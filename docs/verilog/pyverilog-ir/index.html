<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.27.1 by Michael Rose
  Copyright 2013-2025 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en-US" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>PyVerilog AST 변환 - ARCHIVE</title>
<meta name="description" content="">


  <meta name="author" content="hvppyarchive">
  
  <meta property="article:author" content="hvppyarchive">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="ARCHIVE">
<meta property="og:title" content="PyVerilog AST 변환">
<meta property="og:url" content="https://hvppyarchive.github.io/verilog/pyverilog-ir/">


  <meta property="og:description" content="">







  <meta property="article:published_time" content="2025-08-20T14:24:23+09:00">





  

  


<link rel="canonical" href="https://hvppyarchive.github.io/verilog/pyverilog-ir/">












<!-- end _includes/seo.html -->


<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->
<!-- hvppyarchive: add fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@200..900&display=swap" rel="stylesheet">

<!-- insert favicons. use https://realfavicongenerator.net/ -->
 <!-- hvppyarchive: add favicons -->
<link rel="icon" type="image/png" href="/assets/favicon/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/assets/favicon/favicon.svg" />
<link rel="shortcut icon" href="/assets/favicon/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png" />
<link rel="manifest" href="/assets/favicon/site.webmanifest" />

<!-- end custom head snippets -->

  </head>

  <body class="layout--single" dir="ltr">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          ARCHIVE
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/year-archive/"
                
                
              >Posts</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="PyVerilog AST 변환">
    <meta itemprop="description" content="">
    <meta itemprop="datePublished" content="2025-08-20T14:24:23+09:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://hvppyarchive.github.io/verilog/pyverilog-ir/" itemprop="url">PyVerilog AST 변환
</a>
          </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-08-20T14:24:23+09:00">2025-08-20</time>
      </span>
    

    

    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p class="chat--user">

PyVerilog의 ast가 생각보다 정규화(표준화) 되어 있지 않아서 예외처리할 것이 너무 많아.(e.g. port가 IO 포함인지, 본문에 써있는지 등등) 좀 더 표준화된 형식으로 쉽게 traverse할 수 있는 형태로 conversion 하는 기능을 개발하려고 해. 들어가야할 사항들: - port(순서, 포트명, width(msb, lsb), in/out/inout) - 내부 instance(submodule, port-argument mapping) - 내부 nets(width(msb, lsb)) 

</p>

<p>좋아요—PyVerilog AST의 들쭉날쭉함(ANSI/Non-ANSI 포트 선언, 포지셔널/네임드 인스턴스, width 표현식 등) 때문에 예외가 많죠. 아래처럼 <strong>표준화된 중간 표현(IR)</strong>로 변환하는 파이프라인을 제안합니다. 바로 쓸 수 있는 <strong>참조 구현 코드</strong> 도 넣었어요.</p>

<hr />

<h1 id="목표">목표</h1>

<ul>
  <li>
    <p>모듈 단위로 <strong>일관된 JSON IR</strong> 제공</p>
  </li>
  <li>
    <p>포트: <strong>순서(index), 이름, 방향, 폭(msb/lsb, 정수 평가 가능하면 width), signed 여부</strong></p>
  </li>
  <li>
    <p>내부 인스턴스: <strong>서브모듈명, 인스턴스명, 파라미터 override, 포트-아규먼트 매핑(포지셔널→네임드 자동 치환)</strong></p>
  </li>
  <li>
    <p>내부 nets: <strong>wire/reg 등, 이름, 폭(msb/lsb, width)</strong></p>
  </li>
</ul>

<hr />

<h1 id="설계-스텝별">설계 (스텝별)</h1>

<ol>
  <li><strong>IR 스키마 정의</strong></li>
</ol>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"modules"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"&lt;modname&gt;"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"WIDTH"</span><span class="p">,</span><span class="nl">"value_str"</span><span class="p">:</span><span class="s2">"8"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="mi">8</span><span class="p">}],</span><span class="w">
      </span><span class="nl">"ports"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="nl">"index"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"clk"</span><span class="p">,</span><span class="nl">"dir"</span><span class="p">:</span><span class="s2">"input"</span><span class="p">,</span><span class="nl">"signed"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="w">
         </span><span class="nl">"msb_str"</span><span class="p">:</span><span class="s2">"0"</span><span class="p">,</span><span class="nl">"lsb_str"</span><span class="p">:</span><span class="s2">"0"</span><span class="p">,</span><span class="nl">"msb"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nl">"lsb"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nl">"width"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"nets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"data"</span><span class="p">,</span><span class="nl">"kind"</span><span class="p">:</span><span class="s2">"wire"</span><span class="p">,</span><span class="nl">"signed"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="w">
         </span><span class="nl">"msb_str"</span><span class="p">:</span><span class="s2">"WIDTH-1"</span><span class="p">,</span><span class="nl">"lsb_str"</span><span class="p">:</span><span class="s2">"0"</span><span class="p">,</span><span class="nl">"msb"</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span><span class="nl">"lsb"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nl">"width"</span><span class="p">:</span><span class="mi">8</span><span class="p">}</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"instances"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="nl">"inst"</span><span class="p">:</span><span class="s2">"u0"</span><span class="p">,</span><span class="nl">"module"</span><span class="p">:</span><span class="s2">"child"</span><span class="p">,</span><span class="nl">"param_overrides"</span><span class="p">:[{</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"WIDTH"</span><span class="p">,</span><span class="nl">"value_str"</span><span class="p">:</span><span class="s2">"4"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="mi">4</span><span class="p">}],</span><span class="w">
         </span><span class="nl">"connections"</span><span class="p">:[{</span><span class="nl">"port"</span><span class="p">:</span><span class="s2">"a"</span><span class="p">,</span><span class="nl">"expr_str"</span><span class="p">:</span><span class="s2">"data[3:0]"</span><span class="p">},{</span><span class="nl">"port"</span><span class="p">:</span><span class="s2">"b"</span><span class="p">,</span><span class="nl">"expr_str"</span><span class="p">:</span><span class="s2">"clk"</span><span class="p">}]}</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">*_str</code>는 원본 표현식 문자열, <code class="language-plaintext highlighter-rouge">msb/lsb/width/value</code>는 <strong>가능하면 정수 평가</strong> , 실패 시 <code class="language-plaintext highlighter-rouge">null</code>.</p>
  </li>
  <li>
    <p>포지셔널 연결은 <strong>서브모듈 포트 순서</strong> 를 이용해 네임드로 변환.</p>
  </li>
</ul>

<ol>
  <li><strong>두 단계 수집</strong></li>
</ol>

<ul>
  <li>
    <p><strong>1패스</strong> : 모든 모듈의 포트 순서/기본 파라미터 테이블 생성(포지셔널 매핑용).</p>
  </li>
  <li>
    <p><strong>2패스</strong> : 각 모듈에 대해 포트/넷/인스턴스 표준화.</p>
  </li>
</ul>

<ol>
  <li><strong>포트 정규화</strong></li>
</ol>

<ul>
  <li>
    <p>ANSI(<code class="language-plaintext highlighter-rouge">Ioport</code>)와 Non-ANSI(<code class="language-plaintext highlighter-rouge">Port</code>+본문 <code class="language-plaintext highlighter-rouge">Input/Output/Inout</code> 선언) 모두 흡수.</p>
  </li>
  <li>
    <p>폭 미지정은 <code class="language-plaintext highlighter-rouge">1비트(msb=lsb=0)</code>로 통일. 방향 미상은 보수적으로 <code class="language-plaintext highlighter-rouge">inout</code> 대신 <strong>발견 실패 시 null</strong>(현실적으로 거의 없음).</p>
  </li>
</ul>

<ol>
  <li><strong>인스턴스 정규화</strong></li>
</ol>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">InstanceList</code>를 재귀 탐색(Generate 블록 내부 포함).</p>
  </li>
  <li>
    <p>포지셔널 연결은 1패스에서 모은 <strong>서브모듈 포트 순서</strong> 로 네임드 변환. 알 수 없는 외부 모듈은 인덱스 기반으로 남김(예: <code class="language-plaintext highlighter-rouge">__pos0</code>, <code class="language-plaintext highlighter-rouge">__pos1</code>).</p>
  </li>
</ul>

<ol>
  <li><strong>넷 정규화</strong></li>
</ol>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">wire/reg</code>(필요하면 <code class="language-plaintext highlighter-rouge">integer</code>)를 수집, 다중 선언은 개별 항목으로 분할.</p>
  </li>
  <li>
    <p>포트 선언에서 이미 등장한 식별자는 <strong>nets에서 중복 제외</strong>(요구사항이 “내부 nets”이므로).</p>
  </li>
</ul>

<ol>
  <li><strong>표현식 평가기</strong></li>
</ol>

<ul>
  <li>파라미터 환경을 사용해 <code class="language-plaintext highlighter-rouge">IntConst/Identifier/UnaryOp/BinaryOp</code> 중심으로 <strong>안전한 정수 평가</strong>(미지원 연산 시 값은 <code class="language-plaintext highlighter-rouge">null</code>, 원 문자열은 유지).</li>
</ul>

<hr />

<h1 id="레퍼런스-구현-python--pyverilog">레퍼런스 구현 (Python / PyVerilog)</h1>

<blockquote>
  <p>pip: <code class="language-plaintext highlighter-rouge">pyverilog</code> 필요. 파일 모음 입력 → 위 IR JSON 반환.
```python</p>
  <h1 id="vnormpy">vnorm.py</h1>
  <p>from <strong>future</strong> import annotations
from typing import Any, Dict, List, Tuple, Optional
import json
from pyverilog.vparser.parser import parse
from pyverilog.vparser import ast as vast
from pyverilog.ast_code_generator.codegen import ASTCodeGenerator</p>
</blockquote>

<p>codegen = ASTCodeGenerator()</p>

<h1 id="--utilities--">———- utilities ———-</h1>
<p>def to_str(node) -&gt; Optional[str]:
    if node is None:
        return None
    try:
        return codegen.visit(node)
    except Exception:
        return None</p>

<p>def int_from_intconst(intconst: str) -&gt; Optional[int]:
    # Handles decimal/hex/bin/octal Verilog ints like 8'hFF or 'd10.
    s = intconst.replace('_', '')
    try:
        # forms: 10, 8'hFF, 'd3
        if "'" not in s:
            return int(s, 10)
        width_base, val = s.split("'")
        base = val[0].lower()
        digits = val[1:]
        if base == 'd': return int(digits, 10)
        if base == 'h': return int(digits, 16)
        if base == 'b': return int(digits, 2)
        if base == 'o': return int(digits, 8)
        # unknown base
        return int(digits, 10)
    except Exception:
        return None</p>

<p>def eval_expr(node, env: Dict[str, int]) -&gt; Optional[int]:
    # conservative evaluator for width-ish integer expressions
    if node is None:
        return None
    if isinstance(node, vast.IntConst):
        return int_from_intconst(node.value)
    if isinstance(node, vast.Identifier):
        return env.get(node.name)
    if isinstance(node, vast.UnaryOperator):
        v = eval_expr(node.children()[0], env)
        if v is None: return None
        op = node.<strong>class</strong>.<strong>name</strong>
        if op in ("Uplus",): return +v
        if op in ("Uminus",): return -v
        if op in ("Ulnot","Unot"): return 0 if v else 1
        return None
    if isinstance(node, vast.Partselect) or isinstance(node, vast.Pointer):
        # treat as unknown integer
        return None
    if isinstance(node, vast.Concat) or isinstance(node, vast.Repeat):
        return None
    # Binary operators
    if isinstance(node, vast.BinaryOperator):
        a = eval_expr(node.left, env)
        b = eval_expr(node.right, env)
        if a is None or b is None:
            return None
        t = node.<strong>class</strong>.<strong>name</strong>
        try:
            if t == "Plus": return a + b
            if t == "Minus": return a - b
            if t == "Times": return a * b
            if t == "Div": return a // b if b != 0 else None
            if t == "Power": return a ** b
            if t == "Mod": return a % b if b != 0 else None
            if t == "Sll": return a « b
            if t == "Srl": return a » b
            if t == "And": return a &amp; b
            if t == "Or":  return a | b
            if t == "Xor": return a ^ b
        except Exception:
            return None
        return None
    return None</p>

<p>def width_tuple(width_node, env: Dict[str,int]):
    # returns (msb_str, lsb_str, msb_val, lsb_val, width_val)
    if width_node is None:
        return "0", "0", 0, 0, 1
    msb_n, lsb_n = width_node.msb, width_node.lsb
    msb_s, lsb_s = to_str(msb_n), to_str(lsb_n)
    msb_v, lsb_v = eval_expr(msb_n, env), eval_expr(lsb_n, env)
    width_v = None
    if msb_v is not None and lsb_v is not None:
        width_v = abs(msb_v - lsb_v) + 1
    return msb_s, lsb_s, msb_v, lsb_v, width_v</p>

<h1 id="--1st-pass-collect-module-port-order--param-defaults--">———- 1st pass: collect module port order &amp; param defaults ———-</h1>
<p>def collect_modules(ast_root) -&gt; Dict[str, vast.ModuleDef]:
    mods = {}
    for d in ast_root.description.definitions:
        if isinstance(d, vast.ModuleDef):
            mods[d.name] = d
    return mods</p>

<p>def collect_param_env(mod: vast.ModuleDef) -&gt; Dict[str,int]:
    env = {}
    # parameters in header
    if getattr(mod, "paramlist", None):
        for p in mod.paramlist.params:
            if isinstance(p, vast.Parameter):
                v = eval_expr(p.value, env)  # parameters can depend on earlier ones
                if v is not None:
                    env[p.name] = v
    # parameters in body declarations, if any
    for item in getattr(mod, "items", []) or []:
        if isinstance(item, vast.Decl):
            for e in item.list:
                if isinstance(e, vast.Parameter):
                    v = eval_expr(e.value, env)
                    if v is not None:
                        env[e.name] = v
    return env</p>

<p>def ordered_port_names(mod: vast.ModuleDef) -&gt; List[str]:
    names = []
    if mod.portlist is None:
        return names
    for p in mod.portlist.ports:
        # Ioport(first=Identifier, second=Input/Output/Inout)
        if isinstance(p, vast.Ioport):
            names.append(p.first.name)
        elif isinstance(p, vast.Port):
            # Port(name, arg=None) in non-ANSI
            names.append(p.name)
    return names</p>

<h1 id="--helpers-declaration-maps--">———- helpers: declaration maps ———-</h1>
<p>def build_io_decl_map(mod: vast.ModuleDef, env: Dict[str,int]):
    # name -&gt; (dir, signed, width_info)
    io_map = {}
    for item in getattr(mod, "items", []) or []:
        if not isinstance(item, vast.Decl):
            continue
        for e in item.list:
            if isinstance(e, (vast.Input, vast.Output, vast.Inout)):
                dir_ = "input" if isinstance(e, vast.Input) else ("output" if isinstance(e, vast.Output) else "inout")
                signed = bool(getattr(e, "signed", False))
                w = getattr(e, "width", None)
                msb_s, lsb_s, msb_v, lsb_v, width_v = width_tuple(w, env)
                for name in [n.name for n in e.children() if isinstance(n, vast.Identifier)]:
                    io_map[name] = (dir_, signed, (msb_s, lsb_s, msb_v, lsb_v, width_v))
    return io_map</p>

<p>def build_net_decl_list(mod: vast.ModuleDef, env: Dict[str,int]):
    nets = []
    for item in getattr(mod, "items", []) or []:
        if not isinstance(item, vast.Decl):
            continue
        for e in item.list:
            if isinstance(e, (vast.Wire, vast.Reg, vast.Integer)):
                kind = "wire" if isinstance(e, vast.Wire) else ("reg" if isinstance(e, vast.Reg) else "integer")
                signed = bool(getattr(e, "signed", False))
                w = getattr(e, "width", None)
                msb_s, lsb_s, msb_v, lsb_v, width_v = width_tuple(w, env)
                for n in e.children():
                    if isinstance(n, vast.Identifier):
                        nets.append({
                            "name": n.name, "kind": kind, "signed": signed,
                            "msb_str": msb_s, "lsb_str": lsb_s, "msb": msb_v, "lsb": lsb_v, "width": width_v
                        })
    return nets</p>

<h1 id="--recursive-walker-for-instancelist--">———- recursive walker for InstanceList ———-</h1>
<p>def iter_instancelists(node):
    # yield vast.InstanceList under any nesting (e.g., Generate blocks)
    if isinstance(node, vast.InstanceList):
        yield node
    for ch in getattr(node, "children", lambda: [])():
        yield from iter_instancelists(ch)</p>

<h1 id="--2nd-pass-build-ir-per-module--">———- 2nd pass: build IR per module ———-</h1>
<p>def normalize_module(mod: vast.ModuleDef, modlib_ports: Dict[str, List[str]]) -&gt; Dict[str,Any]:
    env = collect_param_env(mod)
    # parameters
    params = []
    # header params
    if getattr(mod, "paramlist", None):
        for p in mod.paramlist.params:
            if isinstance(p, vast.Parameter):
                params.append({
                    "name": p.name,
                    "value_str": to_str(p.value),
                    "value": eval_expr(p.value, env)
                })
    # body params (avoid duplicates)
    body_params = {}
    for item in getattr(mod, "items", []) or []:
        if isinstance(item, vast.Decl):
            for e in item.list:
                if isinstance(e, vast.Parameter) and e.name not in {x["name"] for x in params}:
                    body_params[e.name] = {
                        "name": e.name,
                        "value_str": to_str(e.value),
                        "value": eval_expr(e.value, env)
                    }
    params.extend(body_params.values())</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ports
io_map = build_io_decl_map(mod, env)
ordered_names = ordered_port_names(mod)
ports = []
for idx, pname in enumerate(ordered_names):
    dir_, signed, winfo = None, False, None
    # ANSI Ioport case
    ansi_hit = False
    if mod.portlist and isinstance(mod.portlist.ports[idx], vast.Ioport):
        io = mod.portlist.ports[idx]
        decl = io.second  # Input/Output/Inout
        dir_ = "input" if isinstance(decl, vast.Input) else ("output" if isinstance(decl, vast.Output) else "inout")
        signed = bool(getattr(decl, "signed", False))
        w = getattr(decl, "width", None)
        msb_s, lsb_s, msb_v, lsb_v, width_v = width_tuple(w, env)
        winfo = (msb_s, lsb_s, msb_v, lsb_v, width_v)
        ansi_hit = True
    # Non-ANSI fallback via body decl map
    if not ansi_hit and pname in io_map:
        dir_, signed, winfo = io_map[pname]
    if winfo is None:
        winfo = width_tuple(None, env)
    msb_s, lsb_s, msb_v, lsb_v, width_v = winfo
    ports.append({
        "index": idx, "name": pname, "dir": dir_, "signed": signed,
        "msb_str": msb_s, "lsb_str": lsb_s, "msb": msb_v, "lsb": lsb_v, "width": width_v
    })

# nets (exclude names that are top-level ports)
nets_raw = build_net_decl_list(mod, env)
port_names_set = set(ordered_names)
nets = [n for n in nets_raw if n["name"] not in port_names_set]

# instances
instances = []
for il in iter_instancelists(mod):
    submod = il.module
    # parameter overrides (common across instances in the list)
    param_overrides = []
    if getattr(il, "paramlist", None):
        for pa in il.paramlist.params:
            # pa: vast.ParamArg(name, argname/value)
            name = pa.paramname if hasattr(pa, "paramname") else getattr(pa, "name", None)
            value_node = pa.argname if hasattr(pa, "argname") else getattr(pa, "value", None)
            param_overrides.append({
                "name": name,
                "value_str": to_str(value_node),
                "value": eval_expr(value_node, env)
            })
    for inst in il.instances:
        conns = []
        # PortArg(portname, argname)
        portargs = getattr(inst, "portlist", []) or []
        # decide positional vs named
        positional = any(getattr(pa, "portname", None) in (None, "") for pa in portargs)
        if positional:
            # map by index using lib
            lib_ports = modlib_ports.get(submod, [])
            for i, pa in enumerate(portargs):
                pname = lib_ports[i] if i &lt; len(lib_ports) else f"__pos{i}"
                conns.append({"port": pname, "expr_str": to_str(getattr(pa, "argname", None))})
        else:
            for pa in portargs:
                conns.append({"port": pa.portname, "expr_str": to_str(pa.argname)})
        instances.append({
            "inst": inst.name,
            "module": submod,
            "param_overrides": param_overrides,
            "connections": conns
        })

return {"parameters": params, "ports": ports, "nets": nets, "instances": instances}
</code></pre></div></div>

<p>def convert_to_vnorm(files: List[str]) -&gt; Dict[str,Any]:
    ast, _ = parse(files)
    mods = collect_modules(ast)
    modlib_ports = {name: ordered_port_names(m) for name, m in mods.items()}
    result = {"modules": {}}
    for name, m in mods.items():
        result["modules"][name] = normalize_module(m, modlib_ports)
    return result</p>

<p>if <strong>name</strong> == "<strong>main</strong>":
    import argparse, sys
    ap = argparse.ArgumentParser()
    ap.add_argument("verilog", nargs="+", help="Verilog source files")
    ap.add_argument("-o", "–out", default="-", help="Output JSON path (default: stdout)")
    args = ap.parse_args()
    ir = convert_to_vnorm(args.verilog)
    s = json.dumps(ir, indent=2)
    if args.out == "-" or args.out == "/dev/stdout":
        print(s)
    else:
        with open(args.out, "w") as f:
            f.write(s)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
* * *

# 사용 예시

**예제 Verilog**
```verilog
module child #(parameter WIDTH=8) (input clk, input [WIDTH-1:0] a, output y);
  assign y = a[0];
endmodule

module top (clk, rst, out);
  input clk, rst;
  output out;
  wire [7:0] data;
  child #(.WIDTH(8)) u0 (.clk(clk), .a(data), .y(out));
endmodule
</code></pre></div></div>

<p><strong>실행</strong></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python vnorm.py top.v <span class="nt">-o</span> ir.json
</code></pre></div></div>

<p><strong>핵심 결과(발췌)</strong></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"modules"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"top"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"ports"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="nl">"index"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"clk"</span><span class="p">,</span><span class="nl">"dir"</span><span class="p">:</span><span class="s2">"input"</span><span class="p">,</span><span class="nl">"width"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="err">...</span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="nl">"index"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"rst"</span><span class="p">,</span><span class="nl">"dir"</span><span class="p">:</span><span class="s2">"input"</span><span class="p">,</span><span class="nl">"width"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="err">...</span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="nl">"index"</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"out"</span><span class="p">,</span><span class="nl">"dir"</span><span class="p">:</span><span class="s2">"output"</span><span class="p">,</span><span class="nl">"width"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="err">...</span><span class="p">}</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"nets"</span><span class="p">:[</span><span class="w">
        </span><span class="p">{</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"data"</span><span class="p">,</span><span class="nl">"kind"</span><span class="p">:</span><span class="s2">"wire"</span><span class="p">,</span><span class="nl">"msb_str"</span><span class="p">:</span><span class="s2">"7"</span><span class="p">,</span><span class="nl">"lsb_str"</span><span class="p">:</span><span class="s2">"0"</span><span class="p">,</span><span class="nl">"msb"</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span><span class="nl">"lsb"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nl">"width"</span><span class="p">:</span><span class="mi">8</span><span class="p">}</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"instances"</span><span class="p">:[</span><span class="w">
        </span><span class="p">{</span><span class="nl">"inst"</span><span class="p">:</span><span class="s2">"u0"</span><span class="p">,</span><span class="nl">"module"</span><span class="p">:</span><span class="s2">"child"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"param_overrides"</span><span class="p">:[{</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"WIDTH"</span><span class="p">,</span><span class="nl">"value_str"</span><span class="p">:</span><span class="s2">"8"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="mi">8</span><span class="p">}],</span><span class="w">
         </span><span class="nl">"connections"</span><span class="p">:[</span><span class="w">
           </span><span class="p">{</span><span class="nl">"port"</span><span class="p">:</span><span class="s2">"clk"</span><span class="p">,</span><span class="nl">"expr_str"</span><span class="p">:</span><span class="s2">"clk"</span><span class="p">},</span><span class="w">
           </span><span class="p">{</span><span class="nl">"port"</span><span class="p">:</span><span class="s2">"a"</span><span class="p">,</span><span class="nl">"expr_str"</span><span class="p">:</span><span class="s2">"data"</span><span class="p">},</span><span class="w">
           </span><span class="p">{</span><span class="nl">"port"</span><span class="p">:</span><span class="s2">"y"</span><span class="p">,</span><span class="nl">"expr_str"</span><span class="p">:</span><span class="s2">"out"</span><span class="p">}</span><span class="w">
         </span><span class="p">]}</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<hr />

<h1 id="구현-포인트--엣지케이스-처리">구현 포인트 &amp; 엣지케이스 처리</h1>

<ul>
  <li>
    <p><strong>ANSI/Non-ANSI 포트</strong> : 둘 다 커버. Non-ANSI는 본문 <code class="language-plaintext highlighter-rouge">Decl</code> 탐색으로 방향/폭 채움.</p>
  </li>
  <li>
    <p><strong>폭 미지정</strong> : <code class="language-plaintext highlighter-rouge">msb=lsb=0</code>, <code class="language-plaintext highlighter-rouge">width=1</code>로 통일.</p>
  </li>
  <li>
    <p><strong>표현식 평가 실패</strong> : <code class="language-plaintext highlighter-rouge">*_str</code>만 보존하고 정수 필드는 <code class="language-plaintext highlighter-rouge">null</code>.</p>
  </li>
  <li>
    <p><strong>포지셔널 연결</strong> : 1패스에서 수집한 <strong>서브모듈 포트 순서</strong> 로 네임드화.</p>
  </li>
  <li>
    <p><strong>Generate 내부 인스턴스</strong> : 재귀 탐색으로 수집.</p>
  </li>
  <li>
    <p><strong>내부 nets</strong> : 포트 이름과 중복 제거.</p>
  </li>
  <li>
    <p><strong>파라미터</strong> : 헤더/본문 모두 수집, 가능한 경우 정수 평가.</p>
  </li>
</ul>

<hr />

<h1 id="다음-확장-아이디어">다음 확장 아이디어</h1>

<ul>
  <li>
    <p>SystemVerilog 일부 지원(가능 범위에서): <code class="language-plaintext highlighter-rouge">logic</code>, packed/unpacked 배열, interface 포트는 별 레이어로.</p>
  </li>
  <li>
    <p>폭/파라미터 <strong>완전 평가</strong> 를 위해 PyVerilog Dataflow 연계.</p>
  </li>
  <li>
    <p><strong>기본 nettype</strong>(<code class="language-plaintext highlighter-rouge">default_nettype none</code> 미사용 시) 암시적 net 감지 옵션.</p>
  </li>
  <li>
    <p><strong>소스 위치 정보</strong>(filename, lineno) 추가로 디버깅 편의성↑.</p>
  </li>
  <li>
    <p><strong>스키마 검증</strong>(pydantic/jsonschema)로 다운스트림 안정성 확보.</p>
  </li>
</ul>

<hr />

<p>필요하시면 이 IR로부터 <strong>Graphviz 모듈-인스턴스 다이어그램</strong> 이나 <strong>포트/넷 테이블</strong> 뽑는 코드도 바로 붙여드릴게요.</p>

<p class="chat--user">

JSON 말고 Python class로 변환하고 싶어

</p>

<p>좋지! JSON 대신 <strong>Python 클래스(IR)</strong>로 바로 다루게 만들자.<br />
아래는 (1) 타입 설계 → (2) 변환 파이프라인 → (3) 전체 구현 코드 → (4) 사용 예시 순서로 <strong>차근차근</strong> 정리했어.</p>

<hr />

<h1 id="1-목표-재정의-step-by-step">1) 목표 재정의 (Step-by-step)</h1>

<ul>
  <li>
    <p>PyVerilog AST → <strong>일관된 Python dataclass IR</strong> 반환</p>
  </li>
  <li>
    <p>포함 정보</p>

    <ul>
      <li>
        <p><strong>포트</strong> : 순서(index), 이름, 방향(in/out/inout), signed, 폭(msb/lsb/width)</p>
      </li>
      <li>
        <p><strong>인스턴스</strong> : 서브모듈명, 인스턴스명, 파라미터 override, 포트-아규먼트 매핑(포지셔널 → 네임드 자동 변환)</p>
      </li>
      <li>
        <p><strong>내부 nets</strong> : wire/reg/integer, signed, 폭(msb/lsb/width)</p>
      </li>
    </ul>
  </li>
  <li>
    <p>표현식은 가능한 한 <strong>정수 평가</strong> , 실패하면 원문 문자열 유지</p>
  </li>
</ul>

<hr />

<h1 id="2-타입-설계-dataclass--enum">2) 타입 설계 (dataclass + Enum)</h1>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">DesignIR</code> (루트) → 모듈명 → <code class="language-plaintext highlighter-rouge">ModuleIR</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">ModuleIR</code> 안에 <code class="language-plaintext highlighter-rouge">Parameter</code>, <code class="language-plaintext highlighter-rouge">Port</code>, <code class="language-plaintext highlighter-rouge">Net</code>, <code class="language-plaintext highlighter-rouge">Instance(Connection[])</code></p>
  </li>
  <li>
    <p>방향/넷 종류는 Enum으로 안정화</p>
  </li>
</ul>

<hr />

<h1 id="3-변환-파이프라인-두-패스-step-by-step">3) 변환 파이프라인 (두 패스, Step-by-step)</h1>

<ol>
  <li>
    <p><strong>1패스</strong> : 모든 모듈의</p>

    <ul>
      <li>
        <p>포트 순서 수집(포지셔널 매핑용)</p>
      </li>
      <li>
        <p>파라미터 기본값 환경(env) 구성(폭 평가용)</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>2패스(모듈 단위)</strong> :</p>

    <ul>
      <li>
        <p>포트: ANSI/Non-ANSI 통합 정규화</p>
      </li>
      <li>
        <p>넷: 포트와 중복 제거, 다중 선언 분리</p>
      </li>
      <li>
        <p>인스턴스: Generate 내부 포함 재귀 수집, 포지셔널→네임드</p>
      </li>
    </ul>
  </li>
</ol>

<hr />

<h1 id="4-전체-구현-코드-복붙해서-vnorm_classespy-로-저장">4) 전체 구현 코드 (복붙해서 <code class="language-plaintext highlighter-rouge">vnorm_classes.py</code> 로 저장)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># vnorm_classes.py
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">asdict</span>
<span class="kn">from</span> <span class="n">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="n">json</span>

<span class="kn">from</span> <span class="n">pyverilog.vparser.parser</span> <span class="kn">import</span> <span class="n">parse</span>
<span class="kn">from</span> <span class="n">pyverilog.vparser</span> <span class="kn">import</span> <span class="n">ast</span> <span class="k">as</span> <span class="n">vast</span>
<span class="kn">from</span> <span class="n">pyverilog.ast_code_generator.codegen</span> <span class="kn">import</span> <span class="n">ASTCodeGenerator</span>

<span class="n">codegen</span> <span class="o">=</span> <span class="nc">ASTCodeGenerator</span><span class="p">()</span>

<span class="c1"># -------------------- Typed IR --------------------
</span>
<span class="k">class</span> <span class="nc">Direction</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">INPUT</span> <span class="o">=</span> <span class="sh">"</span><span class="s">input</span><span class="sh">"</span>
    <span class="n">OUTPUT</span> <span class="o">=</span> <span class="sh">"</span><span class="s">output</span><span class="sh">"</span>
    <span class="n">INOUT</span> <span class="o">=</span> <span class="sh">"</span><span class="s">inout</span><span class="sh">"</span>

<span class="k">class</span> <span class="nc">NetKind</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">WIRE</span> <span class="o">=</span> <span class="sh">"</span><span class="s">wire</span><span class="sh">"</span>
    <span class="n">REG</span> <span class="o">=</span> <span class="sh">"</span><span class="s">reg</span><span class="sh">"</span>
    <span class="n">INTEGER</span> <span class="o">=</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Parameter</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">value_str</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Port</span><span class="p">:</span>
    <span class="n">index</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Direction</span><span class="p">]</span>          <span class="c1"># Non-ANSI에서 드물게 못찾으면 None
</span>    <span class="n">signed</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">msb_str</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">lsb_str</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">msb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="n">lsb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="n">width</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>              <span class="c1"># msb/lsb 둘 다 평가되면 abs(msb-lsb)+1
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Net</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">kind</span><span class="p">:</span> <span class="n">NetKind</span>
    <span class="n">signed</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">msb_str</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">lsb_str</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">msb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="n">lsb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="n">width</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Connection</span><span class="p">:</span>
    <span class="n">port</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">expr_str</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Instance</span><span class="p">:</span>
    <span class="n">inst</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">module</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">param_overrides</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Parameter</span><span class="p">]</span> <span class="o">=</span> <span class="nf">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">connections</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Connection</span><span class="p">]</span> <span class="o">=</span> <span class="nf">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModuleIR</span><span class="p">:</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Parameter</span><span class="p">]</span> <span class="o">=</span> <span class="nf">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">ports</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Port</span><span class="p">]</span> <span class="o">=</span> <span class="nf">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">nets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Net</span><span class="p">]</span> <span class="o">=</span> <span class="nf">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">instances</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Instance</span><span class="p">]</span> <span class="o">=</span> <span class="nf">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

    <span class="c1"># 편의 메서드
</span>    <span class="k">def</span> <span class="nf">port_by_name</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Port</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">ports</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">p</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">ports_by_dir</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dir_</span><span class="p">:</span> <span class="n">Direction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Port</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">ports</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nb">dir</span> <span class="o">==</span> <span class="n">dir_</span><span class="p">]</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">DesignIR</span><span class="p">:</span>
    <span class="n">modules</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModuleIR</span><span class="p">]</span> <span class="o">=</span> <span class="nf">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="nf">asdict</span><span class="p">(</span><span class="n">self</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span>

<span class="c1"># -------------------- Helpers --------------------
</span>
<span class="k">def</span> <span class="nf">to_str</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">codegen</span><span class="p">.</span><span class="nf">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">int_from_intconst</span><span class="p">(</span><span class="n">intconst</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">intconst</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="s">_</span><span class="sh">'</span><span class="p">,</span> <span class="sh">''</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="sh">"'"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">return</span> <span class="nf">int</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">width_base</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"'"</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">lower</span><span class="p">()</span>
        <span class="n">digits</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">base</span> <span class="o">==</span> <span class="sh">'</span><span class="s">d</span><span class="sh">'</span><span class="p">:</span> <span class="k">return</span> <span class="nf">int</span><span class="p">(</span><span class="n">digits</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">base</span> <span class="o">==</span> <span class="sh">'</span><span class="s">h</span><span class="sh">'</span><span class="p">:</span> <span class="k">return</span> <span class="nf">int</span><span class="p">(</span><span class="n">digits</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">base</span> <span class="o">==</span> <span class="sh">'</span><span class="s">b</span><span class="sh">'</span><span class="p">:</span> <span class="k">return</span> <span class="nf">int</span><span class="p">(</span><span class="n">digits</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">base</span> <span class="o">==</span> <span class="sh">'</span><span class="s">o</span><span class="sh">'</span><span class="p">:</span> <span class="k">return</span> <span class="nf">int</span><span class="p">(</span><span class="n">digits</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">int</span><span class="p">(</span><span class="n">digits</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">eval_expr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">IntConst</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">int_from_intconst</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Identifier</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">env</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">UnaryOperator</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nf">eval_expr</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="nf">children</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">env</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">Uplus</span><span class="sh">"</span><span class="p">:</span> <span class="k">return</span> <span class="o">+</span><span class="n">v</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">Uminus</span><span class="sh">"</span><span class="p">:</span> <span class="k">return</span> <span class="o">-</span><span class="n">v</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">Ulnot</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Unot</span><span class="sh">"</span><span class="p">):</span> <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">v</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">BinaryOperator</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nf">eval_expr</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="nf">eval_expr</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">right</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">b</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">Plus</span><span class="sh">"</span><span class="p">:</span> <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">Minus</span><span class="sh">"</span><span class="p">:</span> <span class="k">return</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">Times</span><span class="sh">"</span><span class="p">:</span> <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">Div</span><span class="sh">"</span><span class="p">:</span> <span class="k">return</span> <span class="n">a</span> <span class="o">//</span> <span class="n">b</span> <span class="k">if</span> <span class="n">b</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">Power</span><span class="sh">"</span><span class="p">:</span> <span class="k">return</span> <span class="n">a</span> <span class="o">**</span> <span class="n">b</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">Mod</span><span class="sh">"</span><span class="p">:</span> <span class="k">return</span> <span class="n">a</span> <span class="o">%</span> <span class="n">b</span> <span class="k">if</span> <span class="n">b</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">Sll</span><span class="sh">"</span><span class="p">:</span> <span class="k">return</span> <span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="n">b</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">Srl</span><span class="sh">"</span><span class="p">:</span> <span class="k">return</span> <span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="n">b</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">And</span><span class="sh">"</span><span class="p">:</span> <span class="k">return</span> <span class="n">a</span> <span class="o">&amp;</span> <span class="n">b</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">Or</span><span class="sh">"</span><span class="p">:</span>  <span class="k">return</span> <span class="n">a</span> <span class="o">|</span> <span class="n">b</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">Xor</span><span class="sh">"</span><span class="p">:</span> <span class="k">return</span> <span class="n">a</span> <span class="o">^</span> <span class="n">b</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="c1"># 기타 복합표현(Concat/Repeat/Partselect/Pointer)은 평가 보류
</span>    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">width_tuple</span><span class="p">(</span><span class="n">width_node</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]):</span>
    <span class="c1"># (msb_str, lsb_str, msb_val, lsb_val, width_val)
</span>    <span class="k">if</span> <span class="n">width_node</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">0</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">0</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
    <span class="n">msb_n</span><span class="p">,</span> <span class="n">lsb_n</span> <span class="o">=</span> <span class="n">width_node</span><span class="p">.</span><span class="n">msb</span><span class="p">,</span> <span class="n">width_node</span><span class="p">.</span><span class="n">lsb</span>
    <span class="n">msb_s</span><span class="p">,</span> <span class="n">lsb_s</span> <span class="o">=</span> <span class="nf">to_str</span><span class="p">(</span><span class="n">msb_n</span><span class="p">),</span> <span class="nf">to_str</span><span class="p">(</span><span class="n">lsb_n</span><span class="p">)</span>
    <span class="n">msb_v</span><span class="p">,</span> <span class="n">lsb_v</span> <span class="o">=</span> <span class="nf">eval_expr</span><span class="p">(</span><span class="n">msb_n</span><span class="p">,</span> <span class="n">env</span><span class="p">),</span> <span class="nf">eval_expr</span><span class="p">(</span><span class="n">lsb_n</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
    <span class="n">width_v</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">msb_v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">lsb_v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">width_v</span> <span class="o">=</span> <span class="nf">abs</span><span class="p">(</span><span class="n">msb_v</span> <span class="o">-</span> <span class="n">lsb_v</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">msb_s</span><span class="p">,</span> <span class="n">lsb_s</span><span class="p">,</span> <span class="n">msb_v</span><span class="p">,</span> <span class="n">lsb_v</span><span class="p">,</span> <span class="n">width_v</span>

<span class="c1"># -------------------- 1st pass: module tables --------------------
</span>
<span class="k">def</span> <span class="nf">collect_modules</span><span class="p">(</span><span class="n">ast_root</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">ModuleDef</span><span class="p">]:</span>
    <span class="n">mods</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">ast_root</span><span class="p">.</span><span class="n">description</span><span class="p">.</span><span class="n">definitions</span><span class="p">:</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">ModuleDef</span><span class="p">):</span>
            <span class="n">mods</span><span class="p">[</span><span class="n">d</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
    <span class="k">return</span> <span class="n">mods</span>

<span class="k">def</span> <span class="nf">collect_param_env</span><span class="p">(</span><span class="n">mod</span><span class="p">:</span> <span class="n">vast</span><span class="p">.</span><span class="n">ModuleDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># 헤더 파라미터
</span>    <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="sh">"</span><span class="s">paramlist</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">mod</span><span class="p">.</span><span class="n">paramlist</span><span class="p">.</span><span class="n">params</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Parameter</span><span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="nf">eval_expr</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">env</span><span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="c1"># 바디 파라미터
</span>    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="sh">"</span><span class="s">items</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Decl</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">item</span><span class="p">.</span><span class="nb">list</span><span class="p">:</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Parameter</span><span class="p">):</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="nf">eval_expr</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">env</span><span class="p">[</span><span class="n">e</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">env</span>

<span class="k">def</span> <span class="nf">ordered_port_names</span><span class="p">(</span><span class="n">mod</span><span class="p">:</span> <span class="n">vast</span><span class="p">.</span><span class="n">ModuleDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">mod</span><span class="p">.</span><span class="n">portlist</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">names</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">mod</span><span class="p">.</span><span class="n">portlist</span><span class="p">.</span><span class="n">ports</span><span class="p">:</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Ioport</span><span class="p">):</span>
            <span class="n">names</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Port</span><span class="p">):</span>
            <span class="n">names</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">names</span>

<span class="c1"># -------------------- Decl scans --------------------
</span>
<span class="k">def</span> <span class="nf">build_io_decl_map</span><span class="p">(</span><span class="n">mod</span><span class="p">:</span> <span class="n">vast</span><span class="p">.</span><span class="n">ModuleDef</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]):</span>
    <span class="c1"># name -&gt; (Direction|None, signed, width_info)
</span>    <span class="n">io_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="sh">"</span><span class="s">items</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Decl</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">item</span><span class="p">.</span><span class="nb">list</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="n">vast</span><span class="p">.</span><span class="n">Input</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Output</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Inout</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Input</span><span class="p">):</span>  <span class="n">dir_</span> <span class="o">=</span> <span class="n">Direction</span><span class="p">.</span><span class="n">INPUT</span>
                <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Output</span><span class="p">):</span> <span class="n">dir_</span> <span class="o">=</span> <span class="n">Direction</span><span class="p">.</span><span class="n">OUTPUT</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">dir_</span> <span class="o">=</span> <span class="n">Direction</span><span class="p">.</span><span class="n">INOUT</span>
                <span class="n">signed</span> <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="sh">"</span><span class="s">signed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">False</span><span class="p">))</span>
                <span class="n">w</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="sh">"</span><span class="s">width</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="n">msb_s</span><span class="p">,</span> <span class="n">lsb_s</span><span class="p">,</span> <span class="n">msb_v</span><span class="p">,</span> <span class="n">lsb_v</span><span class="p">,</span> <span class="n">width_v</span> <span class="o">=</span> <span class="nf">width_tuple</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
                <span class="c1"># e.children() contains Identifiers
</span>                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">e</span><span class="p">.</span><span class="nf">children</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Identifier</span><span class="p">):</span>
                        <span class="n">io_map</span><span class="p">[</span><span class="n">n</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dir_</span><span class="p">,</span> <span class="n">signed</span><span class="p">,</span> <span class="p">(</span><span class="n">msb_s</span><span class="p">,</span> <span class="n">lsb_s</span><span class="p">,</span> <span class="n">msb_v</span><span class="p">,</span> <span class="n">lsb_v</span><span class="p">,</span> <span class="n">width_v</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">io_map</span>

<span class="k">def</span> <span class="nf">build_net_decl_list</span><span class="p">(</span><span class="n">mod</span><span class="p">:</span> <span class="n">vast</span><span class="p">.</span><span class="n">ModuleDef</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Net</span><span class="p">]:</span>
    <span class="n">nets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Net</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="sh">"</span><span class="s">items</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Decl</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">item</span><span class="p">.</span><span class="nb">list</span><span class="p">:</span>
            <span class="n">kind</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NetKind</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Wire</span><span class="p">):</span> <span class="n">kind</span> <span class="o">=</span> <span class="n">NetKind</span><span class="p">.</span><span class="n">WIRE</span>
            <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Reg</span><span class="p">):</span> <span class="n">kind</span> <span class="o">=</span> <span class="n">NetKind</span><span class="p">.</span><span class="n">REG</span>
            <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Integer</span><span class="p">):</span> <span class="n">kind</span> <span class="o">=</span> <span class="n">NetKind</span><span class="p">.</span><span class="n">INTEGER</span>
            <span class="k">if</span> <span class="n">kind</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">signed</span> <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="sh">"</span><span class="s">signed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">False</span><span class="p">))</span>
            <span class="n">w</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="sh">"</span><span class="s">width</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">msb_s</span><span class="p">,</span> <span class="n">lsb_s</span><span class="p">,</span> <span class="n">msb_v</span><span class="p">,</span> <span class="n">lsb_v</span><span class="p">,</span> <span class="n">width_v</span> <span class="o">=</span> <span class="nf">width_tuple</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">e</span><span class="p">.</span><span class="nf">children</span><span class="p">():</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Identifier</span><span class="p">):</span>
                    <span class="n">nets</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Net</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">n</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="n">signed</span><span class="p">,</span>
                        <span class="n">msb_str</span><span class="o">=</span><span class="n">msb_s</span><span class="p">,</span> <span class="n">lsb_str</span><span class="o">=</span><span class="n">lsb_s</span><span class="p">,</span> <span class="n">msb</span><span class="o">=</span><span class="n">msb_v</span><span class="p">,</span> <span class="n">lsb</span><span class="o">=</span><span class="n">lsb_v</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width_v</span>
                    <span class="p">))</span>
    <span class="k">return</span> <span class="n">nets</span>

<span class="c1"># -------------------- Instance walker --------------------
</span>
<span class="k">def</span> <span class="nf">iter_instancelists</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">InstanceList</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">node</span>
    <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="sh">"</span><span class="s">children</span><span class="sh">"</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="p">[])():</span>
        <span class="k">yield</span> <span class="k">from</span> <span class="nf">iter_instancelists</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>

<span class="c1"># -------------------- 2nd pass: normalize module --------------------
</span>
<span class="k">def</span> <span class="nf">normalize_module</span><span class="p">(</span><span class="n">mod</span><span class="p">:</span> <span class="n">vast</span><span class="p">.</span><span class="n">ModuleDef</span><span class="p">,</span> <span class="n">modlib_ports</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">ModuleIR</span><span class="p">:</span>
    <span class="n">env</span> <span class="o">=</span> <span class="nf">collect_param_env</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>

    <span class="c1"># parameters
</span>    <span class="n">params</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Parameter</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="sh">"</span><span class="s">paramlist</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">mod</span><span class="p">.</span><span class="n">paramlist</span><span class="p">.</span><span class="n">params</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Parameter</span><span class="p">):</span>
                <span class="n">params</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Parameter</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">value_str</span><span class="o">=</span><span class="nf">to_str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">value</span><span class="p">),</span>
                    <span class="n">value</span><span class="o">=</span><span class="nf">eval_expr</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">env</span><span class="p">),</span>
                <span class="p">))</span>
    <span class="c1"># body params (dedupe)
</span>    <span class="n">header_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="sh">"</span><span class="s">items</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Decl</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">item</span><span class="p">.</span><span class="nb">list</span><span class="p">:</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Parameter</span><span class="p">)</span> <span class="ow">and</span> <span class="n">e</span><span class="p">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header_names</span><span class="p">:</span>
                    <span class="n">params</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Parameter</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">e</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">value_str</span><span class="o">=</span><span class="nf">to_str</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">value</span><span class="p">),</span>
                        <span class="n">value</span><span class="o">=</span><span class="nf">eval_expr</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">env</span><span class="p">),</span>
                    <span class="p">))</span>

    <span class="c1"># ports
</span>    <span class="n">io_map</span> <span class="o">=</span> <span class="nf">build_io_decl_map</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
    <span class="n">ordered_names</span> <span class="o">=</span> <span class="nf">ordered_port_names</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
    <span class="n">ports</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Port</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">pname</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">ordered_names</span><span class="p">):</span>
        <span class="n">dir_</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Direction</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">signed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">msb_s</span> <span class="o">=</span> <span class="n">lsb_s</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">msb_v</span> <span class="o">=</span> <span class="n">lsb_v</span> <span class="o">=</span> <span class="n">width_v</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">ansi_hit</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">mod</span><span class="p">.</span><span class="n">portlist</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">mod</span><span class="p">.</span><span class="n">portlist</span><span class="p">.</span><span class="n">ports</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">vast</span><span class="p">.</span><span class="n">Ioport</span><span class="p">):</span>
            <span class="n">io</span> <span class="o">=</span> <span class="n">mod</span><span class="p">.</span><span class="n">portlist</span><span class="p">.</span><span class="n">ports</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">decl</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">second</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">decl</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Input</span><span class="p">):</span>  <span class="n">dir_</span> <span class="o">=</span> <span class="n">Direction</span><span class="p">.</span><span class="n">INPUT</span>
            <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">decl</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Output</span><span class="p">):</span> <span class="n">dir_</span> <span class="o">=</span> <span class="n">Direction</span><span class="p">.</span><span class="n">OUTPUT</span>
            <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">decl</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Inout</span><span class="p">):</span> <span class="n">dir_</span> <span class="o">=</span> <span class="n">Direction</span><span class="p">.</span><span class="n">INOUT</span>
            <span class="n">signed</span> <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">decl</span><span class="p">,</span> <span class="sh">"</span><span class="s">signed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">False</span><span class="p">))</span>
            <span class="n">msb_s</span><span class="p">,</span> <span class="n">lsb_s</span><span class="p">,</span> <span class="n">msb_v</span><span class="p">,</span> <span class="n">lsb_v</span><span class="p">,</span> <span class="n">width_v</span> <span class="o">=</span> <span class="nf">width_tuple</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">decl</span><span class="p">,</span> <span class="sh">"</span><span class="s">width</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="n">env</span><span class="p">)</span>
            <span class="n">ansi_hit</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ansi_hit</span> <span class="ow">and</span> <span class="n">pname</span> <span class="ow">in</span> <span class="n">io_map</span><span class="p">:</span>
            <span class="n">dir_</span><span class="p">,</span> <span class="n">signed</span><span class="p">,</span> <span class="p">(</span><span class="n">msb_s</span><span class="p">,</span> <span class="n">lsb_s</span><span class="p">,</span> <span class="n">msb_v</span><span class="p">,</span> <span class="n">lsb_v</span><span class="p">,</span> <span class="n">width_v</span><span class="p">)</span> <span class="o">=</span> <span class="n">io_map</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">msb_s</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">lsb_s</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">msb_v</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">lsb_v</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">width_v</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># width unspecified -&gt; 1-bit
</span>            <span class="n">msb_s</span><span class="p">,</span> <span class="n">lsb_s</span><span class="p">,</span> <span class="n">msb_v</span><span class="p">,</span> <span class="n">lsb_v</span><span class="p">,</span> <span class="n">width_v</span> <span class="o">=</span> <span class="sh">"</span><span class="s">0</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">0</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>

        <span class="n">ports</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Port</span><span class="p">(</span>
            <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">pname</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">dir_</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="n">signed</span><span class="p">,</span>
            <span class="n">msb_str</span><span class="o">=</span><span class="n">msb_s</span><span class="p">,</span> <span class="n">lsb_str</span><span class="o">=</span><span class="n">lsb_s</span><span class="p">,</span> <span class="n">msb</span><span class="o">=</span><span class="n">msb_v</span><span class="p">,</span> <span class="n">lsb</span><span class="o">=</span><span class="n">lsb_v</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width_v</span>
        <span class="p">))</span>

    <span class="c1"># nets (exclude top ports)
</span>    <span class="n">nets_raw</span> <span class="o">=</span> <span class="nf">build_net_decl_list</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
    <span class="n">port_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">}</span>
    <span class="n">nets</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nets_raw</span> <span class="k">if</span> <span class="n">n</span><span class="p">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">port_names</span><span class="p">]</span>

    <span class="c1"># instances
</span>    <span class="n">instances</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Instance</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">il</span> <span class="ow">in</span> <span class="nf">iter_instancelists</span><span class="p">(</span><span class="n">mod</span><span class="p">):</span>
        <span class="n">submod</span> <span class="o">=</span> <span class="n">il</span><span class="p">.</span><span class="n">module</span>

        <span class="n">shared_param_ovrs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Parameter</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="sh">"</span><span class="s">paramlist</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pa</span> <span class="ow">in</span> <span class="n">il</span><span class="p">.</span><span class="n">paramlist</span><span class="p">.</span><span class="n">params</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="sh">"</span><span class="s">paramname</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="n">value_node</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="sh">"</span><span class="s">argname</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="n">shared_param_ovrs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Parameter</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">value_str</span><span class="o">=</span><span class="nf">to_str</span><span class="p">(</span><span class="n">value_node</span><span class="p">),</span>
                    <span class="n">value</span><span class="o">=</span><span class="nf">eval_expr</span><span class="p">(</span><span class="n">value_node</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
                <span class="p">))</span>

        <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">il</span><span class="p">.</span><span class="n">instances</span><span class="p">:</span>
            <span class="n">conns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Connection</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">portargs</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="sh">"</span><span class="s">portlist</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="n">positional</span> <span class="o">=</span> <span class="nf">any</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="sh">"</span><span class="s">portname</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="k">for</span> <span class="n">pa</span> <span class="ow">in</span> <span class="n">portargs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">positional</span><span class="p">:</span>
                <span class="n">lib_ports</span> <span class="o">=</span> <span class="n">modlib_ports</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">submod</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pa</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">portargs</span><span class="p">):</span>
                    <span class="n">pname</span> <span class="o">=</span> <span class="n">lib_ports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">lib_ports</span><span class="p">)</span> <span class="k">else</span> <span class="sa">f</span><span class="sh">"</span><span class="s">__pos</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span>
                    <span class="n">conns</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Connection</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">pname</span><span class="p">,</span> <span class="n">expr_str</span><span class="o">=</span><span class="nf">to_str</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="sh">"</span><span class="s">argname</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">))))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pa</span> <span class="ow">in</span> <span class="n">portargs</span><span class="p">:</span>
                    <span class="n">conns</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Connection</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">pa</span><span class="p">.</span><span class="n">portname</span><span class="p">,</span> <span class="n">expr_str</span><span class="o">=</span><span class="nf">to_str</span><span class="p">(</span><span class="n">pa</span><span class="p">.</span><span class="n">argname</span><span class="p">)))</span>

            <span class="n">instances</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Instance</span><span class="p">(</span>
                <span class="n">inst</span><span class="o">=</span><span class="n">inst</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="n">submod</span><span class="p">,</span>
                <span class="n">param_overrides</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">shared_param_ovrs</span><span class="p">),</span>
                <span class="n">connections</span><span class="o">=</span><span class="n">conns</span>
            <span class="p">))</span>

    <span class="k">return</span> <span class="nc">ModuleIR</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">ports</span><span class="o">=</span><span class="n">ports</span><span class="p">,</span> <span class="n">nets</span><span class="o">=</span><span class="n">nets</span><span class="p">,</span> <span class="n">instances</span><span class="o">=</span><span class="n">instances</span><span class="p">)</span>

<span class="c1"># -------------------- Public API --------------------
</span>
<span class="k">def</span> <span class="nf">convert_to_design_ir</span><span class="p">(</span><span class="n">files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">DesignIR</span><span class="p">:</span>
    <span class="n">ast</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nf">parse</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="n">mods</span> <span class="o">=</span> <span class="nf">collect_modules</span><span class="p">(</span><span class="n">ast</span><span class="p">)</span>
    <span class="n">modlib_ports</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="nf">ordered_port_names</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mods</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="n">design</span> <span class="o">=</span> <span class="nc">DesignIR</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mods</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="n">design</span><span class="p">.</span><span class="n">modules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nf">normalize_module</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">modlib_ports</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">design</span>

<span class="c1"># CLI (optional)
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">argparse</span><span class="p">,</span> <span class="n">sys</span>
    <span class="n">ap</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">()</span>
    <span class="n">ap</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">verilog</span><span class="sh">"</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Verilog sources</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">-o</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">--out</span><span class="sh">"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Dump as JSON (for debug)</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">ap</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>
    <span class="n">ir</span> <span class="o">=</span> <span class="nf">convert_to_design_ir</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">verilog</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">out</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">out</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">ir</span><span class="p">.</span><span class="nf">to_json</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Pretty print summary
</span>        <span class="k">for</span> <span class="n">mname</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">ir</span><span class="p">.</span><span class="n">modules</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[module] </span><span class="si">{</span><span class="n">mname</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">m</span><span class="p">.</span><span class="n">ports</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  port[</span><span class="si">{</span><span class="n">p</span><span class="p">.</span><span class="n">index</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">p</span><span class="p">.</span><span class="nb">dir</span> <span class="ow">and</span> <span class="n">p</span><span class="p">.</span><span class="nb">dir</span><span class="p">.</span><span class="n">value</span> <span class="ow">or</span> <span class="sh">'</span><span class="s">None</span><span class="sh">'</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> [</span><span class="si">{</span><span class="n">p</span><span class="p">.</span><span class="n">msb_str</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">p</span><span class="p">.</span><span class="n">lsb_str</span><span class="si">}</span><span class="s">] -&gt; width=</span><span class="si">{</span><span class="n">p</span><span class="p">.</span><span class="n">width</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">m</span><span class="p">.</span><span class="n">nets</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  net </span><span class="si">{</span><span class="n">n</span><span class="p">.</span><span class="n">kind</span><span class="p">.</span><span class="n">value</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">n</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> [</span><span class="si">{</span><span class="n">n</span><span class="p">.</span><span class="n">msb_str</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">n</span><span class="p">.</span><span class="n">lsb_str</span><span class="si">}</span><span class="s">] -&gt; width=</span><span class="si">{</span><span class="n">n</span><span class="p">.</span><span class="n">width</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">m</span><span class="p">.</span><span class="n">instances</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  inst </span><span class="si">{</span><span class="n">i</span><span class="p">.</span><span class="n">inst</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">i</span><span class="p">.</span><span class="n">module</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">i</span><span class="p">.</span><span class="n">connections</span><span class="p">:</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    .</span><span class="si">{</span><span class="n">c</span><span class="p">.</span><span class="n">port</span><span class="si">}</span><span class="s">(</span><span class="si">{</span><span class="n">c</span><span class="p">.</span><span class="n">expr_str</span><span class="si">}</span><span class="s">)</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h1 id="5-사용-예시-step-by-step">5) 사용 예시 (Step-by-step)</h1>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python vnorm_classes.py top.v            <span class="c"># 요약 출력</span>
python vnorm_classes.py top.v <span class="nt">-o</span> ir.json <span class="c"># 디버그용 JSON 덤프(옵션)</span>
</code></pre></div></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 라이브러리처럼 사용
</span><span class="kn">from</span> <span class="n">vnorm_classes</span> <span class="kn">import</span> <span class="n">convert_to_design_ir</span><span class="p">,</span> <span class="n">Direction</span>

<span class="n">ir</span> <span class="o">=</span> <span class="nf">convert_to_design_ir</span><span class="p">([</span><span class="sh">"</span><span class="s">top.v</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">child.v</span><span class="sh">"</span><span class="p">])</span>
<span class="n">top</span> <span class="o">=</span> <span class="n">ir</span><span class="p">.</span><span class="n">modules</span><span class="p">[</span><span class="sh">"</span><span class="s">top</span><span class="sh">"</span><span class="p">]</span>

<span class="c1"># 포트 순회
</span><span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">top</span><span class="p">.</span><span class="n">ports</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="nb">dir</span> <span class="ow">and</span> <span class="n">p</span><span class="p">.</span><span class="nb">dir</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">width</span><span class="p">)</span>

<span class="c1"># 인스턴스/연결 순회
</span><span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">top</span><span class="p">.</span><span class="n">instances</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">inst</span><span class="sh">"</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">inst</span><span class="p">,</span> <span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">module</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inst</span><span class="p">.</span><span class="n">connections</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">  </span><span class="sh">"</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">port</span><span class="p">,</span> <span class="sh">"</span><span class="s">=&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">expr_str</span><span class="p">)</span>

<span class="c1"># 필요 시 JSON 직렬화도 가능 (테스트/로깅용)
</span><span class="nf">print</span><span class="p">(</span><span class="n">ir</span><span class="p">.</span><span class="nf">to_json</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h1 id="6-주의확장-step-by-step">6) 주의/확장 (Step-by-step)</h1>

<ul>
  <li>
    <p><strong>표현식 평가 실패</strong> : <code class="language-plaintext highlighter-rouge">value/width/msb/lsb</code>는 <code class="language-plaintext highlighter-rouge">None</code>이 될 수 있음. 원문은 <code class="language-plaintext highlighter-rouge">*_str</code>에 보존.</p>
  </li>
  <li>
    <p><strong>포지셔널 연결</strong> : 라이브러리에 해당 서브모듈이 없으면 <code class="language-plaintext highlighter-rouge">__pos0</code>처럼 보존.</p>
  </li>
  <li>
    <p><strong>SystemVerilog 확장</strong> : <code class="language-plaintext highlighter-rouge">logic</code>, packed/unpacked, interface 포트 등은 별 레이어로 확장 추천.</p>
  </li>
  <li>
    <p><strong>위치 정보</strong> : 필요하면 <code class="language-plaintext highlighter-rouge">lineno/coord</code>를 dataclass에 추가 가능.</p>
  </li>
  <li>
    <p><strong>검증</strong> : 큰 설계에서 스키마 보장 원하면 <code class="language-plaintext highlighter-rouge">pydantic</code>으로 교체 가능.</p>
  </li>
</ul>

<p>원하는 대로 <strong>직접 탐색 가능한 Python 클래스 IR</strong> 로 변환되도록 구성해 두었어.<br />
원하면 <code class="language-plaintext highlighter-rouge">Connection</code>에 좌표/소스파일 정보나, <code class="language-plaintext highlighter-rouge">ModuleIR</code>에 빠른 인덱스(예: <code class="language-plaintext highlighter-rouge">port_dict</code>)를 추가해주는 최적화 버전도 바로 만들어줄게.</p>

<p class="chat--user">

IR이 뭐야

</p>

<p>좋은 질문! <strong>IR(Intermediate Representation, 중간 표현)</strong>은 <em>소스 코드(또는 설계)를 한층 표준화된 형태로 담아두는 중간 단계의 데이터 구조</em> 예요. 파서가 만든 “문법 그대로”의 트리(AST)와, 그걸 써서 분석·변환·코드생성 같은 후처리 사이에 놓입니다.</p>

<p>아래처럼 <strong>차근차근</strong> 이해하면 편해요:</p>

<ol>
  <li>
    <p><strong>정의</strong></p>

    <ul>
      <li>IR = 분석·최적화·변환을 하기 쉽도록 만든 <strong>표준화된 내부 데이터 모델</strong>.</li>
    </ul>
  </li>
  <li>
    <p><strong>왜 필요한가</strong></p>

    <ul>
      <li>
        <p>언어 문법 차이/스타일(예: Verilog ANSI vs Non-ANSI 포트 선언)을 <strong>한 가지 규칙</strong> 으로 통일.</p>
      </li>
      <li>
        <p><strong>트래버스(순회) 쉬움</strong> : 필요한 정보가 같은 자리/형태에 있음.</p>
      </li>
      <li>
        <p><strong>모듈성</strong> : 프런트엔드(AST)와 백엔드(분석/생성)를 느슨하게 결합.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>AST와의 차이</strong></p>

    <ul>
      <li>
        <p><strong>AST</strong> : 원문 문법을 거의 그대로 반영(케이스가 많고 예외 처리 필요).</p>
      </li>
      <li>
        <p><strong>IR</strong> : 의미 중심으로 <strong>정규화/정리</strong>(예: 포지셔널 인스턴스 → 네임드로 변환, 폭 미지정→1비트로 통일, 상수 가능하면 평가).</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>일반적인 IR의 형태</strong></p>

    <ul>
      <li>
        <p>컴파일러: SSA, 3-address code, CFG/DFG 등</p>
      </li>
      <li>
        <p>하드웨어: <strong>넷리스트-유사 구조</strong> , 파라미터 평가 결과, 모듈/인스턴스/연결 관계 등</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>당신의 프로젝트에서의 IR</strong></p>

    <ul>
      <li>
        <p>우리가 설계한 <strong>Python dataclass IR</strong> 이 곧 IR:</p>

        <ul>
          <li>
            <p><code class="language-plaintext highlighter-rouge">ModuleIR</code> 안에 <code class="language-plaintext highlighter-rouge">ports</code>, <code class="language-plaintext highlighter-rouge">nets</code>, <code class="language-plaintext highlighter-rouge">instances</code>, <code class="language-plaintext highlighter-rouge">parameters</code></p>
          </li>
          <li>
            <p>포트 방향/폭, 내부 넷 폭, 인스턴스의 포트 매핑을 <strong>일관된 스키마</strong> 로 제공</p>
          </li>
          <li>
            <p>가능한 범위에서 <strong>정수 평가</strong>(<code class="language-plaintext highlighter-rouge">width</code>, <code class="language-plaintext highlighter-rouge">msb/lsb</code>) 적용, 실패해도 원문(<code class="language-plaintext highlighter-rouge">*_str</code>) 보존</p>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>얻는 이점</strong></p>

    <ul>
      <li>
        <p>이후 단계(예: 연결 검사, 자동 배선, 문서화, 코드 생성, 시각화)를 <strong>예외처리 거의 없이</strong> 구현 가능.</p>
      </li>
      <li>
        <p>도구 간 <strong>재사용</strong> ·확장 용이.</p>
      </li>
    </ul>
  </li>
</ol>

<p>한 줄 요약: <strong>IR은 “다루기 쉬운 표준형 설계 스냅샷”</strong>이고, 지금 만들고 있는 Python 클래스들이 바로 그 IR이에요.</p>

<p class="chat--user">

decl = io.first 이야. 근데 Enum을 Serialize 못해서 json 변환 부분에서 에러가 나

</p>

<p>좋은 포인트 두 가지!</p>

<ul>
  <li>
    <p><strong>(A)</strong> <code class="language-plaintext highlighter-rouge">Ioport</code>에서 선언/이름의 위치가 환경마다 달라 <code class="language-plaintext highlighter-rouge">decl = io.first</code>가 되는 케이스가 있어요. ⇒ <strong>양쪽 모두 자동 감지</strong> 하도록 바꿉니다.</p>
  </li>
  <li>
    <p><strong>(B)</strong> <code class="language-plaintext highlighter-rouge">Enum</code>은 기본 <code class="language-plaintext highlighter-rouge">json.dumps</code>로 직렬화가 안 됩니다. ⇒ <strong>custom default/encoder</strong> 로 <code class="language-plaintext highlighter-rouge">.value</code>를 쓰게 하면 해결됩니다.</p>
  </li>
</ul>

<p>아래를 그대로 반영하세요. (필요한 부분만 교체/추가)</p>

<hr />

<h2 id="1-ioport-양식-차이를-자동-감지-firstsecond-스왑-대응">1) <code class="language-plaintext highlighter-rouge">Ioport</code> 양식 차이를 자동 감지 (first/second 스왑 대응)</h2>

<h3 id="ordered_port_names-교체"><code class="language-plaintext highlighter-rouge">ordered_port_names</code> 교체</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">ordered_port_names</span><span class="p">(</span><span class="n">mod</span><span class="p">:</span> <span class="n">vast</span><span class="p">.</span><span class="n">ModuleDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">mod</span><span class="p">.</span><span class="n">portlist</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">names</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">mod</span><span class="p">.</span><span class="n">portlist</span><span class="p">.</span><span class="n">ports</span><span class="p">:</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Ioport</span><span class="p">):</span>
            <span class="c1"># Robust: 이름이 어느 쪽(first/second)에 있든 잡아낸다
</span>            <span class="n">name_node</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">first</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Identifier</span><span class="p">):</span>
                <span class="n">name_node</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">first</span>
            <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">second</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Identifier</span><span class="p">):</span>
                <span class="n">name_node</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">second</span>
            <span class="k">if</span> <span class="n">name_node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">names</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">name_node</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Port</span><span class="p">):</span>
            <span class="n">names</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">names</span>
</code></pre></div></div>

<h3 id="normalize_module-내부의-포트-정규화-부분-수정"><code class="language-plaintext highlighter-rouge">normalize_module</code> 내부의 포트 정규화 부분 수정</h3>

<p>아래처럼 <strong>decl(방향/폭을 가진 선언 노드)</strong>를 어느 쪽(first/second)이든 잡도록 바꿉니다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1"># ...
</span>    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">pname</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">ordered_names</span><span class="p">):</span>
        <span class="n">dir_</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Direction</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">signed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">msb_s</span> <span class="o">=</span> <span class="n">lsb_s</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">msb_v</span> <span class="o">=</span> <span class="n">lsb_v</span> <span class="o">=</span> <span class="n">width_v</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">ansi_hit</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">mod</span><span class="p">.</span><span class="n">portlist</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">mod</span><span class="p">.</span><span class="n">portlist</span><span class="p">.</span><span class="n">ports</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">vast</span><span class="p">.</span><span class="n">Ioport</span><span class="p">):</span>
            <span class="n">io</span> <span class="o">=</span> <span class="n">mod</span><span class="p">.</span><span class="n">portlist</span><span class="p">.</span><span class="n">ports</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

            <span class="c1"># 어느 쪽이 선언 노드인지 감지
</span>            <span class="k">def</span> <span class="nf">_is_decl</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="k">return</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">vast</span><span class="p">.</span><span class="n">Input</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Output</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Inout</span><span class="p">))</span>

            <span class="n">decl</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="nf">_is_decl</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">first</span><span class="p">):</span>
                <span class="n">decl</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">first</span>
            <span class="k">elif</span> <span class="nf">_is_decl</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">second</span><span class="p">):</span>
                <span class="n">decl</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">second</span>

            <span class="k">if</span> <span class="n">decl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">decl</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Input</span><span class="p">):</span>  <span class="n">dir_</span> <span class="o">=</span> <span class="n">Direction</span><span class="p">.</span><span class="n">INPUT</span>
                <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">decl</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Output</span><span class="p">):</span> <span class="n">dir_</span> <span class="o">=</span> <span class="n">Direction</span><span class="p">.</span><span class="n">OUTPUT</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">dir_</span> <span class="o">=</span> <span class="n">Direction</span><span class="p">.</span><span class="n">INOUT</span>
                <span class="n">signed</span> <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">decl</span><span class="p">,</span> <span class="sh">"</span><span class="s">signed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">False</span><span class="p">))</span>
                <span class="n">msb_s</span><span class="p">,</span> <span class="n">lsb_s</span><span class="p">,</span> <span class="n">msb_v</span><span class="p">,</span> <span class="n">lsb_v</span><span class="p">,</span> <span class="n">width_v</span> <span class="o">=</span> <span class="nf">width_tuple</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">decl</span><span class="p">,</span> <span class="sh">"</span><span class="s">width</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="n">env</span><span class="p">)</span>
                <span class="n">ansi_hit</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c1"># Non-ANSI fallback
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">ansi_hit</span> <span class="ow">and</span> <span class="n">pname</span> <span class="ow">in</span> <span class="n">io_map</span><span class="p">:</span>
            <span class="n">dir_</span><span class="p">,</span> <span class="n">signed</span><span class="p">,</span> <span class="p">(</span><span class="n">msb_s</span><span class="p">,</span> <span class="n">lsb_s</span><span class="p">,</span> <span class="n">msb_v</span><span class="p">,</span> <span class="n">lsb_v</span><span class="p">,</span> <span class="n">width_v</span><span class="p">)</span> <span class="o">=</span> <span class="n">io_map</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span>

        <span class="c1"># 폭 미지정 → 1비트
</span>        <span class="k">if</span> <span class="nf">all</span><span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">msb_s</span><span class="p">,</span> <span class="n">lsb_s</span><span class="p">,</span> <span class="n">msb_v</span><span class="p">,</span> <span class="n">lsb_v</span><span class="p">,</span> <span class="n">width_v</span><span class="p">)):</span>
            <span class="n">msb_s</span><span class="p">,</span> <span class="n">lsb_s</span><span class="p">,</span> <span class="n">msb_v</span><span class="p">,</span> <span class="n">lsb_v</span><span class="p">,</span> <span class="n">width_v</span> <span class="o">=</span> <span class="sh">"</span><span class="s">0</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">0</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>

        <span class="n">ports</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Port</span><span class="p">(</span>
            <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">pname</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">dir_</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="n">signed</span><span class="p">,</span>
            <span class="n">msb_str</span><span class="o">=</span><span class="n">msb_s</span><span class="p">,</span> <span class="n">lsb_str</span><span class="o">=</span><span class="n">lsb_s</span><span class="p">,</span> <span class="n">msb</span><span class="o">=</span><span class="n">msb_v</span><span class="p">,</span> <span class="n">lsb</span><span class="o">=</span><span class="n">lsb_v</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width_v</span>
        <span class="p">))</span>
</code></pre></div></div>

<blockquote>
  <p>이렇게 하면 <strong><code class="language-plaintext highlighter-rouge">decl = io.first</code></strong>인 케이스도, 반대로 <strong><code class="language-plaintext highlighter-rouge">decl = io.second</code></strong>인 케이스도 모두 정상 처리돼요.</p>
</blockquote>

<hr />

<h2 id="2-enum-json-직렬화-에러-해결">2) Enum JSON 직렬화 에러 해결</h2>

<p><code class="language-plaintext highlighter-rouge">json.dumps</code>에 <code class="language-plaintext highlighter-rouge">default</code>를 주거나, 커스텀 <code class="language-plaintext highlighter-rouge">JSONEncoder</code>를 써서 <code class="language-plaintext highlighter-rouge">Enum</code>을 <code class="language-plaintext highlighter-rouge">.value</code>로 바꿔 주세요.</p>

<h3 id="간단-버전-default-함수-추가">간단 버전: <code class="language-plaintext highlighter-rouge">default</code> 함수 추가</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">asdict</span>

<span class="k">def</span> <span class="nf">_json_default</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
    <span class="c1"># Enum -&gt; 그 값으로 직렬화
</span>    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">o</span><span class="p">.</span><span class="n">value</span>
    <span class="c1"># 필요시 추가 핸들링 가능
</span>    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">DesignIR</span><span class="p">:</span>
    <span class="n">modules</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModuleIR</span><span class="p">]</span> <span class="o">=</span> <span class="nf">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="nf">asdict</span><span class="p">(</span><span class="n">self</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">_json_default</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="대안-encoder-클래스로">대안: Encoder 클래스로</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">EnumEncoder</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">JSONEncoder</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">o</span><span class="p">.</span><span class="n">value</span>
        <span class="k">return</span> <span class="nf">super</span><span class="p">().</span><span class="nf">default</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>

<span class="c1"># 사용
</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="nf">asdict</span><span class="p">(</span><span class="n">self</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="n">EnumEncoder</span><span class="p">)</span>
</code></pre></div></div>

<blockquote>
  <p>어느 쪽이든 결과는 동일: <code class="language-plaintext highlighter-rouge">Direction.INPUT</code> → <code class="language-plaintext highlighter-rouge">"input"</code>, <code class="language-plaintext highlighter-rouge">NetKind.WIRE</code> → <code class="language-plaintext highlighter-rouge">"wire"</code>처럼 직렬화됩니다.</p>
</blockquote>

<hr />

<h2 id="3-빠른-체크리스트-step-by-step">3) 빠른 체크리스트 (step-by-step)</h2>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">ordered_port_names</code>를 위 코드로 <strong>교체</strong></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">normalize_module</code>의 <strong>포트 처리 블록</strong> 을 위 코드로 <strong>교체</strong></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">DesignIR.to_json</code>에서 <code class="language-plaintext highlighter-rouge">default=_json_default</code> 또는 <code class="language-plaintext highlighter-rouge">cls=EnumEncoder</code>를 <strong>적용</strong></p>
  </li>
  <li>
    <p>다시 실행해서 <code class="language-plaintext highlighter-rouge">Enum</code> 직렬화 에러가 사라지는지, ANSI/Non-ANSI 모두에서 포트 방향/폭이 제대로 나오는지 확인</p>
  </li>
</ol>

<p>필요하면 <code class="language-plaintext highlighter-rouge">Port.dir</code> 타입을 일시적으로 <code class="language-plaintext highlighter-rouge">Optional[str]</code>로 바꿔도 되지만, 위처럼 <strong>Enum 유지 + 직렬화 커스터마이즈</strong> 가 더 안정적이에요.<br />
다른 부분도 막히는 게 있으면 오류 메시지랑 함께 알려줘—거기에 맞춰 추가 패치 줄게!</p>

<p class="chat--user">

1. Normalize 말고 표준화/정규화 라는 느낌으로 rename 하는 걸 제안해. 2. Port 방향이 non ansi 타입으로 되어있을 경우에 찾으면 업데이트하도록 해줘

</p>

<p>좋아—요청한 두 가지를 <strong>차근차근</strong> 반영할게.</p>

<hr />

<h1 id="1-normalize-이름을-표준화정규화-느낌으로-변경-제안">1) “Normalize” 이름을 “표준화/정규화” 느낌으로 변경 제안</h1>

<p>영어 식별자는 그대로 쓰되 의미를 “표준화/정규화”로 바꿔 읽히도록 추천해.</p>

<p><strong>이름 매핑(권장)</strong></p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">normalize_module</code> → <code class="language-plaintext highlighter-rouge">standardize_module</code> <em>(표준화)</em></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">convert_to_design_ir</code> → <code class="language-plaintext highlighter-rouge">build_standard_ir</code> <em>(표준 IR 빌드)</em></p>
  </li>
  <li>
    <p>파일명 <code class="language-plaintext highlighter-rouge">vnorm_classes.py</code> → <code class="language-plaintext highlighter-rouge">std_ir.py</code> <em>(standardized IR)</em></p>
  </li>
</ul>

<p><strong>호환용 래퍼(선택)</strong><br />
기존 호출부 안 깨지게 아래처럼 유지해도 좋아.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">convert_to_design_ir</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
    <span class="c1"># deprecated alias for backward-compat
</span>    <span class="k">return</span> <span class="nf">build_standard_ir</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h1 id="2-non-ansi-선언에서-포트-방향속성-발견-시-업데이트-로직-추가">2) Non-ANSI 선언에서 포트 방향/속성 발견 시 <strong>업데이트</strong> 로직 추가</h1>

<p>요지는 “헤더(ANSI)가 비어 있거나(non-ANSI 스타일) 또는 충돌 시 <strong>본문 선언(Decl)</strong> 을 신뢰해 덮어쓰기”다.<br />
아래 2개 조각만 교체/추가하면 됨.</p>

<h2 id="a-포트-표준화-함수-standardize_module-기존-normalize_module-대체">(A) 포트 표준화 함수: <code class="language-plaintext highlighter-rouge">standardize_module</code> (기존 <code class="language-plaintext highlighter-rouge">normalize_module</code> 대체)</h2>

<p>차이점:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Ioport</code>에서 선언 노드(first/second) 자동 감지</p>
  </li>
  <li>
    <p>일단 포트를 구성한 뒤 <strong>본문 선언으로 후처리 덮어쓰기</strong> 수행</p>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">standardize_module</span><span class="p">(</span><span class="n">mod</span><span class="p">:</span> <span class="n">vast</span><span class="p">.</span><span class="n">ModuleDef</span><span class="p">,</span> <span class="n">modlib_ports</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">ModuleIR</span><span class="p">:</span>
    <span class="n">env</span> <span class="o">=</span> <span class="nf">collect_param_env</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>

    <span class="c1"># 1) parameters (동일)
</span>    <span class="n">params</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Parameter</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="sh">"</span><span class="s">paramlist</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">mod</span><span class="p">.</span><span class="n">paramlist</span><span class="p">.</span><span class="n">params</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Parameter</span><span class="p">):</span>
                <span class="n">params</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Parameter</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value_str</span><span class="o">=</span><span class="nf">to_str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">value</span><span class="p">),</span> <span class="n">value</span><span class="o">=</span><span class="nf">eval_expr</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
                <span class="p">))</span>
    <span class="n">header_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="sh">"</span><span class="s">items</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Decl</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">item</span><span class="p">.</span><span class="nb">list</span><span class="p">:</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Parameter</span><span class="p">)</span> <span class="ow">and</span> <span class="n">e</span><span class="p">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header_names</span><span class="p">:</span>
                    <span class="n">params</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Parameter</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">e</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value_str</span><span class="o">=</span><span class="nf">to_str</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">value</span><span class="p">),</span> <span class="n">value</span><span class="o">=</span><span class="nf">eval_expr</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
                    <span class="p">))</span>

    <span class="c1"># 2) 포트 초안(헤더 기반)
</span>    <span class="n">ordered_names</span> <span class="o">=</span> <span class="nf">ordered_port_names</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
    <span class="n">ports</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Port</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">pname</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">ordered_names</span><span class="p">):</span>
        <span class="n">dir_</span><span class="p">,</span> <span class="n">signed</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">False</span>
        <span class="n">msb_s</span> <span class="o">=</span> <span class="n">lsb_s</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">msb_v</span> <span class="o">=</span> <span class="n">lsb_v</span> <span class="o">=</span> <span class="n">width_v</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># Ioport에서 first/second 어느 쪽이든 선언 노드 감지
</span>        <span class="n">decl</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">mod</span><span class="p">.</span><span class="n">portlist</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">mod</span><span class="p">.</span><span class="n">portlist</span><span class="p">.</span><span class="n">ports</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">vast</span><span class="p">.</span><span class="n">Ioport</span><span class="p">):</span>
            <span class="n">io</span> <span class="o">=</span> <span class="n">mod</span><span class="p">.</span><span class="n">portlist</span><span class="p">.</span><span class="n">ports</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">def</span> <span class="nf">_is_decl</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">vast</span><span class="p">.</span><span class="n">Input</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Output</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Inout</span><span class="p">))</span>
            <span class="k">if</span> <span class="nf">_is_decl</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">first</span><span class="p">):</span>  <span class="n">decl</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">first</span>
            <span class="k">elif</span> <span class="nf">_is_decl</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">second</span><span class="p">):</span> <span class="n">decl</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">second</span>
        <span class="k">if</span> <span class="n">decl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">decl</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Input</span><span class="p">):</span>  <span class="n">dir_</span> <span class="o">=</span> <span class="n">Direction</span><span class="p">.</span><span class="n">INPUT</span>
            <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">decl</span><span class="p">,</span> <span class="n">vast</span><span class="p">.</span><span class="n">Output</span><span class="p">):</span> <span class="n">dir_</span> <span class="o">=</span> <span class="n">Direction</span><span class="p">.</span><span class="n">OUTPUT</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">dir_</span> <span class="o">=</span> <span class="n">Direction</span><span class="p">.</span><span class="n">INOUT</span>
            <span class="n">signed</span> <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">decl</span><span class="p">,</span> <span class="sh">"</span><span class="s">signed</span><span class="sh">"</span><span class="p">,</span> <span class="bp">False</span><span class="p">))</span>
            <span class="n">msb_s</span><span class="p">,</span> <span class="n">lsb_s</span><span class="p">,</span> <span class="n">msb_v</span><span class="p">,</span> <span class="n">lsb_v</span><span class="p">,</span> <span class="n">width_v</span> <span class="o">=</span> <span class="nf">width_tuple</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">decl</span><span class="p">,</span> <span class="sh">"</span><span class="s">width</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="n">env</span><span class="p">)</span>

        <span class="c1"># 폭 미지정 → 1비트 기본
</span>        <span class="k">if</span> <span class="nf">all</span><span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">msb_s</span><span class="p">,</span> <span class="n">lsb_s</span><span class="p">,</span> <span class="n">msb_v</span><span class="p">,</span> <span class="n">lsb_v</span><span class="p">,</span> <span class="n">width_v</span><span class="p">)):</span>
            <span class="n">msb_s</span><span class="p">,</span> <span class="n">lsb_s</span><span class="p">,</span> <span class="n">msb_v</span><span class="p">,</span> <span class="n">lsb_v</span><span class="p">,</span> <span class="n">width_v</span> <span class="o">=</span> <span class="sh">"</span><span class="s">0</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">0</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>

        <span class="n">ports</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Port</span><span class="p">(</span>
            <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">pname</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">dir_</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="n">signed</span><span class="p">,</span>
            <span class="n">msb_str</span><span class="o">=</span><span class="n">msb_s</span><span class="p">,</span> <span class="n">lsb_str</span><span class="o">=</span><span class="n">lsb_s</span><span class="p">,</span> <span class="n">msb</span><span class="o">=</span><span class="n">msb_v</span><span class="p">,</span> <span class="n">lsb</span><span class="o">=</span><span class="n">lsb_v</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width_v</span>
        <span class="p">))</span>

    <span class="c1"># 3) 본문 선언(Non-ANSI)로 **후처리 덮어쓰기**
</span>    <span class="n">io_map</span> <span class="o">=</span> <span class="nf">build_io_decl_map</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
    <span class="nf">apply_nonansi_overrides</span><span class="p">(</span><span class="n">ports</span><span class="p">,</span> <span class="n">io_map</span><span class="p">,</span> <span class="n">prefer_body</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># 4) nets (포트명 제외)
</span>    <span class="n">nets_raw</span> <span class="o">=</span> <span class="nf">build_net_decl_list</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
    <span class="n">port_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">}</span>
    <span class="n">nets</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nets_raw</span> <span class="k">if</span> <span class="n">n</span><span class="p">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">port_names</span><span class="p">]</span>

    <span class="c1"># 5) instances (기존과 동일)
</span>    <span class="n">instances</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Instance</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">il</span> <span class="ow">in</span> <span class="nf">iter_instancelists</span><span class="p">(</span><span class="n">mod</span><span class="p">):</span>
        <span class="n">submod</span> <span class="o">=</span> <span class="n">il</span><span class="p">.</span><span class="n">module</span>
        <span class="n">shared_param_ovrs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Parameter</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="sh">"</span><span class="s">paramlist</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pa</span> <span class="ow">in</span> <span class="n">il</span><span class="p">.</span><span class="n">paramlist</span><span class="p">.</span><span class="n">params</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="sh">"</span><span class="s">paramname</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="n">value_node</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="sh">"</span><span class="s">argname</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="n">shared_param_ovrs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Parameter</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">value_str</span><span class="o">=</span><span class="nf">to_str</span><span class="p">(</span><span class="n">value_node</span><span class="p">),</span> <span class="n">value</span><span class="o">=</span><span class="nf">eval_expr</span><span class="p">(</span><span class="n">value_node</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
                <span class="p">))</span>
        <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">il</span><span class="p">.</span><span class="n">instances</span><span class="p">:</span>
            <span class="n">conns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Connection</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">pas</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="sh">"</span><span class="s">portlist</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="n">positional</span> <span class="o">=</span> <span class="nf">any</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="sh">"</span><span class="s">portname</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="k">for</span> <span class="n">pa</span> <span class="ow">in</span> <span class="n">pas</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">positional</span><span class="p">:</span>
                <span class="n">lib_ports</span> <span class="o">=</span> <span class="n">modlib_ports</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">submod</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pa</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">pas</span><span class="p">):</span>
                    <span class="n">pname</span> <span class="o">=</span> <span class="n">lib_ports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">lib_ports</span><span class="p">)</span> <span class="k">else</span> <span class="sa">f</span><span class="sh">"</span><span class="s">__pos</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span>
                    <span class="n">conns</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Connection</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">pname</span><span class="p">,</span> <span class="n">expr_str</span><span class="o">=</span><span class="nf">to_str</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="sh">"</span><span class="s">argname</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">))))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pa</span> <span class="ow">in</span> <span class="n">pas</span><span class="p">:</span>
                    <span class="n">conns</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Connection</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">pa</span><span class="p">.</span><span class="n">portname</span><span class="p">,</span> <span class="n">expr_str</span><span class="o">=</span><span class="nf">to_str</span><span class="p">(</span><span class="n">pa</span><span class="p">.</span><span class="n">argname</span><span class="p">)))</span>
            <span class="n">instances</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Instance</span><span class="p">(</span><span class="n">inst</span><span class="o">=</span><span class="n">inst</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="n">submod</span><span class="p">,</span>
                                      <span class="n">param_overrides</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">shared_param_ovrs</span><span class="p">),</span>
                                      <span class="n">connections</span><span class="o">=</span><span class="n">conns</span><span class="p">))</span>
    <span class="k">return</span> <span class="nc">ModuleIR</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">ports</span><span class="o">=</span><span class="n">ports</span><span class="p">,</span> <span class="n">nets</span><span class="o">=</span><span class="n">nets</span><span class="p">,</span> <span class="n">instances</span><span class="o">=</span><span class="n">instances</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="b-본문-선언-덮어쓰기-헬퍼-추가-apply_nonansi_overrides">(B) 본문 선언 덮어쓰기 헬퍼 추가: <code class="language-plaintext highlighter-rouge">apply_nonansi_overrides</code></h2>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">prefer_body=True</code>면 <strong>항상</strong> 본문 선언으로 덮어씀(권장)</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">prefer_body=False</code>면 비어있는 값만 채움</p>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">apply_nonansi_overrides</span><span class="p">(</span><span class="n">ports</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Port</span><span class="p">],</span> <span class="n">io_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">],</span> <span class="n">prefer_body</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">io_map</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">dir2</span><span class="p">,</span> <span class="n">signed2</span><span class="p">,</span> <span class="p">(</span><span class="n">msb_s2</span><span class="p">,</span> <span class="n">lsb_s2</span><span class="p">,</span> <span class="n">msb_v2</span><span class="p">,</span> <span class="n">lsb_v2</span><span class="p">,</span> <span class="n">width_v2</span><span class="p">)</span> <span class="o">=</span> <span class="n">io_map</span><span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">use_body</span><span class="p">(</span><span class="n">existing</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">new</span> <span class="nf">if </span><span class="p">(</span><span class="n">prefer_body</span> <span class="ow">or</span> <span class="n">existing</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">existing</span>

        <span class="c1"># 방향/서명/폭 모두 업데이트 규칙 적용
</span>        <span class="n">p</span><span class="p">.</span><span class="nb">dir</span>    <span class="o">=</span> <span class="nf">use_body</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nb">dir</span><span class="p">,</span> <span class="n">dir2</span><span class="p">)</span>
        <span class="n">p</span><span class="p">.</span><span class="n">signed</span> <span class="o">=</span> <span class="nf">use_body</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">signed</span><span class="p">,</span> <span class="n">signed2</span><span class="p">)</span>
        <span class="n">p</span><span class="p">.</span><span class="n">msb_str</span> <span class="o">=</span> <span class="nf">use_body</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">msb_str</span><span class="p">,</span> <span class="n">msb_s2</span><span class="p">)</span>
        <span class="n">p</span><span class="p">.</span><span class="n">lsb_str</span> <span class="o">=</span> <span class="nf">use_body</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">lsb_str</span><span class="p">,</span> <span class="n">lsb_s2</span><span class="p">)</span>
        <span class="n">p</span><span class="p">.</span><span class="n">msb</span> <span class="o">=</span> <span class="nf">use_body</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">msb</span><span class="p">,</span> <span class="n">msb_v2</span><span class="p">)</span>
        <span class="n">p</span><span class="p">.</span><span class="n">lsb</span> <span class="o">=</span> <span class="nf">use_body</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">lsb</span><span class="p">,</span> <span class="n">lsb_v2</span><span class="p">)</span>
        <span class="n">p</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="nf">use_body</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">width_v2</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="c-엔트리-포인트-이름-교체-build_standard_ir">(C) 엔트리 포인트 이름 교체 (<code class="language-plaintext highlighter-rouge">build_standard_ir</code>)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">build_standard_ir</span><span class="p">(</span><span class="n">files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">DesignIR</span><span class="p">:</span>
    <span class="n">ast</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nf">parse</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="n">mods</span> <span class="o">=</span> <span class="nf">collect_modules</span><span class="p">(</span><span class="n">ast</span><span class="p">)</span>
    <span class="n">modlib_ports</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="nf">ordered_port_names</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mods</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="n">design</span> <span class="o">=</span> <span class="nc">DesignIR</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mods</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="n">design</span><span class="p">.</span><span class="n">modules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nf">standardize_module</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">modlib_ports</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">design</span>

<span class="c1"># (선택) 하위호환
</span><span class="k">def</span> <span class="nf">convert_to_design_ir</span><span class="p">(</span><span class="n">files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">DesignIR</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">build_standard_ir</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="동작-요약-step-by-step">동작 요약 (step-by-step)</h2>

<ol>
  <li>
    <p>헤더에서 포트 <strong>초안</strong> 생성 (ANSI면 그 값 사용, 아니면 1비트 기본)</p>
  </li>
  <li>
    <p>본문 <code class="language-plaintext highlighter-rouge">Decl(Input/Output/Inout)</code> 스캔해서 <strong>io_map</strong> 생성</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">apply_nonansi_overrides(..., prefer_body=True)</code>로</p>

    <ul>
      <li>
        <p><strong>non-ANSI에서 찾은 방향/폭/서명</strong> 을 <strong>항상 덮어쓰기</strong></p>
      </li>
      <li>
        <p>결과적으로 “헤더가 비어 있고 본문에만 방향이 있는” 경우도 정확히 채워짐</p>
      </li>
    </ul>
  </li>
</ol>

<p>원하면 <code class="language-plaintext highlighter-rouge">prefer_body=False</code>로 바꿔 “헤더 우선, 빈 값만 보충” 정책도 쉽게 전환 가능해.<br />
필요 시 포트에 <code class="language-plaintext highlighter-rouge">source="ansi|body"</code> 같은 필드 추가해서 최종 값의 출처를 트래킹하는 것도 추천!</p>

        
      </section>

      <footer class="page__meta">
        
        


  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#verilog" class="page__taxonomy-item p-category" rel="tag">verilog</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2025-08-20T14:24:23+09:00">2025-08-20</time></p>

      </footer>

      

      
  <nav class="pagination">
    
      <a href="/misc/text-split-copy/" class="pagination--pager" title="텍스트 분할 복사">Previous</a>
    
    
      <a href="/python/python-class-tree/" class="pagination--pager" title="Python 클래스 트리 출력">Next</a>
    
  </nav>


    </div>

    
  </article>

  
  
    
<div class="page__related">
  
  <h2 class="page__related-title">You may also enjoy</h2>
  <div class="grid__wrapper">
    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2025-08-19-python-repr-vs-str/" rel="permalink">
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-17T15:03:57+09:00">2025-10-17</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/circuit/circuit-optimization-example/" rel="permalink">아날로그 회로 최적화 데모
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-17T15:03:52+09:00">2025-10-17</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/circuit/stateye/" rel="permalink">HSPICE StatEye 설정 방법
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-16T19:49:25+09:00">2025-10-16</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/comfyui/async-request-cancel/" rel="permalink">Async request 취소 처리
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-16T11:57:41+09:00">2025-10-16</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
  </div>
</div>

  
  
</div>

      
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        

<div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    
  </ul>
</div>


<div class="page__footer-copyright">&copy; 2013 - 2025 <a href="https://hvppyarchive.github.io">ARCHIVE</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/jekyll-themes/minimal-mistakes/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>






  </body>
</html>
