<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.27.1 by Michael Rose
  Copyright 2013-2025 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en-US" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>파일 캐시 패키지 추천 - ARCHIVE</title>
<meta name="description" content="">


  <meta name="author" content="hvppyarchive">
  
  <meta property="article:author" content="hvppyarchive">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="ARCHIVE">
<meta property="og:title" content="파일 캐시 패키지 추천">
<meta property="og:url" content="https://hvppyarchive.github.io/python/file-memory-cache/">


  <meta property="og:description" content="">







  <meta property="article:published_time" content="2025-10-28T13:03:49+09:00">





  

  


<link rel="canonical" href="https://hvppyarchive.github.io/python/file-memory-cache/">












<!-- end _includes/seo.html -->


<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->
<!-- hvppyarchive: add fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@200..900&display=swap" rel="stylesheet">

<!-- insert favicons. use https://realfavicongenerator.net/ -->
 <!-- hvppyarchive: add favicons -->
<link rel="icon" type="image/png" href="/assets/favicon/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/assets/favicon/favicon.svg" />
<link rel="shortcut icon" href="/assets/favicon/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png" />
<link rel="manifest" href="/assets/favicon/site.webmanifest" />

<!-- end custom head snippets -->

  </head>

  <body class="layout--single" dir="ltr">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          ARCHIVE
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/year-archive/"
                
                
              >Posts</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="파일 캐시 패키지 추천">
    <meta itemprop="description" content="">
    <meta itemprop="datePublished" content="2025-10-28T13:03:49+09:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://hvppyarchive.github.io/python/file-memory-cache/" itemprop="url">파일 캐시 패키지 추천
</a>
          </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-28T13:03:49+09:00">2025-10-28</time>
      </span>
    

    

    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p class="chat--user">

혹시 파일 캐시 같은 역할을 하는 파이썬 패키지나 스탠다드 라이브러리 없나? 내가 원하는거 1. 파일을 읽어서 그 내용을 캐싱해둠 2. 외부에서 사용할 때는 마치 파일을 읽듯이 접근 가능(open 등) 3. 파일이 연결 이슈 등 있어서 접속이 안될때는 최근 읽은 버젼 사용 4. 너무 캐시가 오래될 경우 + 파일이 변경되었을 경우 업데이트를 확인

</p>

<p>짧게 결론부터 말하면, “표준 라이브러리만으로는” 원하는 기능을 깔끔하게 충족시키기 어렵고, fsspec 계열을 쓰면 거의 그대로 구현할 수 있습니다. 특히 fsspec의 simplecache/filecache가 2–4번 요구사항까지 잘 커버합니다.</p>

<p>추천 경로</p>

<ol>
  <li>
    <p>fsspec + simplecache/filecache 사용</p>
  </li>
  <li>
    <p>원하면 얇은 래퍼로 TTL, 장애 시 폴백, 변경 감지 정책을 보강</p>
  </li>
</ol>

<p>왜 표준 라이브러리는 부족한가<br />
functools.lru_cache는 메모리 함수 캐시라 파일 변경 감지/오프라인 폴백을 못 합니다. urllib.request나 pathlib에도 지속 캐시가 없습니다. 결국 “파일같이 열기(open)”를 유지하면서 캐시·폴백·검증을 하려면 가상 파일시스템 레이어가 필요합니다.</p>

<p>fsspec로 바로 쓰는 방법<br />
fsspec은 open과 거의 동일한 인터페이스를 제공합니다. 뒤에 ::simplecache 또는 ::filecache를 붙이면 로컬 디스크에 캐시를 유지하고, 원본이 안 열리면 캐시를 폴백으로 씁니다.</p>

<p>HTTP 예시</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">fsspec</span>

<span class="c1"># 단순 캐시: 최초 1회 받아두고 그 다음은 로컬 캐시 사용
# 원본 접속 실패 시 자동으로 캐시로 폴백
</span><span class="k">with</span> <span class="n">fsspec</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span>
    <span class="sh">"</span><span class="s">simplecache::https://example.com/data.json</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="sh">"</span><span class="s">rt</span><span class="sh">"</span><span class="p">,</span>
    <span class="c1"># 캐시 저장 위치 지정(없으면 기본 temp)
</span>    <span class="n">cache_storage</span><span class="o">=</span><span class="sh">"</span><span class="s">/tmp/mycache</span><span class="sh">"</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
</code></pre></div></div>

<p>S3 예시(원본처럼 열기)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">fsspec</span>

<span class="c1"># filecache는 원본 갱신 감지 및 갱신(fetch) 로직을 포함
# (원본이 접근 불가면 로컬 캐시로 폴백)
</span><span class="n">url</span> <span class="o">=</span> <span class="sh">"</span><span class="s">filecache::s3://my-bucket/path/to/file.parquet</span><span class="sh">"</span>
<span class="k">with</span> <span class="n">fsspec</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span>
    <span class="n">url</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">cache_storage</span><span class="o">=</span><span class="sh">"</span><span class="s">/var/cache/myapp</span><span class="sh">"</span><span class="p">,</span>
    <span class="c1"># 필요 시 자격증명 전달
</span>    <span class="n">s3</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">anon</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">blob</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
</code></pre></div></div>

<p>simplecache vs filecache<br />
simplecache<br />
전체 파일을 한 번 내려받아 로컬 파일처럼 사용. 기본적으로 수동 무효화 전까지는 캐시를 그대로 사용. 오프라인 폴백에 매우 강함.</p>

<p>filecache<br />
원본 파일시스템의 변경을 비교·갱신하려는 목적. 원본 접근이 가능하면 최신성 확인 후 필요 시 재다운로드. 접근 불가하면 기존 캐시 사용.</p>

<p>TTL과 강제 업데이트가 필요하다면(정책 강화)<br />
fsspec 자체는 “언제 캐시를 버릴지”에 대한 강한 TTL 정책까지는 제공하지 않습니다. 보통은 다음처럼 얇은 래퍼로 보완합니다.</p>

<p>목표 충족 체크리스트</p>

<ol>
  <li>
    <p>읽은 내용을 캐시: simplecache/filecache가 디스크에 저장</p>
  </li>
  <li>
    <p>open처럼 접근: fsspec.open이 파일 핸들 제공</p>
  </li>
  <li>
    <p>연결 이슈 시 최근 버전: 캐시된 파일 자동 폴백</p>
  </li>
  <li>
    <p>오래된/변경된 경우 업데이트: filecache로 기본 지원, 여기에 TTL 로직 추가</p>
  </li>
</ol>

<p>실전용 얇은 래퍼 예시</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">fsspec</span>
<span class="kn">from</span> <span class="n">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>

<span class="k">class</span> <span class="nc">CachedOpen</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">,</span> <span class="n">ttl_seconds</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">storage</span><span class="o">=</span><span class="sh">"</span><span class="s">filecache</span><span class="sh">"</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_kwargs</span><span class="p">):</span>
        <span class="c1"># storage: "filecache" 또는 "simplecache"
</span>        <span class="n">self</span><span class="p">.</span><span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">storage</span><span class="si">}</span><span class="s">::</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache_dir</span> <span class="o">=</span> <span class="n">cache_dir</span>
        <span class="n">self</span><span class="p">.</span><span class="n">ttl</span> <span class="o">=</span> <span class="n">ttl_seconds</span>
        <span class="n">self</span><span class="p">.</span><span class="n">storage_kwargs</span> <span class="o">=</span> <span class="n">storage_kwargs</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">meta_path</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_meta_path</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_meta_path</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># URL을 파일명으로 안정화
</span>        <span class="kn">import</span> <span class="n">hashlib</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="nf">sha256</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">url</span><span class="p">.</span><span class="nf">encode</span><span class="p">()).</span><span class="nf">hexdigest</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_dir</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s">.meta.json</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_meta</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">meta_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">meta_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_save_meta</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">meta</span><span class="p">):</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">meta_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_expired</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">meta</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">ttl</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">meta</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">fetched_at</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">ttl</span>

    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_load_meta</span><span class="p">()</span>
        <span class="n">must_refresh</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_expired</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>

        <span class="c1"># 1차 시도: 새로운 핸들 시도(만약 TTL 만료거나 최초 접근이면 최신 확인)
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">fsspec</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span>
                <span class="n">self</span><span class="p">.</span><span class="n">url</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
                <span class="n">cache_storage</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">cache_dir</span><span class="p">,</span>
                <span class="o">**</span><span class="n">self</span><span class="p">.</span><span class="n">storage_kwargs</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="c1"># 성공했으면 메타 갱신
</span>                <span class="n">meta</span><span class="p">[</span><span class="sh">"</span><span class="s">fetched_at</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_save_meta</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">f</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># 원본 접근 실패. 아래에서 캐시 폴백 시도
</span>            <span class="k">pass</span>

        <span class="c1"># 2차 시도: 캐시 폴백
</span>        <span class="c1"># fsspec의 캐시 파일 경로 규칙은 내부적이라 확정 경로를 잡기 어렵습니다.
</span>        <span class="c1"># 대신 simplecache/filecache는 원본 실패에도 위의 open이 캐시를 쓰도록 설계되어 있음.
</span>        <span class="c1"># 여기까지 왔다는 건 캐시가 없거나 깨졌다는 뜻. 일관된 예외를 던집니다.
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">must_refresh</span> <span class="ow">and</span> <span class="n">meta</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">fetched_at</span><span class="sh">"</span><span class="p">):</span>
            <span class="c1"># 이 분기는 보수적으로 남겨두었지만, 일반적으로 위의 open이 캐시를 알아서 씁니다.
</span>            <span class="k">pass</span>
        <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">원본에 접속할 수 없고 유효한 캐시도 없습니다.</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 사용 예시
# 30분(1800초) 지나면 최신 확인 시도, 실패하면 기존 캐시 사용
</span><span class="n">co</span> <span class="o">=</span> <span class="nc">CachedOpen</span><span class="p">(</span>
    <span class="n">url</span><span class="o">=</span><span class="sh">"</span><span class="s">https://example.com/big.csv</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">cache_dir</span><span class="o">=</span><span class="sh">"</span><span class="s">/var/cache/myapp</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">ttl_seconds</span><span class="o">=</span><span class="mi">1800</span><span class="p">,</span>
    <span class="n">storage</span><span class="o">=</span><span class="sh">"</span><span class="s">filecache</span><span class="sh">"</span>  <span class="c1"># 또는 "simplecache"
</span><span class="p">)</span>

<span class="k">with</span> <span class="n">co</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">rt</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">head</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">readline</span><span class="p">()</span>
</code></pre></div></div>

<p>이 래퍼의 동작 방식</p>

<ol>
  <li>
    <p>평소엔 fsspec이 제공하는 캐시를 사용합니다.</p>
  </li>
  <li>
    <p>TTL이 지난 경우에는 “원본에 접근해보며” 새 버전이면 캐시를 갱신합니다.</p>
  </li>
  <li>
    <p>원본 접근이 실패하면 기존 캐시로 계속 읽을 수 있게 설계되어 있습니다(파일이 이미 캐시되어 있을 때).</p>
  </li>
  <li>
    <p>메타 파일(fetched_at)로 신선도(최근 읽은 시각)를 판단합니다.</p>
  </li>
</ol>

<p>대안 패키지 간단 비교<br />
pooch<br />
데이터 파일 버전·해시 관리에 강함. “열기 인터페이스”라기보단 “파일 내려받아 로컬 경로 반환” 스타일. open처럼 직접 다루는 작업에는 fsspec이 더 자연스럽습니다.</p>

<p>smart_open<br />
S3/GCS/HDFS/HTTP 등을 파일처럼 열게 해주는 툴. 본질적으로 스트리밍이 강점이고, 지속 캐시·오프라인 폴백은 스스로 제공하지 않습니다. 캐시가 필요하면 fsspec 쪽이 맞습니다.</p>

<p>requests-cache / cachecontrol<br />
HTTP 레벨의 요청 캐시이므로 “파일처럼 open”과는 거리가 있고, S3·FTP 등 비-HTTP 스토리지는 다루지 못합니다.</p>

<p>실무 팁<br />
프로세스/스레드 동시 접근이 있다면 파일 락(예: filelock)으로 캐시 디렉터리를 보호하세요.<br />
대용량 바이너리는 simplecache가 더 예측 가능하고, 잦은 갱신이 있는 파일은 filecache가 더 적합합니다.<br />
변경 감지를 더 강하게 하고 싶다면 ETag/Last-Modified 헤더(HTTP), ETag/VersionId(S3) 같은 메타데이터로 추가 검증을 넣을 수 있습니다.</p>

<p>다음 단계로는, 당신의 실제 소스(HTTP/S3/FTP/NFS 등)와 캐시 만료 기준(TTL, ETag, 주기적 강제 갱신)에 맞춰 위 래퍼를 맞춤화해 드릴 수 있습니다.</p>

<p class="chat--user">

사실 로컬 파일이긴한데 공유 드라이브라 완전 안정적이진 않아 캐시는 메모리에 두고 싶은데

</p>

<p>좋아, “공유 드라이브의 로컬 파일을 메모리에 캐시”하는 요구라면 fsspec 같은 디스크 캐시 대신, 파이썬 표준 도구들만으로 얇은 메모리 캐시 레이어를 얹는 게 딱입니다. 핵심 아이디어는 간단해요: 파일 내용을 바이트로 읽어 메모리에 들고 있고, 다음 접근 시 원본 파일의 mtime(수정시각)·크기를 확인해서 갱신 여부를 판단, 원본 접근 실패 시엔 메모리 캐시를 폴백으로 쓰는 것. 아래 유틸은 그걸 그대로 구현합니다.</p>

<p>메모리 캐시형 “open” 래퍼</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">io</span>
<span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="k">class</span> <span class="nc">MemFileCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    로컬(공유 드라이브 포함) 파일을 메모리에 캐싱해서
    open처럼 다룰 수 있게 하는 읽기 전용 래퍼.

    기능
    - TTL(초) 만료 또는 원본 변경(mtime/size) 시 재로딩 시도
    - 원본 접근 실패하면 기존 캐시로 폴백
    - LRU 방식으로 max_items 초과 시 오래된 항목 제거
    - 바이너리/텍스트 모드(rb/rt) 지원
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">ttl_seconds</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_items</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">default_encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">ttl</span> <span class="o">=</span> <span class="n">ttl_seconds</span>
        <span class="n">self</span><span class="p">.</span><span class="n">max_items</span> <span class="o">=</span> <span class="n">max_items</span>
        <span class="n">self</span><span class="p">.</span><span class="n">default_encoding</span> <span class="o">=</span> <span class="n">default_encoding</span>
        <span class="c1"># path -&gt; dict(data: bytes, mtime: float, size: int, fetched_at: float)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="nc">OrderedDict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_evict_if_needed</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">max_items</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">.</span><span class="nf">popitem</span><span class="p">(</span><span class="n">last</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>  <span class="c1"># LRU 제거
</span>
    <span class="k">def</span> <span class="nf">_touch_lru</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="c1"># LRU 최신화
</span>        <span class="k">if</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">.</span><span class="nf">move_to_end</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_need_refresh</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">now</span><span class="p">):</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">entry</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">ttl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">entry</span><span class="p">[</span><span class="sh">"</span><span class="s">fetched_at</span><span class="sh">"</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">ttl</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="c1"># 변경 감지: mtime 또는 size 다르면 갱신
</span>        <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="sh">"</span><span class="s">mtime</span><span class="sh">"</span><span class="p">]</span> <span class="o">!=</span> <span class="n">st</span><span class="p">.</span><span class="n">st_mtime</span> <span class="ow">or</span> <span class="n">entry</span><span class="p">[</span><span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">]</span> <span class="o">!=</span> <span class="n">st</span><span class="p">.</span><span class="n">st_size</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_read_bytes</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_ensure_cached</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># 원본 접근 자체가 안 될 때: 캐시가 있으면 폴백, 없으면 실패
</span>            <span class="k">if</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_touch_lru</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">raise</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_need_refresh</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">now</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_bytes</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">mtime</span><span class="sh">"</span><span class="p">:</span> <span class="n">st</span><span class="p">.</span><span class="n">st_mtime</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">st</span><span class="p">.</span><span class="n">st_size</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">fetched_at</span><span class="sh">"</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_touch_lru</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_evict_if_needed</span><span class="p">()</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="c1"># 로딩 실패면 기존 캐시로 폴백, 없으면 실패
</span>                <span class="k">if</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="nf">_touch_lru</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_touch_lru</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        읽기 전용 핸들 반환.
        - mode: </span><span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="s"> 또는 </span><span class="sh">"</span><span class="s">rt</span><span class="sh">"</span><span class="s">만 지원
        </span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">rt</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">읽기 전용 지원: mode는 </span><span class="sh">'</span><span class="s">rb</span><span class="sh">'</span><span class="s"> 또는 </span><span class="sh">'</span><span class="s">rt</span><span class="sh">'</span><span class="s">만 가능합니다.</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_cached</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">path</span><span class="p">]</span>  <span class="c1"># 여기까지 왔으면 반드시 존재
</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">b</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">io</span><span class="p">.</span><span class="nc">BytesIO</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">enc</span> <span class="o">=</span> <span class="n">encoding</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="n">default_encoding</span>
            <span class="k">return</span> <span class="n">io</span><span class="p">.</span><span class="nc">StringIO</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">].</span><span class="nf">decode</span><span class="p">(</span><span class="n">enc</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">))</span>
</code></pre></div></div>

<p>사용 예시</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cache</span> <span class="o">=</span> <span class="nc">MemFileCache</span><span class="p">(</span><span class="n">ttl_seconds</span><span class="o">=</span><span class="mi">1800</span><span class="p">,</span> <span class="n">max_items</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>  <span class="c1"># 30분 TTL
</span>
<span class="c1"># 바이너리 읽기
</span><span class="k">with</span> <span class="n">cache</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">/mnt/shared/data.bin</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">chunk</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>

<span class="c1"># 텍스트 읽기
</span><span class="k">with</span> <span class="n">cache</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">/mnt/shared/config.yaml</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">rt</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
</code></pre></div></div>

<p>이 구현이 네 가지 요구를 어떻게 맞추는지</p>

<ol>
  <li>
    <p>파일을 읽으면 메모리에 바이트로 캐싱. LRU로 용량 관리.</p>
  </li>
  <li>
    <p>open처럼 file-like 객체(BytesIO/StringIO) 반환. 기존 코드와의 궁합이 좋음.</p>
  </li>
  <li>
    <p>공유 드라이브 끊김 등으로 os.stat/open 실패 시, 이전에 캐시가 있으면 그대로 폴백.</p>
  </li>
  <li>
    <p>TTL이 지나면 신선도 확인을 시도하고, 원본의 mtime/size가 바뀌면 재로딩. 접근 불가면 기존 캐시 유지.</p>
  </li>
</ol>

<p>실전 팁<br />
• 공유 드라이브 특성상 mtime이 뒤늦게 반영되거나 순간적으로 stat이 실패할 수 있어요. 지금 코드는 그런 순간 실패를 폴백으로 흡수합니다.<br />
• 파일이 아주 크면 메모리 압박이 생깁니다. 큰 파일은 부분 읽기 전략을 쓰거나, 헤더/인덱스만 메모리에 두고 본문은 필요 시 디스크 캐시(fsspec simplecache)를 혼합하는 하이브리드도 좋습니다.<br />
• 변경 감지를 더 단단히 하고 싶다면, mtime/size 외에 주기적으로 해시(예: SHA-256) 계산을 추가할 수 있습니다. 다만 대용량 파일의 해시는 비용이 큽니다.<br />
• 멀티프로세스라면 메모리 캐시는 프로세스마다 따로 생깁니다. 프로세스 간 공유가 필요하면 디스크 캐시나 메모리 매핑(mmap), 혹은 중앙 캐시(예: Redis)로 설계를 바꾸는 게 맞습니다.</p>

<p>여기서 더 깔끔하게 쓰려면 cachetools의 TTLCache로 LRU+TTL을 맡기고, 데이터만 우리가 관리하는 방법도 괜찮습니다. 원하면 그 변형도 바로 적어줄게요.</p>

        
      </section>

      <footer class="page__meta">
        
        


  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#python" class="page__taxonomy-item p-category" rel="tag">python</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2025-10-28T13:03:49+09:00">2025-10-28</time></p>

      </footer>

      

      
  <nav class="pagination">
    
      <a href="/llm/comfyui-llm-tool-call/" class="pagination--pager" title="ComfyUI LLM Tool Call">Previous</a>
    
    
      <a href="/python/python-decorator/" class="pagination--pager" title="Python 데코레이터 설명">Next</a>
    
  </nav>


    </div>

    
  </article>

  
  
    
<div class="page__related">
  
  <h2 class="page__related-title">You may also enjoy</h2>
  <div class="grid__wrapper">
    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2025-08-19-python-repr-vs-str/" rel="permalink">
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-29T16:23:05+09:00">2025-10-29</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/llm/unified-mcp-interface/" rel="permalink">Python MCP 연결 방법
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-29T16:22:58+09:00">2025-10-29</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/llm/unified-mcp-interface/" rel="permalink">Python MCP 연결 방법
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-28T20:16:40+09:00">2025-10-28</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/python/python-decorator/" rel="permalink">Python 데코레이터 설명
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-28T16:53:51+09:00">2025-10-28</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
  </div>
</div>

  
  
</div>

      
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        

<div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    
  </ul>
</div>


<div class="page__footer-copyright">&copy; 2013 - 2025 <a href="https://hvppyarchive.github.io">ARCHIVE</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/jekyll-themes/minimal-mistakes/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>






  </body>
</html>
