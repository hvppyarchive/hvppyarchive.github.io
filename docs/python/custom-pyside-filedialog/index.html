<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.27.1 by Michael Rose
  Copyright 2013-2025 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en-US" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>CFileDialog 구현 방법 - ARCHIVE</title>
<meta name="description" content="">


  <meta name="author" content="hvppyarchive">
  
  <meta property="article:author" content="hvppyarchive">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="ARCHIVE">
<meta property="og:title" content="CFileDialog 구현 방법">
<meta property="og:url" content="https://hvppyarchive.github.io/python/custom-pyside-filedialog/">


  <meta property="og:description" content="">







  <meta property="article:published_time" content="2025-11-12T19:33:35+09:00">





  

  


<link rel="canonical" href="https://hvppyarchive.github.io/python/custom-pyside-filedialog/">












<!-- end _includes/seo.html -->


<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->
<!-- hvppyarchive: add fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@200..900&display=swap" rel="stylesheet">

<!-- insert favicons. use https://realfavicongenerator.net/ -->
 <!-- hvppyarchive: add favicons -->
<link rel="icon" type="image/png" href="/assets/favicon/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/assets/favicon/favicon.svg" />
<link rel="shortcut icon" href="/assets/favicon/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png" />
<link rel="manifest" href="/assets/favicon/site.webmanifest" />

<!-- end custom head snippets -->

  </head>

  <body class="layout--single" dir="ltr">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          ARCHIVE
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/year-archive/"
                
                
              >Posts</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="CFileDialog 구현 방법">
    <meta itemprop="description" content="">
    <meta itemprop="datePublished" content="2025-11-12T19:33:35+09:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://hvppyarchive.github.io/python/custom-pyside-filedialog/" itemprop="url">CFileDialog 구현 방법
</a>
          </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-11-12T19:33:35+09:00">2025-11-12</time>
      </span>
    

    

    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p class="chat--user">

PySide6(PyQt6)를 이용해서 나만의 QFileDialog를 만들고 싶어. 이름은 CFileDialog라고 하자. 그냥 Qt의 내장 다이얼로그와 비슷하면 돼 ## UI 설명 가장 위에는 현재 경로가 콤보 박스로 있고, 콤보박스를 누르면 하위 경로들을 선택할 수 있게 된다 예를 들어 지금 /a/b/c/d 에서 시작했으면 /a/b/c/d /a/b/c /a/b /a / 이런 식으로 나와야하고, 경로 클릭 시 그 경로로 다이얼로그 이동할 것. 그 옆에는 Back, Forward, Parent Directory, Create New Folder 버튼이 있다. 가운데 리스트뷰에는 현재 폴더의 하위 폴더, 파일들이 보인다. (모드에 따라 보이는게 다름, 폴더 선택 모드냐 파일 선택 모드냐) 아래에는 경로를 입력을 할 수 있는 LineEdit이 있고 경로 입력 시에 자동완성 될만한게 QCompleter로 나타난다. 이 때 네트워크 드라이브를 사용하므로 QCompleter가 매우 느릴 수 있는데, QCompleter의 역할을 쓰레드로 빼면 좋을 것 같음. 현재 경로에서 가장 일치하는 상위 10개 정도 경로만 Completer로 사용하고 경로가 완성되면 다시 리프레시 해서 상위 10개를 찾는 식으로 하면 좋을 것 같음. (중요) 그 아래에는 Type 선택 콤보박스가 있다. 그 외 사용법은 QFileDialog와 거의 동일하게 하면 좋겠음. 파일/폴더 얻을 지 Save용인지 Load용인지

</p>

<p>좋아요. 이건 꽤 본격적인 커스텀 다이얼로그 설계예요.<br />
PySide6(PyQt6 동일 구조)에서 Qt의 기본 <code class="language-plaintext highlighter-rouge">QFileDialog</code>를 재현하면서 더 유연하게 만들기 위해선 <strong>QDialog 기반의 클래스</strong> 로 직접 구현하는 게 가장 깔끔합니다.<br />
아래는 전체적인 구조와 주요 포인트를 단계별로 설명할게요.</p>

<hr />

<h2 id="핵심-구조-개요">핵심 구조 개요</h2>

<p><code class="language-plaintext highlighter-rouge">CFileDialog</code>는 기본적으로 <code class="language-plaintext highlighter-rouge">QDialog</code>를 상속받습니다.<br />
내부 구성요소는 다음과 같습니다.</p>

<ul>
  <li>
    <p><strong>상단 영역</strong> :</p>

    <ul>
      <li>
        <p>경로 콤보박스 (<code class="language-plaintext highlighter-rouge">QComboBox</code>)</p>
      </li>
      <li>
        <p>Back / Forward / Up / New Folder 버튼 (<code class="language-plaintext highlighter-rouge">QToolButton</code>)</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>중앙 영역</strong> :</p>

    <ul>
      <li>
        <p>파일/폴더 목록 (<code class="language-plaintext highlighter-rouge">QListView</code> or <code class="language-plaintext highlighter-rouge">QTreeView</code>)</p>
      </li>
      <li>
        <p>모델은 <code class="language-plaintext highlighter-rouge">QFileSystemModel</code> 사용</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>하단 영역</strong> :</p>

    <ul>
      <li>
        <p>경로 입력창 (<code class="language-plaintext highlighter-rouge">QLineEdit</code>) + 자동완성 (<code class="language-plaintext highlighter-rouge">QCompleter</code>)</p>
      </li>
      <li>
        <p>Type 선택 콤보박스 (<code class="language-plaintext highlighter-rouge">QComboBox</code>)</p>
      </li>
      <li>
        <p>확인/취소 버튼 (<code class="language-plaintext highlighter-rouge">QDialogButtonBox</code>)</p>
      </li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="주요-동작-설계">주요 동작 설계</h2>

<h3 id="1-경로-콤보박스">1. 경로 콤보박스</h3>

<p>현재 경로를 <code class="language-plaintext highlighter-rouge">/a/b/c/d</code> 형태로 표시하고, 클릭 시 아래처럼 보여야 함:</p>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">/</span><span class="nt">a</span><span class="o">/</span><span class="nt">b</span><span class="o">/</span><span class="nt">c</span><span class="o">/</span><span class="nt">d</span>
<span class="o">/</span><span class="nt">a</span><span class="o">/</span><span class="nt">b</span><span class="o">/</span><span class="nt">c</span>
<span class="o">/</span><span class="nt">a</span><span class="o">/</span><span class="nt">b</span>
<span class="o">/</span><span class="nt">a</span>
<span class="o">/</span>
</code></pre></div></div>

<p>이건 <code class="language-plaintext highlighter-rouge">QComboBox</code>를 매번 경로 변경 시 갱신하는 방식으로 구현 가능.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">update_path_combo</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="n">parts</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">subpath</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="o">*</span><span class="n">parts</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">addItem</span><span class="p">(</span><span class="n">subpath</span><span class="p">)</span>
</code></pre></div></div>

<p>콤보박스에서 항목 선택 시 <code class="language-plaintext highlighter-rouge">QFileSystemModel</code>의 root를 해당 경로로 변경.</p>

<hr />

<h3 id="2-탐색-버튼들">2. 탐색 버튼들</h3>

<ul>
  <li>
    <p><strong>Back / Forward</strong> : 간단히 <code class="language-plaintext highlighter-rouge">deque</code>를 이용한 히스토리 관리.</p>
  </li>
  <li>
    <p><strong>Up (Parent)</strong> : <code class="language-plaintext highlighter-rouge">os.path.dirname(current_path)</code>로 이동.</p>
  </li>
  <li>
    <p><strong>New Folder</strong> : <code class="language-plaintext highlighter-rouge">QInputDialog.getText()</code>로 폴더명 받아 <code class="language-plaintext highlighter-rouge">os.makedirs()</code>.</p>
  </li>
</ul>

<hr />

<h3 id="3-파일폴더-리스트">3. 파일/폴더 리스트</h3>

<p><code class="language-plaintext highlighter-rouge">QFileSystemModel</code> + <code class="language-plaintext highlighter-rouge">QListView</code> 또는 <code class="language-plaintext highlighter-rouge">QTreeView</code> 사용.<br />
선택 모드에 따라 표시되는 항목 제한 가능:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">folder</span><span class="sh">'</span><span class="p">:</span>
    <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setFilter</span><span class="p">(</span><span class="n">QDir</span><span class="p">.</span><span class="n">AllDirs</span> <span class="o">|</span> <span class="n">QDir</span><span class="p">.</span><span class="n">NoDotAndDotDot</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setFilter</span><span class="p">(</span><span class="n">QDir</span><span class="p">.</span><span class="n">AllEntries</span> <span class="o">|</span> <span class="n">QDir</span><span class="p">.</span><span class="n">NoDotAndDotDot</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">QListView.clicked</code> 시 <code class="language-plaintext highlighter-rouge">LineEdit</code> 업데이트.</p>

<hr />

<h3 id="4-경로-입력--자동완성">4. 경로 입력 + 자동완성</h3>

<p>핵심 포인트는 <strong>QCompleter를 별도 쓰레드로 관리</strong> 하는 부분이에요.<br />
대용량 네트워크 드라이브에서 디렉토리 자동완성은 느리므로,<br />
다음과 같은 비동기 구조를 씁니다.</p>

<h4 id="worker-thread">Worker Thread</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PathCompleterWorker</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
    <span class="n">paths_ready</span> <span class="o">=</span> <span class="nc">Signal</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_path</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_path</span> <span class="o">=</span> <span class="n">base_path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">walk</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">base_path</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">d</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">):</span>
                    <span class="n">matches</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">self</span><span class="p">.</span><span class="n">paths_ready</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">CFileDialog</code>에서 입력창 내용이 바뀔 때마다 이 쓰레드 실행 → <code class="language-plaintext highlighter-rouge">QCompleter</code> 갱신.</p>

<hr />

<h3 id="5-type-선택-콤보박스">5. Type 선택 콤보박스</h3>

<p>일반 파일 다이얼로그처럼 <code class="language-plaintext highlighter-rouge">*.txt</code>, <code class="language-plaintext highlighter-rouge">*.png</code> 등의 필터를 표시:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">.</span><span class="nf">addItems</span><span class="p">([</span><span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Text Files (*.txt)</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Images (*.png *.jpg)</span><span class="sh">"</span><span class="p">])</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">currentTextChanged</code> 시 모델 필터 갱신.</p>

<hr />

<h3 id="6-qfiledialog처럼-동작하게-만들기">6. QFileDialog처럼 동작하게 만들기</h3>

<p>외부 인터페이스는 기존 QFileDialog와 유사하게:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dlg</span> <span class="o">=</span> <span class="nc">CFileDialog</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">,</span> <span class="n">select_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">)</span>
<span class="k">if</span> <span class="n">dlg</span><span class="p">.</span><span class="nf">exec</span><span class="p">():</span>
    <span class="n">selected_path</span> <span class="o">=</span> <span class="n">dlg</span><span class="p">.</span><span class="nf">selected_path</span><span class="p">()</span>
</code></pre></div></div>

<p>옵션:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">mode</code>: <code class="language-plaintext highlighter-rouge">"open"</code> / <code class="language-plaintext highlighter-rouge">"save"</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">select_mode</code>: <code class="language-plaintext highlighter-rouge">"file"</code> / <code class="language-plaintext highlighter-rouge">"folder"</code></p>
  </li>
</ul>

<hr />

<h2 id="전체-구조-코드-예시-요약-버전">전체 구조 코드 예시 (요약 버전)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">PySide6.QtWidgets</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">PySide6.QtGui</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">deque</span>

<span class="k">class</span> <span class="nc">CFileDialog</span><span class="p">(</span><span class="n">QDialog</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">start_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">,</span> <span class="n">select_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">=</span> <span class="n">select_mode</span>
        <span class="n">self</span><span class="p">.</span><span class="n">history</span> <span class="o">=</span> <span class="nf">deque</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">forward_stack</span> <span class="o">=</span> <span class="nf">deque</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_path</span> <span class="o">=</span> <span class="n">start_path</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_ui</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_connect_signals</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_ui</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">setWindowTitle</span><span class="p">(</span><span class="sh">"</span><span class="s">CFileDialog</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># 상단
</span>        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span> <span class="o">=</span> <span class="nc">QComboBox</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">back_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sh">"</span><span class="s">←</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">forward_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sh">"</span><span class="s">→</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">up_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sh">"</span><span class="s">↑</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">new_folder_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">top_layout</span> <span class="o">=</span> <span class="nc">QHBoxLayout</span><span class="p">()</span>
        <span class="n">top_layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">back_btn</span><span class="p">)</span>
        <span class="n">top_layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">forward_btn</span><span class="p">)</span>
        <span class="n">top_layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">up_btn</span><span class="p">)</span>
        <span class="n">top_layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">new_folder_btn</span><span class="p">)</span>
        <span class="n">top_layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">)</span>

        <span class="c1"># 중앙
</span>        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="nc">QFileSystemModel</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setRootPath</span><span class="p">(</span><span class="sh">""</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span> <span class="o">=</span> <span class="nc">QListView</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setModel</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">)</span>

        <span class="c1"># 하단
</span>        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span> <span class="o">=</span> <span class="nc">QLineEdit</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span> <span class="o">=</span> <span class="nc">QComboBox</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">.</span><span class="nf">addItems</span><span class="p">([</span><span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">button_box</span> <span class="o">=</span> <span class="nc">QDialogButtonBox</span><span class="p">(</span><span class="n">QDialogButtonBox</span><span class="p">.</span><span class="n">Ok</span> <span class="o">|</span> <span class="n">QDialogButtonBox</span><span class="p">.</span><span class="n">Cancel</span><span class="p">)</span>

        <span class="n">bottom_layout</span> <span class="o">=</span> <span class="nc">QHBoxLayout</span><span class="p">()</span>
        <span class="n">bottom_layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">)</span>
        <span class="n">bottom_layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">)</span>

        <span class="n">layout</span> <span class="o">=</span> <span class="nc">QVBoxLayout</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addLayout</span><span class="p">(</span><span class="n">top_layout</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addLayout</span><span class="p">(</span><span class="n">bottom_layout</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_connect_signals</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="n">currentTextChanged</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_load_path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">up_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_go_up</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">back_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_go_back</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">forward_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_go_forward</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">new_folder_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_create_folder</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_item_clicked</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">.</span><span class="n">accepted</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">accept</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">.</span><span class="n">rejected</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">reject</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_path</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="k">return</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setRootIndex</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">update_path_combo</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_path_combo</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">blockSignals</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="n">parts</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">addItem</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="o">*</span><span class="n">parts</span><span class="p">[:</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">blockSignals</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_item_clicked</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">filePath</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">selected_path</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">()</span>

    <span class="c1"># 기타 버튼 함수 생략 (Back, Forward, Up, etc.)
</span></code></pre></div></div>

<hr />

<p>이 설계대로라면 Qt 내장 <code class="language-plaintext highlighter-rouge">QFileDialog</code>와 거의 동일한 인터페이스를 가지되,<br />
확장성과 사용자 지정성이 훨씬 높습니다.</p>

<p>다음 단계로는 <strong>Completer를 쓰레드로 실제 연결하는 부분</strong> 을 구현해보면 완성형에 가까워집니다.<br />
원한다면 그 부분만 이어서 구체적으로 작성해드릴게요 — 쓰레드 관리(<code class="language-plaintext highlighter-rouge">QThreadPool</code> + <code class="language-plaintext highlighter-rouge">QRunnable</code>) 방식으로.</p>

<p class="chat--user">

다음 단계로 진행해줘.

</p>

<p>좋아, 바로 “자동완성 + 스레드” 단계까지 붙여서 동작하는 전체 예제를 만들어줄게.<br />
아래 코드는 PySide6 기준이며, <code class="language-plaintext highlighter-rouge">QThreadPool + QRunnable</code>로 완성 후보 10개를 비동기로 찾고, 입력이 바뀔 때마다 최신 검색만 반영되도록 <code class="language-plaintext highlighter-rouge">task_id</code>로 레이스 컨디션을 막았어. 경로 콤보/뒤로·앞으로·상위·새폴더, 파일/폴더 모드, Open/Save, Type 필터, 히스토리, 디바운스까지 들어있어.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">fnmatch</span>
<span class="kn">import</span> <span class="n">traceback</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">deque</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Qt</span><span class="p">,</span> <span class="n">QObject</span><span class="p">,</span> <span class="n">Signal</span><span class="p">,</span> <span class="n">Slot</span><span class="p">,</span> <span class="n">QModelIndex</span><span class="p">,</span>
                                 <span class="n">QTimer</span><span class="p">,</span> <span class="n">QRunnable</span><span class="p">,</span> <span class="n">QThreadPool</span><span class="p">,</span> <span class="n">QMetaObject</span><span class="p">,</span> <span class="n">Q_ARG</span><span class="p">)</span>
    <span class="kn">from</span> <span class="n">PySide6.QtGui</span> <span class="kn">import</span> <span class="n">QIcon</span>
    <span class="kn">from</span> <span class="n">PySide6.QtWidgets</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">QApplication</span><span class="p">,</span> <span class="n">QDialog</span><span class="p">,</span> <span class="n">QVBoxLayout</span><span class="p">,</span> <span class="n">QHBoxLayout</span><span class="p">,</span> <span class="n">QToolButton</span><span class="p">,</span> <span class="n">QComboBox</span><span class="p">,</span>
        <span class="n">QListView</span><span class="p">,</span> <span class="n">QTreeView</span><span class="p">,</span> <span class="n">QFileSystemModel</span><span class="p">,</span> <span class="n">QLineEdit</span><span class="p">,</span> <span class="n">QCompleter</span><span class="p">,</span>
        <span class="n">QDialogButtonBox</span><span class="p">,</span> <span class="n">QInputDialog</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="p">,</span> <span class="n">QLabel</span><span class="p">,</span> <span class="n">QWidget</span><span class="p">,</span> <span class="n">QSizePolicy</span>
    <span class="p">)</span>
<span class="k">except</span> <span class="nb">ImportError</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">PySide6가 필요합니다. pip install PySide6</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># --------------------------
# 비동기 컴플리터 작업자
# --------------------------
</span>
<span class="k">class</span> <span class="nc">_CompleterResultEmitter</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
    <span class="n">resultsReady</span> <span class="o">=</span> <span class="nc">Signal</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>  <span class="c1"># task_id, results 리스트(str)
</span>
<span class="k">class</span> <span class="nc">PathSearchTask</span><span class="p">(</span><span class="n">QRunnable</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    입력 문자열을 기반으로 base_dir 아래에서 이름이 prefix로 시작하는 경로(파일/폴더)를
    최대 top_k개까지 찾아서 내보내는 작업. (가벼운 BFS, 얕은 탐색)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">want_files</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">want_dirs</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">depth_limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">emitter</span><span class="p">:</span> <span class="n">_CompleterResultEmitter</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">task_id</span> <span class="o">=</span> <span class="n">task_id</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">base_dir</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span>
        <span class="n">self</span><span class="p">.</span><span class="n">want_files</span> <span class="o">=</span> <span class="n">want_files</span>
        <span class="n">self</span><span class="p">.</span><span class="n">want_dirs</span> <span class="o">=</span> <span class="n">want_dirs</span>
        <span class="n">self</span><span class="p">.</span><span class="n">top_k</span> <span class="o">=</span> <span class="n">top_k</span>
        <span class="n">self</span><span class="p">.</span><span class="n">depth_limit</span> <span class="o">=</span> <span class="n">depth_limit</span>
        <span class="n">self</span><span class="p">.</span><span class="n">emitter</span> <span class="o">=</span> <span class="n">emitter</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">base_dir</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
                <span class="c1"># 베이스 디렉터리가 없으면 상위들을 타고 올라가며 존재하는 곳부터
</span>                <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="nc">Path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">base_dir</span><span class="p">).</span><span class="nf">resolve</span><span class="p">().</span><span class="n">parents</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">parent</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
                        <span class="n">base</span> <span class="o">=</span> <span class="n">parent</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                    <span class="k">return</span>

            <span class="c1"># 우선 1순위: base_dir의 직접 하위
</span>            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span>
                        <span class="c1"># 시작 접두사 매칭 (대소문자 구분 없음)
</span>                        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">want_dirs</span><span class="p">:</span>
                                <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">want_files</span><span class="p">:</span>
                                <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
                        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span>
                            <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                            <span class="k">return</span>
            <span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># 2순위: 얕은 깊이 탐색 (depth_limit)
</span>            <span class="c1"># BFS 큐: (Path, depth)
</span>            <span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">deque</span> <span class="k">as</span> <span class="n">cdeque</span>
            <span class="n">q</span> <span class="o">=</span> <span class="nf">cdeque</span><span class="p">()</span>
            <span class="n">q</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">base</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">seen</span> <span class="o">=</span> <span class="nf">set</span><span class="p">([</span><span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">)])</span>

            <span class="k">while</span> <span class="n">q</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span>
                <span class="n">cur</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="nf">popleft</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">depth_limit</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">full</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                                    <span class="c1"># 디렉터리 자체가 매칭되면 결과에
</span>                                    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">want_dirs</span> <span class="ow">and</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                                        <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">))</span>
                                        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span>
                                            <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                                            <span class="k">return</span>
                                    <span class="c1"># 하위로 진행
</span>                                    <span class="n">s</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                                        <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                                        <span class="n">q</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">full</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">want_files</span> <span class="ow">and</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                                        <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">))</span>
                                        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span>
                                            <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                                            <span class="k">return</span>
                            <span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
                                <span class="k">continue</span>
                <span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
                    <span class="k">continue</span>

        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># 에러는 무시하고 빈 결과
</span>            <span class="n">traceback</span><span class="p">.</span><span class="nf">print_exc</span><span class="p">()</span>

        <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_emit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
        <span class="c1"># UI 스레드로 안전하게 신호
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">QMetaObject</span><span class="p">.</span><span class="nf">invokeMethod</span><span class="p">(</span>
                <span class="n">self</span><span class="p">.</span><span class="n">emitter</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">resultsReady</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">Qt</span><span class="p">.</span><span class="n">QueuedConnection</span><span class="p">,</span>
                <span class="nc">Q_ARG</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="p">),</span>
                <span class="nc">Q_ARG</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">results</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

<span class="c1"># --------------------------
# CFileDialog 본체
# --------------------------
</span>
<span class="k">class</span> <span class="nc">CFileDialog</span><span class="p">(</span><span class="n">QDialog</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    모드:
      mode: </span><span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="s"> | </span><span class="sh">"</span><span class="s">save</span><span class="sh">"</span><span class="s">
      select_mode: </span><span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="s"> | </span><span class="sh">"</span><span class="s">folder</span><span class="sh">"</span><span class="s">
    QFileDialog와 유사한 사용법:
        dlg = CFileDialog(mode=</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="s">, select_mode=</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="s">, filters=[</span><span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">Images (*.png *.jpg)</span><span class="sh">"</span><span class="s">])
        if dlg.exec():
            print(dlg.selected_path())
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">start_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">,</span> <span class="n">select_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">,</span>
                 <span class="n">filters</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">setWindowTitle</span><span class="p">(</span><span class="sh">"</span><span class="s">CFileDialog</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">resize</span><span class="p">(</span><span class="mi">900</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>  <span class="c1"># open/save
</span>        <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">=</span> <span class="n">select_mode</span>  <span class="c1"># file/folder
</span>        <span class="n">self</span><span class="p">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">filters</span> <span class="ow">or</span> <span class="p">[</span><span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="p">]</span>

        <span class="n">self</span><span class="p">.</span><span class="n">history_back</span> <span class="o">=</span> <span class="nf">deque</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">history_fwd</span> <span class="o">=</span> <span class="nf">deque</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">start_path</span><span class="p">).</span><span class="nf">resolve</span><span class="p">())</span> <span class="k">if</span> <span class="n">start_path</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">()</span>

        <span class="c1"># completer state
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_completer_task_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_latest_task_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_completer_emitter</span> <span class="o">=</span> <span class="nf">_CompleterResultEmitter</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_completer_emitter</span><span class="p">.</span><span class="n">resultsReady</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_on_completer_results</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_thread_pool</span> <span class="o">=</span> <span class="n">QThreadPool</span><span class="p">.</span><span class="nf">globalInstance</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span> <span class="o">=</span> <span class="nc">QTimer</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span><span class="p">.</span><span class="nf">setInterval</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span><span class="p">.</span><span class="nf">setSingleShot</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span><span class="p">.</span><span class="n">timeout</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_spawn_completer_task</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="nf">_build_ui</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_connect_signals</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_configure_modes</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">,</span> <span class="n">push_history</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># ---------- UI 구성 ----------
</span>    <span class="k">def</span> <span class="nf">_build_ui</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># 상단 툴바
</span>        <span class="n">self</span><span class="p">.</span><span class="n">back_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">back_btn</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="sh">"</span><span class="s">Back</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">forward_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">forward_btn</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="sh">"</span><span class="s">Forward</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">up_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">up_btn</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="sh">"</span><span class="s">Parent</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">new_folder_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">new_folder_btn</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="sh">"</span><span class="s">New Folder</span><span class="sh">"</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span> <span class="o">=</span> <span class="nc">QComboBox</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="p">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="p">.</span><span class="n">Fixed</span><span class="p">)</span>

        <span class="n">top</span> <span class="o">=</span> <span class="nc">QHBoxLayout</span><span class="p">()</span>
        <span class="n">top</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">back_btn</span><span class="p">)</span>
        <span class="n">top</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">forward_btn</span><span class="p">)</span>
        <span class="n">top</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">up_btn</span><span class="p">)</span>
        <span class="n">top</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">new_folder_btn</span><span class="p">)</span>
        <span class="n">top</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">)</span>

        <span class="c1"># 중앙 파일 뷰
</span>        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="nc">QFileSystemModel</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setRootPath</span><span class="p">(</span><span class="sh">""</span><span class="p">)</span>  <span class="c1"># 전체 파일 시스템
</span>        <span class="c1"># 필터는 모드에 따라 아래에서 설정
</span>        <span class="n">self</span><span class="p">.</span><span class="n">view</span> <span class="o">=</span> <span class="nc">QTreeView</span><span class="p">()</span>  <span class="c1"># 트리로 쓰되, 루트 인덱스를 현재 경로로 심어 1계층처럼 사용
</span>        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setModel</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setRootIsDecorated</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setSortingEnabled</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">sortByColumn</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Qt</span><span class="p">.</span><span class="n">AscendingOrder</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setSelectionBehavior</span><span class="p">(</span><span class="n">QTreeView</span><span class="p">.</span><span class="n">SelectRows</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setUniformRowHeights</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1"># 보조 컬럼 정리
</span>        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setColumnWidth</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>

        <span class="c1"># 하단: 경로 입력 + Type + 버튼
</span>        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span> <span class="o">=</span> <span class="nc">QLineEdit</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setPlaceholderText</span><span class="p">(</span><span class="sh">"</span><span class="s">경로를 입력하세요…</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer_model</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 유지용 (디버그)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">completer</span> <span class="o">=</span> <span class="nc">QCompleter</span><span class="p">([],</span> <span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setCaseSensitivity</span><span class="p">(</span><span class="n">Qt</span><span class="p">.</span><span class="n">CaseInsensitive</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setFilterMode</span><span class="p">(</span><span class="n">Qt</span><span class="p">.</span><span class="n">MatchContains</span><span class="p">)</span>  <span class="c1"># prefix 기반이지만 substring도 보여주면 편함
</span>        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setCompletionMode</span><span class="p">(</span><span class="n">QCompleter</span><span class="p">.</span><span class="n">PopupCompletion</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setCompleter</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span> <span class="o">=</span> <span class="nc">QComboBox</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">.</span><span class="nf">addItems</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">filters</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">button_box</span> <span class="o">=</span> <span class="nc">QDialogButtonBox</span><span class="p">(</span><span class="n">QDialogButtonBox</span><span class="p">.</span><span class="n">Ok</span> <span class="o">|</span> <span class="n">QDialogButtonBox</span><span class="p">.</span><span class="n">Cancel</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">self</span><span class="p">)</span>

        <span class="n">bottom_row1</span> <span class="o">=</span> <span class="nc">QHBoxLayout</span><span class="p">()</span>
        <span class="n">bottom_row1</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="nc">QLabel</span><span class="p">(</span><span class="sh">"</span><span class="s">경로:</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">bottom_row1</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">)</span>
        <span class="n">bottom_row1</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="nc">QLabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Type:</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">bottom_row1</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">)</span>

        <span class="n">layout</span> <span class="o">=</span> <span class="nc">QVBoxLayout</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addLayout</span><span class="p">(</span><span class="n">top</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addLayout</span><span class="p">(</span><span class="n">bottom_row1</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">)</span>

    <span class="c1"># ---------- 시그널 연결 ----------
</span>    <span class="k">def</span> <span class="nf">_connect_signals</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">back_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_go_back</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">forward_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_go_forward</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">up_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_go_up</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">new_folder_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_create_folder</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="n">activated</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_combo_jump</span><span class="p">)</span>  <span class="c1"># 인덱스 선택 시 이동
</span>        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">doubleClicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_item_double_clicked</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_item_clicked</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="n">textEdited</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_on_path_edited</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">.</span><span class="n">currentTextChanged</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_on_filter_changed</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">.</span><span class="n">accepted</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_accept_if_valid</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">.</span><span class="n">rejected</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">reject</span><span class="p">)</span>

    <span class="c1"># ---------- 모드/필터 ----------
</span>    <span class="k">def</span> <span class="nf">_configure_modes</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">folder</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1"># 폴더만
</span>            <span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="n">QDir</span>
            <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setFilter</span><span class="p">(</span><span class="n">QDir</span><span class="p">.</span><span class="n">AllDirs</span> <span class="o">|</span> <span class="n">QDir</span><span class="p">.</span><span class="n">NoDotAndDotDot</span> <span class="o">|</span> <span class="n">QDir</span><span class="p">.</span><span class="n">Drives</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="n">QDir</span>
            <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setFilter</span><span class="p">(</span><span class="n">QDir</span><span class="p">.</span><span class="n">AllEntries</span> <span class="o">|</span> <span class="n">QDir</span><span class="p">.</span><span class="n">NoDotAndDotDot</span> <span class="o">|</span> <span class="n">QDir</span><span class="p">.</span><span class="n">Drives</span><span class="p">)</span>

        <span class="c1"># 이름 필터(패턴) 적용
</span>        <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setNameFilterDisables</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_apply_name_filters_from_combo</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_apply_name_filters_from_combo</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># "Images (*.png *.jpg)" -&gt; ["*.png", "*.jpg"]
</span>        <span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">.</span><span class="nf">currentText</span><span class="p">()</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">(</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="sh">"</span><span class="s">)</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">inside</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">text</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">(</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">text</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">)</span><span class="sh">"</span><span class="p">)]</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">inside</span><span class="p">.</span><span class="nf">split</span><span class="p">()</span> <span class="k">if</span> <span class="sh">"</span><span class="s">*</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">p</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">?</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">p</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">patterns</span><span class="p">:</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setNameFilters</span><span class="p">(</span><span class="n">patterns</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_filter_changed</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_apply_name_filters_from_combo</span><span class="p">()</span>

    <span class="c1"># ---------- 경로 로딩 ----------
</span>    <span class="k">def</span> <span class="nf">_load_path</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">push_history</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">resolve</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">push_history</span><span class="p">:</span>
            <span class="c1"># 히스토리 푸시
</span>            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">current_path</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">current_path</span> <span class="o">!=</span> <span class="n">path</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">history_back</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="n">history_fwd</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

        <span class="n">self</span><span class="p">.</span><span class="n">current_path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_update_path_combo</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setRootIndex</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

        <span class="c1"># OK 버튼 활성화 상태 갱신
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">_update_ok_enabled</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_combo_jump</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">itemText</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_path_combo</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">blockSignals</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">parts</span>
        <span class="c1"># 예: /, /a, /a/b, /a/b/c ... 혹은 Windows: C:\, C:\Users, ...
</span>        <span class="n">acc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)):</span>
            <span class="n">acc</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">joined</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="o">*</span><span class="n">acc</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">addItem</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">joined</span><span class="p">))</span>
        <span class="c1"># 현재 경로가 가장 아래쪽에 오도록 선택
</span>        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">setCurrentIndex</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">blockSignals</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># ---------- 탐색 버튼 ----------
</span>    <span class="k">def</span> <span class="nf">_go_back</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">history_back</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">history_back</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">history_fwd</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">push_history</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_go_forward</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">history_fwd</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">history_fwd</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">history_back</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">push_history</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_go_up</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">).</span><span class="n">parent</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="ow">and</span> <span class="n">parent</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_folder</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">ok</span> <span class="o">=</span> <span class="n">QInputDialog</span><span class="p">.</span><span class="nf">getText</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">새 폴더</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">폴더명:</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">name</span><span class="p">.</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="n">target</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">,</span> <span class="n">name</span><span class="p">.</span><span class="nf">strip</span><span class="p">())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">target</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="c1"># 새 폴더로 포커스 이동
</span>            <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
        <span class="k">except</span> <span class="nb">FileExistsError</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">경고</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">동일한 이름의 폴더가 이미 존재합니다.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="p">.</span><span class="nf">critical</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">오류</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">폴더를 만들 권한이 없습니다.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="p">.</span><span class="nf">critical</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">오류</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">폴더 생성 실패: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># ---------- 뷰 클릭/더블클릭 ----------
</span>    <span class="k">def</span> <span class="nf">_item_clicked</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">QModelIndex</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">filePath</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="c1"># 미리보듯 경로창에 반영
</span>        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_update_ok_enabled</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_item_double_clicked</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">QModelIndex</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">filePath</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 파일이면 경로창에 넣고 OK
</span>            <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_update_ok_enabled</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">open</span><span class="sh">'</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">accept</span><span class="p">()</span>

    <span class="c1"># ---------- OK 유효성 ----------
</span>    <span class="k">def</span> <span class="nf">_is_selection_valid</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">folder</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1"># 폴더 선택 모드
</span>            <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="c1"># Save 모드에서는 새 폴더명도 허용할지? 여기선 폴더 존재만 허용
</span>            <span class="k">return</span> <span class="bp">False</span>

        <span class="c1"># 파일 선택 모드
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1"># 존재하고, 파일이어야 함
</span>            <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
                <span class="c1"># 필터도 통과해야 함
</span>                <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">_match_type_filters</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">target</span><span class="p">).</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># save 모드: 존재 여부 무관, 상위 폴더가 있어야 함
</span>            <span class="n">parent</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">target</span><span class="p">).</span><span class="n">parent</span>
            <span class="k">if</span> <span class="n">parent</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">parent</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
                <span class="c1"># 파일명 필터도 통과하는지(선택한 필터와 맞지 않아도 저장 허용할지 정책 결정)
</span>                <span class="c1"># 여기서는 허용(사용자가 필터 바꾸지 않고 확장자 직접 입력 가능)
</span>                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_match_type_filters</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">.</span><span class="nf">currentText</span><span class="p">()</span>
        <span class="c1"># 괄호 안 패턴들 추출
</span>        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">(</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="sh">"</span><span class="s">)</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">inside</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">text</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">(</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">text</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">)</span><span class="sh">"</span><span class="p">)]</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">inside</span><span class="p">.</span><span class="nf">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">patterns</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fnmatch</span><span class="p">.</span><span class="nf">fnmatch</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">pat</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_update_ok_enabled</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">ok_btn</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">.</span><span class="nf">button</span><span class="p">(</span><span class="n">QDialogButtonBox</span><span class="p">.</span><span class="n">Ok</span><span class="p">)</span>
        <span class="n">ok_btn</span><span class="p">.</span><span class="nf">setEnabled</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_is_selection_valid</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_accept_if_valid</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_is_selection_valid</span><span class="p">():</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">accept</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">선택 확인</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">선택이 유효하지 않습니다.</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># ---------- 경로 입력 + 비동기 자동완성 ----------
</span>    <span class="k">def</span> <span class="nf">_on_path_edited</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
        <span class="c1"># 디바운스 후 검색 태스크 실행
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="c1"># 입력 중에도 OK 버튼 상태 적절히 조정
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">_update_ok_enabled</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_spawn_completer_task</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">model</span><span class="p">().</span><span class="nf">setStringList</span><span class="p">([])</span> <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">model</span><span class="p">()</span> <span class="k">else</span> <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setModel</span><span class="p">(</span><span class="nc">QCompleter</span><span class="p">([],</span> <span class="n">self</span><span class="p">).</span><span class="nf">model</span><span class="p">())</span>
            <span class="k">return</span>

        <span class="c1"># base_dir와 prefix 분리
</span>        <span class="c1"># 예: "/a/b/pa" -&gt; base="/a/b", prefix="pa"
</span>        <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">text</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">):</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="n">text</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="k">if</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="o">!=</span> <span class="sh">""</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span>

        <span class="n">want_files</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">want_dirs</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c1"># 항상 디렉터리도 제안: 경로 완성에 중요
</span>        <span class="n">top_k</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">depth_limit</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># 너무 깊이 들어가면 느려짐
</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_completer_task_id</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_latest_task_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_completer_task_id</span>
        <span class="n">task</span> <span class="o">=</span> <span class="nc">PathSearchTask</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_completer_task_id</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span>
                              <span class="n">want_files</span><span class="p">,</span> <span class="n">want_dirs</span><span class="p">,</span> <span class="n">top_k</span><span class="p">,</span> <span class="n">depth_limit</span><span class="p">,</span>
                              <span class="n">self</span><span class="p">.</span><span class="n">_completer_emitter</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_thread_pool</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

    <span class="nd">@Slot</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_on_completer_results</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="c1"># 최신 요청만 반영
</span>        <span class="k">if</span> <span class="n">task_id</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_latest_task_id</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># 결과를 가까운 경로부터 정렬(문자열 길이/사전식)
</span>        <span class="n">results_sorted</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span><span class="p">.</span><span class="nf">lower</span><span class="p">()))</span>
        <span class="c1"># QCompleter 갱신
</span>        <span class="n">model</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">model</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">and</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="sh">'</span><span class="s">setStringList</span><span class="sh">'</span><span class="p">):</span>
            <span class="n">model</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">(</span><span class="n">results_sorted</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">string_list_model</span> <span class="o">=</span> <span class="nc">QCompleter</span><span class="p">(</span><span class="n">results_sorted</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">model</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setModel</span><span class="p">(</span><span class="n">string_list_model</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">complete</span><span class="p">()</span>  <span class="c1"># 팝업 열기 시도
</span>
    <span class="c1"># ---------- 외부 API ----------
</span>    <span class="k">def</span> <span class="nf">selected_path</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>

<span class="c1"># --------------------------
# 실행 예시
# --------------------------
</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">app</span> <span class="o">=</span> <span class="nc">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span>

    <span class="c1"># 사용 예시 1: 파일 Open
</span>    <span class="n">dlg1</span> <span class="o">=</span> <span class="nc">CFileDialog</span><span class="p">(</span>
        <span class="n">start_path</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">(),</span>
        <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">select_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">filters</span><span class="o">=</span><span class="p">[</span>
            <span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">Text Files (*.txt *.md)</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">Images (*.png *.jpg *.jpeg *.bmp *.gif)</span><span class="sh">"</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">dlg1</span><span class="p">.</span><span class="nf">exec</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">OPEN FILE:</span><span class="sh">"</span><span class="p">,</span> <span class="n">dlg1</span><span class="p">.</span><span class="nf">selected_path</span><span class="p">())</span>

    <span class="c1"># 사용 예시 2: 폴더 선택
</span>    <span class="n">dlg2</span> <span class="o">=</span> <span class="nc">CFileDialog</span><span class="p">(</span>
        <span class="n">start_path</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">(),</span>
        <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">select_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">folder</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">dlg2</span><span class="p">.</span><span class="nf">exec</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">SELECT FOLDER:</span><span class="sh">"</span><span class="p">,</span> <span class="n">dlg2</span><span class="p">.</span><span class="nf">selected_path</span><span class="p">())</span>

    <span class="c1"># 사용 예시 3: 파일 Save
</span>    <span class="n">dlg3</span> <span class="o">=</span> <span class="nc">CFileDialog</span><span class="p">(</span>
        <span class="n">start_path</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">(),</span>
        <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">save</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">select_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Python (*.py)</span><span class="sh">"</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">dlg3</span><span class="p">.</span><span class="nf">exec</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">SAVE FILE:</span><span class="sh">"</span><span class="p">,</span> <span class="n">dlg3</span><span class="p">.</span><span class="nf">selected_path</span><span class="p">())</span>

    <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>설명 포인트 정리</p>

<ul>
  <li>
    <p>자동완성 비동기화<br />
입력이 바뀌면 200ms 디바운스 후 <code class="language-plaintext highlighter-rouge">QThreadPool</code>에 <code class="language-plaintext highlighter-rouge">PathSearchTask</code>를 던져서, 현재 입력 기준 <code class="language-plaintext highlighter-rouge">base_dir</code> 아래에서 이름이 접두사로 맞는 경로들을 최대 10개 찾는다. 결과는 <code class="language-plaintext highlighter-rouge">task_id</code>로 최신성 확인 후에만 <code class="language-plaintext highlighter-rouge">QCompleter</code> 모델을 갱신한다. 네트워크 드라이브처럼 느린 환경에서도 메인 스레드를 막지 않으면서 점진적으로 후보를 보여준다.</p>
  </li>
  <li>
    <p>후보 품질<br />
1순위로 현재 폴더의 직속 항목을 살피고, 부족하면 얕은 깊이(기본 2)만 BFS로 확장해 근처 경로를 제안한다. 정렬은 길이→사전식으로 해서 더 “가까운” 경로가 먼저 온다.</p>
  </li>
  <li>
    <p>필터<br />
<code class="language-plaintext highlighter-rouge">Type</code> 콤보박스의 패턴을 <code class="language-plaintext highlighter-rouge">QFileSystemModel.setNameFilters</code>로 적용했다. Open 파일 모드에서는 OK 직전에도 파일명이 패턴과 맞는지 빠르게 확인한다.</p>
  </li>
  <li>
    <p>동작 정책<br />
Open+File: 존재하는 파일만 OK.<br />
Open+Folder: 존재하는 폴더만 OK.<br />
Save+File: 상위 폴더만 존재하면 OK(파일은 없어도 됨).<br />
Save+Folder 정책은 예제에선 막아두었는데, 원하면 옵션으로 허용 로직을 추가할 수 있다.</p>
  </li>
  <li>
    <p>경로 콤보<br />
현재 경로의 루트부터 단계적으로 쌓아서 표시한다. 항목 선택 시 해당 경로로 점프한다. 히스토리 Back/Forward, 상위 이동, 새 폴더도 지원한다.</p>
  </li>
</ul>

<p>다음 확장 아이디어</p>

<ul>
  <li>
    <p>네트워크 드라이브에서 <code class="language-plaintext highlighter-rouge">depth_limit</code>를 동적으로 조절(지연 길이에 따라 1↔3).</p>
  </li>
  <li>
    <p>숨김 파일 토글, 최근 위치/즐겨찾기 사이드바 추가.</p>
  </li>
  <li>
    <p>멀티 선택 지원(파일 다중 선택 모드).</p>
  </li>
  <li>
    <p>Windows 드라이브 루트(“C:\”, “D:\”) 목록을 콤보에 자동 삽입.</p>
  </li>
</ul>

<p>추가로 원하는 동작 정책이나 세부 UX가 있으면 말해줘. 바로 코드에 녹여서 완성도를 더 끌어올려볼게.</p>

<p class="chat--user">

혹시 더 좋은 개발 방향 있어?

</p>

<p>좋지! 지금도 꽤 쓸만하지만, “더 견고하고 빠르고 확장 가능한” 방향으로 다듬을 수 있는 포인트들을 제안할게. 당장 적용할 수 있는 것부터 중장기적인 리팩터링 아이디어까지, 실전적인 순서로 정리했어.</p>

<h1 id="성능안정성">성능·안정성</h1>

<ol>
  <li>캐싱과 취소 토큰</li>
</ol>

<ul>
  <li>
    <p>자동완성 후보 탐색 결과를 디렉터리 단위로 캐시하고, mtime(디렉터리 수정 시간) + 사이즈로 신선도 체크.</p>
  </li>
  <li>
    <p>현재 task_id 방식은 최신성 보장은 되지만, 쓰레드가 불필요하게 계속 돈다는 단점이 있어. <code class="language-plaintext highlighter-rouge">PathSearchTask</code>에 <code class="language-plaintext highlighter-rouge">cancelled</code> 플래그(쓰레드 안전) 넣어서 오래 걸리는 네트워크 디렉터리 탐색을 중간 취소 가능하게 만들면 대기시간을 크게 줄일 수 있어.</p>
  </li>
</ul>

<ol>
  <li>점진적 자동완성(Incremental feed)</li>
</ol>

<ul>
  <li>한 번에 10개를 찾을 때까지 도는 대신, 3개 단위로 먼저 emit → UI 갱신 → 남은 후보 계속 탐색. 사용자는 즉시 반응을 보게 되고, 나머지는 뒤늦게 채워진다.</li>
</ul>

<ol>
  <li>QFileSystemWatcher 연동</li>
</ol>

<ul>
  <li>루트 인덱스 기준으로 하위 디렉터리에 변화가 생기면 캐시를 무효화하고 리스트뷰를 부드럽게 갱신. 네트워크 환경에서도 변화를 즉시 반영할 수 있다.</li>
</ul>

<ol>
  <li>아이콘·메타데이터 지연 로딩</li>
</ol>

<ul>
  <li><code class="language-plaintext highlighter-rouge">QFileSystemModel</code>의 아이콘 로딩은 느릴 수 있다. <code class="language-plaintext highlighter-rouge">QFileIconProvider</code>를 상속해 썸네일·아이콘을 별도 스레드에서 지연 로딩하고, 임시 기본 아이콘을 먼저 보여주면 스크롤 지연이 줄어든다.</li>
</ul>

<ol>
  <li>대용량 폴더 가상화</li>
</ol>

<ul>
  <li>수만 개 항목이 있는 디렉터리에서는 모든 항목을 모델에 올리는 것만으로도 느려진다. <code class="language-plaintext highlighter-rouge">QSortFilterProxyModel</code>로 가볍게 필터링하고, 스크롤 위치에 따라 보이는 구간만 프리페치하는 “페이징/윈도우링” 기법을 적용하면 체감 성능이 크게 좋아진다.</li>
</ul>

<h1 id="아키텍처유지보수">아키텍처·유지보수</h1>

<ol>
  <li>모델/뷰 분리 강화</li>
</ol>

<ul>
  <li>현재는 <code class="language-plaintext highlighter-rouge">QFileSystemModel</code> 하나로 대부분 해결 중. 여기에 “선택 정책”, “필터 정책”, “히스토리/네비게이션 정책”을 얹은 서비스 계층(작은 클래스로) 분리하면 테스트 용이성↑.<br />
예) <code class="language-plaintext highlighter-rouge">NavigationHistory</code>, <code class="language-plaintext highlighter-rouge">FilterPolicy</code>, <code class="language-plaintext highlighter-rouge">SelectionValidator</code>, <code class="language-plaintext highlighter-rouge">CompleterProvider</code>.</li>
</ul>

<ol>
  <li>인터페이스 호환성 레이어</li>
</ol>

<ul>
  <li><code class="language-plaintext highlighter-rouge">QFileDialog.getOpenFileName()</code> 같은 정적 API와 호환되는 래퍼 제공.<br />
예) <code class="language-plaintext highlighter-rouge">CFileDialog.getOpenFileName(parent, caption, dir, filter)</code> 형태로 반환 타입도 동일하게 맞춰주면 기존 코드 치환이 쉽다.</li>
</ul>

<ol>
  <li>유연한 플러그인 필터</li>
</ol>

<ul>
  <li>단순 패턴 필터(“*.png”) 외에 사용자 정의 필터 콜백을 지원.<br />
예) “최근 24시간 수정” “크기 100MB 이상” 같은 조건을 추가 필터로 끼워 넣기.</li>
</ul>

<ol>
  <li>테스트 전략</li>
</ol>

<ul>
  <li>로컬/네트워크 파일시스템을 흉내내는 가짜 파일시스템(fsys) 어댑터 도입. 비즈니스 로직을 fs 어댑터 인터페이스에 의존하게 하고, 테스트에서는 메모리상 가짜 트리로 검증.</li>
</ul>

<h1 id="ux탐색성">UX·탐색성</h1>

<ol>
  <li>브레드크럼(breadcrumbs) 위젯</li>
</ol>

<ul>
  <li>현재 경로 콤보는 좋지만, 클릭 가능한 조각(폴더 단추들)로 표시하면 상위로 점프가 더 직관적. 드래그로 하위 펼치기까지 지원하면 금상첨화.</li>
</ul>

<ol>
  <li>Places/사이드바</li>
</ol>

<ul>
  <li>홈, 데스크톱, 다운로드, 드라이브 루트, 즐겨찾기(핀), 최근 위치 섹션 추가. Qt의 <code class="language-plaintext highlighter-rouge">QFileDialog</code>가 주는 경험을 재현하면서도 커스텀화 가능.</li>
</ul>

<ol>
  <li>키보드 내비게이션</li>
</ol>

<ul>
  <li>F2: 이름 바꾸기, Del: 삭제(옵션), Alt+↑: 상위, Alt+←/→: 뒤/앞, Ctrl+L: 경로 포커스 같은 단축키. 텍스트 사용자가 특히 빨라진다.</li>
</ul>

<ol>
  <li>멀티선택</li>
</ol>

<ul>
  <li>파일 모드에서 다중 선택을 옵션으로 지원하고, 하단에 선택 개수/합계 크기 표시. 저장 모드에서도 “여러 개를 한 번에”는 보통 허용하지 않지만 옵션으로 노출 가능.</li>
</ul>

<ol>
  <li>자동완성 UX 디테일</li>
</ol>

<ul>
  <li>탭(Tab)으로 첫 후보 자동완성, 오른쪽 화살표로 경로 구분자 자동 삽입, 끝에 구분자 입력 시 즉시 상위 10개 하위 디렉터리 재검색 등 타자 흐름 최적화.</li>
</ul>

<h1 id="네트워크플랫포옴-고려">네트워크·플랫포옴 고려</h1>

<ol>
  <li>UNC/SMB·리눅스 마운트·맥 볼륨</li>
</ol>

<ul>
  <li>Windows UNC 경로(\server\share) 파싱과 자동완성, Linux의 /mnt, macOS의 /Volumes 감지. 네트워크 드라이브는 depth_limit을 기본 1로, 지연 시간 측정 후 동적 확장.</li>
</ul>

<ol>
  <li>심볼릭 링크·순환 방지</li>
</ol>

<ul>
  <li>BFS에서 symlink는 별도 세트로 추적, 같은 inode/경로 해시 재방문 방지. 네트워크에서 링크 루프가 있을 수 있으니 필수.</li>
</ul>

<ol>
  <li>긴 경로 지원(Windows)</li>
</ol>

<ul>
  <li>260자 제한 우회(\?\ prefix) 처리 옵션.</li>
</ul>

<ol>
  <li>권한·락 대응</li>
</ol>

<ul>
  <li>PermissionError는 이미 처리했지만, 저장 모드에서 파일 덮어쓰기 경고, 읽기전용 폴더 알림, 네트워크 타임아웃 후 재시도 버튼 같은 UX를 추가.</li>
</ul>

<h1 id="접근성현지화브랜딩">접근성·현지화·브랜딩</h1>

<ol>
  <li>접근성</li>
</ol>

<ul>
  <li>각 버튼에 <code class="language-plaintext highlighter-rouge">accessibleName/Description</code> 설정, 포커스 인디케이터 가시성 강화, 스크린리더 라벨링.</li>
</ul>

<ol>
  <li>현지화(i18n)</li>
</ol>

<ul>
  <li>문자열 분리와 <code class="language-plaintext highlighter-rouge">QTranslator</code> 적용 포인트 마련.</li>
</ul>

<ol>
  <li>테마/다크모드</li>
</ol>

<ul>
  <li>아이콘 대비, 선택 하이라이트, 고해상도 스케일링(HiDPI) 보정.</li>
</ul>

<h1 id="디테일-코드-아이디어">디테일 코드 아이디어</h1>

<ol>
  <li>취소 가능한 탐색 태스크 스텁</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PathSearchTask</span><span class="p">(</span><span class="n">QRunnable</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="p">...,</span> <span class="n">cancel_flag</span><span class="p">):</span>
        <span class="bp">...</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span> <span class="o">=</span> <span class="n">cancel_flag</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nf">slow_scan</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span><span class="p">.</span><span class="nf">is_set</span><span class="p">():</span>
                <span class="k">return</span>
            <span class="bp">...</span>
</code></pre></div></div>

<ul>
  <li>새 요청이 들어오면 이전 태스크의 <code class="language-plaintext highlighter-rouge">cancel_flag.set()</code> 호출.</li>
</ul>

<ol>
  <li>캐시 키와 무효화</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cache_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">want_files</span><span class="p">,</span> <span class="n">want_dirs</span><span class="p">)</span>
<span class="n">entries</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">entries</span> <span class="ow">or</span> <span class="n">meta</span> <span class="o">!=</span> <span class="p">(</span><span class="nf">mtime</span><span class="p">(</span><span class="n">base_dir</span><span class="p">),</span> <span class="nf">dir_size_estimate</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)):</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="nf">list_dir_fast</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
    <span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="p">(</span><span class="nf">mtime</span><span class="p">(...),</span> <span class="nf">dir_size_estimate</span><span class="p">(...)))</span>
</code></pre></div></div>

<ol>
  <li>사용자 정의 필터 콜백</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">set_custom_filters</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">predicates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">QFileInfo</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]]):</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_predicates</span> <span class="o">=</span> <span class="n">predicates</span>
<span class="c1"># proxy model의 filterAcceptsRow에서 모든 predicate AND 매칭
</span></code></pre></div></div>

<ol>
  <li>브레드크럼</li>
</ol>

<ul>
  <li><code class="language-plaintext highlighter-rouge">QToolButton</code>들을 동적으로 생성하고, 눌렀을 때 그 조각까지의 경로로 이동. 버튼에 메뉴(하위 디렉터리 미리보기) 연결하면 빠른 점프 가능.</li>
</ul>

<h1 id="단계별-적용-추천">단계별 적용 추천</h1>

<ul>
  <li>
    <p>1단계: 자동완성 취소·캐시·점진적 갱신</p>
  </li>
  <li>
    <p>2단계: 브레드크럼 + Places 사이드바 + 단축키</p>
  </li>
  <li>
    <p>3단계: 아이콘 지연 로딩 + 대용량 폴더 가상화</p>
  </li>
  <li>
    <p>4단계: 플러그인 필터·테스트 인프라·i18n</p>
  </li>
</ul>

<p>원하면 1단계(취소 가능한 자동완성 + 캐시 + 점진 emit) 코드를 네 가지 메소드만 바꿔서 바로 패치 가능한 형태로 제공할게.</p>

<p class="chat--user">

Q_ARG에서 에러나

</p>

<p>문제 포인트는 여기예요:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">QMetaObject</span><span class="p">.</span><span class="nf">invokeMethod</span><span class="p">(</span>
    <span class="n">self</span><span class="p">.</span><span class="n">emitter</span><span class="p">,</span> <span class="sh">"</span><span class="s">resultsReady</span><span class="sh">"</span><span class="p">,</span> <span class="n">Qt</span><span class="p">.</span><span class="n">QueuedConnection</span><span class="p">,</span>
    <span class="nc">Q_ARG</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="p">),</span>
    <span class="nc">Q_ARG</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">results</span><span class="p">),</span>
<span class="p">)</span>
</code></pre></div></div>

<p>PySide6에서 <code class="language-plaintext highlighter-rouge">Q_ARG(list, …)</code>는 자주 실패합니다. Qt 메타시스템이 Python의 <code class="language-plaintext highlighter-rouge">list</code> 타입을 몰라서예요. 또한 이 경우 굳이 <code class="language-plaintext highlighter-rouge">QMetaObject.invokeMethod</code>를 쓸 필요가 없습니다. 스레드 간 <code class="language-plaintext highlighter-rouge">Signal.emit()</code> 자체가 안전하게 큐드(queued)로 동작합니다.</p>

<p>가장 간단하고 견고한 수정은 다음 두 가지 중 하나입니다.</p>

<h1 id="해결-a-그냥-시그널-emit으로-바꾸기권장">해결 A: 그냥 시그널 emit으로 바꾸기(권장)</h1>

<p><code class="language-plaintext highlighter-rouge">PathSearchTask._emit()</code>을 이렇게 바꾸세요:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_emit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
    <span class="c1"># 워커(쓰레드)에서 emit하면 자동으로 QueuedConnection으로 전달됨
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">emitter</span><span class="p">.</span><span class="n">resultsReady</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></div>

<p>그리고 <code class="language-plaintext highlighter-rouge">from PySide6.QtCore import QMetaObject, Q_ARG</code> 임포트는 제거해도 됩니다.</p>

<p>이게 가장 깔끔하고 PySide6에서 권장되는 방식입니다.</p>

<h1 id="해결-b-invokemethod를-꼭-쓰고-싶다면">해결 B: invokeMethod를 꼭 쓰고 싶다면</h1>

<p><code class="language-plaintext highlighter-rouge">list</code> 같은 파이썬 컨테이너는 메타시스템에 등록되어 있지 않아서 타입 자리에 <code class="language-plaintext highlighter-rouge">object</code>를 써야 합니다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="n">QMetaObject</span><span class="p">,</span> <span class="n">Q_ARG</span>

<span class="k">def</span> <span class="nf">_emit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">QMetaObject</span><span class="p">.</span><span class="nf">invokeMethod</span><span class="p">(</span>
            <span class="n">self</span><span class="p">.</span><span class="n">emitter</span><span class="p">,</span> <span class="sh">"</span><span class="s">resultsReady</span><span class="sh">"</span><span class="p">,</span> <span class="n">Qt</span><span class="p">.</span><span class="n">QueuedConnection</span><span class="p">,</span>
            <span class="nc">Q_ARG</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="p">),</span>
            <span class="nc">Q_ARG</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">results</span><span class="p">),</span>   <span class="c1"># 핵심: list 대신 object
</span>        <span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></div>

<p>이 방식도 동작하긴 하지만, A안처럼 그냥 <code class="language-plaintext highlighter-rouge">emit()</code>을 쓰는 편이 덜 번거롭고 실전에서 오류가 적습니다.</p>

<h1 id="추가로-함께-고치면-좋은-부분">추가로 함께 고치면 좋은 부분</h1>

<p><code class="language-plaintext highlighter-rouge">QCompleter</code>에 문자열 목록을 넣을 때는 <code class="language-plaintext highlighter-rouge">QStringListModel</code> 하나를 재사용하는 게 좋아요.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="n">QStringListModel</span>

<span class="c1"># __init__에서
</span><span class="n">self</span><span class="p">.</span><span class="n">_slm</span> <span class="o">=</span> <span class="nc">QStringListModel</span><span class="p">([],</span> <span class="n">self</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">completer</span> <span class="o">=</span> <span class="nc">QCompleter</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setCaseSensitivity</span><span class="p">(</span><span class="n">Qt</span><span class="p">.</span><span class="n">CaseInsensitive</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setFilterMode</span><span class="p">(</span><span class="n">Qt</span><span class="p">.</span><span class="n">MatchContains</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setCompletionMode</span><span class="p">(</span><span class="n">QCompleter</span><span class="p">.</span><span class="n">PopupCompletion</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setCompleter</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">)</span>

<span class="c1"># 결과 수신 슬롯에서
</span><span class="nd">@Slot</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_on_completer_results</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">task_id</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_latest_task_id</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">results_sorted</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span><span class="p">.</span><span class="nf">lower</span><span class="p">()))</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">(</span><span class="n">results_sorted</span><span class="p">)</span>
    <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">complete</span><span class="p">()</span>
</code></pre></div></div>

<p>이렇게 하면 모델 재생성에 따른 깜빡임·오버헤드도 줄고, 타입 문제도 사라집니다.</p>

<p>원인 요약: <code class="language-plaintext highlighter-rouge">Q_ARG(list, …)</code> 때문에 생긴 타입 미스매치입니다. 스레드-세이프 신호를 직접 <code class="language-plaintext highlighter-rouge">emit()</code>하거나, <code class="language-plaintext highlighter-rouge">Q_ARG(object, …)</code>로 바꾸면 해결됩니다. 다음에 끊기는 곳이 있으면 에러 메시지 전문을 알려줘요. traceback 기준으로 맞는 패치를 바로 찍어드릴게요.</p>

<p class="chat--user">

아니 왜 툴이 멈추는거지 자꾸 /user/ 만 치면 멈춰

</p>

<p>멈춤 증상은 보통 세 가지 원인에서 터집니다.</p>

<ol>
  <li>
    <p>비존재/네트워크 경로에서의 과도한 스캔</p>
  </li>
  <li>
    <p>결과 적용 시 메인 스레드 쪽 재진입(Completer 팝업/모델 갱신)</p>
  </li>
  <li>
    <p>이전 태스크가 계속 돌아가는 상태에서 새 태스크가 누적(취소 불가)</p>
  </li>
</ol>

<p>아래 패치로 한 번에 잡을 수 있어요. 핵심은 취소 토큰, 안전한 모델 갱신, 루트(/)·빈 접두사에서의 스캔 억제입니다.</p>

<h1 id="1-취소-가능한-태스크--qstringlistmodel-재사용">1) 취소 가능한 태스크 + QStringListModel 재사용</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># __init__ 에 추가
</span><span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="n">QStringListModel</span>
<span class="kn">import</span> <span class="n">threading</span>

<span class="n">self</span><span class="p">.</span><span class="n">_slm</span> <span class="o">=</span> <span class="nc">QStringListModel</span><span class="p">([],</span> <span class="n">self</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">completer</span> <span class="o">=</span> <span class="nc">QCompleter</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setCaseSensitivity</span><span class="p">(</span><span class="n">Qt</span><span class="p">.</span><span class="n">CaseInsensitive</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setFilterMode</span><span class="p">(</span><span class="n">Qt</span><span class="p">.</span><span class="n">MatchContains</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setCompletionMode</span><span class="p">(</span><span class="n">QCompleter</span><span class="p">.</span><span class="n">PopupCompletion</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setCompleter</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">)</span>

<span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># 태스크 취소 토큰
</span></code></pre></div></div>

<h1 id="2-빈-접두사루트-경로에서의-스캔-제한">2) 빈 접두사/루트 경로에서의 스캔 제한</h1>

<p>접두사가 비거나 1글자일 때, 그리고 베이스가 루트일 때는 “직접 하위만” 보거나 아예 스캔을 건너뜁니다. 특히 “/user/” 같이 존재하지 않는 경로를 입력하면 베이스가 “/”로 폴백되는데, 이때 전체 BFS가 급발진할 수 있어서 막아야 해요.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PathSearchTask</span><span class="p">(</span><span class="n">QRunnable</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">want_files</span><span class="p">,</span> <span class="n">want_dirs</span><span class="p">,</span>
                 <span class="n">top_k</span><span class="p">,</span> <span class="n">depth_limit</span><span class="p">,</span> <span class="n">emitter</span><span class="p">,</span> <span class="n">cancel_flag</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">task_id</span> <span class="o">=</span> <span class="n">task_id</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">base_dir</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span>
        <span class="n">self</span><span class="p">.</span><span class="n">want_files</span> <span class="o">=</span> <span class="n">want_files</span>
        <span class="n">self</span><span class="p">.</span><span class="n">want_dirs</span> <span class="o">=</span> <span class="n">want_dirs</span>
        <span class="n">self</span><span class="p">.</span><span class="n">top_k</span> <span class="o">=</span> <span class="n">top_k</span>
        <span class="n">self</span><span class="p">.</span><span class="n">depth_limit</span> <span class="o">=</span> <span class="n">depth_limit</span>
        <span class="n">self</span><span class="p">.</span><span class="n">emitter</span> <span class="o">=</span> <span class="n">emitter</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cancel_flag</span> <span class="o">=</span> <span class="n">cancel_flag</span>

    <span class="k">def</span> <span class="nf">_cancelled</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">cancel_flag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">cancel_flag</span><span class="p">.</span><span class="nf">is_set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">base_dir</span><span class="p">)</span>
            <span class="c1"># resolve()는 네트워크/비존재 경로에서 멈출 수 있어 생략하고 exists()만 사용
</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
                <span class="c1"># 존재하는 가장 가까운 상위로 폴백
</span>                <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="p">[</span><span class="o">*</span><span class="n">base</span><span class="p">.</span><span class="n">parents</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">parent</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
                        <span class="n">base</span> <span class="o">=</span> <span class="n">parent</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">);</span> <span class="k">return</span>

            <span class="c1"># 안전장치: 루트에서 접두사 길이 &lt; 2 인 경우는 탐색하지 않음
</span>            <span class="n">is_root</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,</span> <span class="sh">"</span><span class="s">C:</span><span class="se">\\</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">D:</span><span class="se">\\</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># 윈도는 필요 시 확장
</span>            <span class="n">shallow_only</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">prefix</span> <span class="o">==</span> <span class="sh">""</span> <span class="ow">or</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">is_root</span>

            <span class="c1"># 1) 직속 항목만 먼저
</span>            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_cancelled</span><span class="p">():</span> <span class="k">return</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span>
                        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">prefix</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">want_dirs</span><span class="p">:</span>
                                <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">want_files</span><span class="p">:</span>
                                <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
                        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span>
                            <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">);</span> <span class="k">return</span>
            <span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># 2) 접두사가 충분히 길고 루트가 아니면 얕은 BFS
</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">shallow_only</span><span class="p">:</span>
                <span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">deque</span> <span class="k">as</span> <span class="n">cdeque</span>
                <span class="n">q</span> <span class="o">=</span> <span class="nf">cdeque</span><span class="p">()</span>
                <span class="n">q</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">base</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">seen</span> <span class="o">=</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">)}</span>
                <span class="k">while</span> <span class="n">q</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_cancelled</span><span class="p">():</span> <span class="k">return</span>
                    <span class="n">cur</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="nf">popleft</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">depth_limit</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_cancelled</span><span class="p">():</span> <span class="k">return</span>
                                <span class="n">full</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                                    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">want_dirs</span> <span class="ow">and</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                                        <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">))</span>
                                        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span>
                                            <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">);</span> <span class="k">return</span>
                                    <span class="n">s</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                                        <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="n">q</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">full</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">want_files</span> <span class="ow">and</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                                        <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">))</span>
                                        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span>
                                            <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">);</span> <span class="k">return</span>
                    <span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
                        <span class="k">continue</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_emit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
        <span class="c1"># 스레드에서 emit하면 자동으로 QueuedConnection
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">emitter</span><span class="p">.</span><span class="n">resultsReady</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
</code></pre></div></div>

<h1 id="3-새-입력이-오면-이전-태스크-즉시-취소">3) 새 입력이 오면 이전 태스크 즉시 취소</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_spawn_completer_task</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">([])</span>
        <span class="k">return</span>

    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">text</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">):</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="n">text</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="k">if</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span>

    <span class="n">want_files</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">want_dirs</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">top_k</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">depth_limit</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="c1"># 이전 태스크 취소
</span>    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span><span class="p">.</span><span class="nf">set</span><span class="p">()</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Event</span><span class="p">()</span>

    <span class="n">self</span><span class="p">.</span><span class="n">_completer_task_id</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_latest_task_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_completer_task_id</span>
    <span class="n">task</span> <span class="o">=</span> <span class="nc">PathSearchTask</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_completer_task_id</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span>
                          <span class="n">want_files</span><span class="p">,</span> <span class="n">want_dirs</span><span class="p">,</span> <span class="n">top_k</span><span class="p">,</span> <span class="n">depth_limit</span><span class="p">,</span>
                          <span class="n">self</span><span class="p">.</span><span class="n">_completer_emitter</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span><span class="p">)</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_thread_pool</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</code></pre></div></div>

<h1 id="4-결과-적용은-가볍게-팝업-열기는-조건부">4) 결과 적용은 가볍게, 팝업 열기는 조건부</h1>

<p>팝업을 무조건 열면 입력 중 포커스/선택과 충돌할 수 있어요. 결과가 있을 때, 에디트가 포커스를 가지고 있을 때만 팝업을 열도록 합니다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slot</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_on_completer_results</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">task_id</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_latest_task_id</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">results_sorted</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span><span class="p">.</span><span class="nf">lower</span><span class="p">()))</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">(</span><span class="n">results_sorted</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">results_sorted</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">hasFocus</span><span class="p">():</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">complete</span><span class="p">()</span>
</code></pre></div></div>

<h1 id="5-디바운스-상향--user-같은-오타-보호">5) 디바운스 상향 + “/user/” 같은 오타 보호</h1>

<p>입력이 루트로 폴백될 상황에서 자주 스캔하지 않도록 디바운스를 300~400ms로 올리고, 잘 알려진 루트 후보가 아닌 경우 빈 결과를 줍니다. 예를 들어 macOS는 “/Users”, Linux는 “/usr”, Windows는 “\server\share” 패턴만 허용.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># __init__
</span><span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span><span class="p">.</span><span class="nf">setInterval</span><span class="p">(</span><span class="mi">350</span><span class="p">)</span>

<span class="c1"># _spawn_completer_task 시작부
</span><span class="k">if</span> <span class="n">text</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,</span> <span class="sh">"</span><span class="s">/user/</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/usr/</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/Users</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="se">\\\\</span><span class="sh">"</span><span class="p">):</span>  <span class="c1"># 필요 시 규칙 확장
</span>    <span class="c1"># 루트/의심 경로는 빈 후보로
</span>    <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">([])</span>
    <span class="k">return</span>
</code></pre></div></div>

<p>이 정도만 반영해도 “/user/” 타이핑 시 전체가 멈추는 현상은 사라질 겁니다. 그래도 멈춘다면 로그를 잠깐 추가해서 어느 단계에서 막히는지 보죠.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">time</span><span class="p">,</span> <span class="n">logging</span>
<span class="n">logging</span><span class="p">.</span><span class="nf">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="p">.</span><span class="n">DEBUG</span><span class="p">)</span>

<span class="c1"># PathSearchTask.run() 주요 단계마다
</span><span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">scan base=</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s"> prefix=</span><span class="sh">'</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="si">}</span><span class="sh">'</span><span class="s"> shallow_only=</span><span class="si">{</span><span class="n">shallow_only</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># _on_completer_results
</span><span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">results[</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s">]: </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>추가 힌트<br />
QFileSystemModel도 대용량 루트에서 초기 스캔이 무겁습니다. 입력창 타이핑만으로 멈춘다면, 뷰의 루트 인덱스를 건드리는 코드가 텍스트 편집 흐름 중에 불려서 모델 프리페치가 겹치는지 확인하세요. 타이핑 중에는 <code class="language-plaintext highlighter-rouge">_load_path()</code>가 호출되지 않게(즉, <code class="language-plaintext highlighter-rouge">textEdited</code> 경로에서 루트 변경 금지) 한 번 더 점검하면 좋아요.</p>

<p class="chat--user">

근데 어디서 freeze가 발생하는건지 모르겠어

</p>

<p>가능한 “멈춤 지점”을 빨리 pinpoint하려면, 추측 말고 관측 장비를 꽂아야 해요. 아래 순서대로 넣으면 어디서 멈추는지 10분 안에 알아냅니다.</p>

<h1 id="어디서-얼어붙는지-지도-만들기">어디서 얼어붙는지 지도 만들기</h1>

<p>관찰 포인트는 보통 이 6곳입니다.</p>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">textEdited</code> → 디바운스 타이머</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">_spawn_completer_task</code> 진입부</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">PathSearchTask.run()</code>의 <code class="language-plaintext highlighter-rouge">os.scandir</code> 루프</p>
  </li>
  <li>
    <p>워커 → 메인으로 전달(<code class="language-plaintext highlighter-rouge">emit</code>)</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">_on_completer_results</code>에서 모델 갱신(<code class="language-plaintext highlighter-rouge">QStringListModel.setStringList</code>)</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QCompleter.complete()</code> 팝업 열기</p>
  </li>
</ol>

<p>여기부터는 바로 붙여 넣을 수 있는 계측 코드예요.</p>

<h2 id="1-전역-로깅스톱워치-설정">1) 전역 로깅/스톱워치 설정</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 파일 맨 위쪽
</span><span class="kn">import</span> <span class="n">logging</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">threading</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">faulthandler</span>
<span class="n">logging</span><span class="p">.</span><span class="nf">basicConfig</span><span class="p">(</span>
    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="p">.</span><span class="n">DEBUG</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="sh">"</span><span class="s">%(asctime)s.%(msecs)03d [%(threadName)s] %(levelname)s: %(message)s</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">datefmt</span><span class="o">=</span><span class="sh">"</span><span class="s">%H:%M:%S</span><span class="sh">"</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># GUI 스레드가 정지했을 때 스택 덤프하기 (리눅스/맥)
</span><span class="k">try</span><span class="p">:</span>
    <span class="n">faulthandler</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGUSR1</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="k">pass</span>
</code></pre></div></div>

<p>터미널에서 멈췄다고 느낄 때 리눅스/맥이면 <code class="language-plaintext highlighter-rouge">kill -USR1 &lt;pid&gt;</code>를 치면 모든 스레드 스택이 출력돼요. 윈도우라면 아래 단축키로 덤프하게 하면 됩니다.</p>

<h2 id="2-gui-이벤트-루프가-실제로-멈췄는지-감지워치독">2) GUI 이벤트 루프가 실제로 멈췄는지 감지(워치독)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># CFileDialog.__init__ 끝에 추가
</span><span class="n">self</span><span class="p">.</span><span class="n">_heartbeat</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">self</span><span class="p">.</span><span class="n">_watchdog</span> <span class="o">=</span> <span class="nc">QTimer</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">_watchdog</span><span class="p">.</span><span class="nf">setInterval</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>  <span class="c1"># 0.2초마다 heartbeat++
</span><span class="n">self</span><span class="p">.</span><span class="n">_watchdog</span><span class="p">.</span><span class="n">timeout</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="nf">setattr</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">_heartbeat</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_heartbeat</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">self</span><span class="p">.</span><span class="n">_watchdog</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>

<span class="c1"># 1초마다 GUI가 살아있는지 백그라운드 스레드에서 체크
</span><span class="k">def</span> <span class="nf">_watch_gui</span><span class="p">():</span>
    <span class="n">last</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_heartbeat</span>
        <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cur</span> <span class="o">==</span> <span class="n">self</span><span class="p">.</span><span class="n">_heartbeat</span><span class="p">:</span>
            <span class="n">logging</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sh">"</span><span class="s">GUI event loop stalled ≥1s</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">cur</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_watch_gui</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">GUI-Watchdog</span><span class="sh">"</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">t</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
</code></pre></div></div>

<p>로그에 “stalled”가 찍히면 진짜 메인스레드가 멈춘 겁니다. 안 찍히면 워커가 오래 걸리거나, <code class="language-plaintext highlighter-rouge">complete()</code> 같은 호출이 포커스 충돌로 느려지는 케이스일 가능성이 큽니다.</p>

<h2 id="3-각-단계-계측-로그">3) 각 단계 계측 로그</h2>

<h3 id="3-1-입력태스크-생성">3-1) 입력→태스크 생성</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_on_path_edited</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">EDIT text=</span><span class="sh">'</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">()</span><span class="si">}</span><span class="sh">'"</span><span class="p">)</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">self</span><span class="p">.</span><span class="nf">_update_ok_enabled</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_spawn_completer_task</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">SPAWN text=</span><span class="sh">'</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="sh">'"</span><span class="p">)</span>
    <span class="n">start_t</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>

    <span class="c1"># 기존 취소
</span>    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span><span class="p">.</span><span class="nf">set</span><span class="p">()</span>

    <span class="c1"># base_dir, prefix 계산
</span>    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">text</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">):</span>
        <span class="n">base_dir</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">text</span><span class="p">,</span> <span class="sh">""</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="k">if</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span>

    <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">SPAWN base=</span><span class="sh">'</span><span class="si">{</span><span class="n">base_dir</span><span class="si">}</span><span class="sh">'</span><span class="s"> prefix=</span><span class="sh">'</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="sh">'"</span><span class="p">)</span>

    <span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Event</span><span class="p">()</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_completer_task_id</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_latest_task_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_completer_task_id</span>
    <span class="n">task</span> <span class="o">=</span> <span class="nc">PathSearchTask</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_completer_task_id</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span>
                          <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                          <span class="n">self</span><span class="p">.</span><span class="n">_completer_emitter</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span><span class="p">)</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_thread_pool</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">SPAWN dispatched in </span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span><span class="o">-</span><span class="n">start_t</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> ms</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="3-2-워커-내부">3-2) 워커 내부</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PathSearchTask</span><span class="p">(</span><span class="n">QRunnable</span><span class="p">):</span>
    <span class="bp">...</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
        <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[TASK </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="si">}</span><span class="s">] start base=</span><span class="sh">'</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_dir</span><span class="si">}</span><span class="sh">'</span><span class="s"> prefix=</span><span class="sh">'</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="si">}</span><span class="sh">'"</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">base_dir</span><span class="p">)</span>  <span class="c1"># resolve()는 멈출 수 있어 생략
</span>            <span class="c1"># 1) 직속
</span>            <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">it</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_cancelled</span><span class="p">():</span> 
                            <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[TASK </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="si">}</span><span class="s">] cancelled during scandir</span><span class="sh">"</span><span class="p">)</span>
                            <span class="k">return</span>
                        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">prefix</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                            <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">)))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">)))</span>
                        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span>
                            <span class="k">break</span>
            <span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[TASK </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="si">}</span><span class="s">] direct children took </span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> ms; results=</span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

            <span class="c1"># 2) BFS는 길면 여기서 오래 걸림
</span>            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">prefix</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,):</span>
                <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
                <span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">deque</span> <span class="k">as</span> <span class="n">cdeque</span>
                <span class="n">q</span> <span class="o">=</span> <span class="nf">cdeque</span><span class="p">([(</span><span class="n">base</span><span class="p">,</span><span class="mi">0</span><span class="p">)])</span>
                <span class="n">seen</span> <span class="o">=</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">)}</span>
                <span class="k">while</span> <span class="n">q</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_cancelled</span><span class="p">():</span>
                        <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[TASK </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="si">}</span><span class="s">] cancelled during BFS</span><span class="sh">"</span><span class="p">)</span>
                        <span class="k">return</span>
                    <span class="n">cur</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="nf">popleft</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">depth_limit</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_cancelled</span><span class="p">():</span> <span class="k">return</span>
                                <span class="n">full</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                                    <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                                        <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">))</span>
                                        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span> <span class="k">break</span>
                                    <span class="n">s</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                                        <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="n">q</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">full</span><span class="p">,</span> <span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                                        <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">))</span>
                                        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span> <span class="k">break</span>
                    <span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[TASK </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="si">}</span><span class="s">] BFS took </span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span><span class="o">-</span><span class="n">t2</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> ms; results=</span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[TASK </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="si">}</span><span class="s">] total </span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> ms; emit </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">emitter</span><span class="p">.</span><span class="n">resultsReady</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="3-3-결과-적용부">3-3) 결과 적용부</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slot</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_on_completer_results</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">RESULTS task=</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s"> latest=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_latest_task_id</span><span class="si">}</span><span class="s"> count=</span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s"> focus=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">hasFocus</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">task_id</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_latest_task_id</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
    <span class="n">results_sorted</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span><span class="p">.</span><span class="nf">lower</span><span class="p">()))</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">(</span><span class="n">results_sorted</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">results_sorted</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">hasFocus</span><span class="p">():</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">complete</span><span class="p">()</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">APPLY setStringList </span><span class="si">{</span><span class="p">(</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> ms; complete </span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> ms</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="4-루트의심-경로-차단-규칙-추가">4) 루트·의심 경로 차단 규칙 추가</h2>

<p>“/user/” 같은 오타가 루트 스캔으로 번지는 걸 방지합니다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_spawn_completer_task</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">text</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,</span> <span class="sh">"</span><span class="s">/user/</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/users</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/usr</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="se">\\\\</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sh">"</span><span class="s">SPAWN short-circuit: suspicious root-ish path</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">([])</span>
        <span class="k">return</span>
    <span class="bp">...</span>
</code></pre></div></div>

<h2 id="5-수사-가이드라인">5) 수사 가이드라인</h2>

<p>로그를 켠 상태에서 직접 타이핑해 보세요.</p>

<ul>
  <li>
    <p>로그가 <code class="language-plaintext highlighter-rouge">RESULTS ...</code>까진 잘 나오는데 화면이 버벅이면, <code class="language-plaintext highlighter-rouge">setStringList</code>나 <code class="language-plaintext highlighter-rouge">complete()</code>가 범인입니다.<br />
해결: 후보가 0개일 땐 <code class="language-plaintext highlighter-rouge">complete()</code> 호출 금지, 후보 수를 200개 이상으로 만들지 않기, 팝업이 열려 있을 때만 <code class="language-plaintext highlighter-rouge">complete()</code> 호출.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">TASK ... direct children took ... BFS took ...</code>가 수백~수천 ms로 길면 워커가 네트워크 경로를 훑느라 오래 걸립니다.<br />
해결: <code class="language-plaintext highlighter-rouge">depth_limit=1</code>, prefix 길이 2 미만이면 BFS 금지, 혹은 “직속 하위만”으로 제한.</p>
  </li>
  <li>
    <p>“GUI event loop stalled ≥1s”가 뜨면 메인 스레드가 막힌 겁니다. 이때 SIGUSR1(리눅스/맥)이나 아래 단축키로 스택을 덤프해 원인을 봅니다.</p>
  </li>
</ul>

<h2 id="6-모든-스레드-스택을-단축키로-덤프윈도우-포함">6) 모든 스레드 스택을 단축키로 덤프(윈도우 포함)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># CFileDialog._build_ui() 마지막쯤
</span><span class="n">QShortcut</span> <span class="o">=</span> <span class="nf">__import__</span><span class="p">(</span><span class="sh">"</span><span class="s">PySide6.QtGui</span><span class="sh">"</span><span class="p">,</span> <span class="n">fromlist</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">QShortcut</span><span class="sh">"</span><span class="p">]).</span><span class="n">QShortcut</span>
<span class="n">QKeySequence</span> <span class="o">=</span> <span class="nf">__import__</span><span class="p">(</span><span class="sh">"</span><span class="s">PySide6.QtGui</span><span class="sh">"</span><span class="p">,</span> <span class="n">fromlist</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">QKeySequence</span><span class="sh">"</span><span class="p">]).</span><span class="n">QKeySequence</span>
<span class="n">dump_shortcut</span> <span class="o">=</span> <span class="nc">QShortcut</span><span class="p">(</span><span class="nc">QKeySequence</span><span class="p">(</span><span class="sh">"</span><span class="s">F12</span><span class="sh">"</span><span class="p">),</span> <span class="n">self</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_dump</span><span class="p">():</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sh">"</span><span class="s">=== STACK DUMP REQUESTED ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">faulthandler</span><span class="p">.</span><span class="nf">dump_traceback</span><span class="p">(</span><span class="n">all_threads</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">faulthandler dump failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="n">dump_shortcut</span><span class="p">.</span><span class="n">activated</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">_dump</span><span class="p">)</span>
</code></pre></div></div>

<p>F12를 누르면 현재 모든 스레드의 파이썬 스택이 출력됩니다. 거기에 <code class="language-plaintext highlighter-rouge">QFileSystemModel.index()</code>, <code class="language-plaintext highlighter-rouge">QCompleter.complete()</code>, <code class="language-plaintext highlighter-rouge">os.scandir()</code> 등이 보이면 범인이 명확해져요.</p>

<hr />

<p>이 계측을 넣고 타이핑해 보면, 멈춤이 1) 워커 과부하인지, 2) 결과 적용(모델/컴플리터)에서 포커스 재진입 문제인지, 3) 루트 스캔 폭주인지 바로 드러납니다. 로그 몇 줄만 붙여 주면, 그에 맞춰 해당 지점을 수술해서 완전히 고정해 드릴게요.</p>

<p class="chat--user">

너무 많이 찾을까봐 10개로 줄였잖아

</p>

<p>맞아요, “10개만”으로 제한해도 멈출 수 있어요. 이유는 “개수”가 아니라 “나열(열기) 자체”가 막히기 때문이에요. 네트워크/루트 경로에서 <code class="language-plaintext highlighter-rouge">os.scandir()</code>(혹은 존재 확인) 자체가 블로킹되면 결과를 1개만 원해도 그 1개를 얻기 전에 스레드가 붙잡혀요. 심지어 <code class="language-plaintext highlighter-rouge">Path(...).resolve()</code>도 원격 경로에서 멈출 수 있습니다.</p>

<p>아래처럼 바꾸면 멈춤 원인을 사실상 제거할 수 있습니다. 변화량은 작고 효과는 큽니다.</p>

<h1 id="멈춤을-유발하는-지점">멈춤을 유발하는 지점</h1>

<ul>
  <li>
    <p>루트(<code class="language-plaintext highlighter-rouge">/</code>, <code class="language-plaintext highlighter-rouge">C:\</code>, <code class="language-plaintext highlighter-rouge">\\server\</code>) 또는 잘못된 상위에서 <code class="language-plaintext highlighter-rouge">scandir()</code> 시도</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">resolve()</code>로 네트워크/심볼릭 링크 추적</p>
  </li>
  <li>
    <p>짧은 접두사(예: “/us”)일 때 광범위 탐색</p>
  </li>
  <li>
    <p>이전 작업을 취소해도 실제 <code class="language-plaintext highlighter-rouge">scandir()</code>가 이미 막혔으면 스레드가 오래 살아있음(새 입력과 경합)</p>
  </li>
</ul>

<h1 id="안전장치-6종-세트">안전장치 6종 세트</h1>

<ol>
  <li>절대 <code class="language-plaintext highlighter-rouge">resolve()</code> 금지<br />
자동완성 워커에서는 경로 정규화가 필요 없습니다. 존재 확인만 느슨하게:</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># base = Path(self.base_dir).resolve()  # 금지
</span><span class="n">base</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">base_dir</span><span class="p">)</span>              <span class="c1"># 그대로 둠
# 존재 확인도 느리면 건너뜀
</span><span class="n">exists_try</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">260</span> <span class="k">else</span> <span class="bp">True</span>
</code></pre></div></div>

<ol>
  <li>“루트 + 짧은 접두사”는 스캔하지 않기<br />
루트에서 길이 0~1 접두사는 거의 항상 과탐색을 유도합니다.</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">is_unc</span>   <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">).</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="se">\\\\</span><span class="sh">"</span><span class="p">)</span>
<span class="n">is_root</span>  <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,</span> <span class="sh">"</span><span class="s">C:</span><span class="se">\\</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">D:</span><span class="se">\\</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_unc</span> <span class="ow">or</span> <span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">).</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/Volumes</span><span class="sh">"</span><span class="p">)</span>
<span class="n">short_prefix</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span> <span class="o">==</span> <span class="sh">""</span> <span class="ow">or</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">if</span> <span class="n">is_root</span> <span class="ow">and</span> <span class="n">short_prefix</span><span class="p">:</span>
    <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">([]);</span> <span class="k">return</span>
</code></pre></div></div>

<ol>
  <li>직속 항목만 “가능할 때만” 확인<br />
<code class="language-plaintext highlighter-rouge">scandir()</code> 호출 자체가 막히면 답이 없으니, 먼저 “짧은 시간 예열” 후 넘깁니다.</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">time</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_cancelled</span><span class="p">():</span> <span class="k">return</span>
            <span class="c1"># … 필터링 …
</span>            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span> <span class="k">break</span>
            <span class="nf">if </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>  <span class="c1"># 50ms 이상 쓰면 중단
</span>                <span class="k">break</span>
<span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="k">except</span> <span class="nb">OSError</span><span class="p">:</span>
    <span class="c1"># 원격 타임아웃/연결 문제 등
</span>    <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">);</span> <span class="k">return</span>
</code></pre></div></div>

<p>시간 예산을 50~100ms로 두면 “타자 중” 응답성이 유지됩니다.</p>

<ol>
  <li>BFS 완전 금지(혹은 매우 엄격히)<br />
자동완성에서 BFS는 체감가치 대비 리스크가 큽니다. 최소 요건을 이렇게:</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_root</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">):</span>
    <span class="c1"># BFS 생략
</span>    <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">);</span> <span class="k">return</span>
<span class="c1"># 그래도 하려면 depth_limit=1, 그리고 동일한 50ms 타임박스 내로
</span></code></pre></div></div>

<ol>
  <li>별도 스레드풀 + 단일 스레드<br />
이전 작업이 막히더라도 새 작업이 또 채워지지 않도록 자동완성 전용 풀을 만들어 1개만 돌립니다.</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># __init__
</span><span class="n">self</span><span class="p">.</span><span class="n">_auto_pool</span> <span class="o">=</span> <span class="nc">QThreadPool</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">_auto_pool</span><span class="p">.</span><span class="nf">setMaxThreadCount</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 동시에 1개만
</span>
<span class="c1"># _spawn_completer_task 끝
</span><span class="n">self</span><span class="p">.</span><span class="n">_auto_pool</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>  <span class="c1"># 기존 globalInstance() 대신
</span></code></pre></div></div>

<ol>
  <li>입력 정책: “확실할 때만 자동완성”<br />
네트워크 경로/루트에서 접두사 2글자 미만이면 아예 후보를 내지 않습니다. UX적으로도 납득이 됩니다.</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># _spawn_completer_task 초반
</span><span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
<span class="k">if</span> <span class="n">text</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,</span> <span class="sh">"</span><span class="se">\\\\</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">text</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">text</span><span class="p">).</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">([]);</span> <span class="k">return</span>

<span class="c1"># UNC나 /Volumes, /mnt, /net 등에서 prefix&lt;2면 스킵
</span><span class="n">s</span> <span class="o">=</span> <span class="n">text</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span>
<span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="se">\\\\</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/volumes</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/mnt</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/net</span><span class="sh">"</span><span class="p">):</span>
    <span class="n">tail</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">text</span><span class="p">).</span><span class="n">name</span>
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">tail</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">([]);</span> <span class="k">return</span>
</code></pre></div></div>

<h1 id="작게-고쳐도-큰-효과가-나는-포인트">작게 고쳐도 큰 효과가 나는 포인트</h1>

<ul>
  <li><code class="language-plaintext highlighter-rouge">QCompleter</code> 갱신은 최대 10개라도, 팝업을 매번 열면 메인 스레드가 레이아웃·측정으로 바빠집니다. 결과가 비었으면 <code class="language-plaintext highlighter-rouge">complete()</code> 호출 금지, 이미 열려 있으면만 갱신:</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slot</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_on_completer_results</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">task_id</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_latest_task_id</span><span class="p">:</span> <span class="k">return</span>
    <span class="n">items</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:(</span><span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span><span class="p">.</span><span class="nf">lower</span><span class="p">()))[:</span><span class="mi">10</span><span class="p">]</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">items</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">hasFocus</span><span class="p">()</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">popup</span><span class="p">().</span><span class="nf">isVisible</span><span class="p">():</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">complete</span><span class="p">()</span>
</code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">textEdited</code>에서 절대 <code class="language-plaintext highlighter-rouge">_load_path()</code>를 호출하지 말 것. 입력 중 루트 인덱스 변경은 <code class="language-plaintext highlighter-rouge">QFileSystemModel</code>의 백그라운드 스캔을 유발해 같이 굳습니다.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">exists()</code>도 원격에서 느릴 수 있으니, 자동완성 워커에서는 사용을 최소화하고, 최종 OK 검증 때만 엄격히 확인하세요.</p>
  </li>
</ul>

<h1 id="한-번에-적용하는-최소-패치-요약">한 번에 적용하는 최소 패치 요약</h1>

<ul>
  <li>
    <p>워커에서 <code class="language-plaintext highlighter-rouge">resolve()</code> 제거</p>
  </li>
  <li>
    <p>루트+짧은 접두사면 바로 빈 결과 반환</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">scandir()</code>에 50~100ms 타임박스</p>
  </li>
  <li>
    <p>BFS 끄기(혹은 prefix≥3 &amp; depth=1 &amp; 타임박스)</p>
  </li>
  <li>
    <p>자동완성 전용 <code class="language-plaintext highlighter-rouge">QThreadPool(max=1)</code> 사용</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">complete()</code>는 팝업 열려 있을 때만</p>
  </li>
</ul>

<p>이렇게만 바꿔도 “/user/만 치면 멈춤” 류가 사라집니다.<br />
개수 제한은 “열거가 끝난 뒤”에나 의미가 있으니, 열거 자체가 막히지 않게 설계를 틀어주는 게 핵심입니다.</p>

<p class="chat--user">

근데 쓰레드에서 요청하는건데 왜 gui도 freeze 되는거임

</p>

<p>짚고 넘어가자면, “워커 스레드에서 돌리는데도 GUI가 얼어붙는” 건 꽤 흔한 현상이에요. 원인은 보통 아래 네 가지 중 하나(혹은 복합)입니다. 핵심은 GUI가 진짜 멈춘 게 아니라, 메인 스레드가 일을 못 하거나 대기 상태에 빠져 “멈춘 것처럼 보이는” 겁니다.</p>

<h1 id="왜-멈추는가">왜 멈추는가</h1>

<ol>
  <li>
    <p>GIL(파이썬 전역 락) 점유로 메인 스레드가 굶주림<br />
워커 스레드가 파일 시스템을 훑으면서 Python 레벨 루프를 오래 돌면 GIL을 오래 쥐고 있게 됩니다. Qt의 이벤트 루프 자체는 C++이라 돌아가지만, 메인 스레드에서 실행되는 Python 슬롯/타이머/paint 이벤트 처리에는 GIL이 필요합니다. 워커가 GIL을 오래 잡고 있으면 메인 쪽 Python 코드가 실행되지 못해 “프리즈처럼” 보입니다.<br />
증상: 타이머 콜백, 슬롯이 늦게 오거나 아예 멈춘 것처럼 보임.</p>
  </li>
  <li>
    <p>메인 스레드 쪽에서 무거운 작업이 실행됨<br />
신호는 큐드(queued)로 잘 왔는데, 결과를 적용하는 슬롯에서 무거운 일을 하면(대량 리스트를 <code class="language-plaintext highlighter-rouge">QStringListModel.setStringList()</code>로 교체, <code class="language-plaintext highlighter-rouge">QCompleter.complete()</code> 반복 호출, <code class="language-plaintext highlighter-rouge">QFileSystemModel</code> 루트 변경 등) 그 순간만큼 메인 스레드가 바빠 보입니다. 특히 팝업 열기와 레이아웃 재계산은 생각보다 비쌉니다.</p>
  </li>
  <li>
    <p>Qt 객체를 워커 스레드에서 건드림<br />
Qt 위젯/모델은 “그 객체가 속한 스레드”에서만 만져야 합니다. 워커 내부에서 Qt 객체를 직접 건드리면 undefined behavior → 교착/프리즈. 반드시 워커는 파이썬의 순수 데이터(list[str])만 만들고, 메인 슬롯에서만 Qt 객체를 수정하세요.</p>
  </li>
  <li>
    <p>I/O가 “스레드가 아니라 OS 레벨”에서 막힘<br />
네트워크 경로, UNC, 루트 등에서 <code class="language-plaintext highlighter-rouge">Path.resolve()</code>나 <code class="language-plaintext highlighter-rouge">os.scandir()</code> 첫 호출이 OS 쪽에서 오래 블록될 수 있습니다. 스레드에서 막히는 것이 맞지만, 그 사이 결과를 기다리며 메인에서 계속 팝업을 열고 닫고, 모델을 비우고 채우는 작업이 연쇄되면 체감상 전체가 굼벵이처럼 느립니다.</p>
  </li>
</ol>

<h1 id="확인-체크리스트">확인 체크리스트</h1>

<ul>
  <li>
    <p>워커 코드가 CPU 루프를 오래 잡지 않게 타임박스 적용(예: <code class="language-plaintext highlighter-rouge">scandir</code> 50~100ms 한도).</p>
  </li>
  <li>
    <p>워커 루프 중 주기적으로 <code class="language-plaintext highlighter-rouge">time.sleep(0)</code> 또는 아주 짧은 <code class="language-plaintext highlighter-rouge">time.sleep(0.001)</code> 넣어 GIL 양보. <code class="language-plaintext highlighter-rouge">sleep()</code>은 GIL을 놓습니다.</p>
  </li>
  <li>
    <p>워커에서는 절대 Qt 객체 접근 금지. 신호로 순수 파이썬 자료만 전달.</p>
  </li>
  <li>
    <p>메인 슬롯에서의 작업을 O(候補수)로 유지. <code class="language-plaintext highlighter-rouge">setStringList</code> 후 즉시 <code class="language-plaintext highlighter-rouge">complete()</code>를 매번 호출하지 말고, 팝업이 이미 열려 있을 때만, 결과가 변했을 때만 갱신.</p>
  </li>
  <li>
    <p>입력 중에는 <code class="language-plaintext highlighter-rouge">QFileSystemModel</code> 루트 변경 금지. 루트 변경은 별도 액션(엔터, 버튼, 더블클릭)에서만.</p>
  </li>
</ul>

<h1 id="바로-적용-가능한-수습-팁">바로 적용 가능한 수습 팁</h1>

<ul>
  <li>워커 루프 타임박스와 GIL 양보:</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">time</span>

<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>  <span class="c1"># scandir 루프
</span>    <span class="c1"># ... 필터링/수집 ...
</span>    <span class="nf">if </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>  <span class="c1"># 50ms 예산
</span>        <span class="k">break</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">50</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># GIL 양보
</span></code></pre></div></div>

<ul>
  <li>
    <p>결과 적용 최소화:</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">QStringListModel</code> 재사용(이미 하셨다면 유지).</p>
      </li>
      <li>
        <p>이전 결과와 새 결과가 같으면 아무것도 하지 않기.</p>
      </li>
      <li>
        <p>팝업이 열려 있을 때만 <code class="language-plaintext highlighter-rouge">complete()</code> 호출.</p>
      </li>
      <li>
        <p>후보가 0개면 <code class="language-plaintext highlighter-rouge">complete()</code> 호출 금지.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>루트·짧은 접두사 스킵: 루트(‘/’, ‘\’)에서 prefix 길이 &lt; 2면 아예 탐색하지 않고 빈 후보 반환.</p>
  </li>
  <li>
    <p>자동완성 전용 <code class="language-plaintext highlighter-rouge">QThreadPool</code>을 1스레드로 제한해서 태스크 적체 방지:</p>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">self</span><span class="p">.</span><span class="n">_auto_pool</span> <span class="o">=</span> <span class="nc">QThreadPool</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">_auto_pool</span><span class="p">.</span><span class="nf">setMaxThreadCount</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># self._auto_pool.start(task)
</span></code></pre></div></div>

<h1 id="왜의-핵심-요약">“왜”의 핵심 요약</h1>

<ul>
  <li>
    <p>스레드라서 GUI가 절대 안 멈추는 게 아닙니다.<br />
파이썬은 GIL 때문에 워커가 오래 점유하면 메인의 Python 코드가 멈춘 듯 보입니다.</p>
  </li>
  <li>
    <p>신호가 메인에 도착해도, 그걸 처리하는 슬롯이 무겁거나 자주 불리면 메인이 바빠져서 역시 “멈춘 느낌”이 납니다.</p>
  </li>
  <li>
    <p>Qt 객체는 메인에서만 만지세요. 워커는 데이터만 만들고, 짧게, 타임박스 안에서, GIL을 주기적으로 놓으면서 돌리면 체감 프리즈가 사라집니다.</p>
  </li>
</ul>

<p>원하면 당신 코드의 워커 부분과 결과 적용 슬롯 부분을 딱 10줄 내로 패치한 버전을 만들어서 붙여드릴게요.</p>

<p class="chat--user">

그러면 쓰레드 말고 멀티 프로세싱으로 가자

</p>

<p>좋아, 자동완성만 “멀티프로세싱”으로 빼서 GIL 영향을 원천 차단하는 쪽으로 정리하자. 핵심은 다음 셋업이야.</p>

<ol>
  <li>
    <p>워커는 프로세스. 입력 문자열을 받아서 경로 후보 10개만 계산해 순수 파이썬 리스트로 반환.</p>
  </li>
  <li>
    <p>GUI는 여전히 메인 스레드에서만 Qt 객체를 만짐. 결과는 시그널로만 반영.</p>
  </li>
  <li>
    <p>위험 구간(루트·짧은 접두사·네트워크 루트)의 탐색을 타임박스(예: 50~100ms)로 제한.</p>
  </li>
</ol>

<p>아래는 너의 기존 코드에서 “컴플리터 스레드” 부분만 교체하면 되는 드롭인 패치야. PySide6 그대로, <code class="language-plaintext highlighter-rouge">ProcessPoolExecutor(max_workers=1)</code>를 사용해 요청을 순서대로 처리하고, 이전 요청은 task_id로 무시한다.</p>

<h2 id="0-주의사항">0) 주의사항</h2>

<ul>
  <li>
    <p>Windows/macOS에서 프로세스는 spawn이 기본이라, 워커 함수는 반드시 모듈 최상위에 있어야 하고(피클링), <code class="language-plaintext highlighter-rouge">if __name__ == "__main__":</code> 가드 안에서 앱 실행해야 해. 아래 예제는 그 규칙을 지킨 형태야.</p>
  </li>
  <li>
    <p>Qt 객체는 절대 워커에서 접근하지 말 것. 경로 문자열만 주고 문자열 리스트만 받는다.</p>
  </li>
  <li>
    <p>프로세스 쪽에서 <code class="language-plaintext highlighter-rouge">resolve()</code>는 금지. 네트워크에서 막힐 수 있다.</p>
  </li>
</ul>

<h2 id="1-모듈-최상위-워커-함수-추가">1) 모듈 최상위: 워커 함수 추가</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># --- 모듈 최상위에 추가 ---
</span><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="k">def</span> <span class="nf">_collect_completions</span><span class="p">(</span><span class="n">base_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">want_files</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">want_dirs</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                         <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">depth_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                         <span class="n">time_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">80</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    멀티프로세스 워커. 순수 함수.
    - 루트 + 짧은 접두사면 바로 빈 리스트.
    - 직속 항목만 우선, 필요시 얕은 BFS(depth&lt;=1)로 보강.
    - scandir 루프는 타임박스(기본 80ms) 내에서만 실행.
    </span><span class="sh">"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
        <span class="n">sbase</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
        <span class="n">is_unc</span> <span class="o">=</span> <span class="n">sbase</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="se">\\\\</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">is_root</span> <span class="o">=</span> <span class="n">sbase</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,</span> <span class="sh">"</span><span class="s">C:</span><span class="se">\\</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">D:</span><span class="se">\\</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">E:</span><span class="se">\\</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_unc</span> <span class="ow">or</span> <span class="n">sbase</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/Volumes</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">short_prefix</span> <span class="o">=</span> <span class="p">(</span><span class="n">prefix</span> <span class="o">==</span> <span class="sh">""</span> <span class="ow">or</span> <span class="nf">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_root</span> <span class="ow">and</span> <span class="n">short_prefix</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># 존재 확인은 느릴 수 있으므로 무조건 강행하지 말고 가볍게 시도
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">exists</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">exists</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">:</span>
            <span class="c1"># 가까운 상위로 폴백
</span>            <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">base</span><span class="p">.</span><span class="n">parents</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">parent</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
                        <span class="n">base</span> <span class="o">=</span> <span class="n">parent</span>
                        <span class="k">break</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">budget</span> <span class="o">=</span> <span class="n">time_budget_ms</span> <span class="o">/</span> <span class="mf">1000.0</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>

        <span class="c1"># 1) 직속
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span>
                    <span class="k">if</span> <span class="n">prefix</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                        <span class="nf">if </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">budget</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">want_dirs</span><span class="p">:</span>
                            <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">want_files</span><span class="p">:</span>
                            <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">top_k</span> <span class="ow">or</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">budget</span><span class="p">:</span>
                        <span class="k">break</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># 2) 보강 BFS(아주 얕게, 조건부)
</span>        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">top_k</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_root</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">budget</span><span class="p">:</span>
            <span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">deque</span> <span class="k">as</span> <span class="n">cdeque</span>
            <span class="n">q</span> <span class="o">=</span> <span class="nf">cdeque</span><span class="p">([(</span><span class="n">base</span><span class="p">,</span> <span class="mi">0</span><span class="p">)])</span>
            <span class="n">seen</span> <span class="o">=</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">)}</span>
            <span class="k">while</span> <span class="n">q</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">top_k</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">budget</span><span class="p">:</span>
                <span class="n">cur</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="nf">popleft</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;=</span> <span class="n">depth_limit</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                            <span class="n">full</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">())</span> <span class="ow">and</span> <span class="n">want_dirs</span><span class="p">:</span>
                                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">))</span>
                                    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">top_k</span> <span class="ow">or</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">budget</span><span class="p">:</span>
                                        <span class="k">break</span>
                                <span class="n">s</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                                    <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="n">q</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">full</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">())</span> <span class="ow">and</span> <span class="n">want_files</span><span class="p">:</span>
                                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">))</span>
                                    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">top_k</span> <span class="ow">or</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">budget</span><span class="p">:</span>
                                        <span class="k">break</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>

        <span class="c1"># 정렬은 짧은 경로 우선
</span>        <span class="n">results</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span><span class="p">.</span><span class="nf">lower</span><span class="p">()))[:</span><span class="n">top_k</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">results</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
</code></pre></div></div>

<h2 id="2-다이얼로그-프로세스-풀과-시그널-준비">2) 다이얼로그: 프로세스 풀과 시그널 준비</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># __init__ 안에 (기존 스레드풀·워커 관련 코드 제거하고) 추가
</span><span class="kn">from</span> <span class="n">concurrent.futures</span> <span class="kn">import</span> <span class="n">ProcessPoolExecutor</span>
<span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="n">QObject</span><span class="p">,</span> <span class="n">Signal</span><span class="p">,</span> <span class="n">Slot</span><span class="p">,</span> <span class="n">QTimer</span><span class="p">,</span> <span class="n">QStringListModel</span>

<span class="n">self</span><span class="p">.</span><span class="n">_slm</span> <span class="o">=</span> <span class="nc">QStringListModel</span><span class="p">([],</span> <span class="n">self</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setModel</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">)</span>

<span class="n">self</span><span class="p">.</span><span class="n">_proc_pool</span> <span class="o">=</span> <span class="nc">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 자동완성 전용 1프로세스
</span><span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">self</span><span class="p">.</span><span class="n">_task_seq</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># 결과를 Qt로 넘길 emitter
</span><span class="k">class</span> <span class="nc">_ProcEmitter</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
    <span class="n">resultsReady</span> <span class="o">=</span> <span class="nc">Signal</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">_proc_emitter</span> <span class="o">=</span> <span class="nf">_ProcEmitter</span><span class="p">()</span>
<span class="n">self</span><span class="p">.</span><span class="n">_proc_emitter</span><span class="p">.</span><span class="n">resultsReady</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_on_proc_results</span><span class="p">)</span>
</code></pre></div></div>

<p>다이얼로그가 닫힐 때 풀을 정리해 줘야 해.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">closeEvent</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_proc_pool</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">cancel_futures</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="nf">super</span><span class="p">().</span><span class="nf">closeEvent</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="3-작업-투입-로직-교체">3) 작업 투입 로직 교체</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_spawn_completer_task</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">([])</span>
        <span class="k">return</span>

    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">text</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">):</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="n">text</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="k">if</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span>

    <span class="c1"># 루트·의심 경로 단축 리턴
</span>    <span class="n">sbase</span> <span class="o">=</span> <span class="n">base_dir</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">base_dir</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,</span> <span class="sh">"</span><span class="se">\\\\</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sbase</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/volumes</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sbase</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/mnt</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sbase</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/net</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">([])</span>
            <span class="k">return</span>

    <span class="n">want_files</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">want_dirs</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c1"># 이전 요청 무시(취소 시도)
</span>    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span><span class="p">.</span><span class="nf">done</span><span class="p">():</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>  <span class="c1"># 이미 실행 중이면 취소가 보장되진 않지만 결과는 무시할 거라 OK
</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_task_seq</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">seq</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_task_seq</span>

    <span class="c1"># 제출
</span>    <span class="n">fut</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_proc_pool</span><span class="p">.</span><span class="nf">submit</span><span class="p">(</span><span class="n">_collect_completions</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">want_files</span><span class="p">,</span> <span class="n">want_dirs</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span> <span class="o">=</span> <span class="n">fut</span>

    <span class="c1"># 완료 콜백: 워커 스레드에서 실행→Qt 시그널로 메인에 전달
</span>    <span class="k">def</span> <span class="nf">_on_done</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="p">.</span><span class="nf">done</span><span class="p">()</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_proc_emitter</span><span class="p">.</span><span class="n">resultsReady</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
    <span class="n">fut</span><span class="p">.</span><span class="nf">add_done_callback</span><span class="p">(</span><span class="n">_on_done</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="4-결과-적용-슬롯">4) 결과 적용 슬롯</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slot</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_on_proc_results</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">seq</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">seq</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_task_seq</span><span class="p">:</span>
        <span class="k">return</span>  <span class="c1"># 최신 요청만 반영
</span>    <span class="c1"># 경량 갱신
</span>    <span class="n">items</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
    <span class="c1"># 이전과 동일하면 갱신 생략
</span>    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">stringList</span><span class="p">()</span> <span class="o">==</span> <span class="n">items</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
    <span class="c1"># 팝업은 필요할 때만
</span>    <span class="k">if</span> <span class="n">items</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">hasFocus</span><span class="p">()</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">popup</span><span class="p">().</span><span class="nf">isVisible</span><span class="p">():</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">complete</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="5-엔트리-포인트-가드">5) 엔트리 포인트 가드</h2>

<p>멀티프로세싱을 쓰면 메인 진입을 가드해야 해.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">app</span> <span class="o">=</span> <span class="nc">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span>
    <span class="c1"># ... 다이얼로그 실행 ...
</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="c1"># 필요시: from multiprocessing import set_start_method; set_start_method("spawn", force=True)
</span>    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="6-왜-이-구성이-안전한가">6) 왜 이 구성이 안전한가</h2>

<ul>
  <li>
    <p>GIL: 후보 수집은 별도 프로세스에서 돌아서 메인의 파이썬 슬롯·타이머가 굶지 않는다.</p>
  </li>
  <li>
    <p>Qt 스레드 규칙: 워커는 순수 데이터만 반환하고, Qt 객체 갱신은 시그널 슬롯에서만 처리.</p>
  </li>
  <li>
    <p>블로킹 I/O: 네트워크에서 <code class="language-plaintext highlighter-rouge">scandir()</code>가 잠시 멈춰도 GUI는 독립적. 타임박스로 장기 블로킹을 더 줄였다.</p>
  </li>
  <li>
    <p>폭주 방지: <code class="language-plaintext highlighter-rouge">max_workers=1</code>로 큐 누적을 제한하고, task_seq로 오래된 결과를 무시한다.</p>
  </li>
</ul>

<h2 id="확장-팁">확장 팁</h2>

<ul>
  <li>
    <p>네트워크 드라이브에서 더 여유가 필요하면 <code class="language-plaintext highlighter-rouge">time_budget_ms</code>를 120~150으로, 대신 <code class="language-plaintext highlighter-rouge">depth_limit=0</code>으로 유지(직속만).</p>
  </li>
  <li>
    <p>macOS 앱 번들로 배포할 때는 워커 함수를 별도 <code class="language-plaintext highlighter-rouge">.py</code> 모듈로 분리하면 스폰 안정성이 올라간다.</p>
  </li>
  <li>
    <p>후보 캐싱을 추가하면 같은 <code class="language-plaintext highlighter-rouge">base_dir</code>에서 접두사가 길어질수록 재사용 가능(프로세스 메모리에도 캐시를 둘지, 메인에서 최근 결과를 재활용할지 선택).</p>
  </li>
</ul>

<p>이대로 붙여서 돌려보고, 여전히 특정 경로에서 체감 지연이 있으면 로그 한두 줄만 공유해줘. 타임박스·깊이·루트 규칙을 경로별로 미세 조정해 더 민첩하게 만들 수 있어.</p>

<p class="chat--user">

전체 코드 좀

</p>

<p>좋아. 아래는 멀티프로세싱 기반 자동완성(컴플리터)을 포함한 전체 동작 예제야.<br />
PySide6 기준이고, <code class="language-plaintext highlighter-rouge">ProcessPoolExecutor(max_workers=1)</code>로 자동완성만 별도 프로세스에서 처리해서 GIL·블로킹 영향을 차단해. 경로 콤보/Back·Forward·Parent·New Folder, 파일·폴더 모드, Open/Save, Type 필터, 히스토리, 디바운스, 그리고 안전장치(루트+짧은 접두사 차단, <code class="language-plaintext highlighter-rouge">scandir()</code> 타임박스)까지 포함했어.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># -*- coding: utf-8 -*-
</span><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">fnmatch</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">concurrent.futures</span> <span class="kn">import</span> <span class="n">ProcessPoolExecutor</span>

<span class="c1"># ==========================================
# 멀티프로세스 워커 함수 (모듈 최상위에 있어야 함)
# ==========================================
</span><span class="k">def</span> <span class="nf">_collect_completions</span><span class="p">(</span><span class="n">base_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">want_files</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">want_dirs</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                         <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">depth_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                         <span class="n">time_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">80</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    자동완성 후보를 수집하는 순수 함수(별도 프로세스에서 실행).
    - 루트 + 짧은 접두사면 빈 리스트 반환
    - 직속 항목 우선, 필요 시 매우 얕은 BFS(depth&lt;=1)로 보강
    - os.scandir 루프는 타임박스 내에서만 동작
    - Qt 객체 접근 절대 금지 (문자열 리스트만 반환)
    </span><span class="sh">"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
        <span class="n">sbase</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>

        <span class="c1"># 플랫폼별 루트 판단
</span>        <span class="n">is_unc</span> <span class="o">=</span> <span class="n">sbase</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="se">\\\\</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">is_root_like</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">sbase</span> <span class="o">==</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span> <span class="ow">or</span>
            <span class="n">sbase</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">C:</span><span class="se">\\</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">D:</span><span class="se">\\</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">E:</span><span class="se">\\</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">F:</span><span class="se">\\</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">is_unc</span> <span class="ow">or</span>
            <span class="n">sbase</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/Volumes</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">sbase</span> <span class="o">==</span> <span class="sh">"</span><span class="s">/</span><span class="sh">"</span>
        <span class="p">)</span>

        <span class="n">short_prefix</span> <span class="o">=</span> <span class="p">(</span><span class="n">prefix</span> <span class="o">==</span> <span class="sh">""</span> <span class="ow">or</span> <span class="nf">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_root_like</span> <span class="ow">and</span> <span class="n">short_prefix</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># 존재 확인은 네트워크에서 느릴 수 있으니 조심스럽게
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">exists</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">exists</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">:</span>
            <span class="c1"># 가까운 상위로 폴백
</span>            <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">base</span><span class="p">.</span><span class="n">parents</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">parent</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
                        <span class="n">base</span> <span class="o">=</span> <span class="n">parent</span>
                        <span class="k">break</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">budget</span> <span class="o">=</span> <span class="n">time_budget_ms</span> <span class="o">/</span> <span class="mf">1000.0</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>

        <span class="c1"># 1) 직속 항목 스캔 (타임박스)
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span>
                    <span class="k">if</span> <span class="n">prefix</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                        <span class="nf">if </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">budget</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">want_dirs</span><span class="p">:</span>
                            <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">want_files</span><span class="p">:</span>
                            <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">top_k</span> <span class="ow">or</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">budget</span><span class="p">:</span>
                        <span class="k">break</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># PermissionError, OSError 등은 무시
</span>            <span class="k">pass</span>

        <span class="c1"># 2) 보강 BFS (조건부, 매우 얕게, 타임박스)
</span>        <span class="nf">if </span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">top_k</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_root_like</span>
            <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span>
            <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">budget</span>
            <span class="ow">and</span> <span class="n">depth_limit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">deque</span> <span class="k">as</span> <span class="n">cdeque</span>
            <span class="n">q</span> <span class="o">=</span> <span class="nf">cdeque</span><span class="p">([(</span><span class="n">base</span><span class="p">,</span> <span class="mi">0</span><span class="p">)])</span>
            <span class="n">seen</span> <span class="o">=</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">)}</span>
            <span class="k">while</span> <span class="n">q</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">top_k</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">budget</span><span class="p">:</span>
                <span class="n">cur</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="nf">popleft</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;=</span> <span class="n">depth_limit</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                            <span class="n">full</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
                            <span class="c1"># 매칭 확인
</span>                            <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">())</span> <span class="ow">and</span> <span class="n">want_dirs</span><span class="p">:</span>
                                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">))</span>
                                    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">top_k</span> <span class="ow">or</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">budget</span><span class="p">:</span>
                                        <span class="k">break</span>
                                <span class="n">s</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                                    <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                                    <span class="n">q</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">full</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">())</span> <span class="ow">and</span> <span class="n">want_files</span><span class="p">:</span>
                                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">))</span>
                                    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">top_k</span> <span class="ow">or</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">budget</span><span class="p">:</span>
                                        <span class="k">break</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>

        <span class="n">results</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span><span class="p">.</span><span class="nf">lower</span><span class="p">()))[:</span><span class="n">top_k</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">results</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="c1"># ==========================================
# Qt 임포트
# ==========================================
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="n">Qt</span><span class="p">,</span> <span class="n">QObject</span><span class="p">,</span> <span class="n">Signal</span><span class="p">,</span> <span class="n">Slot</span><span class="p">,</span> <span class="n">QModelIndex</span><span class="p">,</span> <span class="n">QTimer</span><span class="p">,</span> <span class="n">QStringListModel</span>
    <span class="kn">from</span> <span class="n">PySide6.QtWidgets</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">QApplication</span><span class="p">,</span> <span class="n">QDialog</span><span class="p">,</span> <span class="n">QVBoxLayout</span><span class="p">,</span> <span class="n">QHBoxLayout</span><span class="p">,</span> <span class="n">QToolButton</span><span class="p">,</span> <span class="n">QComboBox</span><span class="p">,</span>
        <span class="n">QTreeView</span><span class="p">,</span> <span class="n">QFileSystemModel</span><span class="p">,</span> <span class="n">QLineEdit</span><span class="p">,</span> <span class="n">QCompleter</span><span class="p">,</span> <span class="n">QDialogButtonBox</span><span class="p">,</span>
        <span class="n">QInputDialog</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="p">,</span> <span class="n">QLabel</span><span class="p">,</span> <span class="n">QSizePolicy</span>
    <span class="p">)</span>
<span class="k">except</span> <span class="nb">ImportError</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">PySide6가 필요합니다. pip install PySide6</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># ==========================================
# CFileDialog 본체
# ==========================================
</span><span class="k">class</span> <span class="nc">CFileDialog</span><span class="p">(</span><span class="n">QDialog</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    mode: </span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="s"> | </span><span class="sh">'</span><span class="s">save</span><span class="sh">'</span><span class="s">
    select_mode: </span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="s"> | </span><span class="sh">'</span><span class="s">folder</span><span class="sh">'</span><span class="s">

    사용 예:
        dlg = CFileDialog(mode=</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="s">, select_mode=</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="s">,
                          filters=[</span><span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">Images (*.png *.jpg)</span><span class="sh">"</span><span class="s">])
        if dlg.exec():
            print(dlg.selected_path())
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">start_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">,</span> <span class="n">select_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">,</span>
                 <span class="n">filters</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">setWindowTitle</span><span class="p">(</span><span class="sh">"</span><span class="s">CFileDialog (Multiprocessing Completer)</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">resize</span><span class="p">(</span><span class="mi">960</span><span class="p">,</span> <span class="mi">640</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">=</span> <span class="n">select_mode</span>
        <span class="n">self</span><span class="p">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">filters</span> <span class="ow">or</span> <span class="p">[</span><span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="p">]</span>

        <span class="n">self</span><span class="p">.</span><span class="n">history_back</span> <span class="o">=</span> <span class="nf">deque</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">history_fwd</span> <span class="o">=</span> <span class="nf">deque</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">start_path</span><span class="p">).</span><span class="nf">resolve</span><span class="p">())</span> <span class="k">if</span> <span class="n">start_path</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">()</span>

        <span class="c1"># 자동완성 상태
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span> <span class="o">=</span> <span class="nc">QTimer</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span><span class="p">.</span><span class="nf">setInterval</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>  <span class="c1"># 입력 디바운스
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span><span class="p">.</span><span class="nf">setSingleShot</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span><span class="p">.</span><span class="n">timeout</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_spawn_completer_task</span><span class="p">)</span>

        <span class="c1"># 프로세스 풀: 자동완성 전용, 동시 1개
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_proc_pool</span> <span class="o">=</span> <span class="nc">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_task_seq</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># 프로세스 결과를 Qt로 전달하는 emitter
</span>        <span class="k">class</span> <span class="nc">_ProcEmitter</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
            <span class="n">resultsReady</span> <span class="o">=</span> <span class="nc">Signal</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_proc_emitter</span> <span class="o">=</span> <span class="nf">_ProcEmitter</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_proc_emitter</span><span class="p">.</span><span class="n">resultsReady</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_on_proc_results</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="nf">_build_ui</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_connect_signals</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_configure_modes</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">,</span> <span class="n">push_history</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># ---------- UI 구성 ----------
</span>    <span class="k">def</span> <span class="nf">_build_ui</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># 상단 툴바
</span>        <span class="n">self</span><span class="p">.</span><span class="n">back_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sh">"</span><span class="s">Back</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">forward_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sh">"</span><span class="s">Forward</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">up_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sh">"</span><span class="s">Parent</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">new_folder_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sh">"</span><span class="s">New Folder</span><span class="sh">"</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span> <span class="o">=</span> <span class="nc">QComboBox</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="p">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="p">.</span><span class="n">Fixed</span><span class="p">)</span>

        <span class="n">top</span> <span class="o">=</span> <span class="nc">QHBoxLayout</span><span class="p">()</span>
        <span class="n">top</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">back_btn</span><span class="p">)</span>
        <span class="n">top</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">forward_btn</span><span class="p">)</span>
        <span class="n">top</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">up_btn</span><span class="p">)</span>
        <span class="n">top</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">new_folder_btn</span><span class="p">)</span>
        <span class="n">top</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">)</span>

        <span class="c1"># 중앙 뷰
</span>        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="nc">QFileSystemModel</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setRootPath</span><span class="p">(</span><span class="sh">""</span><span class="p">)</span>  <span class="c1"># 전체 FS
</span>        <span class="n">self</span><span class="p">.</span><span class="n">view</span> <span class="o">=</span> <span class="nc">QTreeView</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setModel</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setRootIsDecorated</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setSortingEnabled</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">sortByColumn</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Qt</span><span class="p">.</span><span class="n">AscendingOrder</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setSelectionBehavior</span><span class="p">(</span><span class="n">QTreeView</span><span class="p">.</span><span class="n">SelectRows</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setUniformRowHeights</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setColumnWidth</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>

        <span class="c1"># 하단: 경로 입력 + Type + 버튼들
</span>        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span> <span class="o">=</span> <span class="nc">QLineEdit</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setPlaceholderText</span><span class="p">(</span><span class="sh">"</span><span class="s">경로를 입력하세요…</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># QCompleter + QStringListModel 재사용
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_slm</span> <span class="o">=</span> <span class="nc">QStringListModel</span><span class="p">([],</span> <span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span> <span class="o">=</span> <span class="nc">QCompleter</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setCaseSensitivity</span><span class="p">(</span><span class="n">Qt</span><span class="p">.</span><span class="n">CaseInsensitive</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setFilterMode</span><span class="p">(</span><span class="n">Qt</span><span class="p">.</span><span class="n">MatchContains</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setCompletionMode</span><span class="p">(</span><span class="n">QCompleter</span><span class="p">.</span><span class="n">PopupCompletion</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setCompleter</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span> <span class="o">=</span> <span class="nc">QComboBox</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">.</span><span class="nf">addItems</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">filters</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">button_box</span> <span class="o">=</span> <span class="nc">QDialogButtonBox</span><span class="p">(</span><span class="n">QDialogButtonBox</span><span class="p">.</span><span class="n">Ok</span> <span class="o">|</span> <span class="n">QDialogButtonBox</span><span class="p">.</span><span class="n">Cancel</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">self</span><span class="p">)</span>

        <span class="n">bottom</span> <span class="o">=</span> <span class="nc">QHBoxLayout</span><span class="p">()</span>
        <span class="n">bottom</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="nc">QLabel</span><span class="p">(</span><span class="sh">"</span><span class="s">경로:</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">bottom</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">)</span>
        <span class="n">bottom</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="nc">QLabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Type:</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">bottom</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">)</span>

        <span class="n">layout</span> <span class="o">=</span> <span class="nc">QVBoxLayout</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addLayout</span><span class="p">(</span><span class="n">top</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addLayout</span><span class="p">(</span><span class="n">bottom</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">)</span>

    <span class="c1"># ---------- 시그널 ----------
</span>    <span class="k">def</span> <span class="nf">_connect_signals</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">back_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_go_back</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">forward_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_go_forward</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">up_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_go_up</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">new_folder_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_create_folder</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="n">activated</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_combo_jump</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">doubleClicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_item_double_clicked</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_item_clicked</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="n">textEdited</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_on_path_edited</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">.</span><span class="n">currentTextChanged</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_on_filter_changed</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">.</span><span class="n">accepted</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_accept_if_valid</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">.</span><span class="n">rejected</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">reject</span><span class="p">)</span>

    <span class="c1"># ---------- 모드/필터 ----------
</span>    <span class="k">def</span> <span class="nf">_configure_modes</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="n">QDir</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">folder</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setFilter</span><span class="p">(</span><span class="n">QDir</span><span class="p">.</span><span class="n">AllDirs</span> <span class="o">|</span> <span class="n">QDir</span><span class="p">.</span><span class="n">NoDotAndDotDot</span> <span class="o">|</span> <span class="n">QDir</span><span class="p">.</span><span class="n">Drives</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setFilter</span><span class="p">(</span><span class="n">QDir</span><span class="p">.</span><span class="n">AllEntries</span> <span class="o">|</span> <span class="n">QDir</span><span class="p">.</span><span class="n">NoDotAndDotDot</span> <span class="o">|</span> <span class="n">QDir</span><span class="p">.</span><span class="n">Drives</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setNameFilterDisables</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_apply_name_filters_from_combo</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_apply_name_filters_from_combo</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">.</span><span class="nf">currentText</span><span class="p">()</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">(</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="sh">"</span><span class="s">)</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">inside</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">text</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">(</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">text</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">)</span><span class="sh">"</span><span class="p">)]</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">inside</span><span class="p">.</span><span class="nf">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">patterns</span><span class="p">:</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setNameFilters</span><span class="p">(</span><span class="n">patterns</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_filter_changed</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_apply_name_filters_from_combo</span><span class="p">()</span>

    <span class="c1"># ---------- 경로 로딩 ----------
</span>    <span class="k">def</span> <span class="nf">_load_path</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">push_history</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="c1"># resolve()는 메인에서만 사용 (UI 반응 느려지면 생략해도 됨)
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">resolve</span><span class="p">())</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">push_history</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">current_path</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">current_path</span> <span class="o">!=</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">history_back</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">history_fwd</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

        <span class="n">self</span><span class="p">.</span><span class="n">current_path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_update_path_combo</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setRootIndex</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_update_ok_enabled</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_combo_jump</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">itemText</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_path_combo</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">blockSignals</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">parts</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)):</span>
            <span class="n">acc</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">addItem</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="o">*</span><span class="n">acc</span><span class="p">)))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">setCurrentIndex</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">blockSignals</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># ---------- 탐색 ----------
</span>    <span class="k">def</span> <span class="nf">_go_back</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">history_back</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">history_back</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">history_fwd</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">push_history</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_go_forward</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">history_fwd</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">history_fwd</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">history_back</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">push_history</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_go_up</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">).</span><span class="n">parent</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="ow">and</span> <span class="n">parent</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_folder</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">ok</span> <span class="o">=</span> <span class="n">QInputDialog</span><span class="p">.</span><span class="nf">getText</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">새 폴더</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">폴더명:</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">name</span><span class="p">.</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="n">target</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">,</span> <span class="n">name</span><span class="p">.</span><span class="nf">strip</span><span class="p">())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">target</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
        <span class="k">except</span> <span class="nb">FileExistsError</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">경고</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">동일한 이름의 폴더가 이미 존재합니다.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="p">.</span><span class="nf">critical</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">오류</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">폴더를 만들 권한이 없습니다.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="p">.</span><span class="nf">critical</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">오류</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">폴더 생성 실패: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># ---------- 뷰 상호작용 ----------
</span>    <span class="k">def</span> <span class="nf">_item_clicked</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">QModelIndex</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">filePath</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_update_ok_enabled</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_item_double_clicked</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">QModelIndex</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">filePath</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_update_ok_enabled</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">open</span><span class="sh">'</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">accept</span><span class="p">()</span>

    <span class="c1"># ---------- 선택 유효성 ----------
</span>    <span class="k">def</span> <span class="nf">_is_selection_valid</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">folder</span><span class="sh">'</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">_match_type_filters</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">target</span><span class="p">).</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">target</span><span class="p">).</span><span class="n">parent</span>
            <span class="k">return</span> <span class="n">parent</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">parent</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_match_type_filters</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">.</span><span class="nf">currentText</span><span class="p">()</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">(</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="sh">"</span><span class="s">)</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">inside</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">text</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">(</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">text</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">)</span><span class="sh">"</span><span class="p">)]</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">inside</span><span class="p">.</span><span class="nf">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">patterns</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fnmatch</span><span class="p">.</span><span class="nf">fnmatch</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">pat</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_update_ok_enabled</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">ok_btn</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">.</span><span class="nf">button</span><span class="p">(</span><span class="n">QDialogButtonBox</span><span class="p">.</span><span class="n">Ok</span><span class="p">)</span>
        <span class="n">ok_btn</span><span class="p">.</span><span class="nf">setEnabled</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_is_selection_valid</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_accept_if_valid</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_is_selection_valid</span><span class="p">():</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">accept</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">선택 확인</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">선택이 유효하지 않습니다.</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># ---------- 경로 입력/자동완성(멀티프로세싱) ----------
</span>    <span class="k">def</span> <span class="nf">_on_path_edited</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
        <span class="c1"># 입력 중에는 루트 변경 금지. 자동완성만 트리거.
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_update_ok_enabled</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_spawn_completer_task</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">([])</span>
            <span class="k">return</span>

        <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">text</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">):</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="n">text</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="k">if</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span>

        <span class="c1"># 루트/의심 경로에서 짧은 접두사면 미리 차단
</span>        <span class="n">sbase</span> <span class="o">=</span> <span class="n">base_dir</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">base_dir</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,</span> <span class="sh">"</span><span class="se">\\\\</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sbase</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/volumes</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sbase</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/mnt</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sbase</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/net</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">([])</span>
                <span class="k">return</span>

        <span class="n">want_files</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">want_dirs</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c1"># 이전 요청 취소 시도 (spawn된 프로세스 작업은 즉시 안 꺼질 수 있으나, 우리는 결과를 무시)
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span><span class="p">.</span><span class="nf">done</span><span class="p">():</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_task_seq</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_task_seq</span>

        <span class="c1"># 제출
</span>        <span class="n">fut</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_proc_pool</span><span class="p">.</span><span class="nf">submit</span><span class="p">(</span><span class="n">_collect_completions</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">want_files</span><span class="p">,</span> <span class="n">want_dirs</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span> <span class="o">=</span> <span class="n">fut</span>

        <span class="c1"># 완료 콜백: 워커 스레드에서 실행되므로 Qt로 신호 전달
</span>        <span class="k">def</span> <span class="nf">_on_done</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">result</span><span class="p">()</span> <span class="k">if</span> <span class="n">f</span><span class="p">.</span><span class="nf">done</span><span class="p">()</span> <span class="k">else</span> <span class="p">[]</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_proc_emitter</span><span class="p">.</span><span class="n">resultsReady</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
        <span class="n">fut</span><span class="p">.</span><span class="nf">add_done_callback</span><span class="p">(</span><span class="n">_on_done</span><span class="p">)</span>

    <span class="nd">@Slot</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_on_proc_results</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">seq</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">seq</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_task_seq</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># 최신 요청만 반영
</span>        <span class="n">items</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
        <span class="c1"># 이전과 동일하면 갱신 생략
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">stringList</span><span class="p">()</span> <span class="o">==</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="c1"># 팝업은 조건부로만 호출
</span>        <span class="k">if</span> <span class="n">items</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">hasFocus</span><span class="p">()</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">popup</span><span class="p">().</span><span class="nf">isVisible</span><span class="p">():</span>
            <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">complete</span><span class="p">()</span>

    <span class="c1"># ---------- 종료 처리 ----------
</span>    <span class="k">def</span> <span class="nf">closeEvent</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_proc_pool</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">cancel_futures</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">closeEvent</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="c1"># ---------- 외부 API ----------
</span>    <span class="k">def</span> <span class="nf">selected_path</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>

<span class="c1"># ==========================================
# 실행 예시
# ==========================================
</span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">app</span> <span class="o">=</span> <span class="nc">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span>

    <span class="c1"># 예시 1: 파일 Open
</span>    <span class="n">dlg1</span> <span class="o">=</span> <span class="nc">CFileDialog</span><span class="p">(</span>
        <span class="n">start_path</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">(),</span>
        <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">select_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">filters</span><span class="o">=</span><span class="p">[</span>
            <span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">Text Files (*.txt *.md)</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">Images (*.png *.jpg *.jpeg *.bmp *.gif)</span><span class="sh">"</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">dlg1</span><span class="p">.</span><span class="nf">exec</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">OPEN FILE:</span><span class="sh">"</span><span class="p">,</span> <span class="n">dlg1</span><span class="p">.</span><span class="nf">selected_path</span><span class="p">())</span>

    <span class="c1"># 예시 2: 폴더 선택
</span>    <span class="n">dlg2</span> <span class="o">=</span> <span class="nc">CFileDialog</span><span class="p">(</span>
        <span class="n">start_path</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">(),</span>
        <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">select_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">folder</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">dlg2</span><span class="p">.</span><span class="nf">exec</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">SELECT FOLDER:</span><span class="sh">"</span><span class="p">,</span> <span class="n">dlg2</span><span class="p">.</span><span class="nf">selected_path</span><span class="p">())</span>

    <span class="c1"># 예시 3: 파일 Save
</span>    <span class="n">dlg3</span> <span class="o">=</span> <span class="nc">CFileDialog</span><span class="p">(</span>
        <span class="n">start_path</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">(),</span>
        <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">save</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">select_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Python (*.py)</span><span class="sh">"</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">dlg3</span><span class="p">.</span><span class="nf">exec</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">SAVE FILE:</span><span class="sh">"</span><span class="p">,</span> <span class="n">dlg3</span><span class="p">.</span><span class="nf">selected_path</span><span class="p">())</span>

    <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="c1"># 멀티프로세싱 스폰 모드 사용 시 필요하다면 주석 해제
</span>    <span class="c1"># from multiprocessing import set_start_method
</span>    <span class="c1"># set_start_method("spawn", force=True)
</span>    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>메모</p>

<ul>
  <li>
    <p>자동완성은 별도 프로세스에서 돌고, GUI는 메인 스레드에서만 Qt 객체를 건드려서 안전해.</p>
  </li>
  <li>
    <p>루트 경로에서 접두사가 짧을 때는 탐색을 생략해 폭주를 막았고, <code class="language-plaintext highlighter-rouge">scandir()</code>에 80ms 타임박스를 걸어 타자 중 지연을 억제했어.</p>
  </li>
  <li>
    <p>이전 요청은 <code class="language-plaintext highlighter-rouge">cancel()</code>하고 <code class="language-plaintext highlighter-rouge">seq</code>로 최신성만 보장해 결과 레이스를 제거했어.</p>
  </li>
  <li>
    <p>필요하면 <code class="language-plaintext highlighter-rouge">time_budget_ms</code>나 <code class="language-plaintext highlighter-rouge">depth_limit</code>을 조절해서 네트워크 드라이브에서 더 보수적으로 동작하게 만들 수 있어.</p>
  </li>
</ul>

<p>특정 OS나 네트워크 공유에서 튜닝이 더 필요하면, 문제 재현 경로와 함께 알려줘. 타임박스·깊이·루트 규칙을 미세조정한 패치를 바로 만들어줄게.</p>

<p class="chat--user">

원인을 좀 더 좁힌거 같아. os.path.isfile("/user/j") 이게 너무 느려 안 끝나

</p>

<p>맞아, 핵심 원인은 <code class="language-plaintext highlighter-rouge">os.path.isfile("/user/j")</code> 같은 “경로 자체에 대한 stat 호출”이 네트워크·자동마운트(autofs)·SMB/UNC 같은 느린 파일시스템에서 블로킹되기 때문이야. 특히 <code class="language-plaintext highlighter-rouge">/user</code> 가 자동마운트 지점이면, <code class="language-plaintext highlighter-rouge">isfile</code> 한 번만으로도 커널이 마운트를 시도→DNS 탐색→타임아웃까지 기다리느라 GUI가 얼어붙은 것처럼 느껴져. 스레드로 돌려도 GIL·결과 반영 타이밍·연쇄 호출 때문에 체감 프리즈가 나오는 거고.</p>

<p>해법은 “타이핑 중에는 절대 <code class="language-plaintext highlighter-rouge">isfile</code>/<code class="language-plaintext highlighter-rouge">exists</code> 같은 직접 stat을 하지 않는다”야. 검증이 필요해도 경량 우회로를 쓰거나, 별도 프로세스에서 타임박스로 돌리고 결과가 늦으면 그냥 “모름”으로 처리하는 정책이 안전해.</p>

<p>아래처럼 바꾸면 바로 효과를 볼 수 있어.</p>

<h1 id="전략-요약">전략 요약</h1>

<ol>
  <li>
    <p>입력 중에는 <code class="language-plaintext highlighter-rouge">isfile</code> 완전 금지. 자동완성은 문자열 매칭만.</p>
  </li>
  <li>
    <p>최종 OK 검증에서만 “빠른 존재 확인”을 시도하되, 경로에 직접 stat 하지 말고 상위 폴더를 짧게 나열해 이름 비교한다.</p>
  </li>
  <li>
    <p>그래도 네트워크일 수 있으니 타임박스(예: 50ms)를 넘기면 “미확인”으로 간주하고 OK을 잠시 비활성화하거나, 메시지로 알려준다.</p>
  </li>
  <li>
    <p>필요하면 멀티프로세싱으로 “느릴 수 있는 stat”을 분리하고 100~150ms 타임아웃을 둔다.</p>
  </li>
  <li>
    <p>autofs·네트워크 루트 프리픽스를 블록리스트로 두고, 접두사가 짧을 땐 아예 검증을 스킵한다.</p>
  </li>
</ol>

<h1 id="코드-패치-1-빠른-파일-확인기로-교체">코드 패치 1: 빠른 파일 확인기로 교체</h1>

<p><code class="language-plaintext highlighter-rouge">_is_selection_valid()</code>에서 쓰던 <code class="language-plaintext highlighter-rouge">os.path.isfile()</code>를 아래 함수로 바꿔 호출해.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_fast_isfile</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">경로 자체를 stat하지 않고, 부모 디렉터리를 짧게 나열해서 이름으로 판단.</span><span class="sh">"""</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">parent</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="c1"># 위험 프리픽스는 즉시 포기(autofs/네트워크 루트)
</span>    <span class="n">s</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">parent</span><span class="p">).</span><span class="nf">lower</span><span class="p">()</span>
    <span class="n">risky_roots</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,</span> <span class="sh">"</span><span class="s">/net</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/nfs</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/afs</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/mnt</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/users</span><span class="sh">"</span><span class="p">,</span>
                   <span class="sh">"</span><span class="s">/volumes</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="se">\\\\</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">rr</span><span class="p">)</span> <span class="k">for</span> <span class="n">rr</span> <span class="ow">in</span> <span class="n">risky_roots</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>  <span class="c1"># 접두사가 짧으면 스캔하지 않음
</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                <span class="c1"># 타임박스 초과 시 즉시 포기
</span>                <span class="nf">if </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">&gt;</span> <span class="n">budget_ms</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                    <span class="c1"># 여기서도 stat 대신 dir 여부만 확인(캐시 활용)
</span>                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">return</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">True</span>  <span class="c1"># 파일로 가정
</span>    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">False</span>
</code></pre></div></div>

<p>그리고 <code class="language-plaintext highlighter-rouge">_is_selection_valid()</code>를 이렇게 조정.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_is_selection_valid</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">folder</span><span class="sh">'</span><span class="p">:</span>
        <span class="c1"># 폴더 검증도 빠른 버전으로(직접 stat 대신 상위 나열)
</span>        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fast_isdir</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">:</span>
        <span class="c1"># 느린 환경에서 isfile 금지 → 빠른 확인기 사용
</span>        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fast_isfile</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="nf">_match_type_filters</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">target</span><span class="p">).</span><span class="n">name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">target</span><span class="p">).</span><span class="n">parent</span>
        <span class="c1"># 저장은 상위 폴더만 확인(이것도 빠른 판정 사용)
</span>        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fast_isdir</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_fast_isdir</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">parent</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
        <span class="c1"># 루트 등: 대개 디렉터리로 취급
</span>        <span class="k">return</span> <span class="bp">True</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                <span class="nf">if </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">&gt;</span> <span class="n">budget_ms</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">False</span>
</code></pre></div></div>

<p>설명: <code class="language-plaintext highlighter-rouge">os.path.isfile(target)</code> 대신, 부모 디렉터리를 아주 짧게 나열하면서 이름이 같은 엔트리만 판정한다. 이러면 커널이 문제의 경로 자체를 접근(=자동마운트 트리거)하지 않고도 대부분의 케이스를 해결한다.</p>

<h1 id="코드-패치-2-최종-검증을-비동기타임아웃으로">코드 패치 2: 최종 검증을 비동기·타임아웃으로</h1>

<p>그래도 원격 부모 폴더 나열이 느릴 수 있어. 그럴 땐 프로세스 풀로 “안전 판정”을 돌리고, 120ms 안에 답이 없으면 OK 버튼을 잠깐 비활성화하거나 경고 배지를 띄우자.</p>

<p>최상위에 워커 함수 추가:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_safe_isfile_worker</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
</code></pre></div></div>

<p>다이얼로그 <code class="language-plaintext highlighter-rouge">__init__</code>에서 재사용용 풀 하나:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">concurrent.futures</span> <span class="kn">import</span> <span class="n">ProcessPoolExecutor</span>
<span class="n">self</span><span class="p">.</span><span class="n">_check_pool</span> <span class="o">=</span> <span class="nc">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">_pending_check</span> <span class="o">=</span> <span class="bp">None</span>
</code></pre></div></div>

<p>OK 직전 확인(예: <code class="language-plaintext highlighter-rouge">_accept_if_valid</code>에서):</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_accept_if_valid</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">open</span><span class="sh">'</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">:</span>
        <span class="c1"># 빠른 판정으로 충분하면 바로 통과
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fast_isfile</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="nf">_match_type_filters</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">target</span><span class="p">).</span><span class="n">name</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">accept</span><span class="p">();</span> <span class="k">return</span>
        <span class="c1"># 느리면 프로세스로 120ms만 시도
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_pending_check</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">_pending_check</span><span class="p">.</span><span class="nf">done</span><span class="p">():</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_pending_check</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="n">fut</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_check_pool</span><span class="p">.</span><span class="nf">submit</span><span class="p">(</span><span class="n">_safe_isfile_worker</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_pending_check</span> <span class="o">=</span> <span class="n">fut</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">fut</span><span class="p">.</span><span class="nf">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.12</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">ok</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="nf">_match_type_filters</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">target</span><span class="p">).</span><span class="n">name</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">accept</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="n">QMessageBox</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">선택 확인</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">파일이 존재하지 않거나 접근할 수 없습니다.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="c1"># 나머지 케이스는 기존 로직
</span>    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_is_selection_valid</span><span class="p">():</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">accept</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">QMessageBox</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">선택 확인</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">선택이 유효하지 않습니다.</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>닫을 때 풀 정리:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">closeEvent</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_pending_check</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">_pending_check</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_check_pool</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">cancel_futures</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="nf">super</span><span class="p">().</span><span class="nf">closeEvent</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</code></pre></div></div>

<h1 id="정책-팁">정책 팁</h1>

<ul>
  <li>
    <p>“루트/네트워크 루트 + 접두사 짧음”에서는 어떤 판정도 하지 말고, 자동완성과 OK 둘 다 보수적으로 막아라. 타자 몇 글자 더 치면 자연스럽게 풀린다.</p>
  </li>
  <li>
    <p>저장 모드에서는 존재 확인이 필요 없다. 상위 폴더만 빠르게 확인하면 된다.</p>
  </li>
  <li>
    <p>자동완성·검증 모두 “경로 자체 stat”을 피하고, 가능하면 “부모 나열”로 판정하라.</p>
  </li>
  <li>
    <p>조직 환경에서 <code class="language-plaintext highlighter-rouge">/user</code>, <code class="language-plaintext highlighter-rouge">/net</code>, <code class="language-plaintext highlighter-rouge">/home</code>, <code class="language-plaintext highlighter-rouge">/nfs</code> 같은 autofs 지점이 있다면, 그 접두사는 공격적으로 스킵하도록 블록리스트에 올려라.</p>
  </li>
  <li>
    <p>리눅스라면 <code class="language-plaintext highlighter-rouge">/proc/mounts</code>를 읽어 <code class="language-plaintext highlighter-rouge">autofs</code> 타입 마운트 목록을 만들어두고, 그 경로 밑은 접두사 길이 3 미만이면 무조건 스킵하는 게 최선이다.</p>
  </li>
</ul>

<p>정리하면, 지금 보이는 병목은 <code class="language-plaintext highlighter-rouge">isfile</code> 한 방으로 autofs를 찌르면서 발생해. 위 패치처럼 “경로 자체 stat 금지 + 부모 디렉터리 짧게 나열 + 타임박스 + 필요시 프로세스 타임아웃”으로 바꾸면 같은 환경에서도 프리즈가 사라질 거야. 원하는 형태로 바로 붙일 수 있게, 네 코드의 <code class="language-plaintext highlighter-rouge">_is_selection_valid()</code> 부분을 기반으로 한 미니 패치도 만들어줄 수 있어.</p>

<p class="chat--user">

음 오케이오케이. 결국 내가 원하는건 내부에서 어떻게 동작하든 깔끔하게 isfile 같은 함수를 다 구현해주면 돼. 파일 확인 함수 모두 구현해줘

</p>

<p>좋아. 내부 구현이 어떻게 돌아가든—UI는 몰라도 되도록—파일 확인용 유틸을 한 덩어리로 정리해줄게. 핵심 목표는 다음이야.</p>

<ul>
  <li>
    <p>타이핑 중엔 느린 stat 계열 호출을 피한다.</p>
  </li>
  <li>
    <p>부모 디렉터리 나열로 빠르게 추정한다(타임박스).</p>
  </li>
  <li>
    <p>필요하면 멀티프로세싱으로 짧은 타임아웃 내 “확정” 검증을 한다.</p>
  </li>
  <li>
    <p>호출자가 정치(빠름/정확)만 고르면 된다.</p>
  </li>
</ul>

<p>아래 모듈은 바로 붙여서 쓸 수 있어. 반환 정책은 세 가지로 나눈다.</p>

<ul>
  <li>
    <p>빠른 추정 계열(<code class="language-plaintext highlighter-rouge">quick_…</code>): True/False/None(None=시간 초과/판단 불가)</p>
  </li>
  <li>
    <p>확정 검증 계열(<code class="language-plaintext highlighter-rouge">confirm_…</code>): 멀티프로세싱 + 타임아웃으로 True/False</p>
  </li>
  <li>
    <p>안전 래퍼(<code class="language-plaintext highlighter-rouge">safe_…</code>): quick이 결정 못 하면 confirm을 짧게 시도</p>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># file_checks.py
# -*- coding: utf-8 -*-
</span><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="n">concurrent.futures</span> <span class="kn">import</span> <span class="n">ProcessPoolExecutor</span><span class="p">,</span> <span class="nb">TimeoutError</span>

<span class="c1"># ---------------------------------------
# 내부 설정
# ---------------------------------------
# autofs/네트워크 루트 등 "건드리면 느릴" 수 있는 접두사
</span><span class="n">_RISKY_PREFIXES</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,</span>                <span class="c1"># "/"
</span>    <span class="sh">"</span><span class="s">/net</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/nfs</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/afs</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/mnt</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/media</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">/user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/users</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/home</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">/Volumes</span><span class="sh">"</span><span class="p">,</span>            <span class="c1"># macOS
</span>    <span class="sh">"</span><span class="se">\\\\</span><span class="sh">"</span><span class="p">,</span>                <span class="c1"># Windows UNC
</span><span class="p">)</span>
<span class="c1"># Windows 드라이브 루트 후보 (필요시 추가)
</span><span class="n">_WIN_ROOTS</span> <span class="o">=</span> <span class="nf">tuple</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s">:</span><span class="se">\\</span><span class="sh">"</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="sh">"</span><span class="s">ABCDEFGHIJKLMNOPQRSTUVWXYZ</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_is_risky_root</span><span class="p">(</span><span class="n">path_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">path_str</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="se">\\</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">).</span><span class="nf">lower</span><span class="p">()</span>
    <span class="k">return</span> <span class="nf">any</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">lower</span><span class="p">())</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">_RISKY_PREFIXES</span><span class="p">)</span> <span class="ow">or</span> <span class="n">path_str</span> <span class="ow">in</span> <span class="n">_WIN_ROOTS</span>

<span class="c1"># ---------------------------------------
# 빠른 부모-나열 기반 판정(타임박스)
# ---------------------------------------
</span><span class="k">def</span> <span class="nf">_parent_scan_type</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    부모 디렉터리를 os.scandir로 짧게 훑어 파일/디렉터리/기타 여부를 추정한다.
    반환: </span><span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="s"> | </span><span class="sh">"</span><span class="s">dir</span><span class="sh">"</span><span class="s"> | </span><span class="sh">"</span><span class="s">other</span><span class="sh">"</span><span class="s"> | None(판단불가/시간초과)
    </span><span class="sh">"""</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">parent</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
        <span class="c1"># 루트 같은 케이스: 디렉터리 취급
</span>        <span class="k">return</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                <span class="nf">if </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">&gt;</span> <span class="n">budget_ms</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">name</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="n">follow_symlinks</span><span class="p">):</span>
                        <span class="k">return</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span>
                    <span class="k">elif</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_file</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="n">follow_symlinks</span><span class="p">):</span>
                        <span class="k">return</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="sh">"</span><span class="s">other</span><span class="sh">"</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="c1"># entry 질의 실패 시 파일로 가정할 수도 있지만 보수적으로 기타 처리
</span>                    <span class="k">return</span> <span class="sh">"</span><span class="s">other</span><span class="sh">"</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">quick_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    빠른 추정: 부모 나열만으로 파일 여부를 판단.
    True/False 또는 None(시간초과/판단불가) 반환.
    </span><span class="sh">"""</span>
    <span class="n">typ</span> <span class="o">=</span> <span class="nf">_parent_scan_type</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">return </span><span class="p">(</span><span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">)</span> <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">quick_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
    <span class="n">typ</span> <span class="o">=</span> <span class="nf">_parent_scan_type</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">return </span><span class="p">(</span><span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span><span class="p">)</span> <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">quick_exists</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
    <span class="n">typ</span> <span class="o">=</span> <span class="nf">_parent_scan_type</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">return </span><span class="p">(</span><span class="n">typ</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">other</span><span class="sh">"</span><span class="p">))</span> <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span>

<span class="c1"># ---------------------------------------
# 멀티프로세싱 확정 검증(타임아웃)
# ---------------------------------------
</span><span class="k">def</span> <span class="nf">_mp_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">_mp_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">_mp_exists</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">_confirm_with_timeout</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="c1"># 프로세스를 매 호출마다 만드는 방식: 누수 없음, 간결
</span>    <span class="n">timeout_s</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000.0</span>
    <span class="k">with</span> <span class="nc">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="n">fut</span> <span class="o">=</span> <span class="n">pool</span><span class="p">.</span><span class="nf">submit</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nf">bool</span><span class="p">(</span><span class="n">fut</span><span class="p">.</span><span class="nf">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout_s</span><span class="p">))</span>
        <span class="k">except</span> <span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">confirm_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">_confirm_with_timeout</span><span class="p">(</span><span class="n">_mp_isfile</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">confirm_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">_confirm_with_timeout</span><span class="p">(</span><span class="n">_mp_isdir</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">confirm_exists</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">_confirm_with_timeout</span><span class="p">(</span><span class="n">_mp_exists</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">)</span>

<span class="c1"># ---------------------------------------
# 안전 래퍼: 빠름→(필요 시)확정
# ---------------------------------------
</span><span class="k">def</span> <span class="nf">safe_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">quick_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                <span class="n">confirm_timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">,</span>
                <span class="n">risky_skip_minlen</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    권장 사용: 타자 중엔 빠르게, 확정이 필요하면 짧게 confirm.
    - 위험 루트 + 이름이 짧으면(기본 2) 바로 False로 간주(탐색 회피).
    </span><span class="sh">"""</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="nf">_is_risky_root</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">))</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">risky_skip_minlen</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="n">q</span> <span class="o">=</span> <span class="nf">quick_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="o">=</span><span class="n">quick_budget_ms</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">q</span>
    <span class="k">return</span> <span class="nf">confirm_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="o">=</span><span class="n">confirm_timeout_ms</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">safe_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
               <span class="n">quick_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
               <span class="n">confirm_timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">,</span>
               <span class="n">risky_skip_minlen</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="nf">_is_risky_root</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">))</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">risky_skip_minlen</span><span class="p">:</span>
        <span class="c1"># 루트 자체는 디렉터리 취급
</span>        <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="sh">""</span>
    <span class="n">q</span> <span class="o">=</span> <span class="nf">quick_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="o">=</span><span class="n">quick_budget_ms</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">q</span>
    <span class="k">return</span> <span class="nf">confirm_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="o">=</span><span class="n">confirm_timeout_ms</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">safe_exists</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">quick_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                <span class="n">confirm_timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">,</span>
                <span class="n">risky_skip_minlen</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="nf">_is_risky_root</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">))</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">risky_skip_minlen</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="n">q</span> <span class="o">=</span> <span class="nf">quick_exists</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="o">=</span><span class="n">quick_budget_ms</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">q</span>
    <span class="k">return</span> <span class="nf">confirm_exists</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="o">=</span><span class="n">confirm_timeout_ms</span><span class="p">)</span>

<span class="c1"># ---------------------------------------
# 접근/권한 체크(빠른 버전)
# ---------------------------------------
</span><span class="k">def</span> <span class="nf">quick_access</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">R_OK</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    접근 권한 추정. 존재 여부를 확정하지 않고 부모 나열로 보수 판정.
    파일이면 os.R_OK, os.W_OK, os.X_OK 의미 동일.
    </span><span class="sh">"""</span>
    <span class="n">typ</span> <span class="o">=</span> <span class="nf">_parent_scan_type</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="c1"># 존재한다고 가정하고 접근 모드는 낙관적으로 추정할 수도 있지만,
</span>    <span class="c1"># 네트워크/권한 이슈는 확인 비용이 큼 → None 반환이 안전
</span>    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">confirm_access</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">R_OK</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">_mp_access</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="nf">access</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="n">timeout_s</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000.0</span>
    <span class="k">with</span> <span class="nc">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="n">fut</span> <span class="o">=</span> <span class="n">pool</span><span class="p">.</span><span class="nf">submit</span><span class="p">(</span><span class="n">_mp_access</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nf">bool</span><span class="p">(</span><span class="n">fut</span><span class="p">.</span><span class="nf">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout_s</span><span class="p">))</span>
        <span class="k">except</span> <span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">safe_access</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">R_OK</span><span class="p">,</span>
                <span class="n">quick_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">confirm_timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">q</span> <span class="o">=</span> <span class="nf">quick_exists</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="o">=</span><span class="n">quick_budget_ms</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="c1"># q is True/None → 필요 시 짧게 확인
</span>    <span class="k">return</span> <span class="nf">confirm_access</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="o">=</span><span class="n">confirm_timeout_ms</span><span class="p">)</span>

<span class="c1"># ---------------------------------------
# 편의: 파일/폴더 모드에서 OK 활성화 판정
# ---------------------------------------
</span><span class="k">def</span> <span class="nf">can_accept_open_file</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">require_filter_match</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                         <span class="n">name_patterns</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">...]</span> <span class="o">=</span> <span class="p">(),</span>
                         <span class="n">quick_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                         <span class="n">confirm_timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Open+File 모드의 OK 가능 여부.
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">safe_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">quick_budget_ms</span><span class="p">,</span> <span class="n">confirm_timeout_ms</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">require_filter_match</span> <span class="ow">and</span> <span class="n">name_patterns</span><span class="p">:</span>
        <span class="kn">import</span> <span class="n">fnmatch</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="n">name</span>
        <span class="k">return</span> <span class="nf">any</span><span class="p">(</span><span class="n">fnmatch</span><span class="p">.</span><span class="nf">fnmatch</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pat</span><span class="p">)</span> <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">name_patterns</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">True</span>

<span class="k">def</span> <span class="nf">can_accept_open_folder</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                           <span class="n">quick_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                           <span class="n">confirm_timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="nf">safe_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">quick_budget_ms</span><span class="p">,</span> <span class="n">confirm_timeout_ms</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">can_accept_save_file</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">quick_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                         <span class="n">confirm_timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Save+File: 상위 폴더만 존재하면 OK.
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="n">parent</span><span class="p">)</span>
    <span class="k">return</span> <span class="nf">safe_isdir</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">quick_budget_ms</span><span class="p">,</span> <span class="n">confirm_timeout_ms</span><span class="p">)</span>
</code></pre></div></div>

<p>간단 사용 예시는 아래처럼.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 예시
</span><span class="kn">from</span> <span class="n">file_checks</span> <span class="kn">import</span> <span class="n">safe_isfile</span><span class="p">,</span> <span class="n">safe_isdir</span><span class="p">,</span> <span class="n">safe_exists</span><span class="p">,</span> <span class="n">can_accept_open_file</span>

<span class="nf">print</span><span class="p">(</span><span class="nf">safe_isfile</span><span class="p">(</span><span class="sh">"</span><span class="s">/user/j</span><span class="sh">"</span><span class="p">))</span>                 <span class="c1"># autofs 환경에서도 프리즈 없이 빠른 반환
</span><span class="nf">print</span><span class="p">(</span><span class="nf">safe_isdir</span><span class="p">(</span><span class="sh">"</span><span class="s">/some/dir</span><span class="sh">"</span><span class="p">))</span>                <span class="c1"># 빠른 추정 → 필요시 150ms 타임아웃으로 확정
</span><span class="nf">print</span><span class="p">(</span><span class="nf">safe_exists</span><span class="p">(</span><span class="sh">"</span><span class="s">/network/share/file.txt</span><span class="sh">"</span><span class="p">))</span> <span class="c1"># 동일 정책
</span><span class="nf">print</span><span class="p">(</span><span class="nf">can_accept_open_file</span><span class="p">(</span><span class="sh">"</span><span class="s">/path/a.png</span><span class="sh">"</span><span class="p">,</span>
                           <span class="n">require_filter_match</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                           <span class="n">name_patterns</span><span class="o">=</span><span class="p">(</span><span class="sh">"</span><span class="s">*.png</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">*.jpg</span><span class="sh">"</span><span class="p">)))</span>
</code></pre></div></div>

<p>핵심 포인트 정리</p>

<ul>
  <li>
    <p>quick 단계는 부모 디렉터리만 짧게 나열해서 추정하므로 autofs/UNC에서도 안전하다.</p>
  </li>
  <li>
    <p>confirm 단계는 별도 프로세스로 <code class="language-plaintext highlighter-rouge">os.path.isfile</code> 같은 “진짜 stat”을 돌리되, 타임아웃을 걸어 GUI가 멈추지 않게 한다.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">safe_*</code>는 quick→confirm 순으로 처리해서 UI 코드가 간단해진다.</p>
  </li>
  <li>
    <p>위험 루트에서 이름이 너무 짧으면(기본 2) 아예 건드리지 않고 False를 돌려 탐욕적 마운트를 피한다. 필요하면 이 기준을 조정하면 된다.</p>
  </li>
</ul>

<p>원하면 이 모듈을 너의 <code class="language-plaintext highlighter-rouge">CFileDialog</code>에 바로 끼워 넣을 수 있도록 <code class="language-plaintext highlighter-rouge">_is_selection_valid()</code> 패치 버전도 만들어서 붙여줄게.</p>

<p class="chat--user">

risky root를 하드코딩으로 하는건 별로 안하고 싶네. 그 부분은 빼줘

</p>

<p>좋아. 하드코딩된 “risky root” 판단을 싹 제거한 버전이야.<br />
정책은 오직 시간 예산(타임박스)과 멀티프로세싱 타임아웃으로만 안전성을 보장해. 필요하면 호출 시 파라미터로 시간 값을 조절해 쓰면 된다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># file_checks.py
# -*- coding: utf-8 -*-
</span><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="n">concurrent.futures</span> <span class="kn">import</span> <span class="n">ProcessPoolExecutor</span><span class="p">,</span> <span class="nb">TimeoutError</span>

<span class="c1"># ---------------------------------------
# 부모-나열 기반 빠른 추정(타임박스)
# ---------------------------------------
</span><span class="k">def</span> <span class="nf">_parent_scan_type</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    부모 디렉터리를 짧게 나열해 대상이 파일/디렉터리/기타인지 추정.
    반환: </span><span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="s"> | </span><span class="sh">"</span><span class="s">dir</span><span class="sh">"</span><span class="s"> | </span><span class="sh">"</span><span class="s">other</span><span class="sh">"</span><span class="s"> | None(시간초과/판단불가)
    </span><span class="sh">"""</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">parent</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
        <span class="c1"># 루트 같은 케이스는 디렉터리로 간주
</span>        <span class="k">return</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                <span class="nf">if </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">&gt;</span> <span class="n">budget_ms</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">name</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="n">follow_symlinks</span><span class="p">):</span>
                        <span class="k">return</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span>
                    <span class="k">elif</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_file</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="n">follow_symlinks</span><span class="p">):</span>
                        <span class="k">return</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="sh">"</span><span class="s">other</span><span class="sh">"</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="k">return</span> <span class="sh">"</span><span class="s">other</span><span class="sh">"</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">quick_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
    <span class="n">typ</span> <span class="o">=</span> <span class="nf">_parent_scan_type</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">return </span><span class="p">(</span><span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">)</span> <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">quick_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
    <span class="n">typ</span> <span class="o">=</span> <span class="nf">_parent_scan_type</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">return </span><span class="p">(</span><span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span><span class="p">)</span> <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">quick_exists</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
    <span class="n">typ</span> <span class="o">=</span> <span class="nf">_parent_scan_type</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">return </span><span class="p">(</span><span class="n">typ</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">other</span><span class="sh">"</span><span class="p">))</span> <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span>

<span class="c1"># ---------------------------------------
# 멀티프로세싱 확정 검증(타임아웃)
# ---------------------------------------
</span><span class="k">def</span> <span class="nf">_mp_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">_mp_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">_mp_exists</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">_confirm_with_timeout</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">timeout_s</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000.0</span>
    <span class="c1"># 호출 단위 풀 생성: 간단하고 누수 없음
</span>    <span class="k">with</span> <span class="nc">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="n">fut</span> <span class="o">=</span> <span class="n">pool</span><span class="p">.</span><span class="nf">submit</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nf">bool</span><span class="p">(</span><span class="n">fut</span><span class="p">.</span><span class="nf">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout_s</span><span class="p">))</span>
        <span class="k">except</span> <span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">confirm_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">_confirm_with_timeout</span><span class="p">(</span><span class="n">_mp_isfile</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">confirm_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">_confirm_with_timeout</span><span class="p">(</span><span class="n">_mp_isdir</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">confirm_exists</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">_confirm_with_timeout</span><span class="p">(</span><span class="n">_mp_exists</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">)</span>

<span class="c1"># ---------------------------------------
# 안전 래퍼: 빠름→(필요 시)확정
# ---------------------------------------
</span><span class="k">def</span> <span class="nf">safe_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">quick_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                <span class="n">confirm_timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    1) quick(부모 나열, 타임박스)로 결정 시 그 값 사용
    2) 결정 불가(None)이면 멀티프로세싱으로 짧게 확정
    </span><span class="sh">"""</span>
    <span class="n">q</span> <span class="o">=</span> <span class="nf">quick_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="o">=</span><span class="n">quick_budget_ms</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q</span> <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="nf">confirm_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="o">=</span><span class="n">confirm_timeout_ms</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">safe_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
               <span class="n">quick_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
               <span class="n">confirm_timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">q</span> <span class="o">=</span> <span class="nf">quick_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="o">=</span><span class="n">quick_budget_ms</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q</span> <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="nf">confirm_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="o">=</span><span class="n">confirm_timeout_ms</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">safe_exists</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">quick_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                <span class="n">confirm_timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">q</span> <span class="o">=</span> <span class="nf">quick_exists</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="o">=</span><span class="n">quick_budget_ms</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q</span> <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="nf">confirm_exists</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="o">=</span><span class="n">confirm_timeout_ms</span><span class="p">)</span>

<span class="c1"># ---------------------------------------
# 접근/권한 체크
# ---------------------------------------
</span><span class="k">def</span> <span class="nf">confirm_access</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">R_OK</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">_mp_access</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="nf">access</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="n">timeout_s</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000.0</span>
    <span class="k">with</span> <span class="nc">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="n">fut</span> <span class="o">=</span> <span class="n">pool</span><span class="p">.</span><span class="nf">submit</span><span class="p">(</span><span class="n">_mp_access</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nf">bool</span><span class="p">(</span><span class="n">fut</span><span class="p">.</span><span class="nf">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout_s</span><span class="p">))</span>
        <span class="k">except</span> <span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">safe_access</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">R_OK</span><span class="p">,</span>
                <span class="n">quick_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">confirm_timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    접근성은 빠른 추정이 의미가 적으므로 바로 확정 호출을 권장.
    그래도 호출 시그니처를 맞추기 위해 quick_budget_ms를 남겨둠.
    </span><span class="sh">"""</span>
    <span class="k">return</span> <span class="nf">confirm_access</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="o">=</span><span class="n">confirm_timeout_ms</span><span class="p">)</span>

<span class="c1"># ---------------------------------------
# OK 활성화 판정(다이얼로그 용)
# ---------------------------------------
</span><span class="k">def</span> <span class="nf">can_accept_open_file</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">require_filter_match</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                         <span class="n">name_patterns</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">...]</span> <span class="o">=</span> <span class="p">(),</span>
                         <span class="n">quick_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                         <span class="n">confirm_timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">safe_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">quick_budget_ms</span><span class="p">,</span> <span class="n">confirm_timeout_ms</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">require_filter_match</span> <span class="ow">and</span> <span class="n">name_patterns</span><span class="p">:</span>
        <span class="kn">import</span> <span class="n">fnmatch</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="n">name</span>
        <span class="k">return</span> <span class="nf">any</span><span class="p">(</span><span class="n">fnmatch</span><span class="p">.</span><span class="nf">fnmatch</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pat</span><span class="p">)</span> <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">name_patterns</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">True</span>

<span class="k">def</span> <span class="nf">can_accept_open_folder</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                           <span class="n">quick_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                           <span class="n">confirm_timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="nf">safe_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">quick_budget_ms</span><span class="p">,</span> <span class="n">confirm_timeout_ms</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">can_accept_save_file</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">quick_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                         <span class="n">confirm_timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="n">parent</span><span class="p">)</span>
    <span class="k">return</span> <span class="nf">safe_isdir</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">quick_budget_ms</span><span class="p">,</span> <span class="n">confirm_timeout_ms</span><span class="p">)</span>
</code></pre></div></div>

<p>포인트</p>

<ul>
  <li>
    <p>어떤 경로든 하드코딩 규칙 없이 동일하게 다룬다.</p>
  </li>
  <li>
    <p>quick 계열은 부모 디렉터리만 짧게 스캔해서 프리즈를 막고, 판단 불가일 때만 confirm(프로세스, 타임아웃)으로 확정한다.</p>
  </li>
  <li>
    <p>UI에서는 <code class="language-plaintext highlighter-rouge">safe_isfile/safe_isdir/safe_exists</code>만 호출하면 되고, 느려 보이면 <code class="language-plaintext highlighter-rouge">quick_budget_ms</code>를 줄이거나 <code class="language-plaintext highlighter-rouge">confirm_timeout_ms</code>를 늘려 튜닝하면 된다.</p>
  </li>
</ul>

<p>원하면 이 모듈을 <code class="language-plaintext highlighter-rouge">CFileDialog</code>의 <code class="language-plaintext highlighter-rouge">_is_selection_valid()</code>에 바로 붙인 예시도 덧붙여줄게.</p>

<p class="chat--user">

worker가 1개인데 만약에 async나 thread로 confirm_isfile이 불려도 상관없나?

</p>

<p>결론부터 말하면, 지금 올려둔 <code class="language-plaintext highlighter-rouge">confirm_isfile()</code>처럼 <strong>호출할 때마다<code class="language-plaintext highlighter-rouge">ProcessPoolExecutor(max_workers=1)</code>를 만들고 닫는 구조</strong>라면,<br />
여러 스레드·async 컨텍스트에서 동시에 호출되어도 서로 독립적으로 돌아서 문제 없습니다. 각 호출이 자기 전용 프로세스를 잠깐 띄웠다가 타임아웃/완료 후 종료하니까요. 다만 <strong>동시 호출 수만큼 프로세스 생성 오버헤드</strong> 가 생깁니다(특히 Windows/macOS에서 spawn 비용 큼).</p>

<p>원하는 운영 방식에 따라 선택지가 두 가지예요.</p>

<h1 id="옵션-a-지금처럼-호출-단위-풀-생성">옵션 A: 지금처럼 “호출 단위 풀 생성”</h1>

<ul>
  <li>
    <p>장점: 동시 호출 안전(완전 독립), 리소스 누수 없음, 구현 간단.</p>
  </li>
  <li>
    <p>단점: 호출이 잦거나 동시에 많이 들어오면 프로세스 생성 오버헤드↑.</p>
  </li>
  <li>
    <p>스레드/async에서 동시에 불러도 OK. 단, async에서는 반드시 이벤트루프를 블로킹하지 않게 감싸야 함(아래 참고).</p>
  </li>
</ul>

<h1 id="옵션-b-공용-풀을-하나만-두고-직렬병렬-제어">옵션 B: “공용 풀”을 하나만 두고 직렬/병렬 제어</h1>

<ul>
  <li>
    <p>장점: 프로세스 생성/해제 오버헤드↓, 캐시를 얹기도 쉬움.</p>
  </li>
  <li>
    <p>단점: <code class="language-plaintext highlighter-rouge">max_workers=1</code>로 두면 요청이 큐에 쌓여 <strong>직렬 처리</strong> 됩니다. 여러 호출이 동시에 들어오면 뒤에 오는 건 타임아웃될 수 있어요. 병렬을 원하면 2~4로 늘리면 됩니다.</p>
  </li>
</ul>

<p>아래는 두 옵션의 안전한 패턴과 async/스레드에서 쓰는 방법입니다.</p>

<h2 id="옵션-a-유지호출-단위-풀--async스레드에서-호출">옵션 A 유지(호출 단위 풀) + async/스레드에서 호출</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 동기 호출은 그대로 사용
</span><span class="n">ok</span> <span class="o">=</span> <span class="nf">confirm_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="c1"># 스레드에서 호출 (GUI 이벤트 루프 안막음)
</span><span class="kn">import</span> <span class="n">threading</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="nf">confirm_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">daemon</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">t</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>

<span class="c1"># asyncio에서 호출 (반드시 run_in_executor/to_thread로 감싸기)
</span><span class="kn">import</span> <span class="n">asyncio</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">confirm_isfile_async</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="o">=</span><span class="mi">150</span><span class="p">):</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">loop</span><span class="p">.</span><span class="nf">run_in_executor</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">confirm_isfile</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">)</span>

<span class="c1"># 사용
</span><span class="n">ok</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">confirm_isfile_async</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="옵션-b-공용-풀권장-파라미터-예시-max_workers24">옵션 B: 공용 풀(권장 파라미터 예시: max_workers=2~4)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># file_checks_pool.py
</span><span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">concurrent.futures</span> <span class="kn">import</span> <span class="n">ProcessPoolExecutor</span><span class="p">,</span> <span class="nb">TimeoutError</span>
<span class="n">_pool</span> <span class="o">=</span> <span class="nc">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># 병렬 2개
</span>
<span class="k">def</span> <span class="nf">_mp_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">bool</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span> <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">confirm_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">bool</span><span class="p">:</span>
    <span class="n">fut</span> <span class="o">=</span> <span class="n">_pool</span><span class="p">.</span><span class="nf">submit</span><span class="p">(</span><span class="n">_mp_isfile</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">bool</span><span class="p">(</span><span class="n">fut</span><span class="p">.</span><span class="nf">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout_ms</span><span class="o">/</span><span class="mi">1000</span><span class="p">))</span>
    <span class="k">except</span> <span class="nb">TimeoutError</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="c1"># 종료 시 정리(앱 종료 훅이나 다이얼로그 closeEvent에서 호출)
</span><span class="k">def</span> <span class="nf">shutdown_pool</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span> <span class="n">_pool</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">cancel_futures</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
</code></pre></div></div>

<h3 id="async-래퍼">async 래퍼</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># asyncio에서 블로킹 피하기
</span><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">file_checks_pool</span> <span class="kn">import</span> <span class="n">confirm_isfile</span> <span class="k">as</span> <span class="n">_confirm_isfile</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">confirm_isfile_async</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="o">=</span><span class="mi">150</span><span class="p">):</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">loop</span><span class="p">.</span><span class="nf">run_in_executor</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">_confirm_isfile</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="스레드-안전성">스레드 안전성</h3>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">ProcessPoolExecutor</code> 자체는 <strong>스레드 세이프</strong> 한 제출을 지원합니다. 여러 스레드에서 동시에 <code class="language-plaintext highlighter-rouge">submit()</code> 호출 가능.</p>
  </li>
  <li>
    <p>단, <code class="language-plaintext highlighter-rouge">max_workers=1</code>이면 제출은 되지만 실행은 <strong>순차적</strong> 입니다. 여러 곳에서 동시에 타임아웃 짧게 걸고 기다리면, 뒤의 Future들이 타임아웃으로 False를 받게 되는 건 정상 동작입니다. 필요하면 <code class="language-plaintext highlighter-rouge">max_workers</code>를 늘리거나, 호출 측에서 디바운싱/리밋을 두세요.</p>
  </li>
</ul>

<h1 id="추가-팁">추가 팁</h1>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">quick_*</code>(부모 나열 기반 추정)는 순수 I/O + 지역 루프이므로 <strong>스레드·async 동시 호출 안전</strong> 합니다. 공유 상태가 없고, GIL로 간단히 보호됩니다.</p>
  </li>
  <li>
    <p>Qt/async 혼합 환경이면, 이벤트 루프를 막지 않도록 <code class="language-plaintext highlighter-rouge">confirm_*</code>를 항상 <code class="language-plaintext highlighter-rouge">run_in_executor</code>(또는 <code class="language-plaintext highlighter-rouge">to_thread</code>)로 감싸세요.</p>
  </li>
  <li>
    <p>Windows/macOS에서 멀티프로세싱은 항상 <code class="language-plaintext highlighter-rouge">if __name__ == "__main__":</code> 가드가 필요합니다. Qt 앱 엔트리도 그 안에서 시작하세요.</p>
  </li>
  <li>
    <p>공용 풀을 쓴다면 앱 종료 시 <code class="language-plaintext highlighter-rouge">shutdown_pool()</code> 호출로 정리하는 습관을 들이면 좋습니다.</p>
  </li>
</ul>

<p>정리:</p>

<ul>
  <li>
    <p>지금 구조(호출 단위 풀)는 <strong>동시 호출에도 안전</strong> 하지만 오버헤드가 큽니다.</p>
  </li>
  <li>
    <p>공용 풀은 <strong>효율적</strong> 이고 스레드·async 모두 안전하되, <code class="language-plaintext highlighter-rouge">max_workers</code> 설정에 따라 직렬/병렬 특성이 달라지니 호출 패턴에 맞춰 수치만 잡으면 됩니다.</p>
  </li>
</ul>

<p class="chat--user">

근데 보니까 aiofiles 라는 패키지가 있네. 멀티프로세싱 대신 이걸 타임아웃 걸어서 쓰는건 어떨까

</p>

<p>좋은 발상인데, 딱 정리하면 이렇습니다.</p>

<ul>
  <li>
    <p>aiofiles는 파일 열기/읽기 같은 파일 I/O를 비동기로 다루기 위해 내부적으로 스레드풀을 씁니다. <code class="language-plaintext highlighter-rouge">os.path.isfile</code> 같은 stat 계열은 aiofiles가 감싸주지 않으니 <code class="language-plaintext highlighter-rouge">asyncio.to_thread</code>나 <code class="language-plaintext highlighter-rouge">run_in_executor</code>로 직접 감싸야 합니다.</p>
  </li>
  <li>
    <p>타임아웃은 <code class="language-plaintext highlighter-rouge">asyncio.wait_for</code>로 손쉽게 걸 수 있지만, 커널에서 stat이 오래 블록되면 스레드는 계속 붙잡혀 있고 코루틴만 취소됩니다. 즉, GUI는 살지만 백그라운드 스레드가 “끝날 때까지” 남습니다. 반면 멀티프로세싱은 프로세스를 내려서 정리할 수 있다는 차이가 있어요.</p>
  </li>
  <li>
    <p>정리: 이미 앱에 asyncio 루프(예: qasync 사용)가 있고, 네트워크 환경이 아주 험하지 않다면 aiofiles/스레드 경로가 간단하고 충분합니다. 오랫동안 먹통이 되는 경로가 많다면 멀티프로세싱이 더 안전합니다.</p>
  </li>
</ul>

<p>아래는 깔끔한 비동기 버전입니다. 하드코딩 규칙 없이, 타임박스 중심으로 동작합니다.</p>

<h3 id="1-빠른-추정동기-부모-나열-타임박스">1) 빠른 추정(동기, 부모 나열 타임박스)</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="k">def</span> <span class="nf">_parent_scan_type</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">);</span> <span class="n">parent</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                <span class="nf">if </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">&gt;</span> <span class="n">budget_ms</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">name</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="n">follow_symlinks</span><span class="p">):</span>
                        <span class="k">return</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span>
                    <span class="k">elif</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_file</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="n">follow_symlinks</span><span class="p">):</span>
                        <span class="k">return</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="sh">"</span><span class="s">other</span><span class="sh">"</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="k">return</span> <span class="sh">"</span><span class="s">other</span><span class="sh">"</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">quick_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
    <span class="n">t</span> <span class="o">=</span> <span class="nf">_parent_scan_type</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">return </span><span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">quick_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
    <span class="n">t</span> <span class="o">=</span> <span class="nf">_parent_scan_type</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">return </span><span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">quick_exists</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
    <span class="n">t</span> <span class="o">=</span> <span class="nf">_parent_scan_type</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">return </span><span class="p">(</span><span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">dir</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">other</span><span class="sh">"</span><span class="p">))</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span>
</code></pre></div></div>

<h3 id="2-aiofiles-없이-asyncio로-확정-확인-스레드풀--타임아웃">2) aiofiles 없이 asyncio로 “확정 확인” (스레드풀 + 타임아웃)</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">asyncio</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">confirm_isfile_async</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
    <span class="n">coro</span> <span class="o">=</span> <span class="n">loop</span><span class="p">.</span><span class="nf">run_in_executor</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">isfile</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_ms</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">confirm_isdir_async</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
    <span class="n">coro</span> <span class="o">=</span> <span class="n">loop</span><span class="p">.</span><span class="nf">run_in_executor</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">isdir</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_ms</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">confirm_exists_async</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
    <span class="n">coro</span> <span class="o">=</span> <span class="n">loop</span><span class="p">.</span><span class="nf">run_in_executor</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_ms</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
</code></pre></div></div>

<p>참고: aiofiles를 꼭 쓰고 싶다면 <code class="language-plaintext highlighter-rouge">await asyncio.wait_for(asyncio.to_thread(os.path.isfile, path), timeout)</code>처럼 동일하게 감싸면 됩니다. 실질적으로는 위 코드와 같습니다.</p>

<h3 id="3-안전-래퍼-빠른-추정--필요-시-비동기-확정">3) 안전 래퍼: 빠른 추정 → 필요 시 비동기 확정</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">safe_isfile_async</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">quick_budget_ms</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">confirm_timeout_ms</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">q</span> <span class="o">=</span> <span class="nf">quick_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="o">=</span><span class="n">quick_budget_ms</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q</span> <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="k">await</span> <span class="nf">confirm_isfile_async</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="o">=</span><span class="n">confirm_timeout_ms</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">safe_isdir_async</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">quick_budget_ms</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">confirm_timeout_ms</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">q</span> <span class="o">=</span> <span class="nf">quick_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="o">=</span><span class="n">quick_budget_ms</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q</span> <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="k">await</span> <span class="nf">confirm_isdir_async</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="o">=</span><span class="n">confirm_timeout_ms</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">safe_exists_async</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">quick_budget_ms</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">confirm_timeout_ms</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">q</span> <span class="o">=</span> <span class="nf">quick_exists</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">budget_ms</span><span class="o">=</span><span class="n">quick_budget_ms</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q</span> <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="k">await</span> <span class="nf">confirm_exists_async</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="o">=</span><span class="n">confirm_timeout_ms</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="4-pyside6와-같이-쓰는-방법">4) PySide6와 같이 쓰는 방법</h3>

<ul>
  <li>
    <p>Qt 이벤트 루프와 asyncio를 함께 쓰려면 qasync를 쓰는 게 깔끔합니다.</p>
  </li>
  <li>
    <p>버튼 클릭 시 <code class="language-plaintext highlighter-rouge">asyncio.create_task(safe_isfile_async(...))</code>로 던지고, 완료되면 OK 버튼 상태를 갱신합니다.</p>
  </li>
  <li>
    <p>타임아웃이 발생해도 스레드는 죽지 않고 백그라운드에서 끝까지 돌 수 있습니다. 보통 문제 없지만, 호출 폭주를 막으려면 디바운스/동시 실행 제한을 두세요.</p>
  </li>
</ul>

<h3 id="5-멀티프로세싱과-비교한-장단점-요약">5) 멀티프로세싱과 비교한 장단점 요약</h3>

<ul>
  <li>
    <p>aiofiles/스레드 방식</p>

    <ul>
      <li>
        <p>장점: 설정 간단, 프로세스 스폰 오버헤드 없음, UI와 자연스러운 연동.</p>
      </li>
      <li>
        <p>단점: 타임아웃이 걸려도 실제 OS 호출 스레드는 살아 있어 누적될 수 있음. 아주 느린 네트워크/autofs에서 많이 호출하면 스레드풀 고갈 가능성.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>멀티프로세싱</p>

    <ul>
      <li>
        <p>장점: 최악의 블로킹에서 격리 안전. 필요시 프로세스 종료로 강제 정리 가능.</p>
      </li>
      <li>
        <p>단점: 스폰 비용, 코드·배포 복잡도 증가.</p>
      </li>
    </ul>
  </li>
</ul>

<p>실전 추천은 이렇습니다.</p>

<ul>
  <li>
    <p>앱이 이미 qasync로 asyncio를 쓰고 있고, 경로 확인 호출 빈도가 낮거나 중간 정도라면 위 비동기 스레드풀+타임아웃 구성이 가장 단순합니다.</p>
  </li>
  <li>
    <p>네트워크 마운트가 “자주” 느려지는 환경이면, 비동기 버전을 기본으로 쓰되, 타임아웃이 일정 횟수 연속 발생할 때만 멀티프로세싱 경로로 자동 폴백하는 하이브리드가 제일 튼튼합니다.</p>
  </li>
</ul>

        
      </section>

      <footer class="page__meta">
        
        


  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#python" class="page__taxonomy-item p-category" rel="tag">python</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2025-11-12T19:33:35+09:00">2025-11-12</time></p>

      </footer>

      

      
  <nav class="pagination">
    
      <a href="/misc/web-korean-keyboard/" class="pagination--pager" title="웹 한글 키보드 추가">Previous</a>
    
    
      <a href="/qt/qfiledialog-study/" class="pagination--pager" title="QFileDialog 설명">Next</a>
    
  </nav>


    </div>

    
  </article>

  
  
    
<div class="page__related">
  
  <h2 class="page__related-title">You may also enjoy</h2>
  <div class="grid__wrapper">
    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2025-08-19-python-repr-vs-str/" rel="permalink">
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-11-13T12:24:10+09:00">2025-11-13</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/qt/qfiledialog-study/" rel="permalink">QFileDialog 설명
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-11-13T12:24:00+09:00">2025-11-13</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/misc/web-korean-keyboard/" rel="permalink">웹 한글 키보드 추가
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-11-07T20:48:31+09:00">2025-11-07</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/misc/virutual-korean-keyboard/" rel="permalink">untitled
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-11-07T17:47:20+09:00">2025-11-07</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">ChatGPT404 Not Found
</p>
  </article>
</div>

    
  </div>
</div>

  
  
</div>

      
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        

<div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    
  </ul>
</div>


<div class="page__footer-copyright">&copy; 2013 - 2025 <a href="https://hvppyarchive.github.io">ARCHIVE</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/jekyll-themes/minimal-mistakes/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>






  </body>
</html>
