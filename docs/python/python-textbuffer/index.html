<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.27.1 by Michael Rose
  Copyright 2013-2025 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en-US" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Python TextBuffer 구현 - ARCHIVE</title>
<meta name="description" content="">


  <meta name="author" content="hvppyarchive">
  
  <meta property="article:author" content="hvppyarchive">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="ARCHIVE">
<meta property="og:title" content="Python TextBuffer 구현">
<meta property="og:url" content="https://hvppyarchive.github.io/python/python-textbuffer/">


  <meta property="og:description" content="">







  <meta property="article:published_time" content="2025-08-21T19:10:46+09:00">





  

  


<link rel="canonical" href="https://hvppyarchive.github.io/python/python-textbuffer/">












<!-- end _includes/seo.html -->


<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->
<!-- hvppyarchive: add fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@200..900&display=swap" rel="stylesheet">

<!-- insert favicons. use https://realfavicongenerator.net/ -->
 <!-- hvppyarchive: add favicons -->
<link rel="icon" type="image/png" href="/assets/favicon/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/assets/favicon/favicon.svg" />
<link rel="shortcut icon" href="/assets/favicon/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png" />
<link rel="manifest" href="/assets/favicon/site.webmanifest" />

<!-- end custom head snippets -->

  </head>

  <body class="layout--single" dir="ltr">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          ARCHIVE
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/year-archive/"
                
                
              >Posts</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Python TextBuffer 구현">
    <meta itemprop="description" content="">
    <meta itemprop="datePublished" content="2025-08-21T19:10:46+09:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://hvppyarchive.github.io/python/python-textbuffer/" itemprop="url">Python TextBuffer 구현
</a>
          </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-08-21T19:10:46+09:00">2025-08-21</time>
      </span>
    

    

    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p class="chat--user">

Developer: 현재 Verilog 파일 처리와 관련된 여러 작업(예: 간단한 전처리/후처리 등)을 수행 중입니다. Raw Verilog 소스 코드를 저장할 수 있는 파이썬 클래스 개발을 검토하고 있습니다. Verilog 소스 코드는 문자열 형태로 보관하거나, 줄 단위로 split하여 List[str] 타입(줄바꿈 없이)으로 저장하거나, splitlines(keepends=True)를 사용해 줄바꿈이 포함된 리스트로 보관할 수 있습니다. 여러 방식이 프로젝트 내에서 혼용되면 혼란을 초래할 수 있으므로, 범용적으로 사용할 수 있도록 일관된 구조를 하나의 클래스에 통일할 것을 권장합니다. Begin with a concise checklist (3-7 bullets) of what you will do; keep items conceptual, not implementation-level. After each significant code or class design decision, briefly validate if the chosen approach aligns with the project's consistency and extensibility goals, and self-correct if needed.

</p>

<p>here’s the game plan:</p>

<ul>
  <li>
    <p>Define one <strong>canonical, internal representation</strong> for Verilog source and convert to/from other views.</p>
  </li>
  <li>
    <p>Normalize and <strong>track newline style</strong> for faithful round-trips (LF/CRLF/mixed).</p>
  </li>
  <li>
    <p>Expose <strong>consistent views</strong> (<code class="language-plaintext highlighter-rouge">as_string()</code>, <code class="language-plaintext highlighter-rouge">as_lines(keepends=...)</code>) instead of multiple storage forms.</p>
  </li>
  <li>
    <p>Provide a small, <strong>extensible transform pipeline</strong> for pre/post-processing (with history).</p>
  </li>
  <li>
    <p>Make edits <strong>immutable by default</strong> (return a new instance) with an opt-in <code class="language-plaintext highlighter-rouge">in_place=True</code>.</p>
  </li>
  <li>
    <p>Add <strong>I/O helpers</strong> (<code class="language-plaintext highlighter-rouge">from_*</code>, <code class="language-plaintext highlighter-rouge">to_file</code>) with explicit encoding and deterministic newline policy.</p>
  </li>
</ul>

<hr />

<h2 id="key-design-decisions-with-quick-self-checks">Key design decisions (with quick self-checks)</h2>

<ol>
  <li>
    <p><strong>Canonical storage = one normalized<code class="language-plaintext highlighter-rouge">str</code> (<code class="language-plaintext highlighter-rouge">\n</code> line endings).</strong></p>

    <ul>
      <li>
        <p><em>Why:</em> single source of truth avoids drift between parallel representations; Python string ops are fast and familiar.</p>
      </li>
      <li>
        <p><em>Consistency/Extensibility check:</em> callers always interact with one invariant; adding new views later won’t change storage. ✅</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>Preserve original newline style as metadata (<code class="language-plaintext highlighter-rouge">'lf'|'crlf'|'mixed'</code>).</strong></p>

    <ul>
      <li>
        <p><em>Why:</em> we normalize internally but can emit exactly what the file used before, unless caller overrides.</p>
      </li>
      <li>
        <p><em>Check:</em> round-tripping is predictable across the project; future formatters can opt into a uniform style. ✅</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>Views, not storage:</strong> <code class="language-plaintext highlighter-rouge">as_string(newline=...)</code> and <code class="language-plaintext highlighter-rouge">as_lines(keepends=False|True, newline=...)</code>.</p>

    <ul>
      <li>
        <p><em>Why:</em> banishes ad-hoc lists/strings in the codebase; one class hands out consistent views.</p>
      </li>
      <li>
        <p><em>Check:</em> API encourages a single pattern everywhere; avoids mixing representations in state. ✅</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>Edits are immutable by default, with<code class="language-plaintext highlighter-rouge">in_place=True</code> for performance-critical paths.</strong></p>

    <ul>
      <li>
        <p><em>Why:</em> functional style reduces surprise; explicit mutability keeps hot paths fast.</p>
      </li>
      <li>
        <p><em>Check:</em> consistent with safety + speed; cache invalidation is centralized. ✅</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>Lazy, cached line splits (both with and without<code class="language-plaintext highlighter-rouge">keepends</code>).</strong></p>

    <ul>
      <li>
        <p><em>Why:</em> many tools need line access; caching avoids repeated <code class="language-plaintext highlighter-rouge">splitlines</code>.</p>
      </li>
      <li>
        <p><em>Check:</em> cache invalidated on any text change; future features (e.g., line index) can reuse it. ✅</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>Transform pipeline:<code class="language-plaintext highlighter-rouge">apply(transformer)</code> where a transformer is a callable <code class="language-plaintext highlighter-rouge">text -&gt; text</code>, plus history.</strong></p>

    <ul>
      <li>
        <p><em>Why:</em> flexible slot for “pre/post-processing” like trimming, EOL fixing, simple macro munging, etc.</p>
      </li>
      <li>
        <p><em>Check:</em> keeps responsibilities modular; easy to add/remove steps; provenance is recorded. ✅</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>I/O boundaries explicit:</strong> constructors for string/lines/file; <code class="language-plaintext highlighter-rouge">to_file(encoding, newline)</code>; no auto-detection magic.</p>

    <ul>
      <li>
        <p><em>Why:</em> explicit beats implicit; fewer surprises across platforms and CI.</p>
      </li>
      <li>
        <p><em>Check:</em> project-wide consistency; easy to thread encoding/newline policy from config. ✅</p>
      </li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="the-class">The class</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">import</span> <span class="n">hashlib</span>
<span class="kn">import</span> <span class="n">time</span>

<span class="n">NewlineStyle</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">lf</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">crlf</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">mixed</span><span class="sh">"</span><span class="p">]</span>
<span class="n">EmitNewline</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">original</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">lf</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">crlf</span><span class="sh">"</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">TextTransformer</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">A simple, composable transformer: text -&gt; text.</span><span class="sh">"""</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="bp">...</span>

<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TransformRecord</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">before_sha1</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">after_sha1</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nf">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">VerilogSource</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Canonical container for Verilog source.

    Invariants:
      - Internal storage `_text` always uses LF (</span><span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="s">) line endings.
      - `_newline_style` records the original newline style encountered on load.
      - All edit methods are immutable by default; pass in_place=True to mutate.
    </span><span class="sh">"""</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sh">"</span><span class="s">_text</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">_newline_style</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">_encoding</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">_source_path</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">_version</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">_cached_lines</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">_cached_lines_keepends</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">_history</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">newline_style</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NewlineStyle</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">source_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">_assume_normalized</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_assume_normalized</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">text</span>
            <span class="n">style</span> <span class="o">=</span> <span class="n">newline_style</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">lf</span><span class="sh">"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">norm</span><span class="p">,</span> <span class="n">style</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_normalize_newlines</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">prefer</span><span class="o">=</span><span class="sh">"</span><span class="s">lf</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># internal LF
</span>            <span class="k">if</span> <span class="n">newline_style</span> <span class="ow">and</span> <span class="n">newline_style</span> <span class="o">!=</span> <span class="n">style</span><span class="p">:</span>
                <span class="c1"># honor explicit override only for "mixed" -&gt; "lf/crlf" upgrade
</span>                <span class="n">style</span> <span class="o">=</span> <span class="n">newline_style</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_text</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">norm</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_newline_style</span><span class="p">:</span> <span class="n">NewlineStyle</span> <span class="o">=</span> <span class="n">style</span>  <span class="c1"># how it *came in* (for round-trip)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">encoding</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_source_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">source_path</span> <span class="k">else</span> <span class="bp">None</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cached_lines</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>              <span class="c1"># keepends=False
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_cached_lines_keepends</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>     <span class="c1"># keepends=True
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_history</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TransformRecord</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># ---------- creation / I/O ----------
</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_string</span><span class="p">(</span>
        <span class="n">cls</span><span class="p">,</span>
        <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">source_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">VerilogSource</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">cls</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span> <span class="n">source_path</span><span class="o">=</span><span class="n">source_path</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_lines</span><span class="p">(</span>
        <span class="n">cls</span><span class="p">,</span>
        <span class="n">lines</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">keepends</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">source_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">VerilogSource</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">keepends</span><span class="p">:</span>
            <span class="n">joined</span> <span class="o">=</span> <span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">joined</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">cls</span><span class="p">(</span><span class="n">joined</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span> <span class="n">source_path</span><span class="o">=</span><span class="n">source_path</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span>
        <span class="n">cls</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">VerilogSource</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">cls</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span> <span class="n">source_path</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_file</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">newline</span><span class="p">:</span> <span class="n">EmitNewline</span> <span class="o">=</span> <span class="sh">"</span><span class="s">original</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">ensure_trailing_newline</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">as_string</span><span class="p">(</span><span class="n">newline</span><span class="o">=</span><span class="n">newline</span><span class="p">,</span> <span class="n">ensure_trailing_newline</span><span class="o">=</span><span class="n">ensure_trailing_newline</span><span class="p">)</span>
        <span class="n">p</span><span class="p">.</span><span class="nf">write_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="n">_encoding</span><span class="p">)</span>

    <span class="c1"># ---------- core views ----------
</span>
    <span class="k">def</span> <span class="nf">as_string</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">newline</span><span class="p">:</span> <span class="n">EmitNewline</span> <span class="o">=</span> <span class="sh">"</span><span class="s">original</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">ensure_trailing_newline</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_text</span>
        <span class="k">if</span> <span class="n">ensure_trailing_newline</span> <span class="ow">is</span> <span class="bp">True</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">)):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span>
        <span class="k">if</span> <span class="n">ensure_trailing_newline</span> <span class="ow">is</span> <span class="bp">False</span> <span class="ow">and</span> <span class="n">s</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">newline</span> <span class="o">==</span> <span class="sh">"</span><span class="s">original</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">style</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_newline_style</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">style</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">lf</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">lf</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">crlf</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">crlf</span><span class="sh">"</span><span class="p">}[</span><span class="n">newline</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="sh">"</span><span class="s">lf</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span>
        <span class="k">elif</span> <span class="n">style</span> <span class="o">==</span> <span class="sh">"</span><span class="s">crlf</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="se">\r\n</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># "mixed" -&gt; default to CRLF for lines that originally were CRLF? We can't reconstruct mixed reliably.
</span>            <span class="c1"># project policy: emit LF for mixed unless caller overrides
</span>            <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">as_lines</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">keepends</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">keepends</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_cached_lines_keepends</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_cached_lines_keepends</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_text</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_cached_lines_keepends</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_cached_lines</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_cached_lines</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_text</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_cached_lines</span><span class="p">)</span>

    <span class="c1"># ---------- inspection ----------
</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">source_path</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_source_path</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">newline_style</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NewlineStyle</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_newline_style</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">encoding</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_encoding</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_version</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">history</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">TransformRecord</span><span class="p">,</span> <span class="p">...]:</span>
        <span class="k">return</span> <span class="nf">tuple</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_history</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">line_count</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">as_lines</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">get_line</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">keepend</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">as_lines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="n">keepend</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="c1"># ---------- transforms / edits ----------
</span>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">transformer</span><span class="p">:</span> <span class="n">TextTransformer</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">in_place</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">record</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">VerilogSource</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">before</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_text</span>
        <span class="n">after</span> <span class="o">=</span> <span class="nf">transformer</span><span class="p">(</span><span class="n">before</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">after</span> <span class="ow">is</span> <span class="n">before</span><span class="p">:</span>
            <span class="c1"># even if identity, return self or bump version in-place
</span>            <span class="k">if</span> <span class="n">in_place</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_bump_version</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">self</span>

        <span class="k">if</span> <span class="n">in_place</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_set_text</span><span class="p">(</span><span class="n">after</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">record</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_record</span><span class="p">(</span><span class="n">transformer</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inst</span> <span class="o">=</span> <span class="nc">VerilogSource</span><span class="p">(</span>
                <span class="n">after</span><span class="p">,</span>
                <span class="n">newline_style</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_newline_style</span><span class="p">,</span>
                <span class="n">encoding</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_encoding</span><span class="p">,</span>
                <span class="n">source_path</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_source_path</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">record</span><span class="p">:</span>
                <span class="n">inst</span><span class="p">.</span><span class="n">_history</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">self</span><span class="p">.</span><span class="n">_history</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="nf">_mk_record</span><span class="p">(</span><span class="n">transformer</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">)]</span>
            <span class="k">return</span> <span class="n">inst</span>

    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">old</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">new</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">in_place</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">VerilogSource</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">class</span> <span class="nc">_Repl</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span>
            <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">text</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="nf">_Repl</span><span class="p">(),</span> <span class="n">in_place</span><span class="o">=</span><span class="n">in_place</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_line</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">keepend</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">in_place</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">VerilogSource</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">as_lines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  <span class="c1"># edit with keepends to keep layout
</span>        <span class="k">if</span> <span class="n">keepend</span><span class="p">:</span>
            <span class="c1"># caller provided EOL
</span>            <span class="n">lines</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># normalize to internal LF
</span>            <span class="n">eol</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="k">if</span> <span class="n">lines</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="sh">""</span>
            <span class="n">lines</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span> <span class="o">+</span> <span class="n">eol</span>
        <span class="n">new_text</span> <span class="o">=</span> <span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">_with_text</span><span class="p">(</span><span class="n">new_text</span><span class="p">,</span> <span class="n">in_place</span><span class="o">=</span><span class="n">in_place</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">insert_lines</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">new_lines</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">keepends</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">in_place</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">VerilogSource</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">nl</span> <span class="o">=</span> <span class="p">[</span><span class="n">ln</span> <span class="k">if</span> <span class="n">keepends</span> <span class="nf">else </span><span class="p">(</span><span class="n">ln</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span> <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">new_lines</span><span class="p">]</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">as_lines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">new_text</span> <span class="o">=</span> <span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[:</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">nl</span> <span class="o">+</span> <span class="n">lines</span><span class="p">[</span><span class="n">idx</span><span class="p">:])</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">_with_text</span><span class="p">(</span><span class="n">new_text</span><span class="p">,</span> <span class="n">in_place</span><span class="o">=</span><span class="n">in_place</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">delete_lines</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">end</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">in_place</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">VerilogSource</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">as_lines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">new_text</span> <span class="o">=</span> <span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[:</span><span class="n">start</span><span class="p">]</span> <span class="o">+</span> <span class="n">lines</span><span class="p">[</span><span class="n">end</span><span class="p">:])</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">_with_text</span><span class="p">(</span><span class="n">new_text</span><span class="p">,</span> <span class="n">in_place</span><span class="o">=</span><span class="n">in_place</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ensure_trailing_newline</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">in_place</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">VerilogSource</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_text</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">self</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">_with_text</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_text</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">in_place</span><span class="o">=</span><span class="n">in_place</span><span class="p">)</span>

    <span class="c1"># ---------- internals ----------
</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_normalize_newlines</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">prefer</span><span class="p">:</span> <span class="n">NewlineStyle</span> <span class="o">=</span> <span class="sh">"</span><span class="s">lf</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">NewlineStyle</span><span class="p">]:</span>
        <span class="n">has_crlf</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\r\n</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">text</span>
        <span class="n">has_lf</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">text</span>
        <span class="k">if</span> <span class="n">has_crlf</span> <span class="ow">and</span> <span class="n">has_lf</span> <span class="ow">and</span> <span class="n">text</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="se">\r\n</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span> <span class="o">!=</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">style</span><span class="p">:</span> <span class="n">NewlineStyle</span> <span class="o">=</span> <span class="sh">"</span><span class="s">mixed</span><span class="sh">"</span>
        <span class="k">elif</span> <span class="n">has_crlf</span><span class="p">:</span>
            <span class="n">style</span> <span class="o">=</span> <span class="sh">"</span><span class="s">crlf</span><span class="sh">"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">style</span> <span class="o">=</span> <span class="sh">"</span><span class="s">lf</span><span class="sh">"</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">text</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="se">\r\n</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">).</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="se">\r</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># coerce to LF
</span>        <span class="k">return</span> <span class="n">norm</span><span class="p">,</span> <span class="n">style</span>

    <span class="k">def</span> <span class="nf">_with_text</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">new_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">in_place</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">VerilogSource</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">in_place</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_set_text</span><span class="p">(</span><span class="n">new_text</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span>
        <span class="n">inst</span> <span class="o">=</span> <span class="nc">VerilogSource</span><span class="p">(</span>
            <span class="n">new_text</span><span class="p">,</span>
            <span class="n">newline_style</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_newline_style</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_encoding</span><span class="p">,</span>
            <span class="n">source_path</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_source_path</span><span class="p">,</span>
            <span class="n">_assume_normalized</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">inst</span><span class="p">.</span><span class="n">_history</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_history</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inst</span>

    <span class="k">def</span> <span class="nf">_set_text</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">new_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_text</span> <span class="o">=</span> <span class="n">new_text</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_invalidate_cache</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_bump_version</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_invalidate_cache</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cached_lines</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cached_lines_keepends</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_bump_version</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_version</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_mk_record</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">before</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">after</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransformRecord</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">TransformRecord</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">before_sha1</span><span class="o">=</span><span class="n">hashlib</span><span class="p">.</span><span class="nf">sha1</span><span class="p">(</span><span class="n">before</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)).</span><span class="nf">hexdigest</span><span class="p">(),</span>
            <span class="n">after_sha1</span><span class="o">=</span><span class="n">hashlib</span><span class="p">.</span><span class="nf">sha1</span><span class="p">(</span><span class="n">after</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)).</span><span class="nf">hexdigest</span><span class="p">(),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_record</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">before</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">after</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_history</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_mk_record</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">))</span>
</code></pre></div></div>

<p><strong>Validation:</strong> The class enforces one storage invariant (LF string), exposes consistent views, and gives predictable I/O. It’s easy to extend with more transforms or richer metadata later. This aligns with our consistency goal and makes future preprocessors trivial to add. ✅</p>

<hr />

<h2 id="example-transformers-plug-and-play">Example transformers (plug-and-play)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TrimTrailingWhitespace</span><span class="p">:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="sh">"</span><span class="s">trim_trailing_ws</span><span class="sh">"</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># safe for Verilog; does not alter semantics
</span>        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s"> </span><span class="se">\t</span><span class="sh">"</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">text</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">())</span>

<span class="k">class</span> <span class="nc">EnsureFinalNewline</span><span class="p">:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="sh">"</span><span class="s">ensure_final_newline</span><span class="sh">"</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">text</span> <span class="k">if</span> <span class="n">text</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span> <span class="nf">else </span><span class="p">(</span><span class="n">text</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Validation:</strong> Transformers are plain callables; team members can add steps without touching the core class. History records provenance. ✅</p>

<hr />

<h2 id="typical-usage-uniform-across-the-project">Typical usage (uniform across the project)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Load
</span><span class="n">src</span> <span class="o">=</span> <span class="n">VerilogSource</span><span class="p">.</span><span class="nf">from_file</span><span class="p">(</span><span class="sh">"</span><span class="s">rtl/top.v</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Get views (without changing internal storage form)
</span><span class="n">text</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="nf">as_string</span><span class="p">()</span>                            <span class="c1"># normalized LF by default (round-tripped on write)
</span><span class="n">lines</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="nf">as_lines</span><span class="p">()</span>                            <span class="c1"># ['module top(', ...]
</span><span class="n">lines_ke</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="nf">as_lines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>            <span class="c1"># ['module top(\n', ...]
</span>
<span class="c1"># Edits (immutable by default)
</span><span class="n">src2</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="nf">set_line</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="sh">"</span><span class="s">// AUTOGEN: do not edit</span><span class="sh">"</span><span class="p">)</span>
<span class="n">src3</span> <span class="o">=</span> <span class="n">src2</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="nc">TrimTrailingWhitespace</span><span class="p">())</span>

<span class="c1"># Save with original newline style, enforcing final newline
</span><span class="n">src3</span><span class="p">.</span><span class="nf">to_file</span><span class="p">(</span><span class="sh">"</span><span class="s">rtl/top.v</span><span class="sh">"</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="sh">"</span><span class="s">original</span><span class="sh">"</span><span class="p">,</span> <span class="n">ensure_trailing_newline</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Validation:</strong> This usage pattern prevents any accidental mixing of storage forms. Every operation goes through one API, keeping the project consistent. ✅</p>

<hr />

<h2 id="why-this-will-hold-up-on-bigger-needs">Why this will hold up on bigger needs</h2>

<ul>
  <li>
    <p><strong>Round-trip safety:</strong> We track original newline style and encoding; callers can enforce a project-wide style by always passing <code class="language-plaintext highlighter-rouge">newline="lf"</code> if desired.</p>
  </li>
  <li>
    <p><strong>Performance:</strong> Internal <code class="language-plaintext highlighter-rouge">str</code>, lazy line cache, optional in-place edits.</p>
  </li>
  <li>
    <p><strong>Extensibility:</strong> Add richer transforms (comment stripping, lightweight <code class="language-plaintext highlighter-rouge">\</code>line continuation` merges, macro stubs) without changing the core.</p>
  </li>
  <li>
    <p><strong>Determinism:</strong> No auto encoding detection; configs drive output style.</p>
  </li>
</ul>

<hr />

<h3 id="optional-next-steps-if-you-want-them">Optional next steps (if you want them)</h3>

<ul>
  <li>
    <p>Add a <code class="language-plaintext highlighter-rouge">LineIndex</code> helper for O(1) char-offset ↔ line/col mapping.</p>
  </li>
  <li>
    <p>Provide <code class="language-plaintext highlighter-rouge">diff(other)</code> to aid review bots.</p>
  </li>
  <li>
    <p>Introduce a config object (encoding/newline policy) to thread through I/O.</p>
  </li>
</ul>

<p>If you share any project constraints (e.g., must always emit LF, or enforce final newline), I can wire them into defaults so every team member gets the same behavior automatically.</p>

<p class="chat--user">

보다보니 굳이 VerilogSource에 한정될 필요는 없는거 같은데 범용적인 방법 추천있어?

</p>

<p>아주 좋아요—Verilog 전용이 아니라 <strong>언어 무관(Text-agnostic)</strong> 하게 쓰면 팀 전체에 더 깔끔합니다. 아래처럼 일반화하죠.</p>

<h3 id="체크리스트-개념-위주">체크리스트 (개념 위주)</h3>

<ul>
  <li>
    <p>하나의 <strong>범용 텍스트 컨테이너</strong> 로 표준화하고, 내부 표현은 단일 규칙(LF)로 고정</p>
  </li>
  <li>
    <p><strong>프로필(언어/포맷 메타데이터)</strong> 레이어로 주석/확장자 등만 바꿔 끼우기</p>
  </li>
  <li>
    <p><strong>일관된 뷰 API</strong>(문자열/줄 리스트)만 노출, 저장 형식은 1개</p>
  </li>
  <li>
    <p><strong>변환 파이프라인</strong>(transformer: <code class="language-plaintext highlighter-rouge">text -&gt; text</code>)과 기록(히스토리) 제공</p>
  </li>
  <li>
    <p><strong>불변 편집 기본 + 선택적 in-place</strong> , 캐시/버전 관리</p>
  </li>
  <li>
    <p>명시적 <strong>I/O 정책</strong>(인코딩/개행 방침)과 라운드트립 보장</p>
  </li>
</ul>

<hr />

<h2 id="설계-스텝각-스텝마다-빠른-검증-포함">설계 스텝(각 스텝마다 빠른 검증 포함)</h2>

<ol>
  <li>
    <p><strong>범용 컨테이너 =<code class="language-plaintext highlighter-rouge">TextBuffer</code> (내부 LF 문자열 1개만 저장)</strong></p>

    <ul>
      <li>
        <p><em>이유:</em> 상태가 하나면 표현 불일치가 사라짐.</p>
      </li>
      <li>
        <p><em>검증:</em> 프로젝트 일관성(✅) / 다른 언어로 확장 쉬움(✅).</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>메타데이터/프로필(<code class="language-plaintext highlighter-rouge">TextProfile</code>) 분리</strong></p>

    <ul>
      <li>
        <p>이름, 대표 확장자, 주석 마커 등은 “설명”일 뿐, 동작은 동일.</p>
      </li>
      <li>
        <p><em>검증:</em> 텍스트 코어는 같고, 언어별 규칙은 얹기만 함 → 확장성(✅).</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>뷰 API =<code class="language-plaintext highlighter-rouge">as_string(newline=...)</code>, <code class="language-plaintext highlighter-rouge">as_lines(keepends=...)</code></strong></p>

    <ul>
      <li>
        <p>저장은 1종, 뷰만 여러 형태로 “보여주기”.</p>
      </li>
      <li>
        <p><em>검증:</em> 코드베이스에서 혼용 방지(✅). 새 뷰 추가 시 내부는 그대로(✅).</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>개행 정책과 라운드트립</strong></p>

    <ul>
      <li>
        <p>로드 시 CRLF/혼합 감지 → 내부 LF로 정규화 + “원래 스타일” 메타 보존.</p>
      </li>
      <li>
        <p>저장 시 <code class="language-plaintext highlighter-rouge">original|lf|crlf</code> 선택, <code class="language-plaintext highlighter-rouge">ensure_trailing_newline</code> 옵션 제공.</p>
      </li>
      <li>
        <p><em>검증:</em> 재현성/예측가능성(✅). <em>혼합</em> 은 완전 복원 불가 → 정책상 LF로 내보내기(합리적 셀프코렉트).</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>변환 파이프라인 + 역사(sha1)</strong></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">apply(transformer)</code>로 조합 가능; 이름/해시 기록.</p>
      </li>
      <li>
        <p><em>검증:</em> 단계적 전/후처리의 표준 통로(✅). 원인 추적 용이(✅).</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>편집 모델: 불변 기본 +<code class="language-plaintext highlighter-rouge">in_place=True</code></strong></p>

    <ul>
      <li>
        <p>안전한 기본값, 고성능 경로 필요 시 명시적 사용.</p>
      </li>
      <li>
        <p><em>검증:</em> 안전/성능 균형(✅). 캐시 무효화 한 곳에서 관리(✅).</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>I/O 경계는 명시적</strong></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">from_*</code>/<code class="language-plaintext highlighter-rouge">to_file(encoding,newline)</code>에서만 환경 영향을 받도록.</p>
      </li>
      <li>
        <p><em>검증:</em> CI/OS 차이 최소화(✅).</p>
      </li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="범용-구현-스켈레톤-python">범용 구현 스켈레톤 (Python)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">import</span> <span class="n">hashlib</span><span class="p">,</span> <span class="n">time</span>

<span class="c1"># ---- Profiles (언어/포맷 설명용 메타) ----
</span><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TextProfile</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">plain</span><span class="sh">"</span>
    <span class="n">file_exts</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">...]</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">line_comment_markers</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">...]</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">block_comment_markers</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="p">...]</span> <span class="o">=</span> <span class="p">()</span>

<span class="c1"># 예시 프로필
</span><span class="n">VERILOG</span> <span class="o">=</span> <span class="nc">TextProfile</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">verilog</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">file_exts</span><span class="o">=</span><span class="p">(</span><span class="sh">"</span><span class="s">.v</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">.sv</span><span class="sh">"</span><span class="p">),</span>
    <span class="n">line_comment_markers</span><span class="o">=</span><span class="p">(</span><span class="sh">"</span><span class="s">//</span><span class="sh">"</span><span class="p">,),</span>
    <span class="n">block_comment_markers</span><span class="o">=</span><span class="p">((</span><span class="sh">"</span><span class="s">/*</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">*/</span><span class="sh">"</span><span class="p">),),</span>
<span class="p">)</span>
<span class="n">PYTHON</span> <span class="o">=</span> <span class="nc">TextProfile</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">file_exts</span><span class="o">=</span><span class="p">(</span><span class="sh">"</span><span class="s">.py</span><span class="sh">"</span><span class="p">,),</span>
    <span class="n">line_comment_markers</span><span class="o">=</span><span class="p">(</span><span class="sh">"</span><span class="s">#</span><span class="sh">"</span><span class="p">,),</span>
<span class="p">)</span>

<span class="n">NewlineStyle</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">lf</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">crlf</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">mixed</span><span class="sh">"</span><span class="p">]</span>
<span class="n">EmitNewline</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">original</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">lf</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">crlf</span><span class="sh">"</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">TextTransformer</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="bp">...</span>

<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TransformRecord</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">before_sha1</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">after_sha1</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nf">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">TextBuffer</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    범용 텍스트 컨테이너(언어-무관).
    내부 규칙:
      - _text 는 항상 LF(</span><span class="sh">'</span><span class="se">\\</span><span class="s">n</span><span class="sh">'</span><span class="s">)로 정규화된 단일 문자열
      - 원본 개행 스타일/인코딩/경로/프로필을 메타로 보관
      - 불변 편집 기본, in_place=True로 명시적 변경 가능
    </span><span class="sh">"""</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">_text</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">_newline_style</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">_encoding</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">_source_path</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">_profile</span><span class="sh">"</span><span class="p">,</span>
                 <span class="sh">"</span><span class="s">_version</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">_cached_lines</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">_cached_lines_keepends</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">_history</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">profile</span><span class="p">:</span> <span class="n">TextProfile</span> <span class="o">=</span> <span class="nc">TextProfile</span><span class="p">(),</span>
        <span class="n">newline_style</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NewlineStyle</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">source_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">_assume_normalized</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_assume_normalized</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">text</span>
            <span class="n">style</span> <span class="o">=</span> <span class="n">newline_style</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">lf</span><span class="sh">"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">norm</span><span class="p">,</span> <span class="n">style</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_normalize_newlines</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_text</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">norm</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_newline_style</span><span class="p">:</span> <span class="n">NewlineStyle</span> <span class="o">=</span> <span class="n">style</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">encoding</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_source_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">source_path</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_profile</span><span class="p">:</span> <span class="n">TextProfile</span> <span class="o">=</span> <span class="n">profile</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cached_lines</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cached_lines_keepends</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_history</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TransformRecord</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># ---------- constructors / I-O ----------
</span>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_string</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">profile</span><span class="p">:</span> <span class="n">TextProfile</span> <span class="o">=</span> <span class="nc">TextProfile</span><span class="p">(),</span>
                    <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">source_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">TextBuffer</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">cls</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="n">profile</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span> <span class="n">source_path</span><span class="o">=</span><span class="n">source_path</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_lines</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">lines</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">keepends</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                   <span class="n">profile</span><span class="p">:</span> <span class="n">TextProfile</span> <span class="o">=</span> <span class="nc">TextProfile</span><span class="p">(),</span> <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
                   <span class="n">source_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">TextBuffer</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">joined</span> <span class="o">=</span> <span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="k">if</span> <span class="n">keepends</span> <span class="k">else</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">cls</span><span class="p">(</span><span class="n">joined</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="n">profile</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span> <span class="n">source_path</span><span class="o">=</span><span class="n">source_path</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">profile</span><span class="p">:</span> <span class="n">TextProfile</span> <span class="o">=</span> <span class="nc">TextProfile</span><span class="p">(),</span>
                  <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">TextBuffer</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">cls</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="n">profile</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span> <span class="n">source_path</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_file</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">encoding</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                <span class="n">newline</span><span class="p">:</span> <span class="n">EmitNewline</span> <span class="o">=</span> <span class="sh">"</span><span class="s">original</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">ensure_trailing_newline</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">as_string</span><span class="p">(</span><span class="n">newline</span><span class="o">=</span><span class="n">newline</span><span class="p">,</span> <span class="n">ensure_trailing_newline</span><span class="o">=</span><span class="n">ensure_trailing_newline</span><span class="p">)</span>
        <span class="n">p</span><span class="p">.</span><span class="nf">write_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="n">_encoding</span><span class="p">)</span>

    <span class="c1"># ---------- views ----------
</span>    <span class="k">def</span> <span class="nf">as_string</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">newline</span><span class="p">:</span> <span class="n">EmitNewline</span> <span class="o">=</span> <span class="sh">"</span><span class="s">original</span><span class="sh">"</span><span class="p">,</span>
                  <span class="n">ensure_trailing_newline</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_text</span>
        <span class="k">if</span> <span class="n">ensure_trailing_newline</span> <span class="ow">is</span> <span class="bp">True</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span>
        <span class="k">if</span> <span class="n">ensure_trailing_newline</span> <span class="ow">is</span> <span class="bp">False</span> <span class="ow">and</span> <span class="n">s</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">style</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_newline_style</span> <span class="k">if</span> <span class="n">newline</span> <span class="o">==</span> <span class="sh">"</span><span class="s">original</span><span class="sh">"</span> <span class="k">else</span> <span class="p">{</span><span class="sh">"</span><span class="s">lf</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">lf</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">crlf</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">crlf</span><span class="sh">"</span><span class="p">}[</span><span class="n">newline</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="sh">"</span><span class="s">lf</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span>
        <span class="k">elif</span> <span class="n">style</span> <span class="o">==</span> <span class="sh">"</span><span class="s">crlf</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="se">\r\n</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># mixed는 정확 복원이 불가 → 정책상 LF로 내보냄
</span>            <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">as_lines</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">keepends</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">keepends</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_cached_lines_keepends</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_cached_lines_keepends</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_text</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_cached_lines_keepends</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_cached_lines</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_cached_lines</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_text</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_cached_lines</span><span class="p">)</span>

    <span class="c1"># ---------- inspection ----------
</span>    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TextProfile</span><span class="p">:</span> <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_profile</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">source_path</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span> <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_source_path</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">newline_style</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NewlineStyle</span><span class="p">:</span> <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_newline_style</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">encoding</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_encoding</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span> <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_version</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">history</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">TransformRecord</span><span class="p">,</span> <span class="p">...]:</span> <span class="k">return</span> <span class="nf">tuple</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_history</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">line_count</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span> <span class="k">return</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">as_lines</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">get_line</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">keepend</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">as_lines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="n">keepend</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span>

    <span class="c1"># ---------- edits / transforms ----------
</span>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">transformer</span><span class="p">:</span> <span class="n">TextTransformer</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">in_place</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
              <span class="n">record</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">TextBuffer</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">before</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_text</span>
        <span class="n">after</span> <span class="o">=</span> <span class="nf">transformer</span><span class="p">(</span><span class="n">before</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">after</span> <span class="ow">is</span> <span class="n">before</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">in_place</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nf">_bump_version</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">self</span>
        <span class="k">if</span> <span class="n">in_place</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_set_text</span><span class="p">(</span><span class="n">after</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">record</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nf">_record</span><span class="p">(</span><span class="n">transformer</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inst</span> <span class="o">=</span> <span class="nc">TextBuffer</span><span class="p">(</span><span class="n">after</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_profile</span><span class="p">,</span> <span class="n">newline_style</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_newline_style</span><span class="p">,</span>
                              <span class="n">encoding</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_encoding</span><span class="p">,</span> <span class="n">source_path</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_source_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">record</span><span class="p">:</span> <span class="n">inst</span><span class="p">.</span><span class="n">_history</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">self</span><span class="p">.</span><span class="n">_history</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="nf">_mk_record</span><span class="p">(</span><span class="n">transformer</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">)]</span>
            <span class="k">return</span> <span class="n">inst</span>

    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">old</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">in_place</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">TextBuffer</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">class</span> <span class="nc">_Repl</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span>
            <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="k">return</span> <span class="n">text</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="nf">_Repl</span><span class="p">(),</span> <span class="n">in_place</span><span class="o">=</span><span class="n">in_place</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_line</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">keepend</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                 <span class="n">in_place</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">TextBuffer</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">as_lines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keepend</span><span class="p">:</span>
            <span class="n">lines</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eol</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="k">if</span> <span class="n">lines</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="sh">""</span>
            <span class="n">lines</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span> <span class="o">+</span> <span class="n">eol</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">_with_text</span><span class="p">(</span><span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="n">in_place</span><span class="o">=</span><span class="n">in_place</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">insert_lines</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">new_lines</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">keepends</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                     <span class="n">in_place</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">TextBuffer</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">nl</span> <span class="o">=</span> <span class="p">[</span><span class="n">ln</span> <span class="k">if</span> <span class="n">keepends</span> <span class="nf">else </span><span class="p">(</span><span class="n">ln</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span> <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">new_lines</span><span class="p">]</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">as_lines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">_with_text</span><span class="p">(</span><span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[:</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">nl</span> <span class="o">+</span> <span class="n">lines</span><span class="p">[</span><span class="n">idx</span><span class="p">:]),</span> <span class="n">in_place</span><span class="o">=</span><span class="n">in_place</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">delete_lines</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">in_place</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">TextBuffer</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">as_lines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">_with_text</span><span class="p">(</span><span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[:</span><span class="n">start</span><span class="p">]</span> <span class="o">+</span> <span class="n">lines</span><span class="p">[</span><span class="n">end</span><span class="p">:]),</span> <span class="n">in_place</span><span class="o">=</span><span class="n">in_place</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ensure_trailing_newline</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">in_place</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">TextBuffer</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span> <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_text</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="n">self</span><span class="p">.</span><span class="nf">_with_text</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_text</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">in_place</span><span class="o">=</span><span class="n">in_place</span><span class="p">)</span>

    <span class="c1"># ---------- internals ----------
</span>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_normalize_newlines</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">NewlineStyle</span><span class="p">]:</span>
        <span class="n">has_crlf</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\r\n</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">text</span>
        <span class="n">has_lf</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">text</span>
        <span class="k">if</span> <span class="n">has_crlf</span> <span class="ow">and</span> <span class="n">has_lf</span> <span class="ow">and</span> <span class="n">text</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="se">\r\n</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span> <span class="o">!=</span> <span class="n">text</span><span class="p">:</span> <span class="n">style</span><span class="p">:</span> <span class="n">NewlineStyle</span> <span class="o">=</span> <span class="sh">"</span><span class="s">mixed</span><span class="sh">"</span>
        <span class="k">elif</span> <span class="n">has_crlf</span><span class="p">:</span> <span class="n">style</span> <span class="o">=</span> <span class="sh">"</span><span class="s">crlf</span><span class="sh">"</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">style</span> <span class="o">=</span> <span class="sh">"</span><span class="s">lf</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">text</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="se">\r\n</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">).</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="se">\r</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">),</span> <span class="n">style</span>

    <span class="k">def</span> <span class="nf">_with_text</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">new_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">in_place</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">TextBuffer</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">in_place</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_set_text</span><span class="p">(</span><span class="n">new_text</span><span class="p">);</span> <span class="k">return</span> <span class="n">self</span>
        <span class="n">inst</span> <span class="o">=</span> <span class="nc">TextBuffer</span><span class="p">(</span><span class="n">new_text</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_profile</span><span class="p">,</span> <span class="n">newline_style</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_newline_style</span><span class="p">,</span>
                          <span class="n">encoding</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_encoding</span><span class="p">,</span> <span class="n">source_path</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_source_path</span><span class="p">,</span> <span class="n">_assume_normalized</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">inst</span><span class="p">.</span><span class="n">_history</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_history</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inst</span>

    <span class="k">def</span> <span class="nf">_set_text</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">new_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_text</span> <span class="o">=</span> <span class="n">new_text</span><span class="p">;</span> <span class="n">self</span><span class="p">.</span><span class="nf">_invalidate_cache</span><span class="p">();</span> <span class="n">self</span><span class="p">.</span><span class="nf">_bump_version</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_invalidate_cache</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cached_lines</span> <span class="o">=</span> <span class="bp">None</span><span class="p">;</span> <span class="n">self</span><span class="p">.</span><span class="n">_cached_lines_keepends</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_bump_version</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">_version</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_mk_record</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">before</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">after</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransformRecord</span><span class="p">:</span>
        <span class="k">return</span> <span class="nc">TransformRecord</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">before_sha1</span><span class="o">=</span><span class="n">hashlib</span><span class="p">.</span><span class="nf">sha1</span><span class="p">(</span><span class="n">before</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)).</span><span class="nf">hexdigest</span><span class="p">(),</span>
            <span class="n">after_sha1</span><span class="o">=</span><span class="n">hashlib</span><span class="p">.</span><span class="nf">sha1</span><span class="p">(</span><span class="n">after</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)).</span><span class="nf">hexdigest</span><span class="p">(),</span>
        <span class="p">)</span>
    <span class="k">def</span> <span class="nf">_record</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">before</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">after</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_history</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_mk_record</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">))</span>
</code></pre></div></div>

<p><strong>검증 요약:</strong> 내부 저장 1종(LF), 뷰 API 고정, 변환/편집/히스토리 표준화 → <strong>일관성</strong> 과 <strong>확장성</strong> 목표에 부합(✅). <em>혼합 개행 복원 한계</em> 는 정책으로 명시하여 팀 혼선을 차단(셀프코렉트 완료).</p>

<hr />

<h2 id="사용-예-언어-불문">사용 예 (언어 불문)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Verilog도 Python도 동일한 API
</span><span class="n">buf</span> <span class="o">=</span> <span class="n">TextBuffer</span><span class="p">.</span><span class="nf">from_file</span><span class="p">(</span><span class="sh">"</span><span class="s">rtl/top.v</span><span class="sh">"</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="n">VERILOG</span><span class="p">)</span>

<span class="c1"># 일관된 뷰
</span><span class="n">text</span> <span class="o">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">as_string</span><span class="p">()</span>
<span class="n">lines</span> <span class="o">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">as_lines</span><span class="p">()</span>
<span class="n">lines_ke</span> <span class="o">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">as_lines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># 불변 편집 + 파이프라인
</span><span class="k">class</span> <span class="nc">TrimTrailingWS</span><span class="p">:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="sh">"</span><span class="s">trim_trailing_ws</span><span class="sh">"</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="nf">rstrip</span><span class="p">(</span><span class="sh">"</span><span class="s"> </span><span class="se">\t</span><span class="sh">"</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">t</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">())</span>

<span class="n">buf2</span> <span class="o">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">set_line</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="sh">"</span><span class="s">// AUTOGEN: do not edit</span><span class="sh">"</span><span class="p">)</span>
<span class="n">buf3</span> <span class="o">=</span> <span class="n">buf2</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="nc">TrimTrailingWS</span><span class="p">())</span>
<span class="n">buf3</span><span class="p">.</span><span class="nf">to_file</span><span class="p">(</span><span class="sh">"</span><span class="s">rtl/top.v</span><span class="sh">"</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="sh">"</span><span class="s">original</span><span class="sh">"</span><span class="p">,</span> <span class="n">ensure_trailing_newline</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="verilog-전용-api가-필요하면">Verilog 전용 API가 필요하면?</h2>

<ul>
  <li><code class="language-plaintext highlighter-rouge">VerilogSource = TextBuffer</code>에 <code class="language-plaintext highlighter-rouge">profile=VERILOG</code>만 기본값으로 래핑(또는 서브클래싱)하면 됩니다. 코드베이스는 <strong>항상<code class="language-plaintext highlighter-rouge">TextBuffer</code> API</strong>만 사용하므로 혼용이 사라집니다.</li>
</ul>

<hr />

<h2 id="권장-정책팀-규칙으로-고정-추천">권장 정책(팀 규칙으로 고정 추천)</h2>

<ul>
  <li>
    <p>저장 시 기본 <code class="language-plaintext highlighter-rouge">newline="original"</code>(레거시 유지) → 리포맷 단계에서 일괄 <code class="language-plaintext highlighter-rouge">lf</code> 전환 선택 가능.</p>
  </li>
  <li>
    <p>모든 변환은 <strong>Transformer</strong> 로만 수행(직접 문자열 조작 금지).</p>
  </li>
  <li>
    <p>CI에 <code class="language-plaintext highlighter-rouge">ensure_trailing_newline=True</code> + <code class="language-plaintext highlighter-rouge">TrimTrailingWS</code> 적용.</p>
  </li>
</ul>

<p>필요하면 토큰화나 라인-오프셋 매핑, <code class="language-plaintext highlighter-rouge">diff(other)</code> 같은 유틸을 얹을 수 있게 설계해 두었습니다. 원하는 기본 프로필(Verilog/Lex/YAML 등) 목록을 알려주시면 템플릿으로 함께 추가해 드릴게요.</p>

<p class="chat--user">

이런 일을 하는 유명한 클래스나 파이썬 내장은 없어?

</p>

<p>다음 순서로 생각해볼게요 (개념 체크리스트):</p>

<ul>
  <li>
    <p>표준 라이브러리에 “그 일을 전부” 하는 <strong>단일 클래스는 없다</strong> → 조합해서 써야 함.</p>
  </li>
  <li>
    <p>가장 가까운 <strong>표준 도구들</strong> 이 무엇인지 파악하고, 무엇이 <strong>부족</strong> 한지 명확히 하기.</p>
  </li>
  <li>
    <p>부족한 부분(개행 추적·일관된 뷰·변환 파이프라인)은 <strong>얇은 래퍼</strong> 로 보완.</p>
  </li>
  <li>
    <p>최소주의 버전(함수 2–3개)과 확장형(클래스) 중 팀 정책에 맞게 선택.</p>
  </li>
</ul>

<hr />

<h2 id="짧은-결론">짧은 결론</h2>

<ul>
  <li><strong>표준/유명 내장에 “텍스트 컨테이너 + 개행 정책 + 변환/히스토리”를 한 번에 제공하는 건 없습니다.</strong><br />
따라서 지금까지 제안한 <code class="language-plaintext highlighter-rouge">TextBuffer</code> 같은 얇은 래퍼가 <strong>일관성</strong> 과 <strong>라운드트립 보장</strong> 면에서 가장 현실적입니다.<br />
<em>검증:</em> 팀 전역 일관성과 확장성 목표에 부합. ✅</li>
</ul>

<hr />

<h2 id="가장-가까운-표준-도구들무엇을-해주고못-해주는가">가장 가까운 표준 도구들(무엇을 해주고/못 해주는가)</h2>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">io.StringIO</code><br />
메모리 파일 객체. 줄 단위 읽기/쓰기 쉽지만 <strong>원본 개행 스타일 추적 X</strong> , 변환/히스토리 X.<br />
<em>검증:</em> “일관된 내부 표현” 요구에 미달 → 래퍼 필요. ❌</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">open(..., newline=...)</code> / <code class="language-plaintext highlighter-rouge">pathlib.Path.read_text()/write_text()</code><br />
텍스트 모드에서 <strong>개행 변환을 제어</strong>(쓰기 시 <code class="language-plaintext highlighter-rouge">newline='\n'</code> 강제 등) 가능. 하지만 <strong>읽을 때 원본이 CRLF/혼합이었는지</strong> 를 보존하진 않음(보통 <code class="language-plaintext highlighter-rouge">\n</code>으로 흡수).<br />
<em>검증:</em> 라운드트립용 “원래 개행 스타일” 메타 보존이 없다 → 래퍼 필요. ❌</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">fileinput</code><br />
여러 파일을 한 줄 스트림처럼 순회. <strong>컨테이너 아님</strong> , 상태/뷰/히스토리 X. ❌</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">difflib</code><br />
차이 계산·패치 출력을 도와줌. <strong>변환 파이프라인/저장소</strong> 는 아님. 보조 도구로는 유용. 🆗</p>
  </li>
  <li>
    <p>(<code class="language-plaintext highlighter-rouge">tokenize</code>, <code class="language-plaintext highlighter-rouge">ast</code>, <code class="language-plaintext highlighter-rouge">parso</code> 등)<br />
언어별 파서/토크나이저. “구문 인지 변환”에는 좋지만 <strong>범용 텍스트 컨테이너 역할</strong> 은 아님. 보조. 🆗</p>
  </li>
</ul>

<blockquote>
  <p>요약: <strong>조각들은 있지만, “일관 컨테이너 + 개행 정책 + 변환/히스토리” 조합은 직접 얇게 감싸야</strong> 합니다.</p>
</blockquote>

<hr />

<h2 id="최소주의-대안클래스-없이-함수-3개로">최소주의 대안(클래스 없이 함수 3개로)</h2>

<p>클래스가 부담이면, 팀 규칙을 함수로 고정하세요.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="k">def</span> <span class="nf">detect_newline_style</span><span class="p">(</span><span class="n">raw</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>  <span class="c1"># "lf" | "crlf" | "mixed"
</span>    <span class="n">crlf</span> <span class="o">=</span> <span class="n">raw</span><span class="p">.</span><span class="nf">count</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="se">\r\n</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">lf</span> <span class="o">=</span> <span class="n">raw</span><span class="p">.</span><span class="nf">count</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">cr</span> <span class="o">=</span> <span class="n">raw</span><span class="p">.</span><span class="nf">count</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="se">\r</span><span class="sh">"</span><span class="p">)</span> <span class="o">-</span> <span class="n">crlf</span>
    <span class="nf">if </span><span class="p">(</span><span class="n">crlf</span> <span class="ow">and</span> <span class="p">(</span><span class="n">lf</span> <span class="o">-</span> <span class="n">crlf</span><span class="p">))</span> <span class="ow">or</span> <span class="n">cr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 서로 섞여 있으면 mixed
</span>        <span class="k">return</span> <span class="sh">"</span><span class="s">mixed</span><span class="sh">"</span>
    <span class="k">return</span> <span class="sh">"</span><span class="s">crlf</span><span class="sh">"</span> <span class="k">if</span> <span class="n">crlf</span> <span class="k">else</span> <span class="sh">"</span><span class="s">lf</span><span class="sh">"</span>

<span class="k">def</span> <span class="nf">normalize_to_lf</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="se">\r\n</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">).</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="se">\r</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">emit_with_newline</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">style</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">s</span> <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="sh">"</span><span class="s">lf</span><span class="sh">"</span> <span class="k">else</span> <span class="n">s</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="se">\r\n</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># mixed는 정책상 lf 취급 권장
</span></code></pre></div></div>

<p>사용 패턴:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">raw</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">p</span><span class="p">).</span><span class="nf">read_bytes</span><span class="p">()</span>
<span class="n">style</span> <span class="o">=</span> <span class="nf">detect_newline_style</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>          <span class="c1"># 원본 스타일 메타
</span><span class="n">text</span> <span class="o">=</span> <span class="nf">normalize_to_lf</span><span class="p">(</span><span class="n">raw</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">))</span>
<span class="n">lines</span> <span class="o">=</span> <span class="n">text</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">()</span>                  <span class="c1"># 필요한 뷰
</span><span class="n">out</span> <span class="o">=</span> <span class="nf">emit_with_newline</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>       <span class="c1"># 저장 시 라운드트립
</span></code></pre></div></div>

<ul>
  <li><em>검증:</em> “단일 내부 표현(LF 문자열) + 원본 개행 메타 보존”을 만족. 변환 파이프라인/히스토리는 여전히 없으므로, 필요 시 클래스로 승격. ✅</li>
</ul>

<hr />

<h2 id="언제-표준만으로-충분하고-언제-래퍼가-필요한가">언제 표준만으로 충분하고, 언제 래퍼가 필요한가</h2>

<ul>
  <li>
    <p><strong>충분한 경우:</strong> 단순 읽기/쓰기 + 포맷터(예: pre-commit 훅으로 trailing space 제거, EOF newline 강제). 변환 기록/뷰 일관성이 크게 중요치 않을 때.</p>
  </li>
  <li>
    <p><strong>래퍼 필요:</strong></p>

    <ul>
      <li>
        <p>라운드트립 정확도(원본 개행 정책 유지)가 중요</p>
      </li>
      <li>
        <p>코드베이스에서 “문자열/lines 혼용”을 금지하고 <strong>한 API로 통일</strong> 하고 싶을 때</p>
      </li>
      <li>
        <p>전/후처리를 <strong>파이프라인 + 히스토리</strong> 로 관리하고 싶을 때</p>
      </li>
    </ul>
  </li>
</ul>

<p><em>검증:</em> 우리 요구사항(일관성·확장성·라운드트립) 기준으로는 래퍼가 맞음. ✅</p>

<hr />

<h2 id="참고서드파티-조합-아이디어">참고(서드파티 조합 아이디어)</h2>

<ul>
  <li>
    <p><strong>pre-commit / pre-commit-hooks</strong> : <code class="language-plaintext highlighter-rouge">end-of-file-fixer</code>, <code class="language-plaintext highlighter-rouge">trailing-whitespace</code>, <code class="language-plaintext highlighter-rouge">mixed-line-ending</code> 등으로 저장소 수준 위생 관리.<br />
<em>역할 보완:</em> 파이프라인 일부를 CI로 밀어내 일관성 강화. ✅</p>
  </li>
  <li>
    <p><strong>difflib / unidiff</strong> : 변환 결과를 리뷰하기 쉬운 패치로 제시.<br />
<em>역할 보완:</em> 팀 리뷰 경험 개선. ✅</p>
  </li>
</ul>

<hr />

<h3 id="정리">정리</h3>

<ul>
  <li>
    <p>“그 일을 전부 하는” 유명 내장/클래스는 없음.</p>
  </li>
  <li>
    <p>표준 도구(특히 <code class="language-plaintext highlighter-rouge">open/newline</code>, <code class="language-plaintext highlighter-rouge">Path.write_text(newline=...)</code>)는 <strong>출력 정책 강제</strong> 에는 충분하나, <strong>원본 개행 추적/일관 뷰/히스토리</strong> 는 커버하지 못함.</p>
  </li>
  <li>
    <p>팀 차원의 일관성과 확장성을 원하면, 지금 설계한 <strong>얇은 범용 래퍼</strong>(또는 위의 <strong>함수 3개 + 규칙</strong>)가 가장 안전합니다.</p>
  </li>
</ul>

<p class="chat--user">

@classmethod def from_file(cls, path: Path | str, *, profile: TextProfile = TextProfile(), encoding: str = "utf-8") -&gt; "TextBuffer": p = Path(path) text = p.read_text(encoding=encoding) return cls(text, profile=profile, encoding=encoding, source_path=p) 여기 중간에 있는 * 은 뭐야? 이런 문법 처음봐

</p>

<p>짧게 체크리스트:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">*</code> 는 <strong>키워드 전용(Keyword-only) 인자 구분자</strong> 예요.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">*</code> 뒤에 나오는 파라미터는 <strong>반드시<code class="language-plaintext highlighter-rouge">name=value</code> 형태로</strong> 호출해야 해요.</p>
  </li>
  <li>
    <p>목적: <strong>가독성↑</strong> , <strong>실수 방지</strong>(순서 착각), <strong>API 확장성</strong>(새 옵션 추가해도 안전).</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">*</code> 자체는 <code class="language-plaintext highlighter-rouge">*args</code>와 다릅니다(수집 아님, <strong>구분자</strong> 일 뿐).</p>
  </li>
</ul>

<hr />

<h3 id="한-줄-요약">한 줄 요약</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">profile</span><span class="p">:</span> <span class="n">TextProfile</span> <span class="o">=</span> <span class="nc">TextProfile</span><span class="p">(),</span>
              <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">TextBuffer</span><span class="sh">"</span><span class="p">:</span>
</code></pre></div></div>

<p>여기 가운데 <code class="language-plaintext highlighter-rouge">*</code> 때문에 <code class="language-plaintext highlighter-rouge">profile</code>과 <code class="language-plaintext highlighter-rouge">encoding</code>은 <strong>키워드로만</strong> 넘길 수 있습니다.</p>

<ul>
  <li>✅ 올바른 호출:
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">TextBuffer</span><span class="p">.</span><span class="nf">from_file</span><span class="p">(</span><span class="sh">"</span><span class="s">rtl/top.v</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># 기본값 사용
</span><span class="n">TextBuffer</span><span class="p">.</span><span class="nf">from_file</span><span class="p">(</span><span class="sh">"</span><span class="s">rtl/top.v</span><span class="sh">"</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="n">VERILOG</span><span class="p">)</span>
<span class="n">TextBuffer</span><span class="p">.</span><span class="nf">from_file</span><span class="p">(</span><span class="sh">"</span><span class="s">rtl/top.v</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-16</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li>❌ 잘못된 호출(순서로 넘김):
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">TextBuffer</span><span class="p">.</span><span class="nf">from_file</span><span class="p">(</span><span class="sh">"</span><span class="s">rtl/top.v</span><span class="sh">"</span><span class="p">,</span> <span class="n">VERILOG</span><span class="p">)</span>
<span class="c1"># TypeError: ... takes 2 positional arguments but 3 were given
</span></code></pre></div>    </div>
  </li>
</ul>

<hr />

<h3 id="왜-쓰나요-step-by-step-사고">왜 쓰나요? (step-by-step 사고)</h3>

<ol>
  <li>
    <p><strong>의미가 분명해집니다.</strong><br />
<code class="language-plaintext highlighter-rouge">profile=VERILOG</code> 처럼 이름이 보이니, 인자 의미를 헷갈릴 일이 줄어요.<br />
→ 프로젝트 <strong>일관성</strong> 목표에 부합. ✅</p>
  </li>
  <li>
    <p><strong>파라미터 순서 변경에 강합니다.</strong><br />
나중에 옵션을 더 추가해도 기존 호출부는 <code class="language-plaintext highlighter-rouge">name=value</code>라 <strong>깨지지 않음</strong>.<br />
→ API <strong>확장성</strong> 목표에 부합. ✅</p>
  </li>
  <li>
    <p><strong>실수 방지.</strong><br />
<code class="language-plaintext highlighter-rouge">profile</code>과 <code class="language-plaintext highlighter-rouge">encoding</code>을 순서로 바꿔 넣는 실수를 차단. ✅</p>
  </li>
</ol>

<hr />

<h3 id="-와-args-의-차이"><code class="language-plaintext highlighter-rouge">*</code> 와 <code class="language-plaintext highlighter-rouge">*args</code> 의 차이</h3>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">*</code> (단독): <strong>구분자</strong>. 뒤의 인자들을 <strong>키워드 전용</strong> 으로 만듭니다.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">*args</code>: 남는 위치 인자들을 <strong>튜플로 수집</strong> 합니다. (수집 + 구분자 역할 모두)</p>
  </li>
</ul>

<p>예:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>         <span class="c1"># b, c는 키워드-only
</span>    <span class="bp">...</span>

<span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="c1"># a는 위치, args는 추가 위치들 수집, b는 키워드-only
</span>    <span class="bp">...</span>
</code></pre></div></div>

<hr />

<h3 id="보너스--positional-only-도-있어요">보너스: <code class="language-plaintext highlighter-rouge">/</code> (positional-only) 도 있어요</h3>

<p>Python 3.8+ 부터는 <code class="language-plaintext highlighter-rouge">/</code> 로 <strong>위치 전용</strong> 인자를 강제할 수 있습니다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">h</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>  <span class="c1"># a: 위치-only, b: 둘 다 가능, c: 키워드-only
</span>    <span class="bp">...</span>
</code></pre></div></div>

<hr />

<h3 id="타입-힌트-관련">타입 힌트 관련</h3>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Path | str</code> 는 <strong>Python 3.10+</strong> 의 Union 약식 문법입니다(이전 버전은 <code class="language-plaintext highlighter-rouge">Union[Path, str]</code>).</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">TextProfile()</code> 을 기본값으로 두면 <strong>정의 시점에</strong> 한 번 생성된 인스턴스를 재사용합니다.<br />
여기서는 <code class="language-plaintext highlighter-rouge">@dataclass(frozen=True)</code>라 <strong>불변</strong> 이므로 안전하지만,<br />
일반적으로는 <code class="language-plaintext highlighter-rouge">None</code> 기본값 + 함수 내부에서 생성하는 패턴도 고려하세요.</p>
  </li>
</ul>

<hr />

<p>필요하면, 팀 규칙으로 “옵션 인자는 모두 <code class="language-plaintext highlighter-rouge">*</code> 뒤에 배치”를 정해두면 호출부가 항상 <code class="language-plaintext highlighter-rouge">name=value</code>라 깔끔하고, 장기 유지보수에 유리합니다.</p>

<p class="chat--user">

__slots__는 뭐야?

</p>

<p>짧은 체크리스트(개념):</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">__slots__</code>는 <strong>인스턴스가 가질 수 있는 속성 이름들을 고정</strong> 하는 메커니즘이다.</p>
  </li>
  <li>
    <p>효과: <strong>메모리 절감</strong> , <strong>속성 접근 소폭 빠름</strong> , <strong>오타/임의 속성 추가 방지</strong>.</p>
  </li>
  <li>
    <p>선언: <code class="language-plaintext highlighter-rouge">class C: __slots__ = ('a', 'b')</code> 처럼 <strong>튜플/리스트/이터러블</strong> 에 이름을 나열.</p>
  </li>
  <li>
    <p>주의: <strong>동적 속성 추가 불가</strong> , 상속/디폴트/<code class="language-plaintext highlighter-rouge">__dict__</code>/<code class="language-plaintext highlighter-rouge">__weakref__</code> 처리에 신경.</p>
  </li>
  <li>
    <p>권장 사용: <strong>인스턴스가 아주 많고 필드 스키마가 고정</strong> 된 클래스.</p>
  </li>
</ul>

<hr />

<h1 id="한-줄-정의">한 줄 정의</h1>

<p><code class="language-plaintext highlighter-rouge">__slots__</code>를 정의하면 해당 클래스의 인스턴스는 <strong>per-instance<code class="language-plaintext highlighter-rouge">__dict__</code>를 만들지 않고</strong>, 미리 정해둔 슬롯(고정 필드)만 메모리에 <strong>compact</strong> 하게 저장한다.</p>

<hr />

<h2 id="왜-쓰나-step-by-step">왜 쓰나 (step-by-step)</h2>

<ol>
  <li>
    <p><strong>메모리 절감</strong> : <code class="language-plaintext highlighter-rouge">__dict__</code>(해시맵) 대신 <strong>슬롯 배열</strong> 을 써서 인스턴스당 수십 바이트~수백 바이트를 아낀다(필드 수/파이썬 구현에 따라 상이). 대량 객체(예: 수십만 개)에서 큰 차이.</p>
  </li>
  <li>
    <p><strong>속성 접근 비용 감소</strong> : 해시 조회가 아닌 <strong>오프셋 접근</strong> 이라 약간 빠르다(미세하지만 누적되면 의미).</p>
  </li>
  <li>
    <p><strong>API 안전성</strong> : 선언되지 않은 속성은 설정 자체가 에러 → <strong>오타/임의 필드</strong> 방지.</p>
  </li>
</ol>

<hr />

<h2 id="어떻게-쓰나">어떻게 쓰나</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Node</span><span class="p">:</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">next</span><span class="sh">'</span><span class="p">)</span>  <span class="c1"># 인스턴스 필드 스키마 고정
</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">next</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>   <span class="c1"># OK
</span>        <span class="n">self</span><span class="p">.</span><span class="nb">next</span> <span class="o">=</span> <span class="nb">next</span>     <span class="c1"># OK
</span>
<span class="n">n</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">n</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">2</span>      <span class="c1"># OK
</span><span class="n">n</span><span class="p">.</span><span class="n">other</span> <span class="o">=</span> <span class="mi">3</span>      <span class="c1"># AttributeError: 'Node' object has no attribute 'other'
</span></code></pre></div></div>

<ul>
  <li>
    <p><strong>디폴트값</strong> 은 보통 <code class="language-plaintext highlighter-rouge">__init__</code>에서 채운다.</p>
  </li>
  <li>
    <p>클래스 속성으로 기본값을 주고 싶다면:</p>
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">C</span><span class="p">:</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="sh">'</span><span class="s">a</span><span class="sh">'</span><span class="p">,)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># 모든 인스턴스의 초기 읽기는 10으로 보이지만,
</span>            <span class="c1"># 인스턴스에 a를 설정하면 인스턴스 슬롯 값이 우선한다.
</span></code></pre></div>    </div>
  </li>
</ul>

<hr />

<h2 id="자주-부딪히는-포인트-꼭-알아둘-것">자주 부딪히는 포인트 (꼭 알아둘 것)</h2>

<h3 id="1-__dict__--__weakref__가-필요하면">1) <code class="language-plaintext highlighter-rouge">__dict__</code> / <code class="language-plaintext highlighter-rouge">__weakref__</code>가 필요하면?</h3>

<ul>
  <li>
    <p>기본적으로 <code class="language-plaintext highlighter-rouge">__slots__</code> 클래스에는 <strong>인스턴스<code class="language-plaintext highlighter-rouge">__dict__</code>가 없다</strong>.</p>
  </li>
  <li><strong>예외적으로</strong> 동적 속성을 허용하고 싶다면 슬롯에 <code class="language-plaintext highlighter-rouge">"__dict__"</code>를 명시:
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">C</span><span class="p">:</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="sh">'</span><span class="s">a</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">__dict__</span><span class="sh">'</span><span class="p">)</span>  <span class="c1"># 슬롯 + 동적 속성 허용
</span></code></pre></div>    </div>
  </li>
  <li><code class="language-plaintext highlighter-rouge">weakref</code>를 쓰려면 <code class="language-plaintext highlighter-rouge">"__weakref__"</code>도 포함:
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">C</span><span class="p">:</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="sh">'</span><span class="s">a</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">__weakref__</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="2-상속">2) 상속</h3>

<ul>
  <li>
    <p><strong>슬롯 클래스의 서브클래스</strong> 가 <code class="language-plaintext highlighter-rouge">__slots__</code>를 정의하지 않으면, 서브클래스는 <strong>다시<code class="language-plaintext highlighter-rouge">__dict__</code>가 생긴다</strong>(동적 속성 가능).<br />
→ 계속 제한하고 싶다면 <strong>서브클래스에서도<code class="language-plaintext highlighter-rouge">__slots__</code>를 정의</strong>해야 한다.</p>
  </li>
  <li>
    <p>서브클래스에서 <strong>부모 슬롯 이름을 다시 적지 않는다</strong>. 새로 추가하는 슬롯만 나열:</p>
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Base</span><span class="p">:</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="sh">'</span><span class="s">a</span><span class="sh">'</span><span class="p">,)</span>
    
<span class="k">class</span> <span class="nc">Child</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="sh">'</span><span class="s">b</span><span class="sh">'</span><span class="p">,)</span>  <span class="c1"># 'a'는 이미 Base에 있으므로 중복 기재 X
</span></code></pre></div>    </div>
  </li>
</ul>

<h3 id="3-다중-상속">3) 다중 상속</h3>

<ul>
  <li>
    <p>다중 상속에서 <strong>슬롯이 서로 충돌</strong> 하면 에러가 날 수 있다.</p>
  </li>
  <li>
    <p>실무 팁: 다중 상속을 최소화하거나, <strong>한쪽만 슬롯</strong> 을 쓰고 다른 쪽은 데이터 없는 믹스인으로 설계.</p>
  </li>
</ul>

<h3 id="4-dataclass와의-결합">4) dataclass와의 결합</h3>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">@dataclass(slots=True)</code>(Py3.10+)를 쓰면 <strong>자동으로<code class="language-plaintext highlighter-rouge">__slots__</code>가 생성</strong>된다.</p>
  </li>
  <li>
    <p>이미 수동으로 <code class="language-plaintext highlighter-rouge">__slots__</code>를 정의했다면, <code class="language-plaintext highlighter-rouge">slots=True</code>를 <strong>중복으로 쓰지 않는다</strong>(충돌/중복 정의 주의).</p>
  </li>
</ul>

<h3 id="5-pickle--직렬화">5) pickle / 직렬화</h3>

<ul>
  <li>
    <p>많은 경우 <strong>잘 작동</strong> 하지만, 어떤 프레임워크는 <code class="language-plaintext highlighter-rouge">__dict__</code>를 기대한다.</p>
  </li>
  <li>
    <p>커스텀 직렬화 필요하면 <code class="language-plaintext highlighter-rouge">__getstate__/__setstate__</code>를 구현해 <strong>슬롯 값들을 딕트로 변환</strong> 하는 방식 사용.</p>
  </li>
</ul>

<h3 id="6-프로파일링디버깅-도구">6) 프로파일링/디버깅 도구</h3>

<ul>
  <li>
    <p>일부 도구가 <code class="language-plaintext highlighter-rouge">obj.__dict__</code>를 바로 펼치려다 당황할 수 있다.</p>
  </li>
  <li>
    <p>이런 도구를 쓰면 <code class="language-plaintext highlighter-rouge">"__dict__"</code> 슬롯을 추가하거나, 보조 메서드(예: <code class="language-plaintext highlighter-rouge">to_dict()</code>) 제공.</p>
  </li>
</ul>

<hr />

<h2 id="언제-쓰면-좋은가--피해야-하는가">언제 쓰면 좋은가 / 피해야 하는가</h2>

<p><strong>적합</strong></p>

<ul>
  <li>
    <p>인스턴스가 <strong>엄청 많다</strong> (e.g., 파서 토큰, AST 노드, 로그 레코드 등).</p>
  </li>
  <li>
    <p>속성 스키마가 <strong>변하지 않는다</strong>.</p>
  </li>
  <li>
    <p>라이브러리/코어 레이어에서 <strong>API 안정성</strong> 과 <strong>메모리 효율</strong> 이 중요하다.</p>
  </li>
</ul>

<p><strong>부적합</strong></p>

<ul>
  <li>
    <p>동적으로 속성을 붙였다 뗐다 해야 한다.</p>
  </li>
  <li>
    <p>디버깅/관찰 도구가 <code class="language-plaintext highlighter-rouge">__dict__</code>에 강하게 의존한다.</p>
  </li>
  <li>
    <p>다중 상속 구조가 복잡하다(충돌 위험).</p>
  </li>
</ul>

<hr />

<h2 id="여러분-코드베이스-관점빠른-셀프-체크">여러분 코드베이스 관점(빠른 셀프 체크)</h2>

<ul>
  <li>
    <p>텍스트 버퍼/소스 컨테이너처럼 <strong>필드가 고정</strong> 되고, <strong>많은 인스턴스</strong> 를 만들 가능성이 있다면 <code class="language-plaintext highlighter-rouge">__slots__</code>는 <strong>일관성/성능</strong> 목표에 부합합니다. ✅</p>
  </li>
  <li>
    <p>단, 변환 파이프라인/메타 확장이 잦고 <strong>동적 필드 추가 가능성</strong> 이 있다면, <code class="language-plaintext highlighter-rouge">__slots__</code> 대신 일반 클래스(또는 <code class="language-plaintext highlighter-rouge">__slots__</code>에 <code class="language-plaintext highlighter-rouge">"__dict__"</code> 포함)로 <strong>유연성</strong> 을 남기는 것이 안전합니다. ✅</p>
  </li>
</ul>

<hr />

<h2 id="미니-예시-dataclass--slots">미니 예시: dataclass + slots</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>

<span class="nd">@dataclass</span><span class="p">(</span><span class="n">slots</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  <span class="c1"># Py3.10+
</span><span class="k">class</span> <span class="nc">Token</span><span class="p">:</span>
    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">line</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">col</span><span class="p">:</span> <span class="nb">int</span>
</code></pre></div></div>

<ul>
  <li>메모리 절감 + 오타 방지 + 명확한 스키마를 한 번에 확보.</li>
</ul>

<p>필요하면, 현재 설계한 <code class="language-plaintext highlighter-rouge">TextBuffer</code>/<code class="language-plaintext highlighter-rouge">VerilogSource</code>에 <code class="language-plaintext highlighter-rouge">__slots__</code>를 적용할 때의 <strong>필드 목록/상속 전략</strong> 을 바로 제안해 드릴게요.</p>

<p class="chat--user">

그냥 타입 판별해서 자동으로 만들게 하는 방식 어때 from_lines, from_string, from_textbuffer 구별하기가 좀 귀찮은데, isinstance 같은걸로 비교해서 자동으로 만들게 하는거지(from_file은 별개로), 기존 함수도 두고 

</p>

<p>좋아요—“타입에 따라 자동 생성”을 넣는 건 편의성에 꽤 유용합니다. 다만 <strong>예측 가능성</strong> 을 해치지 않도록 규칙을 명확히 두면 좋아요.</p>

<h3 id="체크리스트개념">체크리스트(개념)</h3>

<ul>
  <li>
    <p>단일 진입점 <code class="language-plaintext highlighter-rouge">coerce(...)</code>로 <strong>문자열/줄 리스트/TextBuffer</strong> 를 알아서 수용</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">from_*</code>들은 <strong>그대로 유지</strong>(명시적 경로가 필요한 곳에서 사용)</p>
  </li>
  <li>
    <p><strong>모호성 규칙</strong> 고정: <code class="language-plaintext highlighter-rouge">keepends</code> 기본 동작과 판별 기준을 문서화</p>
  </li>
  <li>
    <p>제3자 타입은 <strong>프로토콜/어댑터</strong> 로 확장 가능하게 설계</p>
  </li>
  <li>
    <p>잘못된 타입은 <strong>명확한 오류</strong> 로 거절</p>
  </li>
</ul>

<hr />

<h2 id="설계-결론--빠른-검증">설계 결론 &amp; 빠른 검증</h2>

<ol>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">TextBuffer.coerce(obj, ...)</code> 추가</strong></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">TextBuffer</code> → 그대로 반환</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">str</code> → <code class="language-plaintext highlighter-rouge">from_string</code></p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">list/tuple/Iterable[str]</code> → <code class="language-plaintext highlighter-rouge">from_lines</code> (필요 시 materialize)</p>
      </li>
      <li>
        <p><em>검증:</em> 호출부 단순화(✅), 기존 명시 API와 공존(✅).</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">keepends</code> 기본 정책</strong></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">keepends=None</code>(기본): <strong>한 줄이라도<code class="language-plaintext highlighter-rouge">\n</code>/<code class="language-plaintext highlighter-rouge">\r</code>가 포함되면</strong> <code class="language-plaintext highlighter-rouge">keepends=True</code>로 간주, 아니면 <code class="language-plaintext highlighter-rouge">False</code>.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">keepends</code>를 명시하면 그 값을 그대로 사용.</p>
      </li>
      <li>
        <p><em>검증:</em> 휴리스틱 최소화 + 결정적(✅). 과도한 “추측”은 피함(셀프 코렉트).</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>경계 명확화</strong></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">Path/bytes</code>는 <strong>여기서 처리하지 않음</strong>. 파일 I/O는 <code class="language-plaintext highlighter-rouge">from_file</code>로만.</p>
      </li>
      <li>
        <p><em>검증:</em> I/O 사이드이펙트 금지로 일관성 유지(✅).</p>
      </li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="코드-추가-기존-textbuffer에-붙일-메서드">코드 추가 (기존 <code class="language-plaintext highlighter-rouge">TextBuffer</code>에 붙일 메서드)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Sequence</span>

<span class="k">class</span> <span class="nc">TextBuffer</span><span class="p">:</span>
    <span class="c1"># ... 기존 코드 ...
</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">coerce</span><span class="p">(</span>
        <span class="n">cls</span><span class="p">,</span>
        <span class="n">obj</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">profile</span><span class="p">:</span> <span class="n">TextProfile</span> <span class="o">=</span> <span class="nc">TextProfile</span><span class="p">(),</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">keepends</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">TextBuffer</span><span class="sh">"</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        다양한 입력(obj)을 TextBuffer로 표준화.
        - TextBuffer: 그대로 반환
        - str: from_string
        - Iterable[str]: from_lines (필요 시 keepends 추정)
        - (주의) Path/bytes는 여기서 처리하지 않음 → from_file / decode 경로 사용
        </span><span class="sh">"""</span>
        <span class="c1"># 1) 이미 TextBuffer인 경우
</span>        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">TextBuffer</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obj</span>

        <span class="c1"># 2) 문자열
</span>        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cls</span><span class="p">.</span><span class="nf">from_string</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="n">profile</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>

        <span class="c1"># 3) 문자열 이터러블(리스트/튜플/제너레이터 등)
</span>        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="c1"># materialize (제너레이터 보호 및 타입 검사)
</span>            <span class="n">lines</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nf">all</span><span class="p">(</span><span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span><span class="sh">"</span><span class="s">Iterable must yield str values</span><span class="sh">"</span><span class="p">)</span>

            <span class="c1"># keepends 규칙: 명시값 우선, 없으면 자동 판별
</span>            <span class="n">ke</span> <span class="o">=</span> <span class="n">keepends</span> <span class="k">if</span> <span class="n">keepends</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">cls</span><span class="p">.</span><span class="nf">_guess_keepends</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cls</span><span class="p">.</span><span class="nf">from_lines</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">keepends</span><span class="o">=</span><span class="n">ke</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="n">profile</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>

        <span class="c1"># 4) 그 외 타입은 명확히 거절
</span>        <span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="sh">"</span><span class="s">Cannot coerce type </span><span class="si">{</span><span class="nf">type</span><span class="p">(</span><span class="n">obj</span><span class="p">).</span><span class="n">__name__</span><span class="si">}</span><span class="s"> to TextBuffer. </span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">Use from_file() for paths/files, or pass str/Iterable[str]/TextBuffer.</span><span class="sh">"</span>
        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_guess_keepends</span><span class="p">(</span><span class="n">lines</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">한 줄이라도 개행 문자를 포함하면 keepends=True로 간주.</span><span class="sh">"""</span>
        <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="nf">if </span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">ln</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="sh">"</span><span class="se">\r</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">ln</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>
</code></pre></div></div>

<p><strong>검증:</strong> 단일 진입점으로 편의성을 제공하면서, 파일 I/O·바이트 처리 등 사이드이펙트는 명시 API로 분리 → <strong>일관성/확장성</strong> 목표에 부합. ✅</p>

<hr />

<h2 id="사용-예">사용 예</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">buf1</span> <span class="o">=</span> <span class="n">TextBuffer</span><span class="p">.</span><span class="nf">coerce</span><span class="p">(</span><span class="sh">"</span><span class="s">module top;</span><span class="se">\n</span><span class="s">endmodule</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="n">VERILOG</span><span class="p">)</span>
<span class="n">buf2</span> <span class="o">=</span> <span class="n">TextBuffer</span><span class="p">.</span><span class="nf">coerce</span><span class="p">([</span><span class="sh">"</span><span class="s">module top;</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">endmodule</span><span class="sh">"</span><span class="p">],</span> <span class="n">profile</span><span class="o">=</span><span class="n">VERILOG</span><span class="p">)</span>              <span class="c1"># keepends=False
</span><span class="n">buf3</span> <span class="o">=</span> <span class="n">TextBuffer</span><span class="p">.</span><span class="nf">coerce</span><span class="p">([</span><span class="sh">"</span><span class="s">module top;</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">endmodule</span><span class="se">\n</span><span class="sh">"</span><span class="p">],</span> <span class="n">profile</span><span class="o">=</span><span class="n">VERILOG</span><span class="p">)</span>          <span class="c1"># keepends=True (자동 판별)
</span><span class="n">buf4</span> <span class="o">=</span> <span class="n">TextBuffer</span><span class="p">.</span><span class="nf">coerce</span><span class="p">(</span><span class="n">existing_textbuffer</span><span class="p">)</span>                                        <span class="c1"># 그대로
# 파일은 명시 API 사용
</span><span class="n">buf5</span> <span class="o">=</span> <span class="n">TextBuffer</span><span class="p">.</span><span class="nf">from_file</span><span class="p">(</span><span class="sh">"</span><span class="s">rtl/top.v</span><span class="sh">"</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="n">VERILOG</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="확장-아이디어필요-시">확장 아이디어(필요 시)</h2>

<ul>
  <li>
    <p><strong>모듈 전역<code class="language-plaintext highlighter-rouge">ensure_textbuffer(obj, **opts)</code></strong> 함수를 <code class="language-plaintext highlighter-rouge">functools.singledispatch</code>로 제공(내부에서 위 <code class="language-plaintext highlighter-rouge">coerce</code> 호출).</p>
  </li>
  <li>
    <p>외부 타입 지원: 객체가 <code class="language-plaintext highlighter-rouge">to_textbuffer()</code>(또는 <code class="language-plaintext highlighter-rouge">__textbuffer__()</code>)를 구현했다면 그걸 우선 호출하는 <strong>어댑터 패턴</strong> 허용.</p>
  </li>
</ul>

<hr />

<h3 id="최종-판단">최종 판단</h3>

<ul>
  <li>
    <p>“자동 생성”은 생산성을 올리되, <strong>명시 API를 남겨</strong> 경계를 분명히 하는 지금 방식이 가장 안전합니다.</p>
  </li>
  <li>
    <p>휴리스틱은 최소화했고, 필요 시 <code class="language-plaintext highlighter-rouge">keepends</code>를 명시하면 <strong>항상 우선</strong> 합니다.<br />
→ 프로젝트의 <strong>일관성</strong>(놀라움 최소화)과 <strong>확장성</strong>(타입 추가 여지) 목표에 적합합니다. ✅</p>
  </li>
</ul>

<p class="chat--user">

coerce 단어가 좀 어려운데

</p>

<p>좋은 포인트! 이름이 어렵게 느껴지면 쓰는 사람이 안 쓰게 됩니다 😅<br />
아래처럼 바꾸면 어때요?</p>

<h3 id="체크리스트">체크리스트</h3>

<ul>
  <li>
    <p>후보 이름 몇 개 제안하고 의미·관용성 비교</p>
  </li>
  <li>
    <p>하나를 <strong>기본 추천</strong> 으로 선택</p>
  </li>
  <li>
    <p>기존 <code class="language-plaintext highlighter-rouge">coerce</code>는 <strong>호환용 별칭</strong> 으로 남김</p>
  </li>
  <li>
    <p>예시 코드/사용법 제시</p>
  </li>
  <li>
    <p>선택이 <strong>일관성/확장성</strong> 목표에 맞는지 빠른 검증</p>
  </li>
</ul>

<hr />

<h2 id="이름-후보-짧은-코멘트">이름 후보 (짧은 코멘트)</h2>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">as_textbuffer(obj, ...)</code> — <strong>가장 추천</strong>. NumPy의 <code class="language-plaintext highlighter-rouge">asarray</code> 패턴처럼 “이걸 TextBuffer로 ‘바꿔서’ 주세요(이미면 그대로)”라는 의미가 <strong>직관적</strong>.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">ensure_textbuffer(obj, ...)</code> — “TextBuffer 되게 보장해줘”라는 뉘앙스. 명확하지만 약간 길어요.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">from_any(obj, ...)</code> — “아무 타입이나 받아들여 생성”. 기능은 맞지만 의미가 약간 포괄적.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">wrap(obj, ...)</code> / <code class="language-plaintext highlighter-rouge">adapt(obj, ...)</code> — 포장/어댑트 느낌. 다만 구체성이 떨어짐.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">cast(...)</code> — 타입 캐스트 뉘앙스로 혼동 우려 → 비추천.</p>
  </li>
</ul>

<p><strong>결론:</strong> <code class="language-plaintext highlighter-rouge">as_textbuffer</code>를 기본으로, 클래스 메서드로는 <code class="language-plaintext highlighter-rouge">from_any</code>를 얹고, 기존 <code class="language-plaintext highlighter-rouge">coerce</code>는 alias로 두는 구성이 가장 읽기 쉽고 점진적입니다.</p>

<ul>
  <li><em>검증:</em> 이름만 바꿔도 호출부 가독성↑(일관성 목표 부합) / API 확장 시에도 의미 유지(확장성 목표 부합). ✅</li>
</ul>

<hr />

<h2 id="코드-스니펫-기존-coerce-내용을-내부-구현으로-재사용">코드 스니펫 (기존 <code class="language-plaintext highlighter-rouge">coerce</code> 내용을 내부 구현으로 재사용)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># module-level 함수: 가장 눈에 잘 띄는 진입점
</span><span class="k">def</span> <span class="nf">as_textbuffer</span><span class="p">(</span>
    <span class="n">obj</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">profile</span><span class="p">:</span> <span class="n">TextProfile</span> <span class="o">=</span> <span class="nc">TextProfile</span><span class="p">(),</span>
    <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">keepends</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">TextBuffer</span><span class="sh">"</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">TextBuffer</span><span class="p">.</span><span class="nf">from_any</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="n">profile</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span> <span class="n">keepends</span><span class="o">=</span><span class="n">keepends</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">TextBuffer</span><span class="p">:</span>
    <span class="c1"># ... 기존 코드 ...
</span>
    <span class="c1"># 새 이름: 의미가 분명한 클래스 메서드
</span>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_any</span><span class="p">(</span>
        <span class="n">cls</span><span class="p">,</span>
        <span class="n">obj</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">profile</span><span class="p">:</span> <span class="n">TextProfile</span> <span class="o">=</span> <span class="nc">TextProfile</span><span class="p">(),</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">keepends</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">TextBuffer</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">.</span><span class="nf">_from_any_impl</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="n">profile</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span> <span class="n">keepends</span><span class="o">=</span><span class="n">keepends</span><span class="p">)</span>

    <span class="c1"># 과거 이름은 호환용 별칭으로 유지 (원하면 향후 deprecate)
</span>    <span class="nb">coerce</span> <span class="o">=</span> <span class="n">from_any</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_from_any_impl</span><span class="p">(</span>
        <span class="n">cls</span><span class="p">,</span>
        <span class="n">obj</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">profile</span><span class="p">:</span> <span class="n">TextProfile</span><span class="p">,</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">keepends</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">TextBuffer</span><span class="sh">"</span><span class="p">:</span>
        <span class="kn">from</span> <span class="n">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Sequence</span>

        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">TextBuffer</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obj</span>

        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cls</span><span class="p">.</span><span class="nf">from_string</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="n">profile</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>

        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">all</span><span class="p">(</span><span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span><span class="sh">"</span><span class="s">Iterable must yield str values</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">ke</span> <span class="o">=</span> <span class="n">keepends</span> <span class="k">if</span> <span class="n">keepends</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">cls</span><span class="p">.</span><span class="nf">_guess_keepends</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cls</span><span class="p">.</span><span class="nf">from_lines</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">keepends</span><span class="o">=</span><span class="n">ke</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="n">profile</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>

        <span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="sh">"</span><span class="s">Cannot convert </span><span class="si">{</span><span class="nf">type</span><span class="p">(</span><span class="n">obj</span><span class="p">).</span><span class="n">__name__</span><span class="si">}</span><span class="s"> to TextBuffer. </span><span class="sh">"</span>
            <span class="sh">"</span><span class="s">Use from_file() for paths/files, or pass str/Iterable[str]/TextBuffer.</span><span class="sh">"</span>
        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_guess_keepends</span><span class="p">(</span><span class="n">lines</span><span class="p">:</span> <span class="sh">"</span><span class="s">Sequence[str]</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">any</span><span class="p">((</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">ln</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="sh">"</span><span class="se">\r</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">ln</span><span class="p">)</span> <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="사용-예-1">사용 예</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">buf1</span> <span class="o">=</span> <span class="nf">as_textbuffer</span><span class="p">(</span><span class="sh">"</span><span class="s">module top;</span><span class="se">\n</span><span class="s">endmodule</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="n">VERILOG</span><span class="p">)</span>
<span class="n">buf2</span> <span class="o">=</span> <span class="nf">as_textbuffer</span><span class="p">([</span><span class="sh">"</span><span class="s">module top;</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">endmodule</span><span class="sh">"</span><span class="p">],</span> <span class="n">profile</span><span class="o">=</span><span class="n">VERILOG</span><span class="p">)</span>
<span class="n">buf3</span> <span class="o">=</span> <span class="n">TextBuffer</span><span class="p">.</span><span class="nf">from_any</span><span class="p">([</span><span class="sh">"</span><span class="s">a</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">b</span><span class="se">\n</span><span class="sh">"</span><span class="p">],</span> <span class="n">profile</span><span class="o">=</span><span class="n">VERILOG</span><span class="p">)</span>  <span class="c1"># 클래스 메서드 경로
</span><span class="n">buf4</span> <span class="o">=</span> <span class="n">TextBuffer</span><span class="p">.</span><span class="nf">coerce</span><span class="p">(</span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># 기존 코드도 그대로 동작(호환 alias)
</span></code></pre></div></div>

<hr />

<h2 id="빠른-검증--셀프코렉트">빠른 검증 &amp; 셀프코렉트</h2>

<ul>
  <li>
    <p><strong>가독성/예측 가능성:</strong> <code class="language-plaintext highlighter-rouge">as_textbuffer</code> 이름만 보고도 역할이 보입니다. 혼동 여지 낮음. ✅</p>
  </li>
  <li>
    <p><strong>일관성:</strong> <code class="language-plaintext highlighter-rouge">from_string/from_lines/from_file</code> 같은 명시 경로를 유지하면서, “편의 경로”는 <code class="language-plaintext highlighter-rouge">as_textbuffer</code>로 통일. ✅</p>
  </li>
  <li>
    <p><strong>확장성:</strong> 제3자 타입이 늘어나면 <code class="language-plaintext highlighter-rouge">_from_any_impl</code>에 어댑터 훅을 추가하면 됨(예: <code class="language-plaintext highlighter-rouge">obj.__textbuffer__()</code> 지원 등). ✅</p>
  </li>
  <li>
    <p><strong>모호성 관리:</strong> 파일/바이트는 여전히 <code class="language-plaintext highlighter-rouge">from_file</code>/decode 경로로만 처리 → 사이드이펙트·추측 로직 최소화. ✅</p>
  </li>
</ul>

<p>원하시면 프로젝트 전역 네이밍 룰(예: “편의 변환 엔트리는 항상 <code class="language-plaintext highlighter-rouge">as_*</code>로 시작”)도 같이 정리해 드릴게요.</p>

        
      </section>

      <footer class="page__meta">
        
        


  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#python" class="page__taxonomy-item p-category" rel="tag">python</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2025-08-21T19:10:46+09:00">2025-08-21</time></p>

      </footer>

      

      
  <nav class="pagination">
    
      <a href="/python/python-dataclass-method/" class="pagination--pager" title="untitled">Previous</a>
    
    
      <a href="/llm/simple-chatbot-client/" class="pagination--pager" title="LLM Chatbot Client Plan">Next</a>
    
  </nav>


    </div>

    
  </article>

  
  
    
<div class="page__related">
  
  <h2 class="page__related-title">You may also enjoy</h2>
  <div class="grid__wrapper">
    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2025-08-19-python-repr-vs-str/" rel="permalink">
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-10T18:42:46+09:00">2025-10-10</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/comfyui/comfyui-lsf-job-submit/" rel="permalink">ComfyUI LSF Job Submit
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-10T18:42:41+09:00">2025-10-10</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/python/python-async-subprocess/" rel="permalink">Python 비동기 서브프로세스 실행
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-10T14:05:19+09:00">2025-10-10</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/comfyui/async-request-cancel/" rel="permalink">Async request 취소 처리
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-10T11:53:02+09:00">2025-10-10</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
  </div>
</div>

  
  
</div>

      
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        

<div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    
  </ul>
</div>


<div class="page__footer-copyright">&copy; 2013 - 2025 <a href="https://hvppyarchive.github.io">ARCHIVE</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/jekyll-themes/minimal-mistakes/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>






  </body>
</html>
