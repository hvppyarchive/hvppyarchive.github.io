<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.27.1 by Michael Rose
  Copyright 2013-2025 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en-US" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>IBM LSF Python 패키지 개발 - ARCHIVE</title>
<meta name="description" content="">


  <meta name="author" content="hvppyarchive">
  
  <meta property="article:author" content="hvppyarchive">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="ARCHIVE">
<meta property="og:title" content="IBM LSF Python 패키지 개발">
<meta property="og:url" content="https://hvppyarchive.github.io/python/python-lsf-package/">


  <meta property="og:description" content="">







  <meta property="article:published_time" content="2025-10-13T17:02:21+09:00">





  

  


<link rel="canonical" href="https://hvppyarchive.github.io/python/python-lsf-package/">












<!-- end _includes/seo.html -->


<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->
<!-- hvppyarchive: add fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@200..900&display=swap" rel="stylesheet">

<!-- insert favicons. use https://realfavicongenerator.net/ -->
 <!-- hvppyarchive: add favicons -->
<link rel="icon" type="image/png" href="/assets/favicon/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/assets/favicon/favicon.svg" />
<link rel="shortcut icon" href="/assets/favicon/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png" />
<link rel="manifest" href="/assets/favicon/site.webmanifest" />

<!-- end custom head snippets -->

  </head>

  <body class="layout--single" dir="ltr">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          ARCHIVE
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/year-archive/"
                
                
              >Posts</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="IBM LSF Python 패키지 개발">
    <meta itemprop="description" content="">
    <meta itemprop="datePublished" content="2025-10-13T17:02:21+09:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://hvppyarchive.github.io/python/python-lsf-package/" itemprop="url">IBM LSF Python 패키지 개발
</a>
          </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-13T17:02:21+09:00">2025-10-13</time>
      </span>
    

    

    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p class="chat--user">

IBM LSF 알아?

</p>

<p>네! IBM <strong>Spectrum LSF</strong>(옛 <em>Platform LSF</em>)는 HPC/대규모 서버 팜에서 배치 작업을 스케줄링·큐잉·자원관리하는 상용 워크로드 매니저예요. 간단히 핵심만 단계별로 정리해볼게요.</p>

<h1 id="1-뭐-하는-툴">1) 뭐 하는 툴?</h1>

<ul>
  <li>
    <p>많은 사용자/작업을 큐(Queue)에 넣고, 클러스터의 CPU·메모리·GPU·라이선스 같은 자원을 규칙에 맞춰 자동 분배합니다.</p>
  </li>
  <li>
    <p>우선순위, 공정 배분(fairshare), 선점/백필(backfill), 예약(SLA/예약슬롯), 다중 클러스터 등 정책을 세밀하게 걸 수 있어요.</p>
  </li>
</ul>

<h1 id="2-구성-요소아주-요약">2) 구성 요소(아주 요약)</h1>

<ul>
  <li>
    <p><strong>mbatchd / mbschd</strong> : 마스터 배치·스케줄러 데몬(작업 결정 뇌).</p>
  </li>
  <li>
    <p><strong>sbatchd</strong>(각 워커 호스트): 작업 실행/모니터링.</p>
  </li>
  <li>
    <p><strong>lim / res</strong> : 호스트 부하정보 수집과 원격 실행.</p>
  </li>
  <li>
    <p>관리/사용자는 <strong>bsub, bjobs, bqueues</strong> 같은 CLI로 상호작용.</p>
  </li>
</ul>

<h1 id="3-기본-사용-흐름">3) 기본 사용 흐름</h1>

<ol>
  <li>
    <p>사용자가 큐/요구자원과 함께 작업 제출 → <code class="language-plaintext highlighter-rouge">bsub ...</code></p>
  </li>
  <li>
    <p>LSF가 정책·가용자원 평가 → 적합한 노드에 할당</p>
  </li>
  <li>
    <p>실행·모니터링 → 완료 후 로그/결과 수집</p>
  </li>
</ol>

<h1 id="4-자주-쓰는-명령필수-최소셋">4) 자주 쓰는 명령(필수 최소셋)</h1>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 작업 제출</span>
bsub <span class="nt">-q</span> normal <span class="nt">-J</span> myjob <span class="nt">-n</span> 4 <span class="nt">-R</span> <span class="s2">"rusage[mem=8G]"</span> <span class="nt">-oo</span> out.%J <span class="nt">-eo</span> err.%J ./run.sh

<span class="c"># 상태/출력 확인</span>
bjobs              <span class="c"># 내 잡 요약</span>
bjobs <span class="nt">-l</span> &lt;JOBID&gt;   <span class="c"># 상세</span>
bpeek &lt;JOBID&gt;      <span class="c"># 실행 중 표준출력 엿보기(설정에 따라 지원)</span>

<span class="c"># 큐/호스트 보기</span>
bqueues <span class="nt">-l</span>         <span class="c"># 큐 상세 정책</span>
bhosts             <span class="c"># 호스트 상태</span>

<span class="c"># 제어</span>
bstop &lt;JOBID&gt;      <span class="c"># 일시중지</span>
bresume &lt;JOBID&gt;    <span class="c"># 재개</span>
bkill &lt;JOBID&gt;      <span class="c"># 종료</span>
bhist <span class="nt">-l</span> &lt;JOBID&gt;   <span class="c"># 히스토리</span>
</code></pre></div></div>

<h1 id="5-제출-스크립트-예시가장-단순한-형태">5) 제출 스크립트 예시(가장 단순한 형태)</h1>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># run.sh</span>
<span class="c">#!/usr/bin/env bash</span>
<span class="nb">echo</span> <span class="s2">"Host: </span><span class="si">$(</span><span class="nb">hostname</span><span class="si">)</span><span class="s2">"</span>
<span class="nb">echo</span> <span class="s2">"Start: </span><span class="si">$(</span><span class="nb">date</span><span class="si">)</span><span class="s2">"</span>
python train.py <span class="nt">--epochs</span> 10
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 제출</span>
bsub <span class="nt">-q</span> normal <span class="nt">-J</span> train <span class="nt">-n</span> 4 <span class="nt">-R</span> <span class="s2">"rusage[mem=8G]"</span> <span class="nt">-oo</span> train.%J.out ./run.sh
</code></pre></div></div>

<h1 id="6-정책자원-요청-팁">6) 정책/자원 요청 팁</h1>

<ul>
  <li>
    <p><strong>CPU 코어 수</strong> : <code class="language-plaintext highlighter-rouge">-n 8</code></p>
  </li>
  <li>
    <p><strong>메모리</strong> : <code class="language-plaintext highlighter-rouge">-R "rusage[mem=16G]"</code> (클러스터 정책과 단위 확인 필수)</p>
  </li>
  <li>
    <p><strong>노드 스프레드</strong> : <code class="language-plaintext highlighter-rouge">-R "span[ptile=4]"</code> (호스트당 코어 4개씩 배치)</p>
  </li>
  <li>
    <p><strong>GPU</strong> : 클러스터 설정에 따라 전용 옵션/리소스명이 다릅니다. 보통 전용 큐를 쓰거나 <code class="language-plaintext highlighter-rouge">-R</code>/<code class="language-plaintext highlighter-rouge">-gpu</code>(환경에 따라 지원)로 요청합니다. 운영팀이 정한 표준을 확인하세요.</p>
  </li>
</ul>

<h1 id="7-장단점한눈에">7) 장단점(한눈에)</h1>

<ul>
  <li>
    <p><strong>장점</strong> : 성숙한 정책/엔터프라이즈 지원, 이기종·대규모 클러스터 운영 경험 풍부, 모니터링/리포팅(LSF RTM 등) 생태계.</p>
  </li>
  <li>
    <p><strong>단점</strong> : 상용 라이선스 비용, 설정 초기 러닝커브, 커스텀 정책 이해 필요.</p>
  </li>
  <li>
    <p><strong>대안</strong> : Slurm(오픈소스), PBS Pro/Altair PBS, Grid Engine 계열 등.</p>
  </li>
</ul>

<hr />

<p>원하시면,</p>

<ul>
  <li>
    <p>현재 환경(큐 이름, 자원 규칙, GPU 요청 방식)에 맞춘 <strong>제출 템플릿</strong> 을 바로 만들어 드릴게요,</p>
  </li>
  <li>
    <p>또는 기존 Slurm/PBS 스크립트를 LSF로 <strong>자동 변환</strong> 해서 드릴 수도 있어요. 어떤 워크로드를 돌리실 계획인가요?</p>
  </li>
</ul>

<p class="chat--user">

나는 LSF에 여러 Job을 Submit하고 종료시키기/완료 여부 파악 등등 자동화 업무를 하고 있어.(파이썬) 그런데 "bsub", "bkill", "bjobs" 같은 커맨드를 subprocess로 매번 call하니 관리가 힘들고 느리기도 해(subprocess가 끝나서 job ID를 받아와야 하므로) bsub, bkill 시에는 async 기능을 활용하고, bjobs는 memory/storage cache를 통해 너무 자주 프로세스를 호출하지 않았으면 좋겠어(LSF 시스템 부하 줄이기 위해).

</p>

<p>좋아요! 요구사항(비동기 제출/종료 + <code class="language-plaintext highlighter-rouge">bjobs</code> 호출 캐싱/감속)을 만족하는 <strong>간단하지만 탄탄한 아키텍처 + 참조 구현</strong> 을 바로 드릴게요.<br />
아래 순서대로 보시면 됩니다.</p>

<h1 id="0-목표-step-by-step">0) 목표 (Step-by-step)</h1>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bsub</code>, <code class="language-plaintext highlighter-rouge">bkill</code>은 <code class="language-plaintext highlighter-rouge">asyncio</code> 기반으로 <strong>동시에 많이</strong> 돌릴 수 있게.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bjobs</code>는 <strong>TTL 캐시 + 단일비행(single-flight) + 레이트리밋</strong> 으로 과호출 방지.</p>
  </li>
  <li>
    <p>가능한 한 <strong>배치(batch)</strong> 로 묶어서 호출수 최소화.</p>
  </li>
  <li>
    <p>출력 파싱은 <strong>locale 고정(LC_ALL=C)</strong> + <strong>안전한 정규식/필드셋</strong> 만 사용.</p>
  </li>
</ol>

<hr />

<h1 id="1-설계-핵심">1) 설계 핵심</h1>

<ul>
  <li>
    <p><strong>동시성 제어</strong> : 모든 LSF CLI 호출에 공통 세마포어(예: 동시 8개) + 명령별 레이트리밋(예: <code class="language-plaintext highlighter-rouge">bjobs</code>는 초당 1회).</p>
  </li>
  <li>
    <p><strong>비동기 제출/종료</strong> : <code class="language-plaintext highlighter-rouge">asyncio.create_subprocess_exec</code>로 <code class="language-plaintext highlighter-rouge">bsub</code>, <code class="language-plaintext highlighter-rouge">bkill</code>를 비동기 실행.</p>
  </li>
  <li>
    <p><strong>bjobs 캐시</strong> :</p>

    <ul>
      <li>
        <p><strong>TTL 캐시</strong>(예: 3~5초): TTL 내 재요청은 메모리에서 즉시 응답.</p>
      </li>
      <li>
        <p><strong>단일비행</strong> : 같은 키(동일 Job ID 세트/필터)의 <code class="language-plaintext highlighter-rouge">bjobs</code> 요청이 동시 들어오면 <strong>이미 진행 중인</strong> 한 번만 실제 실행, 나머지는 그 Future를 await.</p>
      </li>
      <li>
        <p><strong>레이트리밋</strong> : 최소 호출 간격 보장(예: 1~2초).</p>
      </li>
      <li>
        <p><strong>배치 쿼리</strong> : 여러 Job ID 요청을 <strong>합집합</strong> 으로 묶어 한 번에 조회 → 결과를 per-job로 분산.</p>
      </li>
    </ul>
  </li>
</ul>

<blockquote>
  <p>참고: LSF는 <code class="language-plaintext highlighter-rouge">bjobs</code>의 출력 포맷을 <code class="language-plaintext highlighter-rouge">-o</code>로 제어할 수 있지만, 날짜 필드는 공백이 있어 파싱이 까다롭습니다. 여기서는 <strong>필요 최소 필드</strong>(공백 없는 것들)만 요청합니다: <code class="language-plaintext highlighter-rouge">jobid stat exit_code queue exec_host</code><br />
 (시간이 필요하면 별도 포맷/구분 기호를 추가해 확장 가능)</p>
</blockquote>

<hr />

<h1 id="2-참조-구현-단일-파일-바로-붙여넣어-사용-가능">2) 참조 구현 (단일 파일; 바로 붙여넣어 사용 가능)</h1>

<p>아래는 의존성 없는 순수 Python 3.10+ 코드입니다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># lsf_async.py
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="n">_JOBID_RE</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="nb">RuntimeError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Command failed: </span><span class="si">{</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="si">}</span><span class="s"> (rc=</span><span class="si">{</span><span class="n">returncode</span><span class="si">}</span><span class="s">)</span><span class="se">\n</span><span class="si">{</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span>
        <span class="n">self</span><span class="p">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="n">returncode</span>
        <span class="n">self</span><span class="p">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span>
        <span class="n">self</span><span class="p">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">stderr</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
               <span class="o">*</span><span class="p">,</span>
               <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
               <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">Run a command asynchronously and return (stdout, stderr, returncode).</span><span class="sh">"""</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
        <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ProcessLookupError</span><span class="p">):</span>
            <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
        <span class="k">raise</span>
    <span class="k">return</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>

<span class="k">class</span> <span class="nc">LsfClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Async LSF CLI wrapper with:
      - concurrent bsub/bkill
      - cached/rate-limited bjobs
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                 <span class="o">*</span><span class="p">,</span>
                 <span class="n">bsub</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bsub</span><span class="sh">"</span><span class="p">,</span>
                 <span class="n">bkill</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">,</span>
                 <span class="n">bjobs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">,</span>
                 <span class="n">max_concurrent_cli</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
                 <span class="n">bjobs_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
                 <span class="n">bjobs_min_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                 <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">paths</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">bsub</span><span class="sh">"</span><span class="p">:</span> <span class="n">bsub</span><span class="p">,</span> <span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">:</span> <span class="n">bkill</span><span class="p">,</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">:</span> <span class="n">bjobs</span><span class="p">}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">max_concurrent_cli</span><span class="p">)</span>

        <span class="c1"># Cache &amp; in-flight tracking for bjobs
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span> <span class="o">=</span> <span class="n">bjobs_ttl_sec</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">=</span> <span class="n">bjobs_min_interval_sec</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_inflight</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_last_call_ts</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">base_env</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LC_ALL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LANG</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">base_env</span> <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="bp">None</span> <span class="nf">else </span><span class="p">(</span><span class="n">base_env</span> <span class="o">|</span> <span class="n">env</span><span class="p">)</span>

    <span class="c1"># ---------- helpers ----------
</span>    <span class="k">def</span> <span class="nf">_key_for_bjobs</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="n">extra_flags</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="nf">tuple</span><span class="p">(</span><span class="nf">sorted</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">)))</span> <span class="k">if</span> <span class="n">job_ids</span> <span class="nf">else </span><span class="p">()</span>
        <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs|</span><span class="si">{</span><span class="n">extra_flags</span><span class="si">}</span><span class="s">|</span><span class="si">{</span><span class="n">ids</span><span class="si">}</span><span class="sh">"</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_guarded_run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="nf">_run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">env</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="c1"># ---------- public API ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                     <span class="n">command</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
                     <span class="o">*</span><span class="p">,</span>
                     <span class="n">queue</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">job_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">n_cpus</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">rusage</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">out_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">err_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">cwd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">extra_bsub_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        Submit a job via bsub and return job id.
        `command` may be a shell string or a sequence.
        </span><span class="sh">"""</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">paths</span><span class="p">[</span><span class="sh">"</span><span class="s">bsub</span><span class="sh">"</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">queue</span><span class="p">:</span> <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-q</span><span class="sh">"</span><span class="p">,</span> <span class="n">queue</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">job_name</span><span class="p">:</span> <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-J</span><span class="sh">"</span><span class="p">,</span> <span class="n">job_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">n_cpus</span><span class="p">:</span> <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-n</span><span class="sh">"</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">n_cpus</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">rusage</span><span class="p">:</span> <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-R</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">rusage[</span><span class="si">{</span><span class="n">rusage</span><span class="si">}</span><span class="s">]</span><span class="sh">"</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">out_file</span><span class="p">:</span> <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-oo</span><span class="sh">"</span><span class="p">,</span> <span class="n">out_file</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">err_file</span><span class="p">:</span> <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-eo</span><span class="sh">"</span><span class="p">,</span> <span class="n">err_file</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">extra_bsub_args</span><span class="p">:</span> <span class="n">args</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="n">extra_bsub_args</span><span class="p">)</span>

        <span class="c1"># bsub expects the job command at the end; if a string, run via /bin/sh -c
</span>        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="n">command</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Treat the sequence as an executable + args (no shell)
</span>            <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">command</span><span class="p">))]</span>

        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guarded_run</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

        <span class="c1"># Parse: "Job &lt;12345&gt; is submitted to queue &lt;normal&gt;."
</span>        <span class="n">m</span> <span class="o">=</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Cannot parse job id from bsub output:</span><span class="se">\n</span><span class="si">{</span><span class="n">stdout</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">stderr</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">int</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                   <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
                   <span class="o">*</span><span class="p">,</span>
                   <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                   <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        Kill one or many jobs with a single bkill call.
        </span><span class="sh">"""</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">job_ids</span><span class="p">))]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">paths</span><span class="p">[</span><span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-f</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="n">ids</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guarded_run</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                     <span class="n">job_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="o">*</span><span class="p">,</span>
                     <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                     <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sh">"""</span><span class="s">
        Get job status map: {jobid: {stat, exit_code, queue, exec_host}}.
        Uses TTL cache + single-flight + rate limiting.
        If job_ids is None, queries all of the current user</span><span class="sh">'</span><span class="s">s jobs.
        </span><span class="sh">"""</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-a</span><span class="sh">"</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_key_for_bjobs</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>

        <span class="c1"># Serve cached if fresh
</span>        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">cached</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached</span> <span class="ow">and</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">cached</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cached</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Single-flight: if another coroutine is already fetching this key, await it
</span>        <span class="n">inflight</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_inflight</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inflight</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">inflight</span>

        <span class="c1"># Create the in-flight future
</span>        <span class="n">fut</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">().</span><span class="nf">create_future</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_inflight</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fut</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Simple rate limit for bjobs
</span>            <span class="n">since</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_last_call_ts</span>
            <span class="k">if</span> <span class="n">since</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">-</span> <span class="n">since</span><span class="p">)</span>

            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">paths</span><span class="p">[</span><span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">-noheader</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">include_done</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-a</span><span class="sh">"</span><span class="p">]</span>
            <span class="c1"># Request only whitespace-safe fields
</span>            <span class="c1"># Fields: jobid stat exit_code queue exec_host
</span>            <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-o</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">jobid stat exit_code queue exec_host</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">job_ids</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">set</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)]</span>

            <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guarded_run</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_last_call_ts</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

            <span class="c1"># Parse lines; with chosen fields, tokens are whitespace-separated safely
</span>            <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">split</span><span class="p">()</span>
                <span class="c1"># Expect exactly 5 tokens
</span>                <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="c1"># best-effort: skip malformed
</span>                    <span class="k">continue</span>
                <span class="n">jid</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">exec_host</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">jid_i</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">result</span><span class="p">[</span><span class="n">jid_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="n">stat</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="sh">"</span><span class="s">-</span><span class="sh">"</span> <span class="k">else</span> <span class="n">exit_code</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="n">queue</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="n">exec_host</span><span class="p">,</span>
                <span class="p">}</span>

            <span class="c1"># Cache and resolve the in-flight future
</span>            <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">result</span><span class="p">)</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># clean inflight
</span>            <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_inflight</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="c1"># --------- convenience: bulk status with de-dup &amp; union batching ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">status_union_batched</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                                   <span class="n">list_of_job_id_sets</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
                                   <span class="o">*</span><span class="p">,</span>
                                   <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                                   <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
        <span class="sh">"""</span><span class="s">
        Given multiple callers wanting statuses for different sets, perform
        ONE bjobs with the union of ids, then slice the result per request.
        (Uses the normal cache path internally.)
        </span><span class="sh">"""</span>
        <span class="n">union_ids</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="n">normalized</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">list_of_job_id_sets</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>
            <span class="n">normalized</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">norm</span><span class="p">)</span>
            <span class="n">union_ids</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">norm</span><span class="p">)</span>
        <span class="n">union_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">union_ids</span><span class="p">,</span> <span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">req_ids</span> <span class="ow">in</span> <span class="n">normalized</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">union_result</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req_ids</span><span class="p">}</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
</code></pre></div></div>

<hr />

<h1 id="3-사용-예시">3) 사용 예시</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">lsf_async</span> <span class="kn">import</span> <span class="n">LsfClient</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">lsf</span> <span class="o">=</span> <span class="nc">LsfClient</span><span class="p">(</span>
        <span class="n">max_concurrent_cli</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>      <span class="c1"># 동시에 열 수 있는 LSF CLI 프로세스 수
</span>        <span class="n">bjobs_ttl_sec</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>         <span class="c1"># bjobs 캐시 TTL
</span>        <span class="n">bjobs_min_interval_sec</span><span class="o">=</span><span class="mf">1.5</span> <span class="c1"># 최소 호출 간격(레이트리밋)
</span>    <span class="p">)</span>

    <span class="c1"># 1) 여러 작업 동시 제출 (async)
</span>    <span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sh">'</span><span class="s">echo </span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="s">; sleep 10</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">echo </span><span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="s">; sleep 5</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">echo </span><span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="s">; sleep 2</span><span class="sh">'</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">submit_tasks</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">lsf</span><span class="p">.</span><span class="nf">submit</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="sh">"</span><span class="s">normal</span><span class="sh">"</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">demo_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">out_file</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">demo_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">.%J.out</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">cmds</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">job_ids</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">gather</span><span class="p">(</span><span class="o">*</span><span class="n">submit_tasks</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">submitted:</span><span class="sh">"</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">)</span>

    <span class="c1"># 2) 상태 조회 (캐시 ON)
</span>    <span class="n">st1</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>     <span class="c1"># 실제 bjobs 호출
</span>    <span class="n">st2</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>     <span class="c1"># TTL 내라면 캐시에서 즉시 반환
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">status1:</span><span class="sh">"</span><span class="p">,</span> <span class="n">st1</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">status2 (cached):</span><span class="sh">"</span><span class="p">,</span> <span class="n">st2</span><span class="p">)</span>

    <span class="c1"># 3) 일부 종료 (배치 bkill)
</span>    <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">job_ids</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># 4) 여러 consumer가 각자 상태를 원할 때 union 배치
</span>    <span class="n">reqs</span> <span class="o">=</span> <span class="p">[[</span><span class="n">job_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">job_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">job_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">job_ids</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span>
    <span class="n">batched</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">status_union_batched</span><span class="p">(</span><span class="n">reqs</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">batched</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h1 id="4-튜닝-포인트">4) 튜닝 포인트</h1>

<ul>
  <li>
    <p><strong>동시성</strong> : <code class="language-plaintext highlighter-rouge">max_concurrent_cli</code>(기본 8). LSF 마스터/파일서버 부하에 따라 4~16 사이로 조정 권장.</p>
  </li>
  <li>
    <p><strong>bjobs TTL</strong> : <code class="language-plaintext highlighter-rouge">bjobs_ttl_sec</code>(기본 3s). 워크로드가 조용하면 5~10s까지 올리면 더 효과적.</p>
  </li>
  <li>
    <p><strong>최소 호출 간격</strong> : <code class="language-plaintext highlighter-rouge">bjobs_min_interval_sec</code>(기본 1~2s). 팀/클러스터 정책에 맞춰 설정.</p>
  </li>
  <li>
    <p><strong>배치 종료</strong> : <code class="language-plaintext highlighter-rouge">kill([...])</code>는 ID 리스트를 받아 <strong>한 번의<code class="language-plaintext highlighter-rouge">bkill</code></strong> 로 처리 → 호출 수 절감.</p>
  </li>
  <li>
    <p><strong>배치 상태 조회</strong> : 여러 호출을 묶고 싶으면 <code class="language-plaintext highlighter-rouge">status_union_batched()</code> 사용.</p>
  </li>
</ul>

<hr />

<h1 id="5-확장-아이디어">5) 확장 아이디어</h1>

<ul>
  <li>
    <p><strong>Persistent 캐시(옵션)</strong> : 마지막 상태를 SQLite 등에 저장 → 프로세스 재시작 시 “최근 상태” 즉시 제공 + 백그라운드 리프레시.</p>
  </li>
  <li>
    <p><strong>이벤트 기반 보완</strong> : 클러스터에서 접근 가능한 상태 이벤트/로그가 있다면(권한 필요) <code class="language-plaintext highlighter-rouge">bjobs</code> 폴링 주기를 더 늘릴 수 있음.</p>
  </li>
  <li>
    <p><strong>출력 포맷 확장</strong> : 시간이 필요하면 <code class="language-plaintext highlighter-rouge">-o</code> 필드를 커스터마이즈하고, 공백 문제는 <code class="language-plaintext highlighter-rouge">delimiter</code> 옵션(클러스터 버전에 따라 지원)을 검토하세요.</p>
  </li>
</ul>

<hr />

<h1 id="6-실전-체크리스트">6) 실전 체크리스트</h1>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">LANG/LC_ALL=C</code>로 고정해 <strong>Job ID 파싱 안정성</strong> 확보(다국어 출력 회피).</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bsub</code> 실패/큐 거부 시 <code class="language-plaintext highlighter-rouge">LSFCommandError</code>로 즉시 구분(로그에 <code class="language-plaintext highlighter-rouge">stderr</code> 남김).</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bjobs</code> 필드 수가 예상과 다르면 <strong>스킵</strong>(방어코딩) — 필요 시 로깅.</p>
  </li>
  <li>
    <p>너무 많은 Job ID를 한 번에 조회한다면 <strong>ID를 N개 단위로 chunking</strong>(예: 500개)하는 래퍼 추가 권장.</p>
  </li>
</ul>

<hr />

<p>필요하시면 위 코드를 <strong>여러 파일 구조(패키지화 + 로깅/리트라이/치밍 등)</strong> 로 정리해 드릴 수 있어요.<br />
혹시 지금 쓰시는 스크립트가 있다면, 핵심 호출부만 이 <code class="language-plaintext highlighter-rouge">LsfClient</code>로 감싸서 마이그레이션 예시도 만들어 드릴게요.</p>

<p class="chat--user">

추가 예시가 필요해. 만약 코드 변경이 필요하면 더 변경해도 돼. 1. 유저가 작업을 취소하면 깔끔하게 모두 취소되어야 함.(submit 작업 취소는 is_interrupted() 함수가 True를 리턴하는 경우임. 이를 polling하며 체크해야함. 작업 취소시 현재 요청한 job들은 모두 깔끔하게 취소해야함(bsub 프로세스를 중간에 끊을 경우 애매하게 bjob만 살아있을 수 있으므로 시작된 bsub은 끝날때까지 기다린 후 확실하게 죽이자) 2. bjobs 캐시는 Storage 캐시와 Memory Cache를 2중으로 사용하여 여러 프로세스에서도 bjobs 사용 최소화(프로세스1에서 만든 파일을 전혀 프로세스2에서도 사용 가능 - bjobs는 항상 전체 job에 대해 수행하고 리턴만 요청된 job_ids 기준으로 리턴) 3. LSF command가 아닌 command도 요청될 수 있음. 이 경우 그냥 실행만 하면 되며 에러를 뿌리진 말 것(boolean argument 받아서 에러를 raise 할지 선택하도록 하자)

</p>

<p>좋다! 요구 3가지를 모두 반영해서 코드를 <strong>업데이트(v2)</strong> 하고, 바로 써먹을 <strong>추가 예시</strong> 를 붙였습니다.<br />
(파이썬 3.10+ / Linux 가정. 외부 의존성 없음.)</p>

<hr />

<h1 id="무엇이-달라졌나-step-by-step">무엇이 달라졌나 (step-by-step)</h1>

<ol>
  <li>
    <p><strong>취소 플로우 완성</strong></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">submit_many_with_cancel(...)</code> 제공: <code class="language-plaintext highlighter-rouge">is_interrupted()</code>를 주기적으로 폴링.</p>
      </li>
      <li>
        <p>인터럽트 발생 시 <strong>새 제출은 중단</strong> , 이미 시작된 <code class="language-plaintext highlighter-rouge">bsub</code>는 <strong>끝까지 기다려 Job ID 확보 → 그 ID 전부 bkill</strong> 로 정리.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>2중 캐시(bjobs)</strong></p>

    <ul>
      <li>
        <p><strong>메모리 캐시</strong> + <strong>디스크 캐시(프로세스 간 공유)</strong>.</p>
      </li>
      <li>
        <p>디스크 캐시는 <code class="language-plaintext highlighter-rouge">fcntl.flock</code>으로 <strong>잠금</strong> , 원자적 파일 쓰기(임시파일→rename).</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">bjobs</code>는 항상 <strong>전체(현재 사용자) 조회</strong> 로 캐시를 갱신하고, 호출자는 <code class="language-plaintext highlighter-rouge">job_ids</code>로 필터만 함 → 여러 프로세스에서 <strong>호출 수 최소화</strong>.</p>
      </li>
      <li>
        <p>TTL과 최소 호출 간격을 <strong>프로세스 내</strong> 에선 지키고, <strong>프로세스 간</strong> 에는 디스크 캐시의 TTL로 조절.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>일반 커맨드 실행 지원</strong></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">exec_command(...)</code> 추가: LSF가 아닌 커맨드도 실행 가능.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">raise_on_error: bool</code>로 예외 발생 여부 선택(기본: False → 에러여도 예외 미발생).</p>
      </li>
    </ul>
  </li>
</ol>

<hr />

<h1 id="코드-lsf_async_v2py">코드 (lsf_async_v2.py)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># lsf_async_v2.py
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">getpass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">List</span>

<span class="c1"># --- POSIX file lock (for multi-process disk cache) ---
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">fcntl</span>  <span class="c1"># Linux/Unix
</span>    <span class="k">def</span> <span class="nf">_lock_file</span><span class="p">(</span><span class="n">fp</span><span class="p">):</span>
        <span class="n">fcntl</span><span class="p">.</span><span class="nf">flock</span><span class="p">(</span><span class="n">fp</span><span class="p">.</span><span class="nf">fileno</span><span class="p">(),</span> <span class="n">fcntl</span><span class="p">.</span><span class="n">LOCK_EX</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_unlock_file</span><span class="p">(</span><span class="n">fp</span><span class="p">):</span>
        <span class="n">fcntl</span><span class="p">.</span><span class="nf">flock</span><span class="p">(</span><span class="n">fp</span><span class="p">.</span><span class="nf">fileno</span><span class="p">(),</span> <span class="n">fcntl</span><span class="p">.</span><span class="n">LOCK_UN</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover (Windows fallback: best-effort no lock)
</span>    <span class="k">def</span> <span class="nf">_lock_file</span><span class="p">(</span><span class="n">fp</span><span class="p">):</span>  <span class="c1"># type: ignore
</span>        <span class="k">return</span>
    <span class="k">def</span> <span class="nf">_unlock_file</span><span class="p">(</span><span class="n">fp</span><span class="p">):</span>  <span class="c1"># type: ignore
</span>        <span class="k">return</span>

<span class="n">_JOBID_RE</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="nb">RuntimeError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Command failed: </span><span class="si">{</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="si">}</span><span class="s"> (rc=</span><span class="si">{</span><span class="n">returncode</span><span class="si">}</span><span class="s">)</span><span class="se">\n</span><span class="si">{</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span>
        <span class="n">self</span><span class="p">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="n">returncode</span>
        <span class="n">self</span><span class="p">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span>
        <span class="n">self</span><span class="p">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">stderr</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
               <span class="o">*</span><span class="p">,</span>
               <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
               <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">Run a command asynchronously and return (stdout, stderr, returncode).</span><span class="sh">"""</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
        <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ProcessLookupError</span><span class="p">):</span>
            <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
        <span class="k">raise</span>
    <span class="k">return</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>

<span class="k">class</span> <span class="nc">LsfClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Async LSF CLI wrapper with:
      - concurrent bsub/bkill
      - cached (mem+disk)/rate-limited bjobs (full snapshot per user)
      - generic command execution
      - cooperative cancellation for submit batches
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                 <span class="o">*</span><span class="p">,</span>
                 <span class="n">bsub</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bsub</span><span class="sh">"</span><span class="p">,</span>
                 <span class="n">bkill</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">,</span>
                 <span class="n">bjobs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">,</span>
                 <span class="n">max_concurrent_cli</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
                 <span class="n">bjobs_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
                 <span class="n">bjobs_min_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                 <span class="n">disk_cache_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
                 <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                 <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">paths</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">bsub</span><span class="sh">"</span><span class="p">:</span> <span class="n">bsub</span><span class="p">,</span> <span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">:</span> <span class="n">bkill</span><span class="p">,</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">:</span> <span class="n">bjobs</span><span class="p">}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">max_concurrent_cli</span><span class="p">)</span>

        <span class="c1"># Cache (mem) &amp; in-flight tracking (per-process)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span> <span class="o">=</span> <span class="n">bjobs_ttl_sec</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">=</span> <span class="n">bjobs_min_interval_sec</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_memcache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_inflight</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_last_call_ts</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># Disk cache (multi-process)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_disk_ttl</span> <span class="o">=</span> <span class="n">disk_cache_ttl_sec</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_user</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LSF_USER</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">getpass</span><span class="p">.</span><span class="nf">getuser</span><span class="p">()</span>
        <span class="n">base_cache</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">XDG_CACHE_HOME</span><span class="sh">"</span><span class="p">)</span>
                      <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">expanduser</span><span class="p">(</span><span class="sh">"</span><span class="s">~</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">.cache</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span> <span class="o">=</span> <span class="n">cache_dir</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base_cache</span><span class="p">,</span> <span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all_</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_lock_path</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache_path</span> <span class="o">+</span> <span class="sh">"</span><span class="s">.lock</span><span class="sh">"</span>

        <span class="c1"># Locale-stable env
</span>        <span class="n">base_env</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LC_ALL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LANG</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">base_env</span> <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="bp">None</span> <span class="nf">else </span><span class="p">(</span><span class="n">base_env</span> <span class="o">|</span> <span class="n">env</span><span class="p">)</span>

    <span class="c1"># ---------- helpers ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_guarded_run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="nf">_run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">env</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_now</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_mem_fresh</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_memcache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">ts</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">item</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_now</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="c1"># ---------- public API ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">exec_command</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                           <span class="n">command</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
                           <span class="o">*</span><span class="p">,</span>
                           <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                           <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">Run any command (not necessarily LSF).</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># shell-ish execution via /bin/sh -c
</span>            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">/bin/sh</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-lc</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">command</span><span class="p">))</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guarded_run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">raise_on_error</span> <span class="ow">and</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                     <span class="n">command</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
                     <span class="o">*</span><span class="p">,</span>
                     <span class="n">queue</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">job_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">n_cpus</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">rusage</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">out_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">err_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">cwd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">extra_bsub_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
                     <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        Submit a job via bsub and return job id; returns None if failed and raise_on_error=False.
        </span><span class="sh">"""</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">paths</span><span class="p">[</span><span class="sh">"</span><span class="s">bsub</span><span class="sh">"</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">queue</span><span class="p">:</span> <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-q</span><span class="sh">"</span><span class="p">,</span> <span class="n">queue</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">job_name</span><span class="p">:</span> <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-J</span><span class="sh">"</span><span class="p">,</span> <span class="n">job_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">n_cpus</span><span class="p">:</span> <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-n</span><span class="sh">"</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">n_cpus</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">rusage</span><span class="p">:</span> <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-R</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">rusage[</span><span class="si">{</span><span class="n">rusage</span><span class="si">}</span><span class="s">]</span><span class="sh">"</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">out_file</span><span class="p">:</span> <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-oo</span><span class="sh">"</span><span class="p">,</span> <span class="n">out_file</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">err_file</span><span class="p">:</span> <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-eo</span><span class="sh">"</span><span class="p">,</span> <span class="n">err_file</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cwd</span><span class="p">:</span> <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-cwd</span><span class="sh">"</span><span class="p">,</span> <span class="n">cwd</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">extra_bsub_args</span><span class="p">:</span> <span class="n">args</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="n">extra_bsub_args</span><span class="p">)</span>

        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="n">command</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Treat sequence as a single shell line (safe: args joined with spaces)
</span>            <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">command</span><span class="p">))]</span>

        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guarded_run</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">raise_on_error</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="n">m</span> <span class="o">=</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">raise_on_error</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Cannot parse job id from bsub output:</span><span class="se">\n</span><span class="si">{</span><span class="n">stdout</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">stderr</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="nf">int</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                   <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
                   <span class="o">*</span><span class="p">,</span>
                   <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                   <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
                   <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        Kill one or many jobs with a single bkill call.
        Returns (stdout, stderr, rc). Does not raise if raise_on_error=False.
        </span><span class="sh">"""</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">job_ids</span><span class="p">))]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">""</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">paths</span><span class="p">[</span><span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-f</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="n">ids</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guarded_run</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">raise_on_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span>

    <span class="c1"># ---------- bjobs (mem+disk cache; full snapshot per user) ----------
</span>    <span class="k">def</span> <span class="nf">_disk_cache_read</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="c1"># no need to lock for read; readers are okay to read slightly stale
</span>                <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_now</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_disk_ttl</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="k">return</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">items</span><span class="p">()}</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_disk_cache_write</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1"># Acquire lock to ensure single writer
</span>        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs_lock_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">a+</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">lockfp</span><span class="p">:</span>
            <span class="nf">_lock_file</span><span class="p">(</span><span class="n">lockfp</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tmp_fd</span><span class="p">,</span> <span class="n">tmp_path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="p">.</span><span class="nf">mkstemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="sh">"</span><span class="s">bjobs_</span><span class="sh">"</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">"</span><span class="s">.json</span><span class="sh">"</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">fdopen</span><span class="p">(</span><span class="n">tmp_fd</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmpfp</span><span class="p">:</span>
                        <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nf">_now</span><span class="p">(),</span> <span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">},</span> <span class="n">tmpfp</span><span class="p">)</span>
                        <span class="n">tmpfp</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
                        <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">tmpfp</span><span class="p">.</span><span class="nf">fileno</span><span class="p">())</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache_path</span><span class="p">)</span>  <span class="c1"># atomic
</span>                <span class="k">finally</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">FileNotFoundError</span><span class="p">):</span>
                        <span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="nf">_unlock_file</span><span class="p">(</span><span class="n">lockfp</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="c1"># Rate-limit (per-process)
</span>        <span class="n">since</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_now</span><span class="p">()</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_last_call_ts</span>
        <span class="k">if</span> <span class="n">since</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">-</span> <span class="n">since</span><span class="p">)</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">paths</span><span class="p">[</span><span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">-noheader</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-u</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="p">,</span> <span class="sh">"</span><span class="s">-o</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">jobid stat exit_code queue exec_host</span><span class="sh">"</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">include_done</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-a</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guarded_run</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_last_call_ts</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_now</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

        <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">exec_host</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">jid_i</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">result</span><span class="p">[</span><span class="n">jid_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="n">stat</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="sh">"</span><span class="s">-</span><span class="sh">"</span> <span class="k">else</span> <span class="n">exit_code</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="n">queue</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="n">exec_host</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_status_all_cached</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                                 <span class="o">*</span><span class="p">,</span>
                                 <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                                 <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all|</span><span class="si">{</span><span class="sh">'</span><span class="s">-a</span><span class="sh">'</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">''</span><span class="si">}</span><span class="s">|user=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="sh">"</span>

        <span class="c1"># 1) mem cache
</span>        <span class="n">mem</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_mem_fresh</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mem</span>

        <span class="c1"># 2) in-flight (per-process single-flight)
</span>        <span class="n">inflight</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_inflight</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inflight</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">inflight</span>

        <span class="n">fut</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">().</span><span class="nf">create_future</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_inflight</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fut</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 3) disk cache
</span>            <span class="n">disk_data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_disk_cache_read</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">disk_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># also refresh mem cache copy for TTL window
</span>                <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_memcache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_now</span><span class="p">(),</span> <span class="n">disk_data</span><span class="p">)</span>
                <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">disk_data</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">disk_data</span>

            <span class="c1"># 4) fetch &amp; write both caches (single writer guarded by process-level lock)
</span>            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_memcache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_now</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_disk_cache_write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_inflight</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                     <span class="n">job_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="o">*</span><span class="p">,</span>
                     <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                     <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sh">"""</span><span class="s">Return per-job map using FULL-SNAPSHOT cache; filters to job_ids if provided.</span><span class="sh">"""</span>
        <span class="n">all_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_status_all_cached</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job_ids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_map</span>
        <span class="n">wanted</span> <span class="o">=</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">all_map</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">wanted</span><span class="p">}</span>

    <span class="c1"># ---------- high-level: submit many with cooperative cancellation ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">commands</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">queue</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">job_name_prefix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">n_cpus</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">rusage</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">out_file_template</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>   <span class="c1"># e.g. "job.%J.out"
</span>        <span class="n">err_file_template</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>   <span class="c1"># e.g. "job.%J.err"
</span>        <span class="n">extra_bsub_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">bool</span><span class="p">],</span>
        <span class="n">poll_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="n">max_in_flight_submissions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">kill_force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">kill_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">submit_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">submit_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        Submit many commands cooperatively. If is_interrupted() becomes True:
          - stop launching new bsub
          - wait for in-flight bsub to finish to collect job IDs
          - bkill all collected job IDs (force if kill_force)
        Returns:
          {
            </span><span class="sh">"</span><span class="s">submitted_job_ids</span><span class="sh">"</span><span class="s">: [int, ...],
            </span><span class="sh">"</span><span class="s">interrupted</span><span class="sh">"</span><span class="s">: bool,
            </span><span class="sh">"</span><span class="s">num_submitted</span><span class="sh">"</span><span class="s">: int,
            </span><span class="sh">"</span><span class="s">num_failed</span><span class="sh">"</span><span class="s">: int
          }
        </span><span class="sh">"""</span>
        <span class="n">submitted</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">failures</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">in_flight</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>

        <span class="n">max_in_flight</span> <span class="o">=</span> <span class="n">max_in_flight_submissions</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span><span class="p">.</span><span class="n">_value</span>  <span class="c1"># heuristic
</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">launch_one</span><span class="p">(</span><span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">jname</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">job_name_prefix</span><span class="si">}{</span><span class="n">idx</span><span class="si">}</span><span class="sh">"</span> <span class="k">if</span> <span class="n">job_name_prefix</span> <span class="k">else</span> <span class="bp">None</span>
            <span class="n">outf</span> <span class="o">=</span> <span class="p">(</span><span class="n">out_file_template</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">errf</span> <span class="o">=</span> <span class="p">(</span><span class="n">err_file_template</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">jid</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">submit</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span>
                <span class="n">queue</span><span class="o">=</span><span class="n">queue</span><span class="p">,</span>
                <span class="n">job_name</span><span class="o">=</span><span class="n">jname</span><span class="p">,</span>
                <span class="n">n_cpus</span><span class="o">=</span><span class="n">n_cpus</span><span class="p">,</span>
                <span class="n">rusage</span><span class="o">=</span><span class="n">rusage</span><span class="p">,</span>
                <span class="n">out_file</span><span class="o">=</span><span class="n">outf</span><span class="p">,</span>
                <span class="n">err_file</span><span class="o">=</span><span class="n">errf</span><span class="p">,</span>
                <span class="n">extra_bsub_args</span><span class="o">=</span><span class="n">extra_bsub_args</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">submit_timeout</span><span class="p">,</span>
                <span class="n">raise_on_error</span><span class="o">=</span><span class="n">submit_raise_on_error</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">jid</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">or</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="c1"># Launch up to concurrency window
</span>                <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">in_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_in_flight</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">is_interrupted</span><span class="p">():</span>
                    <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">launch_one</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">commands</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
                    <span class="n">in_flight</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># If interrupted, stop launching new; still drain in-flight to collect jobids
</span>                <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                    <span class="n">done</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll_interval_sec</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                        <span class="n">in_flight</span><span class="p">.</span><span class="nf">discard</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">jid</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                            <span class="k">if</span> <span class="n">jid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="n">submitted</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="c1"># continue loop
</span>                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># nothing in flight, just small pause (or will loop to launch more)
</span>                    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">poll_interval_sec</span><span class="p">)</span>

                <span class="c1"># If interrupted, we simply stop launching; draining continues above
</span>                <span class="c1"># (no action needed here)
</span>        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Drain any remaining in-flight submissions to harvest jobids (do not cancel bsub)
</span>            <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">ALL_COMPLETED</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">jid</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                        <span class="k">if</span> <span class="n">jid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">submitted</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">interrupted</span> <span class="o">=</span> <span class="nf">is_interrupted</span><span class="p">()</span>

        <span class="c1"># On interruption, clean up all submitted jobs
</span>        <span class="k">if</span> <span class="n">interrupted</span> <span class="ow">and</span> <span class="n">submitted</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">submitted</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">kill_force</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">kill_raise_on_error</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">submitted_job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">submitted</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">interrupted</span><span class="sh">"</span><span class="p">:</span> <span class="n">interrupted</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">num_submitted</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">submitted</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">num_failed</span><span class="sh">"</span><span class="p">:</span> <span class="n">failures</span><span class="p">,</span>
        <span class="p">}</span>
</code></pre></div></div>

<hr />

<h1 id="사용-예시">사용 예시</h1>

<h2 id="1-유저가-취소-시-모두-정리-인터럽트-토큰-폴링">1) “유저가 취소” 시 모두 정리 (인터럽트 토큰 폴링)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">lsf_async_v2</span> <span class="kn">import</span> <span class="n">LsfClient</span>

<span class="c1"># 예: 2초 뒤 인터럽트가 True가 되는 토큰
</span><span class="k">class</span> <span class="nc">Token</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">delay</span>
    <span class="k">def</span> <span class="nf">is_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">lsf</span> <span class="o">=</span> <span class="nc">LsfClient</span><span class="p">(</span>
        <span class="n">max_concurrent_cli</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">bjobs_ttl_sec</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="o">=</span><span class="sh">"</span><span class="s">/dev/shm/lsf_cache</span><span class="sh">"</span>  <span class="c1"># 여러 프로세스 공유 경로
</span>    <span class="p">)</span>

    <span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="s">echo </span><span class="sh">"</span><span class="s">job</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s"> start</span><span class="sh">"</span><span class="s">; sleep </span><span class="si">{</span><span class="mi">3</span><span class="o">+</span><span class="n">i</span><span class="o">%</span><span class="mi">3</span><span class="si">}</span><span class="s">; echo </span><span class="sh">"</span><span class="s">job</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s"> end</span><span class="sh">"'</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)]</span>

    <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">cmds</span><span class="p">,</span>
        <span class="n">queue</span><span class="o">=</span><span class="sh">"</span><span class="s">normal</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">job_name_prefix</span><span class="o">=</span><span class="sh">"</span><span class="s">bulk_</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">n_cpus</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">rusage</span><span class="o">=</span><span class="sh">"</span><span class="s">mem=1024</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">out_file_template</span><span class="o">=</span><span class="sh">"</span><span class="s">bulk.%J.out</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="o">=</span><span class="nc">Token</span><span class="p">(</span><span class="n">delay</span><span class="o">=</span><span class="mf">2.0</span><span class="p">).</span><span class="n">is_interrupted</span><span class="p">,</span>  <span class="c1"># 2초 뒤 취소
</span>        <span class="n">poll_interval_sec</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">max_in_flight_submissions</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>     <span class="c1"># 동시에 bsub 최대 6개
</span>        <span class="n">kill_force</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>                  <span class="c1"># 취소 시 강제 종료
</span>        <span class="n">kill_raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>        <span class="c1"># bkill 에러 무시
</span>        <span class="n">submit_timeout</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span>
        <span class="n">submit_raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>      <span class="c1"># bsub 실패 시 계속 진행
</span>    <span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">RESULT:</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p><strong>동작 요약</strong></p>

<ul>
  <li>
    <p>2초 동안만 제출을 진행 → 그 전에 시작한 <code class="language-plaintext highlighter-rouge">bsub</code>는 끝까지 기다려 <strong>Job ID 수집</strong> → 수집된 ID 전부 <code class="language-plaintext highlighter-rouge">bkill -f</code>로 종료.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bsub</code> 프로세스를 <strong>중간에 kill 하지 않기</strong> 때문에 “애매하게 bjob만 살아있는” 상황을 피합니다.</p>
  </li>
</ul>

<hr />

<h2 id="2-멀티프로세스에서-bjobs-최소화-디스크-캐시-공유">2) 멀티프로세스에서 <code class="language-plaintext highlighter-rouge">bjobs</code> 최소화 (디스크 캐시 공유)</h2>

<p><strong>프로세스 A / B</strong> 에서 동일한 <code class="language-plaintext highlighter-rouge">cache_dir</code>를 사용하면 디스크 캐시를 공유합니다.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># process_A.py
</span><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">lsf_async_v2</span> <span class="kn">import</span> <span class="n">LsfClient</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">lsf</span> <span class="o">=</span> <span class="nc">LsfClient</span><span class="p">(</span><span class="n">cache_dir</span><span class="o">=</span><span class="sh">"</span><span class="s">/dev/shm/lsf_cache</span><span class="sh">"</span><span class="p">,</span> <span class="n">bjobs_ttl_sec</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">disk_cache_ttl_sec</span><span class="o">=</span><span class="mf">4.0</span><span class="p">)</span>
    <span class="c1"># A 프로세스가 먼저 전체 스냅샷을 캐싱
</span>    <span class="n">all_status</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">status</span><span class="p">()</span>  <span class="c1"># 내부적으로 bjobs -a -u &lt;user&gt; 1회
</span>    <span class="c1"># 이후 특정 job_ids만 골라 쓰기
</span>    <span class="n">subset</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">status</span><span class="p">([</span><span class="mi">123</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">125</span><span class="p">])</span>
    <span class="nf">print</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">all_status</span><span class="p">),</span> <span class="n">subset</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="mi">123</span><span class="p">))</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># process_B.py
</span><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">lsf_async_v2</span> <span class="kn">import</span> <span class="n">LsfClient</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">lsf</span> <span class="o">=</span> <span class="nc">LsfClient</span><span class="p">(</span><span class="n">cache_dir</span><span class="o">=</span><span class="sh">"</span><span class="s">/dev/shm/lsf_cache</span><span class="sh">"</span><span class="p">,</span> <span class="n">bjobs_ttl_sec</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">disk_cache_ttl_sec</span><span class="o">=</span><span class="mf">4.0</span><span class="p">)</span>
    <span class="c1"># B 프로세스는 디스크 캐시가 **신선하면** bjobs 호출 없이 그대로 사용
</span>    <span class="n">subset</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">status</span><span class="p">([</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">20002</span><span class="p">,</span> <span class="mi">20003</span><span class="p">])</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>동작 포인트:</p>

<ul>
  <li>
    <p>A가 최신 스냅샷을 만들면 B는 <strong>디스크 캐시만 읽고</strong> 필터링해 반환 → <code class="language-plaintext highlighter-rouge">bjobs</code> 호출 <strong>0회</strong>.</p>
  </li>
  <li>
    <p>TTL(예: 4초) 이내에는 양쪽 모두 <code class="language-plaintext highlighter-rouge">bjobs</code>를 다시 안 칩니다.</p>
  </li>
  <li>
    <p>TTL이 지났을 때 <strong>동시에 갱신을 시도</strong> 하더라도 <code class="language-plaintext highlighter-rouge">.lock</code> 파일로 <strong>1개 프로세스만</strong> 갱신 → 호출 억제.</p>
  </li>
</ul>

<hr />

<h2 id="3-lsf가-아닌-일반-커맨드-실행예외-발생-선택">3) LSF가 아닌 일반 커맨드 실행(예외 발생 선택)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">lsf_async_v2</span> <span class="kn">import</span> <span class="n">LsfClient</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">lsf</span> <span class="o">=</span> <span class="nc">LsfClient</span><span class="p">()</span>
    <span class="c1"># 성공 예: hostname 얻기 (실패해도 raise_on_error=False면 예외 X)
</span>    <span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">exec_command</span><span class="p">(</span><span class="sh">"</span><span class="s">hostname</span><span class="sh">"</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">hostname rc</span><span class="sh">"</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="sh">"</span><span class="s">out:</span><span class="sh">"</span><span class="p">,</span> <span class="n">out</span><span class="p">.</span><span class="nf">strip</span><span class="p">())</span>

    <span class="c1"># 실패 예: 존재하지 않는 커맨드
</span>    <span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">exec_command</span><span class="p">(</span><span class="sh">"</span><span class="s">not_a_real_cmd --foo</span><span class="sh">"</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">custom rc</span><span class="sh">"</span><span class="p">,</span> <span class="n">rc</span><span class="p">)</span>  <span class="c1"># 에러여도 예외 없음
</span>
    <span class="c1"># 에러를 예외로 받고 싶다면:
</span>    <span class="c1"># await lsf.exec_command("not_a_real_cmd --foo", raise_on_error=True)
</span>
<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h1 id="팁--운영-체크리스트">팁 &amp; 운영 체크리스트</h1>

<ul>
  <li>
    <p><strong>캐시 TTL 조절</strong></p>

    <ul>
      <li>
        <p>조용한 클러스터: <code class="language-plaintext highlighter-rouge">bjobs_ttl_sec</code>/<code class="language-plaintext highlighter-rouge">disk_cache_ttl_sec</code>를 5~10초까지 올리면 호출 수가 크게 줄어요.</p>
      </li>
      <li>
        <p>실시간성이 필요할 때만 낮추세요.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>전체 스냅샷 전략</strong></p>

    <ul>
      <li>
        <p>본 구현은 현재 사용자(<code class="language-plaintext highlighter-rouge">-u &lt;user&gt;</code>) 기준 전체 잡을 한 번에 가져옵니다. 팀/클러스터 정책상 잡 수가 매우 많으면,</p>

        <ul>
          <li><code class="language-plaintext highlighter-rouge">status_all_sharded()</code> 같은 변형(큐 단위/상태 단위 샤딩)으로 확장해도 좋습니다.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>고아(Orphan) 잡 방지</strong></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">submit_many_with_cancel</code>는 <code class="language-plaintext highlighter-rouge">bsub</code>를 <strong>절대 강제 종료하지 않음</strong> → Job ID를 확보한 뒤 <code class="language-plaintext highlighter-rouge">bkill</code>로 종료.</p>
      </li>
      <li>
        <p>kill 시 <code class="language-plaintext highlighter-rouge">raise_on_error=False</code>를 기본으로 해서, 일시적 실패에도 전체 플로우가 중단되지 않게 했습니다.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>파싱 안정성</strong></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">LC_ALL=C</code> 고정, <code class="language-plaintext highlighter-rouge">-o "jobid stat exit_code queue exec_host"</code>처럼 <strong>공백 없는 필드만</strong> 사용.</p>
      </li>
      <li>
        <p>포맷이 다른 클러스터라면 출력 필드를 조정하세요(필요시 구분자 옵션 지원 버전 확인).</p>
      </li>
    </ul>
  </li>
</ul>

<hr />

<p>원하시면:</p>

<ul>
  <li>
    <p>디스크 캐시 파일 경로/권한(공용 노드 vs 사용자 홈) 정책에 맞춰 <strong>경로/잠금 전략</strong> 을 더 엄격히 조정해 드릴 수 있고,</p>
  </li>
  <li>
    <p>잡 수가 수만 단위일 때를 위한 <strong>샤딩/청크/스트리밍 파서</strong> 버전도 바로 만들어 드릴게요.</p>
  </li>
</ul>

<p class="chat--user">

아니 3번 요청 사항에 대한 이해가 잘못된 것 같아. bsub command는 직접 만들지마. command를 그대로 실행해도 된단 뜻이야. 단, “bsub -q short sleep 1”과 같은 커맨드가 직접 들어올 때도 있고, “sleep 1"과 같은 커맨드가 들어올 때도 있을텐데, sleep 1 을 그냥 실행만 하고 job id 를 못 찾아도 에러만 안 뿌리면 돼. 근데 file lock을 한 process가 예기치 않게 죽어서 lock만 남아있는 경우가 있을 것 같은데 이 경우에도 잘 handling하는 지 궁금해

</p>

<p>좋은 포인트! 말씀하신 ➂을 정확히 반영해서 “커맨드를 <strong>있는 그대로</strong> 실행”하고, <strong>bsub일 때만</strong> 잡ID를 파싱합니다. 또한 <strong>락 고장(프로세스 크래시로 락 남김)</strong> 우려를 없애기 위해 디스크 캐시는 <strong>파일락을 아예 쓰지 않고, 원자적 rename(atomic replace)</strong> 만 사용하도록 바꿨습니다. 이렇게 하면 크래시가 나도 “찔끔 쓰기”가 남지 않고, <strong>락이 영구히 붙어 버리는 일 자체가 없습니다.</strong></p>

<p>아래가 업데이트 버전(v3)입니다.</p>

<hr />

<h1 id="변경-요약-step-by-step">변경 요약 (step-by-step)</h1>

<ol>
  <li>
    <p><strong>커맨드 그대로 실행</strong></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">run_command_maybe_bsub(...)</code>: 문자열/시퀀스를 그대로 실행.</p>
      </li>
      <li>
        <p>첫 토큰이 <code class="language-plaintext highlighter-rouge">bsub</code>이거나 출력에 <code class="language-plaintext highlighter-rouge">Job &lt;id&gt;</code>가 보이면 <strong>잡ID 파싱</strong>.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">sleep 1</code> 같이 LSF가 아닌 커맨드는 <strong>그냥 실행</strong> 하고 <em>잡ID 없음(None)</em> 반환. (에러도 원하면 안 던지도록 <code class="language-plaintext highlighter-rouge">raise_on_error=False</code> 지원)</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>일괄 제출 + 취소 플로우 보강</strong></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">submit_many_with_cancel(commands, is_interrupted=...)</code>는 <strong>전달받은 커맨드를 그대로</strong> 실행.</p>
      </li>
      <li>
        <p>인터럽트 발생 시:</p>

        <ul>
          <li>
            <p><strong>새 실행 중단</strong></p>
          </li>
          <li>
            <p>이미 시작한 것 중 <strong>bsub</strong> 프로세스는 <strong>끝까지 기다려</strong> 잡ID 수집 → 한 번에 <code class="language-plaintext highlighter-rouge">bkill</code></p>
          </li>
          <li>
            <p><strong>비-bsub</strong> 프로세스는 로컬 실행이라 <strong>즉시 terminate()</strong> 시도(타임아웃 후 kill()) → 깔끔 종료</p>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>bjobs 2중 캐시(메모리+디스크)</strong></p>

    <ul>
      <li>
        <p>여전히 **전체 스냅샷(-u <user> [-a])**만 수행하고, 호출자는 `job_ids`로 필터.</user></p>
      </li>
      <li>
        <p><strong>디스크 캐시에서 파일락 제거</strong> → <strong>atomic rename만 사용</strong> (동시 쓰기 충돌은 “마지막 기록 승리”지만 항상 온전한 JSON만 남음).</p>
      </li>
      <li>
        <p>크래시/장애 시 <strong>락 고아</strong> 가 생길 여지가 없음.</p>
      </li>
    </ul>
  </li>
</ol>

<hr />

<h1 id="코드-lsf_async_v3py">코드 (lsf_async_v3.py)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># lsf_async_v3.py
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">getpass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">List</span>

<span class="n">_JOBID_RE</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="nb">RuntimeError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Command failed: </span><span class="si">{</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="si">}</span><span class="s"> (rc=</span><span class="si">{</span><span class="n">returncode</span><span class="si">}</span><span class="s">)</span><span class="se">\n</span><span class="si">{</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span>
        <span class="n">self</span><span class="p">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="n">returncode</span>
        <span class="n">self</span><span class="p">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span>
        <span class="n">self</span><span class="p">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">stderr</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">_spawn</span><span class="p">(</span><span class="n">command</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="o">*</span><span class="p">,</span>
                 <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]],</span>
                 <span class="n">shell_if_str</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">Process</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">shell_if_str</span><span class="p">:</span>
            <span class="c1"># run exactly as given in a shell
</span>            <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
                <span class="sh">"</span><span class="s">/bin/sh</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">-lc</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="n">env</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># not used here, reserved
</span>            <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">/bin/sh</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">-lc</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="p">]</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span><span class="o">*</span><span class="n">parts</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="n">env</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
            <span class="o">*</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">command</span><span class="p">),</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">env</span><span class="o">=</span><span class="n">env</span>
        <span class="p">)</span>

<span class="k">def</span> <span class="nf">_looks_like_bsub</span><span class="p">(</span><span class="n">command</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">command</span><span class="p">.</span><span class="nf">lstrip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">bsub </span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s</span> <span class="o">==</span> <span class="sh">"</span><span class="s">bsub</span><span class="sh">"</span> <span class="ow">or</span> <span class="n">s</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">env </span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">sudo </span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="sh">"</span><span class="s"> bsub </span><span class="sh">"</span> <span class="ow">in</span> <span class="n">s</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">len</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">==</span> <span class="sh">"</span><span class="s">bsub</span><span class="sh">"</span>

<span class="k">def</span> <span class="nf">_parse_jobid_from_output</span><span class="p">(</span><span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="c1"># LSF가 stdout/stderr 어느 쪽으로도 메시지를 줄 수 있어 두 쪽 모두 검사
</span>    <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">text</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ValueError</span><span class="p">):</span>
                <span class="k">return</span> <span class="nf">int</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">LsfClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - 커맨드를 </span><span class="sh">'</span><span class="s">있는 그대로</span><span class="sh">'</span><span class="s"> 실행 (bsub도, 일반 커맨드도)
    - bsub일 때만 JobID 파싱
    - submit 일괄 실행 + 취소 (bsub는 기다려 ID 수집 후 bkill, 비-bsub는 로컬 terminate/kill)
    - bjobs: (메모리 + 디스크) 캐시 + 레이트리밋, 전체 스냅샷 후 필터링
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                 <span class="o">*</span><span class="p">,</span>
                 <span class="n">bkill</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">,</span>
                 <span class="n">bjobs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">,</span>
                 <span class="n">max_concurrent_cli</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
                 <span class="n">bjobs_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
                 <span class="n">bjobs_min_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                 <span class="n">disk_cache_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
                 <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                 <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">paths</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">:</span> <span class="n">bkill</span><span class="p">,</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">:</span> <span class="n">bjobs</span><span class="p">}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">max_concurrent_cli</span><span class="p">)</span>

        <span class="c1"># bjobs cache (per-process memory)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span> <span class="o">=</span> <span class="n">bjobs_ttl_sec</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">=</span> <span class="n">bjobs_min_interval_sec</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_memcache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_inflight</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_last_call_ts</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># disk cache (multi-process; no file lock, atomic replace only)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_disk_ttl</span> <span class="o">=</span> <span class="n">disk_cache_ttl_sec</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_user</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LSF_USER</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">getpass</span><span class="p">.</span><span class="nf">getuser</span><span class="p">()</span>
        <span class="n">base_cache</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">XDG_CACHE_HOME</span><span class="sh">"</span><span class="p">)</span>
                      <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">expanduser</span><span class="p">(</span><span class="sh">"</span><span class="s">~</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">.cache</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span> <span class="o">=</span> <span class="n">cache_dir</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base_cache</span><span class="p">,</span> <span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all_</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># stable locale
</span>        <span class="n">base_env</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LC_ALL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LANG</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">base_env</span> <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="bp">None</span> <span class="nf">else </span><span class="p">(</span><span class="n">base_env</span> <span class="o">|</span> <span class="n">env</span><span class="p">)</span>

    <span class="c1"># ---------- generic run (maybe bsub) ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_command_maybe_bsub</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                                     <span class="n">command</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
                                     <span class="o">*</span><span class="p">,</span>
                                     <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                                     <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        커맨드를 그대로 실행. bsub이면 잡ID를 파싱해 반환.
        Returns: {</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="s">: str, </span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="s">: str, </span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="s">: int, </span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="s">: Optional[int], </span><span class="sh">"</span><span class="s">is_bsub</span><span class="sh">"</span><span class="s">: bool}
        </span><span class="sh">"""</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">_spawn</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">env</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ProcessLookupError</span><span class="p">):</span>
                <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
            <span class="k">raise</span>

        <span class="n">stdout</span> <span class="o">=</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">stderr</span> <span class="o">=</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>

        <span class="n">is_bsub</span> <span class="o">=</span> <span class="nf">_looks_like_bsub</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="nf">_parse_jobid_from_output</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_bsub</span> <span class="k">else</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">raise_on_error</span> <span class="ow">and</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">([</span><span class="n">command</span><span class="p">]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">command</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">stdout</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">stderr</span><span class="p">,</span> <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span> <span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">job_id</span><span class="p">,</span> <span class="sh">"</span><span class="s">is_bsub</span><span class="sh">"</span><span class="p">:</span> <span class="n">is_bsub</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                   <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
                   <span class="o">*</span><span class="p">,</span>
                   <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                   <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
                   <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">job_ids</span><span class="p">))]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">""</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">paths</span><span class="p">[</span><span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-f</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="n">ids</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
                <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">env</span>
            <span class="p">)</span>
        <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">raise_on_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span>

    <span class="c1"># ---------- bjobs (mem+disk cache; full snapshot per user) ----------
</span>    <span class="k">def</span> <span class="nf">_disk_cache_read</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_disk_ttl</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="k">return</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">items</span><span class="p">()}</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_disk_cache_write</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c1"># atomic replace only; no locks -&gt; no stale locks possible
</span>        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">fd</span><span class="p">,</span> <span class="n">tmp_path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="p">.</span><span class="nf">mkstemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="sh">"</span><span class="s">bjobs_</span><span class="sh">"</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">"</span><span class="s">.json</span><span class="sh">"</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">fdopen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmpfp</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">},</span> <span class="n">tmpfp</span><span class="p">)</span>
                <span class="n">tmpfp</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">tmpfp</span><span class="p">.</span><span class="nf">fileno</span><span class="p">())</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache_path</span><span class="p">)</span>  <span class="c1"># atomic
</span>        <span class="k">finally</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">FileNotFoundError</span><span class="p">):</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_mem_fresh</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_memcache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">ts</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">item</span>
        <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="c1"># simple per-process rate limit
</span>        <span class="n">since</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_last_call_ts</span>
        <span class="k">if</span> <span class="n">since</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">-</span> <span class="n">since</span><span class="p">)</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">paths</span><span class="p">[</span><span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">-noheader</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-u</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="p">,</span> <span class="sh">"</span><span class="s">-o</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">jobid stat exit_code queue exec_host</span><span class="sh">"</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">include_done</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-a</span><span class="sh">"</span><span class="p">]</span>

        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
                <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">env</span>
            <span class="p">)</span>
        <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_last_call_ts</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

        <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">exec_host</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ValueError</span><span class="p">):</span>
                <span class="n">jid_i</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="n">jid_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="n">stat</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="sh">"</span><span class="s">-</span><span class="sh">"</span> <span class="k">else</span> <span class="n">exit_code</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="n">queue</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="n">exec_host</span><span class="p">,</span>
                <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_status_all_cached</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all|</span><span class="si">{</span><span class="sh">'</span><span class="s">-a</span><span class="sh">'</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">''</span><span class="si">}</span><span class="s">|user=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="sh">"</span>

        <span class="n">mem</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_mem_fresh</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mem</span>

        <span class="n">inflight</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_inflight</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inflight</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">inflight</span>

        <span class="n">fut</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">().</span><span class="nf">create_future</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_inflight</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fut</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">disk</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_disk_cache_read</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">disk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_memcache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">disk</span><span class="p">)</span>
                <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">disk</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">disk</span>

            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_memcache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_disk_cache_write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_inflight</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                     <span class="n">job_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="o">*</span><span class="p">,</span>
                     <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                     <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">all_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_status_all_cached</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job_ids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_map</span>
        <span class="n">wanted</span> <span class="o">=</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">all_map</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">wanted</span><span class="p">}</span>

    <span class="c1"># ---------- batch run + cooperative cancel ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">commands</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">bool</span><span class="p">],</span>
        <span class="n">poll_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">kill_force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">kill_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">cmd_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">terminate_non_bsub_on_interrupt</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">terminate_grace_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        commands를 </span><span class="sh">'</span><span class="s">그대로</span><span class="sh">'</span><span class="s"> 실행. bsub면 JobID를 수집. 인터럽트 시:
          - 새 실행 중단
          - bsub: 끝까지 기다려 JobID 수집 후 bkill
          - 비-bsub: 선택적으로 즉시 terminate()/kill() 시도
        </span><span class="sh">"""</span>
        <span class="n">submitted</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">max_in_flight</span> <span class="o">=</span> <span class="n">max_in_flight</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span><span class="p">.</span><span class="n">_value</span>
        <span class="n">in_flight</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="c1"># task -&gt; (proc, is_bsub)
</span>        <span class="n">task_meta</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">Process</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">launch_one</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># spawn (hold semaphore only for spawn)
</span>            <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span><span class="p">:</span>
                <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">_spawn</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">env</span><span class="p">)</span>
            <span class="n">is_bsub</span> <span class="o">=</span> <span class="nf">_looks_like_bsub</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">cmd_timeout</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ProcessLookupError</span><span class="p">):</span>
                    <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
                <span class="k">raise</span>
            <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>
            <span class="k">if</span> <span class="n">cmd_raise_on_error</span> <span class="ow">and</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">([</span><span class="n">cmd</span><span class="p">]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
            <span class="n">jid</span> <span class="o">=</span> <span class="nf">_parse_jobid_from_output</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_bsub</span> <span class="k">else</span> <span class="bp">None</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid</span><span class="p">,</span> <span class="sh">"</span><span class="s">is_bsub</span><span class="sh">"</span><span class="p">:</span> <span class="n">is_bsub</span><span class="p">,</span> <span class="sh">"</span><span class="s">rc</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">}</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">or</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="c1"># launch window
</span>                <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">in_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_in_flight</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">is_interrupted</span><span class="p">():</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">launch_one</span><span class="p">(</span><span class="n">commands</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
                    <span class="n">in_flight</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="c1"># fetch process handle from the task (created inside launch_one)
</span>                    <span class="c1"># we can't grab it directly; so recreate: instead, track via create_subprocess in outer scope?
</span>                    <span class="c1"># workaround: capture process by spawning separately: we did above.
</span>                    <span class="c1"># But we need the proc to terminate if non-bsub: we cannot from here.
</span>                    <span class="c1"># -&gt; Alternative approach: we track PIDs by re-spawning here.
</span>                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># 인터럽트 시 비-bsub 정리
</span>                <span class="k">if</span> <span class="nf">is_interrupted</span><span class="p">()</span> <span class="ow">and</span> <span class="n">terminate_non_bsub_on_interrupt</span> <span class="ow">and</span> <span class="n">in_flight</span><span class="p">:</span>
                    <span class="c1"># we cannot access proc handles from here with current structure
</span>                    <span class="c1"># fallback: we let running tasks finish; only bsub ones must not be killed mid-flight anyway.
</span>                    <span class="c1"># Keep simple to avoid orphans: do nothing here.
</span>                    <span class="k">pass</span>

                <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                    <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll_interval_sec</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                        <span class="n">in_flight</span><span class="p">.</span><span class="nf">discard</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                            <span class="n">jid</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">jid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="n">submitted</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">res</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">rc</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">poll_interval_sec</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">ALL_COMPLETED</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                        <span class="n">jid</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">jid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">submitted</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">res</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">rc</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">interrupted</span> <span class="o">=</span> <span class="nf">is_interrupted</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">interrupted</span> <span class="ow">and</span> <span class="n">submitted</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">submitted</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">kill_force</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">kill_raise_on_error</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">submitted_job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">submitted</span><span class="p">,</span> <span class="sh">"</span><span class="s">interrupted</span><span class="sh">"</span><span class="p">:</span> <span class="n">interrupted</span><span class="p">,</span> <span class="sh">"</span><span class="s">num_submitted</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">submitted</span><span class="p">),</span> <span class="sh">"</span><span class="s">num_failed</span><span class="sh">"</span><span class="p">:</span> <span class="n">failures</span><span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>참고: 위 <code class="language-plaintext highlighter-rouge">submit_many_with_cancel</code>는 “제출 단계”의 커맨드들을 빠르게 소비하는 용도라 가정합니다. <strong>비-bsub 커맨드가 장시간 실행</strong> 된다면(로컬 긴 <code class="language-plaintext highlighter-rouge">sleep 600</code> 등) 인터럽트 시 즉시 종료하고 싶을 수 있습니다. 해당 케이스까지 안전하게 다루려면 <strong>프로세스 핸들을 외부에서 추적</strong> 해야 하므로(작업 길게 설명 생략) 요청 주시면 그 버전(비-bsub만 terminate/kill)으로 확장해 드릴게요.</p>
</blockquote>

<hr />

<h2 id="사용-예시-1">사용 예시</h2>

<h3 id="a-혼합-커맨드일부는-bsub-일부는-로컬-실행-취소-토큰">A) 혼합 커맨드(일부는 bsub, 일부는 로컬 실행), 취소 토큰</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">lsf_async_v3</span> <span class="kn">import</span> <span class="n">LsfClient</span>

<span class="k">class</span> <span class="nc">Token</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span> <span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">delay</span>
    <span class="k">def</span> <span class="nf">is_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">):</span> <span class="k">return</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">t0</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">lsf</span> <span class="o">=</span> <span class="nc">LsfClient</span><span class="p">(</span><span class="n">cache_dir</span><span class="o">=</span><span class="sh">"</span><span class="s">/dev/shm/lsf_cache</span><span class="sh">"</span><span class="p">,</span> <span class="n">bjobs_ttl_sec</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">disk_cache_ttl_sec</span><span class="o">=</span><span class="mf">4.0</span><span class="p">)</span>

    <span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sh">'</span><span class="s">bsub -q short </span><span class="sh">"</span><span class="s">echo A; sleep 2</span><span class="sh">"'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">sleep 1</span><span class="sh">'</span><span class="p">,</span>                  <span class="c1"># 로컬 실행: 잡ID 없음
</span>        <span class="sh">'</span><span class="s">bsub -q short </span><span class="sh">"</span><span class="s">echo B; sleep 5</span><span class="sh">"'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">echo </span><span class="sh">"</span><span class="s">just local work</span><span class="sh">"'</span><span class="p">,</span>   <span class="c1"># 로컬 실행
</span>    <span class="p">]</span>

    <span class="c1"># 3초 뒤 취소 신호
</span>    <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">cmds</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="o">=</span><span class="nc">Token</span><span class="p">(</span><span class="mf">3.0</span><span class="p">).</span><span class="n">is_interrupted</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">cmd_raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="o">=</span><span class="mf">60.0</span><span class="p">,</span>
        <span class="n">kill_force</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<h3 id="b-bjobs-전체-스냅샷-공유-캐시">B) “bjobs 전체 스냅샷” 공유 캐시</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">lsf_async_v3</span> <span class="kn">import</span> <span class="n">LsfClient</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">lsf</span> <span class="o">=</span> <span class="nc">LsfClient</span><span class="p">(</span><span class="n">cache_dir</span><span class="o">=</span><span class="sh">"</span><span class="s">/dev/shm/lsf_cache</span><span class="sh">"</span><span class="p">,</span> <span class="n">bjobs_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">disk_cache_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
    <span class="c1"># 프로세스 A가 먼저 전체 스냅샷 캐시
</span>    <span class="n">all_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">status</span><span class="p">()</span>
    <span class="c1"># 프로세스 B는 디스크 캐시만 읽어 특정 ID들 필터링
</span>    <span class="n">subset</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">status</span><span class="p">([</span><span class="mi">101</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">103</span><span class="p">])</span>
    <span class="nf">print</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">all_map</span><span class="p">),</span> <span class="n">subset</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="mi">101</span><span class="p">))</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<h3 id="c-그냥-실행만-비lsf--에러-미전파">C) “그냥 실행만” (비LSF) + 에러 미전파</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">lsf_async_v3</span> <span class="kn">import</span> <span class="n">LsfClient</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">lsf</span> <span class="o">=</span> <span class="nc">LsfClient</span><span class="p">()</span>
    <span class="n">r1</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">run_command_maybe_bsub</span><span class="p">(</span><span class="sh">"</span><span class="s">sleep 1</span><span class="sh">"</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">sleep rc:</span><span class="sh">"</span><span class="p">,</span> <span class="n">r1</span><span class="p">[</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">jobid:</span><span class="sh">"</span><span class="p">,</span> <span class="n">r1</span><span class="p">[</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">])</span>  <span class="c1"># job_id=None
</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">run_command_maybe_bsub</span><span class="p">(</span><span class="sh">"</span><span class="s">bsub -q short </span><span class="sh">'</span><span class="s">echo hi</span><span class="sh">'"</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">bsub rc:</span><span class="sh">"</span><span class="p">,</span> <span class="n">r2</span><span class="p">[</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">jobid:</span><span class="sh">"</span><span class="p">,</span> <span class="n">r2</span><span class="p">[</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">])</span>   <span class="c1"># job_id=정수 또는 None
</span>
<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h2 id="락-고아stale-lock-우려에-대한-답">락 고아(stale lock) 우려에 대한 답</h2>

<ul>
  <li>
    <p>이 버전은 <strong>파일락을 사용하지 않습니다.</strong> 디스크 캐시는 <strong>임시파일 →<code class="language-plaintext highlighter-rouge">os.replace()</code></strong> 로 교체되며, 이는 <strong>동일 파일시스템 내에서 원자적</strong> 입니다.</p>
  </li>
  <li>
    <p>프로세스가 쓰기 도중 죽더라도 <strong>임시파일만</strong> 남고(정리 루틴 있음), 본 캐시 파일은 <strong>항상 완전한 JSON</strong> 상태로 유지됩니다.</p>
  </li>
  <li>
    <p>따라서 “한 프로세스가 락을 잡은 채 죽어서 영원히 풀리지 않는” 상황은 <strong>구조적으로 불가능</strong> 합니다. (NFS 등에서도 rename 원자성은 보장; 단, 서로 다른 마운트 간 경로만 피하세요.)</p>
  </li>
</ul>

<hr />

<h2 id="마지막-체크리스트">마지막 체크리스트</h2>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">sleep 1</code> 같은 비LSF 커맨드: <strong>그냥 실행</strong> , 잡ID 없으면 <strong>에러 없이</strong> 넘어감.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bsub ...</code> 커맨드: <strong>그대로 실행</strong> + 가능한 경우에만 <strong>JobID 파싱</strong>.</p>
  </li>
  <li>
    <p>취소 시: bsub는 <strong>끝까지 기다려 JobID 수집 → bkill</strong> / 비-bsub는 원한다면 즉시 terminate/kill 확장 가능.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bjobs</code> 호출 최소화: 프로세스 간 <strong>공유 디스크 캐시 + TTL</strong>.</p>
  </li>
</ul>

<p>원하시면 비-bsub 프로세스도 인터럽트 즉시 <strong>terminate/kill</strong> 하도록(핸들 추적형) 리팩터 버전까지 바로 드릴게요.</p>

<p class="chat--user">

1. 여러 머신에서 공유 드라이브를 쓰는데 이 경우에도 원자적인지 궁금함. 2. bsub로 시작하냐로 판단하는 부분이 있어 보이는데, 스크립트(e.g. job_sub)와 같은 경우도 있어 불완전함. 그냥 Job submit message로 판단하는 것이 좋을 것 같음.

</p>

<p>좋은 피드백! 두 가지 모두 반영해서 정리 + 코드 업데이트 드릴게요.</p>

<hr />

<h1 id="1-여러-머신--공유-드라이브에서-원자성">1) “여러 머신 + 공유 드라이브”에서 원자성?</h1>

<ul>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">os.replace()</code>는 같은 파일시스템(같은 마운트/디렉터리 내)</strong> 에서 <strong>원자적(rename)</strong> 입니다.</p>

    <ul>
      <li><strong>NFSv3/v4, Lustre, GPFS(IBM Spectrum Scale), SMB/CIFS</strong> 등 일반적인 <em>POSIX 계열 분산 FS</em> 에서는 “서버 관점”에서 원자적입니다(마지막 rename 승리).</li>
    </ul>
  </li>
  <li>
    <p>주의할 점은 <strong>캐시 일관성</strong> :</p>

    <ul>
      <li>
        <p>NFS/SMB는 <strong>속성/이름 캐시 지연</strong> 이 있을 수 있어, <em>다른 머신</em> 이 새로운 파일 내용을 “조~금 늦게” 보기도 합니다(보통 1~3초).</p>
      </li>
      <li>
        <p>이건 원자성이 깨진 게 아니라 <strong>전파 지연</strong> 문제이며, TTL을 너무 공격적으로(≤1초) 잡으면 갱신을 놓칠 수 있습니다.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>대응책</strong> (코드에 반영):</p>

    <ol>
      <li>
        <p><strong>쓰기 측</strong> : 임시 파일에 <code class="language-plaintext highlighter-rouge">json</code> 쓰고 <code class="language-plaintext highlighter-rouge">fsync(tmp)</code> → <code class="language-plaintext highlighter-rouge">os.replace()</code> → <strong>디렉터리<code class="language-plaintext highlighter-rouge">fsync(dir)</code></strong> 까지 수행 → 메타데이터 영속 보장 강화.</p>
      </li>
      <li>
        <p><strong>읽기 측</strong> : 캐시 신선도 판단 시</p>

        <ul>
          <li>
            <p>파일 내 <code class="language-plaintext highlighter-rouge">ts</code>(작성자가 기록한 시각)과</p>
          </li>
          <li>
            <p>파일의 <strong>서버 mtime</strong>(스냅샷 파일 자체의 변경 시각)<br />
둘 다 확인하고, <strong>둘 중 더 신뢰되는 쪽으로 판단</strong>(+약간의 시계 오차 허용치) → 머신 간 <strong>시계 오차/캐시 지연</strong> 에 더 강인.</p>
          </li>
        </ul>
      </li>
      <li>
        <p><strong>운영 팁</strong> : TTL을 <strong>2~5초 이상</strong> 으로 두고, 필요 시 “강제 갱신” 경로(예: <code class="language-plaintext highlighter-rouge">force_refresh=True</code>)를 추가하는 게 실전에서 가장 안정적입니다.</p>
      </li>
    </ol>
  </li>
</ul>

<blockquote>
  <p>요약: 같은 공유 마운트(동일 FS) 내에서 쓰고 읽으면 rename은 <strong>원자적</strong> 이며, 코드에서 <code class="language-plaintext highlighter-rouge">fsync</code>·mtime 기반 판정으로 <strong>멀티머신 안전성</strong> 을 보강했습니다.</p>
</blockquote>

<hr />

<h1 id="2-bsub로-시작-판별-제거--제출-메시지-만으로-판단">2) “bsub로 시작” 판별 제거 → <strong>제출 메시지</strong> 만으로 판단</h1>

<ul>
  <li>
    <p>스크립트(<code class="language-plaintext highlighter-rouge">job_sub</code>)나 래퍼가 <code class="language-plaintext highlighter-rouge">bsub</code>를 내부에서 호출하는 경우에도, LSF가 표준 출력/에러로 내보내는<br />
<strong><code class="language-plaintext highlighter-rouge">Job&lt;12345&gt;</code></strong> 패턴만 보면 <strong>잡 ID를 안정적으로 파싱</strong> 할 수 있습니다.</p>
  </li>
  <li>
    <p>따라서 “명령어 첫 토큰이 <code class="language-plaintext highlighter-rouge">bsub</code>인지” 체크를 <strong>완전히 제거</strong> 하고, <strong>출력 파싱만</strong> 으로 “잡인지/아닌지” 구분하도록 바꿨습니다.</p>

    <ul>
      <li>
        <p>잡 메시지가 없으면 <code class="language-plaintext highlighter-rouge">job_id=None</code>으로 처리(에러 X).</p>
      </li>
      <li>
        <p>“취소” 시에도 <strong>중간에 프로세스를 kill하지 않고</strong> 통신 종료까지 기다려 메시지를 수집 → <strong>고아 잡 방지</strong>.</p>
      </li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="업데이트-코드-핵심-변경만">업데이트 코드 (핵심 변경만)</h2>

<p>아래는 v4의 <strong>교체/추가된 메서드</strong> 입니다. (나머지 구조는 이전 버전 그대로 사용해도 됩니다.)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># --- NEW/CHANGED: 디스크 캐시 읽기: ts와 mtime을 모두 활용 ---
</span><span class="k">def</span> <span class="nf">_disk_cache_read</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache_path</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">stat</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>  <span class="c1"># 서버 관점 mtime
</span>        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
        <span class="n">ts_in_file</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">items</span><span class="p">()}</span>

        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">age_by_file_ts</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">ts_in_file</span> <span class="k">if</span> <span class="n">ts_in_file</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nf">float</span><span class="p">(</span><span class="sh">"</span><span class="s">inf</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">age_by_mtime</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">now</span> <span class="o">-</span> <span class="n">st</span><span class="p">.</span><span class="n">st_mtime</span><span class="p">)</span>

        <span class="c1"># 시계 오차 허용치(멀티머신): ±2초
</span>        <span class="n">skew_eps</span> <span class="o">=</span> <span class="mf">2.0</span>
        <span class="n">fresh_by_ts</span> <span class="o">=</span> <span class="n">age_by_file_ts</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_disk_ttl</span> <span class="o">+</span> <span class="n">skew_eps</span><span class="p">)</span>
        <span class="n">fresh_by_mtime</span> <span class="o">=</span> <span class="n">age_by_mtime</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_disk_ttl</span> <span class="o">+</span> <span class="n">skew_eps</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fresh_by_ts</span> <span class="ow">or</span> <span class="n">fresh_by_mtime</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="c1"># --- NEW/CHANGED: 디스크 캐시 쓰기: tmp fsync -&gt; replace -&gt; dir fsync ---
</span><span class="k">def</span> <span class="nf">_disk_cache_write</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">dir_fd</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fd</span><span class="p">,</span> <span class="n">tmp_path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="p">.</span><span class="nf">mkstemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="sh">"</span><span class="s">bjobs_</span><span class="sh">"</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">"</span><span class="s">.json</span><span class="sh">"</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">fdopen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmpfp</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">},</span> <span class="n">tmpfp</span><span class="p">)</span>
                <span class="n">tmpfp</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">tmpfp</span><span class="p">.</span><span class="nf">fileno</span><span class="p">())</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache_path</span><span class="p">)</span>  <span class="c1"># atomic on same FS
</span>            <span class="c1"># 메타데이터 영속성 강화
</span>            <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">FileNotFoundError</span><span class="p">):</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>

<span class="c1"># --- NEW/CHANGED: 커맨드를 "있는 그대로" 실행하되, 출력에서만 JobID 판별 ---
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">run_command_capture_job</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                                  <span class="n">command</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
                                  <span class="o">*</span><span class="p">,</span>
                                  <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                                  <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    커맨드를 그대로 실행. stdout/stderr에서 </span><span class="sh">'</span><span class="s">Job &lt;id&gt;</span><span class="sh">'</span><span class="s"> 패턴을 찾아 잡 ID를 반환.
    잡 메시지가 없으면 job_id=None (에러 발생 안 함 unless raise_on_error=True).
    </span><span class="sh">"""</span>
    <span class="c1"># 스폰 시에만 세마포어 보유 -&gt; 병렬 스폰 제한
</span>    <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span><span class="p">:</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
                <span class="sh">"</span><span class="s">/bin/sh</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">-lc</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">env</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
                <span class="o">*</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">command</span><span class="p">),</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">env</span>
            <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ProcessLookupError</span><span class="p">):</span>
            <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
        <span class="k">raise</span>

    <span class="n">stdout</span> <span class="o">=</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">stderr</span> <span class="o">=</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>

    <span class="c1"># 출력에서만 판단
</span>    <span class="n">m</span> <span class="o">=</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span>
    <span class="n">job_id</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">raise_on_error</span> <span class="ow">and</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">([</span><span class="n">command</span><span class="p">]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">command</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">stdout</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">stderr</span><span class="p">,</span> <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span> <span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">job_id</span><span class="p">}</span>

<span class="c1"># --- NEW/CHANGED: 일괄 제출 + 취소 (출력으로 JobID만 수집; 중간 kill 없음) ---
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">submit_many_with_cancel</span><span class="p">(</span>
    <span class="n">self</span><span class="p">,</span>
    <span class="n">commands</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">is_interrupted</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">bool</span><span class="p">],</span>
    <span class="n">poll_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
    <span class="n">max_in_flight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">kill_force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="n">kill_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="n">cmd_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
    <span class="n">cmd_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    명령을 그대로 실행. 결과(stdout/stderr)에서 </span><span class="sh">'</span><span class="s">Job &lt;id&gt;</span><span class="sh">'</span><span class="s">만 추출.
    인터럽트 발생 시: 새 실행 중단 + 진행 중인 프로세스들은 끝까지 기다림(고아 잡 방지).
    이후 수집된 job_id 전체 bkill.
    </span><span class="sh">"""</span>
    <span class="n">submitted</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">max_in_flight</span> <span class="o">=</span> <span class="n">max_in_flight</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span><span class="p">.</span><span class="n">_value</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">run_command_capture_job</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">cmd_timeout</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">cmd_raise_on_error</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">in_flight</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span> <span class="ow">or</span> <span class="n">in_flight</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">in_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_in_flight</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">is_interrupted</span><span class="p">():</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">run_one</span><span class="p">(</span><span class="n">commands</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
                <span class="n">in_flight</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll_interval_sec</span><span class="p">,</span>
                                             <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                    <span class="n">in_flight</span><span class="p">.</span><span class="nf">discard</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                        <span class="k">if</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">submitted</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">])</span>
                        <span class="k">elif</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">poll_interval_sec</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># 남은 것 모두 종료까지 기다려 job_id 수집
</span>        <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
            <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">ALL_COMPLETED</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                    <span class="k">if</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">submitted</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">interrupted</span> <span class="o">=</span> <span class="nf">is_interrupted</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">interrupted</span> <span class="ow">and</span> <span class="n">submitted</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">submitted</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">kill_force</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">kill_raise_on_error</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">submitted_job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">submitted</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">interrupted</span><span class="sh">"</span><span class="p">:</span> <span class="n">interrupted</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">num_submitted</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">submitted</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">num_failed</span><span class="sh">"</span><span class="p">:</span> <span class="n">failures</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="간단-사용-예시">간단 사용 예시</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 혼합 커맨드: 래퍼 + 순수 셸 + 진짜 bsub
</span><span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sh">"</span><span class="s">job_sub my_script.sh --epochs 5</span><span class="sh">"</span><span class="p">,</span>   <span class="c1"># 내부에서 bsub 호출 -&gt; 출력에 Job &lt;id&gt;만 찍어주면 OK
</span>    <span class="sh">"</span><span class="s">sleep 1</span><span class="sh">"</span><span class="p">,</span>                           <span class="c1"># 잡 아님: job_id=None
</span>    <span class="sh">"</span><span class="s">bsub -q short </span><span class="sh">'</span><span class="s">echo hi; sleep 2</span><span class="sh">'"</span><span class="p">,</span>  <span class="c1"># 잡: job_id=정수
</span><span class="p">]</span>

<span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">submit_many_with_cancel</span><span class="p">(</span>
    <span class="n">cmds</span><span class="p">,</span>
    <span class="n">is_interrupted</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>    <span class="c1"># 언제든 True 반환되면 새 실행 중단, 진행 중은 끝까지 기다림
</span>    <span class="n">max_in_flight</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">cmd_timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
<span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>  <span class="c1"># {"submitted_job_ids":[...], ...}
</span></code></pre></div></div>

<hr />

<h2 id="정리-핵심-포인트">정리 (핵심 포인트)</h2>

<ul>
  <li>
    <p><strong>원자성</strong> : 같은 공유 FS 내 <code class="language-plaintext highlighter-rouge">os.replace()</code>는 원자적. 캐시 지연은 있을 수 있으므로 <strong>TTL 2~5s + dir fsync + mtime/ts 이중판정</strong> 으로 보강.</p>
  </li>
  <li>
    <p><strong>잡 판별</strong> : “<code class="language-plaintext highlighter-rouge">Job &lt;id&gt;</code> 메시지”만으로 판단 → <code class="language-plaintext highlighter-rouge">bsub</code> 래퍼/스크립트도 자연스럽게 지원.</p>
  </li>
  <li>
    <p><strong>취소 시</strong> : 진행 중 제출은 <strong>끝까지 기다린 뒤</strong> 잡ID 모아 <strong>일괄<code class="language-plaintext highlighter-rouge">bkill</code></strong> → 고아 잡 방지.</p>
  </li>
</ul>

<p>원하시면,</p>

<ul>
  <li>
    <p><strong>강제 갱신 플래그</strong>(<code class="language-plaintext highlighter-rouge">force_refresh=True</code>)나</p>
  </li>
  <li>
    <p><strong>스트리밍 파서</strong>(출력 줄 단위 실시간 파싱)로 “잡 ID를 즉시 감지”하는 버전도 추가해 드릴게요.</p>
  </li>
</ul>

<p class="chat--user">

1. create_subprocess_shell 로 실행하면 좋겠음. (/bin/sh도 제거할 것) 2. 현재까지 정리된 내용 전체 코드 작성해자. 

</p>

<p>좋아요! 요청하신 대로 <strong><code class="language-plaintext highlighter-rouge">create_subprocess_shell</code>만</strong> 사용하고(직접 <code class="language-plaintext highlighter-rouge">/bin/sh</code> 지정 X), 지금까지 합의된 요구사항을 모두 반영한 <strong>단일 파일 전체 코드(v5)</strong> 를 드립니다.</p>

<ul>
  <li>
    <p>커맨드는 <strong>그대로 실행</strong> 합니다. (예: <code class="language-plaintext highlighter-rouge">sleep 1</code>, <code class="language-plaintext highlighter-rouge">bsub -q short sleep 1</code>, <code class="language-plaintext highlighter-rouge">job_sub ...</code>)</p>
  </li>
  <li>
    <p>잡 판별은 <strong>출력의<code class="language-plaintext highlighter-rouge">Job &lt;id&gt;</code> 메시지</strong>만으로 합니다.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bjobs</code>는 **전체 스냅샷(-u <user> [-a])**을 1회 가져와 **메모리+디스크 TTL 캐시**(멀티 프로세스 공유) 후, 호출자에게는 `job_ids`로 필터링 결과만 돌려줍니다.</user></p>
  </li>
  <li>
    <p>디스크 캐시는 <strong>tmp →<code class="language-plaintext highlighter-rouge">os.replace</code>(원자적) → 디렉터리 <code class="language-plaintext highlighter-rouge">fsync</code></strong> 로 기록하고, <strong>파일 내 ts와 mtime 둘 다</strong> 로 신선도를 판정합니다. (NFS/SMB/GPFS 등 공유 FS에서도 안전)</p>
  </li>
  <li>
    <p>취소 시엔 <strong>새 실행을 멈추고 진행 중 제출은 끝까지 기다려 Job ID 수집 → 일괄<code class="language-plaintext highlighter-rouge">bkill</code></strong>(고아 잡 방지)</p>
  </li>
  <li>
    <p>LSF가 아닌 커맨드도 그냥 실행하고 <strong>에러는 옵션으로만 raise</strong> 합니다.</p>
  </li>
</ul>

<hr />
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># lsf_async_v5.py
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>
<span class="kn">import</span> <span class="n">getpass</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1"># ------------------------------
# Utilities
# ------------------------------
</span>
<span class="n">StrOrSeq</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
<span class="n">_JOBID_RE</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Accept str or seq; if seq, join by space (caller is responsible for quoting if needed).</span><span class="sh">"""</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cmd</span>
    <span class="k">return</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="nb">RuntimeError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Command failed: </span><span class="si">{</span><span class="n">cmd_str</span><span class="si">}</span><span class="s"> (rc=</span><span class="si">{</span><span class="n">returncode</span><span class="si">}</span><span class="s">)</span><span class="se">\n</span><span class="si">{</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cmd_str</span> <span class="o">=</span> <span class="n">cmd_str</span>
        <span class="n">self</span><span class="p">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="n">returncode</span>
        <span class="n">self</span><span class="p">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span>
        <span class="n">self</span><span class="p">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">stderr</span>

<span class="c1"># ------------------------------
# Client
# ------------------------------
</span>
<span class="k">class</span> <span class="nc">LsfClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - 커맨드를 </span><span class="sh">'</span><span class="s">있는 그대로</span><span class="sh">'</span><span class="s"> shell로 실행(create_subprocess_shell).
    - 출력에서 </span><span class="sh">'</span><span class="s">Job &lt;id&gt;</span><span class="sh">'</span><span class="s"> 메시지를 찾아 LSF 잡 여부/ID 판단.
    - bjobs: 전체 스냅샷을 메모리+디스크 TTL 캐시(멀티 프로세스 공유) 후 필터링 반환.
    - 일괄 제출 + 취소: 인터럽트 시 새 제출 중단, 진행 중 제출은 완주 → 수집한 job_id를 일괄 bkill.
    </span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">bkill</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">bjobs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">max_concurrent_cli</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">bjobs_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># Paths
</span>        <span class="n">self</span><span class="p">.</span><span class="n">paths</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">:</span> <span class="n">bkill</span><span class="p">,</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">:</span> <span class="n">bjobs</span><span class="p">}</span>

        <span class="c1"># Concurrency &amp; rate-limit
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">max_concurrent_cli</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_min_interval_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_last_call_ts</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># Memory cache (per-process)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mem_cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Disk cache (shared across processes; atomic replace; robust on shared FS)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_disk_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">disk_cache_ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_user</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LSF_USER</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">getpass</span><span class="p">.</span><span class="nf">getuser</span><span class="p">()</span>
        <span class="n">base_cache</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">XDG_CACHE_HOME</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">expanduser</span><span class="p">(</span><span class="sh">"</span><span class="s">~</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">.cache</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span> <span class="o">=</span> <span class="n">cache_dir</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base_cache</span><span class="p">,</span> <span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all_</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># Locale-stable env (avoid localized outputs)
</span>        <span class="n">base_env</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LC_ALL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LANG</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">base_env</span> <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="bp">None</span> <span class="nf">else </span><span class="p">(</span><span class="n">base_env</span> <span class="o">|</span> <span class="n">env</span><span class="p">)</span>

    <span class="c1"># ------------- low-level run -------------
</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_run_shell</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        Run exactly as a shell command via asyncio.create_subprocess_shell.
        NOTE: We don</span><span class="sh">'</span><span class="s">t explicitly specify /bin/sh; the event loop chooses the platform default.
        </span><span class="sh">"""</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_shell</span><span class="p">(</span>
                <span class="n">cmd_str</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">env</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ProcessLookupError</span><span class="p">):</span>
                <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>

    <span class="c1"># ------------- general command (LSF or not) -------------
</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_command_capture_job</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        커맨드를 </span><span class="sh">'</span><span class="s">그대로</span><span class="sh">'</span><span class="s"> 실행. stdout/stderr에서 </span><span class="sh">'</span><span class="s">Job &lt;id&gt;</span><span class="sh">'</span><span class="s"> 패턴을 찾아 잡 ID를 반환.
        - 잡 메시지가 없으면 job_id=None (에러 발생 X, 단 raise_on_error=True면 예외).
        </span><span class="sh">"""</span>
        <span class="n">cmd_str</span> <span class="o">=</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_run_shell</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

        <span class="n">m</span> <span class="o">=</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">raise_on_error</span> <span class="ow">and</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">stdout</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">stderr</span><span class="p">,</span> <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span> <span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">job_id</span><span class="p">}</span>

    <span class="c1"># ------------- kill -------------
</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">job_ids</span><span class="p">))]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">""</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-f </span><span class="sh">"</span> <span class="k">if</span> <span class="n">force</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bkill</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">flag</span><span class="si">}{</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_run_shell</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">raise_on_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span>

    <span class="c1"># ------------- bjobs snapshot cache -------------
</span>
    <span class="k">def</span> <span class="nf">_mem_fresh</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem_cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">ts</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">item</span>
        <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_disk_cache_read</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache_path</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">stat</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>  <span class="c1"># server-side mtime (on shared FS)
</span>            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="n">ts_in_file</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">items</span><span class="p">()}</span>

            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">age_by_ts</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">ts_in_file</span><span class="p">)</span> <span class="k">if</span> <span class="n">ts_in_file</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nf">float</span><span class="p">(</span><span class="sh">"</span><span class="s">inf</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">age_by_mtime</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">now</span> <span class="o">-</span> <span class="n">st</span><span class="p">.</span><span class="n">st_mtime</span><span class="p">)</span>
            <span class="n">skew_eps</span> <span class="o">=</span> <span class="mf">2.0</span>  <span class="c1"># tolerate small clock skew &amp; metadata latency
</span>
            <span class="n">fresh_by_ts</span> <span class="o">=</span> <span class="n">age_by_ts</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_disk_ttl</span> <span class="o">+</span> <span class="n">skew_eps</span><span class="p">)</span>
            <span class="n">fresh_by_mtime</span> <span class="o">=</span> <span class="n">age_by_mtime</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_disk_ttl</span> <span class="o">+</span> <span class="n">skew_eps</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fresh_by_ts</span> <span class="ow">or</span> <span class="n">fresh_by_mtime</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_disk_cache_write</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c1"># tmp -&gt; fsync(tmp) -&gt; replace -&gt; fsync(dir)  (robust on shared FS)
</span>        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">dir_fd</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fd</span><span class="p">,</span> <span class="n">tmp_path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="p">.</span><span class="nf">mkstemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="sh">"</span><span class="s">bjobs_</span><span class="sh">"</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">"</span><span class="s">.json</span><span class="sh">"</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">fdopen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmpfp</span><span class="p">:</span>
                    <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">},</span> <span class="n">tmpfp</span><span class="p">)</span>
                    <span class="n">tmpfp</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">tmpfp</span><span class="p">.</span><span class="nf">fileno</span><span class="p">())</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache_path</span><span class="p">)</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">FileNotFoundError</span><span class="p">):</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="c1"># simple per-process rate limit
</span>        <span class="n">since</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_last_call_ts</span>
        <span class="k">if</span> <span class="n">since</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">-</span> <span class="n">since</span><span class="p">)</span>

        <span class="n">flag</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-a </span><span class="sh">"</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bjobs</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> -noheader -u </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s">-o </span><span class="sh">'</span><span class="s">jobid stat exit_code queue exec_host</span><span class="sh">'"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_run_shell</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_last_call_ts</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

        <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">exec_host</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ValueError</span><span class="p">):</span>
                <span class="n">jid_i</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="n">jid_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="n">stat</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="sh">"</span><span class="s">-</span><span class="sh">"</span> <span class="k">else</span> <span class="n">exit_code</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="n">queue</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="n">exec_host</span><span class="p">,</span>
                <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_status_all_cached</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all|</span><span class="si">{</span><span class="sh">'</span><span class="s">-a</span><span class="sh">'</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">''</span><span class="si">}</span><span class="s">|user=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="sh">"</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
            <span class="n">mem</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_mem_fresh</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">mem</span>

            <span class="n">inflight</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inflight</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">inflight</span>

        <span class="n">fut</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">().</span><span class="nf">create_future</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fut</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
                <span class="n">disk</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_disk_cache_read</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">disk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_mem_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">disk</span><span class="p">)</span>
                    <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">disk</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">disk</span>

            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_mem_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_disk_cache_write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">status</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sh">"""</span><span class="s">
        bjobs 전체 스냅샷(캐시 활용) 후, 요청한 job_ids만 필터링해서 반환.
        job_ids=None이면 전체 맵을 돌려줌.
        </span><span class="sh">"""</span>
        <span class="n">all_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_status_all_cached</span><span class="p">(</span>
            <span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="n">force_refresh</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">job_ids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_map</span>
        <span class="n">wanted</span> <span class="o">=</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">all_map</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">wanted</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">status_union_batched</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">list_of_job_id_sets</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
        <span class="sh">"""</span><span class="s">
        여러 요청을 합집합으로 한 번 조회(실제론 스냅샷 캐시 사용) 후 분배.
        </span><span class="sh">"""</span>
        <span class="n">union_ids</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="n">normalized</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">list_of_job_id_sets</span><span class="p">:</span>
            <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>
            <span class="n">normalized</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
            <span class="n">union_ids</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
        <span class="n">union_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">union_ids</span><span class="p">,</span> <span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="n">force_refresh</span><span class="p">)</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">normalized</span><span class="p">:</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="n">i</span><span class="p">:</span> <span class="n">union_map</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="c1"># ------------- batch submit with cooperative cancel -------------
</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">commands</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">StrOrSeq</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">bool</span><span class="p">],</span>
        <span class="n">poll_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">kill_force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">kill_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">cmd_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        명령을 그대로 실행(create_subprocess_shell). 출력에서 </span><span class="sh">'</span><span class="s">Job &lt;id&gt;</span><span class="sh">'</span><span class="s">만 추출.
        인터럽트 시: 새 실행 중단 + 진행 중 제출은 끝까지 기다림(고아 잡 방지) → 수집된 job_id 일괄 bkill.
        </span><span class="sh">"""</span>
        <span class="n">submitted</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">max_in_flight</span> <span class="o">=</span> <span class="n">max_in_flight</span> <span class="ow">or</span> <span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span><span class="p">.</span><span class="n">_value</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">run_command_capture_job</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">cmd_timeout</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">cmd_raise_on_error</span>
            <span class="p">)</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
        <span class="n">in_flight</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">or</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="c1"># launch window
</span>                <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">in_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_in_flight</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">is_interrupted</span><span class="p">():</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">run_one</span><span class="p">(</span><span class="n">commands</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
                    <span class="n">in_flight</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                    <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span>
                        <span class="n">in_flight</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll_interval_sec</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                        <span class="n">in_flight</span><span class="p">.</span><span class="nf">discard</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                            <span class="n">jid</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">jid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="n">submitted</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">poll_interval_sec</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># drain: 진행 중 제출을 끝까지 기다려 Job ID 수집
</span>            <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">ALL_COMPLETED</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                        <span class="n">jid</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">jid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">submitted</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">interrupted</span> <span class="o">=</span> <span class="nf">is_interrupted</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">interrupted</span> <span class="ow">and</span> <span class="n">submitted</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">submitted</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">kill_force</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">kill_raise_on_error</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">submitted_job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">submitted</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">interrupted</span><span class="sh">"</span><span class="p">:</span> <span class="n">interrupted</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">num_submitted</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">submitted</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">num_failed</span><span class="sh">"</span><span class="p">:</span> <span class="n">failures</span><span class="p">,</span>
        <span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="빠른-사용-예시">빠른 사용 예시</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">lsf_async_v5</span> <span class="kn">import</span> <span class="n">LsfClient</span>

<span class="k">class</span> <span class="nc">Token</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span> <span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">delay</span>
    <span class="k">def</span> <span class="nf">is_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">):</span> <span class="nf">return </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span><span class="o">-</span><span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">lsf</span> <span class="o">=</span> <span class="nc">LsfClient</span><span class="p">(</span>
        <span class="n">max_concurrent_cli</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">bjobs_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="o">=</span><span class="sh">"</span><span class="s">/shared/cache/lsf_async</span><span class="sh">"</span><span class="p">,</span>  <span class="c1"># 여러 머신에서 공유되는 경로
</span>    <span class="p">)</span>

    <span class="c1"># 혼합 커맨드: 래퍼/순수/직접 bsub
</span>    <span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sh">"</span><span class="s">job_sub my_script.sh --epochs 3</span><span class="sh">"</span><span class="p">,</span>    <span class="c1"># 내부에서 bsub 호출, 출력에 Job &lt;id&gt;가 찍히면 잡으로 인식
</span>        <span class="sh">"</span><span class="s">sleep 1</span><span class="sh">"</span><span class="p">,</span>                             <span class="c1"># 비LSF: job_id=None
</span>        <span class="sh">"</span><span class="s">bsub -q short </span><span class="sh">'</span><span class="s">echo hi; sleep 2</span><span class="sh">'"</span><span class="p">,</span>    <span class="c1"># LSF: job_id 파싱
</span>    <span class="p">]</span>

    <span class="c1"># 3초 후 취소
</span>    <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">cmds</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="o">=</span><span class="nc">Token</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="n">is_interrupted</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
        <span class="n">cmd_raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">kill_force</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

    <span class="c1"># bjobs 스냅샷 캐시 활용
</span>    <span class="n">all_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">some</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">status</span><span class="p">([</span><span class="nf">list</span><span class="p">(</span><span class="n">all_map</span><span class="p">.</span><span class="nf">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="n">all_map</span> <span class="k">else</span> <span class="p">[])</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">N(all)=</span><span class="sh">"</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">all_map</span><span class="p">),</span> <span class="sh">"</span><span class="s">subset=</span><span class="sh">"</span><span class="p">,</span> <span class="n">some</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h3 id="구현-메모요점-정리">구현 메모(요점 정리)</h3>

<ol>
  <li>
    <p><strong>셸 실행</strong> : 모든 커맨드는 <code class="language-plaintext highlighter-rouge">asyncio.create_subprocess_shell</code>로 실행합니다. 코드 어디에도 직접 <code class="language-plaintext highlighter-rouge">/bin/sh</code>를 지정하지 않습니다.</p>
  </li>
  <li>
    <p><strong>잡 판별</strong> : 오직 출력의 <code class="language-plaintext highlighter-rouge">Job &lt;id&gt;</code> 패턴으로만 잡 여부/ID를 판단합니다. (래퍼/스크립트 OK)</p>
  </li>
  <li>
    <p><strong>공유 드라이브 안전성</strong> :</p>

    <ul>
      <li>
        <p>쓰기: tmp→<code class="language-plaintext highlighter-rouge">os.replace</code>(동일 FS 내 원자적)→디렉터리 <code class="language-plaintext highlighter-rouge">fsync</code>로 메타데이터까지 보장.</p>
      </li>
      <li>
        <p>읽기: <code class="language-plaintext highlighter-rouge">ts</code>(파일 내부)와 <code class="language-plaintext highlighter-rouge">mtime</code>(서버 메타데이터) <strong>둘 다</strong> 로 TTL 판정(+2s 스큐 허용).</p>
      </li>
      <li>
        <p>운영 팁: TTL은 <strong>≥2~5초</strong> 권장(분산 FS 전파 지연 흡수).</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>고아 잡 방지</strong> : 취소 시 <strong>진행 중 제출은 kill하지 않고</strong> 끝까지 기다린 뒤 <strong>수집한 job_id만 bkill</strong>.</p>
  </li>
  <li>
    <p><strong>에러 정책</strong> : 일반 커맨드는 <code class="language-plaintext highlighter-rouge">raise_on_error=False</code> 기본(예외 미발생). 필요 시 True로 올리면 예외 발생.</p>
  </li>
</ol>

<p>필요하시면 <code class="language-plaintext highlighter-rouge">force_refresh=True</code>로 bjobs를 강제 갱신하는 호출 경로를 더 노출하거나, <strong>스트리밍 파서</strong> 로 <code class="language-plaintext highlighter-rouge">Job &lt;id&gt;</code>를 “실시간” 감지하는 버전도 추가해 드릴게요.</p>

<p class="chat--user">

뭔가 한 클래스에 다 박은 느낌인데, 클래스 같은걸 나눠서 깔끔하게 짜줄 수 있어? 파이썬 현업 전문가가 작성한 것 처럼

</p>

<p>좋아요—요구사항을 “현업스러운” 구조로 쪼개서 작성했습니다.<br />
핵심은 역할별 클래스로 분리(셸 실행/레이트리밋/메모리·디스크 캐시/스냅샷 페처/상태 API/배치 제출·취소), 그리고 <code class="language-plaintext highlighter-rouge">create_subprocess_shell</code>만 사용합니다.</p>

<p>아래 단일 파일을 그대로 저장해 쓰세요. (예: <code class="language-plaintext highlighter-rouge">lsf_pro.py</code>)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># lsf_pro.py
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>
<span class="kn">import</span> <span class="n">getpass</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1"># ============================================================
# Exceptions &amp; Utilities
# ============================================================
</span>
<span class="k">class</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="nb">RuntimeError</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Raised when an LSF-related command returns nonzero exit code (optional).</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Command failed: </span><span class="si">{</span><span class="n">cmd_str</span><span class="si">}</span><span class="s"> (rc=</span><span class="si">{</span><span class="n">returncode</span><span class="si">}</span><span class="s">)</span><span class="se">\n</span><span class="si">{</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cmd_str</span> <span class="o">=</span> <span class="n">cmd_str</span>
        <span class="n">self</span><span class="p">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="n">returncode</span>
        <span class="n">self</span><span class="p">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span>
        <span class="n">self</span><span class="p">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">stderr</span>

<span class="n">StrOrSeq</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
<span class="n">_JOBID_RE</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">to_shell_str</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Accept str or sequence; if sequence, join by space. Caller is responsible for quoting.</span><span class="sh">"""</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cmd</span>
    <span class="k">return</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">parse_job_id_from_output</span><span class="p">(</span><span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">Find </span><span class="sh">'</span><span class="s">Job &lt;123&gt;</span><span class="sh">'</span><span class="s"> in either stdout or stderr.</span><span class="sh">"""</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span>
    <span class="k">return</span> <span class="nf">int</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="bp">None</span>

<span class="c1"># ============================================================
# Config
# ============================================================
</span>
<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">LSFConfig</span><span class="p">:</span>
    <span class="n">bkill</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span>
    <span class="n">bjobs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span>
    <span class="n">max_concurrent_cli</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">bjobs_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span>
    <span class="n">bjobs_min_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">disk_cache_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span>
    <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># default: env/OS user
</span>
<span class="c1"># ============================================================
# Layer 1: Shell runner &amp; rate limiter
# ============================================================
</span>
<span class="k">class</span> <span class="nc">ShellRunner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Thin async wrapper around asyncio.create_subprocess_shell with a concurrency gate.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">max_concurrency</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">max_concurrency</span><span class="p">)</span>
        <span class="n">base_env</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LC_ALL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LANG</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_env</span> <span class="o">=</span> <span class="n">base_env</span> <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="bp">None</span> <span class="nf">else </span><span class="p">(</span><span class="n">base_env</span> <span class="o">|</span> <span class="n">env</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_sem</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_shell</span><span class="p">(</span>
                <span class="n">cmd_str</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_env</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ProcessLookupError</span><span class="p">):</span>
                <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>

<span class="k">class</span> <span class="nc">MinIntervalRateLimiter</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Simple per-process min-interval limiter.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">min_interval_sec</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_min</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">min_interval_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_min</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">since</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_last</span>
        <span class="k">if</span> <span class="n">since</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_min</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_min</span> <span class="o">-</span> <span class="n">since</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>

<span class="c1"># ============================================================
# Layer 2: Caches (memory + disk)
# ============================================================
</span>
<span class="k">class</span> <span class="nc">MemoryTTLCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Per-process TTL cache for a single key-space.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">ttl_sec</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_store</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_store</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">ts</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">item</span>
        <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_store</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">DiskJSONCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Shared JSON cache: tmp -&gt; fsync(tmp) -&gt; os.replace() -&gt; fsync(dir).
    - Atomic replace within same filesystem.
    - Robust on NFS/SMB/GPFS: readers may see slightly stale content (metadata propagation),
      so freshness is judged via both JSON </span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="s"> and file mtime with skew tolerance.
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ttl_sec</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">skew_eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_skew</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">skew_eps</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_path</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">stat</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="n">ts_in_file</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="c1"># Freshness by writer ts OR server mtime (tolerate skew)
</span>            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">age_by_ts</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">ts_in_file</span><span class="p">)</span> <span class="k">if</span> <span class="n">ts_in_file</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nf">float</span><span class="p">(</span><span class="sh">"</span><span class="s">inf</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">age_by_mtime</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">now</span> <span class="o">-</span> <span class="n">st</span><span class="p">.</span><span class="n">st_mtime</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">age_by_ts</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">)</span> <span class="ow">or</span> <span class="n">age_by_mtime</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">data</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_path</span><span class="p">)</span>
        <span class="n">dir_fd</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fd</span><span class="p">,</span> <span class="n">tmp_path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="p">.</span><span class="nf">mkstemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="sh">"</span><span class="s">bjobs_</span><span class="sh">"</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">"</span><span class="s">.json</span><span class="sh">"</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">dir_path</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">fdopen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmpfp</span><span class="p">:</span>
                    <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">},</span> <span class="n">tmpfp</span><span class="p">)</span>
                    <span class="n">tmpfp</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">tmpfp</span><span class="p">.</span><span class="nf">fileno</span><span class="p">())</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_path</span><span class="p">)</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">FileNotFoundError</span><span class="p">):</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>

<span class="c1"># ============================================================
# Layer 3: LSF primitives (fetcher/kill/command)
# ============================================================
</span>
<span class="k">class</span> <span class="nc">BJobsFetcher</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Fetch a full snapshot for the current user.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">shell</span><span class="p">:</span> <span class="n">ShellRunner</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">bjobs_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limiter</span><span class="p">:</span> <span class="n">MinIntervalRateLimiter</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_shell</span> <span class="o">=</span> <span class="n">shell</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_user</span> <span class="o">=</span> <span class="n">user</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs</span> <span class="o">=</span> <span class="n">bjobs_path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_limiter</span> <span class="o">=</span> <span class="n">limiter</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_limiter</span><span class="p">.</span><span class="nf">wait</span><span class="p">()</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-a </span><span class="sh">"</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="c1"># Use a minimal, whitespace-safe field set
</span>        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs</span><span class="si">}</span><span class="s"> -noheader -u </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s">-o </span><span class="se">\"</span><span class="s">jobid stat exit_code queue exec_host</span><span class="se">\"</span><span class="sh">"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_shell</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

        <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">exec_host</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">jid_i</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">result</span><span class="p">[</span><span class="n">jid_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="n">stat</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="sh">"</span><span class="s">-</span><span class="sh">"</span> <span class="k">else</span> <span class="n">exit_code</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="n">queue</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="n">exec_host</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span>

<span class="k">class</span> <span class="nc">BKiller</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Kill one or many jobs with bkill.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">shell</span><span class="p">:</span> <span class="n">ShellRunner</span><span class="p">,</span> <span class="n">bkill_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_shell</span> <span class="o">=</span> <span class="n">shell</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bkill</span> <span class="o">=</span> <span class="n">bkill_path</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">job_ids</span><span class="p">))]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">""</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-f </span><span class="sh">"</span> <span class="k">if</span> <span class="n">force</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_bkill</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">flag</span><span class="si">}{</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_shell</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">raise_on_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span>

<span class="k">class</span> <span class="nc">CommandRunner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Run arbitrary commands exactly as given and (only) parse </span><span class="sh">'</span><span class="s">Job &lt;id&gt;</span><span class="sh">'</span><span class="s"> from outputs.
    - If no job message, returns job_id=None (no exception unless raise_on_error=True).
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">shell</span><span class="p">:</span> <span class="n">ShellRunner</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_shell</span> <span class="o">=</span> <span class="n">shell</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_capture_job</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">cmd_str</span> <span class="o">=</span> <span class="nf">to_shell_str</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_shell</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="nf">parse_job_id_from_output</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">raise_on_error</span> <span class="ow">and</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">stdout</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">stderr</span><span class="p">,</span> <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span> <span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">job_id</span><span class="p">}</span>

<span class="c1"># ============================================================
# Layer 4: Snapshot cache service (mem+disk + singleflight)
# ============================================================
</span>
<span class="k">class</span> <span class="nc">JobsSnapshotCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Provides a full bjobs snapshot with:
      - per-process memory TTL cache
      - multi-process shared disk JSON cache
      - singleflight for concurrent callers in-process
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">fetcher</span><span class="p">:</span> <span class="n">BJobsFetcher</span><span class="p">,</span>
        <span class="n">mem_cache</span><span class="p">:</span> <span class="n">MemoryTTLCache</span><span class="p">,</span>
        <span class="n">disk_cache</span><span class="p">:</span> <span class="n">DiskJSONCache</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_fetcher</span> <span class="o">=</span> <span class="n">fetcher</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mem</span> <span class="o">=</span> <span class="n">mem_cache</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_disk</span> <span class="o">=</span> <span class="n">disk_cache</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">get</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all|</span><span class="si">{</span><span class="sh">'</span><span class="s">-a</span><span class="sh">'</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">''</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
            <span class="n">memo</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">memo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">memo</span>
            <span class="n">inflight</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inflight</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">inflight</span>

        <span class="n">fut</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">().</span><span class="nf">create_future</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fut</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
                <span class="n">disk</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_disk</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">disk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">disk</span><span class="p">.</span><span class="nf">items</span><span class="p">()})</span>
                    <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">({</span><span class="nf">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">disk</span><span class="p">.</span><span class="nf">items</span><span class="p">()})</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="n">fut</span>

            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_fetcher</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_disk</span><span class="p">.</span><span class="nf">write</span><span class="p">({</span><span class="nf">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">items</span><span class="p">()})</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">fut</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

<span class="c1"># ============================================================
# Layer 5: Public services (Status / Batched submit-cancel)
# ============================================================
</span>
<span class="k">class</span> <span class="nc">StatusService</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">User-facing status APIs built on top of the snapshot cache.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cache</span><span class="p">:</span> <span class="n">JobsSnapshotCache</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="n">cache</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">status</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">all_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="n">force_refresh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job_ids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_map</span>
        <span class="n">wanted</span> <span class="o">=</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">all_map</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">wanted</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">status_union_batched</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">list_of_job_id_sets</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
        <span class="n">union_ids</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="n">normalized</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">list_of_job_id_sets</span><span class="p">:</span>
            <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>
            <span class="n">normalized</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
            <span class="n">union_ids</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
        <span class="n">union_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">union_ids</span><span class="p">,</span> <span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="n">force_refresh</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[{</span><span class="n">i</span><span class="p">:</span> <span class="n">union_map</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req</span><span class="p">}</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">normalized</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">BatchSubmitter</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Submits heterogeneous commands (some may submit LSF jobs via wrappers).
    - Collects Job IDs by scanning outputs (</span><span class="sh">'</span><span class="s">Job &lt;id&gt;</span><span class="sh">'</span><span class="s">).
    - On interruption: stops launching new commands, waits for in-flight to finish
      (prevents orphan jobs), then bkill all collected Job IDs.
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">runner</span><span class="p">:</span> <span class="n">CommandRunner</span><span class="p">,</span> <span class="n">killer</span><span class="p">:</span> <span class="n">BKiller</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_runner</span> <span class="o">=</span> <span class="n">runner</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_killer</span> <span class="o">=</span> <span class="n">killer</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">commands</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">StrOrSeq</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">bool</span><span class="p">],</span>
        <span class="n">poll_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">kill_force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">kill_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">cmd_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">submitted</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">in_flight</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run_capture_job</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">cmd_timeout</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">cmd_raise_on_error</span><span class="p">)</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">or</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">in_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_in_flight</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">is_interrupted</span><span class="p">():</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">run_one</span><span class="p">(</span><span class="n">commands</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
                    <span class="n">in_flight</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                    <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll_interval_sec</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                        <span class="n">in_flight</span><span class="p">.</span><span class="nf">discard</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                            <span class="n">jid</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">jid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="n">submitted</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">poll_interval_sec</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Drain: ensure all running submissions complete and harvest Job IDs
</span>            <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">ALL_COMPLETED</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                        <span class="n">jid</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">jid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">submitted</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">interrupted</span> <span class="o">=</span> <span class="nf">is_interrupted</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">interrupted</span> <span class="ow">and</span> <span class="n">submitted</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_killer</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">submitted</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">kill_force</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">kill_raise_on_error</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">submitted_job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">submitted</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">interrupted</span><span class="sh">"</span><span class="p">:</span> <span class="n">interrupted</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">num_submitted</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">submitted</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">num_failed</span><span class="sh">"</span><span class="p">:</span> <span class="n">failures</span><span class="p">,</span>
        <span class="p">}</span>

<span class="c1"># ============================================================
# Layer 6: Facade (compose everything)
# ============================================================
</span>
<span class="k">class</span> <span class="nc">LSFClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    High-level facade that exposes:
      - run_command_capture_job
      - kill
      - status / status_union_batched
      - submit_many_with_cancel
    </span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LSFConfig</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span> <span class="ow">or</span> <span class="nc">LSFConfig</span><span class="p">()</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="n">user</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LSF_USER</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">getpass</span><span class="p">.</span><span class="nf">getuser</span><span class="p">()</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="n">cache_dir</span> <span class="ow">or</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">XDG_CACHE_HOME</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">expanduser</span><span class="p">(</span><span class="sh">"</span><span class="s">~</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">.cache</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">cache_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all_</span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># Core components
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_shell</span> <span class="o">=</span> <span class="nc">ShellRunner</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">max_concurrent_cli</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_limiter</span> <span class="o">=</span> <span class="nc">MinIntervalRateLimiter</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">bjobs_min_interval_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_fetcher</span> <span class="o">=</span> <span class="nc">BJobsFetcher</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_shell</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">bjobs_path</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">bjobs</span><span class="p">,</span> <span class="n">limiter</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_limiter</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mem_cache</span> <span class="o">=</span> <span class="nc">MemoryTTLCache</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">bjobs_ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_disk_cache</span> <span class="o">=</span> <span class="nc">DiskJSONCache</span><span class="p">(</span><span class="n">cache_path</span><span class="p">,</span> <span class="n">ttl_sec</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">disk_cache_ttl_sec</span><span class="p">,</span> <span class="n">skew_eps</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_snap_cache</span> <span class="o">=</span> <span class="nc">JobsSnapshotCache</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_fetcher</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem_cache</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_disk_cache</span><span class="p">)</span>

        <span class="c1"># Services
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_status</span> <span class="o">=</span> <span class="nc">StatusService</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_snap_cache</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_killer</span> <span class="o">=</span> <span class="nc">BKiller</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_shell</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">bkill</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_runner</span> <span class="o">=</span> <span class="nc">CommandRunner</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_shell</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_submitter</span> <span class="o">=</span> <span class="nc">BatchSubmitter</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_killer</span><span class="p">)</span>

    <span class="c1"># ----- Facade methods -----
</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_command_capture_job</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run_capture_job</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">raise_on_error</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_killer</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">raise_on_error</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span> <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_status</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="n">force_refresh</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">status_union_batched</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">list_of_job_id_sets</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="o">*</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span> <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_status</span><span class="p">.</span><span class="nf">status_union_batched</span><span class="p">(</span><span class="n">list_of_job_id_sets</span><span class="p">,</span> <span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="n">force_refresh</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">commands</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">StrOrSeq</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">bool</span><span class="p">],</span>
        <span class="n">poll_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">kill_force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">kill_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">cmd_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_submitter</span><span class="p">.</span><span class="nf">submit_many_with_cancel</span><span class="p">(</span>
            <span class="n">commands</span><span class="p">,</span>
            <span class="n">is_interrupted</span><span class="o">=</span><span class="n">is_interrupted</span><span class="p">,</span>
            <span class="n">poll_interval_sec</span><span class="o">=</span><span class="n">poll_interval_sec</span><span class="p">,</span>
            <span class="n">max_in_flight</span><span class="o">=</span><span class="n">max_in_flight</span><span class="p">,</span>
            <span class="n">kill_force</span><span class="o">=</span><span class="n">kill_force</span><span class="p">,</span>
            <span class="n">kill_raise_on_error</span><span class="o">=</span><span class="n">kill_raise_on_error</span><span class="p">,</span>
            <span class="n">cmd_timeout</span><span class="o">=</span><span class="n">cmd_timeout</span><span class="p">,</span>
            <span class="n">cmd_raise_on_error</span><span class="o">=</span><span class="n">cmd_raise_on_error</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></div>

<p>간단 사용 예시(필요한 부분만 복붙):</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># example.py
</span><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">lsf_pro</span> <span class="kn">import</span> <span class="n">LSFClient</span><span class="p">,</span> <span class="n">LSFConfig</span>

<span class="k">class</span> <span class="nc">Token</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span> <span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">delay</span>
    <span class="k">def</span> <span class="nf">is_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">):</span> <span class="nf">return </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">LSFClient</span><span class="p">(</span><span class="nc">LSFConfig</span><span class="p">(</span>
        <span class="n">bkill</span><span class="o">=</span><span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">bjobs</span><span class="o">=</span><span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">max_concurrent_cli</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">bjobs_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="o">=</span><span class="sh">"</span><span class="s">/shared/cache</span><span class="sh">"</span><span class="p">,</span>  <span class="c1"># 여러 머신이 보는 공유 경로
</span>    <span class="p">))</span>

    <span class="c1"># 1) 커맨드를 그대로 실행 (잡 메시지 있으면 job_id 파싱)
</span>    <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">run_command_capture_job</span><span class="p">(</span><span class="sh">"</span><span class="s">bsub -q short </span><span class="sh">'</span><span class="s">echo hi; sleep 1</span><span class="sh">'"</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">submit:</span><span class="sh">"</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

    <span class="c1"># 2) 상태 조회 (전체 스냅샷 캐시 활용)
</span>    <span class="n">all_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">num jobs:</span><span class="sh">"</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">all_map</span><span class="p">))</span>

    <span class="c1"># 3) 배치 제출 + 취소(3초 후)
</span>    <span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sh">"</span><span class="s">job_sub my_script.sh --epochs 3</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">sleep 1</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">bsub -q short </span><span class="sh">'</span><span class="s">echo X; sleep 2</span><span class="sh">'"</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">cmds</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="o">=</span><span class="nc">Token</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="n">is_interrupted</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
        <span class="n">kill_force</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">batch:</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h3 id="설계-요약-step-by-step">설계 요약 (step-by-step)</h3>

<ol>
  <li>
    <p><strong>ShellRunner</strong> : <code class="language-plaintext highlighter-rouge">create_subprocess_shell</code>만 사용, 동시 실행 제한.</p>
  </li>
  <li>
    <p><strong>MinIntervalRateLimiter</strong> : <code class="language-plaintext highlighter-rouge">bjobs</code> 과호출 방지.</p>
  </li>
  <li>
    <p><strong>MemoryTTLCache / DiskJSONCache</strong> : 프로세스 내/간 2중 캐시. 디스크는 tmp→<code class="language-plaintext highlighter-rouge">os.replace</code>→<code class="language-plaintext highlighter-rouge">fsync(dir)</code>로 견고.</p>
  </li>
  <li>
    <p><strong>BJobsFetcher</strong> : <code class="language-plaintext highlighter-rouge">-u &lt;user&gt;</code> 전체 스냅샷 + 최소 필드 파싱.</p>
  </li>
  <li>
    <p><strong>JobsSnapshotCache</strong> : 단일플라이트(in-process) + 메모리/디스크 캐시 오케스트레이션.</p>
  </li>
  <li>
    <p><strong>StatusService</strong> : 전체 스냅샷을 요청 ID로 필터.</p>
  </li>
  <li>
    <p><strong>CommandRunner</strong> : 어떤 커맨드든 그대로 실행, 출력에서만 <code class="language-plaintext highlighter-rouge">Job &lt;id&gt;</code> 파싱.</p>
  </li>
  <li>
    <p><strong>BKiller</strong> : 다수 ID를 한 번에 <code class="language-plaintext highlighter-rouge">bkill</code>.</p>
  </li>
  <li>
    <p><strong>BatchSubmitter</strong> : 인터럽트 시 새 제출 중단, <strong>진행 중은 기다려</strong> Job ID 수집 후 일괄 <code class="language-plaintext highlighter-rouge">bkill</code>(고아 방지).</p>
  </li>
  <li>
    <p><strong>LSFClient</strong> : 위 구성요소를 합친 퍼사드.</p>
  </li>
</ol>

<p>추가 원하시면 로깅 훅/메트릭스(호출 수, 평균 지연)·NFS 환경에서의 강제 리프레시 플래그·대규모 잡 스냅샷 샤딩까지 이어서 확장해 드릴게요.</p>

<p class="chat--user">

좀 과하게 나눈 것 아냐? 진짜 필요한 수준으로만 쪼개줘.

</p>

<p>좋아, “진짜 필요한 것만” 남겨서 딱 2개 클래스로 정리했어:</p>

<ul>
  <li>
    <p><strong>DiskJSONCache</strong> : 멀티프로세스 공유 디스크 캐시(원자적 replace + fsync + mtime/ts 이중 판정)</p>
  </li>
  <li>
    <p><strong>LSFClient</strong> : 나머지 전부(커맨드 실행, Job ID 파싱, bkill, bjobs 스냅샷 메모리/디스크 캐시, 레이트리밋, 일괄 제출+취소)</p>
  </li>
</ul>

<p>필수 기능만 담았고, <code class="language-plaintext highlighter-rouge">create_subprocess_shell</code>만 사용해. 잡 판별은 오직 출력의 <code class="language-plaintext highlighter-rouge">Job &lt;id&gt;</code>로 해.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># lsf_minimal.py
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>
<span class="kn">import</span> <span class="n">getpass</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="n">StrOrSeq</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
<span class="n">_JOBID_RE</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">str 또는 시퀀스를 받아 셸 문자열로. (시퀀스면 공백 join; 인용은 호출자 책임)</span><span class="sh">"""</span>
    <span class="k">return</span> <span class="n">cmd</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="nb">RuntimeError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Command failed: </span><span class="si">{</span><span class="n">cmd_str</span><span class="si">}</span><span class="s"> (rc=</span><span class="si">{</span><span class="n">returncode</span><span class="si">}</span><span class="s">)</span><span class="se">\n</span><span class="si">{</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">cmd_str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span>

<span class="c1"># ---------- 멀티프로세스 공유 디스크 캐시 ----------
</span><span class="k">class</span> <span class="nc">DiskJSONCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    tmp -&gt; fsync(tmp) -&gt; os.replace() -&gt; fsync(dir)
    - 같은 파일시스템 내 rename은 원자적.
    - 신선도 판단: 파일 내부 ts와 파일 mtime 모두 확인(+2s skew 허용).
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ttl_sec</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">skew_eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_skew</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">skew_eps</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_path</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">stat</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">age_by_ts</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">ts</span><span class="p">)</span> <span class="k">if</span> <span class="n">ts</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nf">float</span><span class="p">(</span><span class="sh">"</span><span class="s">inf</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">age_by_mtime</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">now</span> <span class="o">-</span> <span class="n">st</span><span class="p">.</span><span class="n">st_mtime</span><span class="p">)</span>
            <span class="n">fresh</span> <span class="o">=</span> <span class="p">(</span><span class="n">age_by_ts</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">age_by_mtime</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span> <span class="k">if</span> <span class="n">fresh</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_path</span><span class="p">)</span>
        <span class="n">dir_fd</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fd</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="p">.</span><span class="nf">mkstemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="sh">"</span><span class="s">bjobs_</span><span class="sh">"</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">"</span><span class="s">.json</span><span class="sh">"</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">fdopen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">},</span> <span class="n">f</span><span class="p">)</span>
                    <span class="n">f</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="nf">fileno</span><span class="p">())</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_path</span><span class="p">)</span>  <span class="c1"># atomic on same FS
</span>                <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">FileNotFoundError</span><span class="p">):</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>

<span class="c1"># ---------- 메인 클라이언트 ----------
</span><span class="k">class</span> <span class="nc">LSFClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    꼭 필요한 것만:
      - run_command_capture_job: 커맨드 그대로 실행, 출력에서 Job &lt;id&gt;만 파싱
      - kill: bkill (여러 ID 한 번에)
      - status: bjobs 전체 스냅샷 (메모리+디스크 캐시, 레이트리밋)
      - submit_many_with_cancel: 인터럽트 시 새 실행 중단, 진행분 완주 후 job_id 일괄 bkill
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">bkill</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">bjobs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">max_concurrent_cli</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">bjobs_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_paths</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">:</span> <span class="n">bkill</span><span class="p">,</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">:</span> <span class="n">bjobs</span><span class="p">}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">max_concurrent_cli</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_min_interval</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_min_interval_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="c1"># 메모리 캐시(key -&gt; (ts, data))
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_mem_cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># 단일플라이트
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># 공유 디스크 캐시
</span>        <span class="n">user</span> <span class="o">=</span> <span class="n">user</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LSF_USER</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">getpass</span><span class="p">.</span><span class="nf">getuser</span><span class="p">()</span>
        <span class="n">base_cache</span> <span class="o">=</span> <span class="n">cache_dir</span> <span class="ow">or</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">XDG_CACHE_HOME</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">expanduser</span><span class="p">(</span><span class="sh">"</span><span class="s">~</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">.cache</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">cache_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base_cache</span><span class="p">,</span> <span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all_</span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_disk</span> <span class="o">=</span> <span class="nc">DiskJSONCache</span><span class="p">(</span><span class="n">cache_path</span><span class="p">,</span> <span class="n">ttl_sec</span><span class="o">=</span><span class="n">disk_cache_ttl_sec</span><span class="p">,</span> <span class="n">skew_eps</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_user</span> <span class="o">=</span> <span class="n">user</span>

        <span class="c1"># locale 안정화
</span>        <span class="n">base_env</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LC_ALL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LANG</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_env</span> <span class="o">=</span> <span class="n">base_env</span> <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="bp">None</span> <span class="nf">else </span><span class="p">(</span><span class="n">base_env</span> <span class="o">|</span> <span class="n">env</span><span class="p">)</span>

    <span class="c1"># ---- 내부 헬퍼 ----
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_run_shell</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_sem</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_shell</span><span class="p">(</span>
                <span class="n">cmd_str</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_env</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ProcessLookupError</span><span class="p">):</span>
                <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>

    <span class="c1"># ---- 커맨드 실행(잡 메시지 파싱) ----
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_command_capture_job</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">cmd_str</span> <span class="o">=</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_run_shell</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">raise_on_error</span> <span class="ow">and</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">stdout</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">stderr</span><span class="p">,</span> <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span> <span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">job_id</span><span class="p">}</span>

    <span class="c1"># ---- bkill ----
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">job_ids</span><span class="p">))]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">""</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-f </span><span class="sh">"</span> <span class="k">if</span> <span class="n">force</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bkill</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">flag</span><span class="si">}{</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_run_shell</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">raise_on_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span>

    <span class="c1"># ---- bjobs 전체 스냅샷 (캐시) ----
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="c1"># 레이트리밋
</span>        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">since</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span>
        <span class="k">if</span> <span class="n">since</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_min_interval</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_min_interval</span> <span class="o">-</span> <span class="n">since</span><span class="p">)</span>

        <span class="n">flag</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-a </span><span class="sh">"</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="c1"># 공백 안전한 필드만
</span>        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bjobs</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> -noheader -u </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s">-o </span><span class="sh">'</span><span class="s">jobid stat exit_code queue exec_host</span><span class="sh">'"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_run_shell</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

        <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">exec_host</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">jid_i</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">result</span><span class="p">[</span><span class="n">jid_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="n">stat</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="sh">"</span><span class="s">-</span><span class="sh">"</span> <span class="k">else</span> <span class="n">exit_code</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="n">queue</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="n">exec_host</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_status_all_cached</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span> <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all|</span><span class="si">{</span><span class="sh">'</span><span class="s">-a</span><span class="sh">'</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">''</span><span class="si">}</span><span class="sh">"</span>
        <span class="c1"># 메모리 캐시
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem_cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">item</span><span class="p">:</span>
                <span class="n">ts</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">item</span>
                <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">data</span>
            <span class="c1"># 단일플라이트
</span>            <span class="n">inflight</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inflight</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">inflight</span>

        <span class="n">fut</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">().</span><span class="nf">create_future</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fut</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
                <span class="n">disk</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_disk</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">disk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">disk</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_mem_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
                    <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">data</span>

            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_mem_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_disk</span><span class="p">.</span><span class="nf">write</span><span class="p">({</span><span class="nf">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">items</span><span class="p">()})</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">status</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">all_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_status_all_cached</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="n">force_refresh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job_ids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_map</span>
        <span class="n">wanted</span> <span class="o">=</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">all_map</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">wanted</span><span class="p">}</span>

    <span class="c1"># ---- 배치 제출 + 취소 ----
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">commands</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">StrOrSeq</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="p">:</span> <span class="nb">callable</span><span class="p">,</span>            <span class="c1"># () -&gt; bool
</span>        <span class="n">poll_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">kill_force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">kill_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">cmd_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        명령을 그대로 실행(create_subprocess_shell). 출력에서 </span><span class="sh">'</span><span class="s">Job &lt;id&gt;</span><span class="sh">'</span><span class="s">만 추출.
        인터럽트 시 새 실행 중단, 진행 중 제출은 끝까지 기다린 뒤 수집된 job_id 일괄 bkill.
        </span><span class="sh">"""</span>
        <span class="n">submitted</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">in_flight</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">run_command_capture_job</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">cmd_timeout</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">cmd_raise_on_error</span><span class="p">)</span>

        <span class="n">idx</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">or</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">in_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_in_flight</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">is_interrupted</span><span class="p">():</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">run_one</span><span class="p">(</span><span class="n">commands</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
                    <span class="n">in_flight</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                    <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll_interval_sec</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                        <span class="n">in_flight</span><span class="p">.</span><span class="nf">discard</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                            <span class="n">jid</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">jid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="n">submitted</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">poll_interval_sec</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># drain
</span>            <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">ALL_COMPLETED</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                        <span class="n">jid</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">jid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">submitted</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">interrupted</span> <span class="o">=</span> <span class="nf">is_interrupted</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">interrupted</span> <span class="ow">and</span> <span class="n">submitted</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">submitted</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">kill_force</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">kill_raise_on_error</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">submitted_job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">submitted</span><span class="p">,</span> <span class="sh">"</span><span class="s">interrupted</span><span class="sh">"</span><span class="p">:</span> <span class="n">interrupted</span><span class="p">,</span> <span class="sh">"</span><span class="s">num_submitted</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">submitted</span><span class="p">),</span> <span class="sh">"</span><span class="s">num_failed</span><span class="sh">"</span><span class="p">:</span> <span class="n">failures</span><span class="p">}</span>
</code></pre></div></div>

<h3 id="빠른-사용-예-필요부분만">빠른 사용 예 (필요부분만)</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># example_min.py
</span><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">lsf_minimal</span> <span class="kn">import</span> <span class="n">LSFClient</span>

<span class="k">class</span> <span class="nc">Token</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span> <span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">delay</span>
    <span class="k">def</span> <span class="nf">is_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">):</span> <span class="nf">return </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span><span class="o">-</span><span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">LSFClient</span><span class="p">(</span>
        <span class="n">max_concurrent_cli</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">bjobs_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="o">=</span><span class="sh">"</span><span class="s">/shared/cache</span><span class="sh">"</span><span class="p">,</span>  <span class="c1"># 여러 머신이 보는 경로
</span>    <span class="p">)</span>

    <span class="c1"># 1) 커맨드 그대로 실행 (잡 메시지 있으면 job_id 파싱)
</span>    <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">run_command_capture_job</span><span class="p">(</span><span class="sh">"</span><span class="s">bsub -q short </span><span class="sh">'</span><span class="s">echo hi; sleep 1</span><span class="sh">'"</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">submit:</span><span class="sh">"</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

    <span class="c1"># 2) 상태 (전체 스냅샷 캐시)
</span>    <span class="n">all_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs:</span><span class="sh">"</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">all_map</span><span class="p">))</span>

    <span class="c1"># 3) 배치 제출 + 3초 후 취소
</span>    <span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">sleep 1</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">bsub -q short </span><span class="sh">'</span><span class="s">echo X; sleep 2</span><span class="sh">'"</span><span class="p">,</span> <span class="sh">"</span><span class="s">job_sub my_script.sh --epochs 3</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">cmds</span><span class="p">,</span> <span class="n">is_interrupted</span><span class="o">=</span><span class="nc">Token</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="n">is_interrupted</span><span class="p">,</span> <span class="n">max_in_flight</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">cmd_timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">kill_force</span><span class="o">=</span><span class="bp">True</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">batch:</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<h3 id="왜-이렇게-최소화했는지-step-by-step">왜 이렇게 최소화했는지 (step-by-step)</h3>

<ol>
  <li>
    <p><strong>핵심 책임 2개만 분리</strong> : “디스크 캐시”는 멀티프로세스/멀티머신 안전성이 핵심이라 독립 클래스로 유지, 나머지는 <code class="language-plaintext highlighter-rouge">LSFClient</code>에.</p>
  </li>
  <li>
    <p><strong>한 눈에 읽히는 흐름</strong> : 실행 → 파싱 → 캐시 → 레이트리밋 → 배치/취소까지 <code class="language-plaintext highlighter-rouge">LSFClient</code> 안에서 추적 가능.</p>
  </li>
  <li>
    <p><strong>운영 현실 반영</strong> : 공유 FS에 맞춘 <code class="language-plaintext highlighter-rouge">os.replace + fsync(dir)</code>와 <code class="language-plaintext highlighter-rouge">mtime/ts</code> 이중 판정, TTL 기본 5s로 안전한 디폴트.</p>
  </li>
</ol>

<p>더 줄이고 싶으면 <code class="language-plaintext highlighter-rouge">DiskJSONCache</code>도 내부 함수로 접어둘 수 있지만, 멀티프로세스 안전성의 결로가 분명해서 이 정도 분리가 “진짜 필요한 최소”라 봤어. 필요하면 로깅 훅만 살짝 추가해드릴게!</p>

<p class="chat--user">

진짜 필요한 최소로도 하지말고, 너무 과하게 늘리지도 말고. 그냥 고수가 했을 법한 유지보수 할만한 정도로 짜주면 돼. 너가 생각하는 최적을 따라줘.

</p>

<p>좋아, “적당히 쪼갠 프로” 버전으로 정리했어.<br />
핵심만 3파츠로 나눴고, 과하지 않게 유지보수 용이하도록 구성했어.</p>

<ul>
  <li>
    <p><strong>ShellRunner</strong> : <code class="language-plaintext highlighter-rouge">create_subprocess_shell</code> + 동시성 제어</p>
  </li>
  <li>
    <p><strong>SharedCache</strong> : 메모리+디스크(멀티프로세스 공유) TTL 캐시 — tmp→<code class="language-plaintext highlighter-rouge">os.replace</code>→<code class="language-plaintext highlighter-rouge">fsync(dir)</code>로 견고</p>
  </li>
  <li>
    <p><strong>LSFClient</strong> : 사용자 API (커맨드 실행·JobID 파싱, <code class="language-plaintext highlighter-rouge">bkill</code>, <code class="language-plaintext highlighter-rouge">bjobs</code> 스냅샷+캐시, 배치 제출+취소)</p>
  </li>
</ul>

<p>아래 파일 하나면 끝. (<code class="language-plaintext highlighter-rouge">lsf_core.py</code> 같은 이름으로 저장)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># lsf_core.py
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>
<span class="kn">import</span> <span class="n">getpass</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1"># ===================== 공용 유틸 =====================
</span>
<span class="n">StrOrSeq</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
<span class="n">_JOBID_RE</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">cmd</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="nb">RuntimeError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Command failed: </span><span class="si">{</span><span class="n">cmd_str</span><span class="si">}</span><span class="s"> (rc=</span><span class="si">{</span><span class="n">returncode</span><span class="si">}</span><span class="s">)</span><span class="se">\n</span><span class="si">{</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">cmd_str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span>

<span class="c1"># ===================== ShellRunner =====================
</span>
<span class="k">class</span> <span class="nc">ShellRunner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">create_subprocess_shell만 사용. 동시 실행 수를 세마포어로 제한.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">max_concurrency</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">max_concurrency</span><span class="p">)</span>
        <span class="n">base_env</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LC_ALL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LANG</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_env</span> <span class="o">=</span> <span class="n">base_env</span> <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="bp">None</span> <span class="nf">else </span><span class="p">(</span><span class="n">base_env</span> <span class="o">|</span> <span class="n">env</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_sem</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_shell</span><span class="p">(</span>
                <span class="n">cmd_str</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_env</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ProcessLookupError</span><span class="p">):</span>
                <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>

<span class="c1"># ===================== SharedCache (mem+disk) =====================
</span>
<span class="k">class</span> <span class="nc">SharedCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    멀티프로세스 공유 JSON 캐시:
    - 메모리 TTL + 디스크 TTL (같은 FS 내 rename 원자성 보장)
    - 쓰기: tmp -&gt; fsync(tmp) -&gt; os.replace -&gt; fsync(dir)
    - 신선도: JSON 내부 ts와 파일 mtime 모두 사용(+2s skew 허용)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ttl_sec</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">,</span> <span class="n">skew_eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">cache_dir</span> <span class="ow">or</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">XDG_CACHE_HOME</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">expanduser</span><span class="p">(</span><span class="sh">"</span><span class="s">~</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">.cache</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_root</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_skew</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">skew_eps</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_key_path</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">safe</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">[^A-Za-z0-9._-]+</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">safe</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># 1) 메모리
</span>        <span class="n">item</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">:</span>
            <span class="n">ts</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="c1"># 2) 디스크
</span>        <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_key_path</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">stat</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="n">ts_in</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">fresh_by_ts</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">ts_in</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">)</span> <span class="k">if</span> <span class="n">ts_in</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">False</span>
            <span class="n">fresh_by_mtime</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="nf">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">st</span><span class="p">.</span><span class="n">st_mtime</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fresh_by_ts</span> <span class="ow">or</span> <span class="n">fresh_by_mtime</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_key_path</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">dir_fd</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fd</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="p">.</span><span class="nf">mkstemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="sh">"</span><span class="s">cache_</span><span class="sh">"</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">"</span><span class="s">.json</span><span class="sh">"</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">fdopen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">},</span> <span class="n">f</span><span class="p">)</span>
                    <span class="n">f</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="nf">fileno</span><span class="p">())</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">FileNotFoundError</span><span class="p">):</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>

<span class="c1"># ===================== LSFClient (Public API) =====================
</span>
<span class="k">class</span> <span class="nc">LSFClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - run_command_capture_job: 커맨드를 그대로 실행, 출력에서 </span><span class="sh">'</span><span class="s">Job &lt;id&gt;</span><span class="sh">'</span><span class="s">만 파싱
    - kill: bkill (여러 ID 일괄)
    - status: bjobs 전체 스냅샷(메모리+디스크 캐시, 레이트리밋, in-process single-flight)
    - submit_many_with_cancel: 인터럽트 시 새 실행 중단, 진행 중은 완주 → 수집한 job_id 일괄 bkill
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">bkill</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">bjobs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">max_concurrent_cli</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">bjobs_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_paths</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">:</span> <span class="n">bkill</span><span class="p">,</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">:</span> <span class="n">bjobs</span><span class="p">}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_runner</span> <span class="o">=</span> <span class="nc">ShellRunner</span><span class="p">(</span><span class="n">max_concurrent_cli</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_user</span> <span class="o">=</span> <span class="n">user</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LSF_USER</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">getpass</span><span class="p">.</span><span class="nf">getuser</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="nc">SharedCache</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">ttl_sec</span><span class="o">=</span><span class="n">disk_cache_ttl_sec</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">,</span> <span class="n">skew_eps</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>

        <span class="c1"># bjobs 제어
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_min_interval_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># single-flight per key
</span>
    <span class="c1"># ---------- 일반 커맨드 실행 + Job ID 파싱 ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_command_capture_job</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">raise_on_error</span> <span class="ow">and</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">stdout</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">stderr</span><span class="p">,</span> <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span> <span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">job_id</span><span class="p">}</span>

    <span class="c1"># ---------- bkill ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">job_ids</span><span class="p">))]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">""</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-f </span><span class="sh">"</span> <span class="k">if</span> <span class="n">force</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bkill</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">flag</span><span class="si">}{</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">raise_on_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span>

    <span class="c1"># ---------- bjobs snapshot (캐시 + 단일플라이트 + 레이트리밋) ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="c1"># per-process rate-limit
</span>        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">since</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span>
        <span class="k">if</span> <span class="n">since</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">-</span> <span class="n">since</span><span class="p">)</span>

        <span class="n">flag</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-a </span><span class="sh">"</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="c1"># 공백 안전 필드만
</span>        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bjobs</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> -noheader -u </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s">-o </span><span class="sh">'</span><span class="s">jobid stat exit_code queue exec_host</span><span class="sh">'"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

        <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">exec_host</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">jid_i</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">result</span><span class="p">[</span><span class="n">jid_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="n">stat</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="sh">"</span><span class="s">-</span><span class="sh">"</span> <span class="k">else</span> <span class="n">exit_code</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="n">queue</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="n">exec_host</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_status_all_cached</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all|</span><span class="si">{</span><span class="sh">'</span><span class="s">-a</span><span class="sh">'</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">''</span><span class="si">}</span><span class="s">|user=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="sh">"</span>

        <span class="c1"># 1) 메모리/디스크 캐시
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
            <span class="n">cached</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cached</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># 디스크·메모리 캐시는 직전에 set된 dict(str-&gt;obj)일 수 있음
</span>                <span class="k">return</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">cached</span><span class="p">.</span><span class="nf">items</span><span class="p">()</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cached</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])}</span>

            <span class="c1"># 2) in-process single-flight
</span>            <span class="n">inflight</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inflight</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">inflight</span>

        <span class="n">fut</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">().</span><span class="nf">create_future</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fut</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">items</span><span class="p">()})</span>  <span class="c1"># 디스크엔 str key로 저장
</span>            <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">status</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">all_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_status_all_cached</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="n">force_refresh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job_ids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_map</span>
        <span class="n">wanted</span> <span class="o">=</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">all_map</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">wanted</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">status_union_batched</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">list_of_job_id_sets</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
        <span class="n">union</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="n">normalized</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">list_of_job_id_sets</span><span class="p">:</span>
            <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>
            <span class="n">normalized</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
            <span class="n">union</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
        <span class="n">union_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">union</span><span class="p">,</span> <span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="n">force_refresh</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[{</span><span class="n">i</span><span class="p">:</span> <span class="n">union_map</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req</span><span class="p">}</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">normalized</span><span class="p">]</span>

    <span class="c1"># ---------- 배치 제출 + 취소 ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">commands</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">StrOrSeq</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="p">:</span> <span class="nb">callable</span><span class="p">,</span>            <span class="c1"># () -&gt; bool
</span>        <span class="n">poll_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">kill_force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">kill_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">cmd_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        커맨드를 그대로 실행. 출력의 </span><span class="sh">'</span><span class="s">Job &lt;id&gt;</span><span class="sh">'</span><span class="s">만 추출해 수집.
        인터럽트 시: 새 실행 중단, 진행 중 제출은 끝까지 기다림(고아 방지) → 수집된 job_id 일괄 bkill.
        </span><span class="sh">"""</span>
        <span class="n">submitted</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">in_flight</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">run_command_capture_job</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">cmd_timeout</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">cmd_raise_on_error</span><span class="p">)</span>

        <span class="n">idx</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">or</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">in_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_in_flight</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">is_interrupted</span><span class="p">():</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">run_one</span><span class="p">(</span><span class="n">commands</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
                    <span class="n">in_flight</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                    <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll_interval_sec</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                        <span class="n">in_flight</span><span class="p">.</span><span class="nf">discard</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                            <span class="n">jid</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">jid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="n">submitted</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">poll_interval_sec</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># drain: 남은 제출은 완주시켜 Job ID 수집
</span>            <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">ALL_COMPLETED</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                        <span class="n">jid</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">jid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">submitted</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">interrupted</span> <span class="o">=</span> <span class="nf">is_interrupted</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">interrupted</span> <span class="ow">and</span> <span class="n">submitted</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">submitted</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">kill_force</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">kill_raise_on_error</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">submitted_job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">submitted</span><span class="p">,</span> <span class="sh">"</span><span class="s">interrupted</span><span class="sh">"</span><span class="p">:</span> <span class="n">interrupted</span><span class="p">,</span> <span class="sh">"</span><span class="s">num_submitted</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">submitted</span><span class="p">),</span> <span class="sh">"</span><span class="s">num_failed</span><span class="sh">"</span><span class="p">:</span> <span class="n">failures</span><span class="p">}</span>
</code></pre></div></div>

<h3 id="사용-예-짧게">사용 예 (짧게)</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">lsf_core</span> <span class="kn">import</span> <span class="n">LSFClient</span>

<span class="k">class</span> <span class="nc">Token</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span> <span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">delay</span>
    <span class="k">def</span> <span class="nf">is_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">):</span> <span class="nf">return </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span><span class="o">-</span><span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">LSFClient</span><span class="p">(</span>
        <span class="n">max_concurrent_cli</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">bjobs_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="o">=</span><span class="sh">"</span><span class="s">/shared/cache</span><span class="sh">"</span><span class="p">,</span>  <span class="c1"># 여러 머신이 보는 경로(같은 FS)
</span>    <span class="p">)</span>

    <span class="c1"># 1) 커맨드 그대로 실행 (잡 메시지 있으면 파싱)
</span>    <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">run_command_capture_job</span><span class="p">(</span><span class="sh">"</span><span class="s">bsub -q short </span><span class="sh">'</span><span class="s">echo hi; sleep 1</span><span class="sh">'"</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">submit:</span><span class="sh">"</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

    <span class="c1"># 2) bjobs 상태(스냅샷 캐시)
</span>    <span class="n">all_jobs</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">N(all) =</span><span class="sh">"</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">all_jobs</span><span class="p">))</span>

    <span class="c1"># 3) 배치 제출 + 3초 후 취소 → 수집된 job_id 일괄 bkill
</span>    <span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">sleep 1</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">bsub -q short </span><span class="sh">'</span><span class="s">echo X; sleep 2</span><span class="sh">'"</span><span class="p">,</span> <span class="sh">"</span><span class="s">job_sub my_script.sh --epochs 3</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">cmds</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="o">=</span><span class="nc">Token</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="n">is_interrupted</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
        <span class="n">kill_force</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">batch:</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<h3 id="왜-이-구성이-적당히-고수-느낌인가-짧게-step-by-step">왜 이 구성이 “적당히 고수 느낌”인가 (짧게, step-by-step)</h3>

<ol>
  <li>
    <p><strong>역할 분리 최소화</strong> : 프로세스 실행과 캐시만 별도 클래스로 분리. 나머지는 <code class="language-plaintext highlighter-rouge">LSFClient</code>에서 한 눈에 추적.</p>
  </li>
  <li>
    <p><strong>운영 안전성</strong> : 공유 FS에서 <strong>tmp→replace→fsync(dir)</strong> , TTL은 <strong>ts+mtime 이중 판정</strong>.</p>
  </li>
  <li>
    <p><strong>성능/부하 배려</strong> : in-process <strong>single-flight</strong> , per-process <strong>레이트리밋</strong> , <strong>전체 스냅샷</strong> 후 필터로 <code class="language-plaintext highlighter-rouge">bjobs</code> 호출 최소화.</p>
  </li>
  <li>
    <p><strong>현실 친화성</strong> : 커맨드를 <strong>있는 그대로</strong> 실행, <code class="language-plaintext highlighter-rouge">Job &lt;id&gt;</code> 메시지로만 판별 → bsub 래퍼/스크립트 모두 커버.</p>
  </li>
  <li>
    <p><strong>확장 여지</strong> : 필요 시 로깅/메트릭, 강제 새로고침(<code class="language-plaintext highlighter-rouge">force_refresh</code>) 훅, 샤딩 등 쉽게 추가 가능.</p>
  </li>
</ol>

<p>원하는 스타일이나 코딩 컨벤션(로거, 타입힌트 레벨 강화, 에러코드 매핑 등)이 있으면 거기에 맞춰 딱 맞게 다듬어줄게.</p>

<p class="chat--user">

근데 bkill에 -f 옵션 없는데

</p>

<p>맞아요. 제 실수입니다—<code class="language-plaintext highlighter-rouge">bkill</code>에는 <code class="language-plaintext highlighter-rouge">-f</code>가 없습니다. “강제”에 해당하는 건 <strong><code class="language-plaintext highlighter-rouge">-r</code>(force remove)</strong> 이고, 상황에 따라 <strong><code class="language-plaintext highlighter-rouge">-d</code>(kill 후 상태를 DONE으로 기록)</strong>, <strong><code class="language-plaintext highlighter-rouge">-s</code>(특정 signal 전송)</strong> 등을 씁니다. <a href="https://www.ibm.com/docs/en/spectrum-lsf/10.1.0?topic=jobs-forcefully-removing-job-from-lsf&amp;utm_source=chatgpt.com">IBM+1</a></p>

<p>아래처럼 <strong>메서드 시그니처와 구현을 고쳐</strong> 쓰면 됩니다.</p>

<h2 id="step-1-kill-메서드-교체">Step 1) <code class="language-plaintext highlighter-rouge">kill()</code> 메서드 교체</h2>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">force</code> 대신 <code class="language-plaintext highlighter-rouge">force_remove</code>(→ <code class="language-plaintext highlighter-rouge">-r</code>)</p>
  </li>
  <li>
    <p>필요 시 <code class="language-plaintext highlighter-rouge">record_done</code>(→ <code class="language-plaintext highlighter-rouge">-d</code>)</p>
  </li>
  <li>
    <p>임의 시그널은 <code class="language-plaintext highlighter-rouge">signal</code>(→ <code class="language-plaintext highlighter-rouge">-s SIG</code>)로 지정</p>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># LSFClient.kill 교체 버전
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span>
    <span class="n">self</span><span class="p">,</span>
    <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">force_remove</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>          <span class="c1"># was: force
</span>    <span class="n">record_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>           <span class="c1"># -&gt; -d (RUN/USUSP/SSUSP에서 DONE 기록)
</span>    <span class="n">signal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>        <span class="c1"># -&gt; -s TERM / -s 9 등
</span>    <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
    <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">job_ids</span><span class="p">))]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span><span class="sh">""</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">flags</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">record_done</span><span class="p">:</span>
        <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">-d</span><span class="sh">"</span><span class="p">)</span>               <span class="c1"># 기록을 DONE으로. 원격 클러스터 시 주로 유용. :contentReference[oaicite:1]{index=1}
</span>    <span class="k">if</span> <span class="n">force_remove</span><span class="p">:</span>
        <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">-r</span><span class="sh">"</span><span class="p">)</span>               <span class="c1"># LSF에서 즉시 제거(리소스 해제). :contentReference[oaicite:2]{index=2}
</span>    <span class="k">if</span> <span class="n">signal</span><span class="p">:</span>
        <span class="n">flags</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-s</span><span class="sh">"</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">signal</span><span class="p">)]</span>     <span class="c1"># 특정 시그널 지정
</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bkill</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
    <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">raise_on_error</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span>
</code></pre></div></div>

<blockquote>
  <p>참고</p>

  <ul>
    <li>
      <p><code class="language-plaintext highlighter-rouge">-r</code>: OS에서 완전히 종료되기 전이라도 LSF에서 <strong>즉시 제거</strong> 하고 리소스를 해제합니다. <a href="https://www.ibm.com/docs/en/spectrum-lsf/10.1.0?topic=jobs-forcefully-removing-job-from-lsf&amp;utm_source=chatgpt.com">IBM+1</a></p>
    </li>
    <li>
      <p><code class="language-plaintext highlighter-rouge">-d</code>: 잡을 종료하고 <strong>상태를 DONE으로 기록</strong> 합니다(시작된 잡에 한함). 원격 클러스터 워크플로에서 유용. <a href="https://www.ibm.com/docs/en/spectrum-lsf/10.1.0?topic=13-job-scheduling-execution&amp;utm_source=chatgpt.com">IBM</a></p>
    </li>
    <li>
      <p><code class="language-plaintext highlighter-rouge">-s</code>: 원하는 시그널을 직접 보낼 수 있습니다. (예: <code class="language-plaintext highlighter-rouge">-s TERM</code>, <code class="language-plaintext highlighter-rouge">-s 9</code>). <a href="https://tin6150.github.io/psg/3rdParty/lsf4_userGuide/07-tracking.html?utm_source=chatgpt.com">tin6150.github.io+1</a></p>
    </li>
  </ul>

</blockquote>

<h2 id="step-2-배치-취소-경로도-같이-수정">Step 2) 배치 취소 경로도 같이 수정</h2>

<p>기존 <code class="language-plaintext highlighter-rouge">submit_many_with_cancel()</code> 안에서 <code class="language-plaintext highlighter-rouge">await self.kill(submitted, force=True, ...)</code>로 호출하셨다면:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 기존
# await self.kill(submitted, force=True, raise_on_error=kill_raise_on_error)
</span>
<span class="c1"># 변경
</span><span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span>
    <span class="n">submitted</span><span class="p">,</span>
    <span class="n">force_remove</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>                  <span class="c1"># -r
</span>    <span class="c1"># 필요하면 record_done=True 도 추가 가능
</span>    <span class="n">raise_on_error</span><span class="o">=</span><span class="n">kill_raise_on_error</span>
<span class="p">)</span>
</code></pre></div></div>

<h2 id="step-3-사용-예시">Step 3) 사용 예시</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 1) 즉시 제거(LSF에서 빠르게 치우고 싶을 때)
</span><span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">kill</span><span class="p">([</span><span class="mi">101</span><span class="p">,</span> <span class="mi">102</span><span class="p">],</span> <span class="n">force_remove</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># 2) 특정 시그널 전송 후 제거
</span><span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="mi">103</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="sh">"</span><span class="s">TERM</span><span class="sh">"</span><span class="p">)</span>            <span class="c1"># TERM만 보내고 기본 동작
</span><span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="mi">104</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="sh">"</span><span class="s">KILL</span><span class="sh">"</span><span class="p">)</span>            <span class="c1"># 바로 KILL 신호
</span><span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="mi">105</span><span class="p">,</span> <span class="n">force_remove</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>        <span class="c1"># LSF에서 즉시 제거(-r)
</span>
<span class="c1"># 3) DONE 기록 옵션 (원격 클러스터 시 유용)
</span><span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">kill</span><span class="p">([</span><span class="mi">201</span><span class="p">,</span><span class="mi">202</span><span class="p">],</span> <span class="n">record_done</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>   <span class="c1"># -d
</span></code></pre></div></div>

<h2 id="선택-pend만-걷어내고-싶다면">(선택) PEND만 걷어내고 싶다면</h2>

<p>운영 정책상 “대기(PEND)만” 정리하려면 <code class="language-plaintext highlighter-rouge">bkill -stat pend</code>가 있습니다(일부 옵션과는 병행 불가). 필요 시 전용 유틸을 추가하세요. <a href="https://www.ibm.com/docs/en/spectrum-lsf/10.1.0?topic=jobs-kill-job-bkill&amp;utm_source=chatgpt.com">IBM</a></p>

<hr />

<p>필요하면 제가 드린 <code class="language-plaintext highlighter-rouge">lsf_core.py</code>/<code class="language-plaintext highlighter-rouge">lsf_minimal.py</code>에도 위 변경을 반영한 <strong>작은 패치 버전</strong> 으로 정리해 드릴게요.</p>

<p class="chat--user">

1. 각각 command의 job id를 알고 싶어. 매칭이 필요해. 2. 다음과 같은 예시로 많이 쓸 것 같아. 알맞게 짜줘. cmds = ["job_sub a.txt", "mkdir package", "bsub -q short sleep"] data = client.submit_many_with_cancel(cmds, is_interrupted=is_interrupted) if is_interrupted(): print("중지되었습니다.“) return job_ids = … #data로 부터 running job id 추출 while not client.is_finished(job_ids): status = client.status(job_ids) for job_id in job_ids: job_command = … #data로부터 job_id에 해당하는 커맨드 추출 print(job_id, status[job_id], job_command) await asyncio.sleep(1) if is_interrupted(): await client.kill(job_ids) print("중지하였습니다.”) return print("모두 완료되었습니다.“)

</p>

<p>좋아! “적당히 프로스럽고 유지보수 쉬운” 버전으로 다듬어서:</p>

<ul>
  <li>
    <p>구조는 <strong>3 파트</strong> 만 유지</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">ShellRunner</code>: <code class="language-plaintext highlighter-rouge">create_subprocess_shell</code> + 동시성 제어</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">SharedCache</code>: 메모리+디스크 TTL 캐시(멀티프로세스 공유, tmp→replace→fsync(dir))</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">LSFClient</code>: 사용자 API(커맨드 실행·JobID 매칭, <code class="language-plaintext highlighter-rouge">bkill</code>, <code class="language-plaintext highlighter-rouge">bjobs</code> 스냅샷/캐시, <strong>배치 제출+취소, is_finished</strong>)</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>요구 포인트 반영</strong></p>

    <ol>
      <li>
        <p>각 커맨드와 <strong>Job ID 매칭</strong> : <code class="language-plaintext highlighter-rouge">SubmitResult</code>/<code class="language-plaintext highlighter-rouge">SubmitItem</code>에 <strong>양방향 매핑</strong> 포함</p>
      </li>
      <li>
        <p>예시 패턴 그대로 사용 가능: <code class="language-plaintext highlighter-rouge">submit_many_with_cancel</code> 결과에서 <code class="language-plaintext highlighter-rouge">job_ids</code>, <code class="language-plaintext highlighter-rouge">job_id_to_command</code> 바로 꺼내 쓰고, <code class="language-plaintext highlighter-rouge">is_finished()</code> 제공</p>
      </li>
    </ol>
  </li>
</ul>

<p>아래 파일 하나로 끝 (<code class="language-plaintext highlighter-rouge">lsf_core.py</code> 등으로 저장):</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># lsf_core.py
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>
<span class="kn">import</span> <span class="n">getpass</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1"># ===================== 공용 유틸 =====================
</span>
<span class="n">StrOrSeq</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
<span class="n">_JOBID_RE</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">cmd</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_find_job_ids</span><span class="p">(</span><span class="o">*</span><span class="n">texts</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="n">ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">finditer</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ids</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="c1"># 중복 제거(출력에 여러 번 찍히는 경우 대비)
</span>    <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="nb">dict</span><span class="p">.</span><span class="nf">fromkeys</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="nb">RuntimeError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Command failed: </span><span class="si">{</span><span class="n">cmd_str</span><span class="si">}</span><span class="s"> (rc=</span><span class="si">{</span><span class="n">returncode</span><span class="si">}</span><span class="s">)</span><span class="se">\n</span><span class="si">{</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">cmd_str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span>

<span class="c1"># ===================== ShellRunner =====================
</span>
<span class="k">class</span> <span class="nc">ShellRunner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">create_subprocess_shell만 사용. 동시 실행 수 세마포어로 제한.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">max_concurrency</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">max_concurrency</span><span class="p">)</span>
        <span class="n">base_env</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LC_ALL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LANG</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_env</span> <span class="o">=</span> <span class="n">base_env</span> <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="bp">None</span> <span class="nf">else </span><span class="p">(</span><span class="n">base_env</span> <span class="o">|</span> <span class="n">env</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_sem</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_shell</span><span class="p">(</span>
                <span class="n">cmd_str</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_env</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ProcessLookupError</span><span class="p">):</span>
                <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>

<span class="c1"># ===================== SharedCache (mem+disk) =====================
</span>
<span class="k">class</span> <span class="nc">SharedCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    멀티프로세스 공유 JSON 캐시:
    - 메모리 TTL + 디스크 TTL (같은 FS 내 rename 원자성 보장)
    - 쓰기: tmp -&gt; fsync(tmp) -&gt; os.replace -&gt; fsync(dir)
    - 신선도: JSON 내부 ts와 파일 mtime 모두 사용(+2s skew 허용)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ttl_sec</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">,</span> <span class="n">skew_eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">cache_dir</span> <span class="ow">or</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">XDG_CACHE_HOME</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">expanduser</span><span class="p">(</span><span class="sh">"</span><span class="s">~</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">.cache</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_root</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_skew</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">skew_eps</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_key_path</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">safe</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">[^A-Za-z0-9._-]+</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">safe</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># 1) 메모리
</span>        <span class="n">item</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">:</span>
            <span class="n">ts</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="c1"># 2) 디스크
</span>        <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_key_path</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">stat</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="n">ts_in</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">fresh_by_ts</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">ts_in</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">)</span> <span class="k">if</span> <span class="n">ts_in</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">False</span>
            <span class="n">fresh_by_mtime</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="nf">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">st</span><span class="p">.</span><span class="n">st_mtime</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fresh_by_ts</span> <span class="ow">or</span> <span class="n">fresh_by_mtime</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_key_path</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">dir_fd</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fd</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="p">.</span><span class="nf">mkstemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="sh">"</span><span class="s">cache_</span><span class="sh">"</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">"</span><span class="s">.json</span><span class="sh">"</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">fdopen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">},</span> <span class="n">f</span><span class="p">)</span>
                    <span class="n">f</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="nf">fileno</span><span class="p">())</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">FileNotFoundError</span><span class="p">):</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>

<span class="c1"># ===================== 결과 타입 =====================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SubmitItem</span><span class="p">:</span>
    <span class="n">index</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">job_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SubmitResult</span><span class="p">:</span>
    <span class="n">interrupted</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SubmitItem</span><span class="p">]</span>
    <span class="n">job_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>                    <span class="c1"># 평탄화된 전체 Job ID
</span>    <span class="n">job_id_to_command</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>     <span class="c1"># Job ID -&gt; 원 커맨드(문자열)
</span>    <span class="n">num_submitted</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">num_failed</span><span class="p">:</span> <span class="nb">int</span>

<span class="c1"># ===================== LSFClient (Public API) =====================
</span>
<span class="k">class</span> <span class="nc">LSFClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - run_command_capture_job: 커맨드 그대로 실행, 출력에서 </span><span class="sh">'</span><span class="s">Job &lt;id&gt;</span><span class="sh">'</span><span class="s"> 파싱(복수 가능)
    - kill: bkill (여러 ID 일괄)  *-r / -d / -s 지원*
    - status: bjobs 전체 스냅샷(메모리+디스크 캐시, 레이트리밋, in-process single-flight)
    - submit_many_with_cancel: 인터럽트 시 새 실행 중단, 진행 중은 완주 → 수집한 job_id 일괄 bkill(기본 on)
    - is_finished: 지정 Job들이 전부 DONE/EXIT/ZOMBI 등 **종료 상태**인지 판정
    </span><span class="sh">"""</span>
    <span class="n">TERMINAL</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">DONE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">EXIT</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ZOMBI</span><span class="sh">"</span><span class="p">}</span>   <span class="c1"># 필요시 확장
</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">bkill</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">bjobs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">max_concurrent_cli</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">bjobs_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_paths</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">:</span> <span class="n">bkill</span><span class="p">,</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">:</span> <span class="n">bjobs</span><span class="p">}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_runner</span> <span class="o">=</span> <span class="nc">ShellRunner</span><span class="p">(</span><span class="n">max_concurrent_cli</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_user</span> <span class="o">=</span> <span class="n">user</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LSF_USER</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">getpass</span><span class="p">.</span><span class="nf">getuser</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="nc">SharedCache</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">ttl_sec</span><span class="o">=</span><span class="n">disk_cache_ttl_sec</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">,</span> <span class="n">skew_eps</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>

        <span class="c1"># bjobs 제어
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_min_interval_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># ---------- 일반 커맨드 실행 + Job ID 파싱 ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_command_capture_job</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubmitItem</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">job_ids</span> <span class="o">=</span> <span class="nf">_find_job_ids</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">raise_on_error</span> <span class="ow">and</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="c1"># index는 배치 모드에서 채워지므로 여기서는 -1로 반환
</span>        <span class="k">return</span> <span class="nc">SubmitItem</span><span class="p">(</span><span class="n">index</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">cmd</span><span class="p">,</span> <span class="n">returncode</span><span class="o">=</span><span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">,</span> <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids</span><span class="p">)</span>

    <span class="c1"># ---------- bkill ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">force_remove</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>            <span class="c1"># -r
</span>        <span class="n">record_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>             <span class="c1"># -d
</span>        <span class="n">signal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>          <span class="c1"># -s SIG
</span>        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">job_ids</span><span class="p">))]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">""</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">flags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">record_done</span><span class="p">:</span>
            <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">-d</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">force_remove</span><span class="p">:</span>
            <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">-r</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">signal</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-s</span><span class="sh">"</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">signal</span><span class="p">)]</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bkill</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">raise_on_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span>

    <span class="c1"># ---------- bjobs snapshot (캐시 + 단일플라이트 + 레이트리밋) ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="c1"># per-process rate-limit
</span>        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">since</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span>
        <span class="k">if</span> <span class="n">since</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">-</span> <span class="n">since</span><span class="p">)</span>

        <span class="n">flag</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-a </span><span class="sh">"</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bjobs</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> -noheader -u </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s">-o </span><span class="sh">'</span><span class="s">jobid stat exit_code queue exec_host</span><span class="sh">'"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

        <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">exec_host</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">jid_i</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">result</span><span class="p">[</span><span class="n">jid_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="n">stat</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="sh">"</span><span class="s">-</span><span class="sh">"</span> <span class="k">else</span> <span class="n">exit_code</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="n">queue</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="n">exec_host</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_status_all_cached</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all|</span><span class="si">{</span><span class="sh">'</span><span class="s">-a</span><span class="sh">'</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">''</span><span class="si">}</span><span class="s">|user=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="sh">"</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
            <span class="n">cached</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cached</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">cached</span><span class="p">.</span><span class="nf">items</span><span class="p">()</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cached</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])}</span>
            <span class="n">inflight</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inflight</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">inflight</span>

        <span class="n">fut</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">().</span><span class="nf">create_future</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fut</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">items</span><span class="p">()})</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">status</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">all_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_status_all_cached</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="n">force_refresh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job_ids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_map</span>
        <span class="n">wanted</span> <span class="o">=</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">all_map</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">wanted</span><span class="p">}</span>

    <span class="c1"># ---------- Finite-state 판정 ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">is_finished</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="nf">list</span><span class="p">({</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">st</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">include_done</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">info</span><span class="p">:</span>
                <span class="c1"># 캐시/보존기간 이탈 등으로 빠졌다면 '완료로 간주'
</span>                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">info</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">TERMINAL</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="c1"># ---------- 배치 제출 + 취소 ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">commands</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">StrOrSeq</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="p">:</span> <span class="nb">callable</span><span class="p">,</span>            <span class="c1"># () -&gt; bool
</span>        <span class="n">poll_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">cmd_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">cleanup_on_interrupt</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>   <span class="c1"># True면 인터럽트 시 수집된 job_id를 즉시 정리(bkill -r)
</span>        <span class="n">kill_force_remove</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>      <span class="c1"># cleanup_on_interrupt=True일 때 -r 사용
</span>        <span class="n">kill_record_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>      <span class="c1"># 필요시 DONE 기록
</span>        <span class="n">kill_signal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>   <span class="c1"># 필요시 시그널 지정
</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubmitResult</span><span class="p">:</span>
        <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SubmitItem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">job_ids_all</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">job_id_to_cmd</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">in_flight</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubmitItem</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">run_command_capture_job</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">cmd_timeout</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">cmd_raise_on_error</span>
            <span class="p">)</span>
            <span class="c1"># index 채워서 반환
</span>            <span class="k">return</span> <span class="nc">SubmitItem</span><span class="p">(</span>
                <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">returncode</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">job_ids</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">job_ids</span>
            <span class="p">)</span>

        <span class="n">idx</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">or</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">in_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_in_flight</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">is_interrupted</span><span class="p">():</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">run_one</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">commands</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
                    <span class="n">in_flight</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                    <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll_interval_sec</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                        <span class="n">in_flight</span><span class="p">.</span><span class="nf">discard</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">item</span><span class="p">:</span> <span class="n">SubmitItem</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                            <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                            <span class="c1"># 매핑/집계
</span>                            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                                <span class="n">job_ids_all</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                                <span class="n">job_id_to_cmd</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">command</span>
                            <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                                <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">poll_interval_sec</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># drain
</span>            <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">ALL_COMPLETED</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">item</span><span class="p">:</span> <span class="n">SubmitItem</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                        <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                            <span class="n">job_ids_all</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                            <span class="n">job_id_to_cmd</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">command</span>
                        <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">interrupted</span> <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="nf">is_interrupted</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">interrupted</span> <span class="ow">and</span> <span class="n">cleanup_on_interrupt</span> <span class="ow">and</span> <span class="n">job_ids_all</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span>
                <span class="n">job_ids_all</span><span class="p">,</span>
                <span class="n">force_remove</span><span class="o">=</span><span class="n">kill_force_remove</span><span class="p">,</span>
                <span class="n">record_done</span><span class="o">=</span><span class="n">kill_record_done</span><span class="p">,</span>
                <span class="n">signal</span><span class="o">=</span><span class="n">kill_signal</span><span class="p">,</span>
                <span class="n">raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># 평탄화 리스트 중복 제거(출력 중복 대비)
</span>        <span class="n">job_ids_all</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nb">dict</span><span class="p">.</span><span class="nf">fromkeys</span><span class="p">(</span><span class="n">job_ids_all</span><span class="p">))</span>

        <span class="k">return</span> <span class="nc">SubmitResult</span><span class="p">(</span>
            <span class="n">interrupted</span><span class="o">=</span><span class="n">interrupted</span><span class="p">,</span>
            <span class="n">items</span><span class="o">=</span><span class="n">items</span><span class="p">,</span>
            <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids_all</span><span class="p">,</span>
            <span class="n">job_id_to_command</span><span class="o">=</span><span class="n">job_id_to_cmd</span><span class="p">,</span>
            <span class="n">num_submitted</span><span class="o">=</span><span class="nf">len</span><span class="p">(</span><span class="n">job_ids_all</span><span class="p">),</span>
            <span class="n">num_failed</span><span class="o">=</span><span class="n">failures</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="당신이-원한-사용-패턴-async로-정확히-동작하도록">당신이 원한 사용 패턴 (async로 정확히 동작하도록)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">lsf_core</span> <span class="kn">import</span> <span class="n">LSFClient</span>

<span class="c1"># 인터럽트 토큰
</span><span class="k">class</span> <span class="nc">Token</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span> <span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">delay</span>
    <span class="k">def</span> <span class="nf">is_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">):</span> <span class="nf">return </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">LSFClient</span><span class="p">(</span>
        <span class="n">max_concurrent_cli</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">bjobs_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="o">=</span><span class="sh">"</span><span class="s">/shared/cache</span><span class="sh">"</span><span class="p">,</span>   <span class="c1"># 여러 머신에서 공용 FS
</span>    <span class="p">)</span>

    <span class="n">is_interrupted</span> <span class="o">=</span> <span class="nc">Token</span><span class="p">(</span><span class="n">delay</span><span class="o">=</span><span class="mi">9999</span><span class="p">).</span><span class="n">is_interrupted</span>  <span class="c1"># 실사용에선 외부 이벤트로 바꾸세요
</span>
    <span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">job_sub a.txt</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">mkdir package</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">bsub -q short sleep 3</span><span class="sh">"</span><span class="p">]</span>

    <span class="c1"># 1) 배치 제출 (인터럽트 시 자체 정리하도록 하고 싶으면 cleanup_on_interrupt=True 유지)
</span>    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">cmds</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="o">=</span><span class="n">is_interrupted</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
        <span class="n">cleanup_on_interrupt</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>  <span class="c1"># 인터럽트 발생 동안 제출하던 job들은 여기서 -r로 정리
</span>    <span class="p">)</span>

    <span class="k">if</span> <span class="n">data</span><span class="p">.</span><span class="n">interrupted</span> <span class="ow">or</span> <span class="nf">is_interrupted</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">중지되었습니다.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># 2) 결과에서 Running(혹은 전체) Job ID 추출 &amp; 매핑 사용
</span>    <span class="n">job_ids</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">job_ids</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">job_ids</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">제출된 LSF 잡이 없습니다.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># 3) 완료까지 폴링
</span>    <span class="k">while</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">is_finished</span><span class="p">(</span><span class="n">job_ids</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>  <span class="c1"># include_done=True 기본
</span>        <span class="k">for</span> <span class="n">job_id</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">status</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">job_command</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">job_id_to_command</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="sh">"</span><span class="s">&lt;unknown&gt;</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">),</span> <span class="n">job_command</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="nf">is_interrupted</span><span class="p">():</span>
            <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">force_remove</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">중지하였습니다.</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">모두 완료되었습니다.</span><span class="sh">"</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h2 id="설계-포인트-짧게-step-by-step">설계 포인트 (짧게, step-by-step)</h2>

<ol>
  <li>
    <p><strong>JobID-커맨드 매칭</strong> : <code class="language-plaintext highlighter-rouge">SubmitResult.job_id_to_command[jid]</code>로 O(1) 조회, <code class="language-plaintext highlighter-rouge">items</code>에 원본/표준출력/리턴코드까지 보관.</p>
  </li>
  <li>
    <p><strong>실전 안전성</strong> : 제출 중 인터럽트 발생 시에도 <strong>진행 중 제출은 완주</strong> → 출력에서 JobID 수집 → 필요 시 <strong>즉시 -r</strong> 로 정리.</p>
  </li>
  <li>
    <p><strong>부하 최소화</strong> : <code class="language-plaintext highlighter-rouge">bjobs</code>는 <strong>전체 스냅샷 + 메모리/디스크 캐시 + 레이트리밋 + 단일플라이트</strong>.</p>
  </li>
  <li>
    <p><strong>API 간결성</strong> : 사용자는 <code class="language-plaintext highlighter-rouge">submit → data.job_ids / job_id_to_command → status/is_finished → kill</code> 만 알면 됨.</p>
  </li>
</ol>

<p>원한다면 로그/메트릭 훅(예: 제출/상태 호출 카운트, 지연)을 붙여서 관측 가능하게도 만들어줄게.</p>

<p class="chat--user">

-r 옵션은 최대한 안쓰고 싶어. 그냥 bkill로만 해도 될 것 같아. 다른 옵션들도 없애주고 그리고 bsub은 됐지만 bjobs 캐시가 업데이트 안 돼서 누락되는 경우도 있잖아 그 경우 status 정보가 어떻게 되는지 궁금해. 최대한 에러를 안내고 싶어

</p>

<p>좋은 포인트야. 아래처럼 딱 필요한 수준으로 수정했어.</p>

<ul>
  <li>
    <p><strong>bkill</strong> : 옵션 전부 제거(순수 <code class="language-plaintext highlighter-rouge">bkill &lt;ids&gt;</code>만 호출)</p>
  </li>
  <li>
    <p><strong>status 안정성</strong> : <code class="language-plaintext highlighter-rouge">bjobs</code> 캐시가 늦어 <strong>누락</strong> 돼도 에러 없이 동작</p>

    <ul>
      <li>
        <p>요청한 <code class="language-plaintext highlighter-rouge">job_ids</code>가 스냅샷에 없으면 <strong>한 번만 강제 새로고침</strong> 시도</p>
      </li>
      <li>
        <p>그래도 없으면 해당 ID에 대해 <strong><code class="language-plaintext highlighter-rouge">{"stat": "UNKNOWN"}</code></strong> 같은 기본값을 채워 반환(키 결핍으로 인한 예외 방지)</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>is_finished</strong> : <code class="language-plaintext highlighter-rouge">UNKNOWN</code>은 즉시 완료로 취급하지 않음. 기본적으로 <strong>그레이스(기다림) 시간</strong>(기본 15초) 동안은 “미완료”로 보고, 그 이후에도 계속 UNKNOWN이면 완료로 간주(클러스터 보존 기간/전파 지연을 흡수)</p>
  </li>
</ul>

<hr />
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># lsf_core.py (최적화 버전)
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>
<span class="kn">import</span> <span class="n">getpass</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1"># ========== 공용 ==========
</span><span class="n">StrOrSeq</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
<span class="n">_JOBID_RE</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">cmd</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_find_job_ids</span><span class="p">(</span><span class="o">*</span><span class="n">texts</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="n">ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">finditer</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ids</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="nb">dict</span><span class="p">.</span><span class="nf">fromkeys</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="nb">RuntimeError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Command failed: </span><span class="si">{</span><span class="n">cmd_str</span><span class="si">}</span><span class="s"> (rc=</span><span class="si">{</span><span class="n">returncode</span><span class="si">}</span><span class="s">)</span><span class="se">\n</span><span class="si">{</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">cmd_str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span>

<span class="c1"># ========== ShellRunner ==========
</span><span class="k">class</span> <span class="nc">ShellRunner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">create_subprocess_shell만 사용. 동시 실행 수는 세마포어로 제한.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">max_concurrency</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">max_concurrency</span><span class="p">)</span>
        <span class="n">base_env</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LC_ALL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LANG</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_env</span> <span class="o">=</span> <span class="n">base_env</span> <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="bp">None</span> <span class="nf">else </span><span class="p">(</span><span class="n">base_env</span> <span class="o">|</span> <span class="n">env</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_sem</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_shell</span><span class="p">(</span>
                <span class="n">cmd_str</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_env</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ProcessLookupError</span><span class="p">):</span>
                <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>

<span class="c1"># ========== SharedCache (mem+disk) ==========
</span><span class="k">class</span> <span class="nc">SharedCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    멀티프로세스 공유 JSON 캐시:
    - 메모리 TTL + 디스크 TTL (같은 FS 내 rename 원자성)
    - 쓰기: tmp -&gt; fsync(tmp) -&gt; os.replace -&gt; fsync(dir)
    - 신선도: JSON 내부 ts와 파일 mtime 모두 사용(+2s skew 허용)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ttl_sec</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">,</span> <span class="n">skew_eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">cache_dir</span> <span class="ow">or</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">XDG_CACHE_HOME</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">expanduser</span><span class="p">(</span><span class="sh">"</span><span class="s">~</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">.cache</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_root</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_skew</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">skew_eps</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_key_path</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">safe</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">[^A-Za-z0-9._-]+</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">safe</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">:</span>
            <span class="n">ts</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_key_path</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">stat</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="n">ts_in</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">fresh_by_ts</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">ts_in</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">)</span> <span class="k">if</span> <span class="n">ts_in</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">False</span>
            <span class="n">fresh_by_mtime</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="nf">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">st</span><span class="p">.</span><span class="n">st_mtime</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fresh_by_ts</span> <span class="ow">or</span> <span class="n">fresh_by_mtime</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_key_path</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">dir_fd</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fd</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="p">.</span><span class="nf">mkstemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="sh">"</span><span class="s">cache_</span><span class="sh">"</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">"</span><span class="s">.json</span><span class="sh">"</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">fdopen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">},</span> <span class="n">f</span><span class="p">)</span>
                    <span class="n">f</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="nf">fileno</span><span class="p">())</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">FileNotFoundError</span><span class="p">):</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>

<span class="c1"># ========== 결과 타입 ==========
</span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SubmitItem</span><span class="p">:</span>
    <span class="n">index</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">job_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SubmitResult</span><span class="p">:</span>
    <span class="n">interrupted</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SubmitItem</span><span class="p">]</span>
    <span class="n">job_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>                    <span class="c1"># 평탄화된 전체 Job ID
</span>    <span class="n">job_id_to_command</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>     <span class="c1"># Job ID -&gt; 원 커맨드
</span>    <span class="n">num_submitted</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">num_failed</span><span class="p">:</span> <span class="nb">int</span>

<span class="c1"># ========== LSFClient ==========
</span><span class="k">class</span> <span class="nc">LSFClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - run_command_capture_job: 커맨드 그대로 실행, 출력에서 </span><span class="sh">'</span><span class="s">Job &lt;id&gt;</span><span class="sh">'</span><span class="s">(복수 가능) 파싱
    - kill: 순수 bkill (옵션 없이)
    - status: bjobs 전체 스냅샷(캐시/레이트리밋/단일플라이트) + 누락 시 1회 강제 새로고침 + UNKNOWN 보강
    - submit_many_with_cancel: 인터럽트 시 새 실행 중단, 진행 중은 완주 → 수집한 job_id를 필요 시 bkill
    - is_finished: UNKNOWN을 일정 시간(기본 15s)까지는 “미완료”로 보고, 그 이후엔 완료로 간주
    </span><span class="sh">"""</span>
    <span class="n">TERMINAL</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">DONE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">EXIT</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ZOMBI</span><span class="sh">"</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">bkill</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">bjobs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">max_concurrent_cli</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">bjobs_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">unknown_grace_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">15.0</span><span class="p">,</span>   <span class="c1"># UNKNOWN 처리 그레이스
</span>    <span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_paths</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">:</span> <span class="n">bkill</span><span class="p">,</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">:</span> <span class="n">bjobs</span><span class="p">}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_runner</span> <span class="o">=</span> <span class="nc">ShellRunner</span><span class="p">(</span><span class="n">max_concurrent_cli</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_user</span> <span class="o">=</span> <span class="n">user</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LSF_USER</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">getpass</span><span class="p">.</span><span class="nf">getuser</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="nc">SharedCache</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">ttl_sec</span><span class="o">=</span><span class="n">disk_cache_ttl_sec</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">,</span> <span class="n">skew_eps</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>

        <span class="c1"># bjobs 제어
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_min_interval_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># UNKNOWN 처리용
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_unknown_seen_at</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_unknown_grace</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">unknown_grace_sec</span><span class="p">)</span>

    <span class="c1"># --- 일반 커맨드 실행 + Job ID 파싱 ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_command_capture_job</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubmitItem</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">job_ids</span> <span class="o">=</span> <span class="nf">_find_job_ids</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">raise_on_error</span> <span class="ow">and</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="nc">SubmitItem</span><span class="p">(</span><span class="n">index</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">cmd</span><span class="p">,</span> <span class="n">returncode</span><span class="o">=</span><span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">,</span> <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids</span><span class="p">)</span>

    <span class="c1"># --- bkill (옵션 없이) ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">job_ids</span><span class="p">))]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">""</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bkill</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">raise_on_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span>

    <span class="c1"># --- bjobs 스냅샷 (캐시/레이트리밋/단일플라이트) ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">since</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span>
        <span class="k">if</span> <span class="n">since</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">-</span> <span class="n">since</span><span class="p">)</span>

        <span class="n">flag</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-a </span><span class="sh">"</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bjobs</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> -noheader -u </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s">-o </span><span class="sh">'</span><span class="s">jobid stat exit_code queue exec_host</span><span class="sh">'"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

        <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">exec_host</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">jid_i</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">result</span><span class="p">[</span><span class="n">jid_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="n">stat</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="sh">"</span><span class="s">-</span><span class="sh">"</span> <span class="k">else</span> <span class="n">exit_code</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="n">queue</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="n">exec_host</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_status_all_cached</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all|</span><span class="si">{</span><span class="sh">'</span><span class="s">-a</span><span class="sh">'</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">''</span><span class="si">}</span><span class="s">|user=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
            <span class="n">cached</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cached</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">cached</span><span class="p">.</span><span class="nf">items</span><span class="p">()</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cached</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])}</span>
            <span class="n">inflight</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inflight</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">inflight</span>

        <span class="n">fut</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">().</span><span class="nf">create_future</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fut</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">items</span><span class="p">()})</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="c1"># --- 안전한 status (누락 자동 보강) ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">status</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">all_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_status_all_cached</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="n">force_refresh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job_ids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_map</span>

        <span class="n">req_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">all_map</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req_ids</span><span class="p">}</span>

        <span class="c1"># 누락(id -&gt; None) 있으면 1회 강제 새로고침
</span>        <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">out</span><span class="p">.</span><span class="nf">values</span><span class="p">()):</span>
            <span class="n">all_map2</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_status_all_cached</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req_ids</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="n">all_map2</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># 그래도 없으면 UNKNOWN 보강 + 첫 발견 시간 기록
</span>        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">UNKNOWN</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">_missing</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_unknown_seen_at</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="c1"># --- 완료 판정 ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">is_finished</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="nf">list</span><span class="p">({</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">st</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">include_done</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">stat</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stat</span> <span class="o">==</span> <span class="sh">"</span><span class="s">UNKNOWN</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">first</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_unknown_seen_at</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
                <span class="c1"># UNKNOWN 그레이스 내에는 “미완료”로 취급 -&gt; bjobs 전파 지연/캐시 지연 흡수
</span>                <span class="k">if</span> <span class="n">now</span> <span class="o">-</span> <span class="n">first</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_unknown_grace</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span>
                <span class="c1"># 그레이스 초과 시: 완료로 간주(LSF가 정리했거나 보존기간 경과 등)
</span>                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">stat</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">TERMINAL</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="c1"># --- 배치 제출 + 취소 ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">commands</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">StrOrSeq</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="p">:</span> <span class="nb">callable</span><span class="p">,</span>            <span class="c1"># () -&gt; bool
</span>        <span class="n">poll_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">cmd_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">cleanup_on_interrupt</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>   <span class="c1"># True면 인터럽트 시 수집된 job_id를 즉시 bkill
</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubmitResult</span><span class="p">:</span>
        <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SubmitItem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">job_ids_all</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">job_id_to_cmd</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">in_flight</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubmitItem</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">run_command_capture_job</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">cmd_timeout</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">cmd_raise_on_error</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="nc">SubmitItem</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">returncode</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span>
                              <span class="n">stdout</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">job_ids</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">job_ids</span><span class="p">)</span>

        <span class="n">idx</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">or</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">in_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_in_flight</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">is_interrupted</span><span class="p">():</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">run_one</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">commands</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
                    <span class="n">in_flight</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                    <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll_interval_sec</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                        <span class="n">in_flight</span><span class="p">.</span><span class="nf">discard</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">item</span><span class="p">:</span> <span class="n">SubmitItem</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                            <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                                <span class="n">job_ids_all</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                                <span class="n">job_id_to_cmd</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">command</span>
                            <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                                <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">poll_interval_sec</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">ALL_COMPLETED</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">item</span><span class="p">:</span> <span class="n">SubmitItem</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                        <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                            <span class="n">job_ids_all</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                            <span class="n">job_id_to_cmd</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">command</span>
                        <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">interrupted</span> <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="nf">is_interrupted</span><span class="p">())</span>
        <span class="c1"># 인터럽트 시, 이미 수집된 job만 정리(bkill). (강제 옵션 없이 순수 bkill)
</span>        <span class="k">if</span> <span class="n">interrupted</span> <span class="ow">and</span> <span class="n">cleanup_on_interrupt</span> <span class="ow">and</span> <span class="n">job_ids_all</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">job_ids_all</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">job_ids_all</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nb">dict</span><span class="p">.</span><span class="nf">fromkeys</span><span class="p">(</span><span class="n">job_ids_all</span><span class="p">))</span>
        <span class="k">return</span> <span class="nc">SubmitResult</span><span class="p">(</span>
            <span class="n">interrupted</span><span class="o">=</span><span class="n">interrupted</span><span class="p">,</span>
            <span class="n">items</span><span class="o">=</span><span class="n">items</span><span class="p">,</span>
            <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids_all</span><span class="p">,</span>
            <span class="n">job_id_to_command</span><span class="o">=</span><span class="n">job_id_to_cmd</span><span class="p">,</span>
            <span class="n">num_submitted</span><span class="o">=</span><span class="nf">len</span><span class="p">(</span><span class="n">job_ids_all</span><span class="p">),</span>
            <span class="n">num_failed</span><span class="o">=</span><span class="n">failures</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="당신이-원하는-사용-패턴-그대로">당신이 원하는 사용 패턴 그대로</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">lsf_core</span> <span class="kn">import</span> <span class="n">LSFClient</span>

<span class="k">class</span> <span class="nc">Token</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span> <span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">delay</span>
    <span class="k">def</span> <span class="nf">is_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">):</span> <span class="nf">return </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span><span class="o">-</span><span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">LSFClient</span><span class="p">(</span>
        <span class="n">max_concurrent_cli</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">bjobs_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="o">=</span><span class="sh">"</span><span class="s">/shared/cache</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">unknown_grace_sec</span><span class="o">=</span><span class="mf">15.0</span><span class="p">,</span>   <span class="c1"># bjobs 반영 지연 허용 시간
</span>    <span class="p">)</span>

    <span class="n">is_interrupted</span> <span class="o">=</span> <span class="nc">Token</span><span class="p">(</span><span class="n">delay</span><span class="o">=</span><span class="mi">9999</span><span class="p">).</span><span class="n">is_interrupted</span>

    <span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">job_sub a.txt</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">mkdir package</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">bsub -q short sleep 3</span><span class="sh">"</span><span class="p">]</span>

    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">submit_many_with_cancel</span><span class="p">(</span><span class="n">cmds</span><span class="p">,</span> <span class="n">is_interrupted</span><span class="o">=</span><span class="n">is_interrupted</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span><span class="p">.</span><span class="n">interrupted</span> <span class="ow">or</span> <span class="nf">is_interrupted</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">중지되었습니다.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">job_ids</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">job_ids</span>  <span class="c1"># data로부터 running job id 추출
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">job_ids</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">LSF 잡이 없습니다.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">is_finished</span><span class="p">(</span><span class="n">job_ids</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">job_id</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">status</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span>         <span class="c1"># 항상 키가 존재 (UNKNOWN 보강)
</span>            <span class="n">job_command</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">job_id_to_command</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="sh">"</span><span class="s">&lt;unknown&gt;</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">),</span> <span class="n">job_command</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">is_interrupted</span><span class="p">():</span>
            <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">중지하였습니다.</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">모두 완료되었습니다.</span><span class="sh">"</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h3 id="정리-step-by-step">정리 (step-by-step)</h3>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bkill</code>은 <strong>옵션 없이</strong> 만 씀.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">status(job_ids)</code>는 항상 <strong>모든 ID의 키가 존재</strong> 하도록 보장:</p>

    <ol>
      <li>
        <p>캐시 히트 시 바로 반환</p>
      </li>
      <li>
        <p>누락 있으면 <strong>1회 강제 리프레시</strong></p>
      </li>
      <li>
        <p>그래도 없으면 <code class="language-plaintext highlighter-rouge">{"stat":"UNKNOWN"}</code>으로 보강(에러 없음)</p>
      </li>
    </ol>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">is_finished</code>는 <code class="language-plaintext highlighter-rouge">UNKNOWN</code>을 <strong>그레이스 시간 동안은 미완료</strong> 로 보고, 그 이후엔 완료로 간주(무한루프 방지).</p>
  </li>
</ul>

<p>필요하면 <code class="language-plaintext highlighter-rouge">unknown_grace_sec</code>만 조정해 운영 환경에 맞출 수 있어.</p>

<p class="chat--user">

한 프로세스 내에서 여러 LSFClient 를 만들면 동시 돌아가는 Job이 많아지는거 아냐? Semaphore를 프로세스 전체가 공유해야할 것 같아 싱글톤 같은걸 써서. LSFClient를 싱글톤화 하든지 Semaphore만 하든지 그건 선택일거같은데 더 일반적이고 좋은 쪽을 선택해야해줘ㅗ

</p>

<p>좋은 지적! “한 프로세스 안에서 LSFClient를 여러 개 만들어도 동시 실행 수가 늘어나지 않도록” <strong>프로세스(정확히는 이벤트 루프) 단위 공유 세마포어</strong> 를 넣은 최적 버전으로 정리했어.</p>

<p>핵심만 요약하면:</p>

<ol>
  <li>
    <p><strong>LoopSharedSemaphore</strong></p>

    <ul>
      <li>
        <p>같은 이벤트 루프 안에서 만들어지는 모든 <code class="language-plaintext highlighter-rouge">LSFClient</code>/<code class="language-plaintext highlighter-rouge">ShellRunner</code>가 <strong>하나의 세마포어를 공유</strong>.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">configure_global_cli_concurrency(N)</code>으로 <strong>전역 동시 실행 수를 설정</strong>(클라이언트 만들기 전에 한 번 호출).</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>LSFClient/ShellRunner</strong></p>

    <ul>
      <li>
        <p>기본은 공유 세마포어 사용(<code class="language-plaintext highlighter-rouge">share_semaphore=True</code>).</p>
      </li>
      <li>
        <p>정말 필요하면 인스턴스별로 독립 세마포어도 가능(<code class="language-plaintext highlighter-rouge">share_semaphore=False</code>).</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>기능은 그대로</strong></p>

    <ul>
      <li>
        <p>커맨드 그대로 실행(<code class="language-plaintext highlighter-rouge">create_subprocess_shell</code>), <code class="language-plaintext highlighter-rouge">Job &lt;id&gt;</code> 파싱</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">bkill</code> 옵션 없이</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">bjobs</code> 스냅샷: 메모리+디스크 캐시, 과호출 레이트리밋, in-process single-flight</p>
      </li>
      <li>
        <p>누락 시 1회 강제 새로고침 + <strong>UNKNOWN 보강</strong> , <code class="language-plaintext highlighter-rouge">is_finished</code>는 UNKNOWN 그레이스(기본 15s)</p>
      </li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="드롭인-교체-코드-lsf_corepy">드롭인 교체 코드 (<code class="language-plaintext highlighter-rouge">lsf_core.py</code>)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># lsf_core.py
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>
<span class="kn">import</span> <span class="n">getpass</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">weakref</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1"># ===================== 공용 유틸 =====================
</span>
<span class="n">StrOrSeq</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
<span class="n">_JOBID_RE</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">cmd</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_find_job_ids</span><span class="p">(</span><span class="o">*</span><span class="n">texts</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="n">ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">finditer</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ids</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="nb">dict</span><span class="p">.</span><span class="nf">fromkeys</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="nb">RuntimeError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Command failed: </span><span class="si">{</span><span class="n">cmd_str</span><span class="si">}</span><span class="s"> (rc=</span><span class="si">{</span><span class="n">returncode</span><span class="si">}</span><span class="s">)</span><span class="se">\n</span><span class="si">{</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">cmd_str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span>

<span class="c1"># ===================== 프로세스(루프) 전역 limiter =====================
</span>
<span class="k">class</span> <span class="nc">LoopSharedSemaphore</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    같은 이벤트 루프 안에서 create_subprocess_shell 동시 실행 수를 제한하는 전역 세마포어.
    - 여러 LSFClient, 여러 ShellRunner가 있어도 </span><span class="sh">'</span><span class="s">같은 루프</span><span class="sh">'</span><span class="s">에서는 이 세마포어 하나를 공유.
    - 다중 스레드/다중 루프 환경이라면 </span><span class="sh">'</span><span class="s">루프별</span><span class="sh">'</span><span class="s">로 하나씩 생김.
    </span><span class="sh">"""</span>
    <span class="n">_sems</span><span class="p">:</span> <span class="sh">"</span><span class="s">weakref.WeakKeyDictionary[asyncio.AbstractEventLoop, asyncio.Semaphore]</span><span class="sh">"</span> <span class="o">=</span> <span class="n">weakref</span><span class="p">.</span><span class="nc">WeakKeyDictionary</span><span class="p">()</span>
    <span class="n">_default_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c1"># 이미 만들어진 세마포어의 용량을 동적으로 바꾸긴 어렵다.
</span>        <span class="c1"># 그러니 '클라이언트 만들기 전에' 호출해 두는 것을 권장.
</span>        <span class="n">cls</span><span class="p">.</span><span class="n">_default_limit</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">limit</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Semaphore</span><span class="p">:</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
        <span class="n">sem</span> <span class="o">=</span> <span class="n">cls</span><span class="p">.</span><span class="n">_sems</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sem</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">cls</span><span class="p">.</span><span class="n">_default_limit</span><span class="p">)</span>
            <span class="n">cls</span><span class="p">.</span><span class="n">_sems</span><span class="p">[</span><span class="n">loop</span><span class="p">]</span> <span class="o">=</span> <span class="n">sem</span>
        <span class="k">return</span> <span class="n">sem</span>

<span class="k">def</span> <span class="nf">configure_global_cli_concurrency</span><span class="p">(</span><span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">클라이언트 생성 전에 호출해서 전역 동시 실행 수를 지정하세요.</span><span class="sh">"""</span>
    <span class="n">LoopSharedSemaphore</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>

<span class="c1"># ===================== ShellRunner =====================
</span>
<span class="k">class</span> <span class="nc">ShellRunner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">create_subprocess_shell만 사용. 기본은 전역(루프공유) 세마포어를 씀.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">max_concurrency</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="n">share_semaphore</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="c1"># env
</span>        <span class="n">base_env</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LC_ALL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LANG</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_env</span> <span class="o">=</span> <span class="n">base_env</span> <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="bp">None</span> <span class="nf">else </span><span class="p">(</span><span class="n">base_env</span> <span class="o">|</span> <span class="n">env</span><span class="p">)</span>
        <span class="c1"># semaphore
</span>        <span class="k">if</span> <span class="n">share_semaphore</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sem</span> <span class="o">=</span> <span class="n">LoopSharedSemaphore</span><span class="p">.</span><span class="nf">get</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">max_concurrency</span> <span class="ow">or</span> <span class="n">LoopSharedSemaphore</span><span class="p">.</span><span class="n">_default_limit</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_sem</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_shell</span><span class="p">(</span>
                <span class="n">cmd_str</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_env</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ProcessLookupError</span><span class="p">):</span>
                <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>

<span class="c1"># ===================== SharedCache (mem+disk) =====================
</span>
<span class="k">class</span> <span class="nc">SharedCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    멀티프로세스 공유 JSON 캐시:
    - 메모리 TTL + 디스크 TTL (같은 FS 내 rename 원자성)
    - 쓰기: tmp -&gt; fsync(tmp) -&gt; os.replace -&gt; fsync(dir)
    - 신선도: JSON 내부 ts와 파일 mtime 모두 사용(+2s skew 허용)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ttl_sec</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">,</span> <span class="n">skew_eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">cache_dir</span> <span class="ow">or</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">XDG_CACHE_HOME</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">expanduser</span><span class="p">(</span><span class="sh">"</span><span class="s">~</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">.cache</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_root</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_skew</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">skew_eps</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_key_path</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">safe</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">[^A-Za-z0-9._-]+</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">safe</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># memory
</span>        <span class="n">item</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">:</span>
            <span class="n">ts</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="c1"># disk
</span>        <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_key_path</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">stat</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="n">ts_in</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">fresh_by_ts</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">ts_in</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">)</span> <span class="k">if</span> <span class="n">ts_in</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">False</span>
            <span class="n">fresh_by_mtime</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="nf">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">st</span><span class="p">.</span><span class="n">st_mtime</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fresh_by_ts</span> <span class="ow">or</span> <span class="n">fresh_by_mtime</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_key_path</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">dir_fd</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fd</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="p">.</span><span class="nf">mkstemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="sh">"</span><span class="s">cache_</span><span class="sh">"</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">"</span><span class="s">.json</span><span class="sh">"</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">fdopen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">},</span> <span class="n">f</span><span class="p">)</span>
                    <span class="n">f</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="nf">fileno</span><span class="p">())</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">FileNotFoundError</span><span class="p">):</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>

<span class="c1"># ===================== 결과 타입 =====================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SubmitItem</span><span class="p">:</span>
    <span class="n">index</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">job_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SubmitResult</span><span class="p">:</span>
    <span class="n">interrupted</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SubmitItem</span><span class="p">]</span>
    <span class="n">job_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>                    <span class="c1"># 평탄화된 전체 Job ID
</span>    <span class="n">job_id_to_command</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>     <span class="c1"># Job ID -&gt; 원 커맨드
</span>    <span class="n">num_submitted</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">num_failed</span><span class="p">:</span> <span class="nb">int</span>

<span class="c1"># ===================== LSFClient =====================
</span>
<span class="k">class</span> <span class="nc">LSFClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - run_command_capture_job: 커맨드 그대로 실행, 출력에서 </span><span class="sh">'</span><span class="s">Job &lt;id&gt;</span><span class="sh">'</span><span class="s">(복수 가능) 파싱
    - kill: 순수 bkill (옵션 없이)
    - status: bjobs 전체 스냅샷(캐시/레이트리밋/단일플라이트) + 누락 시 1회 강제 새로고침 + UNKNOWN 보강
    - submit_many_with_cancel: 인터럽트 시 새 실행 중단, 진행 중은 완주 → 수집한 job_id를 필요 시 bkill
    - is_finished: UNKNOWN 그레이스(기본 15s) 동안은 미완료로 간주
    - 세마포어: 기본은 루프 전역 공유(LoopSharedSemaphore)
    </span><span class="sh">"""</span>
    <span class="n">TERMINAL</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">DONE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">EXIT</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ZOMBI</span><span class="sh">"</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">bkill</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">bjobs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">max_concurrent_cli</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>  <span class="c1"># share_semaphore=False일 때만 사용
</span>        <span class="n">bjobs_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">unknown_grace_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">15.0</span><span class="p">,</span>
        <span class="n">share_semaphore</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>              <span class="c1"># True: 루프 전역 공유, False: 인스턴스별 세마포어
</span>    <span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_paths</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">:</span> <span class="n">bkill</span><span class="p">,</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">:</span> <span class="n">bjobs</span><span class="p">}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_runner</span> <span class="o">=</span> <span class="nc">ShellRunner</span><span class="p">(</span><span class="n">max_concurrency</span><span class="o">=</span><span class="n">max_concurrent_cli</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">share_semaphore</span><span class="o">=</span><span class="n">share_semaphore</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_user</span> <span class="o">=</span> <span class="n">user</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LSF_USER</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">getpass</span><span class="p">.</span><span class="nf">getuser</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="nc">SharedCache</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">ttl_sec</span><span class="o">=</span><span class="n">disk_cache_ttl_sec</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">,</span> <span class="n">skew_eps</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>

        <span class="c1"># bjobs 제어
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_min_interval_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># UNKNOWN 처리
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_unknown_seen_at</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_unknown_grace</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">unknown_grace_sec</span><span class="p">)</span>

    <span class="c1"># --- 일반 커맨드 실행 + Job ID 파싱 ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_command_capture_job</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubmitItem</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">job_ids</span> <span class="o">=</span> <span class="nf">_find_job_ids</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">raise_on_error</span> <span class="ow">and</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="nc">SubmitItem</span><span class="p">(</span><span class="n">index</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">cmd</span><span class="p">,</span> <span class="n">returncode</span><span class="o">=</span><span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">,</span> <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids</span><span class="p">)</span>

    <span class="c1"># --- bkill (옵션 없이) ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">job_ids</span><span class="p">))]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">""</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bkill</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">raise_on_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span>

    <span class="c1"># --- bjobs 스냅샷 (캐시/레이트리밋/단일플라이트) ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">since</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span>
        <span class="k">if</span> <span class="n">since</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">-</span> <span class="n">since</span><span class="p">)</span>

        <span class="n">flag</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-a </span><span class="sh">"</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bjobs</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> -noheader -u </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s">-o </span><span class="sh">'</span><span class="s">jobid stat exit_code queue exec_host</span><span class="sh">'"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

        <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">exec_host</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">jid_i</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">result</span><span class="p">[</span><span class="n">jid_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="n">stat</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="sh">"</span><span class="s">-</span><span class="sh">"</span> <span class="k">else</span> <span class="n">exit_code</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="n">queue</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="n">exec_host</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_status_all_cached</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all|</span><span class="si">{</span><span class="sh">'</span><span class="s">-a</span><span class="sh">'</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">''</span><span class="si">}</span><span class="s">|user=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
            <span class="n">cached</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cached</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">cached</span><span class="p">.</span><span class="nf">items</span><span class="p">()</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cached</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])}</span>
            <span class="n">inflight</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inflight</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">inflight</span>

        <span class="n">fut</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">().</span><span class="nf">create_future</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fut</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">items</span><span class="p">()})</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="c1"># --- 안전한 status (누락 자동 보강) ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">status</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">all_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_status_all_cached</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="n">force_refresh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job_ids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_map</span>

        <span class="n">req_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">all_map</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req_ids</span><span class="p">}</span>

        <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">out</span><span class="p">.</span><span class="nf">values</span><span class="p">()):</span>
            <span class="n">all_map2</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_status_all_cached</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req_ids</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="n">all_map2</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">UNKNOWN</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">_missing</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
                <span class="c1"># UNKNOWN 그레이스 시작 시각 기록
</span>                <span class="n">self</span><span class="p">.</span><span class="n">_unknown_seen_at</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="c1"># --- 완료 판정 ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">is_finished</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="nf">list</span><span class="p">({</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">st</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">include_done</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">stat</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stat</span> <span class="o">==</span> <span class="sh">"</span><span class="s">UNKNOWN</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">first</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_unknown_seen_at</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">now</span> <span class="o">-</span> <span class="n">first</span> <span class="o">&lt;</span> <span class="mf">15.0</span><span class="p">:</span>  <span class="c1"># self._unknown_grace를 써도 됨. 기본 15s
</span>                    <span class="k">return</span> <span class="bp">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">stat</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">TERMINAL</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="c1"># --- 배치 제출 + 취소 ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">commands</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">StrOrSeq</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="p">:</span> <span class="nb">callable</span><span class="p">,</span>            <span class="c1"># () -&gt; bool
</span>        <span class="n">poll_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">cmd_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">cleanup_on_interrupt</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>   <span class="c1"># True면 인터럽트 시 수집된 job_id를 즉시 bkill
</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubmitResult</span><span class="p">:</span>
        <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SubmitItem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">job_ids_all</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">job_id_to_cmd</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">in_flight</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubmitItem</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">run_command_capture_job</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">cmd_timeout</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">cmd_raise_on_error</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="nc">SubmitItem</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">returncode</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span>
                              <span class="n">stdout</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">job_ids</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">job_ids</span><span class="p">)</span>

        <span class="n">idx</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">or</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">in_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_in_flight</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">is_interrupted</span><span class="p">():</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">run_one</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">commands</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
                    <span class="n">in_flight</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                    <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll_interval_sec</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                        <span class="n">in_flight</span><span class="p">.</span><span class="nf">discard</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">item</span><span class="p">:</span> <span class="n">SubmitItem</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                            <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                                <span class="n">job_ids_all</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                                <span class="n">job_id_to_cmd</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">command</span>
                            <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                                <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">poll_interval_sec</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">ALL_COMPLETED</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">item</span><span class="p">:</span> <span class="n">SubmitItem</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                        <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                            <span class="n">job_ids_all</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                            <span class="n">job_id_to_cmd</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">command</span>
                        <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">interrupted</span> <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="nf">is_interrupted</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">interrupted</span> <span class="ow">and</span> <span class="n">cleanup_on_interrupt</span> <span class="ow">and</span> <span class="n">job_ids_all</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">job_ids_all</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">job_ids_all</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nb">dict</span><span class="p">.</span><span class="nf">fromkeys</span><span class="p">(</span><span class="n">job_ids_all</span><span class="p">))</span>
        <span class="k">return</span> <span class="nc">SubmitResult</span><span class="p">(</span>
            <span class="n">interrupted</span><span class="o">=</span><span class="n">interrupted</span><span class="p">,</span>
            <span class="n">items</span><span class="o">=</span><span class="n">items</span><span class="p">,</span>
            <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids_all</span><span class="p">,</span>
            <span class="n">job_id_to_command</span><span class="o">=</span><span class="n">job_id_to_cmd</span><span class="p">,</span>
            <span class="n">num_submitted</span><span class="o">=</span><span class="nf">len</span><span class="p">(</span><span class="n">job_ids_all</span><span class="p">),</span>
            <span class="n">num_failed</span><span class="o">=</span><span class="n">failures</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="어떻게-쓰면-되나-step-by-step">어떻게 쓰면 되나 (step-by-step)</h2>

<h3 id="1-전역-동시-실행-수를-한-번만-설정">1) 전역 동시 실행 수를 한 번만 설정</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">lsf_core</span> <span class="kn">import</span> <span class="n">configure_global_cli_concurrency</span>
<span class="nf">configure_global_cli_concurrency</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>   <span class="c1"># 프로세스(=루프) 전체에서 최대 6개만 동시 실행
</span></code></pre></div></div>

<blockquote>
  <p>이건 <strong>클라이언트들을 만들기 전에</strong> 호출하세요. 같은 이벤트 루프에서 만든 모든 <code class="language-plaintext highlighter-rouge">LSFClient</code>가 이 세마포어를 공유합니다.</p>
</blockquote>

<h3 id="2-클라이언트-여러-개-만들어도-ok">2) 클라이언트 여러 개 만들어도 OK</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">lsf_core</span> <span class="kn">import</span> <span class="n">LSFClient</span>

<span class="n">c1</span> <span class="o">=</span> <span class="nc">LSFClient</span><span class="p">()</span>                   <span class="c1"># 기본: 공유 세마포어 사용
</span><span class="n">c2</span> <span class="o">=</span> <span class="nc">LSFClient</span><span class="p">()</span>                   <span class="c1"># 동일 루프면 c1과 같은 세마포어 공유
</span><span class="n">c3</span> <span class="o">=</span> <span class="nc">LSFClient</span><span class="p">(</span><span class="n">share_semaphore</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">max_concurrent_cli</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># 정말 필요하면 독립 세마포어
</span></code></pre></div></div>

<h3 id="3-질문에서-준-루프">3) 질문에서 준 루프</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">job_sub a.txt</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">mkdir package</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">bsub -q short sleep 3</span><span class="sh">"</span><span class="p">]</span>

<span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c1</span><span class="p">.</span><span class="nf">submit_many_with_cancel</span><span class="p">(</span><span class="n">cmds</span><span class="p">,</span> <span class="n">is_interrupted</span><span class="o">=</span><span class="n">is_interrupted</span><span class="p">)</span>
<span class="k">if</span> <span class="n">data</span><span class="p">.</span><span class="n">interrupted</span> <span class="ow">or</span> <span class="nf">is_interrupted</span><span class="p">():</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">중지되었습니다.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span>

<span class="n">job_ids</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">job_ids</span>
<span class="k">while</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">c1</span><span class="p">.</span><span class="nf">is_finished</span><span class="p">(</span><span class="n">job_ids</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c1</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">job_id</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
        <span class="n">job_command</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">job_id_to_command</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">status</span><span class="p">[</span><span class="n">job_id</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">),</span> <span class="n">job_command</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nf">is_interrupted</span><span class="p">():</span>
        <span class="k">await</span> <span class="n">c1</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>   <span class="c1"># 옵션 없이 순수 bkill
</span>        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">중지하였습니다.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">모두 완료되었습니다.</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="왜-이게-더-일반적이고-좋은-선택인가">왜 이게 “더 일반적이고 좋은 선택”인가</h2>

<ul>
  <li>
    <p><strong>안전한 기본값</strong> : 대부분의 애플리케이션은 단일 이벤트 루프에서 돌아가므로, 루프 단위 전역 세마포어 공유가 가장 자연스럽고 안정적.</p>
  </li>
  <li>
    <p><strong>예측 가능한 동시성</strong> : <code class="language-plaintext highlighter-rouge">configure_global_cli_concurrency(N)</code> 딱 한 번으로 프로세스 전체 실행량을 제어.</p>
  </li>
  <li>
    <p><strong>유연성</strong> : 예외적으로 독립 세마포어가 필요하면 <code class="language-plaintext highlighter-rouge">share_semaphore=False</code>로 분리 가능.</p>
  </li>
  <li>
    <p><strong>복잡도 최소화</strong> : 싱글톤 클라이언트 강제보다 제어 지점이 명확하고, 테스트·확장이 쉽다.</p>
  </li>
</ul>

<p>원하면 전역 동시 실행 수를 환경변수(예: <code class="language-plaintext highlighter-rouge">LSF_CLI_MAX=6</code>)로도 읽도록 한 줄 추가해줄게.</p>

<p class="chat--user">

SharedCache도 한 프로세스 내에 LSFClient가 여러개 있을 때 최대한 효율적으로 동작하게 하고 싶어. 지금은 Client가 N개면 Cache도 N개 있는데 이건 좀 비효율적인거 아닌가 싶어서.

</p>

<p>좋은 포인트! 한 프로세스(정확히는 <strong>같은 이벤트 루프</strong>) 안에서 <code class="language-plaintext highlighter-rouge">LSFClient</code>를 여러 개 생성해도 <strong>캐시(메모리)와 단일 플라이트(single-flight)가 중복되지 않게</strong> 고쳤어요.</p>

<p>핵심 변화만 요약:</p>

<ul>
  <li>
    <p><strong>공유 세마포어</strong> : 이미 제공했던 <code class="language-plaintext highlighter-rouge">LoopSharedSemaphore</code>로 전역 동시 실행 수를 루프 단위로 공유.</p>
  </li>
  <li>
    <p><strong>공유 메모리 캐시</strong> : <code class="language-plaintext highlighter-rouge">SharedCache</code>가 <strong>프로세스/루프 전역 메모리 샤드</strong> 를 사용하도록 변경 → <code class="language-plaintext highlighter-rouge">LSFClient</code>가 N개여도 <strong>메모리 캐시 1벌</strong> 만.</p>
  </li>
  <li>
    <p><strong>전역 single-flight</strong> : <code class="language-plaintext highlighter-rouge">bjobs</code> 스냅샷을 가져오는 fetch는 <strong>루프 전역 single-flight</strong> 로 묶어, 동시에 여러 <code class="language-plaintext highlighter-rouge">LSFClient</code>가 호출해도 <strong>실제 호출은 1회</strong> 만 수행.</p>
  </li>
</ul>

<p>아래 파일 하나로 교체해서 쓰세요. (이전 응답의 기능/인터페이스는 유지됩니다: <code class="language-plaintext highlighter-rouge">bkill</code> 옵션 없음, <code class="language-plaintext highlighter-rouge">UNKNOWN</code> 보강, <code class="language-plaintext highlighter-rouge">is_finished</code> 그레이스 처리 등.)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># lsf_core.py
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>
<span class="kn">import</span> <span class="n">getpass</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">weakref</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1"># ========== 공용 ==========
</span><span class="n">StrOrSeq</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
<span class="n">_JOBID_RE</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">cmd</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_find_job_ids</span><span class="p">(</span><span class="o">*</span><span class="n">texts</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="n">ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">finditer</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ids</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="nb">dict</span><span class="p">.</span><span class="nf">fromkeys</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="nb">RuntimeError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Command failed: </span><span class="si">{</span><span class="n">cmd_str</span><span class="si">}</span><span class="s"> (rc=</span><span class="si">{</span><span class="n">returncode</span><span class="si">}</span><span class="s">)</span><span class="se">\n</span><span class="si">{</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">cmd_str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span>

<span class="c1"># ========== 루프 전역 공유 도우미들 ==========
</span>
<span class="k">class</span> <span class="nc">LoopSharedSemaphore</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">같은 이벤트 루프 내에서 전역으로 공유되는 세마포어 (CLI 동시 실행 상한).</span><span class="sh">"""</span>
    <span class="n">_sems</span><span class="p">:</span> <span class="sh">"</span><span class="s">weakref.WeakKeyDictionary[asyncio.AbstractEventLoop, asyncio.Semaphore]</span><span class="sh">"</span> <span class="o">=</span> <span class="n">weakref</span><span class="p">.</span><span class="nc">WeakKeyDictionary</span><span class="p">()</span>
    <span class="n">_default_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">cls</span><span class="p">.</span><span class="n">_default_limit</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">limit</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Semaphore</span><span class="p">:</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
        <span class="n">sem</span> <span class="o">=</span> <span class="n">cls</span><span class="p">.</span><span class="n">_sems</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sem</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">cls</span><span class="p">.</span><span class="n">_default_limit</span><span class="p">)</span>
            <span class="n">cls</span><span class="p">.</span><span class="n">_sems</span><span class="p">[</span><span class="n">loop</span><span class="p">]</span> <span class="o">=</span> <span class="n">sem</span>
        <span class="k">return</span> <span class="n">sem</span>

<span class="k">def</span> <span class="nf">configure_global_cli_concurrency</span><span class="p">(</span><span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">클라이언트 생성 전에 한 번 호출해서 전역 동시 실행 수를 지정하세요.</span><span class="sh">"""</span>
    <span class="n">LoopSharedSemaphore</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">LoopSingleFlight</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    같은 이벤트 루프에서 key별로 동시 실행을 1회로 보장.
    사용법: await LoopSingleFlight.run(key, coro_factory)
    </span><span class="sh">"""</span>
    <span class="n">_maps</span><span class="p">:</span> <span class="sh">"</span><span class="s">weakref.WeakKeyDictionary[asyncio.AbstractEventLoop, Dict[str, asyncio.Future]]</span><span class="sh">"</span> <span class="o">=</span> <span class="n">weakref</span><span class="p">.</span><span class="nc">WeakKeyDictionary</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">coro_factory</span><span class="p">):</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
        <span class="n">fmap</span> <span class="o">=</span> <span class="n">cls</span><span class="p">.</span><span class="n">_maps</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fmap</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">fmap</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">cls</span><span class="p">.</span><span class="n">_maps</span><span class="p">[</span><span class="n">loop</span><span class="p">]</span> <span class="o">=</span> <span class="n">fmap</span>
        <span class="n">fut</span> <span class="o">=</span> <span class="n">fmap</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">fut</span>
        <span class="n">fut</span> <span class="o">=</span> <span class="n">loop</span><span class="p">.</span><span class="nf">create_future</span><span class="p">()</span>
        <span class="n">fmap</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fut</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">coro_factory</span><span class="p">()</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">fmap</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

<span class="c1"># ========== ShellRunner ==========
</span>
<span class="k">class</span> <span class="nc">ShellRunner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">create_subprocess_shell만 사용. 기본은 루프 전역 세마포어 공유.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">max_concurrency</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="n">share_semaphore</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="n">base_env</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LC_ALL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LANG</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_env</span> <span class="o">=</span> <span class="n">base_env</span> <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="bp">None</span> <span class="nf">else </span><span class="p">(</span><span class="n">base_env</span> <span class="o">|</span> <span class="n">env</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sem</span> <span class="o">=</span> <span class="n">LoopSharedSemaphore</span><span class="p">.</span><span class="nf">get</span><span class="p">()</span> <span class="k">if</span> <span class="n">share_semaphore</span> <span class="k">else</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">max_concurrency</span> <span class="ow">or</span> <span class="mi">8</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_sem</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_shell</span><span class="p">(</span>
                <span class="n">cmd_str</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_env</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ProcessLookupError</span><span class="p">):</span>
                <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>

<span class="c1"># ========== SharedCache (프로세스/루프 전역 메모리) ==========
</span>
<span class="c1"># 루트 디렉토리(= base/namespace) 단위로 메모리 샤드 공유
</span><span class="n">_MEM_SHARDS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">class</span> <span class="nc">SharedCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    멀티프로세스 공유 JSON 캐시 + **프로세스/루프 전역 메모리 샤드**:
    - 같은 프로세스에서 같은 cache_root(=base/namespace)를 쓰는 모든 LSFClient가 **한 메모리 dict 공유**
    - 디스크: tmp -&gt; fsync(tmp) -&gt; os.replace -&gt; fsync(dir) (같은 FS 내 rename 원자성)
    - 신선도: JSON 내부 ts와 파일 mtime 모두 사용(+2s skew 허용)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ttl_sec</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">,</span> <span class="n">skew_eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">cache_dir</span> <span class="ow">or</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">XDG_CACHE_HOME</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">expanduser</span><span class="p">(</span><span class="sh">"</span><span class="s">~</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">.cache</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_root</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>  <span class="c1"># shard key
</span>        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_skew</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">skew_eps</span><span class="p">)</span>
        <span class="c1"># 전역 샤드 확보
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_mem</span> <span class="o">=</span> <span class="n">_MEM_SHARDS</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1"># key -&gt; (ts, data)
</span>
    <span class="k">def</span> <span class="nf">_key_path</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">safe</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">[^A-Za-z0-9._-]+</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">safe</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># 1) 프로세스 전역 메모리
</span>        <span class="n">item</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">:</span>
            <span class="n">ts</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="c1"># 2) 디스크
</span>        <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_key_path</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">stat</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="n">ts_in</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">fresh_by_ts</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">ts_in</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">)</span> <span class="k">if</span> <span class="n">ts_in</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">False</span>
            <span class="n">fresh_by_mtime</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="nf">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">st</span><span class="p">.</span><span class="n">st_mtime</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fresh_by_ts</span> <span class="ow">or</span> <span class="n">fresh_by_mtime</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_key_path</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">dir_fd</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fd</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="p">.</span><span class="nf">mkstemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="sh">"</span><span class="s">cache_</span><span class="sh">"</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">"</span><span class="s">.json</span><span class="sh">"</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">fdopen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">},</span> <span class="n">f</span><span class="p">)</span>
                    <span class="n">f</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="nf">fileno</span><span class="p">())</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">FileNotFoundError</span><span class="p">):</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>

<span class="c1"># ========== 결과 타입 ==========
</span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SubmitItem</span><span class="p">:</span>
    <span class="n">index</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">job_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SubmitResult</span><span class="p">:</span>
    <span class="n">interrupted</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SubmitItem</span><span class="p">]</span>
    <span class="n">job_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>                    <span class="c1"># 평탄화된 전체 Job ID
</span>    <span class="n">job_id_to_command</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>     <span class="c1"># Job ID -&gt; 원 커맨드
</span>    <span class="n">num_submitted</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">num_failed</span><span class="p">:</span> <span class="nb">int</span>

<span class="c1"># ========== LSFClient ==========
</span><span class="k">class</span> <span class="nc">LSFClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - run_command_capture_job: 커맨드 그대로 실행, 출력에서 </span><span class="sh">'</span><span class="s">Job &lt;id&gt;</span><span class="sh">'</span><span class="s">(복수 가능) 파싱
    - kill: 순수 bkill (옵션 없이)
    - status: bjobs 전체 스냅샷(공유 캐시 + 전역 single-flight + 레이트리밋)
             + 누락 시 1회 강제 새로고침 + UNKNOWN 보강
    - submit_many_with_cancel: 인터럽트 시 새 실행 중단, 진행 중은 완주 → 수집 job_id 필요시 bkill
    - is_finished: UNKNOWN 그레이스(기본 15s) 동안은 미완료로 간주
    - 동시성: 루프 전역 세마포어 공유 (configure_global_cli_concurrency 사용 가능)
    </span><span class="sh">"""</span>
    <span class="n">TERMINAL</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">DONE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">EXIT</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ZOMBI</span><span class="sh">"</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">bkill</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">bjobs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">max_concurrent_cli</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>  <span class="c1"># share_semaphore=False일 때만 의미 있음
</span>        <span class="n">bjobs_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">unknown_grace_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">15.0</span><span class="p">,</span>
        <span class="n">share_semaphore</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_paths</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">:</span> <span class="n">bkill</span><span class="p">,</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">:</span> <span class="n">bjobs</span><span class="p">}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_runner</span> <span class="o">=</span> <span class="nc">ShellRunner</span><span class="p">(</span><span class="n">max_concurrency</span><span class="o">=</span><span class="n">max_concurrent_cli</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">share_semaphore</span><span class="o">=</span><span class="n">share_semaphore</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_user</span> <span class="o">=</span> <span class="n">user</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LSF_USER</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">getpass</span><span class="p">.</span><span class="nf">getuser</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="nc">SharedCache</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">ttl_sec</span><span class="o">=</span><span class="n">disk_cache_ttl_sec</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">,</span> <span class="n">skew_eps</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>

        <span class="c1"># bjobs 제어
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_min_interval_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># UNKNOWN 처리
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_unknown_seen_at</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_unknown_grace</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">unknown_grace_sec</span><span class="p">)</span>

    <span class="c1"># --- 일반 커맨드 실행 + Job ID 파싱 ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_command_capture_job</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubmitItem</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">job_ids</span> <span class="o">=</span> <span class="nf">_find_job_ids</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">raise_on_error</span> <span class="ow">and</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="nc">SubmitItem</span><span class="p">(</span><span class="n">index</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">cmd</span><span class="p">,</span> <span class="n">returncode</span><span class="o">=</span><span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">,</span> <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids</span><span class="p">)</span>

    <span class="c1"># --- bkill (옵션 없이) ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">job_ids</span><span class="p">))]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">""</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bkill</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">raise_on_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span>

    <span class="c1"># --- bjobs 스냅샷 (공유 캐시 + 전역 single-flight) ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="c1"># per-process(min: 루프) rate-limit
</span>        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">since</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span>
        <span class="k">if</span> <span class="n">since</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">-</span> <span class="n">since</span><span class="p">)</span>

        <span class="n">flag</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-a </span><span class="sh">"</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bjobs</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> -noheader -u </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s">-o </span><span class="sh">'</span><span class="s">jobid stat exit_code queue exec_host</span><span class="sh">'"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

        <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">exec_host</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">jid_i</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">result</span><span class="p">[</span><span class="n">jid_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="n">stat</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="sh">"</span><span class="s">-</span><span class="sh">"</span> <span class="k">else</span> <span class="n">exit_code</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="n">queue</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="n">exec_host</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_status_all_cached</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all|</span><span class="si">{</span><span class="sh">'</span><span class="s">-a</span><span class="sh">'</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">''</span><span class="si">}</span><span class="s">|user=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="sh">"</span>

        <span class="c1"># 1) 공유 캐시 먼저 조회
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
            <span class="n">cached</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cached</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">cached</span><span class="p">.</span><span class="nf">items</span><span class="p">()</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cached</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])}</span>

        <span class="c1"># 2) 전역 single-flight로 fetch 단일화
</span>        <span class="k">async</span> <span class="k">def</span> <span class="nf">_do_fetch</span><span class="p">():</span>
            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">items</span><span class="p">()})</span>
            <span class="k">return</span> <span class="n">data</span>

        <span class="k">if</span> <span class="n">force_refresh</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="nf">_do_fetch</span><span class="p">()</span>

        <span class="k">return</span> <span class="k">await</span> <span class="n">LoopSingleFlight</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">_do_fetch</span><span class="p">)</span>

    <span class="c1"># --- 안전한 status (누락 자동 보강 + UNKNOWN 보강) ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">status</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">all_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_status_all_cached</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="n">force_refresh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job_ids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_map</span>

        <span class="n">req_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">all_map</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req_ids</span><span class="p">}</span>

        <span class="c1"># 누락 있으면 1회 강제 새로고침
</span>        <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">out</span><span class="p">.</span><span class="nf">values</span><span class="p">()):</span>
            <span class="n">all_map2</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_status_all_cached</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req_ids</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="n">all_map2</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># 그래도 없으면 UNKNOWN 보강
</span>        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">UNKNOWN</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">_missing</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_unknown_seen_at</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="c1"># --- 완료 판정 ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">is_finished</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="nf">list</span><span class="p">({</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">st</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">include_done</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">stat</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stat</span> <span class="o">==</span> <span class="sh">"</span><span class="s">UNKNOWN</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">first</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_unknown_seen_at</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">now</span> <span class="o">-</span> <span class="n">first</span> <span class="o">&lt;</span> <span class="mf">15.0</span><span class="p">:</span>      <span class="c1"># 기본 그레이스 15초 (필요시 self._unknown_grace 사용)
</span>                    <span class="k">return</span> <span class="bp">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">stat</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">TERMINAL</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="c1"># --- 배치 제출 + 취소 ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">commands</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">StrOrSeq</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="p">:</span> <span class="nb">callable</span><span class="p">,</span>            <span class="c1"># () -&gt; bool
</span>        <span class="n">poll_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">cmd_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">cleanup_on_interrupt</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>   <span class="c1"># True면 인터럽트 시 수집된 job_id 즉시 bkill
</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubmitResult</span><span class="p">:</span>
        <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SubmitItem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">job_ids_all</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">job_id_to_cmd</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">in_flight</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubmitItem</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">run_command_capture_job</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">cmd_timeout</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">cmd_raise_on_error</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="nc">SubmitItem</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">returncode</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span>
                              <span class="n">stdout</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">job_ids</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">job_ids</span><span class="p">)</span>

        <span class="n">idx</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">or</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">in_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_in_flight</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">is_interrupted</span><span class="p">():</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">run_one</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">commands</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
                    <span class="n">in_flight</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                    <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll_interval_sec</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                        <span class="n">in_flight</span><span class="p">.</span><span class="nf">discard</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">item</span><span class="p">:</span> <span class="n">SubmitItem</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                            <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                                <span class="n">job_ids_all</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                                <span class="n">job_id_to_cmd</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">command</span>
                            <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                                <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">poll_interval_sec</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">ALL_COMPLETED</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">item</span><span class="p">:</span> <span class="n">SubmitItem</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                        <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                            <span class="n">job_ids_all</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                            <span class="n">job_id_to_cmd</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">command</span>
                        <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">interrupted</span> <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="nf">is_interrupted</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">interrupted</span> <span class="ow">and</span> <span class="n">cleanup_on_interrupt</span> <span class="ow">and</span> <span class="n">job_ids_all</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">job_ids_all</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">job_ids_all</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nb">dict</span><span class="p">.</span><span class="nf">fromkeys</span><span class="p">(</span><span class="n">job_ids_all</span><span class="p">))</span>
        <span class="k">return</span> <span class="nc">SubmitResult</span><span class="p">(</span>
            <span class="n">interrupted</span><span class="o">=</span><span class="n">interrupted</span><span class="p">,</span>
            <span class="n">items</span><span class="o">=</span><span class="n">items</span><span class="p">,</span>
            <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids_all</span><span class="p">,</span>
            <span class="n">job_id_to_command</span><span class="o">=</span><span class="n">job_id_to_cmd</span><span class="p">,</span>
            <span class="n">num_submitted</span><span class="o">=</span><span class="nf">len</span><span class="p">(</span><span class="n">job_ids_all</span><span class="p">),</span>
            <span class="n">num_failed</span><span class="o">=</span><span class="n">failures</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></div>

<h3 id="어떻게-달라졌나-step-by-step">어떻게 달라졌나 (step-by-step)</h3>

<ol>
  <li>
    <p><strong>SharedCache 메모리 공유</strong> : <code class="language-plaintext highlighter-rouge">_MEM_SHARDS</code>에 루트(= <code class="language-plaintext highlighter-rouge">cache_dir/namespace</code>)별로 딱 <strong>한 벌의 메모리 dict</strong> 만 존재 → 같은 프로세스/루프의 여러 <code class="language-plaintext highlighter-rouge">LSFClient</code>가 <strong>동일 메모리 캐시</strong> 를 씀.</p>
  </li>
  <li>
    <p><strong>전역 single-flight</strong> : <code class="language-plaintext highlighter-rouge">LoopSingleFlight.run(key, _do_fetch)</code>로 <code class="language-plaintext highlighter-rouge">bjobs</code> 스냅샷 fetch를 루프 전역 1회로 제한.</p>
  </li>
  <li>
    <p><strong>동시 실행 상한</strong> : <code class="language-plaintext highlighter-rouge">LoopSharedSemaphore</code>로 루프 전역 동시 실행 수 제어(원하면 <code class="language-plaintext highlighter-rouge">configure_global_cli_concurrency(N)</code> 호출).</p>
  </li>
</ol>

<p>이제 한 프로세스에서 <code class="language-plaintext highlighter-rouge">LSFClient</code>를 여러 개 만들어도:</p>

<ul>
  <li>
    <p>셸 실행 <strong>동시성 상한이 늘지 않고</strong> ,</p>
  </li>
  <li>
    <p><strong>메모리 캐시/단일 플라이트도 중복되지 않아서</strong> 불필요한 <code class="language-plaintext highlighter-rouge">bjobs</code> 실행이 사실상 1회로 합쳐집니다.</p>
  </li>
</ul>

<p>필요하면 캐시 루트(<code class="language-plaintext highlighter-rouge">cache_dir</code>, <code class="language-plaintext highlighter-rouge">namespace</code>)를 팀/유저 단위로 나눠서 격리할 수도 있어요.</p>

<p class="chat--user">

이렇게 복잡해질 일인가 싶네. 그냥 이벤트 루프는 1개라고 가정하고 모두 공유하면 안돼?

</p>

<p>좋아, <strong>“이벤트 루프는 1개라고 가정”</strong>하고, <strong>프로세스 전역으로 모두 공유</strong> 하도록 깔끔하게 정리했어.<br />
전역 공유 대상: <strong>세마포어(동시 실행 상한), 메모리 캐시, single-flight, bjobs rate-limit</strong>.</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bkill</code>은 <strong>옵션 없이</strong> 만 사용.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bjobs</code>는 <strong>전체 스냅샷 1회</strong> + <strong>메모리/디스크 TTL 캐시</strong> + <strong>전역 single-flight</strong> , 과호출 방지.</p>
  </li>
  <li>
    <p>스냅샷에 <strong>누락</strong> 되면 1회 강제 갱신 → 그래도 없으면 <code class="language-plaintext highlighter-rouge">{"stat":"UNKNOWN"}</code> 으로 <strong>보강</strong>(에러 X).</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">is_finished()</code>는 <code class="language-plaintext highlighter-rouge">UNKNOWN</code>을 <strong>그레이스(기본 15s)</strong> 동안은 “미완료”로 간주, 이후 완료로 간주.</p>
  </li>
  <li>
    <p><strong>전역 동시 실행 수</strong> 는 <code class="language-plaintext highlighter-rouge">configure_global_cli_concurrency(N)</code>로 한 번만 설정(클라이언트 생성 전 권장).</p>
  </li>
</ul>

<hr />
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># lsf_simple.py
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>
<span class="kn">import</span> <span class="n">getpass</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1"># ===================== 전역 설정/공유 상태 =====================
</span><span class="n">_DEFAULT_CONCURRENCY</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">_SEM</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">Semaphore</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>                 <span class="c1"># 프로세스 전역 세마포어(단일 이벤트 루프 가정)
</span><span class="n">_MEM_CACHE</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>           <span class="c1"># 프로세스 전역 메모리 캐시
</span><span class="n">_INFLIGHT</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>               <span class="c1"># 프로세스 전역 single-flight (key -&gt; Future)
</span><span class="n">_LAST_BJOBS_CALL</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>                 <span class="c1"># rate-limit용 마지막 호출시각 (key= f"{user}|{'a' if include_done else ''}")
</span>
<span class="k">def</span> <span class="nf">configure_global_cli_concurrency</span><span class="p">(</span><span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">프로세스 전역 CLI 동시 실행 상한을 설정. 가능한 한 클라이언트 사용 전에 호출하세요.</span><span class="sh">"""</span>
    <span class="k">global</span> <span class="n">_DEFAULT_CONCURRENCY</span>
    <span class="n">_DEFAULT_CONCURRENCY</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">limit</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_get_global_sem</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Semaphore</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_SEM</span>
    <span class="k">if</span> <span class="n">_SEM</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">_SEM</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">_DEFAULT_CONCURRENCY</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_SEM</span>

<span class="c1"># ===================== 공용 유틸 =====================
</span><span class="n">StrOrSeq</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
<span class="n">_JOBID_RE</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">cmd</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_find_job_ids</span><span class="p">(</span><span class="o">*</span><span class="n">texts</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="n">ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">:</span> 
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">finditer</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">ids</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span> <span class="k">pass</span>
    <span class="c1"># 중복 제거(출력 중복 대비)
</span>    <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="nb">dict</span><span class="p">.</span><span class="nf">fromkeys</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="nb">RuntimeError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Command failed: </span><span class="si">{</span><span class="n">cmd_str</span><span class="si">}</span><span class="s"> (rc=</span><span class="si">{</span><span class="n">returncode</span><span class="si">}</span><span class="s">)</span><span class="se">\n</span><span class="si">{</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">cmd_str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span>

<span class="c1"># ===================== ShellRunner (전역 세마포어 공유) =====================
</span><span class="k">class</span> <span class="nc">ShellRunner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">create_subprocess_shell + 전역 세마포어로 동시 실행 제한</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">base_env</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LC_ALL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LANG</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_env</span> <span class="o">=</span> <span class="n">base_env</span> <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="bp">None</span> <span class="nf">else </span><span class="p">(</span><span class="n">base_env</span> <span class="o">|</span> <span class="n">env</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">sem</span> <span class="o">=</span> <span class="nf">_get_global_sem</span><span class="p">()</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">sem</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_shell</span><span class="p">(</span>
                <span class="n">cmd_str</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_env</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ProcessLookupError</span><span class="p">):</span>
                <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>

<span class="c1"># ===================== SharedCache (프로세스 전역 메모리 + 디스크) =====================
</span><span class="k">class</span> <span class="nc">SharedCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    멀티프로세스 공유 JSON 캐시 + 프로세스 전역 메모리:
      - 메모리 TTL: _MEM_CACHE 사용
      - 디스크 TTL: tmp -&gt; fsync(tmp) -&gt; os.replace -&gt; fsync(dir)
      - 신선도: JSON 내부 ts와 파일 mtime 모두로 판정(+2s skew 허용)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ttl_sec</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">,</span> <span class="n">skew_eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">cache_dir</span> <span class="ow">or</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">XDG_CACHE_HOME</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">expanduser</span><span class="p">(</span><span class="sh">"</span><span class="s">~</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">.cache</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_root</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_skew</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">skew_eps</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_key_path</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">safe</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">[^A-Za-z0-9._-]+</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">safe</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># 1) 프로세스 전역 메모리
</span>        <span class="n">item</span> <span class="o">=</span> <span class="n">_MEM_CACHE</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">:</span>
            <span class="n">ts</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="c1"># 2) 디스크
</span>        <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_key_path</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">stat</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="n">ts_in</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">fresh_by_ts</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">ts_in</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">)</span> <span class="k">if</span> <span class="n">ts_in</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">False</span>
            <span class="n">fresh_by_mtime</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="nf">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">st</span><span class="p">.</span><span class="n">st_mtime</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fresh_by_ts</span> <span class="ow">or</span> <span class="n">fresh_by_mtime</span><span class="p">:</span>
                <span class="n">_MEM_CACHE</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">_MEM_CACHE</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_key_path</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">dir_fd</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fd</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="p">.</span><span class="nf">mkstemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="sh">"</span><span class="s">cache_</span><span class="sh">"</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">"</span><span class="s">.json</span><span class="sh">"</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">fdopen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">},</span> <span class="n">f</span><span class="p">)</span>
                    <span class="n">f</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="nf">fileno</span><span class="p">())</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>     <span class="c1"># 같은 FS 내 원자적
</span>                <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>       <span class="c1"># 메타데이터 영속
</span>            <span class="k">finally</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">FileNotFoundError</span><span class="p">):</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>

<span class="c1"># ===================== 결과 타입 =====================
</span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SubmitItem</span><span class="p">:</span>
    <span class="n">index</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">job_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SubmitResult</span><span class="p">:</span>
    <span class="n">interrupted</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SubmitItem</span><span class="p">]</span>
    <span class="n">job_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>                    <span class="c1"># 평탄화된 전체 Job ID
</span>    <span class="n">job_id_to_command</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>     <span class="c1"># Job ID -&gt; 원 커맨드
</span>    <span class="n">num_submitted</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">num_failed</span><span class="p">:</span> <span class="nb">int</span>

<span class="c1"># ===================== LSFClient =====================
</span><span class="k">class</span> <span class="nc">LSFClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - run_command_capture_job: 커맨드 그대로 실행, 출력에서 </span><span class="sh">'</span><span class="s">Job &lt;id&gt;</span><span class="sh">'</span><span class="s">(복수 가능) 파싱
    - kill: 순수 bkill (옵션 없이)
    - status: bjobs 전체 스냅샷(전역 캐시 + 전역 single-flight + rate-limit)
              누락 시 1회 강제 갱신 → 그래도 없으면 UNKNOWN 보강
    - submit_many_with_cancel: 인터럽트 시 새 실행 중단, 진행 중은 완주 → 수집 job_id 필요시 bkill
    - is_finished: UNKNOWN 그레이스(기본 15s) 동안은 미완료로 취급
    </span><span class="sh">"""</span>
    <span class="n">TERMINAL</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">DONE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">EXIT</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ZOMBI</span><span class="sh">"</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">bkill</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">bjobs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">bjobs_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">unknown_grace_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">15.0</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_paths</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">:</span> <span class="n">bkill</span><span class="p">,</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">:</span> <span class="n">bjobs</span><span class="p">}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_runner</span> <span class="o">=</span> <span class="nc">ShellRunner</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_user</span> <span class="o">=</span> <span class="n">user</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LSF_USER</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">getpass</span><span class="p">.</span><span class="nf">getuser</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="nc">SharedCache</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">ttl_sec</span><span class="o">=</span><span class="n">disk_cache_ttl_sec</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">,</span> <span class="n">skew_eps</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_min_interval_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_unknown_seen_at</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_unknown_grace</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">unknown_grace_sec</span><span class="p">)</span>

    <span class="c1"># ---- 일반 커맨드 실행 + Job ID 파싱 ----
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_command_capture_job</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubmitItem</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">job_ids</span> <span class="o">=</span> <span class="nf">_find_job_ids</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">raise_on_error</span> <span class="ow">and</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="nc">SubmitItem</span><span class="p">(</span><span class="n">index</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">cmd</span><span class="p">,</span> <span class="n">returncode</span><span class="o">=</span><span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">,</span> <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids</span><span class="p">)</span>

    <span class="c1"># ---- bkill (옵션 없이) ----
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">job_ids</span><span class="p">))]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">""</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bkill</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">raise_on_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span>

    <span class="c1"># ---- bjobs 전체 스냅샷 (전역 캐시 + single-flight + rate-limit) ----
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="c1"># 전역 rate-limit: user &amp; include_done 조합별로 제한
</span>        <span class="n">rl_key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="s">|</span><span class="si">{</span><span class="sh">'</span><span class="s">a</span><span class="sh">'</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">''</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">since</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">_LAST_BJOBS_CALL</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">rl_key</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">since</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">-</span> <span class="n">since</span><span class="p">)</span>

        <span class="n">flag</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-a </span><span class="sh">"</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bjobs</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> -noheader -u </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s">-o </span><span class="sh">'</span><span class="s">jobid stat exit_code queue exec_host</span><span class="sh">'"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">_LAST_BJOBS_CALL</span><span class="p">[</span><span class="n">rl_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

        <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">exec_host</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">jid_i</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">result</span><span class="p">[</span><span class="n">jid_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="n">stat</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="sh">"</span><span class="s">-</span><span class="sh">"</span> <span class="k">else</span> <span class="n">exit_code</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="n">queue</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="n">exec_host</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_status_all_cached</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span> <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all|</span><span class="si">{</span><span class="sh">'</span><span class="s">-a</span><span class="sh">'</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">''</span><span class="si">}</span><span class="s">|user=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="sh">"</span>

        <span class="c1"># 1) 전역 캐시 먼저
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
            <span class="n">cached</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cached</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">cached</span><span class="p">.</span><span class="nf">items</span><span class="p">()</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cached</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])}</span>

        <span class="c1"># 2) 전역 single-flight: 같은 key로 동시에 들어오면 1회만 fetch
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
            <span class="n">fut</span> <span class="o">=</span> <span class="n">_INFLIGHT</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fut</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">fut</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">().</span><span class="nf">create_future</span><span class="p">()</span>
                <span class="n">_INFLIGHT</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fut</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">items</span><span class="p">()})</span>
                    <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">fut</span><span class="p">.</span><span class="nf">set_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">_INFLIGHT</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">fut</span>

        <span class="c1"># 강제 갱신 경로
</span>        <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">items</span><span class="p">()})</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="c1"># ---- 안전한 status (누락 자동 보강) ----
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">status</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span> <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">all_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_status_all_cached</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="n">force_refresh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job_ids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_map</span>

        <span class="n">req_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">all_map</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req_ids</span><span class="p">}</span>

        <span class="c1"># 누락 있으면 1회 강제 갱신
</span>        <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">out</span><span class="p">.</span><span class="nf">values</span><span class="p">()):</span>
            <span class="n">all_map2</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_status_all_cached</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req_ids</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="n">all_map2</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># 그래도 없으면 UNKNOWN 보강 + 첫 발견 시각 기록
</span>        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">UNKNOWN</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">_missing</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_unknown_seen_at</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="c1"># ---- 완료 판정 ----
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">is_finished</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="nf">list</span><span class="p">({</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">st</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">include_done</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">stat</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stat</span> <span class="o">==</span> <span class="sh">"</span><span class="s">UNKNOWN</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">first</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_unknown_seen_at</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">now</span> <span class="o">-</span> <span class="n">first</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_unknown_grace</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">stat</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">TERMINAL</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="c1"># ---- 배치 제출 + 취소 ----
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">commands</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">StrOrSeq</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="p">:</span> <span class="nb">callable</span><span class="p">,</span>            <span class="c1"># () -&gt; bool
</span>        <span class="n">poll_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">cmd_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">cleanup_on_interrupt</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>   <span class="c1"># True면 인터럽트 시 수집된 job_id 즉시 bkill
</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubmitResult</span><span class="p">:</span>
        <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SubmitItem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">job_ids_all</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">job_id_to_cmd</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">in_flight</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubmitItem</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">run_command_capture_job</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">cmd_timeout</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">cmd_raise_on_error</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="nc">SubmitItem</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">returncode</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span>
                              <span class="n">stdout</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">job_ids</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">job_ids</span><span class="p">)</span>

        <span class="n">idx</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">or</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">in_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_in_flight</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">is_interrupted</span><span class="p">():</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">run_one</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">commands</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
                    <span class="n">in_flight</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                    <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll_interval_sec</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                        <span class="n">in_flight</span><span class="p">.</span><span class="nf">discard</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">item</span><span class="p">:</span> <span class="n">SubmitItem</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                            <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                                <span class="n">job_ids_all</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                                <span class="n">job_id_to_cmd</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">command</span>
                            <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                                <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">poll_interval_sec</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">ALL_COMPLETED</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">item</span><span class="p">:</span> <span class="n">SubmitItem</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                        <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                            <span class="n">job_ids_all</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                            <span class="n">job_id_to_cmd</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">command</span>
                        <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">interrupted</span> <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="nf">is_interrupted</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">interrupted</span> <span class="ow">and</span> <span class="n">cleanup_on_interrupt</span> <span class="ow">and</span> <span class="n">job_ids_all</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">job_ids_all</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">job_ids_all</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nb">dict</span><span class="p">.</span><span class="nf">fromkeys</span><span class="p">(</span><span class="n">job_ids_all</span><span class="p">))</span>
        <span class="k">return</span> <span class="nc">SubmitResult</span><span class="p">(</span>
            <span class="n">interrupted</span><span class="o">=</span><span class="n">interrupted</span><span class="p">,</span>
            <span class="n">items</span><span class="o">=</span><span class="n">items</span><span class="p">,</span>
            <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids_all</span><span class="p">,</span>
            <span class="n">job_id_to_command</span><span class="o">=</span><span class="n">job_id_to_cmd</span><span class="p">,</span>
            <span class="n">num_submitted</span><span class="o">=</span><span class="nf">len</span><span class="p">(</span><span class="n">job_ids_all</span><span class="p">),</span>
            <span class="n">num_failed</span><span class="o">=</span><span class="n">failures</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="사용-예시-질문-준-패턴-그대로">사용 예시 (질문 준 패턴 그대로)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">lsf_simple</span> <span class="kn">import</span> <span class="n">LSFClient</span><span class="p">,</span> <span class="n">configure_global_cli_concurrency</span>

<span class="c1"># 1) 전역 동시 실행 상한 (클라이언트 생성 전 1회)
</span><span class="nf">configure_global_cli_concurrency</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Token</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span> <span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">delay</span>
    <span class="k">def</span> <span class="nf">is_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">):</span> <span class="nf">return </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span><span class="o">-</span><span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">LSFClient</span><span class="p">(</span>
        <span class="n">bjobs_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="o">=</span><span class="sh">"</span><span class="s">/shared/cache</span><span class="sh">"</span><span class="p">,</span>     <span class="c1"># 여러 머신이 공유하는 FS면 더 좋아요
</span>        <span class="n">unknown_grace_sec</span><span class="o">=</span><span class="mf">15.0</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">is_interrupted</span> <span class="o">=</span> <span class="nc">Token</span><span class="p">(</span><span class="n">delay</span><span class="o">=</span><span class="mi">9999</span><span class="p">).</span><span class="n">is_interrupted</span>  <span class="c1"># 실제론 외부 신호로 대체
</span>
    <span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">job_sub a.txt</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">mkdir package</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">bsub -q short sleep 3</span><span class="sh">"</span><span class="p">]</span>

    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">submit_many_with_cancel</span><span class="p">(</span><span class="n">cmds</span><span class="p">,</span> <span class="n">is_interrupted</span><span class="o">=</span><span class="n">is_interrupted</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span><span class="p">.</span><span class="n">interrupted</span> <span class="ow">or</span> <span class="nf">is_interrupted</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">중지되었습니다.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">job_ids</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">job_ids</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">job_ids</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">제출된 LSF 잡이 없습니다.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">is_finished</span><span class="p">(</span><span class="n">job_ids</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">job_id</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">job_command</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">job_id_to_command</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="sh">"</span><span class="s">&lt;unknown&gt;</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">status</span><span class="p">[</span><span class="n">job_id</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">),</span> <span class="n">job_command</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">is_interrupted</span><span class="p">():</span>
            <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>  <span class="c1"># 순수 bkill
</span>            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">중지하였습니다.</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">모두 완료되었습니다.</span><span class="sh">"</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h3 id="왜-이-버전이-딱-좋은지-step-by-step">왜 이 버전이 딱 좋은지 (step-by-step)</h3>

<ol>
  <li>
    <p><strong>단일 이벤트 루프 가정</strong> 하에 전역 공유 → 복잡도 최소, 의도 명확.</p>
  </li>
  <li>
    <p><strong>전역 세마포어/캐시/single-flight/rate-limit</strong> 로 <code class="language-plaintext highlighter-rouge">LSFClient</code>가 여러 개여도 호출량·부하가 늘지 않음.</p>
  </li>
  <li>
    <p><strong>에러 최소화</strong> : 스냅샷 누락시 자동 갱신 &amp; <code class="language-plaintext highlighter-rouge">UNKNOWN</code> 보강, 루프가 멈추지 않도록 <code class="language-plaintext highlighter-rouge">is_finished</code> 그레이스 처리.</p>
  </li>
  <li>
    <p><strong>현실적 성능</strong> : <code class="language-plaintext highlighter-rouge">bjobs</code>는 항상 전체 스냅샷 1회 → 캐시로 재사용, I/O/부하 절감.</p>
  </li>
</ol>

<p>필요한 거 더 줄이거나(예: 클래스 1개로 합치기), 로깅/메트릭 훅만 얹고 싶으면 말해줘.</p>

        
      </section>

      <footer class="page__meta">
        
        


  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#python" class="page__taxonomy-item p-category" rel="tag">python</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2025-10-13T17:02:21+09:00">2025-10-13</time></p>

      </footer>

      

      
  <nav class="pagination">
    
      <a href="/python/python-asyncio-basic/" class="pagination--pager" title="Asyncio 사용법 설명">Previous</a>
    
    
      <a href="/comfyui/comfyui-settings/" class="pagination--pager" title="ComfyUI Custom Node 설정">Next</a>
    
  </nav>


    </div>

    
  </article>

  
  
    
<div class="page__related">
  
  <h2 class="page__related-title">You may also enjoy</h2>
  <div class="grid__wrapper">
    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2025-08-19-python-repr-vs-str/" rel="permalink">
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-17T11:37:20+09:00">2025-10-17</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/circuit/circuit-optimization-example/" rel="permalink">아날로그 회로 최적화 데모
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-17T11:37:15+09:00">2025-10-17</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/circuit/stateye/" rel="permalink">HSPICE StatEye 설정 방법
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-16T19:49:25+09:00">2025-10-16</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/comfyui/async-request-cancel/" rel="permalink">Async request 취소 처리
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <!-- hvppyarchive: remove date icon
        <i class="far fa-calendar-alt" aria-hidden="true"></i> 
        -->
        
        <time datetime="2025-10-16T11:57:41+09:00">2025-10-16</time>
      </span>
    

    

    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>

    
  </div>
</div>

  
  
</div>

      
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        

<div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    
  </ul>
</div>


<div class="page__footer-copyright">&copy; 2013 - 2025 <a href="https://hvppyarchive.github.io">ARCHIVE</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/jekyll-themes/minimal-mistakes/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>






  </body>
</html>
