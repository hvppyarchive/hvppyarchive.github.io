<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.4.1">Jekyll</generator><link href="https://hvppyarchive.github.io/feed.xml" rel="self" type="application/atom+xml" /><link href="https://hvppyarchive.github.io/" rel="alternate" type="text/html" /><updated>2025-10-10T18:42:46+09:00</updated><id>https://hvppyarchive.github.io/feed.xml</id><title type="html">ARCHIVE</title><subtitle>An amazing archive.</subtitle><author><name>hvppyarchive</name></author><entry><title type="html"></title><link href="https://hvppyarchive.github.io/2025-08-19-python-repr-vs-str/" rel="alternate" type="text/html" title="" /><published>2025-10-10T18:42:46+09:00</published><updated>2025-10-10T18:42:46+09:00</updated><id>https://hvppyarchive.github.io/2025-08-19-python-repr-vs-str</id><content type="html" xml:base="https://hvppyarchive.github.io/2025-08-19-python-repr-vs-str/"><![CDATA[<p class="chat--user">

Pythonì—ì„œ <code class="language-plaintext highlighter-rouge">__repr__</code> í•¨ìˆ˜ì™€ <code class="language-plaintext highlighter-rouge">__str__</code> í•¨ìˆ˜ì˜ ì°¨ì´ì 

</p>

<p>Pythonì—ì„œ <code class="language-plaintext highlighter-rouge">__repr__</code> ê³¼ <code class="language-plaintext highlighter-rouge">__str__</code> ì˜ ì°¨ì´ì ì€ <strong>ê°ì²´ë¥¼ ë¬¸ìì—´ë¡œ í‘œí˜„í•˜ëŠ” ëª©ì </strong> ì—ì„œ ë‹¬ë¼ì§‘ë‹ˆë‹¤. ì°¨ì´ë¥¼ ë‹¨ê³„ì ìœ¼ë¡œ ì •ë¦¬í•´ë“œë¦´ê²Œìš”.</p>

<hr />

<h2 id="1-__repr__-ì˜-ëª©ì ">1. <code class="language-plaintext highlighter-rouge">__repr__</code> ì˜ ëª©ì </h2>

<ul>
  <li>
    <p><strong>ê°œë°œì ì¤‘ì‹¬</strong> : ê°ì²´ë¥¼ "ê°œë°œì"ê°€ ë³´ê³  ì´í•´í•  ìˆ˜ ìˆë„ë¡ í‘œí˜„í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>ì¬í˜„ ê°€ëŠ¥(reproducible)</strong> : ê°€ëŠ¥í•œ í•œ ê°ì²´ë¥¼ ë‹¤ì‹œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ì½”ë“œ í˜•íƒœë¡œ ë³´ì—¬ì£¼ëŠ” ê²ƒì´ ëª©í‘œì…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë³´í†µ <code class="language-plaintext highlighter-rouge">eval(repr(obj)) == obj</code> ê°€ ì„±ë¦½í•˜ëŠ” í˜•íƒœë¥¼ ì§€í–¥í•©ë‹ˆë‹¤ (ê¼­ í•­ìƒ ê·¸ëŸ° ê±´ ì•„ë‹ˆì§€ë§Œ ê¶Œì¥).</p>
  </li>
  <li>
    <p>ë””ë²„ê¹…í•  ë•Œ ì£¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.</p>
  </li>
</ul>

<p>ì˜ˆì‹œ:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
    
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Person(name=</span><span class="sh">'</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">'</span><span class="s">, age=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">age</span><span class="si">}</span><span class="s">)</span><span class="sh">"</span>

<span class="n">p</span> <span class="o">=</span> <span class="nc">Person</span><span class="p">(</span><span class="sh">"</span><span class="s">Alice</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>  <span class="c1"># Person(name='Alice', age=30)
</span></code></pre></div></div>

<hr />

<h2 id="2-__str__-ì˜-ëª©ì ">2. <code class="language-plaintext highlighter-rouge">__str__</code> ì˜ ëª©ì </h2>

<ul>
  <li>
    <p><strong>ì‚¬ìš©ì ì¤‘ì‹¬</strong> : ê°ì²´ë¥¼ "ì‚¬ìš©ì"ê°€ ë³´ê¸° ì¢‹ì€ ë¬¸ìì—´ë¡œ í‘œí˜„í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì½ê¸° ì‰½ê³  ê¹”ë”í•˜ê²Œ ì¶œë ¥í•˜ëŠ” ë° ì´ˆì ì„ ë‘¡ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">print(obj)</code> ë¥¼ í˜¸ì¶œí–ˆì„ ë•Œ ë³´ì—¬ì§€ëŠ” ê°’ì´ <code class="language-plaintext highlighter-rouge">__str__</code> ì…ë‹ˆë‹¤.</p>
  </li>
</ul>

<p>ì˜ˆì‹œ:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
    
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">age</span><span class="si">}</span><span class="s"> years old)</span><span class="sh">"</span>

<span class="n">p</span> <span class="o">=</span> <span class="nc">Person</span><span class="p">(</span><span class="sh">"</span><span class="s">Alice</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>  <span class="c1"># Alice (30 years old)
</span></code></pre></div></div>

<hr />

<h2 id="3-__repr__-vs-__str__-ë¹„êµ">3. <code class="language-plaintext highlighter-rouge">__repr__</code> vs <code class="language-plaintext highlighter-rouge">__str__</code> ë¹„êµ</h2>

<table>
  <thead>
    <tr>
      <th>íŠ¹ì§•</th>
      <th><code class="language-plaintext highlighter-rouge">__repr__</code></th>
      <th><code class="language-plaintext highlighter-rouge">__str__</code></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ëª©ì </td>
      <td>ê°œë°œììš©, ë””ë²„ê¹…</td>
      <td>ì‚¬ìš©ììš©, ê°€ë…ì„±</td>
    </tr>
    <tr>
      <td>ì¶œë ¥ ëŒ€ìƒ</td>
      <td><code class="language-plaintext highlighter-rouge">repr(obj)</code>, ëŒ€í™”í˜• ì‰˜ì—ì„œ ê¸°ë³¸</td>
      <td><code class="language-plaintext highlighter-rouge">str(obj)</code>, <code class="language-plaintext highlighter-rouge">print(obj)</code></td>
    </tr>
    <tr>
      <td>í˜•ì‹</td>
      <td>ê°ì²´ ì¬í˜„ ê°€ëŠ¥í•˜ê±°ë‚˜ ìƒì„¸</td>
      <td>ì½ê¸° ì‰¬ìš´ ì„¤ëª… ìœ„ì£¼</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="4-êµ¬í˜„-ì‹œ-ì£¼ì˜ì‚¬í•­">4. êµ¬í˜„ ì‹œ ì£¼ì˜ì‚¬í•­</h2>

<ul>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">__str__</code> ê°€ ì—†ìœ¼ë©´ <code class="language-plaintext highlighter-rouge">__repr__</code> ê°€ ëŒ€ì‹  ì‚¬ìš©</strong>ë©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë”°ë¼ì„œ ìµœì†Œí•œ <code class="language-plaintext highlighter-rouge">__repr__</code> ì€ ì •ì˜í•´ ë‘ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />

<p>ğŸ‘‰ ì •ë¦¬í•˜ë©´,</p>

<ul>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">__repr__</code></strong> : â€œê°œë°œìê°€ ë””ë²„ê¹…í•  ë•Œâ€ ê°ì²´ì˜ ì •í™•í•œ í‘œí˜„.</p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">__str__</code></strong> : â€œì‚¬ìš©ìê°€ ì¶œë ¥ë¬¼ì„ ë³¼ ë•Œâ€ ë³´ê¸° ì¢‹ê²Œ í‘œí˜„.</p>
  </li>
</ul>

<hr />

<p>ì›í•˜ì‹œë©´ <code class="language-plaintext highlighter-rouge">__repr__</code> ì™€ <code class="language-plaintext highlighter-rouge">__str__</code> ë¥¼ ë™ì‹œì— êµ¬í˜„í–ˆì„ ë•Œ <code class="language-plaintext highlighter-rouge">print(obj)</code> ì™€ <code class="language-plaintext highlighter-rouge">obj</code> (ì‰˜ ì¶œë ¥) ì˜ ì°¨ì´ë¥¼ ì§ì ‘ ì‹¤í–‰í•´ ë³´ì—¬ë“œë¦´ ìˆ˜ë„ ìˆëŠ”ë°, ì˜ˆì œ ì½”ë“œ ì‹œì—°ì„ ì›í•˜ì‹œë‚˜ìš”?</p>]]></content><author><name>hvppyarchive</name></author></entry><entry><title type="html">ComfyUI LSF Job Submit</title><link href="https://hvppyarchive.github.io/comfyui/comfyui-lsf-job-submit/" rel="alternate" type="text/html" title="ComfyUI LSF Job Submit" /><published>2025-10-10T18:42:41+09:00</published><updated>2025-10-10T18:42:41+09:00</updated><id>https://hvppyarchive.github.io/comfyui/comfyui-lsf-job-submit</id><content type="html" xml:base="https://hvppyarchive.github.io/comfyui/comfyui-lsf-job-submit/"><![CDATA[<p class="chat--user">

ComfyUIì—ì„œ LSF Jobì„ Submití•˜ê³  ì´ë¥¼ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ëŠ” Custom nodeë¥¼ ê°œë°œí•˜ê³  ì‹¶ì–´. ìš”êµ¬ ì¡°ê±´ 1. main execute í•¨ìˆ˜ë¥¼ asyncí•˜ê²Œ êµ¬í˜„í•´ì•¼ í•¨(ìµœì‹  ComfyUIì—ì„œëŠ” async ë…¸ë“œ ë™ì‘ì„ ì§€ì›í•¨) 2. Pollingí•˜ë©° bjobs ì»¤ë§¨ë“œë¥¼ ì´ìš©í•´ ìƒíƒœë¥¼ ì²´í¬í•´ì•¼ í•¨. ì´ ë•Œ bjobs ì»¤ë§¨ë“œê°€ ë‹¤ë¥¸ ê±¸ë¡œ ë°”ë€Œë”ë¼ë„ ì‰½ê²Œ ë³€ê²½í•  ìˆ˜ ìˆê²Œ êµ¬ì¡°ë¥¼ ìœ ì—°í•˜ê²Œ ì§œì¤˜. 3. ì´ ë•Œ ì—¬ëŸ¬ ë…¸ë“œê°€ ë™ì‹œì— ëŒ ìˆ˜ë„ ìˆìœ¼ë©°, bjobsë¥¼ ë„ˆë¬´ ìì£¼ ì¹˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ íŒŒì¼ì‹œìŠ¤í…œì— ìºì‹±í•˜ëŠ” ë¡œì§ì´ ìˆìœ¼ë©´ ì¢‹ì„ ê²ƒ ê°™ìŒ. 4. ì…ë ¥ì€ ì»¤ë§¨ë“œ, cwd 2ê°œ ìŠ¤íŠ¸ë§ì„. ì»¤ë§¨ë“œëŠ” ë©€í‹°ë¼ì¸ìœ¼ë¡œ ì—¬ëŸ¬ bsub ì»¤ë§¨ë“œê°€ ë“¤ì–´ì˜¬ ìˆ˜ ë„ ìˆìŒì„ ëª…ì‹¬í•  ê²ƒ. bsub ì»¤ë§¨ë“œ ìì²´ë„ asyncí•˜ê²Œ ë©€í‹°ë¡œ ë¿Œë¦¬ë„ë¡ í•˜ë©´ ì¢‹ì„ ê²ƒ ê°™ìŒ(ë‹¨ ë„ˆë¬´ í•œ ë²ˆì— ë§ì€ jobì´ ë“¤ì–´ê°€ì§€ ì•Šë„ë¡ ë°°ì¹˜ ì‚¬ì´ì¦ˆ ì¡°ì ˆì€ í•„ìš”í•  ê²ƒ ê°™ìŒ) 5. ì´ ìì²´ê°€ output ë…¸ë“œì´ë©´ì„œ ëë‚˜ë©´ ì ì ˆí•œ ì•„ì›ƒí’‹(ë­ê°€ ë ì§€ëŠ” ì¶”ì²œí•´ì¤˜)ë„ ë±‰ë„ë¡ í•˜ì. 

</p>

<p>ì¢‹ì•„! ìš”êµ¬ì‚¬í•­ì„ ëª¨ë‘ ë§Œì¡±í•˜ëŠ” <strong>ComfyUIìš© LSF Submit &amp; Wait ì»¤ìŠ¤í…€ ë…¸ë“œ</strong> ì„¤ê³„ë¥¼ ê¹”ë”í•˜ê²Œ ì •ë¦¬í•œ ë’¤, ë°”ë¡œ ë¶™ì—¬ ë„£ì–´ ì“¸ ìˆ˜ ìˆëŠ” ì™„ì „í•œ ì½”ë“œë¥¼ ë“œë¦´ê²Œìš”.</p>

<h1 id="ì„¤ê³„-ê°œìš”">ì„¤ê³„ ê°œìš”</h1>

<ul>
  <li>
    <p><strong>Async ë…¸ë“œ</strong> : <code class="language-plaintext highlighter-rouge">SUPPORTS_ASYNC = True</code>, <code class="language-plaintext highlighter-rouge">async def run(...)</code> êµ¬í˜„.</p>
  </li>
  <li>
    <p><strong>ë©€í‹°ë¼ì¸ bsub ì œì¶œ</strong> : ì…ë ¥ <code class="language-plaintext highlighter-rouge">commands</code>ì˜ ê° ë¹„ì–´ìˆì§€ ì•Šì€ ë¼ì¸ì„ ë…ë¦½ ëª…ë ¹ìœ¼ë¡œ ë¹„ë™ê¸° ì œì¶œ. ë™ì‹œ ì œì¶œ ê°œìˆ˜ëŠ” ë°°ì¹˜ í¬ê¸°ë¡œ ì œí•œ.</p>
  </li>
  <li>
    <p><strong>Polling êµ¬ì¡°/ìœ ì—°ì„±</strong> : <code class="language-plaintext highlighter-rouge">StatusBackend</code> ì¸í„°í˜ì´ìŠ¤ì™€ <code class="language-plaintext highlighter-rouge">LSFBjobsBackend</code> ê¸°ë³¸ êµ¬í˜„. <code class="language-plaintext highlighter-rouge">status_cmd_template</code>(ì˜ˆ: <code class="language-plaintext highlighter-rouge">bjobs -noheader -o "jobid stat" {job_ids}</code>)ì„ ë°”ê¾¸ê¸°ë§Œ í•˜ë©´ ë‹¤ë¥¸ ì»¤ë§¨ë“œë¡œ ì‰½ê²Œ ì „í™˜.</p>
  </li>
  <li>
    <p><strong>íŒŒì¼ì‹œìŠ¤í…œ ìºì‹œ</strong> : ì—¬ëŸ¬ ë…¸ë“œê°€ ë™ì‹œì— ëŒì•„ë„ <code class="language-plaintext highlighter-rouge">status_cache.json</code>(ì ê¸ˆ í¬í•¨)ë¡œ <strong>TTL ê¸°ë°˜</strong> ìºì‹±. ë„ˆë¬´ ìì£¼ <code class="language-plaintext highlighter-rouge">bjobs</code>ë¥¼ ì¹˜ì§€ ì•Šë„ë¡ í•¨.</p>
  </li>
  <li><strong>ì…ë ¥</strong> : <code class="language-plaintext highlighter-rouge">commands</code>(ë©€í‹°ë¼ì¸ ë¬¸ìì—´), <code class="language-plaintext highlighter-rouge">cwd</code>(ì‘ì—… ë””ë ‰í† ë¦¬).<br />
ì¶”ê°€ íŒŒë¼ë¯¸í„°ëŠ” <strong>ì¸ë¼ì¸ ì§€ì‹œë¬¸</strong> ìœ¼ë¡œ ì¡°ì ˆ:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># LSF: batch_size=4 poll_interval_s=10 status_ttl_s=15</span>
</code></pre></div>    </div>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">batch_size</code>(ë™ì‹œ ì œì¶œ ê°œìˆ˜), <code class="language-plaintext highlighter-rouge">poll_interval_s</code>(í´ë§ ì£¼ê¸°), <code class="language-plaintext highlighter-rouge">status_ttl_s</code>(ìºì‹œ TTL),<br />
<code class="language-plaintext highlighter-rouge">status_cmd_template</code>(ìƒíƒœ ì¡°íšŒ ì»¤ë§¨ë“œ í…œí”Œë¦¿) ë“± ì§€ì›.</li>
    </ul>
  </li>
  <li>
    <p><strong>ì¶œë ¥(OUTPUT ë…¸ë“œ)</strong> :</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">job_ids</code>: ì œì¶œëœ Job IDë“¤ì˜ ì½¤ë§ˆ êµ¬ë¶„ ë¬¸ìì—´</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">results_json</code>: ìš”ì•½ JSON ë¬¸ìì—´(ìµœì¢… ìƒíƒœ/ì„±ê³µì—¬ë¶€/ê²°ê³¼ íŒŒì¼ ê²½ë¡œ ë“±)</p>
      </li>
    </ul>
  </li>
  <li><strong>í„°ë¯¸ë„ ìƒíƒœ</strong> : ê¸°ë³¸ <code class="language-plaintext highlighter-rouge">{"DONE","EXIT"}</code>. í•„ìš”ì‹œ ì½”ë“œ ë‚´ ìƒìˆ˜ë¡œ í™•ì¥ ê°€ëŠ¥.</li>
</ul>

<hr />

<h1 id="ì„¤ì¹˜ì‚¬ìš©ë²•">ì„¤ì¹˜/ì‚¬ìš©ë²•</h1>

<ol>
  <li>
    <p>ì•„ë˜ ì½”ë“œë¥¼ <code class="language-plaintext highlighter-rouge">ComfyUI/custom_nodes/lsf_submit_and_wait.py</code> ë¡œ ì €ì¥ í›„ ComfyUI ì¬ì‹œì‘.</p>
  </li>
  <li>ì›Œí¬í”Œë¡œì—ì„œ ì´ ë…¸ë“œë¥¼ ë§ˆì§€ë§‰ì— ë‘ê³ , <code class="language-plaintext highlighter-rouge">commands</code>ì— ì—¬ëŸ¬ ì¤„ <code class="language-plaintext highlighter-rouge">bsub ...</code>ë“¤ì„ ë„£ìœ¼ë©´ ë¨.<br />
ì˜µì…˜ì€ ë§¨ ìœ„ì— í•œ ì¤„ì˜ ì¸ë¼ì¸ ì§€ì‹œë¬¸ìœ¼ë¡œ ì¡°ì ˆ:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># LSF: batch_size=3 poll_interval_s=15 status_ttl_s=30</span>
bsub <span class="nt">-q</span> short <span class="nt">-J</span> test1 <span class="nb">sleep </span>5
bsub <span class="nt">-q</span> short <span class="nt">-J</span> test2 <span class="nb">sleep </span>8
bsub <span class="nt">-q</span> short <span class="nt">-J</span> test3 <span class="nb">sleep </span>2
</code></pre></div>    </div>
  </li>
  <li>ê²°ê³¼ëŠ” <code class="language-plaintext highlighter-rouge">job_ids</code>ì™€ <code class="language-plaintext highlighter-rouge">results_json</code>(ìš”ì•½/ê²°ê³¼ íŒŒì¼ ê²½ë¡œ í¬í•¨)ìœ¼ë¡œ ë°˜í™˜ë©ë‹ˆë‹¤.</li>
</ol>

<hr />

<h1 id="ì½”ë“œ-ê·¸ëŒ€ë¡œ-ì‚¬ìš©-ê°€ëŠ¥">ì½”ë“œ (ê·¸ëŒ€ë¡œ ì‚¬ìš© ê°€ëŠ¥)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># File: custom_nodes/lsf_submit_and_wait.py
</span><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">shlex</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># fcntl (POSIX) ì ê¸ˆ: Windowsì—ì„  graceful degrade
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">fcntl</span>  <span class="c1"># type: ignore
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">fcntl</span> <span class="o">=</span> <span class="bp">None</span>

<span class="c1"># ---------- ìœ í‹¸ ----------
</span>
<span class="n">JOB_ID_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
<span class="n">TERMINAL_STATES</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">DONE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">EXIT</span><span class="sh">"</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">iso_now</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">utcnow</span><span class="p">().</span><span class="nf">isoformat</span><span class="p">(</span><span class="n">timespec</span><span class="o">=</span><span class="sh">"</span><span class="s">seconds</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">Z</span><span class="sh">"</span>

<span class="k">def</span> <span class="nf">default_cache_dir</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">COMFYUI_LSF_CACHE_DIR</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">tempfile</span><span class="p">.</span><span class="nf">gettempdir</span><span class="p">(),</span> <span class="sh">"</span><span class="s">comfyui_lsf_cache</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d</span>

<span class="k">def</span> <span class="nf">parse_inline_options_and_commands</span><span class="p">(</span><span class="n">commands_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    ì²« ì¤„(ë“¤)ì— </span><span class="sh">'</span><span class="s"># LSF: key=value key=value ...</span><span class="sh">'</span><span class="s"> í˜•ì‹ì˜ ì¸ë¼ì¸ ì˜µì…˜ì„ í—ˆìš©.
    ë°˜í™˜: (options_dict, command_lines)
    </span><span class="sh">"""</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">ln</span> <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">commands_text</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">()]</span>
    <span class="n">clean_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">^\s*#\s*LSF:\s*(.+)$</span><span class="sh">"</span><span class="p">,</span> <span class="n">ln</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="c1"># key=value ... íŒŒì‹±(ë”°ì˜´í‘œ í—ˆìš©)
</span>            <span class="n">kvs</span> <span class="o">=</span> <span class="n">shlex</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">posix</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">kv</span> <span class="ow">in</span> <span class="n">kvs</span><span class="p">:</span>
                <span class="k">if</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">kv</span><span class="p">:</span>
                    <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">kv</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># ìˆ«ìí˜• ìë™ ìºìŠ¤íŒ…
</span>                    <span class="k">if</span> <span class="n">v</span><span class="p">.</span><span class="nf">isdigit</span><span class="p">():</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># true/false
</span>                        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">false</span><span class="sh">"</span><span class="p">):</span>
                            <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="o">==</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span>
                    <span class="n">options</span><span class="p">[</span><span class="n">k</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">continue</span>
        <span class="n">clean_lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">ln</span><span class="p">)</span>
    <span class="c1"># ë¹„ì–´ìˆëŠ” ë¼ì¸ ì œê±°
</span>    <span class="n">clean_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">ln</span> <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">clean_lines</span> <span class="k">if</span> <span class="n">ln</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span>
    <span class="k">return</span> <span class="n">options</span><span class="p">,</span> <span class="n">clean_lines</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_shell</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_shell</span><span class="p">(</span>
        <span class="n">cmd</span><span class="p">,</span>
        <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span> <span class="k">if</span> <span class="n">cwd</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">ignore</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">ignore</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">extract_job_ids_from_bsub_output</span><span class="p">(</span><span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="c1"># LSF í‘œì¤€: "Job &lt;12345&gt; is submitted to queue &lt;...&gt;."
</span>    <span class="k">return</span> <span class="n">JOB_ID_REGEX</span><span class="p">.</span><span class="nf">findall</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>

<span class="c1"># ---------- ìƒíƒœ ë°±ì—”ë“œ/ìºì‹œ ----------
</span>
<span class="k">class</span> <span class="nc">StatusBackend</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="nb">NotImplementedError</span>

<span class="k">class</span> <span class="nc">LSFBjobsBackend</span><span class="p">(</span><span class="n">StatusBackend</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    status_cmd_template ì˜ˆ:
      </span><span class="sh">'</span><span class="s">bjobs -noheader -o </span><span class="sh">"</span><span class="s">jobid stat</span><span class="sh">"</span><span class="s"> {job_ids}</span><span class="sh">'</span><span class="s">
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">status_cmd_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">status_cmd_template</span><span class="p">:</span>
            <span class="n">status_cmd_template</span> <span class="o">=</span> <span class="sh">'</span><span class="s">bjobs -noheader -o </span><span class="sh">"</span><span class="s">jobid stat</span><span class="sh">"</span><span class="s"> {job_ids}</span><span class="sh">'</span>
        <span class="n">self</span><span class="p">.</span><span class="n">template</span> <span class="o">=</span> <span class="n">status_cmd_template</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">template</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">job_ids</span><span class="o">=</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">job_ids</span><span class="p">))</span>
        <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_shell</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># ì‹¤íŒ¨ ì‹œ ë¹ˆ ë”•íŠ¸ ë°˜í™˜ (ìƒìœ„ ë¡œì§ì—ì„œ ì¬ì‹œë„/ìºì‹œ ì‚¬ìš©)
</span>            <span class="k">return</span> <span class="p">{}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># ê¸°ëŒ€ í¬ë§·: "&lt;jobid&gt; &lt;state&gt;"
</span>        <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">out</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">ln</span> <span class="o">=</span> <span class="n">ln</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ln</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">ln</span><span class="p">.</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">parts</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">upper</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>
        <span class="k">return</span> <span class="n">result</span>

<span class="k">class</span> <span class="nc">SharedJSONCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤/ë…¸ë“œ ê°„ ê³µìœ ë˜ëŠ” JSON ìºì‹œ (TTL ì ìš©).
    íŒŒì¼ ì ê¸ˆ ì‚¬ìš©(ê°€ëŠ¥ ì‹œ).
    êµ¬ì¡°: { job_id: {</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">RUN</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="s">: epoch_seconds}, ... }
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cache_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ttl_s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span> <span class="o">=</span> <span class="n">cache_file</span>
        <span class="n">self</span><span class="p">.</span><span class="n">ttl_s</span> <span class="o">=</span> <span class="n">ttl_s</span>
        <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">cache_file</span><span class="p">))</span>
        <span class="c1"># íŒŒì¼ ì´ˆê¸°í™”
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">cache_file</span><span class="p">):</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({},</span> <span class="n">f</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_lock</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fcntl</span><span class="p">:</span>
            <span class="n">fcntl</span><span class="p">.</span><span class="nf">flock</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">fcntl</span><span class="p">.</span><span class="n">LOCK_EX</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_unlock</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fcntl</span><span class="p">:</span>
            <span class="n">fcntl</span><span class="p">.</span><span class="nf">flock</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">fcntl</span><span class="p">.</span><span class="n">LOCK_UN</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_read</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_write</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span> <span class="o">+</span> <span class="sh">"</span><span class="s">.tmp</span><span class="sh">"</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_statuses</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">backend</span><span class="p">:</span> <span class="n">StatusBackend</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>

        <span class="c1"># 1) ì½ê¸° ì ê¸ˆ
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">r+</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">))</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({},</span> <span class="n">f</span><span class="p">)</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">r+</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_lock</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fh</span><span class="p">.</span><span class="nf">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># ìºì‹œ íˆíŠ¸/ë¯¸ìŠ¤ ê²°ì •
</span>            <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">to_query</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">entry</span> <span class="ow">and</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="nf">float</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">ttl_s</span><span class="p">):</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">to_query</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_unlock</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="n">fh</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

        <span class="c1"># 2) ë¯¸ìŠ¤ ëŒ€ìƒ ì¡°íšŒ (ì ê¸ˆ ì—†ì´)
</span>        <span class="n">fresh</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">to_query</span><span class="p">:</span>
            <span class="n">fresh</span> <span class="o">=</span> <span class="k">await</span> <span class="n">backend</span><span class="p">.</span><span class="nf">query</span><span class="p">(</span><span class="n">to_query</span><span class="p">)</span>

        <span class="c1"># 3) ì“°ê¸° ì ê¸ˆí•˜ì—¬ ë³‘í•© ë°˜ì˜
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">r+</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_lock</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fh</span><span class="p">.</span><span class="nf">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">data2</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">data2</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">updated</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">jid</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">fresh</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
                <span class="n">prev</span> <span class="o">=</span> <span class="n">data2</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">prev</span> <span class="ow">or</span> <span class="n">prev</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">)</span> <span class="o">!=</span> <span class="n">st</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ts</span> <span class="o">-</span> <span class="nf">float</span><span class="p">(</span><span class="n">prev</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">data2</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="n">st</span><span class="p">,</span> <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span><span class="p">}</span>
                    <span class="n">updated</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">updated</span><span class="p">:</span>
                <span class="n">fh</span><span class="p">.</span><span class="nf">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">fh</span><span class="p">.</span><span class="nf">truncate</span><span class="p">()</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">data2</span><span class="p">,</span> <span class="n">fh</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_unlock</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="n">fh</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

        <span class="c1"># ê²°ê´ê°’ êµ¬ì„± (fresh ìš°ì„ )
</span>        <span class="n">result</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">fresh</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

<span class="c1"># ---------- ì œì¶œ &amp; ëŒ€ê¸° ----------
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">submit_commands_multiline</span><span class="p">(</span><span class="n">commands</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    ê° ë¼ì¸ì„ ë…ë¦½ ì»¤ë§¨ë“œë¡œ ì œì¶œ. bsub ì¶œë ¥ì—ì„œ Job ID ì¶”ì¶œ.
    ë™ì‹œ ì œì¶œ ê°œìˆ˜ë¥¼ batch_sizeë¡œ ì œí•œ.
    </span><span class="sh">"""</span>
    <span class="n">sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)))</span>
    <span class="n">submissions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_submit_one</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">sem</span><span class="p">:</span>
            <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_shell</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">)</span>
            <span class="n">jids</span> <span class="o">=</span> <span class="nf">extract_job_ids_from_bsub_output</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">cmd</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">out</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">err</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">jids</span><span class="p">,</span>
            <span class="p">}</span>

    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">_submit_one</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">as_completed</span><span class="p">(</span><span class="n">tasks</span><span class="p">):</span>
        <span class="n">submissions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="k">await</span> <span class="n">t</span><span class="p">)</span>
    <span class="c1"># ì¶”ì¶œëœ Job ID í‰íƒ„í™”
</span>    <span class="n">job_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">jid</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])]</span>
    <span class="k">return</span> <span class="n">job_ids</span><span class="p">,</span> <span class="n">submissions</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">wait_until_done</span><span class="p">(</span><span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                          <span class="n">poll_interval_s</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                          <span class="n">status_cache</span><span class="p">:</span> <span class="n">SharedJSONCache</span><span class="p">,</span>
                          <span class="n">backend</span><span class="p">:</span> <span class="n">StatusBackend</span><span class="p">,</span>
                          <span class="n">max_wait_s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    ëª¨ë“  jobì´ TERMINAL_STATES(DONE/EXIT)ì— ë„ë‹¬í•  ë•Œê¹Œì§€ í´ë§.
    max_wait_s ì§€ì •ì‹œ í•´ë‹¹ ì‹œê°„ ì´ˆê³¼í•˜ë©´ ì¤‘ë‹¨.
    </span><span class="sh">"""</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    <span class="n">final</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">statuses</span> <span class="o">=</span> <span class="k">await</span> <span class="n">status_cache</span><span class="p">.</span><span class="nf">get_statuses</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">backend</span><span class="p">)</span>
        <span class="n">final</span> <span class="o">=</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="n">statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>
        <span class="c1"># ëª¨ë‘ í„°ë¯¸ë„ ìƒíƒœ?
</span>        <span class="k">if</span> <span class="nf">all</span><span class="p">((</span><span class="n">st</span> <span class="ow">in</span> <span class="n">TERMINAL_STATES</span><span class="p">)</span> <span class="ow">and</span> <span class="n">st</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">final</span><span class="p">.</span><span class="nf">values</span><span class="p">()):</span>
            <span class="k">break</span>
        <span class="c1"># íƒ€ì„ì•„ì›ƒ?
</span>        <span class="k">if</span> <span class="n">max_wait_s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_wait_s</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">poll_interval_s</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">final</span><span class="p">,</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

<span class="c1"># ---------- ComfyUI ë…¸ë“œ ----------
</span>
<span class="k">class</span> <span class="nc">LSFSubmitAndWait</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ì…ë ¥:
      - commands (STRING, multiline): ì—¬ëŸ¬ ì¤„ bsub ì»¤ë§¨ë“œ
        * ì¸ë¼ì¸ ì˜µì…˜: </span><span class="sh">'</span><span class="s"># LSF: batch_size=4 poll_interval_s=10 status_ttl_s=15
                         status_cmd_template=</span><span class="sh">"</span><span class="s">bjobs -noheader -o </span><span class="se">\"</span><span class="s">jobid stat</span><span class="se">\"</span><span class="s"> {job_ids}</span><span class="sh">"'</span><span class="s">
      - cwd (STRING): ì‹¤í–‰ ë””ë ‰í† ë¦¬

    ì¶œë ¥(OUTPUT ë…¸ë“œ):
      - job_ids (STRING): ì½¤ë§ˆ êµ¬ë¶„ ëª©ë¡
      - results_json (STRING): ìš”ì•½ JSON ë¬¸ìì—´
    </span><span class="sh">"""</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LSF</span><span class="sh">"</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span>
    <span class="n">OUTPUT_NODE</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">SUPPORTS_ASYNC</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">results_json</span><span class="sh">"</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">commands</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">bsub -q short sleep 3</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">commands</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># 0) ì¸ë¼ì¸ ì˜µì…˜/ëª…ë ¹ íŒŒì‹±
</span>        <span class="n">opts</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="nf">parse_inline_options_and_commands</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">batch_size</span><span class="sh">"</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">poll_interval_s</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">poll_interval_s</span><span class="sh">"</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">status_ttl_s</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status_ttl_s</span><span class="sh">"</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">status_cmd_template</span> <span class="o">=</span> <span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status_cmd_template</span><span class="sh">"</span><span class="p">,</span> <span class="sh">'</span><span class="s">bjobs -noheader -o </span><span class="sh">"</span><span class="s">jobid stat</span><span class="sh">"</span><span class="s"> {job_ids}</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">max_wait_s</span> <span class="o">=</span> <span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">max_wait_s</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">max_wait_s</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">max_wait_s</span><span class="p">.</span><span class="nf">isdigit</span><span class="p">():</span>
            <span class="n">max_wait_s</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">max_wait_s</span><span class="p">)</span>

        <span class="c1"># 1) ì œì¶œ
</span>        <span class="n">submitted_at</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
        <span class="n">job_ids</span><span class="p">,</span> <span class="n">submissions</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">submit_commands_multiline</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>

        <span class="c1"># 2) ìƒíƒœ ë°±ì—”ë“œ/ìºì‹œ
</span>        <span class="n">cache_dir</span> <span class="o">=</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="nf">default_cache_dir</span><span class="p">())</span>
        <span class="n">cache_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">status_cache.json</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">status_cache</span> <span class="o">=</span> <span class="nc">SharedJSONCache</span><span class="p">(</span><span class="n">cache_file</span><span class="p">,</span> <span class="n">ttl_s</span><span class="o">=</span><span class="n">status_ttl_s</span><span class="p">)</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="nc">LSFBjobsBackend</span><span class="p">(</span><span class="n">status_cmd_template</span><span class="o">=</span><span class="n">status_cmd_template</span><span class="p">)</span>

        <span class="c1"># 3) ì™„ë£Œê¹Œì§€ ëŒ€ê¸°
</span>        <span class="n">final_statuses</span><span class="p">,</span> <span class="n">waited_sec</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">wait_until_done</span><span class="p">(</span>
            <span class="n">job_ids</span><span class="p">,</span> <span class="n">poll_interval_s</span><span class="p">,</span> <span class="n">status_cache</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">max_wait_s</span><span class="o">=</span><span class="n">max_wait_s</span>
        <span class="p">)</span>

        <span class="n">completed_at</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
        <span class="n">all_done</span> <span class="o">=</span> <span class="nf">all</span><span class="p">((</span><span class="n">st</span> <span class="ow">in</span> <span class="n">TERMINAL_STATES</span><span class="p">)</span> <span class="ow">and</span> <span class="n">st</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">final_statuses</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>

        <span class="c1"># ì‹¤íŒ¨ ì œì¶œ ìˆ˜ì§‘
</span>        <span class="n">failed_submissions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span>
            <span class="k">if</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># 4) ê²°ê³¼ ìš”ì•½/ë¡œê·¸ íŒŒì¼ ì €ì¥
</span>        <span class="n">session_tag</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">utcnow</span><span class="p">().</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%Y%m%d_%H%M%S</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="sh">"</span><span class="s">_</span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="nf">getpid</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">results_dir</span> <span class="o">=</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">runs</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">results_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">results_dir</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">result_</span><span class="si">{</span><span class="n">session_tag</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">result_payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">submitted_at</span><span class="sh">"</span><span class="p">:</span> <span class="n">submitted_at</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">completed_at</span><span class="sh">"</span><span class="p">:</span> <span class="n">completed_at</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">duration_sec</span><span class="sh">"</span><span class="p">:</span> <span class="nf">round</span><span class="p">(</span><span class="n">waited_sec</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">job_ids</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">final_status</span><span class="sh">"</span><span class="p">:</span> <span class="n">final_statuses</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">all_done</span><span class="sh">"</span><span class="p">:</span> <span class="n">all_done</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">failed_submissions</span><span class="sh">"</span><span class="p">:</span> <span class="n">failed_submissions</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">:</span> <span class="n">cwd</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">options</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">batch_size</span><span class="sh">"</span><span class="p">:</span> <span class="n">batch_size</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">poll_interval_s</span><span class="sh">"</span><span class="p">:</span> <span class="n">poll_interval_s</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">status_ttl_s</span><span class="sh">"</span><span class="p">:</span> <span class="n">status_ttl_s</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">status_cmd_template</span><span class="sh">"</span><span class="p">:</span> <span class="n">status_cmd_template</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">max_wait_s</span><span class="sh">"</span><span class="p">:</span> <span class="n">max_wait_s</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">results_file</span><span class="sh">"</span><span class="p">:</span> <span class="n">results_path</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">results_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">result_payload</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># íŒŒì¼ì— ëª» ì“´ë‹¤ê³  í•´ë„ ë°˜í™˜ì€ ê³„ì†
</span>            <span class="k">pass</span>

        <span class="n">job_ids_str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>
        <span class="n">results_json_str</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result_payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">job_ids_str</span><span class="p">,</span> <span class="n">results_json_str</span><span class="p">)</span>

<span class="c1"># ComfyUI ë…¸ë“œ ë“±ë¡
</span><span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LSFSubmitAndWait</span><span class="sh">"</span><span class="p">:</span> <span class="n">LSFSubmitAndWait</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LSFSubmitAndWait</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">LSF: Submit &amp; Wait</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="ì‚¬ìš©-íŒ--ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆ">ì‚¬ìš© íŒ &amp; ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆ</h2>

<ul>
  <li>
    <p><strong>ë°°ì¹˜ í¬ê¸° ì¡°ì ˆ</strong> : ì œì¶œì´ ë„ˆë¬´ ëª°ë¦¬ë©´ íê°€ ì ê¸¸ ìˆ˜ ìˆìœ¼ë‹ˆ <code class="language-plaintext highlighter-rouge"># LSF: batch_size=4</code>ì²˜ëŸ¼ ì ì ˆíˆ ì œí•œí•˜ì„¸ìš”.</p>
  </li>
  <li>
    <p><strong>í´ë§/ìºì‹œ</strong> : <code class="language-plaintext highlighter-rouge">poll_interval_s</code>ëŠ” í´ë§ ì£¼ê¸°, <code class="language-plaintext highlighter-rouge">status_ttl_s</code>ëŠ” ìºì‹œ TTL(ì´ˆ). ì—¬ëŸ¬ ë…¸ë“œê°€ ëŒë”ë¼ë„ <code class="language-plaintext highlighter-rouge">/tmp/comfyui_lsf_cache</code>(ê¸°ë³¸) ê³µìœ  ìºì‹œë¡œ <code class="language-plaintext highlighter-rouge">bjobs</code> í˜¸ì¶œ ë¹ˆë„ë¥¼ í¬ê²Œ ì¤„ì…ë‹ˆë‹¤. ê²½ë¡œëŠ” <code class="language-plaintext highlighter-rouge">COMFYUI_LSF_CACHE_DIR</code> í™˜ê²½ë³€ìˆ˜ë¡œ ë°”ê¿€ ìˆ˜ ìˆì–´ìš”.</p>
  </li>
  <li>
    <p><strong>ìƒíƒœ ì»¤ë§¨ë“œ êµì²´</strong> : LSF ì™¸ ë‹¤ë¥¸ ì‹œìŠ¤í…œìœ¼ë¡œ ë°”ê¾¸ê³  ì‹¶ë‹¤ë©´ ì¸ë¼ì¸ì—</p>
    <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp"># LSF: status_cmd_template="bjobs -noheader -o \"jobid stat\" {job_ids}"</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>ì²˜ëŸ¼ ëª…ë ¹ í…œí”Œë¦¿ì„ ì „ë‹¬í•˜ì„¸ìš”. <code class="language-plaintext highlighter-rouge">{job_ids}</code> í”Œë ˆì´ìŠ¤í™€ë”ëŠ” ë°˜ë“œì‹œ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.<br />
(ì˜ˆì‹œ) ì»¤ìŠ¤í…€ ìŠ¤í¬ë¦½íŠ¸ë¡œ ë°”ê¿€ ë•Œ:<br />
<code class="language-plaintext highlighter-rouge"># LSF: status_cmd_template="/opt/cluster/bin/my_bjobs --format jobid,status {job_ids}"</code></p>

<ul>
  <li>
    <p><strong>íƒ€ì„ì•„ì›ƒ</strong> : ì „ì²´ ëŒ€ê¸° ì‹œê°„ ì œí•œì´ í•„ìš”í•˜ë©´ <code class="language-plaintext highlighter-rouge"># LSF: max_wait_s=7200</code> ì²˜ëŸ¼ ë„£ìœ¼ì„¸ìš”.</p>
  </li>
  <li>
    <p><strong>í„°ë¯¸ë„ ìƒíƒœ í™•ì¥</strong> : í•„ìš”í•˜ë©´ ì½”ë“œ ìƒë‹¨ì˜ <code class="language-plaintext highlighter-rouge">TERMINAL_STATES</code>ë¥¼ í¸ì§‘(ì˜ˆ: <code class="language-plaintext highlighter-rouge">{"DONE","EXIT","FINISHED"}</code>).</p>
  </li>
</ul>

<hr />

<h2 id="ì¶œë ¥-í¬ë§·-ì œì•ˆ">ì¶œë ¥ í¬ë§· ì œì•ˆ</h2>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">job_ids</code> : <code class="language-plaintext highlighter-rouge">"123,124,125"</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">results_json</code> :</p>
    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"submitted_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-10-10T00:00:00Z"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"completed_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-10-10T00:03:12Z"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"duration_sec"</span><span class="p">:</span><span class="w"> </span><span class="mf">192.4</span><span class="p">,</span><span class="w">
  </span><span class="nl">"job_ids"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"123"</span><span class="p">,</span><span class="s2">"124"</span><span class="p">,</span><span class="s2">"125"</span><span class="p">],</span><span class="w">
  </span><span class="nl">"final_status"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"123"</span><span class="p">:</span><span class="s2">"DONE"</span><span class="p">,</span><span class="nl">"124"</span><span class="p">:</span><span class="s2">"DONE"</span><span class="p">,</span><span class="nl">"125"</span><span class="p">:</span><span class="s2">"EXIT"</span><span class="p">},</span><span class="w">
  </span><span class="nl">"all_done"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
  </span><span class="nl">"failed_submissions"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
  </span><span class="nl">"cwd"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/work/exp1"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"options"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">...</span><span class="p">},</span><span class="w">
  </span><span class="nl">"results_file"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/tmp/comfyui_lsf_cache/runs/result_20251010_000000_12345.json"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
</ul>

<p>í•„ìš”í•˜ë©´ <code class="language-plaintext highlighter-rouge">status_cmd_template</code>ë¥¼ SLURM ë“±ìœ¼ë¡œ ë°”ê¾¸ëŠ” ì˜ˆì‹œë„ ì¶”ê°€ë¡œ ë“œë¦´ê²Œìš”. ì›í•˜ëŠ” ì¶”ê°€ ê¸°ëŠ¥(ì˜ˆ: ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„, ë°±ì˜¤í”„, ê°œë³„ job ë¡œê·¸ ì¶”ì ) ìˆìœ¼ë©´ ë§ë§Œ í•´ì¤˜ìš”!</p>

<p class="chat--user">

ê°œì„  ìš”ì²­: ë…¸ë“œ ìì²´ë„ asyncë¡œ ë™ì‘í•  ìˆ˜ ìˆìŒ, ì¦‰, ì´ì™€ ë™ì¼í•œ ë‹¤ë¥¸ ë…¸ë“œë“¤ì´ ìˆì„ ìˆ˜ ìˆê³  ê·¸ ë…¸ë“œë“¤ê³¼ë„ cacheë¥¼ ê³µìœ í•´ì•¼ ë”ìš± íš¨ìœ¨ì ì¼ ê²ƒ ê°™ìŒ.(bjobsí•  ë•Œ job idë¥¼ ì œí•œí•˜ë©´ ì•ˆ ë  ê²ƒ ê°™ê³ , bjobs -a ë¡œ ë´ì•¼í•  ê²ƒ ê°™ìŒ) ì´ ë•Œ ì¶”ê°€ ê³ ë ¤ ì‚¬í•­: Node1ì´ ë§Œë“  cacheë¥¼ Node2ê°€ ì°¸ê³ í•  ìˆ˜ ìˆëŠ”ë°, ì´ ë•Œ Node2ì—ì„œ ë°©ê¸ˆ bsubí•œ job idëŠ” cacheì— ì—†ì„ ìˆ˜ë„ ìˆìŒ(TTLì´ ì•ˆë¼ì„œ). ì´ ì½”ë„ˆ ì¼€ì´ìŠ¤ë„ ê³ ë ¤í•  ê²ƒ

</p>

<p>ì¢‹ì€ í¬ì¸íŠ¸! ìš”êµ¬í•˜ì‹  â€œë‹¤ì¤‘ ë…¸ë“œ ë™ì‹œ ë™ì‘ + ì „ì—­ ìºì‹œ ê³µìœ  + <code class="language-plaintext highlighter-rouge">bjobs -a</code> ê¸°ë°˜ ì „ì²´ ìŠ¤ëƒ…ìƒ·â€ìœ¼ë¡œ êµ¬ì¡°ë¥¼ ì—…ê·¸ë ˆì´ë“œí–ˆìŠµë‹ˆë‹¤. íŠ¹íˆ <strong>Node2ê°€ ë°©ê¸ˆ ì œì¶œí•œ ì¡ì´ ìºì‹œì— ì•„ì§ ì—†ì„ ìˆ˜ ìˆëŠ” ì½”ë„ˆ ì¼€ì´ìŠ¤</strong> ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´, <strong>ì œì¶œ ì§í›„ ìºì‹œì—<code class="language-plaintext highlighter-rouge">SUBMITTED</code> ìƒíƒœë¡œ ì‹œë“œ(seeding)</strong> í•˜ê³ , ìƒíƒœ ìºì‹œëŠ” <strong>â€˜ì „ì²´ ëª©ë¡â€™(bjobs -a) ìŠ¤ëƒ…ìƒ·</strong> ì„ TTL/ë½ ê¸°ë°˜ìœ¼ë¡œ ê°±ì‹ í•˜ë„ë¡ ë°”ê¿¨ìŠµë‹ˆë‹¤.</p>

<p>ì•„ë˜ëŠ” ë³€ê²½ ìš”ì•½ â†’ ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” ì „ì²´ ì½”ë“œ ìˆœì„œë¡œ ë“œë¦½ë‹ˆë‹¤.</p>

<hr />

<h1 id="ë³€ê²½ì„¤ê³„-í¬ì¸íŠ¸-step-by-step">ë³€ê²½/ì„¤ê³„ í¬ì¸íŠ¸ (step-by-step)</h1>

<ol>
  <li>
    <p><strong>í´ë§ ë°±ì—”ë“œ ì „ë©´ ê°œí¸</strong></p>

    <ul>
      <li>
        <p>ê¸°ì¡´: <code class="language-plaintext highlighter-rouge">bjobs {job_ids}</code> íŠ¹ì • ì¡ë§Œ ì¡°íšŒ</p>
      </li>
      <li>
        <p>ë³€ê²½: <strong>ê¸°ë³¸ê°’ì„<code class="language-plaintext highlighter-rouge">bjobs -a -noheader -o "jobid stat"</code>ë¡œ ì „ì²´ ì¡°íšŒ</strong>â†’ í•œ ë²ˆì˜ í˜¸ì¶œë¡œ ëª¨ë“  ì¡ ìƒíƒœë¥¼ ë°›ì•„ ì „ì—­ ìºì‹œì— ì €ì¥.</p>
      </li>
      <li>
        <p>í…œí”Œë¦¿ì€ <code class="language-plaintext highlighter-rouge">full_status_cmd_template</code>ë¡œ êµì²´(ì—¬ì „íˆ ì˜µì…˜ìœ¼ë¡œ ë°”ê¿€ ìˆ˜ ìˆìŒ).</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ì „ì—­ ê³µìœ  ìºì‹œ(íŒŒì¼) êµ¬ì¡° ê°œì„ </strong></p>

    <ul>
      <li>ë‹¨ì¼ íŒŒì¼ì— ì „ì²´ ìŠ¤ëƒ…ìƒ· ë³´ê´€:
        <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"jobs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"123"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"status"</span><span class="p">:</span><span class="s2">"PEND"</span><span class="p">,</span><span class="nl">"ts"</span><span class="p">:</span><span class="mi">169</span><span class="err">...</span><span class="p">},</span><span class="w"> </span><span class="err">...</span><span class="w"> </span><span class="p">},</span><span class="w">
  </span><span class="nl">"last_full_refresh_ts"</span><span class="p">:</span><span class="w"> </span><span class="mi">169</span><span class="err">...</span><span class="p">,</span><span class="w">
  </span><span class="nl">"meta"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">...</span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>        </div>
      </li>
      <li>
        <p><strong>TTL(<code class="language-plaintext highlighter-rouge">full_ttl_s</code>)</strong> + <strong>ìµœì†Œ ë¦¬í”„ë ˆì‹œ ê°„ê²©(<code class="language-plaintext highlighter-rouge">min_refresh_gap_s</code>)</strong> + <strong>ë½ íŒŒì¼(ê°€ëŠ¥ ì‹œ fcntl)</strong> ë¡œ <strong>-a í˜¸ì¶œ í­ì£¼ ë°©ì§€</strong>.</p>
      </li>
      <li>ë‹¤ì¤‘ ë…¸ë“œê°€ ë™ì‹œì— ì ‘ê·¼í•´ë„ <strong>ì½ê¸°/ì“°ê¸° ì ê¸ˆ</strong> ì ìš©.</li>
    </ul>
  </li>
  <li>
    <p><strong>ì½”ë„ˆ ì¼€ì´ìŠ¤ ì²˜ë¦¬(ë°©ê¸ˆ ì œì¶œí•œ ì¡ ë¯¸ë°˜ì˜)</strong></p>

    <ul>
      <li>
        <p><strong>ì œì¶œ ì§í›„</strong> í•´ë‹¹ ì¡ë“¤ì„ <strong>ìºì‹œì— â€˜SUBMITTEDâ€™</strong> ìƒíƒœë¡œ <strong>ì‹œë“œ(seeding)</strong> â†’ ë‹¤ë¥¸ ë…¸ë“œë„ ì¦‰ì‹œ ì´ JobIDë¥¼ â€œì•Œê³ â€ ìˆì–´ì„œ ë¶ˆí•„ìš”í•œ ê°•ì œ ë¦¬í”„ë ˆì‹œê°€ ì¤„ì–´ë“¦.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">get_statuses()</code>ì—ì„œ <strong>ìš”ì²­í•œ JobIDê°€ ìºì‹œì— ì—†ê±°ë‚˜ ì˜¤ë˜ë˜ë©´</strong> ,</p>

        <ul>
          <li>
            <p>TTL ë§Œë£Œì´ê±°ë‚˜ <code class="language-plaintext highlighter-rouge">force_refresh_on_miss=True</code>ì´ê³  <code class="language-plaintext highlighter-rouge">min_refresh_gap_s</code> ì´ìƒ ê²½ê³¼ ì‹œ <strong>í•œ ë…¸ë“œë§Œ</strong> <code class="language-plaintext highlighter-rouge">-a</code>ë¥¼ ì‹¤í–‰í•´ <strong>ìƒˆ ìŠ¤ëƒ…ìƒ·</strong> ì‘ì„±(ë½ìœ¼ë¡œ ë‹¨ì¼í™”).</p>
          </li>
          <li>
            <p>ê·¸ ì™¸ì—ëŠ” ë‹¤ìŒ í´ë§ ì£¼ê¸°ì— ìì—°ìŠ¤ëŸ½ê²Œ ë°˜ì˜.</p>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ì™„ì „í•œ async ì§€ì› + ë‹¤ì¤‘ ì œì¶œ ì œì–´</strong></p>

    <ul>
      <li>
        <p>ë…¸ë“œ ìì²´ëŠ” <code class="language-plaintext highlighter-rouge">SUPPORTS_ASYNC = True</code>, ë¹„ë™ê¸° ì œì¶œ/ëŒ€ê¸°.</p>
      </li>
      <li>
        <p>ë©€í‹°ë¼ì¸ <code class="language-plaintext highlighter-rouge">bsub</code>ë¥¼ <strong>ë°°ì¹˜ í¬ê¸° ì œí•œ(<code class="language-plaintext highlighter-rouge">batch_size</code>)</strong>ìœ¼ë¡œ ë³‘ë ¬ ì œì¶œ.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ì¶œë ¥/ë¡œê·¸</strong></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">job_ids</code>(ì½¤ë§ˆ ë¬¸ìì—´), <code class="language-plaintext highlighter-rouge">results_json</code>(ìš”ì•½ JSON).</p>
      </li>
      <li>
        <p>ì‹¤í–‰ ê²°ê³¼ëŠ” <code class="language-plaintext highlighter-rouge">/tmp/comfyui_lsf_cache/runs/result_*.json</code>ì—ë„ ì €ì¥.</p>
      </li>
    </ul>
  </li>
</ol>

<hr />

<h1 id="ì½”ë“œ-êµì²´ì¶”ê°€-ì—†ì´-ê·¸ëŒ€ë¡œ-ì‚¬ìš©">ì½”ë“œ (êµì²´/ì¶”ê°€ ì—†ì´ ê·¸ëŒ€ë¡œ ì‚¬ìš©)</h1>

<p><code class="language-plaintext highlighter-rouge">ComfyUI/custom_nodes/lsf_submit_and_wait.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">shlex</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># fcntl (POSIX) ì ê¸ˆ: Windowsì—ì„  graceful degrade
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">fcntl</span>  <span class="c1"># type: ignore
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">fcntl</span> <span class="o">=</span> <span class="bp">None</span>

<span class="c1"># ---------- ìƒìˆ˜/ìœ í‹¸ ----------
</span>
<span class="n">JOB_ID_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
<span class="n">TERMINAL_STATES</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">DONE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">EXIT</span><span class="sh">"</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">iso_now</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">utcnow</span><span class="p">().</span><span class="nf">isoformat</span><span class="p">(</span><span class="n">timespec</span><span class="o">=</span><span class="sh">"</span><span class="s">seconds</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">Z</span><span class="sh">"</span>

<span class="k">def</span> <span class="nf">default_cache_dir</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">COMFYUI_LSF_CACHE_DIR</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">tempfile</span><span class="p">.</span><span class="nf">gettempdir</span><span class="p">(),</span> <span class="sh">"</span><span class="s">comfyui_lsf_cache</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d</span>

<span class="k">def</span> <span class="nf">parse_inline_options_and_commands</span><span class="p">(</span><span class="n">commands_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    ì²« ì¤„(ë“¤)ì— </span><span class="sh">'</span><span class="s"># LSF: key=value key=value ...</span><span class="sh">'</span><span class="s"> í˜•ì‹ì˜ ì¸ë¼ì¸ ì˜µì…˜ì„ í—ˆìš©.
    ë°˜í™˜: (options_dict, command_lines)
    </span><span class="sh">"""</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">ln</span> <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">commands_text</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">()]</span>
    <span class="n">clean_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">^\s*#\s*LSF:\s*(.+)$</span><span class="sh">"</span><span class="p">,</span> <span class="n">ln</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">kvs</span> <span class="o">=</span> <span class="n">shlex</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">posix</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">kv</span> <span class="ow">in</span> <span class="n">kvs</span><span class="p">:</span>
                <span class="k">if</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">kv</span><span class="p">:</span>
                    <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">kv</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span><span class="p">.</span><span class="nf">isdigit</span><span class="p">():</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">false</span><span class="sh">"</span><span class="p">):</span>
                            <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="o">==</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span>
                    <span class="n">options</span><span class="p">[</span><span class="n">k</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">continue</span>
        <span class="n">clean_lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">ln</span><span class="p">)</span>
    <span class="n">clean_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">ln</span> <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">clean_lines</span> <span class="k">if</span> <span class="n">ln</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span>
    <span class="k">return</span> <span class="n">options</span><span class="p">,</span> <span class="n">clean_lines</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_shell</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_shell</span><span class="p">(</span>
        <span class="n">cmd</span><span class="p">,</span>
        <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span> <span class="k">if</span> <span class="n">cwd</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">ignore</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">ignore</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">extract_job_ids_from_bsub_output</span><span class="p">(</span><span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="c1"># LSF í‘œì¤€: "Job &lt;12345&gt; is submitted to queue &lt;...&gt;."
</span>    <span class="k">return</span> <span class="n">JOB_ID_REGEX</span><span class="p">.</span><span class="nf">findall</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>

<span class="c1"># ---------- ìƒíƒœ ë°±ì—”ë“œ (ì „ì²´ ìŠ¤ëƒ…ìƒ·) ----------
</span>
<span class="k">class</span> <span class="nc">StatusBackend</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">query_full</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="nb">NotImplementedError</span>

<span class="k">class</span> <span class="nc">LSFBjobsFullBackend</span><span class="p">(</span><span class="n">StatusBackend</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    ì „ì²´ ìŠ¤ëƒ…ìƒ· ê¸°ë°˜ ë°±ì—”ë“œ.
    full_status_cmd_template ê¸°ë³¸ê°’:
      </span><span class="sh">'</span><span class="s">bjobs -a -noheader -o </span><span class="sh">"</span><span class="s">jobid stat</span><span class="sh">"'</span><span class="s">
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">full_status_cmd_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">full_status_cmd_template</span><span class="p">:</span>
            <span class="n">full_status_cmd_template</span> <span class="o">=</span> <span class="sh">'</span><span class="s">bjobs -a -noheader -o </span><span class="sh">"</span><span class="s">jobid stat</span><span class="sh">"'</span>
        <span class="n">self</span><span class="p">.</span><span class="n">template</span> <span class="o">=</span> <span class="n">full_status_cmd_template</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">query_full</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_shell</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">template</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># ê¸°ëŒ€ í¬ë§·: "&lt;jobid&gt; &lt;state&gt;"
</span>        <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">out</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">ln</span> <span class="o">=</span> <span class="n">ln</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ln</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">ln</span><span class="p">.</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">parts</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">upper</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>
        <span class="k">return</span> <span class="n">result</span>

<span class="c1"># ---------- ì „ì—­ ê³µìœ  ìºì‹œ (ì „ì²´ ëª©ë¡ + TTL + ë½) ----------
</span>
<span class="k">class</span> <span class="nc">FullListSharedCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    íŒŒì¼ í•˜ë‚˜ì— ì „ì²´ job ìƒíƒœ ìŠ¤ëƒ…ìƒ·ì„ ì €ì¥/ê³µìœ .
    êµ¬ì¡°:
    {
      </span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="s">: { job_id: {</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="s">: epoch}, ... },
      </span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="s">: epoch,
      </span><span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="s">: { </span><span class="sh">"</span><span class="s">source</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, ... }
    }
    ì •ì±…:
      - full_ttl_s: ì „ì²´ ìŠ¤ëƒ…ìƒ· TTL
      - min_refresh_gap_s: -a ì¬ì‹¤í–‰ ìµœì†Œ ê°„ê²©
      - force_refresh_on_miss: í•„ìš”í•œ job_idê°€ ì—†ìœ¼ë©´ TTL ë¬´ì‹œí•˜ê³ (ë‹¨ ìµœì†Œ ê°„ê²©ì€ ì¡´ì¤‘) ì¡°ê¸° ê°±ì‹  ì‹œë„
      - SUBMITTED ì‹œë“œ: ì œì¶œ ì§í›„ ìºì‹œì— ë„£ì–´ ì½”ë„ˆ ì¼€ì´ìŠ¤ ì™„í™”
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cache_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">full_ttl_s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                 <span class="n">min_refresh_gap_s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                 <span class="n">force_refresh_on_miss</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span> <span class="o">=</span> <span class="n">cache_file</span>
        <span class="n">self</span><span class="p">.</span><span class="n">full_ttl_s</span> <span class="o">=</span> <span class="n">full_ttl_s</span>
        <span class="n">self</span><span class="p">.</span><span class="n">min_refresh_gap_s</span> <span class="o">=</span> <span class="n">min_refresh_gap_s</span>
        <span class="n">self</span><span class="p">.</span><span class="n">force_refresh_on_miss</span> <span class="o">=</span> <span class="n">force_refresh_on_miss</span>
        <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">cache_file</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">cache_file</span><span class="p">):</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span> <span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="n">f</span><span class="p">)</span>

    <span class="c1"># ---- ë½ ìœ í‹¸ ----
</span>    <span class="k">def</span> <span class="nf">_lock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">nonblock</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">a+</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fcntl</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fcntl</span><span class="p">.</span><span class="nf">flock</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">fcntl</span><span class="p">.</span><span class="n">LOCK_EX</span> <span class="o">|</span> <span class="p">(</span><span class="n">fcntl</span><span class="p">.</span><span class="n">LOCK_NB</span> <span class="k">if</span> <span class="n">nonblock</span> <span class="k">else</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">except</span> <span class="nb">BlockingIOError</span><span class="p">:</span>
                <span class="n">fh</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
                <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">fh</span>

    <span class="k">def</span> <span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fcntl</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fcntl</span><span class="p">.</span><span class="nf">flock</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">fcntl</span><span class="p">.</span><span class="n">LOCK_UN</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fh</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_read_cache</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span> <span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="k">def</span> <span class="nf">_write_cache</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span> <span class="o">+</span> <span class="sh">"</span><span class="s">.tmp</span><span class="sh">"</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">)</span>

    <span class="c1"># ---- ê³µê°œ API ----
</span>    <span class="k">def</span> <span class="nf">seed_submitted</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="sh">"""</span><span class="s">ì œì¶œ ì§í›„ SUBMITTED ìƒíƒœë¡œ ìºì‹œì— ì‹œë“œ(ì½”ë„ˆ ì¼€ì´ìŠ¤ ì™„í™”).</span><span class="sh">"""</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="c1"># ì“°ê¸° ë½
</span>        <span class="n">fh</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_lock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                <span class="c1"># ì´ë¯¸ ìˆìœ¼ë©´ ê±´ë“œë¦¬ì§€ ì•ŠìŒ(ê²½ìŸ ìƒíƒœì—ì„œ ë” ìµœì‹  ê°’ ë³´í˜¸)
</span>                <span class="k">if</span> <span class="n">jid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
                    <span class="n">jobs</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">SUBMITTED</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">now</span><span class="p">}</span>
            <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobs</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_write_cache</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">maybe_refresh_full</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">backend</span><span class="p">:</span> <span class="n">StatusBackend</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        - TTL ë˜ëŠ” miss ì‚¬ìœ ë¡œ ì „ì²´ ìŠ¤ëƒ…ìƒ·ì„ ê°±ì‹ í• ì§€ íŒë‹¨/ì‹¤í–‰
        - ë™ì‹œì„±: refresh ë½ íŒŒì¼ì„ non-blockingìœ¼ë¡œ íšë“í•œ ë‹¨ í•˜ë‚˜ì˜ í”„ë¡œì„¸ìŠ¤ë§Œ ì‹¤ì œë¡œ -a ì‹¤í–‰
        </span><span class="sh">"""</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
        <span class="n">last_ts</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="c1"># ìµœì†Œ ê°„ê²© ì²´í¬
</span>        <span class="nf">if </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_ts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nf">float</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">min_refresh_gap_s</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c1"># refresh ë½(ë³„ë„ íŒŒì¼) íšë“ ì‹œë„(ì‹¤íŒ¨í•˜ë©´ ë‹¤ë¥¸ ë…¸ë“œê°€ ìˆ˜í–‰ ì¤‘)
</span>        <span class="n">lock_path</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span> <span class="o">+</span> <span class="sh">"</span><span class="s">.refresh.lock</span><span class="sh">"</span>
        <span class="n">lock_fh</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_lock_fd</span><span class="p">(</span><span class="n">lock_path</span><span class="p">,</span> <span class="n">nonblock</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lock_fh</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># í•œ ë²ˆ ë” ìµœì‹ í™” ê²€ì‚¬(ê²½ìŸ íšŒí”¼)
</span>            <span class="n">data2</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
            <span class="n">last_ts2</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data2</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="nf">if </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_ts2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nf">float</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">min_refresh_gap_s</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="c1"># ì‹¤ì œ -a ì‹¤í–‰
</span>            <span class="n">snapshot</span> <span class="o">=</span> <span class="k">await</span> <span class="n">backend</span><span class="p">.</span><span class="nf">query_full</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">snapshot</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>  <span class="c1"># ì‹¤íŒ¨ ì‹œ ê·¸ëŒ€ë¡œ ìœ ì§€
</span>
            <span class="n">now2</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="c1"># ì“°ê¸° ë½(ìºì‹œ íŒŒì¼)
</span>            <span class="n">fh</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_lock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="c1"># ìƒˆ ìŠ¤ëƒ…ìƒ· ë°˜ì˜
</span>                <span class="n">ts</span> <span class="o">=</span> <span class="n">now2</span>
                <span class="k">for</span> <span class="n">jid</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">snapshot</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
                    <span class="n">jobs</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="n">st</span><span class="p">,</span> <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span><span class="p">}</span>
                <span class="n">base</span><span class="p">[</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobs</span>
                <span class="n">base</span><span class="p">[</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">now2</span>
                <span class="n">meta</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">meta</span><span class="p">[</span><span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">reason</span>
                <span class="n">meta</span><span class="p">[</span><span class="sh">"</span><span class="s">refreshed_at</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
                <span class="n">base</span><span class="p">[</span><span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_write_cache</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">lock_fh</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_statuses</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">backend</span><span class="p">:</span> <span class="n">StatusBackend</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        - ìºì‹œì—ì„œ ë¨¼ì € ì¡°íšŒ
        - í•„ìš” ì‹œ maybe_refresh_full()ì„ í†µí•´ -a ìŠ¤ëƒ…ìƒ· ê°±ì‹ 
        - ìµœì¢…ì ìœ¼ë¡œ ìš”ì²­ job_idsì— ëŒ€í•œ ìƒíƒœ dict ë°˜í™˜(ì—†ìœ¼ë©´ </span><span class="sh">""</span><span class="s">)
        </span><span class="sh">"""</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">last_ts</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">_fresh</span><span class="p">(</span><span class="n">jid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">ent</span> <span class="o">=</span> <span class="n">jobs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ent</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="c1"># ì—”íŠ¸ë¦¬ê°€ SUBMITTED ë¼ë„ 'ì‹ ì„ í•œ' ê²ƒìœ¼ë¡œ ì·¨ê¸‰(ë°”ë¡œ ì§ì „ ì œì¶œ ì¼€ì´ìŠ¤ ì™„í™”)
</span>            <span class="n">age</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="nf">float</span><span class="p">(</span><span class="n">ent</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">age</span> <span class="o">&lt;=</span> <span class="nf">float</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">full_ttl_s</span><span class="p">)</span>

        <span class="n">need_refresh</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1"># 1) TTL ë§Œë£Œ ë˜ëŠ” miss ì—¬ë¶€ íŒë‹¨
</span>        <span class="nf">if </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_ts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nf">float</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">full_ttl_s</span><span class="p">):</span>
            <span class="n">need_refresh</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c1"># miss ê²€ì‚¬: ìš”ì²­í•œ jobì´ ìºì‹œì— ì—†ê±°ë‚˜ stale
</span>        <span class="n">miss</span> <span class="o">=</span> <span class="p">[</span><span class="n">jid</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span> <span class="k">if</span> <span class="ow">not</span> <span class="nf">_fresh</span><span class="p">(</span><span class="n">jid</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">miss</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">force_refresh_on_miss</span><span class="p">:</span>
            <span class="n">need_refresh</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c1"># 2) í•„ìš” ì‹œ ì „ì²´ ë¦¬í”„ë ˆì‹œ ì‹œë„(í•œ í”„ë¡œì„¸ìŠ¤ë§Œ ì‹¤í–‰)
</span>        <span class="k">if</span> <span class="n">need_refresh</span><span class="p">:</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="sh">"</span><span class="s">ttl_expired</span><span class="sh">"</span> <span class="nf">if </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_ts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nf">float</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">full_ttl_s</span><span class="p">)</span> <span class="k">else</span> <span class="sh">"</span><span class="s">miss</span><span class="sh">"</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">maybe_refresh_full</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="n">reason</span><span class="p">)</span>
            <span class="c1"># ê°±ì‹  í›„ ìµœì‹  ë°ì´í„° ì¬ë¡œë”©
</span>            <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># 3) ê²°ê³¼ êµ¬ì„±
</span>        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">ent</span> <span class="o">=</span> <span class="n">jobs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ent</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="k">if</span> <span class="n">ent</span> <span class="k">else</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="c1"># ---------- ì œì¶œ &amp; ëŒ€ê¸° ----------
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">submit_commands_multiline</span><span class="p">(</span><span class="n">commands</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    ê° ë¼ì¸ì„ ë…ë¦½ ì»¤ë§¨ë“œë¡œ ì œì¶œ. bsub ì¶œë ¥ì—ì„œ Job ID ì¶”ì¶œ.
    ë™ì‹œ ì œì¶œ ê°œìˆ˜ë¥¼ batch_sizeë¡œ ì œí•œ.
    </span><span class="sh">"""</span>
    <span class="n">sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)))</span>
    <span class="n">submissions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_submit_one</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">sem</span><span class="p">:</span>
            <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_shell</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">)</span>
            <span class="n">jids</span> <span class="o">=</span> <span class="nf">extract_job_ids_from_bsub_output</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">cmd</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">out</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">err</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">jids</span><span class="p">,</span>
            <span class="p">}</span>

    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">_submit_one</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">as_completed</span><span class="p">(</span><span class="n">tasks</span><span class="p">):</span>
        <span class="n">submissions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="k">await</span> <span class="n">t</span><span class="p">)</span>
    <span class="n">job_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">jid</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])]</span>
    <span class="k">return</span> <span class="n">job_ids</span><span class="p">,</span> <span class="n">submissions</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">wait_until_done</span><span class="p">(</span><span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                          <span class="n">poll_interval_s</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                          <span class="n">full_cache</span><span class="p">:</span> <span class="n">FullListSharedCache</span><span class="p">,</span>
                          <span class="n">backend</span><span class="p">:</span> <span class="n">StatusBackend</span><span class="p">,</span>
                          <span class="n">max_wait_s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    <span class="n">final</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">statuses</span> <span class="o">=</span> <span class="k">await</span> <span class="n">full_cache</span><span class="p">.</span><span class="nf">get_statuses</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">backend</span><span class="p">)</span>
        <span class="n">final</span> <span class="o">=</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="n">statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>
        <span class="k">if</span> <span class="nf">all</span><span class="p">((</span><span class="n">st</span> <span class="ow">in</span> <span class="n">TERMINAL_STATES</span><span class="p">)</span> <span class="ow">and</span> <span class="n">st</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">final</span><span class="p">.</span><span class="nf">values</span><span class="p">()):</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">max_wait_s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_wait_s</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">poll_interval_s</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">final</span><span class="p">,</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

<span class="c1"># ---------- ComfyUI ë…¸ë“œ ----------
</span>
<span class="k">class</span> <span class="nc">LSFSubmitAndWait</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ì…ë ¥:
      - commands (STRING, multiline): ì—¬ëŸ¬ ì¤„ bsub ì»¤ë§¨ë“œ
        * ì¸ë¼ì¸ ì˜µì…˜: </span><span class="sh">'</span><span class="s"># LSF: batch_size=4 poll_interval_s=10 full_ttl_s=15
                         full_status_cmd_template=</span><span class="sh">"</span><span class="s">bjobs -a -noheader -o </span><span class="se">\"</span><span class="s">jobid stat</span><span class="se">\"</span><span class="sh">"</span><span class="s">
                         min_refresh_gap_s=5 force_refresh_on_miss=true max_wait_s=7200</span><span class="sh">'</span><span class="s">
      - cwd (STRING): ì‹¤í–‰ ë””ë ‰í† ë¦¬

    ì¶œë ¥(OUTPUT ë…¸ë“œ):
      - job_ids (STRING): ì½¤ë§ˆ êµ¬ë¶„ ëª©ë¡
      - results_json (STRING): ìš”ì•½ JSON ë¬¸ìì—´
    </span><span class="sh">"""</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LSF</span><span class="sh">"</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span>
    <span class="n">OUTPUT_NODE</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">SUPPORTS_ASYNC</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">results_json</span><span class="sh">"</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">commands</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">bsub -q short sleep 3</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">commands</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># 0) ì¸ë¼ì¸ ì˜µì…˜/ëª…ë ¹ íŒŒì‹±
</span>        <span class="n">opts</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="nf">parse_inline_options_and_commands</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">batch_size</span><span class="sh">"</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">poll_interval_s</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">poll_interval_s</span><span class="sh">"</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="c1"># backward compat: status_ttl_s -&gt; full_ttl_s
</span>        <span class="n">full_ttl_s</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">full_ttl_s</span><span class="sh">"</span><span class="p">,</span> <span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status_ttl_s</span><span class="sh">"</span><span class="p">,</span> <span class="mi">10</span><span class="p">)))</span>
        <span class="n">min_refresh_gap_s</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">min_refresh_gap_s</span><span class="sh">"</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="n">force_refresh_on_miss</span> <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">force_refresh_on_miss</span><span class="sh">"</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span>
        <span class="n">full_status_cmd_template</span> <span class="o">=</span> <span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">full_status_cmd_template</span><span class="sh">"</span><span class="p">,</span>
                                            <span class="sh">'</span><span class="s">bjobs -a -noheader -o </span><span class="sh">"</span><span class="s">jobid stat</span><span class="sh">"'</span><span class="p">)</span>
        <span class="n">max_wait_s</span> <span class="o">=</span> <span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">max_wait_s</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">max_wait_s</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">max_wait_s</span><span class="p">.</span><span class="nf">isdigit</span><span class="p">():</span>
            <span class="n">max_wait_s</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">max_wait_s</span><span class="p">)</span>

        <span class="c1"># 1) ì œì¶œ
</span>        <span class="n">submitted_at</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
        <span class="n">job_ids</span><span class="p">,</span> <span class="n">submissions</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">submit_commands_multiline</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>

        <span class="c1"># 2) ì „ì—­ ìºì‹œ/ë°±ì—”ë“œ
</span>        <span class="n">cache_dir</span> <span class="o">=</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="nf">default_cache_dir</span><span class="p">())</span>
        <span class="n">cache_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">status_full_cache.json</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">full_cache</span> <span class="o">=</span> <span class="nc">FullListSharedCache</span><span class="p">(</span>
            <span class="n">cache_file</span><span class="p">,</span>
            <span class="n">full_ttl_s</span><span class="o">=</span><span class="n">full_ttl_s</span><span class="p">,</span>
            <span class="n">min_refresh_gap_s</span><span class="o">=</span><span class="n">min_refresh_gap_s</span><span class="p">,</span>
            <span class="n">force_refresh_on_miss</span><span class="o">=</span><span class="n">force_refresh_on_miss</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="nc">LSFBjobsFullBackend</span><span class="p">(</span><span class="n">full_status_cmd_template</span><span class="o">=</span><span class="n">full_status_cmd_template</span><span class="p">)</span>

        <span class="c1"># 2-1) ì½”ë„ˆ ì¼€ì´ìŠ¤ ì™„í™”: ë°©ê¸ˆ ì œì¶œí•œ ì¡ì„ ìºì‹œì— ì‹œë“œ
</span>        <span class="k">if</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">full_cache</span><span class="p">.</span><span class="nf">seed_submitted</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>

        <span class="c1"># 3) ì™„ë£Œê¹Œì§€ ëŒ€ê¸°
</span>        <span class="n">final_statuses</span><span class="p">,</span> <span class="n">waited_sec</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">wait_until_done</span><span class="p">(</span>
            <span class="n">job_ids</span><span class="p">,</span> <span class="n">poll_interval_s</span><span class="p">,</span> <span class="n">full_cache</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">max_wait_s</span><span class="o">=</span><span class="n">max_wait_s</span>
        <span class="p">)</span>

        <span class="n">completed_at</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
        <span class="n">all_done</span> <span class="o">=</span> <span class="nf">all</span><span class="p">((</span><span class="n">st</span> <span class="ow">in</span> <span class="n">TERMINAL_STATES</span><span class="p">)</span> <span class="ow">and</span> <span class="n">st</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">final_statuses</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>

        <span class="n">failed_submissions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span>
            <span class="k">if</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># 4) ê²°ê³¼ íŒŒì¼ ì €ì¥
</span>        <span class="n">session_tag</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">utcnow</span><span class="p">().</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%Y%m%d_%H%M%S</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="sh">"</span><span class="s">_</span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="nf">getpid</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">results_dir</span> <span class="o">=</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">runs</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">results_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">results_dir</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">result_</span><span class="si">{</span><span class="n">session_tag</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">result_payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">submitted_at</span><span class="sh">"</span><span class="p">:</span> <span class="n">submitted_at</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">completed_at</span><span class="sh">"</span><span class="p">:</span> <span class="n">completed_at</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">duration_sec</span><span class="sh">"</span><span class="p">:</span> <span class="nf">round</span><span class="p">(</span><span class="n">waited_sec</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">job_ids</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">final_status</span><span class="sh">"</span><span class="p">:</span> <span class="n">final_statuses</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">all_done</span><span class="sh">"</span><span class="p">:</span> <span class="n">all_done</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">failed_submissions</span><span class="sh">"</span><span class="p">:</span> <span class="n">failed_submissions</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">:</span> <span class="n">cwd</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">options</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">batch_size</span><span class="sh">"</span><span class="p">:</span> <span class="n">batch_size</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">poll_interval_s</span><span class="sh">"</span><span class="p">:</span> <span class="n">poll_interval_s</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">full_ttl_s</span><span class="sh">"</span><span class="p">:</span> <span class="n">full_ttl_s</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">min_refresh_gap_s</span><span class="sh">"</span><span class="p">:</span> <span class="n">min_refresh_gap_s</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">force_refresh_on_miss</span><span class="sh">"</span><span class="p">:</span> <span class="n">force_refresh_on_miss</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">full_status_cmd_template</span><span class="sh">"</span><span class="p">:</span> <span class="n">full_status_cmd_template</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">max_wait_s</span><span class="sh">"</span><span class="p">:</span> <span class="n">max_wait_s</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">results_file</span><span class="sh">"</span><span class="p">:</span> <span class="n">results_path</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">results_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">result_payload</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">job_ids_str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>
        <span class="n">results_json_str</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result_payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">job_ids_str</span><span class="p">,</span> <span class="n">results_json_str</span><span class="p">)</span>

<span class="c1"># ComfyUI ë…¸ë“œ ë“±ë¡
</span><span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LSFSubmitAndWait</span><span class="sh">"</span><span class="p">:</span> <span class="n">LSFSubmitAndWait</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LSFSubmitAndWait</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">LSF: Submit &amp; Wait</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="ì‚¬ìš©-ë°©ë²•ì˜µì…˜-ì˜ˆì‹œ">ì‚¬ìš© ë°©ë²•/ì˜µì…˜ ì˜ˆì‹œ</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vbnet

# LSF: batch_size=4 poll_interval_s=10 full_ttl_s=15 min_refresh_gap_s=5 force_refresh_on_miss=true
# LSF: full_status_cmd_template="bjobs -a -noheader -o \"jobid stat\""
bsub -q short -J test1 sleep 5
bsub -q short -J test2 sleep 8
bsub -q short -J test3 sleep 2
</code></pre></div></div>

<ul>
  <li>
    <p><strong>full_ttl_s</strong> : ì „ì²´ ìŠ¤ëƒ…ìƒ·ì˜ TTL.</p>
  </li>
  <li>
    <p><strong>min_refresh_gap_s</strong> : <code class="language-plaintext highlighter-rouge">-a</code> ì¬í˜¸ì¶œ ìµœì†Œ ê°„ê²©(ëª¨ë“  ë…¸ë“œ ê³µí†µ).</p>
  </li>
  <li>
    <p><strong>force_refresh_on_miss</strong> : ìš”ì²­ Jobì´ ìºì‹œì— ì—†ì„ ë•Œ TTL ê´€ê³„ì—†ì´ ì¡°ê¸° ê°±ì‹  ì‹œë„(ë‹¨ ìµœì†Œ ê°„ê²©ì€ ì§€í‚´).</p>
  </li>
  <li>
    <p><strong>full_status_cmd_template</strong> : ë‹¤ë¥¸ ì‹œìŠ¤í…œ/í˜•ì‹ìœ¼ë¡œ êµì²´ ê°€ëŠ¥(ì˜ˆ: ì»¤ìŠ¤í…€ ìŠ¤í¬ë¦½íŠ¸).</p>
  </li>
</ul>

<hr />

<h2 id="ì½”ë„ˆ-ì¼€ì´ìŠ¤ê°€-í•´ê²°ë˜ëŠ”-íë¦„ìš”ì•½">ì½”ë„ˆ ì¼€ì´ìŠ¤ê°€ í•´ê²°ë˜ëŠ” íë¦„(ìš”ì•½)</h2>

<ol>
  <li>
    <p>Node1Â·Node2ê°€ ê°ê° ì¡ ì œì¶œ â†’ <strong>ê°ì ì œì¶œ ì§í›„ ìºì‹œì— SUBMITTEDë¡œ ì‹œë“œ</strong>.</p>
  </li>
  <li>
    <p>í´ë§ ì‹œ, <strong>ìš”ì²­í•œ JobIDê°€ ìºì‹œì— ì´ë¯¸ ì¡´ì¬</strong> â†’ <code class="language-plaintext highlighter-rouge">SUBMITTED</code>ë¼ë„ <strong>ì‹ ì„ </strong> ìœ¼ë¡œ ê°„ì£¼ë˜ì–´ ë¶ˆí•„ìš”í•œ ì¡°ê¸° <code class="language-plaintext highlighter-rouge">-a</code> í˜¸ì¶œ ë°©ì§€.</p>
  </li>
  <li>
    <p>TTL ë§Œë£Œ ë˜ëŠ” miss+ìµœì†Œ ê°„ê²© ì¶©ì¡± ì‹œ, <strong>í•œ ë…¸ë“œë§Œ</strong> <code class="language-plaintext highlighter-rouge">-a</code> ì‹¤í–‰(ë½) â†’ ì „ì²´ ìŠ¤ëƒ…ìƒ· ì—…ë°ì´íŠ¸.</p>
  </li>
  <li>
    <p>ëª¨ë“  ë…¸ë“œëŠ” <strong>ê°™ì€ ìºì‹œ íŒŒì¼</strong> ì„ ë³´ë©° íš¨ìœ¨ì ìœ¼ë¡œ ìƒíƒœ ë™ê¸°í™”.</p>
  </li>
</ol>

<hr />

<p>ì›í•˜ì‹œë©´:</p>

<ul>
  <li>
    <p><strong>ì§€ìˆ˜ ë°±ì˜¤í”„/í´ë§ ì£¼ê¸° ìë™ íŠœë‹</strong> ,</p>
  </li>
  <li>
    <p><strong>ì¶”ê°€ ìƒíƒœ ë§¤í•‘(ì˜ˆ: ZOMBI/PSUSP ë“±)</strong> ,</p>
  </li>
  <li>
    <p><strong>SLURM ë“± ë‹¤ë¥¸ ìŠ¤ì¼€ì¤„ëŸ¬ í…œí”Œë¦¿</strong> ë„ ë°”ë¡œ ë¶™ì—¬ë“œë¦´ê²Œìš”.</p>
  </li>
</ul>

<p class="chat--user">

ì§ˆë¬¸ 1. íŒŒì¼ read accessë¥¼ ê³„ì†í•˜ëŠ”ê±°ì•¼? ê·¸ë ‡ë‹¤ë©´ ëŒ€ì‹ ì— singletonìœ¼ë¡œ ëœ cache í´ë˜ìŠ¤ì— ì €ì¥ëœ ì •ë³´ë¥¼ ì‚¬ìš©í•˜ëŠ” ê±´ ì–´ë•Œ? ì§ˆë¬¸ 2. job id | ì»¤ë§¨ë“œ | job ìƒíƒœ | ë¥¼ ë…¸ë“œì— ê³„ì† ì—…ë°ì´íŠ¸í•˜ë©° ë³´ì—¬ì¤„ ìˆœ ì—†ë‚˜? ì¢€ ê³ ê¸‰ ê¸°ëŠ¥ ê°™ê¸°ëŠ”í•œë° ë˜ë©´ ì°¸ ì¢‹ì„ë“¯

</p>

<p>ì¢‹ì€ ì§ˆë¬¸! í•µì‹¬ë§Œ â€œì‹¤ë¬´ì ìœ¼ë¡œâ€ ì •ë¦¬í•˜ê³ , ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” ì½”ë“œ ì¡°ê°(ì¶”ê°€/íŒ¨ì¹˜ìš©)ë„ ë“œë¦´ê²Œìš”.</p>

<hr />

<h1 id="q1-íŒŒì¼-read-accessë¥¼-ê³„ì†í•˜ë‚˜ìš”--ëŒ€ì‹ -í”„ë¡œì„¸ìŠ¤-ë‚´-ì‹±ê¸€í†¤-ìºì‹œ-ì“°ë©´-ì–´ë•Œìš”">Q1. â€œíŒŒì¼ read accessë¥¼ ê³„ì†í•˜ë‚˜ìš”? â†’ ëŒ€ì‹  í”„ë¡œì„¸ìŠ¤ ë‚´ ì‹±ê¸€í†¤ ìºì‹œ ì“°ë©´ ì–´ë•Œìš”?â€</h1>

<h2 id="ê²°ë¡ -step-by-step">ê²°ë¡  (step-by-step)</h2>

<ol>
  <li>
    <p><strong>ë§ì•„ìš”.</strong> ì „ì—­ ê³µìœ ë¥¼ ìœ„í•´ íŒŒì¼ ìºì‹œë¥¼ ì“°ë©´ ì—¬ëŸ¬ ë…¸ë“œì—ì„œ ì½ê¸°/ì“°ê¸° ê²½ìŸì´ ìƒê¹ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>í•´ë²•ì€ 2-ê³„ì¸µ ìºì‹œ</strong> :</p>

    <ul>
      <li>
        <p><strong>í”„ë¡œì„¸ìŠ¤ ë‚´ ì‹±ê¸€í†¤ ë©”ëª¨ë¦¬ ìŠ¤ëƒ…ìƒ·</strong>(ì´ˆì €ì§€ì—°Â·ë½ í¬í•¨)</p>
      </li>
      <li>
        <p><strong>í”„ë¡œì„¸ìŠ¤ ê°„ ê³µìœ  íŒŒì¼ ìºì‹œ</strong>(TTL+ë½)</p>
      </li>
    </ul>
  </li>
  <li>
    <p>ì¡°íšŒ íë¦„:</p>

    <ul>
      <li>
        <p><strong>ë©”ëª¨ë¦¬ ìŠ¤ëƒ…ìƒ·ì´ ì‹ ì„ (TTL ì´ë‚´)</strong> â†’ íŒŒì¼ ì½ê¸° ì—†ì´ <strong>ì¦‰ì‹œ ë°˜í™˜</strong>.</p>
      </li>
      <li>
        <p>ì‹ ì„ í•˜ì§€ ì•Šìœ¼ë©´ <strong>íŒŒì¼ì„ 1íšŒ ì½ì–´ ë©”ëª¨ë¦¬ ê°±ì‹ </strong>.</p>
      </li>
      <li>
        <p>TTL ë§Œë£ŒÂ·MISSÂ·ìµœì†Œ ê°„ê²© ì¶©ì¡± ì‹œ <strong>í•œ í”„ë¡œì„¸ìŠ¤ë§Œ</strong> <code class="language-plaintext highlighter-rouge">bjobs -a</code> ìˆ˜í–‰í•´ íŒŒì¼/ë©”ëª¨ë¦¬ ë™ì‹œ ê°±ì‹ .</p>
      </li>
    </ul>
  </li>
  <li>
    <p>ì œì¶œ ì§í›„ <strong>SUBMITTED ì‹œë“œ</strong> ëŠ” <strong>ë©”ëª¨ë¦¬ì™€ íŒŒì¼ ëª¨ë‘</strong> ì— ë°˜ì˜ â†’ Node2 ì½”ë„ˆ ì¼€ì´ìŠ¤(ë°©ê¸ˆ ì œì¶œí•œ ì¡ì´ ìºì‹œì— ì•„ì§ ì—†ìŒ) í•´ì†Œ.</p>
  </li>
</ol>

<h3 id="ì ìš©-ì½”ë“œ-ê¸°ì¡´-fulllistsharedcache-ìœ„ì—-ì–¹ëŠ”-ì‹±ê¸€í†¤-ê³„ì¸µ">ì ìš© ì½”ë“œ (ê¸°ì¡´ <code class="language-plaintext highlighter-rouge">FullListSharedCache</code> ìœ„ì— ì–¹ëŠ” ì‹±ê¸€í†¤ ê³„ì¸µ)</h3>

<p>ì•„ë˜ ë¸”ë¡ë§Œ <strong>ì¶”ê°€/ì¹˜í™˜</strong> í•˜ì„¸ìš”. (ë‚˜ë¨¸ì§€ ë¡œì§ì€ ê·¸ëŒ€ë¡œ ë™ì‘)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># --- ì‹±ê¸€í†¤ ë©”ëª¨ë¦¬ ìŠ¤ëƒ…ìƒ· ê³„ì¸µ ---
</span><span class="k">class</span> <span class="nc">_MemSnap</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">jobs</span> <span class="o">=</span> <span class="p">{}</span>                  <span class="c1"># {job_id: {"status": str, "ts": float}, ...}
</span>        <span class="n">self</span><span class="p">.</span><span class="n">last_full_refresh_ts</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># float epoch
</span>        <span class="n">self</span><span class="p">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">FullListSharedCache</span><span class="p">:</span>
    <span class="n">_mem</span> <span class="o">=</span> <span class="nf">_MemSnap</span><span class="p">()</span>  <span class="c1"># í”„ë¡œì„¸ìŠ¤ ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤
</span>
    <span class="c1"># ... (ê¸°ì¡´ __init__, _lock_fd ë“±ì€ ê·¸ëŒ€ë¡œ)
</span>
    <span class="k">def</span> <span class="nf">_mem_is_fresh</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">now</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">ttl</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="nf">float</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="n">last_full_refresh_ts</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="nf">float</span><span class="p">(</span><span class="n">ttl</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_mem_update_from_dict</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="n">jobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="n">last_full_refresh_ts</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_persist_and_update_mem</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_write_cache</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="c1"># íŒŒì¼ ì“°ê¸°ì™€ ë™ì‹œì— ë©”ëª¨ë¦¬ ìŠ¤ëƒ…ìƒ· ìµœì‹ í™”
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">_mem_update_from_dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">seed_submitted</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">meta</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">ì œì¶œ ì§í›„ SUBMITTED ìƒíƒœë¥¼ ë©”ëª¨ë¦¬/íŒŒì¼ ëª¨ë‘ì— ì‹œë“œ.</span><span class="sh">"""</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="c1"># ë©”ëª¨ë¦¬ ì—…ë°ì´íŠ¸
</span>        <span class="c1"># (ë™ì‹œì— ë“¤ì–´ì™€ë„ ë¬´í•´; ìµœì‹  tsë¡œ ë®ì–´ì¨ë„ OK)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="n">jobs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="n">jobs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="n">jobs</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">SUBMITTED</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">now</span><span class="p">})</span>
        <span class="c1"># íŒŒì¼ ì—…ë°ì´íŠ¸
</span>        <span class="n">fh</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_lock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                <span class="n">jobs</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">SUBMITTED</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">now</span><span class="p">})</span>
            <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobs</span>
            <span class="c1"># (ì„ íƒ) ì»¤ë§¨ë“œ ë©”íƒ€ ì €ì¥
</span>            <span class="k">if</span> <span class="n">meta</span><span class="p">:</span>
                <span class="n">jm</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">:</span>
                        <span class="n">jm</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span>
                <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">jm</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_persist_and_update_mem</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">maybe_refresh_full</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">backend</span><span class="p">:</span> <span class="n">StatusBackend</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="c1"># ìµœì†Œ ê°„ê²©Â·ë½ ì²˜ë¦¬ ë™ì¼
</span>        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
        <span class="n">last_ts</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="nf">if </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_ts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nf">float</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">min_refresh_gap_s</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">lock_path</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span> <span class="o">+</span> <span class="sh">"</span><span class="s">.refresh.lock</span><span class="sh">"</span>
        <span class="n">lock_fh</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_lock_fd</span><span class="p">(</span><span class="n">lock_path</span><span class="p">,</span> <span class="n">nonblock</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lock_fh</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data2</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
            <span class="n">last_ts2</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data2</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="nf">if </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_ts2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nf">float</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">min_refresh_gap_s</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="n">snapshot</span> <span class="o">=</span> <span class="k">await</span> <span class="n">backend</span><span class="p">.</span><span class="nf">query_full</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">snapshot</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="n">now2</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_lock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">now2</span>
                <span class="k">for</span> <span class="n">jid</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">snapshot</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
                    <span class="n">jobs</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="n">st</span><span class="p">,</span> <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span><span class="p">}</span>
                <span class="n">base</span><span class="p">[</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobs</span>
                <span class="n">base</span><span class="p">[</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">now2</span>
                <span class="n">meta</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">meta</span><span class="p">[</span><span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">reason</span>
                <span class="n">meta</span><span class="p">[</span><span class="sh">"</span><span class="s">refreshed_at</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
                <span class="n">base</span><span class="p">[</span><span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_persist_and_update_mem</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>  <span class="c1"># íŒŒì¼ê³¼ ë©”ëª¨ë¦¬ ë™ì‹œ ê°±ì‹ 
</span>            <span class="k">finally</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">lock_fh</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_statuses</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">backend</span><span class="p">:</span> <span class="n">StatusBackend</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="c1"># 1) ë©”ëª¨ë¦¬ ìŠ¤ëƒ…ìƒ· ìš°ì„ 
</span>        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="n">mem_fresh</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_mem_is_fresh</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">full_ttl_s</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mem_fresh</span><span class="p">:</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="n">jobs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># íŒŒì¼ 1íšŒ ì½ì–´ ë©”ëª¨ë¦¬ ìµœì‹ í™”
</span>                <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_mem_update_from_dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="n">jobs</span>

        <span class="k">def</span> <span class="nf">_fresh</span><span class="p">(</span><span class="n">jid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">ent</span> <span class="o">=</span> <span class="n">jobs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ent</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="nf">return </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="nf">float</span><span class="p">(</span><span class="n">ent</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="o">&lt;=</span> <span class="nf">float</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">full_ttl_s</span><span class="p">)</span>

        <span class="n">need_refresh</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_mem_is_fresh</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">full_ttl_s</span><span class="p">):</span>
            <span class="n">need_refresh</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">miss</span> <span class="o">=</span> <span class="p">[</span><span class="n">jid</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span> <span class="k">if</span> <span class="ow">not</span> <span class="nf">_fresh</span><span class="p">(</span><span class="n">jid</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">miss</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">force_refresh_on_miss</span><span class="p">:</span>
            <span class="n">need_refresh</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">need_refresh</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">maybe_refresh_full</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="sh">"</span><span class="s">ttl_or_miss</span><span class="sh">"</span><span class="p">)</span>
            <span class="c1"># ë¦¬í”„ë ˆì‹œ í›„ ë©”ëª¨ë¦¬ì—ì„œ ì¬ì¡°íšŒ
</span>            <span class="n">jobs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="n">jobs</span>

        <span class="k">return</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="p">(</span><span class="n">jobs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>íš¨ê³¼: <strong>ë™ì¼ í”„ë¡œì„¸ìŠ¤(=ë™ì¼ ComfyUI ì¸ìŠ¤í„´ìŠ¤)</strong> ì—ì„œ ì—¬ëŸ¬ ë…¸ë“œê°€ ëŒì•„ë„, ëŒ€ë¶€ë¶„ <strong>íŒŒì¼ I/O ì—†ì´ ë©”ëª¨ë¦¬ë§Œ</strong> ë³´ê²Œ ë©ë‹ˆë‹¤. ê·¸ë˜ë„ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤/ë¨¸ì‹ ê³¼ ê³µìœ ê°€ í•„ìš”í•˜ë©´ íŒŒì¼ ìŠ¤ëƒ…ìƒ·ì´ â€œì‚¬ì‹¤ìƒì˜ ì†ŒìŠ¤ ì˜¤ë¸Œ íŠ¸ë£¨ìŠ¤â€ê°€ ë˜ê³ , í•œ í”„ë¡œì„¸ìŠ¤ë§Œ <code class="language-plaintext highlighter-rouge">-a</code>ë¥¼ ì‹¤í–‰í•´ <strong>í­ì£¼ ë°©ì§€</strong> ê°€ ìœ ì§€ë©ë‹ˆë‹¤.</p>
</blockquote>

<p>ë˜í•œ ì œì¶œ ì§í›„:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># submit ì´í›„
</span><span class="n">jid_to_cmd</span> <span class="o">=</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">submitted_at</span><span class="sh">"</span><span class="p">:</span> <span class="nf">iso_now</span><span class="p">()}</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])}</span>
<span class="n">full_cache</span><span class="p">.</span><span class="nf">seed_submitted</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">jid_to_cmd</span><span class="p">)</span>  <span class="c1"># ë©”ëª¨ë¦¬/íŒŒì¼ ëª¨ë‘ ì‹œë“œ + ì»¤ë§¨ë“œ ë©”íƒ€ ì €ì¥
</span></code></pre></div></div>

<hr />

<h1 id="q2-job-id--ì»¤ë§¨ë“œ--ìƒíƒœë¥¼-ë…¸ë“œì—-ê³„ì†-ì—…ë°ì´íŠ¸í•´ì„œ-ë³´ì—¬ì¤„-ìˆ˜-ìˆë‚˜ìš”">Q2. â€œjob id | ì»¤ë§¨ë“œ | ìƒíƒœâ€ë¥¼ ë…¸ë“œì— <strong>ê³„ì†</strong> ì—…ë°ì´íŠ¸í•´ì„œ ë³´ì—¬ì¤„ ìˆ˜ ìˆë‚˜ìš”?</h1>

<h2 id="ê²°ë¡ -step-by-step-1">ê²°ë¡  (step-by-step)</h2>

<ol>
  <li>
    <p><strong>ComfyUI ì½”ì–´ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ</strong> ì„ì˜ ë…¸ë“œê°€ ì‹¤í–‰ ì¤‘ì— <strong>UIë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°±ì‹ </strong> í•˜ëŠ” APIë¥¼ ì œê³µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤(ìµœì¢… ì¶œë ¥ë§Œ í‘œì‹œ).</p>
  </li>
  <li>
    <p>ëŒ€ì‹  í˜„ì‹¤ì ì¸ ë‘ ê°€ì§€ ê²½ë¡œê°€ ìˆìŠµë‹ˆë‹¤.</p>
  </li>
</ol>

<h3 id="aì•ˆí”„ë¡ íŠ¸-ìˆ˜ì •-ì—†ì´-ë…¸ë“œë§Œìœ¼ë¡œ">Aì•ˆ(í”„ë¡ íŠ¸ ìˆ˜ì • ì—†ì´, ë…¸ë“œë§Œìœ¼ë¡œ)</h3>

<ul>
  <li>
    <p><strong>ë³´ì¡° ë·°ì–´ ë…¸ë“œ</strong> ë¥¼ í•˜ë‚˜ ë” ë§Œë“¤ì–´, ê³µìœ  ìºì‹œ(<code class="language-plaintext highlighter-rouge">status_full_cache.json</code>) + <code class="language-plaintext highlighter-rouge">jobs_meta</code>ì—ì„œ <strong>í‘œë¥¼ ìƒì„±(STRING ë˜ëŠ” ì´ë¯¸ì§€)</strong> í•´ì„œ ë³´ì—¬ì¤ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ìµœì‹  ìƒíƒœë¥¼ ë³´ê³  ì‹¶ì„ ë•Œ ë·°ì–´ ë…¸ë“œë¥¼ <strong>ë‹¤ì‹œ ì‹¤í–‰(Queue)</strong> í•˜ë©´ í‘œê°€ ê°±ì‹ ë©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ìë™ ë¦¬í”„ë ˆì‹œëŠ” <code class="language-plaintext highlighter-rouge">Loop/Repeat</code>ë¥˜ í™•ì¥ ë…¸ë“œë¥¼ ê³ë“¤ì´ë©´ ë©ë‹ˆë‹¤.</p>
  </li>
</ul>

<blockquote>
  <p>ì¥ì : ComfyUI ë³€ê²½ ì—†ì´ ì¦‰ì‹œ ì‚¬ìš©.<br />
 ë‹¨ì : â€œì§€ì† ìŠ¤íŠ¸ë¦¬ë°â€ì€ ì•„ë‹ˆê³  <strong>ìˆ˜ë™/ì£¼ê¸° ì¬ì‹¤í–‰</strong>.</p>
</blockquote>

<h3 id="bì•ˆì§„ì§œ-ì‹¤ì‹œê°„-íŒ¨ë„">Bì•ˆ(ì§„ì§œ ì‹¤ì‹œê°„ íŒ¨ë„)</h3>

<ul>
  <li>
    <p>ì»¤ìŠ¤í…€ ë…¸ë“œ íŒŒì¼ ì•ˆì— <strong>ê°€ë²¼ìš´ HTTP GET ì—”ë“œí¬ì¸íŠ¸</strong> ë¥¼ ì¶”ê°€(ComfyUI ì„œë²„ì— ë¼ìš°íŠ¸ ë“±ë¡) â†’ í”„ë¡ íŠ¸ì— ì‘ì€ ìŠ¤í¬ë¦½íŠ¸(ë˜ëŠ” ë³„ë„ í”ŒëŸ¬ê·¸ì¸)ë¡œ <strong>ì£¼ê¸° í´ë§</strong> í•˜ì—¬ í‘œë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì‚¬ì‹¤ìƒ â€œì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œâ€ë¥¼ ComfyUI ì•ˆìª½ íŒ¨ë„ì— ë„£ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
  </li>
</ul>

<blockquote>
  <p>ì¥ì : ì§„ì§œ ë¼ì´ë¸Œ.<br />
 ë‹¨ì : í”„ë¡ íŠ¸ì— ì†Œí­ ì¶”ê°€ ì‘ì—… í•„ìš”.</p>
</blockquote>

<hr />

<h2 id="ë°”ë¡œ-ì“¸-ìˆ˜-ìˆëŠ”-ë·°ì–´-ë…¸ë“œ-aì•ˆ">ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” â€œë·°ì–´ ë…¸ë“œâ€ (Aì•ˆ)</h2>

<p>ì•„ë˜ í´ë˜ìŠ¤ë¥¼ ê°™ì€ íŒŒì¼ì— <strong>ì¶”ê°€</strong> í•˜ì„¸ìš”.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ====== ë·°ì–´ ë…¸ë“œ: ìƒíƒœ í…Œì´ë¸” ì¶œë ¥ ======
</span><span class="k">class</span> <span class="nc">LSFStatusBoard</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ì…ë ¥:
      - job_ids (STRING): </span><span class="sh">"</span><span class="s">123,124,125</span><span class="sh">"</span><span class="s"> (ë¹„ì›Œë‘ë©´ ìºì‹œì— ìˆëŠ” ìµœê·¼ Nê°œë¥¼ ë³´ì—¬ì¤Œ)
      - top_k (INT): job_ids ë¹„ì—ˆì„ ë•Œ ìµœê·¼ Nê°œ
      - width_limit (INT): ì»¤ë§¨ë“œ ì»¬ëŸ¼ ìë¥´ê¸° ê¸¸ì´
    ì¶œë ¥:
      - table_text (STRING): ëª¨ë…¸ìŠ¤í˜ì´ìŠ¤ í‘œ í…ìŠ¤íŠ¸
    </span><span class="sh">"""</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LSF</span><span class="sh">"</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">table_text</span><span class="sh">"</span><span class="p">,)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">top_k</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">INT</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="sh">"</span><span class="s">min</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">max</span><span class="sh">"</span><span class="p">:</span> <span class="mi">500</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">width_limit</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">INT</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span> <span class="sh">"</span><span class="s">min</span><span class="sh">"</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="sh">"</span><span class="s">max</span><span class="sh">"</span><span class="p">:</span> <span class="mi">200</span><span class="p">}),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_read_cache</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="nf">default_cache_dir</span><span class="p">())</span>
        <span class="n">cache_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">status_full_cache.json</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span> <span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span> <span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_short</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">s</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">limit</span> <span class="nf">else </span><span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="n">limit</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="sh">"</span><span class="s">â€¦</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fmt_table</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">rows</span><span class="p">):</span>
        <span class="c1"># ê³ ì • í­ í‘œ ìƒì„±
</span>        <span class="n">jid_w</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nf">max</span><span class="p">((</span><span class="nf">len</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mi">6</span><span class="p">))</span>
        <span class="n">st_w</span>  <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">max</span><span class="p">((</span><span class="nf">len</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="sh">'</span><span class="s">JOBID</span><span class="sh">'</span><span class="si">:</span><span class="o">&lt;</span><span class="si">{</span><span class="n">jid_w</span><span class="si">}}</span><span class="s"> | </span><span class="si">{</span><span class="sh">'</span><span class="s">STATUS</span><span class="sh">'</span><span class="si">:</span><span class="o">&lt;</span><span class="si">{</span><span class="n">st_w</span><span class="si">}}</span><span class="s"> | CMD</span><span class="sh">"</span>
        <span class="n">sep</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-</span><span class="sh">"</span><span class="o">*</span><span class="nf">len</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="p">[</span><span class="n">hdr</span><span class="p">,</span> <span class="n">sep</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">body</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="sh">'</span><span class="s">job_id</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="o">&lt;</span><span class="si">{</span><span class="n">jid_w</span><span class="si">}}</span><span class="s"> | </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="sh">'</span><span class="s">status</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="o">&lt;</span><span class="si">{</span><span class="n">st_w</span><span class="si">}}</span><span class="s"> | </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="sh">'</span><span class="s">cmd</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">width_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">80</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">job_ids</span><span class="p">.</span><span class="nf">strip</span><span class="p">():</span>
            <span class="n">jids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ìµœê·¼ top_k (ts ê¸°ì¤€ ì •ë ¬)
</span>            <span class="n">jids</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">jobs</span><span class="p">.</span><span class="nf">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">j</span><span class="p">:</span> <span class="n">jobs</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)[:</span><span class="n">top_k</span><span class="p">]</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">jids</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">jobs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">meta</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
            <span class="n">rows</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="n">st</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nf">_short</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">width_limit</span><span class="p">),</span>
            <span class="p">})</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fmt_table</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">table</span><span class="p">,)</span>

<span class="c1"># ë“±ë¡
</span><span class="n">NODE_CLASS_MAPPINGS</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span><span class="sh">"</span><span class="s">LSFStatusBoard</span><span class="sh">"</span><span class="p">:</span> <span class="n">LSFStatusBoard</span><span class="p">})</span>
<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span><span class="sh">"</span><span class="s">LSFStatusBoard</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">LSF: Status Board</span><span class="sh">"</span><span class="p">})</span>
</code></pre></div></div>

<h3 id="ì œì¶œ-ë…¸ë“œì—ì„œ-ì»¤ë§¨ë“œ-ë©”íƒ€-ì €ì¥í•œ-ì¤„-ì¶”ê°€">ì œì¶œ ë…¸ë“œì—ì„œ ì»¤ë§¨ë“œ ë©”íƒ€ ì €ì¥(í•œ ì¤„ ì¶”ê°€)</h3>

<p>ì•ì„œ Q1 ì½”ë“œì²˜ëŸ¼ ì œì¶œ ì§í›„ ì»¤ë§¨ë“œë„ í•¨ê»˜ ì‹œë“œí•©ë‹ˆë‹¤:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">jid_to_cmd</span> <span class="o">=</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">submitted_at</span><span class="sh">"</span><span class="p">:</span> <span class="nf">iso_now</span><span class="p">()}</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])}</span>
<span class="n">full_cache</span><span class="p">.</span><span class="nf">seed_submitted</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">jid_to_cmd</span><span class="p">)</span>
</code></pre></div></div>

<blockquote>
  <p>ì´ì œ ë·°ì–´ ë…¸ë“œì—ì„œ <strong>JOBID | STATUS | CMD</strong> ë¥¼ ê¹”ë”íˆ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br />
 â€œê³„ì†â€ ê°±ì‹ í•˜ë ¤ë©´ ë·°ì–´ ë…¸ë“œë¥¼ <strong>ì£¼ê¸°ì ìœ¼ë¡œ ì¬ì‹¤í–‰</strong>(ì§ì ‘ í´ë¦­ ë˜ëŠ” ë°˜ë³µ ì‹¤í–‰ ë…¸ë“œ ì‚¬ìš©)í•˜ì„¸ìš”.</p>
</blockquote>

<hr />

<h2 id="ì§„ì§œ-ì‹¤ì‹œê°„-íŒ¨ë„-bì•ˆ-ì„ íƒ">ì§„ì§œ ì‹¤ì‹œê°„ íŒ¨ë„ (Bì•ˆ, ì„ íƒ)</h2>

<ul>
  <li>
    <p>ê°€ëŠ¥: ì„œë²„ ë¼ìš°íŠ¸ë¥¼ í•˜ë‚˜ ë…¸ë“œ íŒŒì¼ì— ë“±ë¡í•´ JSONì„ ë‚´ë³´ë‚´ê³ , í”„ë¡ íŠ¸(ê°„ë‹¨ JS)ì—ì„œ 1~3ì´ˆ ê°„ê²© í´ë§.</p>
  </li>
  <li>
    <p>í•„ìš” ì½”ë“œ(ê°œìš”): <code class="language-plaintext highlighter-rouge">server.PromptServer</code> ì´ìš©í•´ <code class="language-plaintext highlighter-rouge">GET /lsf/status?job_ids=...</code> ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€ â†’ ìœ„ <code class="language-plaintext highlighter-rouge">LSFStatusBoard</code>ì˜ ë‚´ë¶€ ë¡œì§ì„ ì¬ì‚¬ìš©í•´ JSON ì‘ë‹µ.</p>
  </li>
  <li>
    <p>ì›í•˜ì‹œë©´ ì´ ë¼ìš°íŠ¸ + ìµœì†Œ HTML/JS íŒ¨ë„ ì½”ë“œë¥¼ ë°”ë¡œ ë¶™ì—¬ë“œë¦´ê²Œìš”.</p>
  </li>
</ul>

<hr />

<h2 id="ìš”ì•½">ìš”ì•½</h2>

<ul>
  <li>
    <p><strong>Q1</strong> : íŒŒì¼ ë‚¨ìš© ì—†ì´ <strong>â€œë©”ëª¨ë¦¬ ì‹±ê¸€í†¤ + íŒŒì¼ ìŠ¤ëƒ…ìƒ·â€</strong> 2-ê³„ì¸µ ìºì‹œë¡œ í•´ê²°. ì œì¶œ ì§í›„ <strong>SUBMITTED ì‹œë“œ</strong> ë¡œ Node2 ì½”ë„ˆ ì¼€ì´ìŠ¤ë„ í•´ê²°.</p>
  </li>
  <li>
    <p><strong>Q2</strong> : ì½”ì–´ UIëŠ” ì¤‘ê°„ ê°±ì‹ ì´ ì–´ë ¤ìš°ë¯€ë¡œ</p>

    <ul>
      <li>
        <p>ë°”ë¡œ ì“°ë ¤ë©´ <strong>ë·°ì–´ ë…¸ë“œ(Aì•ˆ)</strong> ë¡œ í‘œë¥¼ ì¬ì‹¤í–‰ ê°±ì‹ ,</p>
      </li>
      <li>
        <p>ì§„ì§œ ë¼ì´ë¸ŒëŠ” <strong>ê°„ë‹¨ ë¼ìš°íŠ¸(Bì•ˆ)</strong> + ì†Œí˜• íŒ¨ë„.</p>
      </li>
    </ul>
  </li>
</ul>

<p>ë” ì§„í•œ ê¸°ëŠ¥(ìƒíƒœ ì•„ì´ì½˜/ìƒ‰ìƒ, ì •ë ¬/í•„í„°, EXIT ì›ì¸ ì¶”ì , bjobs -a ì¶”ê°€ ì»¬ëŸ¼ íŒŒì‹± ë“±) ì›í•˜ì‹œë©´ ì´ì–´ì„œ í™•ì¥í•´ ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

impact nodeì—ì„œ ì•„ë˜ í•¨ìˆ˜(js)ì™€ PromptServer.instance.send_sync("impact-node-feedback", {"node_id": â€¦, â€widget_name": â€¦}) ì´ëŸ° í•¨ìˆ˜ë¥¼ ì´ìš©í•´ì„œ ëŸ°íƒ€ì„ì—ì„œ ìœ„ì ¯ ì—…ë°ì´íŠ¸ë¥¼ í•˜ëŠ” ê²ƒ ê°™ì€ë° ì´ëŸ° ì°¸ê³ í•´ì„œ markdown table í˜•ì‹ìœ¼ë¡œ Jod ID, Status, Command ë¥¼ String widgetì— ê³„ì† ì—…ë°ì´íŠ¸ í•´ë³´ì. function nodeFeedbackHandler(event) { let nodes = app.graph._nodes_by_id; let node = nodes[event.detail.node_id]; if(node) { const w = node.widgets.find((w) =&gt; event.detail.widget_name === w.name); if(w) { w.value = event.detail.value; } } } api.addEventListener("impact-node-feedback", nodeFeedbackHandler);

</p>

<p>ì¢‹ì•„â€”â€œimpact-node-feedbackâ€ íŒ¨í„´ì„ ê·¸ëŒ€ë¡œ í™œìš©í•´ì„œ, <strong>ëŸ°íƒ€ì„ì— String ìœ„ì ¯ì„ ê³„ì† ê°±ì‹ </strong>(ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸” í˜•íƒœ)í•˜ë„ë¡ ë…¸ë“œë¥¼ í™•ì¥í•´ë³¼ê²Œ. ì•„ë˜ëŠ” <strong>step-by-step</strong> ë¡œ ì •ë¦¬í•œ êµ¬í˜„ ê°€ì´ë“œ + ë°”ë¡œ ë¶™ì—¬ë„£ì–´ ì“¸ <strong>íŒ¨ì¹˜ ì½”ë“œ</strong> ì•¼.</p>

<hr />

<h1 id="ì–´ë–»ê²Œ-ì‘ë™í•˜ë‚˜-step-by-step">ì–´ë–»ê²Œ ì‘ë™í•˜ë‚˜ (step-by-step)</h1>

<ol>
  <li>
    <p><strong>í”„ë¡ íŠ¸ì—”ë“œ ë¦¬ìŠ¤ë„ˆ ë“±ë¡</strong><br />
ë„¤ê°€ ì¤€ í•¸ë“¤ëŸ¬ ê·¸ëŒ€ë¡œ ì”€. <code class="language-plaintext highlighter-rouge">impact-node-feedback</code> ì»¤ìŠ¤í…€ ë©”ì‹œì§€ë¥¼ ë°›ìœ¼ë©´ í•´ë‹¹ ë…¸ë“œì˜ íŠ¹ì • ìœ„ì ¯ ê°’ì„ ê°±ì‹ . ì´ ë°©ì‹ì€ ê³µì‹ ë¬¸ì„œì˜ <code class="language-plaintext highlighter-rouge">PromptServer.instance.send_sync()</code> ì‚¬ìš©ì ì •ì˜ ë©”ì‹œì§€ ê°€ì´ë“œì™€ ë™ì¼í•œ íë¦„ì´ì•¼. <a href="https://docs.comfy.org/development/comfyui-server/comms_messages">ComfyUI</a></p>
  </li>
  <li>
    <p><strong>ë…¸ë“œì— â€œí‘œì‹œ ì „ìš©â€ String ìœ„ì ¯ ì¶”ê°€</strong><br />
ì˜ˆ: <code class="language-plaintext highlighter-rouge">status_md</code> ë¼ëŠ” ì´ë¦„ì˜ ë©€í‹°ë¼ì¸ STRING ìœ„ì ¯. ë…¸ë“œ ì‹¤í–‰ ì¤‘ ì„œë²„ì—ì„œ ì´ ìœ„ì ¯ì˜ ê°’ì„ ê³„ì† ë°”ê¿”ì¹˜ê¸° í•¨(ë§ˆí¬ë‹¤ìš´ í‘œ í…ìŠ¤íŠ¸).</p>
  </li>
  <li>
    <p><strong>node_id í™•ë³´(í•„ìˆ˜)</strong><br />
ComfyUIëŠ” <code class="language-plaintext highlighter-rouge">INPUT_TYPES["hidden"]</code>ì— <code class="language-plaintext highlighter-rouge">"UNIQUE_ID"</code>ë¥¼ ë„£ìœ¼ë©´ ëŸ°íƒ€ì„ì—ì„œ <strong>ë…¸ë“œ id</strong> ë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ë°›ì„ ìˆ˜ ìˆìŒ. ì´ê±¸ payloadì— ì‹¤ì–´ ë³´ë‚´ë©´, í”„ë¡ íŠ¸ì—ì„œ ì •í™•í•œ ë…¸ë“œì˜ í•´ë‹¹ ìœ„ì ¯ë§Œ ì—…ë°ì´íŠ¸ ê°€ëŠ¥. <a href="https://docs.comfy.org/development/comfyui-server/comms_messages">ComfyUI+2</a></p>
  </li>
  <li>
    <p><strong>ì„œë²„ì—ì„œ ì£¼ê¸°ì ìœ¼ë¡œ send_sync ë°œì‚¬</strong><br />
í´ë§ ë£¨í”„ ë§¤ í„´ë§ˆë‹¤</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>arduino
     
PromptServer.instance.send_sync(
  "impact-node-feedback",
  {"node_id": node_id, "widget_name": "status_md", "value": table_md}
)
</code></pre></div>    </div>
  </li>
</ol>

<p>ë¡œ ìœ„ì ¯ ê°’ì„ í‘¸ì‹œ. (ë‹¤ìˆ˜ ì˜ˆì œë“¤ì´ ê°™ì€ íŒ¨í„´ìœ¼ë¡œ ìƒíƒœë¥¼ ì‹¤ì‹œê°„ ì•Œë¦¼) <a href="https://huggingface.co/spaces/Freak-ppa/ioatol/blob/b162d43c5cd550b037fb83fa04cc6301339f36f4/ComfyUI/custom_nodes/cg-use-everywhere/use_everywhere.py?utm_source=chatgpt.com">Hugging Face+2</a></p>

<hr />

<h1 id="0-í”„ë¡ íŠ¸ì—”ë“œì›¹-ì½”ë“œ--ë¦¬ìŠ¤ë„ˆ-ë“±ë¡">0) í”„ë¡ íŠ¸ì—”ë“œ(ì›¹) ì½”ë“œ â€” ë¦¬ìŠ¤ë„ˆ ë“±ë¡</h1>

<p><code class="language-plaintext highlighter-rouge">ComfyUI/web/extensions/impact_node_feedback.js</code> (íŒŒì¼ëª…ì€ ì„ì˜)ë¡œ ì €ì¥:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

function nodeFeedbackHandler(event) {
  let nodes = app.graph._nodes_by_id;
  let node = nodes[event.detail.node_id];
  if (node) {
    const w = node.widgets.find((w) =&gt; event.detail.widget_name === w.name);
    if (w) {
      w.value = event.detail.value;
      // UI ì¦‰ì‹œ ê°±ì‹ 
      if (w.callback) w.callback(w.value);
      node.setDirtyCanvas(true, true);
    }
  }
}
api.addEventListener("impact-node-feedback", nodeFeedbackHandler);
</code></pre></div></div>

<blockquote>
  <p>ì´ê±´ ComfyUIì˜ ì»¤ìŠ¤í…€ ë©”ì‹œì§€ ì´ë²¤íŠ¸ ì²˜ë¦¬ íŒ¨í„´ê³¼ 1:1ë¡œ ë§ìŒ. ì„œë²„ì—ì„œ <code class="language-plaintext highlighter-rouge">send_sync</code>ë¡œ <code class="language-plaintext highlighter-rouge">"impact-node-feedback"</code>ë¥¼ ë³´ë‚¼ ê±°ì•¼. <a href="https://docs.comfy.org/development/comfyui-server/comms_messages">ComfyUI</a></p>
</blockquote>

<hr />

<h1 id="1-íŒŒì´ì¬-ë…¸ë“œ-íŒ¨ì¹˜--ìœ„ì ¯node_idë¼ì´ë¸Œì—…ë°ì´íŠ¸-ì¶”ê°€">1) íŒŒì´ì¬ ë…¸ë“œ íŒ¨ì¹˜ â€” ìœ„ì ¯Â·node_idÂ·ë¼ì´ë¸Œì—…ë°ì´íŠ¸ ì¶”ê°€</h1>

<p>ì•„ë˜ <strong>ì¶”ê°€/ìˆ˜ì • ë¸”ë¡ë§Œ</strong> ê¸°ì¡´ ë…¸ë“œ íŒŒì¼ì— ë°˜ì˜í•˜ë©´ ë¼. (ì´ì „ ë‹µë³€ì—ì„œ ë§Œë“  LSFSubmitAndWait ê¸°ì¤€)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ìƒë‹¨ importì— ì¶”ê°€
</span><span class="kn">from</span> <span class="n">server</span> <span class="kn">import</span> <span class="n">PromptServer</span>  <span class="c1"># send_syncë¥¼ ìœ„í•´
</span>
<span class="c1"># ----- ìœ í‹¸: ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸” ìƒì„± -----
</span><span class="k">def</span> <span class="nf">_short</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">s</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">limit</span> <span class="nf">else </span><span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="n">limit</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="sh">"</span><span class="s">â€¦</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">make_status_markdown</span><span class="p">(</span><span class="n">job_rows</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">width_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">80</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    job_rows: [{</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">123</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">RUN</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">bsub ...</span><span class="sh">"</span><span class="s">}, ...]
    </span><span class="sh">"""</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">| JOB ID | STATUS | COMMAND |</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">|------:|:------:|---------|</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">job_rows</span><span class="p">:</span>
        <span class="n">jid</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">st</span>  <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nf">_short</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">),</span> <span class="n">width_limit</span><span class="p">)</span>
        <span class="c1"># íŒŒì´í”„ ì´ìŠ¤ì¼€ì´í”„ëŠ” ë‹¨ìˆœíˆ ë°±í‹± ê°ì‹¸ê¸°ë¡œ íšŒí”¼
</span>        <span class="n">lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">| `</span><span class="si">{</span><span class="n">jid</span><span class="si">}</span><span class="s">` | `</span><span class="si">{</span><span class="n">st</span><span class="si">}</span><span class="s">` | `</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s">` |</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

<span class="c1"># ----- LSFSubmitAndWait í´ë˜ìŠ¤ ë³€ê²½ -----
</span><span class="k">class</span> <span class="nc">LSFSubmitAndWait</span><span class="p">:</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LSF</span><span class="sh">"</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span>
    <span class="n">OUTPUT_NODE</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">SUPPORTS_ASYNC</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">results_json</span><span class="sh">"</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">commands</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">bsub -q short sleep 3</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="c1"># í‘œì‹œ ì „ìš© ìœ„ì ¯(ë¼ì´ë¸Œ ìƒíƒœ ë³´ë“œ)
</span>                <span class="sh">"</span><span class="s">status_md</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span>
                    <span class="sh">"</span><span class="s">| JOB ID | STATUS | COMMAND |</span><span class="se">\n</span><span class="s">|------:|:------:|---------|</span><span class="se">\n</span><span class="s">(ì‹¤í–‰ ì¤‘ ë¼ì´ë¸Œë¡œ ê°±ì‹ ë©ë‹ˆë‹¤)</span><span class="sh">"</span><span class="p">}),</span>
                <span class="c1"># ì¤„ ê¸¸ì´ ì œí•œ(ëª…ë ¹ì–´ ê³¼ë„í•˜ê²Œ ê¸¸ ë•Œ)
</span>                <span class="sh">"</span><span class="s">cmd_width_limit</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">INT</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="sh">"</span><span class="s">min</span><span class="sh">"</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span> <span class="sh">"</span><span class="s">max</span><span class="sh">"</span><span class="p">:</span> <span class="mi">200</span><span class="p">}),</span>
                <span class="c1"># í•„ìš” ì‹œ ë„ê¸°
</span>                <span class="sh">"</span><span class="s">live_update</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">BOOL</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="c1"># node_idë¥¼ ë°›ê¸° ìœ„í•œ hidden ì…ë ¥ (ê³µì‹ ë¬¸ì„œ íŒ¨í„´)
</span>            <span class="sh">"</span><span class="s">hidden</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span> <span class="sh">"</span><span class="s">node_id</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">UNIQUE_ID</span><span class="sh">"</span> <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                  <span class="n">commands</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">status_md</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span>
                  <span class="n">cmd_width_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                  <span class="n">live_update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                  <span class="n">node_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="c1"># ... (ê¸°ì¡´ run ì½”ë“œì˜ "ì˜µì…˜ íŒŒì‹±" ì§í›„ì— ì´ì–´ì„œ) ...
</span>
        <span class="c1"># 1) ì œì¶œ
</span>        <span class="n">submitted_at</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
        <span class="n">job_ids</span><span class="p">,</span> <span class="n">submissions</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">submit_commands_multiline</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>

        <span class="c1"># ì œì¶œí•œ ì»¤ë§¨ë“œ ë©”íƒ€ ë§µ (job_id -&gt; cmd)
</span>        <span class="n">jid_to_cmd</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">jid_to_cmd</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>

        <span class="c1"># 2) ì „ì—­ ìºì‹œ/ë°±ì—”ë“œ
</span>        <span class="n">cache_dir</span> <span class="o">=</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="nf">default_cache_dir</span><span class="p">())</span>
        <span class="n">cache_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">status_full_cache.json</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">full_cache</span> <span class="o">=</span> <span class="nc">FullListSharedCache</span><span class="p">(</span>
            <span class="n">cache_file</span><span class="p">,</span>
            <span class="n">full_ttl_s</span><span class="o">=</span><span class="n">full_ttl_s</span><span class="p">,</span>
            <span class="n">min_refresh_gap_s</span><span class="o">=</span><span class="n">min_refresh_gap_s</span><span class="p">,</span>
            <span class="n">force_refresh_on_miss</span><span class="o">=</span><span class="n">force_refresh_on_miss</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="nc">LSFBjobsFullBackend</span><span class="p">(</span><span class="n">full_status_cmd_template</span><span class="o">=</span><span class="n">full_status_cmd_template</span><span class="p">)</span>

        <span class="c1"># 2-1) ì œì¶œ ì§í›„ ìºì‹œ ì‹œë“œ(ì»¤ë§¨ë“œ ë©”íƒ€ í¬í•¨)
</span>        <span class="k">if</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="c1"># seed_submittedê°€ metaë¥¼ íŒŒì¼/ë©”ëª¨ë¦¬ ëª¨ë‘ì— ì €ì¥í•˜ë„ë¡ ì•ì„œ êµ¬í˜„í•´ë‘ 
</span>            <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid_to_cmd</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">),</span> <span class="sh">"</span><span class="s">submitted_at</span><span class="sh">"</span><span class="p">:</span> <span class="n">submitted_at</span><span class="p">}</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>
            <span class="n">full_cache</span><span class="p">.</span><span class="nf">seed_submitted</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">)</span>

        <span class="c1"># (ì‹ ê·œ) ì´ˆê¸° UI ì—…ë°ì´íŠ¸ í•œë²ˆ ìˆ˜í–‰
</span>        <span class="k">if</span> <span class="n">live_update</span> <span class="ow">and</span> <span class="n">node_id</span> <span class="ow">and</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[{</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid</span><span class="p">,</span> <span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">SUBMITTED</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid_to_cmd</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)}</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
            <span class="n">table_md</span> <span class="o">=</span> <span class="nf">make_status_markdown</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">width_limit</span><span class="o">=</span><span class="n">cmd_width_limit</span><span class="p">)</span>
            <span class="n">PromptServer</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="nf">send_sync</span><span class="p">(</span><span class="sh">"</span><span class="s">impact-node-feedback</span><span class="sh">"</span><span class="p">,</span>
                                            <span class="p">{</span><span class="sh">"</span><span class="s">node_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">node_id</span><span class="p">,</span> <span class="sh">"</span><span class="s">widget_name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">status_md</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">table_md</span><span class="p">})</span>

        <span class="c1"># 3) ì™„ë£Œê¹Œì§€ ëŒ€ê¸° + ì£¼ê¸°ì  UI ì—…ë°ì´íŠ¸
</span>        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">final_statuses</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">waited_sec</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">statuses</span> <span class="o">=</span> <span class="k">await</span> <span class="n">full_cache</span><span class="p">.</span><span class="nf">get_statuses</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">backend</span><span class="p">)</span>
            <span class="n">final_statuses</span> <span class="o">=</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="n">statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>

            <span class="c1"># (ì‹ ê·œ) ë¼ì´ë¸Œ ì—…ë°ì´íŠ¸
</span>            <span class="k">if</span> <span class="n">live_update</span> <span class="ow">and</span> <span class="n">node_id</span> <span class="ow">and</span> <span class="n">job_ids</span><span class="p">:</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="p">[{</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid</span><span class="p">,</span>
                         <span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="n">final_statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">N/A</span><span class="sh">"</span><span class="p">,</span>
                         <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid_to_cmd</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)}</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
                <span class="n">table_md</span> <span class="o">=</span> <span class="nf">make_status_markdown</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">width_limit</span><span class="o">=</span><span class="n">cmd_width_limit</span><span class="p">)</span>
                <span class="n">PromptServer</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="nf">send_sync</span><span class="p">(</span><span class="sh">"</span><span class="s">impact-node-feedback</span><span class="sh">"</span><span class="p">,</span>
                                                <span class="p">{</span><span class="sh">"</span><span class="s">node_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">node_id</span><span class="p">,</span> <span class="sh">"</span><span class="s">widget_name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">status_md</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">table_md</span><span class="p">})</span>

            <span class="k">if</span> <span class="nf">all</span><span class="p">((</span><span class="n">st</span> <span class="ow">in</span> <span class="n">TERMINAL_STATES</span><span class="p">)</span> <span class="ow">and</span> <span class="n">st</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">final_statuses</span><span class="p">.</span><span class="nf">values</span><span class="p">()):</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">max_wait_s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_wait_s</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">poll_interval_s</span><span class="p">)))</span>

        <span class="n">waited_sec</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
        <span class="n">completed_at</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
        <span class="n">all_done</span> <span class="o">=</span> <span class="nf">all</span><span class="p">((</span><span class="n">st</span> <span class="ow">in</span> <span class="n">TERMINAL_STATES</span><span class="p">)</span> <span class="ow">and</span> <span class="n">st</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">final_statuses</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>

        <span class="c1"># (ë‚˜ë¨¸ì§€ ê²°ê³¼ ì €ì¥/ë°˜í™˜ ë¡œì§ì€ ê¸°ì¡´ ê·¸ëŒ€ë¡œ)
</span>        <span class="c1"># ...
</span></code></pre></div></div>

<blockquote>
  <p>í¬ì¸íŠ¸</p>

  <ul>
    <li>
      <p><code class="language-plaintext highlighter-rouge">hidden</code>ì— <code class="language-plaintext highlighter-rouge">"UNIQUE_ID"</code> ì¶”ê°€ â†’ <code class="language-plaintext highlighter-rouge">run(..., node_id=...)</code>ë¡œ ë°›ì„ ìˆ˜ ìˆìŒ. ì„œë²„ì—ì„œ ì´ ê°’ì„ payloadì— ë‹´ì•„ ë³´ëƒ„. í”„ë¡ íŠ¸ëŠ” <code class="language-plaintext highlighter-rouge">node_id</code>ë¡œ í•´ë‹¹ ë…¸ë“œì˜ <code class="language-plaintext highlighter-rouge">status_md</code> ìœ„ì ¯ë§Œ ê°±ì‹ . <a href="https://docs.comfy.org/development/comfyui-server/comms_messages">ComfyUI</a></p>
    </li>
    <li>
      <p>ë©”ì‹œì§€ ë°œì‚¬ëŠ” <code class="language-plaintext highlighter-rouge">PromptServer.instance.send_sync(&lt;event&gt;, &lt;payload&gt;)</code> í˜•ì‹. (ì—¬ëŸ¬ ì»¤ìŠ¤í…€ ë…¸ë“œë“¤ì´ ì´ íŒ¨í„´ìœ¼ë¡œ ì‹¤ì‹œê°„ ìƒíƒœë¥¼ ë³´ë‚´ëŠ” ì‚¬ë¡€ ë‹¤ìˆ˜) <a href="https://huggingface.co/spaces/Freak-ppa/ioatol/blob/b162d43c5cd550b037fb83fa04cc6301339f36f4/ComfyUI/custom_nodes/cg-use-everywhere/use_everywhere.py?utm_source=chatgpt.com">Hugging Face+1</a></p>
    </li>
  </ul>

</blockquote>

<hr />

<h2 id="ê²°ê³¼-í™”ë©´-ì˜ˆì‹œ-string-ìœ„ì ¯-ë‚´ìš©">ê²°ê³¼ í™”ë©´ ì˜ˆì‹œ (String ìœ„ì ¯ ë‚´ìš©)</h2>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">|</span> <span class="no">JOB</span> <span class="no">ID</span> <span class="o">|</span> <span class="no">STATUS</span> <span class="o">|</span> <span class="no">COMMAND</span> <span class="o">|</span>
<span class="o">|------</span><span class="ss">:|</span><span class="p">:</span><span class="o">------</span><span class="ss">:|</span><span class="o">---------|</span>
<span class="o">|</span> <span class="sb">`124578`</span> <span class="o">|</span> <span class="sb">`RUN`</span> <span class="o">|</span> <span class="sb">`bsub -q short -J test1 sleep 5`</span> <span class="o">|</span>
<span class="o">|</span> <span class="sb">`124579`</span> <span class="o">|</span> <span class="sb">`PEND`</span> <span class="o">|</span> <span class="sb">`bsub -q short -J test2 sleep 8`</span> <span class="o">|</span>
<span class="o">|</span> <span class="sb">`124580`</span> <span class="o">|</span> <span class="sb">`DONE`</span> <span class="o">|</span> <span class="sb">`bsub -q short -J test3 sleep 2`</span> <span class="o">|</span>
</code></pre></div></div>

<ul>
  <li>ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸”ì„ â€œë Œë”ë§â€í•˜ì§€ëŠ” ì•Šì§€ë§Œ, <strong>ê°€ë…ì„± ë†’ì€ í…ìŠ¤íŠ¸ í‘œ</strong> ë¡œ ì˜ ë³´ì—¬ì¤˜. (String ìœ„ì ¯ì€ Markdown í•´ì„ì„ ì•ˆ í•˜ë¯€ë¡œ, í‘œ í…ìŠ¤íŠ¸ í˜•íƒœë¡œ ë³´ëŠ” ê°œë…)</li>
</ul>

<hr />

<h2 id="ì¶”ê°€-íŒ">ì¶”ê°€ íŒ</h2>

<ul>
  <li>
    <p><strong>ì—…ë°ì´íŠ¸ ë¹ˆë„(ìŠ¤íŒ¸ ë°©ì§€)</strong><br />
<code class="language-plaintext highlighter-rouge">poll_interval_s</code>ê°€ ë„ˆë¬´ ì‘ìœ¼ë©´ UIë„ ê·¸ë§Œí¼ ìì£¼ ê°±ì‹ ë¨. í•„ìš”í•˜ë©´ â€œë§ˆì§€ë§‰ ì†¡ì‹  ì‹œê°â€ì„ ì €ì¥í•´ <strong>1~2ì´ˆ ì“°ë¡œí‹€</strong> ì„ ì¶”ê°€í•´ë„ ì¢‹ìŒ.</p>
  </li>
  <li>
    <p><strong>ì—¬ëŸ¬ í´ë¼ì´ì–¸íŠ¸ íƒ­ ë™ì‹œ ì ‘ì†</strong><br />
íŠ¹ì • íƒ­ë§Œ ê°±ì‹ í•˜ê³  ì‹¶ë‹¤ë©´ <code class="language-plaintext highlighter-rouge">send_sync(..., sid=PromptServer.instance.client_id)</code>ë¡œ <strong>í˜„ì¬ í´ë¼ì´ì–¸íŠ¸ì—ë§Œ</strong> ë³´ë‚´ëŠ” íŒ¨í„´ë„ ìˆì–´. (ì—¬ëŸ¬ ì˜ˆì œ ë…¸ë“œê°€ ì´ ë°©ì‹ ì‚¬ìš©) <a href="https://gitee.com/failurejack/ComfyUI/blob/master/execution.py?utm_source=chatgpt.com">Gitee</a></p>
  </li>
  <li>
    <p><strong>ëª…ë ¹ì–´ ê¸¸ì´</strong><br />
<code class="language-plaintext highlighter-rouge">cmd_width_limit</code>ë¡œ ê¸´ ì»¤ë§¨ë“œë¥¼ ì¤„ì—¬ ë³´ì—¬ì¤Œ. í•„ìš”í•˜ë©´ íˆ´íŒ/ë³„ë„ ëŒ€ì‹œë³´ë“œë¡œ í™•ì¥ ê°€ëŠ¥.</p>
  </li>
</ul>

<hr />

<h2 id="ìš”ì•½-1">ìš”ì•½</h2>

<ul>
  <li>
    <p><strong>Q1</strong> : íŒŒì¼ ìºì‹œ + í”„ë¡œì„¸ìŠ¤ ë‚´ ì‹±ê¸€í†¤ ë©”ëª¨ë¦¬ ìºì‹œ(ì´ë¯¸ ë°˜ì˜)ë¡œ <strong>bjobs -a ê³¼ë‹¤ í˜¸ì¶œ ë°©ì§€</strong> ë° <strong>ë™ì‹œ ë…¸ë“œ ì•ˆì „</strong>.</p>
  </li>
  <li>
    <p><strong>Q2</strong> : <code class="language-plaintext highlighter-rouge">send_sync("impact-node-feedback", {...})</code> + <code class="language-plaintext highlighter-rouge">hidden UNIQUE_ID</code> + í‘œì‹œìš© <code class="language-plaintext highlighter-rouge">status_md</code> ìœ„ì ¯ìœ¼ë¡œ, <strong>ëŸ°íƒ€ì„ ë¼ì´ë¸Œ ìƒíƒœíŒ</strong> êµ¬í˜„ ì™„ë£Œ. (ê³µì‹ ë¬¸ì„œì˜ ì»¤ìŠ¤í…€ ë©”ì‹œì§€/ë…¸ë“œ id ì „ë‹¬ íŒ¨í„´ ì¤€ìˆ˜) <a href="https://docs.comfy.org/development/comfyui-server/comms_messages">ComfyUI</a></p>
  </li>
</ul>

<p>ì›í•˜ë©´ <strong>ì§„ì§œ Markdown ë Œë”</strong>(HTML íŒ¨ë„)ë‚˜ <strong>ì»¬ëŸ¬ ë±ƒì§€/ì•„ì´ì½˜</strong> , <strong>EXIT ì›ì¸/ì—ëŸ¬ ë¡œê·¸</strong> ì»¬ëŸ¼ë„ ë¶™ì—¬ì¤„ ìˆ˜ ìˆì–´.</p>]]></content><author><name>hvppyarchive</name></author><category term="comfyui" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">Python ë¹„ë™ê¸° ì„œë¸Œí”„ë¡œì„¸ìŠ¤ ì‹¤í–‰</title><link href="https://hvppyarchive.github.io/python/python-async-subprocess/" rel="alternate" type="text/html" title="Python ë¹„ë™ê¸° ì„œë¸Œí”„ë¡œì„¸ìŠ¤ ì‹¤í–‰" /><published>2025-10-10T14:05:19+09:00</published><updated>2025-10-10T14:05:19+09:00</updated><id>https://hvppyarchive.github.io/python/python-async-subprocess</id><content type="html" xml:base="https://hvppyarchive.github.io/python/python-async-subprocess/"><![CDATA[<p class="chat--user">

Pythonì—ì„œ subprocessë¥¼ async taskë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆì–´?

</p>

<p>ë„¤â€”ê°€ëŠ¥í•©ë‹ˆë‹¤. â€œë¹„ë™ê¸°ì ìœ¼ë¡œ ì„œë¸Œí”„ë¡œì„¸ìŠ¤ ì‹¤í–‰â€ì€ ë³´í†µ ë‘ ê°€ì§€ ë°©ì‹ì´ ìˆì–´ìš”.</p>

<h2 id="1-asyncioê°€-ì œê³µí•˜ëŠ”-ì§„ì§œ-ë¹„ë™ê¸°-ì„œë¸Œí”„ë¡œì„¸ìŠ¤-api-ì“°ê¸°">1) <code class="language-plaintext highlighter-rouge">asyncio</code>ê°€ ì œê³µí•˜ëŠ” <strong>ì§„ì§œ ë¹„ë™ê¸° ì„œë¸Œí”„ë¡œì„¸ìŠ¤</strong> API ì“°ê¸°</h2>

<p>í•µì‹¬ì€ <code class="language-plaintext highlighter-rouge">asyncio.create_subprocess_exec()</code>(ë˜ëŠ” <code class="language-plaintext highlighter-rouge">create_subprocess_shell()</code>)ì…ë‹ˆë‹¤. ë°˜í™˜ê°’ì¸ <code class="language-plaintext highlighter-rouge">Process</code>ì—ëŠ” <code class="language-plaintext highlighter-rouge">wait()</code>, <code class="language-plaintext highlighter-rouge">communicate()</code> ê°™ì€ <strong><code class="language-plaintext highlighter-rouge">await</code> ê°€ëŠ¥í•œ</strong> ë©”ì„œë“œê°€ ìˆì–´ì„œ ì´ë²¤íŠ¸ ë£¨í”„ë¥¼ ë§‰ì§€ ì•Šì•„ìš”.</p>

<h3 id="a-ì¶œë ¥-ì „ì²´-í•œ-ë²ˆì—-ë°›ê¸°">(A) ì¶œë ¥ ì „ì²´ í•œ ë²ˆì— ë°›ê¸°</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span> <span class="k">as</span> <span class="n">asp</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
        <span class="n">sys</span><span class="p">.</span><span class="n">executable</span><span class="p">,</span> <span class="sh">"</span><span class="s">-u</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-c</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">import time; [print(i) or time.sleep(0.3) for i in range(5)]</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">asp</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">asp</span><span class="p">.</span><span class="n">PIPE</span>
    <span class="p">)</span>
    <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">()</span>   <span class="c1"># ë‘˜ ë‹¤ bytes
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">RC:</span><span class="sh">"</span><span class="p">,</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDOUT:</span><span class="sh">"</span><span class="p">,</span> <span class="n">out</span><span class="p">.</span><span class="nf">decode</span><span class="p">())</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDERR:</span><span class="sh">"</span><span class="p">,</span> <span class="n">err</span><span class="p">.</span><span class="nf">decode</span><span class="p">())</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<h3 id="b-ìŠ¤íŠ¸ë¦¬ë°-ìœ¼ë¡œ-ì¤„-ë‹¨ìœ„-ì½ê¸°-ê¸´-ì‘ì—…ì‹¤ì‹œê°„-ë¡œê·¸ìš©">(B) <strong>ìŠ¤íŠ¸ë¦¬ë°</strong> ìœ¼ë¡œ ì¤„ ë‹¨ìœ„ ì½ê¸° (ê¸´ ì‘ì—…/ì‹¤ì‹œê°„ ë¡œê·¸ìš©)</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span> <span class="k">as</span> <span class="n">asp</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
        <span class="n">sys</span><span class="p">.</span><span class="n">executable</span><span class="p">,</span> <span class="sh">"</span><span class="s">-u</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-c</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">import time,sys</span><span class="se">\n</span><span class="s">for i in range(5):</span><span class="se">\n</span><span class="s"> print(i); sys.stdout.flush(); time.sleep(0.3)</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">asp</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">asp</span><span class="p">.</span><span class="n">STDOUT</span>
    <span class="p">)</span>

    <span class="k">async</span> <span class="k">for</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">proc</span><span class="p">.</span><span class="n">stdout</span><span class="p">:</span>  <span class="c1"># bytes ìŠ¤íŠ¸ë¦¼
</span>        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">&gt; </span><span class="sh">"</span><span class="p">,</span> <span class="n">raw</span><span class="p">.</span><span class="nf">decode</span><span class="p">().</span><span class="nf">rstrip</span><span class="p">())</span>

    <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">()</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">RC:</span><span class="sh">"</span><span class="p">,</span> <span class="n">rc</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p><strong>í¬ì¸íŠ¸</strong></p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">stdout=PIPE</code>, <code class="language-plaintext highlighter-rouge">stderr=PIPE/STDOUT</code>ë¡œ íŒŒì´í”„ ì—°ê²°.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">communicate()</code>ëŠ” ì¢…ë£Œê¹Œì§€ ê¸°ë‹¤ë¦¬ë©° ì „ë¶€ ëª¨ì•„ ë°˜í™˜.</p>
  </li>
  <li>
    <p>ì‹¤ì‹œê°„ì´ í•„ìš”í•˜ë©´ <code class="language-plaintext highlighter-rouge">async for proc.stdout</code>ë¡œ ì½ê¸°.</p>
  </li>
  <li>
    <p>íŒŒì´ì¬ í•˜ìœ„ í”„ë¡œì„¸ìŠ¤ëŠ” <code class="language-plaintext highlighter-rouge">-u</code>(unbuffered)ë¡œ ë²„í¼ë§ ì§€ì—°ì„ ì¤„ì´ëŠ” ê²Œ ì¢‹ì•„ìš”.</p>
  </li>
</ul>

<h2 id="2-ê¸°ì¡´ì˜-ë¸”ë¡œí‚¹-subprocessrunì„-ìŠ¤ë ˆë“œë¡œ-ëŒë¦¬ê¸°">2) ê¸°ì¡´ì˜ <strong>ë¸”ë¡œí‚¹</strong> <code class="language-plaintext highlighter-rouge">subprocess.run()</code>ì„ ìŠ¤ë ˆë“œë¡œ ëŒë¦¬ê¸°</h2>

<p>ë ˆê±°ì‹œ ì½”ë“œë‚˜ ê°„ë‹¨í•œ í˜¸ì¶œì„ ê·¸ëŒ€ë¡œ ì“°ê³  ì‹¶ë‹¤ë©´, ì´ë²¤íŠ¸ ë£¨í”„ëŠ” ì‚´ë¦¬ê³  ì‘ì—…ë§Œ ìŠ¤ë ˆë“œë¡œ ë„˜ê¸¸ ìˆ˜ ìˆì–´ìš”.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">subprocess</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_blocking</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
    <span class="c1"># Python 3.9+: to_thread ê¶Œì¥
</span>    <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">to_thread</span><span class="p">(</span>
        <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
        <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="bp">False</span>
    <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_blocking</span><span class="p">([</span><span class="sh">"</span><span class="s">git</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">])</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">stdout</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p><strong>í¬ì¸íŠ¸</strong></p>

<ul>
  <li>
    <p>ì´ ë°©ë²•ì€ <em>ì§„ì§œ ë¹„ë™ê¸° I/O</em> ëŠ” ì•„ë‹ˆê³ , <strong>ìŠ¤ë ˆë“œ í•˜ë‚˜ë¥¼ ì°¨ì§€</strong> í•´ì„œ ë¸”ë¡œí‚¹ í˜¸ì¶œì„ ìš°íšŒí•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì…ì¶œë ¥ì„ ì¤„ ë‹¨ìœ„ë¡œ ì‹¤ì‹œê°„ ì²˜ë¦¬í•˜ê¸´ ë¶ˆí¸í•˜ê³ , â€œëë‚˜ë©´ ê²°ê³¼â€ê°€ í•„ìš”í•œ ê²½ìš°ì— ì í•©.</p>
  </li>
</ul>

<hr />

<h2 id="ì—¬ëŸ¬-í”„ë¡œì„¸ìŠ¤ë¥¼-ë™ì‹œì—-ëŒë¦¬ê¸°">ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤ë¥¼ <strong>ë™ì‹œì—</strong> ëŒë¦¬ê¸°</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span> <span class="k">as</span> <span class="n">asp</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
        <span class="n">sys</span><span class="p">.</span><span class="n">executable</span><span class="p">,</span> <span class="sh">"</span><span class="s">-u</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-c</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">print(</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s">)</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">asp</span><span class="p">.</span><span class="n">PIPE</span>
    <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">procs</span> <span class="o">=</span> <span class="p">[</span><span class="k">await</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
    <span class="n">outs</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">gather</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">communicate</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">procs</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">_err</span><span class="p">)</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">outs</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">out</span><span class="p">.</span><span class="nf">decode</span><span class="p">().</span><span class="nf">strip</span><span class="p">())</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<h2 id="íƒ€ì„ì•„ì›ƒì·¨ì†Œì •ë¦¬ì¤‘ìš”">íƒ€ì„ì•„ì›ƒ/ì·¨ì†Œ/ì •ë¦¬(ì¤‘ìš”)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span> <span class="k">as</span> <span class="n">asp</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">safe_run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">asp</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">asp</span><span class="p">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
        <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>                 <span class="c1"># or proc.terminate()
</span>        <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">()</span>           <span class="c1"># ì¢€ë¹„ ë°©ì§€
</span>        <span class="k">raise</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
        <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">()</span>
        <span class="k">raise</span>
</code></pre></div></div>

<h2 id="í”Œë«í¼ì£¼ì˜ì‚¬í•­-í•œëˆˆì—">í”Œë«í¼/ì£¼ì˜ì‚¬í•­ í•œëˆˆì—</h2>

<ul>
  <li>
    <p><strong>Windows</strong> : íŒŒì´í”„ê°€ ì—°ê²°ëœ ì„œë¸Œí”„ë¡œì„¸ìŠ¤ëŠ” Python â‰¥3.8ì˜ ê¸°ë³¸ ì´ë²¤íŠ¸ ë£¨í”„(í”„ë¡œì•¡í„°)ì—ì„œ ì˜ ë™ì‘í•©ë‹ˆë‹¤. (ì•„ì£¼ ì˜› ë²„ì „ì€ <code class="language-plaintext highlighter-rouge">ProactorEventLoop</code> í•„ìš”)</p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">shell=True</code></strong>ëŠ” í¸í•˜ì§€ë§Œ ì¸ì ì´ìŠ¤ì¼€ì´í”„/ë³´ì•ˆ ì´ìŠˆê°€ ìˆìœ¼ë‹ˆ ê¼­ í•„ìš”í•œ ê²½ìš°ë§Œ ì‚¬ìš©í•˜ì„¸ìš”.</p>
  </li>
  <li>
    <p><strong>ëŒ€ìš©ëŸ‰ ì¶œë ¥</strong> ì„ í•œêº¼ë²ˆì— <code class="language-plaintext highlighter-rouge">communicate()</code>ë¡œ ë°›ìœ¼ë©´ ë©”ëª¨ë¦¬ë¥¼ ë§ì´ ë¨¹ì„ ìˆ˜ ìˆì–´ìš”. ì´ëŸ° ê²½ìš° (B)ì²˜ëŸ¼ ìŠ¤íŠ¸ë¦¬ë°ì´ ì•ˆì „í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>í…ìŠ¤íŠ¸ ë””ì½”ë”©</strong> : <code class="language-plaintext highlighter-rouge">asyncio.subprocess</code>ëŠ” <strong>bytes</strong> ë¥¼ ì¤ë‹ˆë‹¤. <code class="language-plaintext highlighter-rouge">.decode()</code> ì§ì ‘ í˜¸ì¶œí•˜ê±°ë‚˜ <code class="language-plaintext highlighter-rouge">codecs.StreamReader</code>ë¡œ ê°ì‹¸ì„¸ìš”.</p>
  </li>
  <li>
    <p><strong>í”„ë¡œì„¸ìŠ¤ ê·¸ë£¹</strong> : ë¦¬ëˆ…ìŠ¤/ë§¥ì—ì„œ í•˜ìœ„ íŠ¸ë¦¬ê¹Œì§€ ì¢…ë£Œí•˜ë ¤ë©´ <code class="language-plaintext highlighter-rouge">start_new_session=True</code>ë¡œ ìƒˆ ì„¸ì…˜ ì‹œì‘ í›„, í•„ìš” ì‹œ <code class="language-plaintext highlighter-rouge">os.killpg()</code> ì‚¬ìš©(ê³ ê¸‰ ì£¼ì œ).</p>
  </li>
</ul>

<hr />

<h3 id="ìš”ì•½">ìš”ì•½</h3>

<ul>
  <li>
    <p>â€œì´ë²¤íŠ¸ ë£¨í”„ë¥¼ ë§‰ì§€ ì•Šê³ â€ ì„œë¸Œí”„ë¡œì„¸ìŠ¤ë¥¼ ëŒë¦¬ë ¤ë©´: <strong><code class="language-plaintext highlighter-rouge">asyncio.create_subprocess_exec/shell</code></strong>ì„ ì“°ì„¸ìš”.</p>
  </li>
  <li>
    <p>ê¸°ì¡´ ë¸”ë¡œí‚¹ ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ì“°ê³  ì‹¶ë‹¤ë©´: <strong><code class="language-plaintext highlighter-rouge">asyncio.to_thread(subprocess.run, ...)</code></strong>ìœ¼ë¡œ ê°ì‹¸ì„¸ìš”.</p>
  </li>
  <li>
    <p>ìŠ¤íŠ¸ë¦¬ë°, ë³‘ë ¬ ì‹¤í–‰, íƒ€ì„ì•„ì›ƒ/ì·¨ì†Œê¹Œì§€ ìœ„ ì˜ˆì œ íŒ¨í„´ì´ë©´ ëŒ€ë¶€ë¶„ì˜ ì¼€ì´ìŠ¤ë¥¼ ì»¤ë²„í•©ë‹ˆë‹¤.</p>
  </li>
</ul>

<p class="chat--user">

async def main(): proc = await asyncio.create_subprocess_exec( sys.executable, "-u", "-c", "import time; [print(i) or time.sleep(0.3) for i in range(5)]", stdout=asp.PIPE, stderr=asp.PIPE ) out, err = await proc.communicate() # ë‘˜ ë‹¤ bytes print("RC:", proc.returncode) print("STDOUT:", out.decode()) print("STDERR:", err.decode()) ì´ ë™ì‘ì„ taskë¡œ ë§Œë“¤ê³  ì‹¶ì–´.

</p>

<p>ê°€ëŠ¥í•˜ì£ ! í•µì‹¬ì€ â€œì„œë¸Œí”„ë¡œì„¸ìŠ¤ë¥¼ ëŒë¦¬ëŠ” ì½”ë£¨í‹´â€ì„ í•˜ë‚˜ ë§Œë“¤ê³ , ê·¸ê±¸ <code class="language-plaintext highlighter-rouge">asyncio.create_task()</code>ë¡œ ìŠ¤ì¼€ì¤„í•˜ëŠ” ê²ë‹ˆë‹¤. ì•„ë˜ë¥¼ ê·¸ëŒ€ë¡œ ë¶™ì—¬ ë„£ì–´ ì“°ì„¸ìš”.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">asyncio.subprocess</span> <span class="k">as</span> <span class="n">asp</span>

<span class="c1"># 1) ì„œë¸Œí”„ë¡œì„¸ìŠ¤ë¥¼ ì‹¤í–‰í•˜ê³  ê²°ê³¼ë¥¼ ë°˜í™˜í•˜ëŠ” ì½”ë£¨í‹´
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">run_subprocess</span><span class="p">():</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
        <span class="n">sys</span><span class="p">.</span><span class="n">executable</span><span class="p">,</span> <span class="sh">"</span><span class="s">-u</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-c</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">import time; [print(i) or time.sleep(0.3) for i in range(5)]</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">asp</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">asp</span><span class="p">.</span><span class="n">PIPE</span>
    <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">()</span>  <span class="c1"># bytes íŠœí”Œ
</span>        <span class="k">return</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">out</span><span class="p">.</span><span class="nf">decode</span><span class="p">(),</span> <span class="n">err</span><span class="p">.</span><span class="nf">decode</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
        <span class="c1"># ì·¨ì†Œ ì‹œ ê¹”ë”í•˜ê²Œ ì¢…ë£Œ(ì¢€ë¹„ ë°©ì§€)
</span>        <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">()</span>
        <span class="k">raise</span>

<span class="c1"># 2) ìœ„ ì½”ë£¨í‹´ì„ Taskë¡œ ë§Œë“¤ì–´ ë™ì‹œ ì‹¤í–‰
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">run_subprocess</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">my-subprocess-task</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># (ì„ íƒ) ì—¬ê¸°ì„œ ë‹¤ë¥¸ ë¹„ë™ê¸° ì‘ì—…ë“¤ì„ ë³‘í–‰í•  ìˆ˜ ìˆìŒ
</span>    <span class="c1"># await do_other_async_work()
</span>
    <span class="c1"># (ì„ íƒ) íƒ€ì„ì•„ì›ƒì„ ê±¸ê³  ì‹¶ë‹¤ë©´:
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
        <span class="n">task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">task</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">raise</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">RC:</span><span class="sh">"</span><span class="p">,</span> <span class="n">rc</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDOUT:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDERR:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<h3 id="í¬ì¸íŠ¸-í•œê±¸ìŒì”©">í¬ì¸íŠ¸ (í•œê±¸ìŒì”©)</h3>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">run_subprocess()</code>ëŠ” <strong>ì„œë¸Œí”„ë¡œì„¸ìŠ¤ ìƒëª…ì£¼ê¸°</strong> ë¥¼ ì±…ì„ì§€ëŠ” ì½”ë£¨í‹´ì…ë‹ˆë‹¤.</p>

    <ul>
      <li>
        <p>ì •ìƒ ì™„ë£Œ ì‹œ <code class="language-plaintext highlighter-rouge">(returncode, stdout(str), stderr(str))</code>ë¥¼ ë°˜í™˜.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">CancelledError</code>ì—ì„œ <code class="language-plaintext highlighter-rouge">kill()</code>+<code class="language-plaintext highlighter-rouge">wait()</code>ë¡œ ì •ë¦¬(í•„ìˆ˜).</p>
      </li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">main()</code>ì—ì„œ <code class="language-plaintext highlighter-rouge">asyncio.create_task(...)</code>ë¡œ <strong>Task</strong> ë¥¼ ë§Œë“¤ë©´, ì´ë²¤íŠ¸ ë£¨í”„ëŠ” ì´ ì‘ì—…ì„ ë°±ê·¸ë¼ìš´ë“œë¡œ ì§„í–‰í•˜ê³ , í•„ìš”í•  ë•Œ <code class="language-plaintext highlighter-rouge">await task</code>ë¡œ ê²°ê³¼ë¥¼ íšŒìˆ˜í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>íƒ€ì„ì•„ì›ƒ</strong> ì€ <code class="language-plaintext highlighter-rouge">asyncio.wait_for(task, timeout=...)</code>ë¡œ ê°ì‹¸ê³ , ë§Œë£Œ ì‹œ <code class="language-plaintext highlighter-rouge">task.cancel()</code> í›„ ì •ë¦¬.</p>
  </li>
  <li>
    <p>ì‹¤ì‹œê°„ ë¡œê·¸ê°€ í•„ìš”í•˜ë©´, <code class="language-plaintext highlighter-rouge">communicate()</code> ëŒ€ì‹  <code class="language-plaintext highlighter-rouge">async for line in proc.stdout:</code> íŒ¨í„´ì„ <code class="language-plaintext highlighter-rouge">run_subprocess()</code> ì•ˆì— ë„£ìœ¼ë©´ ë©ë‹ˆë‹¤(ê·¸ ê²½ìš° ë¬¸ìì—´ì„ ëˆ„ì í•´ì„œ ë°˜í™˜í•˜ê±°ë‚˜ ì½œë°±/íë¡œ ì „ë‹¬).</p>
  </li>
</ol>

<p>ì›í•˜ë©´, ê°™ì€ íŒ¨í„´ìœ¼ë¡œ ì—¬ëŸ¬ ê°œë¥¼ ë™ì‹œì— ëŒë¦´ ìˆ˜ë„ ìˆì–´ìš”:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">main_many</span><span class="p">():</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">run_subprocess</span><span class="p">())</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">as_completed</span><span class="p">(</span><span class="n">tasks</span><span class="p">):</span>
        <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">done:</span><span class="sh">"</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div></div>

<p>ì´ë ‡ê²Œ í•˜ë©´ â€œì„œë¸Œí”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ â†’ Taskë¡œ ìŠ¤ì¼€ì¤„ â†’ ê²°ê³¼ ëŒ€ê¸°/ì·¨ì†Œ/íƒ€ì„ì•„ì›ƒâ€ê¹Œì§€ ê¹”ë”í•˜ê²Œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</p>

<p class="chat--user">

proc = await asyncio.create_subprocess_exec( sys.executable, "-u", "-c", "import time; [print(i) or time.sleep(0.3) for i in range(5)]", stdout=asp.PIPE, stderr=asp.PIPE ) ì´ ì½”ë“œë¥¼ try ì•ˆì— ë„£ì§€ ì•ŠëŠ” ì´ìœ ê°€ ìˆì–´?

</p>

<p>ì§§ê²Œ ë§í•˜ë©´: <strong>ì •ë¦¬(cleanup)ê°€ í•„ìš”í•œ êµ¬ê°„ë§Œ<code class="language-plaintext highlighter-rouge">try</code>ë¡œ ê°ì‹¸ê¸°</strong> ìœ„í•´ì„œì˜ˆìš”.<br />
<code class="language-plaintext highlighter-rouge">create_subprocess_exec()</code> í˜¸ì¶œ ìì²´ëŠ” â€œì•„ì§ í”„ë¡œì„¸ìŠ¤ê°€ ì—†ê±°ë‚˜(ìƒì„± ì „) ê³§ë°”ë¡œ ì‹¤íŒ¨í•˜ëŠ”â€ ë‹¨ê³„ë¼ì„œ, ì—¬ê¸°ì„œ ì˜ˆì™¸/ì·¨ì†Œê°€ ë‚˜ë©´ <strong>ì •ë¦¬í•  ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.</strong></p>

<p>step-by-stepë¡œ ë³´ë©´:</p>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">await asyncio.create_subprocess_exec(...)</code></p>

    <ul>
      <li>
        <p>ì—¬ê¸°ì„œ <strong>ì·¨ì†Œ(<code class="language-plaintext highlighter-rouge">CancelledError</code>)</strong>ê°€ ë‚˜ë©´ í”„ë¡œì„¸ìŠ¤ëŠ” ë§Œë“¤ì–´ì§€ì§€ ì•Šì•˜ìœ¼ë‹ˆ kill/wait ë¶ˆí•„ìš”.</p>
      </li>
      <li>
        <p>ì‹¤í–‰ íŒŒì¼ ì—†ìŒ ë“±ìœ¼ë¡œ <strong><code class="language-plaintext highlighter-rouge">FileNotFoundError</code>/<code class="language-plaintext highlighter-rouge">OSError</code></strong>ê°€ ë‚˜ë©´ ì—­ì‹œ í”„ë¡œì„¸ìŠ¤ê°€ ì—†ìœ¼ë‹ˆ ì •ë¦¬í•  ê²Œ ì—†ìŒ.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>í”„ë¡œì„¸ìŠ¤ê°€ <strong>ì„±ê³µì ìœ¼ë¡œ ë§Œë“¤ì–´ì§„ ë’¤</strong> ì—ì•¼ <code class="language-plaintext highlighter-rouge">proc</code>ê°€ ìƒê¹ë‹ˆë‹¤.</p>

    <ul>
      <li>
        <p>ì´í›„ <code class="language-plaintext highlighter-rouge">await proc.communicate()</code>ì—ì„œ ì·¨ì†Œ/íƒ€ì„ì•„ì›ƒì´ ë‚˜ë©´ <strong>ì¢€ë¹„ ë°©ì§€</strong> ë¥¼ ìœ„í•´ <code class="language-plaintext highlighter-rouge">proc.kill(); await proc.wait()</code>ê°€ í•„ìš”í•˜ì£ .</p>
      </li>
      <li>
        <p>ê·¸ë˜ì„œ <code class="language-plaintext highlighter-rouge">try/except</code>ëŠ” ì´ <strong>ë‘ ë²ˆì§¸ êµ¬ê°„</strong>(communicate/ëŒ€ê¸° êµ¬ê°„)ì—ë§Œ ë‘ëŠ” ê²Œ ë§ìŠµë‹ˆë‹¤.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>ë˜ ë‹¤ë¥¸ ì´ìœ :</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">create_subprocess_exec()</code>ë¥¼ <code class="language-plaintext highlighter-rouge">try</code> ì•ˆì— ë‘ë©´, ì˜ˆì™¸ íë¦„ì— ë”°ë¼ <code class="language-plaintext highlighter-rouge">proc</code>ê°€ <strong>ì •ì˜ë˜ì§€ ì•Šì€ ìƒíƒœì—ì„œ</strong> <code class="language-plaintext highlighter-rouge">proc.kill()</code>ì„ í˜¸ì¶œí•  ìœ„í—˜ì´ ìƒê¹ë‹ˆë‹¤(ë ˆí¼ëŸ°ìŠ¤ê°€ ì—†ì–´ì„œ ë˜ ë‹¤ë¥¸ ì˜ˆì™¸ ìœ ë°œ).</p>
      </li>
      <li>
        <p>â€œì·¨ì†Œ ì‹ í˜¸ê°€ ìƒì„± ì§í›„~<code class="language-plaintext highlighter-rouge">try</code> ì§„ì… ì‚¬ì´ì— ë“¤ì–´ì˜¤ë©´ ì–´ë–¡í•´ìš”?â€ â†’ ì·¨ì†ŒëŠ” <strong>ë‹¤ìŒ<code class="language-plaintext highlighter-rouge">await</code> ì§€ì ì—ì„œ</strong> ë˜ì ¸ì§€ë¯€ë¡œ, ìƒì„±ì´ ëë‚˜ê³  <code class="language-plaintext highlighter-rouge">try</code> ë¸”ë¡ìœ¼ë¡œ ë“¤ì–´ê°„ ë’¤ì˜ <code class="language-plaintext highlighter-rouge">await</code>(ì˜ˆ: <code class="language-plaintext highlighter-rouge">communicate</code>)ì—ì„œ ì²˜ë¦¬ë©ë‹ˆë‹¤. ë ˆì´ìŠ¤ ê±±ì • ì—†ìŒ.</p>
      </li>
    </ul>
  </li>
</ol>

<p>ì›í•œë‹¤ë©´ â€œìŠ¤í° ì‹¤íŒ¨â€ë§Œ ë³„ë„ë¡œ ë‹¤ë£¨ëŠ” 2ë‹¨ê³„ íŒ¨í„´ì´ ê°€ì¥ ê²¬ê³ í•©ë‹ˆë‹¤:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">asyncio.subprocess</span> <span class="k">as</span> <span class="n">asp</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_subprocess</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
            <span class="n">sys</span><span class="p">.</span><span class="n">executable</span><span class="p">,</span> <span class="sh">"</span><span class="s">-u</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-c</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">import time; [print(i) or time.sleep(0.3) for i in range(5)]</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">asp</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">asp</span><span class="p">.</span><span class="n">PIPE</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="nb">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># ì‹¤í–‰ íŒŒì¼ ì—†ìŒ/ê¶Œí•œ ë¬¸ì œ ë“±
</span>        <span class="c1"># ì—¬ê¸°ì„œëŠ” ì •ë¦¬í•  í”„ë¡œì„¸ìŠ¤ê°€ ì—†ìŒ
</span>        <span class="k">raise</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">out</span><span class="p">.</span><span class="nf">decode</span><span class="p">(),</span> <span class="n">err</span><span class="p">.</span><span class="nf">decode</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
        <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">()</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="c1"># ì›í•œë‹¤ë©´ ë‹¤ë¥¸ ì˜ˆì™¸ì—ì„œë„ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ë¥¼ ë³´ì¥
</span>        <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">()</span>
        <span class="k">raise</span>
</code></pre></div></div>

<p>ìš”ì•½: <strong>í”„ë¡œì„¸ìŠ¤ê°€ ìƒê¸´ ì´í›„ì—ë§Œ</strong> ì •ë¦¬ê°€ í•„ìš”í•˜ë¯€ë¡œ, ìƒì„± í˜¸ì¶œì€ <code class="language-plaintext highlighter-rouge">try</code> ë°–ì— ë‘ê³ , ëŒ€ê¸°/í†µì‹  êµ¬ê°„ì„ <code class="language-plaintext highlighter-rouge">try</code>ë¡œ ê°ì‹¸ëŠ” ê²Œ ê¹”ë”í•˜ê³  ì•ˆì „í•©ë‹ˆë‹¤.</p>

<p class="chat--user">

ê¸°ì¡´ ì½”ë“œì—ì„œ subprocess ì‹¤í–‰í•  ë•Œ preexec_fn=os.setsid, creationflags=0í•˜ê³ , êº¼ì§ˆ ë•ŒëŠ” getpgid(pid)í•´ì„œ ë‹¤ ê°™ì´ ë„ëŠ” ì½”ë“œê°€ ìˆì—ˆëŠ”ë° ì—¬ê¸°ì—ëŠ” í•„ìš”ì—†ì–´?

</p>

<p>ìš”ì§€ëŠ” ì´ê±°ì˜ˆìš”: <strong>â€œì „ì²´ í”„ë¡œì„¸ìŠ¤ ê·¸ë£¹ê¹Œì§€ í•œ ë²ˆì— ë„ê³  ì‹¶ë‹¤ë©´ í•„ìš”â€, ì•„ë‹ˆë©´ ë¶ˆí•„ìš”.</strong></p>

<p>step-by-stepë¡œ ì •ë¦¬í•˜ë©´:</p>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">asyncio.create_subprocess_exec()</code> ìì²´ëŠ” <strong>ë‹¨ì¼ í”„ë¡œì„¸ìŠ¤ë§Œ</strong> ê´€ë¦¬í•©ë‹ˆë‹¤.</p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">proc.terminate()</code>/<code class="language-plaintext highlighter-rouge">proc.kill()</code>ì€ <strong>ê·¸ í”„ë¡œì„¸ìŠ¤ë§Œ</strong> ì£½ì…ë‹ˆë‹¤. ìì‹Â·ì†ìê¹Œì§€ ë³´ì¥í•˜ì§€ ì•Šì•„ìš”.</li>
    </ul>
  </li>
  <li>
    <p>ê¸°ì¡´ì²˜ëŸ¼ â€œí”„ë¡œì„¸ìŠ¤ ê·¸ë£¹(íŠ¸ë¦¬) ì „ì²´ ì¢…ë£Œâ€ê°€ ëª©ì ì´ë©´, <strong>ìŠ¤í°í•  ë•Œ ê·¸ë£¹ì„ ë¶„ë¦¬</strong> í•´ì•¼ í•©ë‹ˆë‹¤.</p>

    <ul>
      <li>
        <p>POSIX(ë¦¬ëˆ…ìŠ¤/ë§¥): <code class="language-plaintext highlighter-rouge">preexec_fn=os.setsid</code> ëŒ€ì‹  <strong><code class="language-plaintext highlighter-rouge">start_new_session=True</code></strong>ê°€ ê¶Œì¥(ë™ì¼ íš¨ê³¼, ë” ì•ˆì „).</p>
      </li>
      <li>
        <p>ìœˆë„ìš°: <strong><code class="language-plaintext highlighter-rouge">creationflags=subprocess.CREATE_NEW_PROCESS_GROUP</code></strong>ë¡œ ìƒˆ ê·¸ë£¹.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>ì¢…ë£Œí•  ë•ŒëŠ” â€œê·¸ë£¹ ì‹ í˜¸â€ë¥¼ ë³´ë‚´ì•¼ í•©ë‹ˆë‹¤.</p>

    <ul>
      <li>
        <p>POSIX: <code class="language-plaintext highlighter-rouge">os.killpg(pgid, signal.SIGTERM)</code> â†’ ëŒ€ê¸° â†’ í•„ìš” ì‹œ <code class="language-plaintext highlighter-rouge">SIGKILL</code>.</p>
      </li>
      <li>
        <p>ìœˆë„ìš°: <code class="language-plaintext highlighter-rouge">proc.send_signal(signal.CTRL_BREAK_EVENT)</code>(ìƒˆ ê·¸ë£¹ìœ¼ë¡œ ë„ì› ì„ ë•Œë§Œ ë™ì‘) â†’ í•„ìš” ì‹œ <code class="language-plaintext highlighter-rouge">taskkill /T</code>.</p>
      </li>
    </ul>
  </li>
</ol>

<p>ì•„ë˜ëŠ” ì•ì„œ ë§Œë“  Task ë²„ì „ì— â€œê·¸ë£¹ ë¶„ë¦¬ + ê·¸ë£¹ ì¢…ë£Œâ€ë¥¼ ë¶™ì¸ ì˜ˆì‹œì…ë‹ˆë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">subprocess</span>
<span class="kn">import</span> <span class="n">asyncio.subprocess</span> <span class="k">as</span> <span class="n">asp</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_subprocess</span><span class="p">():</span>
    <span class="c1"># 1) í”Œë«í¼ë³„ë¡œ "ìƒˆ ê·¸ë£¹/ì„¸ì…˜"ë¡œ ìŠ¤í°
</span>    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">sys</span><span class="p">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="sh">"</span><span class="s">win32</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="sh">"</span><span class="s">start_new_session</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>          <span class="c1"># == setsid()
</span>    <span class="k">else</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="sh">"</span><span class="s">creationflags</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">CREATE_NEW_PROCESS_GROUP</span>

    <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
        <span class="n">sys</span><span class="p">.</span><span class="n">executable</span><span class="p">,</span> <span class="sh">"</span><span class="s">-u</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-c</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">import time,sys; [print(i) or time.sleep(0.3) for i in range(5)]</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">asp</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">asp</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">out</span><span class="p">.</span><span class="nf">decode</span><span class="p">(),</span> <span class="n">err</span><span class="p">.</span><span class="nf">decode</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
        <span class="c1"># 2) Task ì·¨ì†Œ ì‹œ: ê·¸ë£¹ ë‹¨ìœ„ë¡œ ê¹”ë”íˆ ì¢…ë£Œ
</span>        <span class="k">await</span> <span class="nf">terminate_process_tree</span><span class="p">(</span><span class="n">proc</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="c1"># ë‹¤ë¥¸ ì˜ˆì™¸ì—ì„œë„ ì •ë¦¬ ë³´ì¥
</span>        <span class="k">await</span> <span class="nf">terminate_process_tree</span><span class="p">(</span><span class="n">proc</span><span class="p">)</span>
        <span class="k">raise</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">terminate_process_tree</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">sys</span><span class="p">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="sh">"</span><span class="s">win32</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">killpg</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="p">.</span><span class="n">SIGTERM</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">ProcessLookupError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">(),</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">killpg</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="p">.</span><span class="n">SIGKILL</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">ProcessLookupError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">proc</span><span class="p">.</span><span class="nf">send_signal</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">CTRL_BREAK_EVENT</span><span class="p">)</span>  <span class="c1"># CREATE_NEW_PROCESS_GROUP í•„ìš”
</span>        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">(),</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="c1"># ìµœí›„ ìˆ˜ë‹¨: í•˜ìœ„ íŠ¸ë¦¬ê¹Œì§€ ê°•ì œ ì¢…ë£Œ
</span>            <span class="n">subprocess</span><span class="p">.</span><span class="nf">run</span><span class="p">([</span><span class="sh">"</span><span class="s">taskkill</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/F</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/T</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/PID</span><span class="sh">"</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="n">pid</span><span class="p">)],</span>
                           <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">run_subprocess</span><span class="p">())</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">RC:</span><span class="sh">"</span><span class="p">,</span> <span class="n">rc</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
        <span class="n">task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">task</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">pass</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<h3 id="ê²°ë¡ ">ê²°ë¡ </h3>

<ul>
  <li>
    <p>â€œê·¸ëƒ¥ ê·¸ í”„ë¡œì„¸ìŠ¤ í•˜ë‚˜ë§Œâ€ ì¢…ë£Œí•´ë„ ëœë‹¤ë©´ <code class="language-plaintext highlighter-rouge">start_new_session</code>/<code class="language-plaintext highlighter-rouge">CREATE_NEW_PROCESS_GROUP</code>ëŠ” ë¶ˆí•„ìš”.</p>
  </li>
  <li>
    <p><strong>ê³¼ê±°ì²˜ëŸ¼ íŠ¸ë¦¬ ì „ì²´ë¥¼ í™•ì‹¤íˆ ì¢…ë£Œ</strong> í•´ì•¼ í•œë‹¤ë©´, ìœ„ì²˜ëŸ¼ <strong>ìŠ¤í° ì‹œ ê·¸ë£¹ ë¶„ë¦¬ + ê·¸ë£¹ ì¢…ë£Œ ë£¨í‹´</strong> ì„ ê·¸ëŒ€ë¡œ ë„£ì–´ì£¼ì„¸ìš”.</p>
  </li>
  <li>
    <p>POSIXì—ì„  <code class="language-plaintext highlighter-rouge">start_new_session=True</code>ê°€ <code class="language-plaintext highlighter-rouge">preexec_fn=os.setsid</code>ì˜ ì•ˆì „í•œ ëŒ€ì²´ì…ë‹ˆë‹¤.</p>
  </li>
</ul>

<p class="chat--user">

íƒ€ì´ë¨¸ë¥¼ ë”°ë¡œ taskë¡œ ë§Œë“¤ì–´ì„œ subprocess task, timeout task ë‘ ê°œë¥¼ ê·¸ë£¹ìœ¼ë¡œ ì‹¤í–‰ì‹œí‚¤ëŠ” ë°©ì‹ìœ¼ë¡œ ë§Œë“¤ì–´ì¤˜. íƒ€ì„ì•„ì›ƒì´ ë˜ë©´ ìì† í”„ë¡œì„¸ìŠ¤ë„ ë‹¤ ì£½ì—¬ì•¼í•´

</p>

<p>ì¢‹ì•„ìš”â€”â€œíƒ€ì´ë¨¸(Task)ì™€ ì„œë¸Œí”„ë¡œì„¸ìŠ¤(Task)ë¥¼ <strong>ê·¸ë£¹ì²˜ëŸ¼ í•¨ê»˜ ëŒë¦¬ê³ </strong> , íƒ€ì„ì•„ì›ƒ ì‹œ <strong>í”„ë¡œì„¸ìŠ¤ íŠ¸ë¦¬ ì „ì²´</strong> ë¥¼ ì¢…ë£Œâ€í•˜ëŠ” íŒ¨í„´ì„ ê¹”ë”íˆ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤. ê·¸ëŒ€ë¡œ ë¶™ì—¬ ì“°ì„¸ìš”.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">subprocess</span>
<span class="kn">import</span> <span class="n">asyncio.subprocess</span> <span class="k">as</span> <span class="n">asp</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">terminate_process_tree</span><span class="p">(</span><span class="n">proc</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">Process</span><span class="p">,</span> <span class="n">graceful_timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">procë¥¼ </span><span class="sh">'</span><span class="s">ê·¸ë£¹ ë‹¨ìœ„</span><span class="sh">'</span><span class="s">ë¡œ ì¢…ë£Œ. ì•ˆ ì£½ìœ¼ë©´ ê°•ì œ ì¢…ë£Œê¹Œì§€.</span><span class="sh">"""</span>
    <span class="k">if</span> <span class="n">sys</span><span class="p">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="sh">"</span><span class="s">win32</span><span class="sh">"</span><span class="p">:</span>
        <span class="c1"># ìƒˆ ì„¸ì…˜ìœ¼ë¡œ ë„ì› ë‹¤ëŠ” ê°€ì •(start_new_session=True)
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">killpg</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="p">.</span><span class="n">SIGTERM</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">ProcessLookupError</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">graceful_timeout</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">killpg</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="p">.</span><span class="n">SIGKILL</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">ProcessLookupError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># CREATE_NEW_PROCESS_GROUPë¡œ ë„ì› ë‹¤ëŠ” ê°€ì •
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">proc</span><span class="p">.</span><span class="nf">send_signal</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">CTRL_BREAK_EVENT</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">graceful_timeout</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="c1"># ìµœí›„ ìˆ˜ë‹¨: íŠ¸ë¦¬ê¹Œì§€ ëª¨ë‘ ê°•ì œ ì¢…ë£Œ
</span>            <span class="n">subprocess</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
                <span class="p">[</span><span class="sh">"</span><span class="s">taskkill</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/F</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/T</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/PID</span><span class="sh">"</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="n">pid</span><span class="p">)],</span>
                <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">()</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_with_timeout</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    íƒ€ì´ë¨¸ Taskì™€ ì„œë¸Œí”„ë¡œì„¸ìŠ¤ Taskë¥¼ ë™ì‹œì— ëŒë¦¬ë˜,
    íƒ€ì„ì•„ì›ƒì´ ë¨¼ì € ëë‚˜ë©´ </span><span class="sh">'</span><span class="s">í”„ë¡œì„¸ìŠ¤ íŠ¸ë¦¬</span><span class="sh">'</span><span class="s">ë¥¼ ì¢…ë£Œí•œë‹¤.
    ë°˜í™˜: (timed_out: bool, returncode, stdout_str, stderr_str)
    </span><span class="sh">"""</span>
    <span class="c1"># 1) í”„ë¡œì„¸ìŠ¤ë¥¼ "ìƒˆ ê·¸ë£¹/ì„¸ì…˜"ìœ¼ë¡œ ìŠ¤í° (ìì† ì¼ê´„ ì¢…ë£Œë¥¼ ìœ„í•´ í•„ìˆ˜)
</span>    <span class="n">spawn_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">sys</span><span class="p">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="sh">"</span><span class="s">win32</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">spawn_kwargs</span><span class="p">[</span><span class="sh">"</span><span class="s">start_new_session</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>          <span class="c1"># == setsid()
</span>    <span class="k">else</span><span class="p">:</span>
        <span class="n">spawn_kwargs</span><span class="p">[</span><span class="sh">"</span><span class="s">creationflags</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">CREATE_NEW_PROCESS_GROUP</span>

    <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
        <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">asp</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">stderr</span><span class="o">=</span><span class="n">asp</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="o">**</span><span class="n">spawn_kwargs</span>
    <span class="p">)</span>

    <span class="c1"># 2) ë‘ ê°œì˜ Taskë¥¼ ê·¸ë£¹ì²˜ëŸ¼ í•¨ê»˜ ì‹¤í–‰
</span>    <span class="n">proc_task</span>  <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">proc-communicate</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">timer_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">timeout</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">timeout-timer</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">done</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span>
        <span class="p">{</span><span class="n">proc_task</span><span class="p">,</span> <span class="n">timer_task</span><span class="p">},</span>
        <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span>
    <span class="p">)</span>

    <span class="c1"># 3) íƒ€ì´ë¨¸ê°€ ë¨¼ì € ëë‚¨ â†’ íŠ¸ë¦¬ ì¢…ë£Œ í›„ ê²°ê³¼ ì •ë¦¬
</span>    <span class="k">if</span> <span class="n">timer_task</span> <span class="ow">in</span> <span class="n">done</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">proc_task</span><span class="p">.</span><span class="nf">done</span><span class="p">():</span>
        <span class="c1"># í”„ë¡œì„¸ìŠ¤ íŠ¸ë¦¬ ì¢…ë£Œ
</span>        <span class="k">await</span> <span class="nf">terminate_process_tree</span><span class="p">(</span><span class="n">proc</span><span class="p">)</span>
        <span class="c1"># í†µì‹  Task ì·¨ì†Œ (í˜¹ì‹œ ë‚¨ì•„ìˆë‹¤ë©´)
</span>        <span class="n">proc_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">proc_task</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">""</span>  <span class="c1"># timed_out=True
</span>
    <span class="c1"># 4) í”„ë¡œì„¸ìŠ¤ê°€ ë¨¼ì € ëë‚¨ â†’ íƒ€ì´ë¨¸ ì·¨ì†Œ í›„ ê²°ê³¼ ë°˜í™˜
</span>    <span class="n">timer_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">timer_task</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">proc_task</span>  <span class="c1"># bytes
</span>    <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ------------------ ì‚¬ìš© ì˜ˆì‹œ ------------------
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># ì˜ˆ: 0.3ì´ˆ ê°„ê²©ìœ¼ë¡œ 5ì¤„ ì¶œë ¥í•˜ëŠ” í•˜ìœ„ íŒŒì´ì¬ì„ 1ì´ˆ íƒ€ì„ì•„ì›ƒìœ¼ë¡œ ì‹¤í–‰
</span>    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="p">.</span><span class="n">executable</span><span class="p">,</span> <span class="sh">"</span><span class="s">-u</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-c</span><span class="sh">"</span><span class="p">,</span>
           <span class="sh">"</span><span class="s">import time,sys; [print(i) or sys.stdout.flush() or time.sleep(0.3) for i in range(5)]</span><span class="sh">"</span><span class="p">]</span>

    <span class="n">timed_out</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_with_timeout</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">timed_out</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[TIMEOUT] í•˜ìœ„ í”„ë¡œì„¸ìŠ¤ íŠ¸ë¦¬ë¥¼ ëª¨ë‘ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">RC:</span><span class="sh">"</span><span class="p">,</span> <span class="n">rc</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDOUT:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDERR:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<h3 id="í•µì‹¬-í¬ì¸íŠ¸-ìš”ì•½">í•µì‹¬ í¬ì¸íŠ¸ (ìš”ì•½)</h3>

<ul>
  <li>
    <p><strong>ë‘ Taskë¥¼ ê·¸ë£¹ì²˜ëŸ¼</strong> : <code class="language-plaintext highlighter-rouge">proc.communicate()</code> Taskì™€ <code class="language-plaintext highlighter-rouge">asyncio.sleep(timeout)</code> Taskë¥¼ <code class="language-plaintext highlighter-rouge">asyncio.wait(..., FIRST_COMPLETED)</code>ë¡œ ê²½í•©ì‹œí‚µë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>íƒ€ì„ì•„ì›ƒ ê²½ë¡œ</strong> : íƒ€ì´ë¨¸ê°€ ë¨¼ì € ëë‚˜ë©´ <code class="language-plaintext highlighter-rouge">terminate_process_tree()</code>ë¡œ <strong>í”„ë¡œì„¸ìŠ¤ ê·¸ë£¹(íŠ¸ë¦¬)</strong>ì„ ì¢…ë£Œ â†’ í†µì‹  Task ì·¨ì†Œ.</p>
  </li>
  <li>
    <p><strong>í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ ê²½ë¡œ</strong> : í”„ë¡œì„¸ìŠ¤ê°€ ë¨¼ì € ëë‚˜ë©´ íƒ€ì´ë¨¸ Taskë§Œ ì·¨ì†Œ.</p>
  </li>
  <li>
    <p><strong>íŠ¸ë¦¬ ì¢…ë£Œë¥¼ ìœ„í•´ ìŠ¤í° ì˜µì…˜ í•„ìˆ˜</strong></p>

    <ul>
      <li>
        <p>POSIX: <code class="language-plaintext highlighter-rouge">start_new_session=True</code> (â‰’ <code class="language-plaintext highlighter-rouge">preexec_fn=os.setsid</code>)</p>
      </li>
      <li>
        <p>Windows: <code class="language-plaintext highlighter-rouge">creationflags=CREATE_NEW_PROCESS_GROUP</code></p>
      </li>
    </ul>
  </li>
  <li>
    <p>Windowsì—ì„  <code class="language-plaintext highlighter-rouge">CTRL_BREAK_EVENT</code> â†’ ë¶ˆì‘ ì‹œ <code class="language-plaintext highlighter-rouge">taskkill /T</code>ë¡œ ê°•ì œ ì •ë¦¬.</p>
  </li>
</ul>

<p>ì´ íŒ¨í„´ì´ë©´ â€œíƒ€ì´ë¨¸ë¥¼ ë³„ë„ Taskë¡œ ë‘ê³ , íƒ€ì„ì•„ì›ƒ ì‹œ ìì†ê¹Œì§€ ì „ë¶€ ì¢…ë£Œâ€ ìš”êµ¬ì‚¬í•­ì„ ê·¸ëŒ€ë¡œ ì¶©ì¡±í•©ë‹ˆë‹¤.</p>]]></content><author><name>hvppyarchive</name></author><category term="python" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">Async request ì·¨ì†Œ ì²˜ë¦¬</title><link href="https://hvppyarchive.github.io/comfyui/async-request-cancel/" rel="alternate" type="text/html" title="Async request ì·¨ì†Œ ì²˜ë¦¬" /><published>2025-10-10T11:53:02+09:00</published><updated>2025-10-10T11:53:02+09:00</updated><id>https://hvppyarchive.github.io/comfyui/async-request-cancel</id><content type="html" xml:base="https://hvppyarchive.github.io/comfyui/async-request-cancel/"><![CDATA[<p class="chat--user">

comfyuiì—ì„œ custom nodeì˜ ë©”ì¸ í•¨ìˆ˜ë¥¼ asyncë¡œ ë§Œë“¤ ìˆ˜ ìˆê²Œ ë˜ì—ˆì–´. ê·¸ë¦¬ê³ , openai python íŒ¨í‚¤ì§€ì—ì„œ AsyncOpenAIì™€ aiohttpë¥¼ ì´ìš©í•´ì„œ asyncí•˜ê²Œ requestë¥¼ ë³´ë‚¼ ìˆ˜ ìˆì–´. ê·¼ë° ë¬¸ì œëŠ” UIì—ì„œ stopì„ ë³´ë‚´ê³  interruptê°€ ì¦‰ì‹œ ë™ì‘í•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ”ê±°ì•¼. requestë¥¼ ë³´ë‚¸ í›„ await í•˜ëŠ” ë„ì¤‘ì— ì‘ì—…ì´ ì·¨ì†Œë˜ê²Œ í•˜ê³  ì‹¶ì–´

</p>

<p>ì¢‹ì•„, í•µì‹¬ì€ â€œë„¤íŠ¸ì›Œí¬ ìš”ì²­ await ì¤‘ì—ë„ ë°”ë¡œ ëŠê¸°ê²Œâ€ ë§Œë“œëŠ” ê±°ì•¼.<br />
asyncioì—ì„œëŠ” <strong>ì·¨ì†Œ ì‹ í˜¸ì™€ ì‹¤ì œ ì‘ì—…ì„ â€˜ê²½ìŸ(race)â€™</strong> ì‹œí‚¤ë©´ ë¼. ì¦‰, ìš”ì²­ì„ <code class="language-plaintext highlighter-rouge">Task</code>ë¡œ ë§Œë“¤ê³ , UIì—ì„œ ì˜¤ëŠ” stop ì‹ í˜¸(ì´í•˜ <code class="language-plaintext highlighter-rouge">stop_event</code>)ì˜ <code class="language-plaintext highlighter-rouge">wait()</code>ë„ <code class="language-plaintext highlighter-rouge">Task</code>ë¡œ ë§Œë“¤ì–´ì„œ <strong>ë‘˜ ì¤‘ ë¨¼ì € ëë‚˜ëŠ” ìª½</strong> ì„ ë³´ê³  í–‰ë™ì„ ë°”ê¾¸ë©´ ì¦‰ì‹œ ì¤‘ë‹¨ì´ ê°€ëŠ¥í•´.</p>

<p>ì•„ë˜ë¥¼ ê·¸ëŒ€ë¡œ ê°€ì ¸ë‹¤ ì“¸ ìˆ˜ ìˆê²Œ ë‹¨ê³„ë³„(ê·¸ë¦¬ê³  ì•ˆì „í•œ) íŒ¨í„´ìœ¼ë¡œ ì •ë¦¬í–ˆì–´.</p>

<hr />

<h1 id="1-ê³µí†µ-ìœ í‹¸-ì·¨ì†Œ-ê°€ëŠ¥í•œ-await-ë˜í¼">1) ê³µí†µ ìœ í‹¸: ì·¨ì†Œ ê°€ëŠ¥í•œ await ë˜í¼</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>

<span class="k">class</span> <span class="nc">StopByUser</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">UI stop/interruptë¡œ ì¤‘ë‹¨ë˜ì—ˆìŒì„ ë‚˜íƒ€ë‚´ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ ì˜ˆì™¸.</span><span class="sh">"""</span>
    <span class="k">pass</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">await_cancellable</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    coro(ì½”ë£¨í‹´)ì™€ stop_event.wait()ë¥¼ ê²½ìŸì‹œí‚¨ë‹¤.
    - stopì´ ë¨¼ì € ì˜¤ë©´ coro Taskë¥¼ cancelí•˜ê³  ì •ë¦¬í•œ ë’¤ StopByUserë¥¼ ì˜¬ë¦°ë‹¤.
    - ìš”ì²­ì´ ë¨¼ì € ëë‚˜ë©´ stop ëŒ€ê¸° Taskë¥¼ ì·¨ì†Œí•˜ê³  ê²°ê³¼ë¥¼ ë°˜í™˜í•œë‹¤.
    </span><span class="sh">"""</span>
    <span class="n">req_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">coro</span><span class="p">)</span>
    <span class="n">stop_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">stop_event</span><span class="p">.</span><span class="nf">wait</span><span class="p">())</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">done</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span>
            <span class="p">{</span><span class="n">req_task</span><span class="p">,</span> <span class="n">stop_task</span><span class="p">},</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">stop_task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
            <span class="c1"># UIê°€ stopì„ ëˆŒë €ë‹¤: ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì„ ì·¨ì†Œ
</span>            <span class="n">req_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
            <span class="c1"># ì·¨ì†Œ ì •ë¦¬ ëê¹Œì§€ ê¸°ë‹¤ë ¤ ê²½ê³ /ë¦¬ì†ŒìŠ¤ ëˆ„ìˆ˜ ë°©ì§€
</span>            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">req_task</span>
            <span class="k">raise</span> <span class="nc">StopByUser</span><span class="p">(</span><span class="sh">"</span><span class="s">Stopped by user</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># ìš”ì²­ì´ ë¨¼ì € ëë‚¨: stop ëŒ€ê¸°ëŠ” ì·¨ì†Œ
</span>        <span class="n">stop_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">stop_task</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">req_task</span>  <span class="c1"># ê²°ê³¼ ë¦¬í„´
</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
        <span class="c1"># ë°”ê¹¥ ì»¨í…ìŠ¤íŠ¸(ComfyUI ì‹¤í–‰ê¸°)ê°€ ì´ Task ìì²´ë¥¼ ì·¨ì†Œí•œ ê²½ìš°: ë°”ë¡œ ì „íŒŒ
</span>        <span class="k">raise</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># í˜¹ì‹œ ë‚¨ì•„ìˆìœ¼ë©´ í™•ì‹¤íˆ ì •ë¦¬
</span>        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="n">req_task</span><span class="p">,</span> <span class="n">stop_task</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">.</span><span class="nf">done</span><span class="p">():</span>
                <span class="n">t</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">t</span>
</code></pre></div></div>

<blockquote>
  <p>ì¤‘ìš”: ì½”ë“œ ì–´ë”˜ê°€ì— <code class="language-plaintext highlighter-rouge">except Exception:</code> ê°™ì€ ê´‘ë²”ìœ„í•œ ì˜ˆì™¸ ì²˜ë¦¬ê¸°ê°€ ìˆë‹¤ë©´, <strong>ë°˜ë“œì‹œ</strong><br />
 <code class="language-plaintext highlighter-rouge">except asyncio.CancelledError: raise</code> ë¥¼ <strong>ë§¨ ìœ„ì— ë”°ë¡œ</strong> ë‘ì–´ ì·¨ì†Œê°€ ì‚¼ì¼œì§€ì§€ ì•Šê²Œ í•˜ì„¸ìš”.<br />
 (íŒŒì´ì¬ ë²„ì „ì— ë”°ë¼ <code class="language-plaintext highlighter-rouge">CancelledError</code>ê°€ ì¼ë°˜ <code class="language-plaintext highlighter-rouge">Exception</code>ì— ì¡í ìˆ˜ ìˆìœ¼ë‹ˆ ëª…ì‹œì ìœ¼ë¡œ ë¶„ê¸°í•˜ëŠ” ê²Œ ì•ˆì „í•©ë‹ˆë‹¤.)</p>
</blockquote>

<hr />

<h1 id="2-comfyui-ì»¤ìŠ¤í…€-ë…¸ë“œmainasyncì—ì„œ-ì ìš©">2) ComfyUI ì»¤ìŠ¤í…€ ë…¸ë“œ(main=async)ì—ì„œ ì ìš©</h1>

<p>ComfyUIê°€ stopì„ ëˆ„ë¥´ë©´ ë‚´ë¶€ì ìœ¼ë¡œ â€œì¤‘ë‹¨ í”Œë˜ê·¸/ì´ë²¤íŠ¸â€ê°€ ì¼œì§ˆ í…ë°, ê·¸ê±¸ <code class="language-plaintext highlighter-rouge">stop_event</code>(asyncio.Event í˜¸í™˜)ë¡œ ë°›ëŠ”ë‹¤ê³  ê°€ì •í•´ ë³´ì.<br />
(ComfyUIì—ì„œ ì œê³µí•˜ëŠ” ì‹¤ì œ ì¸í„°ëŸ½íŠ¸ ì‹ í˜¸ë¥¼ ì–´ë–»ê²Œ ì–»ëŠ”ì§€ëŠ” í”„ë¡œì íŠ¸ë§ˆë‹¤ ë‹¤ë¥¼ ìˆ˜ ìˆì–´. ë…¸ë“œì— ì£¼ì… ë°›ê±°ë‚˜, ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸ì—ì„œ êº¼ë‚´ ì“°ëŠ” ì‹ìœ¼ë¡œ ì—°ê²°í•´ ì£¼ë©´ ëœë‹¤.)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>

<span class="k">class</span> <span class="nc">AsyncLLMNode</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">prompt</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">})}}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">main</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LLM</span><span class="sh">"</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">stop_event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c1"># stop_eventëŠ” ComfyUI ìª½ì—ì„œ ë„˜ê²¨ì£¼ë„ë¡ ì—°ê²°í•´ ë‘ëŠ” ê±¸ ê¶Œì¥
</span>        <span class="k">if</span> <span class="n">stop_event</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># ìµœì•…ì˜ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ë”ë¯¸ (ì¦‰ì‹œ ì™„ë£Œë˜ì§€ ì•ŠìŒ)
</span>            <span class="n">stop_event</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Event</span><span class="p">()</span>

        <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">()</span>  <span class="c1"># í•„ìš”ì‹œ api_key, base_url ë“± ì„¤ì •
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># â—‡ ë¹„-ìŠ¤íŠ¸ë¦¬ë° ìš”ì²­ ì˜ˆì‹œ
</span>            <span class="n">coro</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
                <span class="n">temperature</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">await_cancellable</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span><span class="p">.</span><span class="n">content</span>
            <span class="nf">return </span><span class="p">(</span><span class="n">text</span><span class="p">,)</span>

        <span class="k">except</span> <span class="n">StopByUser</span><span class="p">:</span>
            <span class="c1"># ComfyUIê°€ ì¦‰ì‹œ ë©ˆì·„ìŒì„ ìœ„ìª½ìœ¼ë¡œ ì•Œë¦¬ê±°ë‚˜, ë¹ˆ ê²°ê³¼/ìƒíƒœ ë©”ì‹œì§€ë¥¼ ë°˜í™˜
</span>            <span class="c1"># ComfyUI ìª½ ì •ì±…ì— ë§ì¶° raise/return ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒ
</span>            <span class="k">raise</span>  <span class="c1"># ë³´í†µì€ raiseë¡œ ì „íŒŒí•˜ëŠ” ê²Œ ì¸í„°ëŸ½íŠ¸ ì²´ì¸ì— ì¶©ì‹¤
</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="c1"># ë°”ê¹¥ì—ì„œ Task ìì²´ê°€ ì·¨ì†Œëœ ê²½ìš°
</span>            <span class="k">raise</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># http ì»¤ë„¥ì…˜ ì •ë¦¬
</span>            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="3-ìŠ¤íŠ¸ë¦¬ë°ë¶€ë¶„-ì‘ë‹µì¼-ë•Œë„-ì¦‰ì‹œ-ì¤‘ë‹¨">3) ìŠ¤íŠ¸ë¦¬ë°(ë¶€ë¶„ ì‘ë‹µ)ì¼ ë•Œë„ ì¦‰ì‹œ ì¤‘ë‹¨</h1>

<p>ìŠ¤íŠ¸ë¦¬ë°ì€ ë‚´ë¶€ì ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">async for</code>ë¡œ ì²­í¬ë¥¼ ì½ëŠ” ë™ì•ˆ <code class="language-plaintext highlighter-rouge">__anext__()</code>ì—ì„œ ë¸”ë¡ë¼ì„œ<br />
stopì„ ëˆŒëŸ¬ë„ ë°”ë¡œ ë°˜ì‘ì„ ëª»í•  ìˆ˜ ìˆì–´. ì´ë•Œë„ <strong>chunk ì½ê¸° vs stop</strong> ë¥¼ ê²½ìŸì‹œí‚¤ë©´ í•´ê²°ë¼.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">stream_chat_cancellable</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">):</span>
    <span class="c1"># ìƒˆë¡œìš´ Responses API ì˜ˆì‹œ (í•„ìš”ì— ë§ì¶° Chat Completionsë¡œ ë°”ê¿”ë„ ë™ì¼ íŒ¨í„´)
</span>    <span class="k">async</span> <span class="k">with</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">stream</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
        <span class="n">aiter</span> <span class="o">=</span> <span class="n">stream</span><span class="p">.</span><span class="nf">aiter_text</span><span class="p">()</span>  <span class="c1"># í…ìŠ¤íŠ¸ ì²­í¬ ì´í„°ë ˆì´í„°
</span>        <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">next_chunk</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">aiter</span><span class="p">.</span><span class="nf">__anext__</span><span class="p">())</span>
            <span class="n">stop_task</span>  <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">stop_event</span><span class="p">.</span><span class="nf">wait</span><span class="p">())</span>
            <span class="n">done</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span>
                <span class="p">{</span><span class="n">next_chunk</span><span class="p">,</span> <span class="n">stop_task</span><span class="p">},</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">stop_task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="c1"># ì½ê¸° ì¤‘ë‹¨ + ì—°ê²° ì •ë¦¬
</span>                <span class="n">next_chunk</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">next_chunk</span>
                <span class="k">await</span> <span class="n">stream</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>  <span class="c1"># ì„œë²„ ìª½ ìŠ¤íŠ¸ë¦¼ë„ ë‹«ê¸°
</span>                <span class="k">raise</span> <span class="nc">StopByUser</span><span class="p">(</span><span class="sh">"</span><span class="s">Stopped by user</span><span class="sh">"</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">next_chunk</span><span class="p">.</span><span class="nf">result</span><span class="p">())</span>
            <span class="k">except</span> <span class="nb">StopAsyncIteration</span><span class="p">:</span>
                <span class="c1"># ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ
</span>                <span class="k">break</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">stop_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">stop_task</span>

        <span class="k">return</span> <span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>
</code></pre></div></div>

<p>ComfyUI ë…¸ë“œì—ì„œ:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">stop_event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">stop_event</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">stop_event</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Event</span><span class="p">()</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">stream_chat_cancellable</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">text</span><span class="p">,)</span>
    <span class="k">except</span> <span class="n">StopByUser</span><span class="p">:</span>
        <span class="k">raise</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="4-aiohttp-ìˆœìˆ˜-ì‚¬ìš©-ì‹œ-ì˜ˆì‹œ">4) aiohttp ìˆœìˆ˜ ì‚¬ìš© ì‹œ ì˜ˆì‹œ</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">aiohttp</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>
<span class="kn">from</span> <span class="n">yarl</span> <span class="kn">import</span> <span class="n">URL</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">fetch_json_cancellable</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="p">.</span><span class="nc">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="c1"># POST ì½”ë£¨í‹´ ìƒì„±
</span>        <span class="k">async</span> <span class="k">def</span> <span class="nf">do_post</span><span class="p">():</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
                <span class="n">resp</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">resp</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>

        <span class="k">return</span> <span class="k">await</span> <span class="nf">await_cancellable</span><span class="p">(</span><span class="nf">do_post</span><span class="p">(),</span> <span class="n">stop_event</span><span class="p">)</span>
</code></pre></div></div>

<blockquote>
  <p>ì°¸ê³ : <code class="language-plaintext highlighter-rouge">aiohttp</code>ëŠ” Task ì·¨ì†Œ ì‹œ ì†Œì¼“ì„ ë‹«ìœ¼ë©° <code class="language-plaintext highlighter-rouge">CancelledError</code>ê°€ ì „íŒŒë¼ìš”.<br />
 ìœ„ì˜ íŒ¨í„´ì²˜ëŸ¼ <em>í•­ìƒ</em> loser taskë¥¼ <code class="language-plaintext highlighter-rouge">cancel()</code>í•˜ê³  <code class="language-plaintext highlighter-rouge">await</code>í•´ì„œ ê²½ê³  ì—†ì´ ì •ë¦¬í•˜ì„¸ìš”.</p>
</blockquote>

<hr />

<h1 id="5-í”í•œ-ì¦‰ì‹œ-ì¤‘ë‹¨ì´-ì•ˆ-ë˜ëŠ”-ì›ì¸-ì²´í¬ë¦¬ìŠ¤íŠ¸">5) í”í•œ â€œì¦‰ì‹œ ì¤‘ë‹¨ì´ ì•ˆ ë˜ëŠ”â€ ì›ì¸ ì²´í¬ë¦¬ìŠ¤íŠ¸</h1>

<ol>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">CancelledError</code>ë¥¼ ì‚¼í‚¤ëŠ” ì˜ˆì™¸ ì²˜ë¦¬</strong></p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">except Exception:</code> ì´ ìˆë‹¤ë©´ ë°”ë¡œ ìœ„ì— <code class="language-plaintext highlighter-rouge">except asyncio.CancelledError: raise</code> ë¥¼ ì¶”ê°€.</li>
    </ul>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">await</code> ì—†ì´ ë™ê¸° ë¸”ë¡œí‚¹ ì½”ë“œ</strong></p>

    <ul>
      <li>CPU ë°”ìš´ë“œ ë£¨í”„/ë¸”ë¡œí‚¹ I/OëŠ” ì´ë²¤íŠ¸ ë£¨í”„ë¥¼ ë§‰ì•„ ì·¨ì†Œê°€ ëŠ¦ì–´ì§ â†’ <code class="language-plaintext highlighter-rouge">await</code> ê°€ëŠ¥í•œ APIë¡œ ë°”ê¾¸ê±°ë‚˜, <code class="language-plaintext highlighter-rouge">run_in_executor()</code>ë¡œ ë¶„ë¦¬.</li>
    </ul>
  </li>
  <li>
    <p><strong>ìŠ¤íŠ¸ë¦¬ë° ë£¨í”„ì—ì„œ stopì„ ì•ˆ ë³´ê³  ìˆìŒ</strong></p>

    <ul>
      <li>ìœ„ì˜ â€œìŠ¤íŠ¸ë¦¬ë° ê²½ìŸâ€ íŒ¨í„´ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">__anext__()</code>ì™€ <code class="language-plaintext highlighter-rouge">stop_event.wait()</code>ë¥¼ ê²½ìŸì‹œí‚¤ê¸°.</li>
    </ul>
  </li>
  <li>
    <p><strong>ì •ë¦¬(cleanup)ë¥¼ ì·¨ì†Œê°€ ë®ì–´ë²„ë¦¼</strong></p>

    <ul>
      <li>ì •ë¦¬ ê³¼ì •ì€ <code class="language-plaintext highlighter-rouge">asyncio.shield()</code>ë¡œ ê°ì‹¸ê±°ë‚˜ <code class="language-plaintext highlighter-rouge">with contextlib.suppress(asyncio.CancelledError)</code>ë¡œ ë§ˆë¬´ë¦¬.</li>
    </ul>
  </li>
  <li>
    <p><strong>ê¸´ ë„¤íŠ¸ì›Œí¬ íƒ€ì„ì•„ì›ƒ</strong></p>

    <ul>
      <li>ì·¨ì†Œ ìì²´ëŠ” íƒ€ì„ì•„ì›ƒê³¼ ë¬´ê´€í•˜ì§€ë§Œ, ë¼ì´ë¸ŒëŸ¬ë¦¬ ì •ë¦¬ê°€ ì§€ì—°ë  ìˆ˜ ìˆìŒ â†’ ì„¸ì…˜/ìŠ¤íŠ¸ë¦¼ì„ <code class="language-plaintext highlighter-rouge">close()</code> í•´ì£¼ê¸°.</li>
    </ul>
  </li>
</ol>

<hr />

<h1 id="6-comfyui-ìª½-stop_event-ì—°ê²°-íŒ">6) ComfyUI ìª½ â€˜stop_eventâ€™ ì—°ê²° íŒ</h1>

<ul>
  <li>
    <p>í”„ë¡œì íŠ¸ì— ë”°ë¼ ë‹¤ë¥´ì§€ë§Œ, ë³´í†µ <strong>ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸</strong> ë‚˜ <strong>ë…¸ë“œ ì¸ì ì£¼ì…</strong> ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">asyncio.Event</code>ë¥¼ ë°›ì„ ìˆ˜ ìˆê²Œ í•´ë‘ë©´ ê°€ì¥ ê¹”ë”í•´.</p>
  </li>
  <li>
    <p>ë§Œì•½ ì§€ê¸ˆì€ ê·¸ëŸ° í›…ì´ ì—†ë‹¤ë©´:</p>

    <ul>
      <li>
        <p>ìµœì†Œí•œ ì£¼ê¸°ì ìœ¼ë¡œ í™•ì¸í•˜ëŠ” pollingì„ ë„£ëŠ” ëŒ€ì‹ , <strong>ìœ„ì˜ ê²½ìŸ íŒ¨í„´</strong> ì„ ì‚¬ìš©í•˜ë©´ â€œawait ì¤‘ì—ë„â€ ë°”ë¡œ ë°˜ì‘í•œë‹¤.</p>
      </li>
      <li>
        <p>stopì„ ëˆ„ë¥¼ ë•Œ ë…¸ë“œ ì¸¡ì— <code class="language-plaintext highlighter-rouge">stop_event.set()</code>ì´ í˜¸ì¶œë˜ë„ë¡ ì—°ê²°(ì£¼ì…)ë§Œ í•´ì£¼ë©´ ëœë‹¤.</p>
      </li>
    </ul>
  </li>
</ul>

<hr />

<p>í•„ìš”í•˜ë©´ ë„ˆì˜ í˜„ì¬ ë…¸ë“œ ì½”ë“œ ì¼ë¶€ë¥¼ ë¶™ì—¬ì¤˜. ê±°ê¸°ì— ë§ì¶° <code class="language-plaintext highlighter-rouge">await_cancellable</code>ì„ ë”± ë“¤ì–´ë§ê²Œ ë¦¬íŒ©í„°ë§í•´ ì¤„ê²Œ.</p>

<p class="chat--user">

stop_eventë¥¼ ë„£ëŠ”ë‹¤ëŠ”ê²Œ ë­”ì§€ ëª¨ë¥´ê² ì–´. comfyui ë‚´ë¶€ì ìœ¼ë¡œ interrupt ë²„íŠ¼ì´ ìˆì–ì•„? ê·¸ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ì·¨ì†Œë˜ë©´ ì¢‹ê² ì–´

</p>

<p>ì¢‹ì•„, â€œUIì˜ Interrupt ë²„íŠ¼(ë˜ëŠ” /interrupt)ì´ ëˆŒë¦¬ë©´ ë‚´ async ì»¤ìŠ¤í…€ ë…¸ë“œê°€ ì§€ê¸ˆ <code class="language-plaintext highlighter-rouge">await</code> ì¤‘ì¸ OpenAI ìš”ì²­ì„ ì¦‰ì‹œ ëŠê³  ì‹¶ë‹¤â€ê°€ ëª©í‘œì§€ìš”. í•µì‹¬ì€ <strong>ComfyUIê°€ ì¸í„°ëŸ½íŠ¸ë¥¼ â€œí”Œë˜ê·¸â€ë¡œë§Œ ì•Œë¦¬ê³ , ì‹¤ì œë¡œëŠ” ë…¸ë“œê°€ í˜‘ì¡°ì ìœ¼ë¡œ ì·¨ì†Œë¥¼ ì²˜ë¦¬í•´ì•¼</strong> í•œë‹¤ëŠ” ì ì´ì—ìš”. ì•„ë˜ë¥¼ ê·¸ëŒ€ë¡œ ë„£ìœ¼ë©´ ë©ë‹ˆë‹¤ â€” ë‹¨ê³„ë³„ë¡œ ì„¤ëª…í• ê²Œìš”.</p>

<hr />

<h2 id="1-comfyuiê°€-ì¸í„°ëŸ½íŠ¸ë¥¼-ì–´ë–»ê²Œ-ì•Œë¦¬ëƒ">1) ComfyUIê°€ ì¸í„°ëŸ½íŠ¸ë¥¼ ì–´ë–»ê²Œ ì•Œë¦¬ëƒ</h2>

<ul>
  <li>
    <p>í”„ë¡ íŠ¸ì—”ë“œ Interrupt ë²„íŠ¼/ë‹¨ì¶•í‚¤ê°€ <strong><code class="language-plaintext highlighter-rouge">POST /interrupt</code></strong> ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. ì„œë²„ëŠ” ë‚´ë¶€ ì¸í„°ëŸ½íŠ¸ í”Œë˜ê·¸ë¥¼ ì„¸íŒ…í•´ìš”. <a href="https://docs.comfy.org/development/comfyui-server/comms_routes?utm_source=chatgpt.com">ComfyUI+2</a></p>
  </li>
  <li>
    <p>ì‹¤í–‰ê¸°ëŠ” ë‹¤ìŒ ë…¸ë“œ ê²½ê³„ í˜¹ì€ ë…¸ë“œ ë‚´ë¶€ì—ì„œ ì²´í¬ë  ë•Œ <strong><code class="language-plaintext highlighter-rouge">InterruptProcessingException</code></strong> ìœ¼ë¡œ ì¤‘ë‹¨ì„ ì „íŒŒí•˜ê³ , ì›¹ì†Œì¼“ ì´ë²¤íŠ¸ <strong><code class="language-plaintext highlighter-rouge">execution_interrupted</code></strong> ë¥¼ ë³´ëƒ…ë‹ˆë‹¤. <a href="https://docs.comfy.org/development/comfyui-server/comms_messages?utm_source=chatgpt.com">ComfyUI</a></p>
  </li>
  <li>
    <p>ë‹¨, <strong>ë…¸ë“œê°€ ë¸”ë¡œí‚¹ ìƒíƒœ(íƒ€ì´íŠ¸ ë£¨í”„/ë¸”ë¡œí‚¹ I/O)</strong> ë©´ ì¸í„°ëŸ½íŠ¸ê°€ ë°”ë¡œ ì²˜ë¦¬ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ ë…¸ë“œê°€ <strong>ì£¼ê¸°ì ìœ¼ë¡œ ì¸í„°ëŸ½íŠ¸ë¥¼ ì²´í¬</strong> í•˜ê±°ë‚˜ <strong><code class="language-plaintext highlighter-rouge">await</code> ë¥¼ ì·¨ì†Œ</strong>í•´ ì¤˜ì•¼ í•´ìš”. <a href="https://github.com/comfyanonymous/ComfyUI/issues/3131?utm_source=chatgpt.com">GitHub</a></p>
  </li>
</ul>

<hr />

<h2 id="2-ì»¤ìŠ¤í…€-ë…¸ë“œì—ì„œ-í˜‘ì¡°ì -ì·¨ì†Œë¥¼-ë¶™ì´ëŠ”-ê°€ì¥-ì‰¬ìš´-ë°©ë²•">2) ì»¤ìŠ¤í…€ ë…¸ë“œì—ì„œ â€œí˜‘ì¡°ì  ì·¨ì†Œâ€ë¥¼ ë¶™ì´ëŠ” ê°€ì¥ ì‰¬ìš´ ë°©ë²•</h2>

<p>ComfyUIëŠ” <code class="language-plaintext highlighter-rouge">comfy.model_management.throw_exception_if_processing_interrupted()</code> ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ì´ê±¸ ì£¼ê¸°ì ìœ¼ë¡œ í˜¸ì¶œí•˜ë©´ ì¸í„°ëŸ½íŠ¸ ì‹œ <code class="language-plaintext highlighter-rouge">InterruptProcessingException</code> ì„ ë˜ì ¸ìš”. (ê³µì‹ ì½”ë“œì™€ ì—¬ëŸ¬ ì˜ˆì‹œ ë…¸ë“œì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤.) <a href="https://gitee.com/bug531/comfy-ui/blob/master/main.py?skip_mobile=true&amp;utm_source=chatgpt.com">Gitee+2</a></p>

<p>ì•„ì´ë””ì–´: <strong>ìš”ì²­ íƒœìŠ¤í¬</strong> ì™€ <strong>ì¸í„°ëŸ½íŠ¸ ê°ì‹œ íƒœìŠ¤í¬</strong> ë¥¼ ë™ì‹œì— ëŒë¦¬ê³ , ê°ì§€ë˜ë©´ ìš”ì²­ íƒœìŠ¤í¬ë¥¼ <code class="language-plaintext highlighter-rouge">cancel()</code>ë¡œ ëŠìŠµë‹ˆë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ì»¤ìŠ¤í…€ ë…¸ë“œ íŒŒì¼ ì•ˆ
</span><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">aiohttp</span>
<span class="kn">import</span> <span class="n">comfy.model_management</span> <span class="k">as</span> <span class="n">mm</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">_watch_interrupt_and_cancel</span><span class="p">(</span><span class="n">task</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">ComfyUI ì¸í„°ëŸ½íŠ¸ê°€ ì˜¤ë©´ ì£¼ì–´ì§„ taskë¥¼ cancel()</span><span class="sh">"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">task</span><span class="p">.</span><span class="nf">done</span><span class="p">():</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>  <span class="c1"># í´ë§ ì£¼ê¸°
</span>            <span class="n">mm</span><span class="p">.</span><span class="nf">throw_exception_if_processing_interrupted</span><span class="p">()</span>  <span class="c1"># ì¸í„°ëŸ½íŠ¸ë©´ ì˜ˆì™¸ ë°œìƒ
</span>    <span class="k">except</span> <span class="n">mm</span><span class="p">.</span><span class="n">InterruptProcessingException</span><span class="p">:</span>
        <span class="n">task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>  <span class="c1"># ë©”ì¸ ìš”ì²­ ì·¨ì†Œ
</span>
<span class="k">class</span> <span class="nc">MyAsyncNode</span><span class="p">:</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">example</span><span class="sh">"</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">prompt</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">})}}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">()</span>  <span class="c1"># í•„ìš” ì‹œ api_key, base_url, timeout ë“± ì„¤ì •
</span>
        <span class="c1"># 1) OpenAI ë¹„ë™ê¸° ìš”ì²­ì„ íƒœìŠ¤í¬ë¡œ ìƒì„±
</span>        <span class="n">req_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span>
            <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>          <span class="c1"># ì„ íƒ: ìš”ì²­ íƒ€ì„ì•„ì›ƒ
</span>                <span class="n">max_retries</span><span class="o">=</span><span class="mi">0</span>         <span class="c1"># ì„ íƒ: ì¬ì‹œë„ ë¹„í™œì„±í™”(ì·¨ì†Œ ì‘ë‹µì„ ë¹ ë¥´ê²Œ)
</span>            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># 2) ì¸í„°ëŸ½íŠ¸ ê°ì‹œ íƒœìŠ¤í¬ ì‹œì‘
</span>        <span class="n">watcher</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">_watch_interrupt_and_cancel</span><span class="p">(</span><span class="n">req_task</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 3) ê²°ê³¼ ëŒ€ê¸° â€” ì¸í„°ëŸ½íŠ¸ ì‹œ req_taskê°€ CancelledErrorë¡œ ê¹¨ì§
</span>            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">req_task</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span><span class="p">.</span><span class="n">content</span>
            <span class="nf">return </span><span class="p">(</span><span class="n">text</span><span class="p">,)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="c1"># 4) ComfyUIì— â€œì‚¬ìš©ì ì¸í„°ëŸ½íŠ¸â€ë¡œ ì•Œë¦¬ë ¤ë©´ ì´ ì˜ˆì™¸ë¡œ ìŠ¹ê²©
</span>            <span class="k">raise</span> <span class="n">mm</span><span class="p">.</span><span class="nc">InterruptProcessingException</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># 5) ì›Œì²˜ ì •ë¦¬
</span>            <span class="n">watcher</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">watcher</span>
</code></pre></div></div>

<h3 id="ì™œ-ì´ë ‡ê²Œ-í•˜ëŠëƒ">ì™œ ì´ë ‡ê²Œ í•˜ëŠëƒ?</h3>

<ul>
  <li>
    <p><strong>UI ë²„íŠ¼</strong> â†’ <code class="language-plaintext highlighter-rouge">/interrupt</code> â†’ ë‚´ë¶€ í”Œë˜ê·¸ on. <a href="https://docs.comfy.org/development/comfyui-server/comms_routes?utm_source=chatgpt.com">ComfyUI</a></p>
  </li>
  <li>
    <p>ê°ì‹œ ì½”ë£¨í‹´ì´ <code class="language-plaintext highlighter-rouge">throw_exception_if_processing_interrupted()</code> í˜¸ì¶œ ì¤‘ <strong>ì˜ˆì™¸ë¥¼ ë°›ìŒ</strong> â†’ <strong><code class="language-plaintext highlighter-rouge">req_task.cancel()</code></strong> â†’ <code class="language-plaintext highlighter-rouge">await</code>ê°€ ì¦‰ì‹œ <code class="language-plaintext highlighter-rouge">CancelledError</code> ë¡œ ê¹¨ì§ â†’ ì´ë¥¼ <strong><code class="language-plaintext highlighter-rouge">InterruptProcessingException</code> ìœ¼ë¡œ ë‹¤ì‹œ ë˜ì ¸</strong> ComfyUIê°€ <em>â€œProcessing interruptedâ€</em> ê²½ë¡œë¡œ ì¢…ë£Œ. <a href="https://docs.comfy.org/development/comfyui-server/comms_messages?utm_source=chatgpt.com">ComfyUI+1</a></p>
  </li>
</ul>

<hr />

<h2 id="3-ëŒ€ì•ˆ-asynciowaitë¡œ-ë ˆì´ìŠ¤-êµ¬ì„±">3) ëŒ€ì•ˆ: <code class="language-plaintext highlighter-rouge">asyncio.wait()</code>ë¡œ â€œë ˆì´ìŠ¤â€ êµ¬ì„±</h2>

<p>í´ë§ ì½”ë“œë¥¼ ì¤„ì´ê³  ì‹¶ë‹¤ë©´, â€œì¸í„°ëŸ½íŠ¸ ëŒ€ê¸° ì½”ë£¨í‹´â€ê³¼ ìš”ì²­ì„ <strong>ë ˆì´ìŠ¤</strong> ì‹œí‚¤ëŠ” ë°©ë²•ë„ ìˆì–´ìš”:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">_wait_for_interrupt</span><span class="p">():</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="n">mm</span><span class="p">.</span><span class="nf">throw_exception_if_processing_interrupted</span><span class="p">()</span>

<span class="c1"># ...
</span><span class="n">req_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(...))</span>
<span class="n">int_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">_wait_for_interrupt</span><span class="p">())</span>

<span class="n">done</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span>
    <span class="p">{</span><span class="n">req_task</span><span class="p">,</span> <span class="n">int_task</span><span class="p">},</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span>
<span class="p">)</span>

<span class="k">if</span> <span class="n">int_task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
    <span class="n">req_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
    <span class="k">raise</span> <span class="n">mm</span><span class="p">.</span><span class="nc">InterruptProcessingException</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">int_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
    <span class="nf">return </span><span class="p">(</span> <span class="p">(</span><span class="k">await</span> <span class="n">req_task</span><span class="p">).</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="4-ìì£¼-ê²ªëŠ”-í•¨ì •--íŒ">4) ìì£¼ ê²ªëŠ” í•¨ì • &amp; íŒ</h2>

<ul>
  <li>
    <p><strong>ë¸”ë¡œí‚¹ ì½”ë“œ</strong>(ë™ê¸° HTTP, ë¬´í•œ ë£¨í”„ ë“±)ê°€ ìˆìœ¼ë©´ ì¸í„°ëŸ½íŠ¸ê°€ â€œì¦‰ì‹œâ€ ì•ˆ ë¨¹í™ë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ëŠ” ë°˜ë“œì‹œ <strong>aiohttp/ë¹„ë™ê¸°</strong> ë¥¼ ì“°ê³ , ë£¨í”„ ì•ˆì—ëŠ” ê°„ê°„ì´ <code class="language-plaintext highlighter-rouge">mm.throw_exception_if_processing_interrupted()</code> ë¥¼ ë„£ìœ¼ì„¸ìš”. <a href="https://github.com/comfyanonymous/ComfyUI/issues/3131?utm_source=chatgpt.com">GitHub</a></p>
  </li>
  <li>
    <p><strong>OpenAI ë¹„ë™ê¸° í´ë¼ì´ì–¸íŠ¸</strong> ëŠ” <code class="language-plaintext highlighter-rouge">AsyncOpenAI</code> ë¥¼ ì“°ë©´ ë©ë‹ˆë‹¤(ìš”ì²­ ì˜µì…˜ì— <code class="language-plaintext highlighter-rouge">timeout</code> ë“± ì „ë‹¬ ê°€ëŠ¥).</p>
  </li>
  <li>
    <p><strong>ì·¨ì†Œ ì „íŒŒ</strong> : <code class="language-plaintext highlighter-rouge">asyncio.CancelledError</code> ë¥¼ <strong>ì¡ì•„ì„œ</strong> <code class="language-plaintext highlighter-rouge">mm.InterruptProcessingException</code> ìœ¼ë¡œ <strong>ë‹¤ì‹œ ë˜ì§€ëŠ” ê²ƒ</strong> ì´ í¬ì¸íŠ¸ì…ë‹ˆë‹¤ â€” ê·¸ë˜ì•¼ UIì— ì •ìƒì ì¸ â€œì¤‘ë‹¨â€ìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤</strong> ë„ ì¸í„°ëŸ½íŠ¸ë¥¼ ë³´ëƒ…ë‹ˆë‹¤(Ctrl+Alt+Enter). <a href="https://docs.comfy.org/interface/shortcuts?utm_source=chatgpt.com">ComfyUI</a></p>
  </li>
</ul>

<hr />

<h2 id="5-ë™ì‘-ì›ë¦¬-í•œëˆˆ-ìš”ì•½">5) ë™ì‘ ì›ë¦¬ í•œëˆˆ ìš”ì•½</h2>

<ol>
  <li>
    <p>ìœ ì €ê°€ Interrupt í´ë¦­ â†’ <strong><code class="language-plaintext highlighter-rouge">POST /interrupt</code></strong> í˜¸ì¶œ â†’ ë‚´ë¶€ í”Œë˜ê·¸ on. <a href="https://docs.comfy.org/development/comfyui-server/comms_routes?utm_source=chatgpt.com">ComfyUI</a></p>
  </li>
  <li>
    <p>ë‚´ ë…¸ë“œì˜ â€œì¸í„°ëŸ½íŠ¸ ì›Œì²˜â€ê°€ í”Œë˜ê·¸ ê°ì§€ â†’ <strong>ìš”ì²­ íƒœìŠ¤í¬ cancel()</strong>.</p>
  </li>
  <li>
    <p>ë‚´ ì½”ë“œê°€ <code class="language-plaintext highlighter-rouge">CancelledError</code> ë¥¼ ë°›ì•„ <strong><code class="language-plaintext highlighter-rouge">InterruptProcessingException</code> ì¬-ë°œìƒ</strong> â†’ ì‹¤í–‰ê¸°ì—ì„œ <strong><code class="language-plaintext highlighter-rouge">execution_interrupted</code></strong> ì´ë²¤íŠ¸ ì „ì†¡ &amp; ì¦‰ì‹œ ì¤‘ë‹¨. <a href="https://docs.comfy.org/development/comfyui-server/comms_messages?utm_source=chatgpt.com">ComfyUI</a></p>
  </li>
</ol>

<p>ì´ë ‡ê²Œ ë¶™ì´ë©´ â€œUIì—ì„œ ì •ì§€ â†’ ê³§ì¥ ë‹¹ì‹ ì˜ <code class="language-plaintext highlighter-rouge">await</code>ê°€ ëŠê¸°ëŠ”â€ ë™ì‘ì„ ì•ˆì •ì ìœ¼ë¡œ ë§Œë“¤ ìˆ˜ ìˆì–´ìš”.</p>

<p class="chat--user">

3ë²ˆì²˜ëŸ¼ êµ¬ì„±í–ˆì–´. ê·¸ëŸ°ë° ë„ˆê°€ ë§Œë“¤ì–´ì¤€ ë…¸ë“œë“¤ì´ ë‹¤ìˆ˜ì˜ ë…¸ë“œê°€ ë™ì‹œì— ì‹¤í–‰ë ìˆ˜ë„ ìˆëŠ”ë° ê·¸ëŸ¬ë©´ ê·¸ ì¤‘ì— í•˜ë‚˜ë§Œ ì·¨ì†Œë˜ëŠ”ê±° ê°™ê¸°ë„í•´. ì™œëƒë©´ throw_exception_if_processing_interrupted() í•¨ìˆ˜ê°€ interrupt_processingì„ Falseë¡œ ë§Œë“¤ê±°ë“ . ê·¸ëŸ¬ë©´ ë‘ ë²ˆì§¸ ë…¸ë“œëŠ” ì·¨ì†Œëœì§€ ëª¨ë¥´ì§€ ì•Šì„ê¹Œ

</p>

<p>ë§ì•„. ë„¤ê°€ ë³¸ ê·¸ëŒ€ë¡œì•¼. ComfyUIì˜ ì¸í„°ëŸ½íŠ¸ í”Œë˜ê·¸ëŠ” <strong>â€œí•œ ë²ˆë§Œ ì†Œë¹„ë˜ëŠ”(edge-triggered)â€</strong> ë™ì‘ì„ í•´.<br />
ì†ŒìŠ¤ ë³´ë©´:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">interrupt_current_processing(True)</code> â†’ ì „ì—­ í”Œë˜ê·¸ë¥¼ <strong>True</strong> ë¡œ ì…‹íŒ….</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">processing_interrupted()</code> â†’ <strong>í”Œë˜ê·¸ë¥¼ ì½ê¸°ë§Œ</strong> í•¨(ì•ˆ ì§€ì›€). <a href="https://huggingface.co/spideyrim/ComfyUI/blob/main/comfy/model_management.py">Hugging Face</a></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">throw_exception_if_processing_interrupted()</code> â†’ í”Œë˜ê·¸ê°€ <strong>Trueë©´ Falseë¡œ ì§€ìš°ê³ </strong> <code class="language-plaintext highlighter-rouge">InterruptProcessingException</code>ì„ ë˜ì§(ì¦‰, <em>ì†Œë¹„</em>). ê·¸ë˜ì„œ <strong>ë¨¼ì € í˜¸ì¶œí•œ ë…¸ë“œë§Œ</strong> í™•ì‹¤íˆ ì·¨ì†Œ ì‹ í˜¸ë¥¼ ë³´ê²Œ ë˜ê³ , ë’¤ëŠ¦ê²Œ ì²´í¬í•œ ë‹¤ë¥¸ ë…¸ë“œëŠ” â€œëª°ëë‹¤â€ê°€ ë  ìˆ˜ ìˆì–´. <a href="https://huggingface.co/spideyrim/ComfyUI/blob/main/comfy/model_management.py">Hugging Face</a></p>
  </li>
</ul>

<p>ê·¸ë˜ì„œ â€œì—¬ëŸ¬ ë…¸ë“œê°€ ë™ì‹œì— ëŒ ë•Œ í•˜ë‚˜ë§Œ ì·¨ì†Œë˜ëŠ” ê²ƒ ê°™ë‹¤â€ëŠ” ë„¤ ì¶”ì¸¡ì´ ì •í™•í•´.</p>

<hr />

<h1 id="ì´ë ‡ê²Œ-ë°”ê¿”ì„œ-í•´ê²°í•´">ì´ë ‡ê²Œ ë°”ê¿”ì„œ í•´ê²°í•´</h1>

<p>í•µì‹¬ì€ <strong>ë…¸ë“œ ë‚´ë¶€ì—ì„œ í”Œë˜ê·¸ë¥¼ â€˜ì½ê¸°ë§Œâ€™ í•˜ë˜ ì§€ìš°ì§€ ì•ŠëŠ” ê²ƒ</strong> ì´ì•¼.<br />
ì¦‰, ê°ì‹œ ì½”ë£¨í‹´ì€ <code class="language-plaintext highlighter-rouge">throw_exception_if_processing_interrupted()</code>(ì†Œë¹„) ëŒ€ì‹  <code class="language-plaintext highlighter-rouge">processing_interrupted()</code>(ë¹„ì†Œë¹„)ë¡œ ì²´í¬í•˜ê³ , <strong>ì§ì ‘<code class="language-plaintext highlighter-rouge">InterruptProcessingException</code>ì„ raise</strong> í•˜ì. ê·¸ëŸ¬ë©´ <strong>ëª¨ë“ </strong> ì‹¤í–‰ ì¤‘ ë…¸ë“œê°€ ê°™ì€ ì¸í„°ëŸ½íŠ¸ë¥¼ ê°ì§€í•˜ê³  ë™ì‹œì— ë©ˆì¶œ ìˆ˜ ìˆì–´.</p>

<h2 id="1-ë ˆì´ìŠ¤-íŒ¨í„´ìš”ì²­-vs-ì¸í„°ëŸ½íŠ¸-ìˆ˜ì •ë³¸">1) ë ˆì´ìŠ¤ íŒ¨í„´(ìš”ì²­ vs ì¸í„°ëŸ½íŠ¸) ìˆ˜ì •ë³¸</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>
<span class="kn">import</span> <span class="n">comfy.model_management</span> <span class="k">as</span> <span class="n">mm</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">_wait_for_interrupt_level_trigger</span><span class="p">():</span>
    <span class="c1"># í”Œë˜ê·¸ë¥¼ 'ì½ê¸°ë§Œ' í•˜ëŠ” ë£¨í”„: ì—¬ëŸ¬ ë…¸ë“œê°€ ë™ì‹œì— Trueë¥¼ ê°ì§€ ê°€ëŠ¥
</span>    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mm</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>           <span class="c1"># â† ì†Œë¹„ ì•ˆ í•¨
</span>            <span class="k">raise</span> <span class="n">mm</span><span class="p">.</span><span class="nc">InterruptProcessingException</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">MyAsyncNode</span><span class="p">:</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">example</span><span class="sh">"</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">prompt</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">})}}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">req_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span>
                <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
                    <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
                    <span class="n">max_retries</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">int_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">_wait_for_interrupt_level_trigger</span><span class="p">())</span>

            <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">({</span><span class="n">req_task</span><span class="p">,</span> <span class="n">int_task</span><span class="p">},</span>
                                        <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">int_task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="c1"># ì¸í„°ëŸ½íŠ¸ê°€ ë¨¼ì € ì˜´: ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ì¦‰ì‹œ ì·¨ì†Œ
</span>                <span class="n">req_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">req_task</span>
                <span class="c1"># ì—¬ê¸°ì„œ throw_exception_if_processing_interrupted()ë¥¼ ë¶€ë¥´ë©´
</span>                <span class="c1"># í”Œë˜ê·¸ë¥¼ 'ì§€ì›Œ' ë²„ë ¤ ë‹¤ë¥¸ ë…¸ë“œê°€ ëª» ë´„ â†’ ì“°ì§€ ë§ì.
</span>                <span class="k">raise</span> <span class="n">mm</span><span class="p">.</span><span class="nc">InterruptProcessingException</span><span class="p">()</span>

            <span class="c1"># ìš”ì²­ì´ ë¨¼ì € ëë‚¨
</span>            <span class="n">int_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">int_task</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">req_task</span>
            <span class="nf">return </span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span><span class="p">.</span><span class="n">content</span><span class="p">,)</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="c1"># ìƒìœ„ì—ì„œ íƒœìŠ¤í¬ ìì²´ë¥¼ ì·¨ì†Œí•œ ê²½ìš°
</span>            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre></div></div>

<blockquote>
  <p>í¬ì¸íŠ¸: <strong>ë…¸ë“œ ì½”ë“œì—ì„œëŠ”<code class="language-plaintext highlighter-rouge">throw_exception_if_processing_interrupted()</code>ë¥¼ í˜¸ì¶œí•˜ì§€ ì•ŠëŠ”ë‹¤.</strong><br />
 ëª¨ë“  ì‹¤í–‰ ì¤‘ ë…¸ë“œê°€ <code class="language-plaintext highlighter-rouge">processing_interrupted()</code>ë¡œ ë™ì‹œì— ê°ì§€ â†’ ê°ì ìì‹ ì˜ ì‘ì—…ì„ ì·¨ì†Œí•˜ê³  <strong>ì§ì ‘</strong> <code class="language-plaintext highlighter-rouge">InterruptProcessingException</code>ì„ ë˜ì§„ë‹¤.<br />
 ì´ë ‡ê²Œ í•´ì•¼ í”Œë˜ê·¸ê°€ í•œ ë…¸ë“œì— ì˜í•´ ë¨¼ì € â€˜ì†Œë¹„â€™ë˜ì–´ ì‚¬ë¼ì§€ëŠ” ì¼ì´ ì—†ë‹¤. (í•´ë‹¹ í•¨ìˆ˜ê°€ í”Œë˜ê·¸ë¥¼ Falseë¡œ ë§Œë“¤ê³  ì˜ˆì™¸ë¥¼ ë˜ì§€ëŠ” ë™ì‘ì€ ì†ŒìŠ¤ì— ëª…ì‹œë¼ ìˆìŒ) <a href="https://huggingface.co/spideyrim/ComfyUI/blob/main/comfy/model_management.py">Hugging Face</a></p>
</blockquote>

<h2 id="2-ìŠ¤íŠ¸ë¦¬ë°-ë£¨í”„ë„-ë™ì¼-ì›ë¦¬">2) ìŠ¤íŠ¸ë¦¬ë° ë£¨í”„ë„ ë™ì¼ ì›ë¦¬</h2>

<p>ì²­í¬ ì½ê¸°(<code class="language-plaintext highlighter-rouge">__anext__</code>)ì™€ ì¸í„°ëŸ½íŠ¸ ê°ì‹œë¥¼ ë ˆì´ìŠ¤ì‹œí‚¤ë˜, ê°ì‹œëŠ” <code class="language-plaintext highlighter-rouge">processing_interrupted()</code>ë§Œ ì‚¬ìš©:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">stream_chat_cancellable</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">stream</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">prompt</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
        <span class="n">aiter</span> <span class="o">=</span> <span class="n">stream</span><span class="p">.</span><span class="nf">aiter_text</span><span class="p">()</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">next_chunk</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">aiter</span><span class="p">.</span><span class="nf">__anext__</span><span class="p">())</span>
            <span class="n">int_task</span>   <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">_wait_for_interrupt_level_trigger</span><span class="p">())</span>

            <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">({</span><span class="n">next_chunk</span><span class="p">,</span> <span class="n">int_task</span><span class="p">},</span>
                                         <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">int_task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="n">next_chunk</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">next_chunk</span>
                <span class="k">await</span> <span class="n">stream</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">mm</span><span class="p">.</span><span class="nc">InterruptProcessingException</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">next_chunk</span><span class="p">.</span><span class="nf">result</span><span class="p">())</span>
            <span class="k">except</span> <span class="nb">StopAsyncIteration</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">int_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">int_task</span>

        <span class="k">return</span> <span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h1 id="ì™œ-ì´ê²Œ-ì•ˆì „í•œê°€-step-by-step">ì™œ ì´ê²Œ ì•ˆì „í•œê°€ (step-by-step)</h1>

<ol>
  <li>
    <p>ì‚¬ìš©ìê°€ UIì—ì„œ <strong>Interrupt ë²„íŠ¼</strong> â†’ ì„œë²„ê°€ <code class="language-plaintext highlighter-rouge">interrupt_current_processing(True)</code>ë¡œ ì „ì—­ í”Œë˜ê·¸ë¥¼ í‚´.</p>
  </li>
  <li>
    <p>ê° ë…¸ë“œì˜ ê°ì‹œ ì½”ë£¨í‹´ì´ <strong>ì§€ìš°ì§€ ì•ŠëŠ”</strong> <code class="language-plaintext highlighter-rouge">processing_interrupted()</code>ë¡œ Trueë¥¼ ê°ì§€. (ë™ì‹œì— ì—¬ëŸ¬ ë…¸ë“œ OK) <a href="https://huggingface.co/spideyrim/ComfyUI/blob/main/comfy/model_management.py">Hugging Face</a></p>
  </li>
  <li>
    <p>ê°ì§€í•œ ë…¸ë“œëŠ” <strong>ìê¸° ë„¤íŠ¸ì›Œí¬ íƒœìŠ¤í¬ë¥¼<code class="language-plaintext highlighter-rouge">cancel()</code></strong> í•˜ê³  <code class="language-plaintext highlighter-rouge">InterruptProcessingException</code>ì„ <strong>ì§ì ‘ raise</strong>.</p>
  </li>
  <li>
    <p>ì‹¤í–‰ê¸°ëŠ” ì´ ì˜ˆì™¸ë¥¼ ë°›ì•„ ì›Œí¬í”Œë¡œë¥¼ â€œProcessing interruptedâ€ë¡œ ì¢…ë£Œ.</p>
  </li>
  <li>
    <p>í”Œë˜ê·¸ ì´ˆê¸°í™”ëŠ” <strong>ì½”ì–´ ìª½</strong>(ë‹¤ìŒ ì‹¤í–‰ ì¤€ë¹„ íƒ€ì´ë°)ì— ì˜í•´ ì²˜ë¦¬ë˜ê±°ë‚˜, ì½”ì–´ê°€ ì ì ˆíˆ <code class="language-plaintext highlighter-rouge">throw_exception_if_processing_interrupted()</code>ë¥¼ í•œ ë²ˆë§Œ í˜¸ì¶œí•´ ì†Œë¹„í•¨. (ì´ í•¨ìˆ˜ê°€ í”Œë˜ê·¸ë¥¼ ì§€ìš°ëŠ” ë™ì‘ì€ ì†ŒìŠ¤ì— ëª…í™•) <a href="https://huggingface.co/spideyrim/ComfyUI/blob/main/comfy/model_management.py">Hugging Face</a></p>
  </li>
</ol>

<blockquote>
  <p>ìš”ì•½: <strong>ë…¸ë“œ ë‹¨ì—ì„œëŠ” â€˜ì½ê¸°(ë ˆë²¨ íŠ¸ë¦¬ê±°)â€™ë§Œ í•˜ê³ , ì§€ìš°ëŠ”(ì—£ì§€ ì†Œë¹„) ì¼ì€ ì½”ì–´ì—ê²Œ ë§¡ê²¨ë¼.</strong></p>
</blockquote>

<hr />

<h1 id="ì¶”ê°€-ì²´í¬ë¦¬ìŠ¤íŠ¸">ì¶”ê°€ ì²´í¬ë¦¬ìŠ¤íŠ¸</h1>

<ul>
  <li>
    <p>ì˜ˆì™¸ ì²˜ë¦¬ì—ì„œ <code class="language-plaintext highlighter-rouge">CancelledError</code>ëŠ” <strong>ì ˆëŒ€ ì‚¼í‚¤ì§€ ë§ê³  ì „íŒŒ</strong> í•˜ì„¸ìš”. (ì·¨ì†Œ ê°ë„ê°€ ë–¨ì–´ì§€ëŠ” ëŒ€í‘œ ì›ì¸)</p>
  </li>
  <li>
    <p>aiohttp/OpenAI ë¹„ë™ê¸°ëŠ” íƒœìŠ¤í¬ ì·¨ì†Œ ì‹œ ì†Œì¼“ì„ ë‹«ê³  <code class="language-plaintext highlighter-rouge">CancelledError</code>ë¥¼ ë˜ì§‘ë‹ˆë‹¤. ì·¨ì†Œ í›„ì—ëŠ” <code class="language-plaintext highlighter-rouge">with suppress(asyncio.CancelledError): await task</code>ë¡œ <strong>ì •ë¦¬ê¹Œì§€</strong> í•´ ì£¼ì„¸ìš”.</p>
  </li>
  <li>
    <p>ì¥ì‹œê°„ ë¸”ë¡œí‚¹/CPU ì‘ì—…ì´ ìˆìœ¼ë©´ <code class="language-plaintext highlighter-rouge">processing_interrupted()</code>ë¥¼ ë£¨í”„ì— ê°„ê°„íˆ ë„£ì–´ ì£¼ì„¸ìš”. (ë¸”ë¡œí‚¹ì´ë©´ ì¸í„°ëŸ½íŠ¸ê°€ ëŠ¦ê²Œ ë°˜ì˜)</p>
  </li>
</ul>

<p>ì´ëŒ€ë¡œ ë°”ê¾¸ë©´ â€œë™ì‹œì— ë„ëŠ” ì—¬ëŸ¬ ë…¸ë“œ ì¤‘ í•˜ë‚˜ë§Œ ë©ˆì¶”ëŠ”â€ í˜„ìƒ ì—†ì´, <strong>ëª¨ë‘ê°€ ì¦‰ì‹œ ë©ˆì¶”ëŠ”</strong> ë™ì‘ì´ ë©ë‹ˆë‹¤.</p>

<p class="chat--user">

Exceptionì„ ì—¬ëŸ¬ ë…¸ë“œì—ì„œ ë¿Œë ¤ë„ ë¼?

</p>

<p>ì§§ê²Œ ë‹µí•˜ë©´: <strong>ë„¤, ì—¬ëŸ¬ ë…¸ë“œì—ì„œ<code class="language-plaintext highlighter-rouge">InterruptProcessingException</code>ì„ ë™ì‹œì—(ë˜ëŠ” ê±°ì˜ ë™ì‹œì—) ë˜ì ¸ë„ ë©ë‹ˆë‹¤.</strong><br />
ComfyUI ì‹¤í–‰ê¸°ëŠ” ì´ ì˜ˆì™¸ë¥¼ â€œì·¨ì†Œ ì‹ í˜¸â€ë¡œ ì·¨ê¸‰í•˜ê³  ìƒìœ„ ì‹¤í–‰ ë£¨í”„ì—ì„œ ì¡ì•„ì„œ í”„ë¡¬í”„íŠ¸ ì‹¤í–‰ì„ ì¤‘ë‹¨í•˜ë„ë¡ ì„¤ê³„ë˜ì–´ ìˆì–´ìš”. í•œ ë…¸ë“œê°€ ë˜ì§€ë“ , ì—¬ëŸ¬ ë…¸ë“œê°€ ë˜ì§€ë“  ê²°ê³¼ëŠ” ê°™ê³ , ì¶”ê°€ë¡œ ë˜ì ¸ì§€ëŠ” ì˜ˆì™¸ë“¤ì€ ìƒìœ„ì—ì„œ ë™ì¼í•˜ê²Œ ì²˜ë¦¬(ë¡œê·¸ë§Œ ë‚¨ê¸°ê³  ë¬´ì‹œ)ë©ë‹ˆë‹¤. ê³µì‹ ë¬¸ì„œì—ë„ <em>â€œë…¸ë“œê°€ <code class="language-plaintext highlighter-rouge">InterruptProcessingException</code>ì„ ë˜ì§ˆ ë•Œ ì‹¤í–‰ì´ ì¤‘ë‹¨ëœë‹¤â€</em>ê³  ëª…ì‹œë¼ ìˆì–´ìš”. <a href="https://docs.comfy.org/development/comfyui-server/comms_messages">ComfyUI ê³µì‹ ë¬¸ì„œ</a></p>

<p>ì¡°ê¸ˆ ë” êµ¬ì²´ì ìœ¼ë¡œ, ë‹¨ê³„ë³„ë¡œ ìƒê°í•´ë³´ë©´:</p>

<ol>
  <li>
    <p><strong>UIì˜ Stop(ë˜ëŠ”<code class="language-plaintext highlighter-rouge">/interrupt</code>) â†’ ì‹¤í–‰ ì¤‘ë‹¨ í”Œë˜ê·¸ ì„¸íŠ¸</strong><br />
í”„ë¡ íŠ¸ì—”ë“œê°€ ì¤‘ë‹¨ì„ ë³´ë‚´ë©´ ì„œë²„ê°€ í˜„ì¬ ì›Œí¬í”Œë¡œ ì‹¤í–‰ì„ ë©ˆì¶”ëŠ” ë¼ìš°íŠ¸ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤. <a href="https://docs.comfy.org/development/comfyui-server/comms_routes?utm_source=chatgpt.com">ComfyUI ê³µì‹ ë¬¸ì„œ</a></p>
  </li>
  <li>
    <p><strong>ë…¸ë“œë‹¨ ì²´í¬ â†’ ì˜ˆì™¸ ë°œìƒ</strong><br />
ê° ë…¸ë“œ(í˜¹ì€ ì§„í–‰ë¥  í›…/ëŒ€ê¸° ì§€ì )ì—ì„œ <code class="language-plaintext highlighter-rouge">throw_exception_if_processing_interrupted()</code>ë¥¼ í˜¸ì¶œí•˜ë©´, í”Œë˜ê·¸ê°€ ì¼œì ¸ ìˆì„ ë•Œ <code class="language-plaintext highlighter-rouge">InterruptProcessingException</code>ì„ ë˜ì§‘ë‹ˆë‹¤. ì´ê±´ ì˜ë„ëœ íë¦„ì´ì—ìš”. ì‹¤í–‰ê¸°ëŠ” ì´ ì˜ˆì™¸ë¥¼ íŠ¹ë³„ì·¨ê¸‰í•˜ì—¬ â€œProcessing interruptedâ€ë¡œ ì²˜ë¦¬í•˜ê³  <code class="language-plaintext highlighter-rouge">execution_interrupted</code> ë©”ì‹œì§€ë¥¼ ë¸Œë¡œë“œìºìŠ¤íŠ¸í•©ë‹ˆë‹¤. <a href="https://docs.comfy.org/development/comfyui-server/comms_messages">ComfyUI ê³µì‹ ë¬¸ì„œ+1</a></p>
  </li>
  <li>
    <p><strong>ì—¬ëŸ¬ ë…¸ë“œê°€ ë™ì‹œì— ë˜ì ¸ë„ ë¬¸ì œ ì—†ìŒ</strong><br />
ì‹¤í–‰ê¸°ëŠ” ë…¸ë“œ ì‹¤í–‰ì„ ê°ì‹¸ëŠ” ìƒìœ„ try/exceptì—ì„œ <code class="language-plaintext highlighter-rouge">InterruptProcessingException</code>ì„ ì¡ì•„ â€œì¤‘ë‹¨â€ìœ¼ë¡œ ì •ë¦¬í•©ë‹ˆë‹¤. ë‹¤ë¥¸ ë…¸ë“œì—ì„œë„ ê°™ì€ ì˜ˆì™¸ê°€ ì—°ë‹¬ì•„ í„°ì ¸ë„ ë™ì¼í•˜ê²Œ ì¤‘ë‹¨ ì²˜ë¦¬ë¡œ í˜ëŸ¬ê°‘ë‹ˆë‹¤(ì¤‘ë³µ ë¡œê·¸ ì •ë„ë§Œ ìƒê¸¸ ìˆ˜ ìˆìŒ). <a href="https://github.com/comfyanonymous/ComfyUI/discussions/6766?utm_source=chatgpt.com">GitHub+1</a></p>
  </li>
</ol>

<p>ê·¸ë˜ì„œ ì‹¤ë¬´ íŒì€ ì´ë ‡ìŠµë‹ˆë‹¤:</p>

<ul>
  <li>
    <p><strong>ê° ë…¸ë“œì—ì„œ</strong> ì§„ì… ì‹œì ê³¼ <strong>ëª¨ë“ <code class="language-plaintext highlighter-rouge">await</code> ì§í›„</strong>ì—<br />
<code class="language-plaintext highlighter-rouge">throw_exception_if_processing_interrupted()</code>ë¥¼ í˜¸ì¶œí•˜ì„¸ìš”.</p>
  </li>
  <li>ì™¸ë¶€ ë¹„ë™ê¸° ìš”ì²­(ì˜ˆ: <code class="language-plaintext highlighter-rouge">AsyncOpenAI</code>/<code class="language-plaintext highlighter-rouge">aiohttp</code>)ì´ ìˆë‹¤ë©´ ì´ë ‡ê²Œ ê°ì‹¸ë©´ ì•ˆì „í•©ë‹ˆë‹¤:
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfy.model_management</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">InterruptProcessingException</span><span class="p">,</span>
    <span class="n">throw_exception_if_processing_interrupted</span><span class="p">,</span>
<span class="p">)</span>
    
<span class="k">async</span> <span class="k">def</span> <span class="nf">FUNCTION</span><span class="p">(...):</span>
    <span class="nf">throw_exception_if_processing_interrupted</span><span class="p">()</span>
    <span class="n">task</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># ì˜ˆ: ëŒ€ê¸° ì „ì— í•œ ë²ˆ ë” ì²´í¬
</span>        <span class="nf">throw_exception_if_processing_interrupted</span><span class="p">()</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(...))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">task</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">except</span> <span class="n">InterruptProcessingException</span><span class="p">:</span>
        <span class="c1"># ì™¸ë¶€ ìš”ì²­/íƒœìŠ¤í¬ ì •ë¦¬
</span>        <span class="k">if</span> <span class="n">task</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task</span><span class="p">.</span><span class="nf">done</span><span class="p">():</span>
            <span class="n">task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">task</span>
        <span class="k">raise</span>  <span class="c1"># ê¼­ ì¬ì „íŒŒ! (ì¤‘ë‹¨ìœ¼ë¡œ ì¸ì‹)
</span></code></pre></div>    </div>
  </li>
  <li>
    <p><strong>ì ˆëŒ€</strong> <code class="language-plaintext highlighter-rouge">InterruptProcessingException</code>ì„ ì¼ë°˜ <code class="language-plaintext highlighter-rouge">Exception</code>ìœ¼ë¡œ ì‚¼ì¼œì„œ ë¦¬í„´í•˜ì§€ ë§ˆì„¸ìš”. ê·¸ëŸ¬ë©´ â€œì¤‘ë‹¨â€ì´ ì•„ë‹Œ â€œì‹¤íŒ¨â€ë¡œ ê¸°ë¡ë©ë‹ˆë‹¤(ë¡œê·¸ì™€ UI ì´ë²¤íŠ¸ê°€ ë‹¬ë¼ì§). <code class="language-plaintext highlighter-rouge">execution_interrupted</code> ì´ë²¤íŠ¸ëŠ” ì´ ì˜ˆì™¸ê°€ ê·¸ëŒ€ë¡œ ì˜¬ë¼ê°ˆ ë•Œë§Œ ë°œìƒí•©ë‹ˆë‹¤. <a href="https://docs.comfy.org/development/comfyui-server/comms_messages">ComfyUI ê³µì‹ ë¬¸ì„œ</a></p>
  </li>
  <li>ì—¬ëŸ¬ ë…¸ë“œê°€ ë™ì‹œì— ì‹¤í–‰ë  ìˆ˜ ìˆëŠ” êµ¬ì¡°ë¼ë©´ <strong>ê° ë…¸ë“œê°€ ë…ë¦½ì ìœ¼ë¡œ ê°™ì€ ì˜ˆì™¸ë¥¼ ë˜ì§€ë„ë¡</strong> ë‘ëŠ” ê²Œ ë§ìŠµë‹ˆë‹¤. ì¤‘ë³µ ì˜ˆì™¸ëŠ” ìƒìœ„ ì‹¤í–‰ê¸°ì—ì„œ ì •ë¦¬ë˜ë©°, ì „ì²´ í”„ë¡¬í”„íŠ¸ëŠ” í•œ ë²ˆë§Œ â€œì¤‘ë‹¨â€ìœ¼ë¡œ ë§ˆê°ë©ë‹ˆë‹¤. <a href="https://github.com/comfyanonymous/ComfyUI/discussions/6766?utm_source=chatgpt.com">GitHub</a></li>
</ul>

<p>ë¤: ë¸Œë¼ìš°ì € íƒ­ì„ ë‹«ì•„ë„ ì¤‘ë‹¨ì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤ëŠ” ì´ìŠˆë“¤ì´ ìˆì–´ìš”(íƒ­ì„ ë‹«ìœ¼ë©´ ì„¸ì…˜ì´ ëŠê¸°ë©° ì¸í„°ëŸ½íŠ¸ê°€ íŠ¸ë¦¬ê±°). API/í—¤ë“œë¦¬ìŠ¤ë¡œ ëŒë¦´ ë•ŒëŠ” ì´ ì ì„ ìœ ì˜í•˜ì„¸ìš”. <a href="https://github.com/comfyanonymous/ComfyUI/issues/6713?utm_source=chatgpt.com">GitHub+1</a></p>

<p>ì •ë¦¬: <strong>ì—¬ëŸ¬ ë…¸ë“œì—ì„œ ë§ˆìŒ í¸íˆ<code class="language-plaintext highlighter-rouge">InterruptProcessingException</code>ì„ ë˜ì§€ì„¸ìš”.</strong> ì´ê²ƒì´ ComfyUIê°€ ì˜ë„í•œ â€œì¦‰ì‹œ ì¤‘ë‹¨â€ ë©”ì»¤ë‹ˆì¦˜ì´ê³ , ì˜ˆì™¸ê°€ ì—¬ëŸ¬ ê°œì—¬ë„ ìƒìœ„ ì‹¤í–‰ê¸°ì—ì„œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</p>

<p class="chat--user">

_wait_for_interrupt_level_trigger()ì—ì„œ raise ì•ˆí•˜ê³  ê·¸ëƒ¥ return í•˜ëŠ”ê±´ ì–´ë•Œ ì–´ì°¨í”¼ ë°–ì—ì„œ raise í•˜ì–ì•„

</p>

<p>ê°€ëŠ¥í•´. <strong><code class="language-plaintext highlighter-rouge">_wait_for_interrupt_level_trigger()</code>ì—ì„œ <code class="language-plaintext highlighter-rouge">raise</code> ëŒ€ì‹  <code class="language-plaintext highlighter-rouge">return</code></strong> í•´ë„ ì›í•˜ëŠ” â€œë ˆì´ìŠ¤(ìš”ì²­ vs ì¸í„°ëŸ½íŠ¸)â€ ë™ì‘ì€ ë˜‘ê°™ì´ ë§Œë“¤ì–´ì ¸. ì‹¤ë¬´ì ìœ¼ë¡œëŠ” <em>í—¬í¼ì—ì„œ ì˜ˆì™¸ ìŠ¤íƒì„ ë‚¨ê¸°ì§€ ì•Šìœ¼ë‹ˆ</em> ë¡œê·¸ê°€ ë” ê¹”ë”í•´ì§€ëŠ” ì¥ì ë„ ìˆì–´.</p>

<p>ì•„ë˜ì²˜ëŸ¼ ë°”ê¾¸ë©´ ë¼ â€” ë‹¨ê³„ë³„ë¡œ ì •ë¦¬í• ê²Œ.</p>

<hr />

<h1 id="í•µì‹¬-ì•„ì´ë””ì–´-step-by-step">í•µì‹¬ ì•„ì´ë””ì–´ (step-by-step)</h1>

<ol>
  <li>
    <p><strong>í—¬í¼ëŠ” â€œì¸í„°ëŸ½íŠ¸ë¥¼ ê°ì§€í•˜ë©´ ëë‚¬ë‹¤â€ëŠ” ì‹ í˜¸ë§Œ ë°˜í™˜</strong> í•œë‹¤.</p>
  </li>
  <li>
    <p><strong>ë°”ê¹¥(ì½œëŸ¬)</strong>ëŠ” <code class="language-plaintext highlighter-rouge">asyncio.wait(..., FIRST_COMPLETED)</code>ë¡œ <code class="language-plaintext highlighter-rouge">req_task</code>(ë„¤íŠ¸ì›Œí¬ ìš”ì²­)ì™€ <code class="language-plaintext highlighter-rouge">int_task</code>(ì¸í„°ëŸ½íŠ¸ ê°ì‹œ) ì¤‘ <strong>ë¨¼ì € ëë‚œ ìª½</strong> ì„ í™•ì¸í•œë‹¤.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">int_task</code>ê°€ ë¨¼ì € ëë‚¬ë‹¤ë©´ <strong>ìš”ì²­ íƒœìŠ¤í¬ë¥¼ cancel() í•˜ê³ </strong> , ì—¬ê¸°ì„œ <strong>í•œ ë²ˆë§Œ</strong> <code class="language-plaintext highlighter-rouge">InterruptProcessingException</code>ì„ ë˜ì§„ë‹¤.</p>
  </li>
</ol>

<hr />

<h1 id="í—¬í¼-return-ë²„ì „-ë ˆë²¨-íŠ¸ë¦¬ê±°-ì†Œë¹„-ì•ˆ-í•¨">í—¬í¼: return ë²„ì „ (ë ˆë²¨ íŠ¸ë¦¬ê±°, ì†Œë¹„ ì•ˆ í•¨)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">comfy.model_management</span> <span class="k">as</span> <span class="n">mm</span>

<span class="c1"># sentinel: ê²°ê³¼ë¥¼ ëª…í™•íˆ êµ¬ë¶„í•˜ê³  ì‹¶ë‹¤ë©´ ì”€
</span><span class="n">INTERRUPTED</span> <span class="o">=</span> <span class="nf">object</span><span class="p">()</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">_wait_for_interrupt_level_trigger</span><span class="p">(</span><span class="n">poll_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">ComfyUI ì¸í„°ëŸ½íŠ¸ í”Œë˜ê·¸ë¥¼ </span><span class="sh">'</span><span class="s">ì½ê¸°ë§Œ</span><span class="sh">'</span><span class="s"> í•˜ë‹¤ê°€ ê°ì§€ë˜ë©´ ë°˜í™˜.</span><span class="sh">"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sleep_s</span> <span class="o">=</span> <span class="n">poll_ms</span> <span class="o">/</span> <span class="mf">1000.0</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">sleep_s</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mm</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>   <span class="c1"># â† ì†Œë¹„í•˜ì§€ ì•ŠìŒ(ì—¬ëŸ¬ ë…¸ë“œ ë™ì‹œ ê°ì§€ ê°€ëŠ¥)
</span>                <span class="k">return</span> <span class="n">INTERRUPTED</span>            <span class="c1"># ë˜ëŠ” True ê°™ì€ ê°„ë‹¨í•œ ê°’
</span>    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
        <span class="c1"># ë°”ê¹¥ì—ì„œ int_taskë¥¼ ì·¨ì†Œí•˜ë©´ ì—¬ê¸°ë¡œ ì˜´. ì •ë¦¬ í›„ ì „íŒŒ.
</span>        <span class="k">raise</span>
</code></pre></div></div>

<hr />

<h1 id="ë¹„-ìŠ¤íŠ¸ë¦¬ë°-ìš”ì²­ì—-ì ìš©">ë¹„-ìŠ¤íŠ¸ë¦¬ë° ìš”ì²­ì— ì ìš©</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>
<span class="kn">import</span> <span class="n">comfy.model_management</span> <span class="k">as</span> <span class="n">mm</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_node</span><span class="p">(</span><span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">()</span>
    <span class="n">req_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span>
        <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
            <span class="n">max_retries</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">int_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">_wait_for_interrupt_level_trigger</span><span class="p">())</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">({</span><span class="n">req_task</span><span class="p">,</span> <span class="n">int_task</span><span class="p">},</span>
                                     <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">int_task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
            <span class="c1"># 1) ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ì¦‰ì‹œ ì·¨ì†Œ
</span>            <span class="n">req_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">req_task</span>

            <span class="c1"># 2) (ì„ íƒ) ê°ì‹œ ê²°ê³¼ë¥¼ í™•ì¸í•´ë„ ë¨
</span>            <span class="n">_</span> <span class="o">=</span> <span class="n">int_task</span><span class="p">.</span><span class="nf">result</span><span class="p">()</span>  <span class="c1"># INTERRUPTED ê°™ì€ ê°’
</span>
            <span class="c1"># 3) ì—¬ê¸°ì„œ ë‹¨ í•œ ë²ˆ raise
</span>            <span class="k">raise</span> <span class="n">mm</span><span class="p">.</span><span class="nc">InterruptProcessingException</span><span class="p">()</span>

        <span class="c1"># ìš”ì²­ì´ ë¨¼ì € ëë‚¨ â†’ ê°ì‹œ íƒœìŠ¤í¬ ì·¨ì†Œ/ì •ë¦¬
</span>        <span class="n">int_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">int_task</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">req_task</span>
        <span class="k">return</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span><span class="p">.</span><span class="n">content</span>

    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
        <span class="c1"># ìƒìœ„ì—ì„œ ì´ ë…¸ë“œ íƒœìŠ¤í¬ ìì²´ë¥¼ ì·¨ì†Œí–ˆì„ ë•Œ
</span>        <span class="k">raise</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="ìŠ¤íŠ¸ë¦¬ë°ì—ë„-ë™ì¼-íŒ¨í„´">ìŠ¤íŠ¸ë¦¬ë°ì—ë„ ë™ì¼ íŒ¨í„´</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">contextlib</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">stream_node</span><span class="p">(</span><span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">stream</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">prompt</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">aiter</span> <span class="o">=</span> <span class="n">stream</span><span class="p">.</span><span class="nf">aiter_text</span><span class="p">()</span>
            <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">next_chunk</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">aiter</span><span class="p">.</span><span class="nf">__anext__</span><span class="p">())</span>
                <span class="n">int_task</span>   <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">_wait_for_interrupt_level_trigger</span><span class="p">())</span>

                <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">({</span><span class="n">next_chunk</span><span class="p">,</span> <span class="n">int_task</span><span class="p">},</span>
                                             <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">int_task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                    <span class="c1"># ìŠ¤íŠ¸ë¦¼/ì²­í¬ ì½ê¸° ì·¨ì†Œ ë° ì •ë¦¬
</span>                    <span class="n">next_chunk</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                    <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                        <span class="k">await</span> <span class="n">next_chunk</span>
                    <span class="k">await</span> <span class="n">stream</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
                    <span class="c1"># ì—¬ê¸°ì„œ raise í•œ ë²ˆ
</span>                    <span class="k">raise</span> <span class="n">mm</span><span class="p">.</span><span class="nc">InterruptProcessingException</span><span class="p">()</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">next_chunk</span><span class="p">.</span><span class="nf">result</span><span class="p">())</span>
                <span class="k">except</span> <span class="nb">StopAsyncIteration</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">int_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                    <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                        <span class="k">await</span> <span class="n">int_task</span>

            <span class="k">return</span> <span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="return-ë°©ì‹ì˜-ì¥ë‹¨ì -ìš”ì•½">return ë°©ì‹ì˜ ì¥ë‹¨ì  ìš”ì•½</h1>

<ul>
  <li>
    <p>âœ… <strong>ì¥ì </strong></p>

    <ul>
      <li>
        <p>í—¬í¼ ë‚´ë¶€ì—ì„œ ì˜ˆì™¸ ìŠ¤íƒì´ ì•ˆ ìƒê²¨ <strong>ë¡œê·¸ê°€ ë‹¨ì •</strong> í•´ì§.</p>
      </li>
      <li>
        <p>â€œëˆ„ê°€ ì˜ˆì™¸ë¥¼ ë˜ì§€ë‚˜?â€ê°€ <strong>ì½œëŸ¬ í•œ ì§€ì </strong> ìœ¼ë¡œ ëª¨ì—¬ <strong>ì •ì±… ì¼ê´€ì„±</strong> í™•ë³´.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>âš ï¸ <strong>ì£¼ì˜</strong></p>

    <ul>
      <li>
        <p>ë‚˜ì¤‘ì— ì‹¤ìˆ˜ë¡œ <code class="language-plaintext highlighter-rouge">int_task.result()</code>ë¥¼ ë‹¤ë¥¸ ê³³ì—ì„œ ì¨ë²„ë¦¬ë©´ <code class="language-plaintext highlighter-rouge">None</code>ì„ ë°›ì•„ í—·ê°ˆë¦´ ìˆ˜ ìˆì–´.<br />
â†’ ìœ„ì²˜ëŸ¼ <strong><code class="language-plaintext highlighter-rouge">INTERRUPTED</code> ì„¼í‹°ë„</strong>ì„ ë°˜í™˜í•´ ëª…ì‹œì ìœ¼ë¡œ êµ¬ë¶„í•˜ëŠ” ê±¸ ì¶”ì²œ.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">req_task</code>ê°€ ë¨¼ì € ëë‚œ ì¼€ì´ìŠ¤ì—ì„œ <code class="language-plaintext highlighter-rouge">int_task</code>ë¥¼ <strong>ë°˜ë“œì‹œ cancel &amp; await</strong>(suppress)ë¡œ ì •ë¦¬í•´ì•¼ ê²½ê³ ê°€ ì•ˆ ë‚¨ì•„.</p>
      </li>
    </ul>
  </li>
</ul>

<hr />

<h1 id="ì—¬ëŸ¬-ë…¸ë“œ-ë™ì‹œ-ì‹¤í–‰ì¼-ë•Œì˜-ì˜ë¯¸">ì—¬ëŸ¬ ë…¸ë“œ ë™ì‹œ ì‹¤í–‰ì¼ ë•Œì˜ ì˜ë¯¸</h1>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">processing_interrupted()</code>ë¥¼ <strong>ì½ê¸°ë§Œ</strong> í•˜ëŠ” ì´ ë°©ì‹ì€ <strong>ëª¨ë“  ë…¸ë“œê°€ ê°™ì€ ì¸í„°ëŸ½íŠ¸ë¥¼ í•¨ê»˜ ê°ì§€</strong> í•  ìˆ˜ ìˆê²Œ í•´.</p>
  </li>
  <li>
    <p>ê° ë…¸ë“œëŠ” ìê¸° ìš”ì²­ì„ ëŠê³ , <strong>ì½œëŸ¬ í•œ êµ°ë°ì—ì„œë§Œ</strong> <code class="language-plaintext highlighter-rouge">InterruptProcessingException</code>ì„ ë˜ì§€ë©´ ë¨(í˜¹ì€ ê° ë…¸ë“œê°€ ìê¸° ì»¨í…ìŠ¤íŠ¸ì—ì„œ ë˜ì ¸ë„ ë¬´ë°©).</p>
  </li>
  <li>
    <p>í•µì‹¬ì€ <strong><code class="language-plaintext highlighter-rouge">throw_exception_if_processing_interrupted()</code>ë¥¼ ë…¸ë“œ ë‚´ë¶€ í—¬í¼ì—ì„œ í˜¸ì¶œí•˜ì§€ ì•ŠëŠ” ê²ƒ</strong>(ê·¸ í•¨ìˆ˜ëŠ” í”Œë˜ê·¸ë¥¼ ì§€ìš°ë¯€ë¡œ â€˜ì²« ë²ˆì§¸ ì†Œë¹„â€™ ë¬¸ì œê°€ ìƒê¹€).</p>
  </li>
</ul>

<hr />

<p>ì •ë¦¬: <strong>ì‘, í—¬í¼ì—ì„œ<code class="language-plaintext highlighter-rouge">raise</code> ëŒ€ì‹  <code class="language-plaintext highlighter-rouge">return</code> í•´ë„ ì™„ì „íˆ OK.</strong><br />
ì˜¤íˆë ¤ ê¹”ë”í•  ë•Œê°€ ë§ê³ , ìœ„ íŒ¨í„´ëŒ€ë¡œ ì„¼í‹°ë„ì„ ë°˜í™˜í•´ì£¼ë©´ ì‹¤ìˆ˜ë„ ì¤„ì¼ ìˆ˜ ìˆì–´.</p>]]></content><author><name>hvppyarchive</name></author><category term="comfyui" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">VS Code ê²½ê³  í•´ê²°ë²•</title><link href="https://hvppyarchive.github.io/python/vscode-python-runtime-path/" rel="alternate" type="text/html" title="VS Code ê²½ê³  í•´ê²°ë²•" /><published>2025-10-10T10:52:16+09:00</published><updated>2025-10-10T10:52:16+09:00</updated><id>https://hvppyarchive.github.io/python/vscode-python-runtime-path</id><content type="html" xml:base="https://hvppyarchive.github.io/python/vscode-python-runtime-path/"><![CDATA[<p class="chat--user">

VS Codeì—ì„œ íŒŒì´ì¬ ì½”ë”© ì¤‘ì¸ë°, ì–´ë–¤ Frameworkì˜ Extensionì„ ê°œë°œ ì¤‘ì´ì•¼. ê·¸ëŸ°ë° ì½”ë“œì—ì„œ Frameworkì˜ ì½”ë“œë¥¼ Reference í•˜ëŠ”ë° ì´ê²Œ ë™ì‘ ì¤‘ì—ëŠ” ì˜ ë™ì‘í•˜ì§€ë§Œ ê°œë°œ ì¤‘ì—ëŠ” Frameworkì˜ ì†ŒìŠ¤ì½”ë“œëŠ” ê°™ì´ ë¶ˆëŸ¬ì˜¤ì§€ ì•Šê³  ì½”ë”©í•´ì„œ ì—ëŸ¬ì²˜ëŸ¼ ê²½ê³ ê°€ ëœ¨ê³  Go to definition ê°™ì€ ê¸°ëŠ¥ë„ ì˜ ë™ì‘í•˜ì§€ ì•Šì•„. ì´ë¥¼ í•´ê²°í•˜ëŠ” ë°©ë²• ìˆì„ê¹Œ

</p>

<p>ì¢‹ì•„, ìƒí™© ì •ë¦¬í•˜ë©´ â€œì‹¤í–‰ ë•ŒëŠ” ì˜ ë˜ëŠ”ë°, VS Codeì—ì„œ ê°œë°œí•  ë•Œ í”„ë ˆì„ì›Œí¬ ëª¨ë“ˆì„ ëª» ì°¾ì•„ì„œ ê²½ê³ /Go to Definitionì´ ì•ˆ ëœë‹¤â€ëŠ” ê±°ì§€. ì´ê±´ <strong>ì—ë””í„°ê°€ ì“°ëŠ” íŒŒì´ì¬ ì¸í„°í”„ë¦¬í„°/ê²€ìƒ‰ ê²½ë¡œì™€ ëŸ°íƒ€ì„ì˜ ê·¸ê²ƒì´ ë‹¤ë¥´ê¸° ë•Œë¬¸</strong> ì´ì•¼. ì•„ë˜ ìˆœì„œëŒ€ë¡œ í•˜ë©´ ê±°ì˜ í•­ìƒ í•´ê²°ë¼.</p>

<h1 id="1-ì—ë””í„°ê°€-ì‚¬ìš©í•˜ëŠ”-ì¸í„°í”„ë¦¬í„°ì—-í”„ë ˆì„ì›Œí¬ë¥¼-ì„¤ì¹˜">1) ì—ë””í„°ê°€ ì‚¬ìš©í•˜ëŠ” ì¸í„°í”„ë¦¬í„°ì— í”„ë ˆì„ì›Œí¬ë¥¼ ì„¤ì¹˜</h1>

<ol>
  <li>
    <p>í”„ë¡œì íŠ¸ìš© ê°€ìƒí™˜ê²½ì„ í•˜ë‚˜ ì •í•˜ê³ (ë˜ëŠ” ìƒˆë¡œ ë§Œë“¤ê³ ) VS Codeì—ì„œ <strong>Python: Select Interpreter</strong> ë¡œ ê·¸ ì¸í„°í”„ë¦¬í„°ë¥¼ ì„ íƒ.</p>
  </li>
  <li>
    <p>ê·¸ <strong>ê°™ì€</strong> ì¸í„°í”„ë¦¬í„°(venv)ì— í”„ë ˆì„ì›Œí¬ë¥¼ ì„¤ì¹˜.</p>

    <ul>
      <li>pip:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python <span class="nt">-m</span> venv .venv
.venv/Scripts/activate  <span class="c"># (Windows)  |  source .venv/bin/activate  # (macOS/Linux)</span>
pip <span class="nb">install</span> &lt;framework&gt;  <span class="c"># í•„ìš”í•œ extrasê°€ ìˆìœ¼ë©´ &lt;framework&gt;[dev] ì²˜ëŸ¼</span>
</code></pre></div>        </div>
      </li>
      <li>Poetry:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>poetry add <span class="nt">-G</span> dev &lt;framework&gt;
poetry <span class="nb">env </span>use &lt;íŒŒì´ì¬ê²½ë¡œ&gt;
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p>ì´ë ‡ê²Œ í•˜ë©´ Pylance/íŒŒì´ì¬ í™•ì¥ë„ ê·¸ venvì˜ <strong>site-packages</strong> ë¥¼ ë³´ê²Œ ë˜ì–´ ê²½ê³ ê°€ ì‚¬ë¼ì§€ê³  â€œGo to Definitionâ€ë„ ë™ì‘í•´.</p>
  </li>
</ol>

<h1 id="2-í”„ë ˆì„ì›Œí¬-ì†ŒìŠ¤ë¡œ-ë§ì¶°-ê°œë°œí•´ì•¼-í•œë‹¤ë©´-editable-install--ë©€í‹°ë£¨íŠ¸">2) í”„ë ˆì„ì›Œí¬ â€œì†ŒìŠ¤â€ë¡œ ë§ì¶° ê°œë°œí•´ì•¼ í•œë‹¤ë©´ (editable install / ë©€í‹°ë£¨íŠ¸)</h1>

<p>ëŸ°íƒ€ì„ê³¼ ë™ì¼í•œ ë²„ì „ì˜ <strong>ì†ŒìŠ¤</strong> ë¥¼ ë³´ê³  ì‹¶ê±°ë‚˜, í”„ë ˆì„ì›Œí¬ë¥¼ ë¡œì»¬ì—ì„œ ê°™ì´ ìˆ˜ì • ì¤‘ì´ë©´:</p>

<ul>
  <li>í”„ë ˆì„ì›Œí¬ repoë¥¼ ì˜†ì— ì²´í¬ì•„ì›ƒí•´ ë‘ê³  <strong>editable install</strong> :
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install</span> <span class="nt">-e</span> ../framework-repo  <span class="c"># src ë ˆì´ì•„ì›ƒì´ë©´ -e ../framework-repo[src]</span>
</code></pre></div>    </div>
  </li>
  <li>í˜¹ì€ VS Code <strong>ë©€í‹° ë£¨íŠ¸ ì›Œí¬ìŠ¤í˜ì´ìŠ¤</strong> ë¡œ ë‘ í´ë”ë¥¼ í•¨ê»˜ ì—´ê³ , Pylanceê°€ ê²½ë¡œë¥¼ ì•Œë„ë¡ <code class="language-plaintext highlighter-rouge">extraPaths</code>ë¥¼ ì§€ì •:<br />
<strong>.vscode/settings.json</strong>
    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"python.defaultInterpreterPath"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${workspaceFolder}/.venv/bin/python"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"python.analysis.extraPaths"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"../framework-repo"</span><span class="p">,</span><span class="w">          </span><span class="err">//</span><span class="w"> </span><span class="err">íŒ¨í‚¤ì§€</span><span class="w"> </span><span class="err">ë£¨íŠ¸</span><span class="w">
    </span><span class="s2">"../framework-repo/src"</span><span class="w">       </span><span class="err">//</span><span class="w"> </span><span class="err">src</span><span class="w"> </span><span class="err">ë ˆì´ì•„ì›ƒì¼</span><span class="w"> </span><span class="err">ë•Œ</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"python.analysis.typeCheckingMode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"basic"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
</ul>

<h1 id="3-ëŸ°íƒ€ì„ì—ì„œë§Œ-syspathê°€-ë°”ë€ŒëŠ”-í”„ë ˆì„ì›Œí¬í”ŒëŸ¬ê·¸ì¸í™•ì¥-í¬ì¸íŠ¸ì¼-ë•Œ">3) ëŸ°íƒ€ì„ì—ì„œë§Œ sys.pathê°€ ë°”ë€ŒëŠ” í”„ë ˆì„ì›Œí¬(í”ŒëŸ¬ê·¸ì¸/í™•ì¥ í¬ì¸íŠ¸)ì¼ ë•Œ</h1>

<p>í”„ë ˆì„ì›Œí¬ê°€ ì‹¤í–‰ ì‹œì ì—ë§Œ ê²½ë¡œë¥¼ ì¶”ê°€í•œë‹¤ë©´ ì—ë””í„°ëŠ” ê·¸ê±¸ ëª°ë¼. ë‘ ê°€ì§€ ì¤‘ í•˜ë‚˜ë¡œ ë§ì¶°ì¤˜:</p>

<ul>
  <li>
    <p><strong>PYTHONPATH</strong> ì‚¬ìš© (VS Codeê°€ ë¡œë“œí•˜ë„ë¡ <code class="language-plaintext highlighter-rouge">.env</code> í™œìš©)</p>

    <ul>
      <li><strong>.vscode/settings.json</strong>
        <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"python.envFile"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${workspaceFolder}/.env"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>        </div>
      </li>
      <li><strong>.env</strong>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">PYTHONPATH</span><span class="o">=</span>../framework-runtime-path:../another/path
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p>í˜¹ì€ ìœ„ì˜ <strong><code class="language-plaintext highlighter-rouge">python.analysis.extraPaths</code></strong>ë¡œ ë˜‘ê°™ì€ ê²½ë¡œë¥¼ ë„£ì–´ì¤˜.</p>
  </li>
</ul>

<h1 id="4-íƒ€ì…ì •ì˜ë§Œ-í•„ìš”í• -ë•ŒëŒ€í˜•ë¹„ê³µê°œ-í”„ë ˆì„ì›Œí¬">4) íƒ€ì…/ì •ì˜ë§Œ í•„ìš”í•  ë•Œ(ëŒ€í˜•/ë¹„ê³µê°œ í”„ë ˆì„ì›Œí¬)</h1>

<p>ì‹¤í–‰ ê°€ëŠ¥í•œ ì „ì²´ ì„¤ì¹˜ê°€ ë¶€ë‹´ìŠ¤ëŸ¬ìš°ë©´ <strong>stub(.pyi)</strong> ë§Œ ë§Œë“¤ì–´ì„œ ì°¸ì¡°í•´ë„ â€œGo to Definition/íƒ€ì… ì¶”ë¡ â€ì´ ì¢‹ì•„ì ¸.</p>

<ul>
  <li>Pyrightë¡œ ìŠ¤í… ìƒì„±:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pyright <span class="nt">--createstub</span> &lt;framework_pkg_name&gt;
</code></pre></div>    </div>
  </li>
</ul>

<p>ìƒì„±ëœ ìŠ¤í… í´ë”ë¥¼ í”„ë¡œì íŠ¸ì˜ <code class="language-plaintext highlighter-rouge">typings/</code>ì— ë‘ê³ :
    <code class="language-plaintext highlighter-rouge">json
    {
      "python.analysis.stubPath": "typings"
    }
   </code></p>

<ul>
  <li>mypyì˜ <code class="language-plaintext highlighter-rouge">stubgen</code>ì„ ì¨ë„ ë¨:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python <span class="nt">-m</span> mypy.stubgen <span class="nt">-m</span> &lt;framework_pkg_name&gt; <span class="nt">-o</span> typings
</code></pre></div>    </div>
  </li>
</ul>

<h1 id="5-ë„ì»¤ì›ê²©-ëŸ°íƒ€ì„ì—ì„œë§Œ-ì„¤ì¹˜ë˜ì–´-ìˆì„-ë•Œ">5) ë„ì»¤/ì›ê²© ëŸ°íƒ€ì„ì—ì„œë§Œ ì„¤ì¹˜ë˜ì–´ ìˆì„ ë•Œ</h1>

<p>ëŸ°íƒ€ì„ì´ Docker/ì›ê²©(SSH)ë¼ë©´ <strong>Dev Containers</strong> ë˜ëŠ” <strong>Remote - SSH</strong> í™•ì¥ìœ¼ë¡œ â€œì½”ë”©ë„ ê·¸ í™˜ê²½ì—ì„œâ€ í•˜ê²Œ ë§Œë“œëŠ” ê²Œ ì œì¼ ê¹”ë”í•´. ê·¸ëŸ¬ë©´ ì—ë””í„°ê°€ ë³´ëŠ” ì¸í„°í”„ë¦¬í„° == ëŸ°íƒ€ì„ ì¸í„°í”„ë¦¬í„°ê°€ ë˜ì–´ ê²½ë¡œ ë¬¸ì œ ìì²´ê°€ ì‚¬ë¼ì§.</p>

<h1 id="6-ì¶”ê°€-íŒ-ìì˜í•˜ì§€ë§Œ-ìœ ìš©">6) ì¶”ê°€ íŒ (ìì˜í•˜ì§€ë§Œ ìœ ìš©)</h1>

<ul>
  <li>
    <p>ê²½ê³ ë§Œ ì ê¹ ìˆ¨ê¸°ë ¤ë©´(ì›ì¸ í•´ê²° ì „ ì„ì‹œ):</p>

    <ul>
      <li>íŒŒì¼ ìƒë‹¨ì— <code class="language-plaintext highlighter-rouge"># pyright: reportMissingImports=false</code> (í˜¹ì€ í•´ë‹¹ import ì¤„ì— <code class="language-plaintext highlighter-rouge"># type: ignore[import]</code>)<br />
â†’ ê·¼ë³¸ í•´ê²°ì€ ì•„ë‹˜.</li>
    </ul>
  </li>
  <li>
    <p>ë„¤ì„ìŠ¤í˜ì´ìŠ¤ íŒ¨í‚¤ì§€(PEP 420)ë‚˜ <code class="language-plaintext highlighter-rouge">src/</code> ë ˆì´ì•„ì›ƒì´ë©´ <strong>íŒ¨í‚¤ì§€ ë£¨íŠ¸</strong> ê°€ ë§ê²Œ ì¡í˜”ëŠ”ì§€ í™•ì¸.</p>
  </li>
  <li>
    <p>ë™ì  ì†ì„±/ì»´íŒŒì¼ë“œ ëª¨ë“ˆì´ë¼ ì •ì˜ ì í”„ê°€ ì–´ë ¤ìš°ë©´:</p>
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span>
<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">framework</span> <span class="kn">import</span> <span class="n">FancyAPI</span>  <span class="c1"># ì—ë””í„°ìš© íŒíŠ¸
</span></code></pre></div>    </div>
  </li>
</ul>

<hr />

<h2 id="ê°€ì¥-ë¹ ë¥¸-ì²´í¬ë¦¬ìŠ¤íŠ¸">ê°€ì¥ ë¹ ë¥¸ ì²´í¬ë¦¬ìŠ¤íŠ¸</h2>

<ol>
  <li>
    <p>VS Codeì—ì„œ <strong>Python Interpreter</strong> ê°€ ë‚´ê°€ ì“°ëŠ” venvë¡œ ë§ë‚˜?</p>
  </li>
  <li>
    <p>ê·¸ venvì— <strong>í”„ë ˆì„ì›Œí¬ê°€ ì„¤ì¹˜</strong> ë˜ì–´ ìˆë‚˜(ë˜ëŠ” <code class="language-plaintext highlighter-rouge">pip install -e</code>ë¡œ ì—°ê²°í–ˆë‚˜)?</p>
  </li>
  <li>
    <p>ì†ŒìŠ¤ íŠ¸ë¦¬ë¼ë©´ <strong><code class="language-plaintext highlighter-rouge">python.analysis.extraPaths</code>/<code class="language-plaintext highlighter-rouge">PYTHONPATH</code></strong>ê°€ í”„ë ˆì„ì›Œí¬ ë£¨íŠ¸ë¥¼ ê°€ë¦¬í‚¤ë‚˜?</p>
  </li>
  <li>
    <p>íŠ¹ë³„í•œ ê²½ìš°ì—” <strong>stub</strong> ìƒì„±í•´ì„œ <code class="language-plaintext highlighter-rouge">stubPath</code> ì„¤ì •.</p>
  </li>
</ol>

<p>ì›í•˜ì‹œë©´ í˜„ì¬ í”„ë¡œì íŠ¸ êµ¬ì¡°(í´ë” ë ˆì´ì•„ì›ƒ/ê°€ìƒí™˜ê²½/ì„¤ì¹˜ ë°©ì‹) ì•Œë ¤ì¤˜. ê±°ê¸°ì— ë§ì¶˜ <strong>settings.json / .env / ì„¤ì¹˜ ì»¤ë§¨ë“œ</strong> ë¥¼ ë”± ë§ê²Œ ì¨ì¤„ê²Œ.</p>]]></content><author><name>hvppyarchive</name></author><category term="python" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">Async request ì·¨ì†Œ ì²˜ë¦¬</title><link href="https://hvppyarchive.github.io/comfyui/async-request/" rel="alternate" type="text/html" title="Async request ì·¨ì†Œ ì²˜ë¦¬" /><published>2025-10-10T10:33:16+09:00</published><updated>2025-10-10T10:33:16+09:00</updated><id>https://hvppyarchive.github.io/comfyui/async-request-</id><content type="html" xml:base="https://hvppyarchive.github.io/comfyui/async-request/"><![CDATA[<p class="chat--user">

comfyuiì—ì„œ custom nodeì˜ ë©”ì¸ í•¨ìˆ˜ë¥¼ asyncë¡œ ë§Œë“¤ ìˆ˜ ìˆê²Œ ë˜ì—ˆì–´. ê·¸ë¦¬ê³ , openai python íŒ¨í‚¤ì§€ì—ì„œ AsyncOpenAIì™€ aiohttpë¥¼ ì´ìš©í•´ì„œ asyncí•˜ê²Œ requestë¥¼ ë³´ë‚¼ ìˆ˜ ìˆì–´. ê·¼ë° ë¬¸ì œëŠ” UIì—ì„œ stopì„ ë³´ë‚´ê³  interruptê°€ ì¦‰ì‹œ ë™ì‘í•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ”ê±°ì•¼. requestë¥¼ ë³´ë‚¸ í›„ await í•˜ëŠ” ë„ì¤‘ì— ì‘ì—…ì´ ì·¨ì†Œë˜ê²Œ í•˜ê³  ì‹¶ì–´

</p>

<p>ì¢‹ì•„, í•µì‹¬ì€ â€œë„¤íŠ¸ì›Œí¬ ìš”ì²­ await ì¤‘ì—ë„ ë°”ë¡œ ëŠê¸°ê²Œâ€ ë§Œë“œëŠ” ê±°ì•¼.<br />
asyncioì—ì„œëŠ” <strong>ì·¨ì†Œ ì‹ í˜¸ì™€ ì‹¤ì œ ì‘ì—…ì„ â€˜ê²½ìŸ(race)â€™</strong> ì‹œí‚¤ë©´ ë¼. ì¦‰, ìš”ì²­ì„ <code class="language-plaintext highlighter-rouge">Task</code>ë¡œ ë§Œë“¤ê³ , UIì—ì„œ ì˜¤ëŠ” stop ì‹ í˜¸(ì´í•˜ <code class="language-plaintext highlighter-rouge">stop_event</code>)ì˜ <code class="language-plaintext highlighter-rouge">wait()</code>ë„ <code class="language-plaintext highlighter-rouge">Task</code>ë¡œ ë§Œë“¤ì–´ì„œ <strong>ë‘˜ ì¤‘ ë¨¼ì € ëë‚˜ëŠ” ìª½</strong> ì„ ë³´ê³  í–‰ë™ì„ ë°”ê¾¸ë©´ ì¦‰ì‹œ ì¤‘ë‹¨ì´ ê°€ëŠ¥í•´.</p>

<p>ì•„ë˜ë¥¼ ê·¸ëŒ€ë¡œ ê°€ì ¸ë‹¤ ì“¸ ìˆ˜ ìˆê²Œ ë‹¨ê³„ë³„(ê·¸ë¦¬ê³  ì•ˆì „í•œ) íŒ¨í„´ìœ¼ë¡œ ì •ë¦¬í–ˆì–´.</p>

<hr />

<h1 id="1-ê³µí†µ-ìœ í‹¸-ì·¨ì†Œ-ê°€ëŠ¥í•œ-await-ë˜í¼">1) ê³µí†µ ìœ í‹¸: ì·¨ì†Œ ê°€ëŠ¥í•œ await ë˜í¼</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>

<span class="k">class</span> <span class="nc">StopByUser</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">UI stop/interruptë¡œ ì¤‘ë‹¨ë˜ì—ˆìŒì„ ë‚˜íƒ€ë‚´ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ ì˜ˆì™¸.</span><span class="sh">"""</span>
    <span class="k">pass</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">await_cancellable</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    coro(ì½”ë£¨í‹´)ì™€ stop_event.wait()ë¥¼ ê²½ìŸì‹œí‚¨ë‹¤.
    - stopì´ ë¨¼ì € ì˜¤ë©´ coro Taskë¥¼ cancelí•˜ê³  ì •ë¦¬í•œ ë’¤ StopByUserë¥¼ ì˜¬ë¦°ë‹¤.
    - ìš”ì²­ì´ ë¨¼ì € ëë‚˜ë©´ stop ëŒ€ê¸° Taskë¥¼ ì·¨ì†Œí•˜ê³  ê²°ê³¼ë¥¼ ë°˜í™˜í•œë‹¤.
    </span><span class="sh">"""</span>
    <span class="n">req_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">coro</span><span class="p">)</span>
    <span class="n">stop_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">stop_event</span><span class="p">.</span><span class="nf">wait</span><span class="p">())</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">done</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span>
            <span class="p">{</span><span class="n">req_task</span><span class="p">,</span> <span class="n">stop_task</span><span class="p">},</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">stop_task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
            <span class="c1"># UIê°€ stopì„ ëˆŒë €ë‹¤: ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì„ ì·¨ì†Œ
</span>            <span class="n">req_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
            <span class="c1"># ì·¨ì†Œ ì •ë¦¬ ëê¹Œì§€ ê¸°ë‹¤ë ¤ ê²½ê³ /ë¦¬ì†ŒìŠ¤ ëˆ„ìˆ˜ ë°©ì§€
</span>            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">req_task</span>
            <span class="k">raise</span> <span class="nc">StopByUser</span><span class="p">(</span><span class="sh">"</span><span class="s">Stopped by user</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># ìš”ì²­ì´ ë¨¼ì € ëë‚¨: stop ëŒ€ê¸°ëŠ” ì·¨ì†Œ
</span>        <span class="n">stop_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">stop_task</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">req_task</span>  <span class="c1"># ê²°ê³¼ ë¦¬í„´
</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
        <span class="c1"># ë°”ê¹¥ ì»¨í…ìŠ¤íŠ¸(ComfyUI ì‹¤í–‰ê¸°)ê°€ ì´ Task ìì²´ë¥¼ ì·¨ì†Œí•œ ê²½ìš°: ë°”ë¡œ ì „íŒŒ
</span>        <span class="k">raise</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># í˜¹ì‹œ ë‚¨ì•„ìˆìœ¼ë©´ í™•ì‹¤íˆ ì •ë¦¬
</span>        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="n">req_task</span><span class="p">,</span> <span class="n">stop_task</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">.</span><span class="nf">done</span><span class="p">():</span>
                <span class="n">t</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">t</span>
</code></pre></div></div>

<blockquote>
  <p>ì¤‘ìš”: ì½”ë“œ ì–´ë”˜ê°€ì— <code class="language-plaintext highlighter-rouge">except Exception:</code> ê°™ì€ ê´‘ë²”ìœ„í•œ ì˜ˆì™¸ ì²˜ë¦¬ê¸°ê°€ ìˆë‹¤ë©´, <strong>ë°˜ë“œì‹œ</strong><br />
 <code class="language-plaintext highlighter-rouge">except asyncio.CancelledError: raise</code> ë¥¼ <strong>ë§¨ ìœ„ì— ë”°ë¡œ</strong> ë‘ì–´ ì·¨ì†Œê°€ ì‚¼ì¼œì§€ì§€ ì•Šê²Œ í•˜ì„¸ìš”.<br />
 (íŒŒì´ì¬ ë²„ì „ì— ë”°ë¼ <code class="language-plaintext highlighter-rouge">CancelledError</code>ê°€ ì¼ë°˜ <code class="language-plaintext highlighter-rouge">Exception</code>ì— ì¡í ìˆ˜ ìˆìœ¼ë‹ˆ ëª…ì‹œì ìœ¼ë¡œ ë¶„ê¸°í•˜ëŠ” ê²Œ ì•ˆì „í•©ë‹ˆë‹¤.)</p>
</blockquote>

<hr />

<h1 id="2-comfyui-ì»¤ìŠ¤í…€-ë…¸ë“œmainasyncì—ì„œ-ì ìš©">2) ComfyUI ì»¤ìŠ¤í…€ ë…¸ë“œ(main=async)ì—ì„œ ì ìš©</h1>

<p>ComfyUIê°€ stopì„ ëˆ„ë¥´ë©´ ë‚´ë¶€ì ìœ¼ë¡œ â€œì¤‘ë‹¨ í”Œë˜ê·¸/ì´ë²¤íŠ¸â€ê°€ ì¼œì§ˆ í…ë°, ê·¸ê±¸ <code class="language-plaintext highlighter-rouge">stop_event</code>(asyncio.Event í˜¸í™˜)ë¡œ ë°›ëŠ”ë‹¤ê³  ê°€ì •í•´ ë³´ì.<br />
(ComfyUIì—ì„œ ì œê³µí•˜ëŠ” ì‹¤ì œ ì¸í„°ëŸ½íŠ¸ ì‹ í˜¸ë¥¼ ì–´ë–»ê²Œ ì–»ëŠ”ì§€ëŠ” í”„ë¡œì íŠ¸ë§ˆë‹¤ ë‹¤ë¥¼ ìˆ˜ ìˆì–´. ë…¸ë“œì— ì£¼ì… ë°›ê±°ë‚˜, ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸ì—ì„œ êº¼ë‚´ ì“°ëŠ” ì‹ìœ¼ë¡œ ì—°ê²°í•´ ì£¼ë©´ ëœë‹¤.)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>

<span class="k">class</span> <span class="nc">AsyncLLMNode</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">prompt</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">})}}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">main</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LLM</span><span class="sh">"</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">stop_event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c1"># stop_eventëŠ” ComfyUI ìª½ì—ì„œ ë„˜ê²¨ì£¼ë„ë¡ ì—°ê²°í•´ ë‘ëŠ” ê±¸ ê¶Œì¥
</span>        <span class="k">if</span> <span class="n">stop_event</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># ìµœì•…ì˜ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ë”ë¯¸ (ì¦‰ì‹œ ì™„ë£Œë˜ì§€ ì•ŠìŒ)
</span>            <span class="n">stop_event</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Event</span><span class="p">()</span>

        <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">()</span>  <span class="c1"># í•„ìš”ì‹œ api_key, base_url ë“± ì„¤ì •
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># â—‡ ë¹„-ìŠ¤íŠ¸ë¦¬ë° ìš”ì²­ ì˜ˆì‹œ
</span>            <span class="n">coro</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
                <span class="n">temperature</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">await_cancellable</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span><span class="p">.</span><span class="n">content</span>
            <span class="nf">return </span><span class="p">(</span><span class="n">text</span><span class="p">,)</span>

        <span class="k">except</span> <span class="n">StopByUser</span><span class="p">:</span>
            <span class="c1"># ComfyUIê°€ ì¦‰ì‹œ ë©ˆì·„ìŒì„ ìœ„ìª½ìœ¼ë¡œ ì•Œë¦¬ê±°ë‚˜, ë¹ˆ ê²°ê³¼/ìƒíƒœ ë©”ì‹œì§€ë¥¼ ë°˜í™˜
</span>            <span class="c1"># ComfyUI ìª½ ì •ì±…ì— ë§ì¶° raise/return ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒ
</span>            <span class="k">raise</span>  <span class="c1"># ë³´í†µì€ raiseë¡œ ì „íŒŒí•˜ëŠ” ê²Œ ì¸í„°ëŸ½íŠ¸ ì²´ì¸ì— ì¶©ì‹¤
</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="c1"># ë°”ê¹¥ì—ì„œ Task ìì²´ê°€ ì·¨ì†Œëœ ê²½ìš°
</span>            <span class="k">raise</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># http ì»¤ë„¥ì…˜ ì •ë¦¬
</span>            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="3-ìŠ¤íŠ¸ë¦¬ë°ë¶€ë¶„-ì‘ë‹µì¼-ë•Œë„-ì¦‰ì‹œ-ì¤‘ë‹¨">3) ìŠ¤íŠ¸ë¦¬ë°(ë¶€ë¶„ ì‘ë‹µ)ì¼ ë•Œë„ ì¦‰ì‹œ ì¤‘ë‹¨</h1>

<p>ìŠ¤íŠ¸ë¦¬ë°ì€ ë‚´ë¶€ì ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">async for</code>ë¡œ ì²­í¬ë¥¼ ì½ëŠ” ë™ì•ˆ <code class="language-plaintext highlighter-rouge">__anext__()</code>ì—ì„œ ë¸”ë¡ë¼ì„œ<br />
stopì„ ëˆŒëŸ¬ë„ ë°”ë¡œ ë°˜ì‘ì„ ëª»í•  ìˆ˜ ìˆì–´. ì´ë•Œë„ <strong>chunk ì½ê¸° vs stop</strong> ë¥¼ ê²½ìŸì‹œí‚¤ë©´ í•´ê²°ë¼.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">stream_chat_cancellable</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">):</span>
    <span class="c1"># ìƒˆë¡œìš´ Responses API ì˜ˆì‹œ (í•„ìš”ì— ë§ì¶° Chat Completionsë¡œ ë°”ê¿”ë„ ë™ì¼ íŒ¨í„´)
</span>    <span class="k">async</span> <span class="k">with</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">stream</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
        <span class="n">aiter</span> <span class="o">=</span> <span class="n">stream</span><span class="p">.</span><span class="nf">aiter_text</span><span class="p">()</span>  <span class="c1"># í…ìŠ¤íŠ¸ ì²­í¬ ì´í„°ë ˆì´í„°
</span>        <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">next_chunk</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">aiter</span><span class="p">.</span><span class="nf">__anext__</span><span class="p">())</span>
            <span class="n">stop_task</span>  <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">stop_event</span><span class="p">.</span><span class="nf">wait</span><span class="p">())</span>
            <span class="n">done</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span>
                <span class="p">{</span><span class="n">next_chunk</span><span class="p">,</span> <span class="n">stop_task</span><span class="p">},</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">stop_task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="c1"># ì½ê¸° ì¤‘ë‹¨ + ì—°ê²° ì •ë¦¬
</span>                <span class="n">next_chunk</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">next_chunk</span>
                <span class="k">await</span> <span class="n">stream</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>  <span class="c1"># ì„œë²„ ìª½ ìŠ¤íŠ¸ë¦¼ë„ ë‹«ê¸°
</span>                <span class="k">raise</span> <span class="nc">StopByUser</span><span class="p">(</span><span class="sh">"</span><span class="s">Stopped by user</span><span class="sh">"</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">next_chunk</span><span class="p">.</span><span class="nf">result</span><span class="p">())</span>
            <span class="k">except</span> <span class="nb">StopAsyncIteration</span><span class="p">:</span>
                <span class="c1"># ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ
</span>                <span class="k">break</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">stop_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">stop_task</span>

        <span class="k">return</span> <span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>
</code></pre></div></div>

<p>ComfyUI ë…¸ë“œì—ì„œ:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">stop_event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">stop_event</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">stop_event</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Event</span><span class="p">()</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">stream_chat_cancellable</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">text</span><span class="p">,)</span>
    <span class="k">except</span> <span class="n">StopByUser</span><span class="p">:</span>
        <span class="k">raise</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="4-aiohttp-ìˆœìˆ˜-ì‚¬ìš©-ì‹œ-ì˜ˆì‹œ">4) aiohttp ìˆœìˆ˜ ì‚¬ìš© ì‹œ ì˜ˆì‹œ</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">aiohttp</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>
<span class="kn">from</span> <span class="n">yarl</span> <span class="kn">import</span> <span class="n">URL</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">fetch_json_cancellable</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="p">.</span><span class="nc">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="c1"># POST ì½”ë£¨í‹´ ìƒì„±
</span>        <span class="k">async</span> <span class="k">def</span> <span class="nf">do_post</span><span class="p">():</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
                <span class="n">resp</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">resp</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>

        <span class="k">return</span> <span class="k">await</span> <span class="nf">await_cancellable</span><span class="p">(</span><span class="nf">do_post</span><span class="p">(),</span> <span class="n">stop_event</span><span class="p">)</span>
</code></pre></div></div>

<blockquote>
  <p>ì°¸ê³ : <code class="language-plaintext highlighter-rouge">aiohttp</code>ëŠ” Task ì·¨ì†Œ ì‹œ ì†Œì¼“ì„ ë‹«ìœ¼ë©° <code class="language-plaintext highlighter-rouge">CancelledError</code>ê°€ ì „íŒŒë¼ìš”.<br />
 ìœ„ì˜ íŒ¨í„´ì²˜ëŸ¼ <em>í•­ìƒ</em> loser taskë¥¼ <code class="language-plaintext highlighter-rouge">cancel()</code>í•˜ê³  <code class="language-plaintext highlighter-rouge">await</code>í•´ì„œ ê²½ê³  ì—†ì´ ì •ë¦¬í•˜ì„¸ìš”.</p>
</blockquote>

<hr />

<h1 id="5-í”í•œ-ì¦‰ì‹œ-ì¤‘ë‹¨ì´-ì•ˆ-ë˜ëŠ”-ì›ì¸-ì²´í¬ë¦¬ìŠ¤íŠ¸">5) í”í•œ â€œì¦‰ì‹œ ì¤‘ë‹¨ì´ ì•ˆ ë˜ëŠ”â€ ì›ì¸ ì²´í¬ë¦¬ìŠ¤íŠ¸</h1>

<ol>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">CancelledError</code>ë¥¼ ì‚¼í‚¤ëŠ” ì˜ˆì™¸ ì²˜ë¦¬</strong></p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">except Exception:</code> ì´ ìˆë‹¤ë©´ ë°”ë¡œ ìœ„ì— <code class="language-plaintext highlighter-rouge">except asyncio.CancelledError: raise</code> ë¥¼ ì¶”ê°€.</li>
    </ul>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">await</code> ì—†ì´ ë™ê¸° ë¸”ë¡œí‚¹ ì½”ë“œ</strong></p>

    <ul>
      <li>CPU ë°”ìš´ë“œ ë£¨í”„/ë¸”ë¡œí‚¹ I/OëŠ” ì´ë²¤íŠ¸ ë£¨í”„ë¥¼ ë§‰ì•„ ì·¨ì†Œê°€ ëŠ¦ì–´ì§ â†’ <code class="language-plaintext highlighter-rouge">await</code> ê°€ëŠ¥í•œ APIë¡œ ë°”ê¾¸ê±°ë‚˜, <code class="language-plaintext highlighter-rouge">run_in_executor()</code>ë¡œ ë¶„ë¦¬.</li>
    </ul>
  </li>
  <li>
    <p><strong>ìŠ¤íŠ¸ë¦¬ë° ë£¨í”„ì—ì„œ stopì„ ì•ˆ ë³´ê³  ìˆìŒ</strong></p>

    <ul>
      <li>ìœ„ì˜ â€œìŠ¤íŠ¸ë¦¬ë° ê²½ìŸâ€ íŒ¨í„´ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">__anext__()</code>ì™€ <code class="language-plaintext highlighter-rouge">stop_event.wait()</code>ë¥¼ ê²½ìŸì‹œí‚¤ê¸°.</li>
    </ul>
  </li>
  <li>
    <p><strong>ì •ë¦¬(cleanup)ë¥¼ ì·¨ì†Œê°€ ë®ì–´ë²„ë¦¼</strong></p>

    <ul>
      <li>ì •ë¦¬ ê³¼ì •ì€ <code class="language-plaintext highlighter-rouge">asyncio.shield()</code>ë¡œ ê°ì‹¸ê±°ë‚˜ <code class="language-plaintext highlighter-rouge">with contextlib.suppress(asyncio.CancelledError)</code>ë¡œ ë§ˆë¬´ë¦¬.</li>
    </ul>
  </li>
  <li>
    <p><strong>ê¸´ ë„¤íŠ¸ì›Œí¬ íƒ€ì„ì•„ì›ƒ</strong></p>

    <ul>
      <li>ì·¨ì†Œ ìì²´ëŠ” íƒ€ì„ì•„ì›ƒê³¼ ë¬´ê´€í•˜ì§€ë§Œ, ë¼ì´ë¸ŒëŸ¬ë¦¬ ì •ë¦¬ê°€ ì§€ì—°ë  ìˆ˜ ìˆìŒ â†’ ì„¸ì…˜/ìŠ¤íŠ¸ë¦¼ì„ <code class="language-plaintext highlighter-rouge">close()</code> í•´ì£¼ê¸°.</li>
    </ul>
  </li>
</ol>

<hr />

<h1 id="6-comfyui-ìª½-stop_event-ì—°ê²°-íŒ">6) ComfyUI ìª½ â€˜stop_eventâ€™ ì—°ê²° íŒ</h1>

<ul>
  <li>
    <p>í”„ë¡œì íŠ¸ì— ë”°ë¼ ë‹¤ë¥´ì§€ë§Œ, ë³´í†µ <strong>ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸</strong> ë‚˜ <strong>ë…¸ë“œ ì¸ì ì£¼ì…</strong> ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">asyncio.Event</code>ë¥¼ ë°›ì„ ìˆ˜ ìˆê²Œ í•´ë‘ë©´ ê°€ì¥ ê¹”ë”í•´.</p>
  </li>
  <li>
    <p>ë§Œì•½ ì§€ê¸ˆì€ ê·¸ëŸ° í›…ì´ ì—†ë‹¤ë©´:</p>

    <ul>
      <li>
        <p>ìµœì†Œí•œ ì£¼ê¸°ì ìœ¼ë¡œ í™•ì¸í•˜ëŠ” pollingì„ ë„£ëŠ” ëŒ€ì‹ , <strong>ìœ„ì˜ ê²½ìŸ íŒ¨í„´</strong> ì„ ì‚¬ìš©í•˜ë©´ â€œawait ì¤‘ì—ë„â€ ë°”ë¡œ ë°˜ì‘í•œë‹¤.</p>
      </li>
      <li>
        <p>stopì„ ëˆ„ë¥¼ ë•Œ ë…¸ë“œ ì¸¡ì— <code class="language-plaintext highlighter-rouge">stop_event.set()</code>ì´ í˜¸ì¶œë˜ë„ë¡ ì—°ê²°(ì£¼ì…)ë§Œ í•´ì£¼ë©´ ëœë‹¤.</p>
      </li>
    </ul>
  </li>
</ul>

<hr />

<p>í•„ìš”í•˜ë©´ ë„ˆì˜ í˜„ì¬ ë…¸ë“œ ì½”ë“œ ì¼ë¶€ë¥¼ ë¶™ì—¬ì¤˜. ê±°ê¸°ì— ë§ì¶° <code class="language-plaintext highlighter-rouge">await_cancellable</code>ì„ ë”± ë“¤ì–´ë§ê²Œ ë¦¬íŒ©í„°ë§í•´ ì¤„ê²Œ.</p>

<p class="chat--user">

stop_eventë¥¼ ë„£ëŠ”ë‹¤ëŠ”ê²Œ ë­”ì§€ ëª¨ë¥´ê² ì–´. comfyui ë‚´ë¶€ì ìœ¼ë¡œ interrupt ë²„íŠ¼ì´ ìˆì–ì•„? ê·¸ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ì·¨ì†Œë˜ë©´ ì¢‹ê² ì–´

</p>

<p>ì¢‹ì•„, â€œUIì˜ Interrupt ë²„íŠ¼(ë˜ëŠ” /interrupt)ì´ ëˆŒë¦¬ë©´ ë‚´ async ì»¤ìŠ¤í…€ ë…¸ë“œê°€ ì§€ê¸ˆ <code class="language-plaintext highlighter-rouge">await</code> ì¤‘ì¸ OpenAI ìš”ì²­ì„ ì¦‰ì‹œ ëŠê³  ì‹¶ë‹¤â€ê°€ ëª©í‘œì§€ìš”. í•µì‹¬ì€ <strong>ComfyUIê°€ ì¸í„°ëŸ½íŠ¸ë¥¼ â€œí”Œë˜ê·¸â€ë¡œë§Œ ì•Œë¦¬ê³ , ì‹¤ì œë¡œëŠ” ë…¸ë“œê°€ í˜‘ì¡°ì ìœ¼ë¡œ ì·¨ì†Œë¥¼ ì²˜ë¦¬í•´ì•¼</strong> í•œë‹¤ëŠ” ì ì´ì—ìš”. ì•„ë˜ë¥¼ ê·¸ëŒ€ë¡œ ë„£ìœ¼ë©´ ë©ë‹ˆë‹¤ â€” ë‹¨ê³„ë³„ë¡œ ì„¤ëª…í• ê²Œìš”.</p>

<hr />

<h2 id="1-comfyuiê°€-ì¸í„°ëŸ½íŠ¸ë¥¼-ì–´ë–»ê²Œ-ì•Œë¦¬ëƒ">1) ComfyUIê°€ ì¸í„°ëŸ½íŠ¸ë¥¼ ì–´ë–»ê²Œ ì•Œë¦¬ëƒ</h2>

<ul>
  <li>
    <p>í”„ë¡ íŠ¸ì—”ë“œ Interrupt ë²„íŠ¼/ë‹¨ì¶•í‚¤ê°€ <strong><code class="language-plaintext highlighter-rouge">POST /interrupt</code></strong> ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. ì„œë²„ëŠ” ë‚´ë¶€ ì¸í„°ëŸ½íŠ¸ í”Œë˜ê·¸ë¥¼ ì„¸íŒ…í•´ìš”. <a href="https://docs.comfy.org/development/comfyui-server/comms_routes?utm_source=chatgpt.com">ComfyUI+2</a></p>
  </li>
  <li>
    <p>ì‹¤í–‰ê¸°ëŠ” ë‹¤ìŒ ë…¸ë“œ ê²½ê³„ í˜¹ì€ ë…¸ë“œ ë‚´ë¶€ì—ì„œ ì²´í¬ë  ë•Œ <strong><code class="language-plaintext highlighter-rouge">InterruptProcessingException</code></strong> ìœ¼ë¡œ ì¤‘ë‹¨ì„ ì „íŒŒí•˜ê³ , ì›¹ì†Œì¼“ ì´ë²¤íŠ¸ <strong><code class="language-plaintext highlighter-rouge">execution_interrupted</code></strong> ë¥¼ ë³´ëƒ…ë‹ˆë‹¤. <a href="https://docs.comfy.org/development/comfyui-server/comms_messages?utm_source=chatgpt.com">ComfyUI</a></p>
  </li>
  <li>
    <p>ë‹¨, <strong>ë…¸ë“œê°€ ë¸”ë¡œí‚¹ ìƒíƒœ(íƒ€ì´íŠ¸ ë£¨í”„/ë¸”ë¡œí‚¹ I/O)</strong> ë©´ ì¸í„°ëŸ½íŠ¸ê°€ ë°”ë¡œ ì²˜ë¦¬ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ ë…¸ë“œê°€ <strong>ì£¼ê¸°ì ìœ¼ë¡œ ì¸í„°ëŸ½íŠ¸ë¥¼ ì²´í¬</strong> í•˜ê±°ë‚˜ <strong><code class="language-plaintext highlighter-rouge">await</code> ë¥¼ ì·¨ì†Œ</strong>í•´ ì¤˜ì•¼ í•´ìš”. <a href="https://github.com/comfyanonymous/ComfyUI/issues/3131?utm_source=chatgpt.com">GitHub</a></p>
  </li>
</ul>

<hr />

<h2 id="2-ì»¤ìŠ¤í…€-ë…¸ë“œì—ì„œ-í˜‘ì¡°ì -ì·¨ì†Œë¥¼-ë¶™ì´ëŠ”-ê°€ì¥-ì‰¬ìš´-ë°©ë²•">2) ì»¤ìŠ¤í…€ ë…¸ë“œì—ì„œ â€œí˜‘ì¡°ì  ì·¨ì†Œâ€ë¥¼ ë¶™ì´ëŠ” ê°€ì¥ ì‰¬ìš´ ë°©ë²•</h2>

<p>ComfyUIëŠ” <code class="language-plaintext highlighter-rouge">comfy.model_management.throw_exception_if_processing_interrupted()</code> ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ì´ê±¸ ì£¼ê¸°ì ìœ¼ë¡œ í˜¸ì¶œí•˜ë©´ ì¸í„°ëŸ½íŠ¸ ì‹œ <code class="language-plaintext highlighter-rouge">InterruptProcessingException</code> ì„ ë˜ì ¸ìš”. (ê³µì‹ ì½”ë“œì™€ ì—¬ëŸ¬ ì˜ˆì‹œ ë…¸ë“œì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤.) <a href="https://gitee.com/bug531/comfy-ui/blob/master/main.py?skip_mobile=true&amp;utm_source=chatgpt.com">Gitee+2</a></p>

<p>ì•„ì´ë””ì–´: <strong>ìš”ì²­ íƒœìŠ¤í¬</strong> ì™€ <strong>ì¸í„°ëŸ½íŠ¸ ê°ì‹œ íƒœìŠ¤í¬</strong> ë¥¼ ë™ì‹œì— ëŒë¦¬ê³ , ê°ì§€ë˜ë©´ ìš”ì²­ íƒœìŠ¤í¬ë¥¼ <code class="language-plaintext highlighter-rouge">cancel()</code>ë¡œ ëŠìŠµë‹ˆë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ì»¤ìŠ¤í…€ ë…¸ë“œ íŒŒì¼ ì•ˆ
</span><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">aiohttp</span>
<span class="kn">import</span> <span class="n">comfy.model_management</span> <span class="k">as</span> <span class="n">mm</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">_watch_interrupt_and_cancel</span><span class="p">(</span><span class="n">task</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">ComfyUI ì¸í„°ëŸ½íŠ¸ê°€ ì˜¤ë©´ ì£¼ì–´ì§„ taskë¥¼ cancel()</span><span class="sh">"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">task</span><span class="p">.</span><span class="nf">done</span><span class="p">():</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>  <span class="c1"># í´ë§ ì£¼ê¸°
</span>            <span class="n">mm</span><span class="p">.</span><span class="nf">throw_exception_if_processing_interrupted</span><span class="p">()</span>  <span class="c1"># ì¸í„°ëŸ½íŠ¸ë©´ ì˜ˆì™¸ ë°œìƒ
</span>    <span class="k">except</span> <span class="n">mm</span><span class="p">.</span><span class="n">InterruptProcessingException</span><span class="p">:</span>
        <span class="n">task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>  <span class="c1"># ë©”ì¸ ìš”ì²­ ì·¨ì†Œ
</span>
<span class="k">class</span> <span class="nc">MyAsyncNode</span><span class="p">:</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">example</span><span class="sh">"</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">prompt</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">})}}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">()</span>  <span class="c1"># í•„ìš” ì‹œ api_key, base_url, timeout ë“± ì„¤ì •
</span>
        <span class="c1"># 1) OpenAI ë¹„ë™ê¸° ìš”ì²­ì„ íƒœìŠ¤í¬ë¡œ ìƒì„±
</span>        <span class="n">req_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span>
            <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>          <span class="c1"># ì„ íƒ: ìš”ì²­ íƒ€ì„ì•„ì›ƒ
</span>                <span class="n">max_retries</span><span class="o">=</span><span class="mi">0</span>         <span class="c1"># ì„ íƒ: ì¬ì‹œë„ ë¹„í™œì„±í™”(ì·¨ì†Œ ì‘ë‹µì„ ë¹ ë¥´ê²Œ)
</span>            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># 2) ì¸í„°ëŸ½íŠ¸ ê°ì‹œ íƒœìŠ¤í¬ ì‹œì‘
</span>        <span class="n">watcher</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">_watch_interrupt_and_cancel</span><span class="p">(</span><span class="n">req_task</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 3) ê²°ê³¼ ëŒ€ê¸° â€” ì¸í„°ëŸ½íŠ¸ ì‹œ req_taskê°€ CancelledErrorë¡œ ê¹¨ì§
</span>            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">req_task</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span><span class="p">.</span><span class="n">content</span>
            <span class="nf">return </span><span class="p">(</span><span class="n">text</span><span class="p">,)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="c1"># 4) ComfyUIì— â€œì‚¬ìš©ì ì¸í„°ëŸ½íŠ¸â€ë¡œ ì•Œë¦¬ë ¤ë©´ ì´ ì˜ˆì™¸ë¡œ ìŠ¹ê²©
</span>            <span class="k">raise</span> <span class="n">mm</span><span class="p">.</span><span class="nc">InterruptProcessingException</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># 5) ì›Œì²˜ ì •ë¦¬
</span>            <span class="n">watcher</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">watcher</span>
</code></pre></div></div>

<h3 id="ì™œ-ì´ë ‡ê²Œ-í•˜ëŠëƒ">ì™œ ì´ë ‡ê²Œ í•˜ëŠëƒ?</h3>

<ul>
  <li>
    <p><strong>UI ë²„íŠ¼</strong> â†’ <code class="language-plaintext highlighter-rouge">/interrupt</code> â†’ ë‚´ë¶€ í”Œë˜ê·¸ on. <a href="https://docs.comfy.org/development/comfyui-server/comms_routes?utm_source=chatgpt.com">ComfyUI</a></p>
  </li>
  <li>
    <p>ê°ì‹œ ì½”ë£¨í‹´ì´ <code class="language-plaintext highlighter-rouge">throw_exception_if_processing_interrupted()</code> í˜¸ì¶œ ì¤‘ <strong>ì˜ˆì™¸ë¥¼ ë°›ìŒ</strong> â†’ <strong><code class="language-plaintext highlighter-rouge">req_task.cancel()</code></strong> â†’ <code class="language-plaintext highlighter-rouge">await</code>ê°€ ì¦‰ì‹œ <code class="language-plaintext highlighter-rouge">CancelledError</code> ë¡œ ê¹¨ì§ â†’ ì´ë¥¼ <strong><code class="language-plaintext highlighter-rouge">InterruptProcessingException</code> ìœ¼ë¡œ ë‹¤ì‹œ ë˜ì ¸</strong> ComfyUIê°€ <em>â€œProcessing interruptedâ€</em> ê²½ë¡œë¡œ ì¢…ë£Œ. <a href="https://docs.comfy.org/development/comfyui-server/comms_messages?utm_source=chatgpt.com">ComfyUI+1</a></p>
  </li>
</ul>

<hr />

<h2 id="3-ëŒ€ì•ˆ-asynciowaitë¡œ-ë ˆì´ìŠ¤-êµ¬ì„±">3) ëŒ€ì•ˆ: <code class="language-plaintext highlighter-rouge">asyncio.wait()</code>ë¡œ â€œë ˆì´ìŠ¤â€ êµ¬ì„±</h2>

<p>í´ë§ ì½”ë“œë¥¼ ì¤„ì´ê³  ì‹¶ë‹¤ë©´, â€œì¸í„°ëŸ½íŠ¸ ëŒ€ê¸° ì½”ë£¨í‹´â€ê³¼ ìš”ì²­ì„ <strong>ë ˆì´ìŠ¤</strong> ì‹œí‚¤ëŠ” ë°©ë²•ë„ ìˆì–´ìš”:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">_wait_for_interrupt</span><span class="p">():</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="n">mm</span><span class="p">.</span><span class="nf">throw_exception_if_processing_interrupted</span><span class="p">()</span>

<span class="c1"># ...
</span><span class="n">req_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(...))</span>
<span class="n">int_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">_wait_for_interrupt</span><span class="p">())</span>

<span class="n">done</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span>
    <span class="p">{</span><span class="n">req_task</span><span class="p">,</span> <span class="n">int_task</span><span class="p">},</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span>
<span class="p">)</span>

<span class="k">if</span> <span class="n">int_task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
    <span class="n">req_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
    <span class="k">raise</span> <span class="n">mm</span><span class="p">.</span><span class="nc">InterruptProcessingException</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">int_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
    <span class="nf">return </span><span class="p">(</span> <span class="p">(</span><span class="k">await</span> <span class="n">req_task</span><span class="p">).</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="4-ìì£¼-ê²ªëŠ”-í•¨ì •--íŒ">4) ìì£¼ ê²ªëŠ” í•¨ì • &amp; íŒ</h2>

<ul>
  <li>
    <p><strong>ë¸”ë¡œí‚¹ ì½”ë“œ</strong>(ë™ê¸° HTTP, ë¬´í•œ ë£¨í”„ ë“±)ê°€ ìˆìœ¼ë©´ ì¸í„°ëŸ½íŠ¸ê°€ â€œì¦‰ì‹œâ€ ì•ˆ ë¨¹í™ë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ëŠ” ë°˜ë“œì‹œ <strong>aiohttp/ë¹„ë™ê¸°</strong> ë¥¼ ì“°ê³ , ë£¨í”„ ì•ˆì—ëŠ” ê°„ê°„ì´ <code class="language-plaintext highlighter-rouge">mm.throw_exception_if_processing_interrupted()</code> ë¥¼ ë„£ìœ¼ì„¸ìš”. <a href="https://github.com/comfyanonymous/ComfyUI/issues/3131?utm_source=chatgpt.com">GitHub</a></p>
  </li>
  <li>
    <p><strong>OpenAI ë¹„ë™ê¸° í´ë¼ì´ì–¸íŠ¸</strong> ëŠ” <code class="language-plaintext highlighter-rouge">AsyncOpenAI</code> ë¥¼ ì“°ë©´ ë©ë‹ˆë‹¤(ìš”ì²­ ì˜µì…˜ì— <code class="language-plaintext highlighter-rouge">timeout</code> ë“± ì „ë‹¬ ê°€ëŠ¥).</p>
  </li>
  <li>
    <p><strong>ì·¨ì†Œ ì „íŒŒ</strong> : <code class="language-plaintext highlighter-rouge">asyncio.CancelledError</code> ë¥¼ <strong>ì¡ì•„ì„œ</strong> <code class="language-plaintext highlighter-rouge">mm.InterruptProcessingException</code> ìœ¼ë¡œ <strong>ë‹¤ì‹œ ë˜ì§€ëŠ” ê²ƒ</strong> ì´ í¬ì¸íŠ¸ì…ë‹ˆë‹¤ â€” ê·¸ë˜ì•¼ UIì— ì •ìƒì ì¸ â€œì¤‘ë‹¨â€ìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤</strong> ë„ ì¸í„°ëŸ½íŠ¸ë¥¼ ë³´ëƒ…ë‹ˆë‹¤(Ctrl+Alt+Enter). <a href="https://docs.comfy.org/interface/shortcuts?utm_source=chatgpt.com">ComfyUI</a></p>
  </li>
</ul>

<hr />

<h2 id="5-ë™ì‘-ì›ë¦¬-í•œëˆˆ-ìš”ì•½">5) ë™ì‘ ì›ë¦¬ í•œëˆˆ ìš”ì•½</h2>

<ol>
  <li>
    <p>ìœ ì €ê°€ Interrupt í´ë¦­ â†’ <strong><code class="language-plaintext highlighter-rouge">POST /interrupt</code></strong> í˜¸ì¶œ â†’ ë‚´ë¶€ í”Œë˜ê·¸ on. <a href="https://docs.comfy.org/development/comfyui-server/comms_routes?utm_source=chatgpt.com">ComfyUI</a></p>
  </li>
  <li>
    <p>ë‚´ ë…¸ë“œì˜ â€œì¸í„°ëŸ½íŠ¸ ì›Œì²˜â€ê°€ í”Œë˜ê·¸ ê°ì§€ â†’ <strong>ìš”ì²­ íƒœìŠ¤í¬ cancel()</strong>.</p>
  </li>
  <li>
    <p>ë‚´ ì½”ë“œê°€ <code class="language-plaintext highlighter-rouge">CancelledError</code> ë¥¼ ë°›ì•„ <strong><code class="language-plaintext highlighter-rouge">InterruptProcessingException</code> ì¬-ë°œìƒ</strong> â†’ ì‹¤í–‰ê¸°ì—ì„œ <strong><code class="language-plaintext highlighter-rouge">execution_interrupted</code></strong> ì´ë²¤íŠ¸ ì „ì†¡ &amp; ì¦‰ì‹œ ì¤‘ë‹¨. <a href="https://docs.comfy.org/development/comfyui-server/comms_messages?utm_source=chatgpt.com">ComfyUI</a></p>
  </li>
</ol>

<p>ì´ë ‡ê²Œ ë¶™ì´ë©´ â€œUIì—ì„œ ì •ì§€ â†’ ê³§ì¥ ë‹¹ì‹ ì˜ <code class="language-plaintext highlighter-rouge">await</code>ê°€ ëŠê¸°ëŠ”â€ ë™ì‘ì„ ì•ˆì •ì ìœ¼ë¡œ ë§Œë“¤ ìˆ˜ ìˆì–´ìš”.</p>]]></content><author><name>hvppyarchive</name></author><category term="comfyui" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">ComfyUI ì„¤ì • íŒŒì¼ ê°œë°œ</title><link href="https://hvppyarchive.github.io/comfyui/comfyui-custom-node-config/" rel="alternate" type="text/html" title="ComfyUI ì„¤ì • íŒŒì¼ ê°œë°œ" /><published>2025-10-02T13:39:43+09:00</published><updated>2025-10-02T13:39:43+09:00</updated><id>https://hvppyarchive.github.io/comfyui/comfyui-custom-node-config</id><content type="html" xml:base="https://hvppyarchive.github.io/comfyui/comfyui-custom-node-config/"><![CDATA[<p class="chat--user">

ComfyUI Custom Nodeì˜ Configë“¤ì„ ì €ì¥ íŒŒì¼ì„ ê°œë°œí•´ì¤˜. config íŒŒì¼ì„ ì‚¬ëŒì´ ìˆ˜ì •í•˜ê¸° ì‰¬ìš´ íŒŒì¼ í˜•ì‹ìœ¼ë¡œ ìˆ˜ì • í•´ì¤˜. íŒŒì¼ì„ ì €ì¥í•˜ì§€ ì•Šê³  ì„¤ì •ì„ ì½ê¸°ë§Œ í•˜ëŠ” readonly ëª¨ë“œë¡œ ë™ì‘í•˜ë©´ ë¼. ì—¬ëŸ¬ ì„¤ì •ì„ ì €ì¥í• ê±°ì§€ë§Œ ì£¼ ìš©ë„ëŠ” LLM ì—”ë“œí¬ì¸íŠ¸ ì •ë³´ë¥¼ ë‹´ì„ê±°ì•¼. ê° LLM Model ë³„ë¡œ (ë””ìŠ¤í”Œë ˆì´ìš© ëª¨ë¸ëª…, ì‹¤ì œ ëª¨ë¸ëª…(requestì‹œ), base url, api key)ë¥¼ ì €ì¥í•˜ë©´ ë¼. Config ì •ë³´ì— ê´€í•œ ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´(e.g. api ë‚ ë¦´ ë•Œ ë“±) í•´ë‹¹í•˜ëŠ” ê°’ì„ ë¦¬í„´í•˜ë©´ ë¼. ì´ ë•Œ config íŒŒì¼ì´ ì´ˆê¸° readí–ˆì„ ë•Œì™€ ë°”ë€Œì—ˆì„ ìˆ˜ë„ ìˆì–´. ì¡°ê¸ˆ ë°˜ì˜ì´ ëŠ¦ë”ë¼ë„ 1ë¶„ ì´ë‚´ì—ëŠ” ë³€ê²½ëœ ê°’ì„ ë¦¬í„´í•´ì•¼í•´. 

</p>

<p>ì¢‹ì•„ìš”! â€œì‚¬ëŒì´ ì§ì ‘ ìˆ˜ì •í•˜ê¸° ì‰¬ìš´ ì„¤ì • íŒŒì¼â€ + â€œì½ê¸° ì „ìš©(íŒŒì¼ ì €ì¥ X)â€ + â€œìµœëŒ€ 1ë¶„ ë‚´ ìµœì‹ ê°’ ë°˜ì˜â€ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ComfyUI ì»¤ìŠ¤í…€ ë…¸ë“œ íŒ¨í‚¤ì§€ë¥¼ ì„¤ê³„/êµ¬í˜„í•´ ë“œë¦´ê²Œìš”.<br />
ì•„ë˜ ê·¸ëŒ€ë¡œ ë³µì‚¬í•´ ë„£ìœ¼ë©´ ë°”ë¡œ ë™ì‘í•©ë‹ˆë‹¤.</p>

<hr />

<h1 id="1-íŒŒì¼-êµ¬ì¡°">1) íŒŒì¼ êµ¬ì¡°</h1>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ComfyUI/
â””â”€ custom_nodes/
   â””â”€ comfyui_llm_config_reader/
      â”œâ”€ __init__.py
      â”œâ”€ llm_config_reader.py     <span class="c"># ì»¤ìŠ¤í…€ ë…¸ë“œ + ì„¤ì • ë¡œë”</span>
      â””â”€ llm_config.toml          <span class="c"># ì‚¬ëŒì´ ì½ê³  ìˆ˜ì •í•˜ê¸° ì‰¬ìš´ TOML ì„¤ì • íŒŒì¼</span>
</code></pre></div></div>

<blockquote>
  <p>ê¸°ë³¸ ê²½ë¡œëŠ” <code class="language-plaintext highlighter-rouge">llm_config.toml</code> ì´ê³ , <code class="language-plaintext highlighter-rouge">LLM_CONFIG_PATH</code> í™˜ê²½ë³€ìˆ˜ë¡œ ë°”ê¿€ ìˆ˜ ìˆì–´ìš”.</p>
</blockquote>

<hr />

<h1 id="2-ì„¤ì •-íŒŒì¼-ì˜ˆì‹œ-toml">2) ì„¤ì • íŒŒì¼ ì˜ˆì‹œ (TOML)</h1>

<p>ì‚¬ëŒì´ ì†ìœ¼ë¡œ í¸ì§‘í•˜ê¸° ì‰½ê³ , ì£¼ì„ë„ ë„£ê¸° ì¢‹ì€ TOMLì„ ì‚¬ìš©í•©ë‹ˆë‹¤.<br />
(API KeyëŠ” ê¹ƒì— ì˜¬ë¦¬ì§€ ì•Šë„ë¡ í™˜ê²½ë³€ìˆ˜ ì¹˜í™˜ë„ ì§€ì›í•´ìš”.)</p>

<p><code class="language-plaintext highlighter-rouge">llm_config.toml</code></p>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë²„ì „ ì •ë³´(ì„ íƒ)</span>
<span class="py">version</span> <span class="p">=</span> <span class="mi">1</span>

<span class="nn">[settings]</span>
<span class="c"># íŒŒì¼ ë³€ê²½ ë°˜ì˜ ì£¼ê¸°(ì´ˆ). 60ì´ˆ ì´ë‚´ ìµœì‹ ê°’ ìš”êµ¬ì´ë¯€ë¡œ ê¸°ë³¸ 30ì´ˆë¡œ ì—¬ìœ  ìˆê²Œ.</span>
<span class="py">refresh_interval_seconds</span> <span class="p">=</span> <span class="mi">30</span>

<span class="nn">[llm_models."gpt-4o-mini"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"GPT-4o mini"</span>
<span class="py">request_model</span> <span class="p">=</span> <span class="s">"gpt-4o-mini"</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${OPENAI_API_KEY}"</span>   <span class="c"># í™˜ê²½ë³€ìˆ˜ë¡œ ì•ˆì „í•˜ê²Œ ì£¼ì…</span>

<span class="nn">[llm_models."claude-3-5-sonnet"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"Claude 3.5 Sonnet"</span>
<span class="py">request_model</span> <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>

<span class="c"># ì›í•˜ëŠ” ë§Œí¼ ëª¨ë¸ì„ ê³„ì† ì¶”ê°€</span>
<span class="c"># [llm_models."ë¬¸ìì—´í‚¤"] ...</span>
</code></pre></div></div>

<ul>
  <li>
    <p>í‚¤ ì„ íƒ ê·œì¹™: <code class="language-plaintext highlighter-rouge">llm_models."&lt;í‚¤&gt;"</code> ì˜ <code class="language-plaintext highlighter-rouge">&lt;í‚¤&gt;</code> ëŠ” ììœ ë¡œìš´ ë¬¸ìì—´ì…ë‹ˆë‹¤.<br />
ì¡°íšŒ ì‹œ <code class="language-plaintext highlighter-rouge">&lt;í‚¤&gt;</code>, <code class="language-plaintext highlighter-rouge">display_name</code>, <code class="language-plaintext highlighter-rouge">request_model</code> ì…‹ ì¤‘ ì–´ëŠ ê±¸ë¡œ ì…ë ¥í•´ë„ ë§¤ì¹­ë˜ë„ë¡ í–ˆì–´ìš”.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">${ENV_NAME}</code> í˜•íƒœëŠ” í™˜ê²½ë³€ìˆ˜ë¡œ ì¹˜í™˜ë©ë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />

<h1 id="3-ì»¤ìŠ¤í…€-ë…¸ë“œë¡œë”-ì½”ë“œ">3) ì»¤ìŠ¤í…€ ë…¸ë“œ/ë¡œë” ì½”ë“œ</h1>

<p><code class="language-plaintext highlighter-rouge">comfyui_llm_config_reader/llm_config_reader.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="c1"># Python 3.11+ tomllib, 3.10 ì´í•˜ë©´ tomli ì‚¬ìš©
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="k">def</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">ë¬¸ìì—´ ë‚´ ${ENV} íŒ¨í„´ì„ í™˜ê²½ë³€ìˆ˜ë¡œ ì¹˜í™˜. ê·¸ ì™¸ íƒ€ì…ì€ ê·¸ëŒ€ë¡œ ë°˜í™˜.</span><span class="sh">"""</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">env_name</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">env_name</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">_normalize_key</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">ë§¤ì¹­ í¸ì˜ë¥¼ ìœ„í•œ ì •ê·œí™”(ì†Œë¬¸ì, ì•ë’¤ ê³µë°± ì œê±°).</span><span class="sh">"""</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">ReadOnlyConfig</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - TOML ì„¤ì •ì„ ì½ì–´ì„œ ë©”ëª¨ë¦¬ì— ìºì‹œ
    - íŒŒì¼ì´ ë°”ë€Œì—ˆê±°ë‚˜ refresh_intervalì´ ì§€ë‚¬ìœ¼ë©´ ì¬ë¡œë“œ
    - ì“°ê¸°ëŠ” ì ˆëŒ€ í•˜ì§€ ì•ŠìŒ (read-only)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span>
            <span class="sh">"</span><span class="s">LLM_CONFIG_PATH</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="sh">"</span><span class="s">llm_config.toml</span><span class="sh">"</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># ê¸°ë³¸ 30ì´ˆ(&lt;= 60ì´ˆ ìš”êµ¬ ì¶©ì¡±)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># ì •ê·œí™” í‚¤ -&gt; ëª¨ë¸ dict
</span>
    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">models</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">llm_models</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">model_key</span><span class="p">,</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">models</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="c1"># í™˜ê²½ë³€ìˆ˜ ì¹˜í™˜
</span>            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>

            <span class="c1"># í•„ìˆ˜ í•„ë“œ ì²´í¬
</span>            <span class="n">required</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">required</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()]</span>
            <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                <span class="c1"># ë¶ˆì™„ì „í•œ ì—”íŠ¸ë¦¬ëŠ” ìŠ¤í‚µ (ëª…í™•í•œ ë¡œê·¸ê°€ í•„ìš”í•˜ë©´ print ê°€ëŠ¥)
</span>                <span class="k">continue</span>

            <span class="c1"># ëª¨ë¸ ì ‘ê·¼ì„ ìœ„í•œ ë‹¤ì–‘í•œ í‚¤ë“¤ ì¸ë±ì‹±
</span>            <span class="n">candidates</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nf">str</span><span class="p">(</span><span class="n">model_key</span><span class="p">),</span>
                <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)),</span>
                <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)),</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">candidates</span><span class="p">):</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">[</span><span class="nf">_normalize_key</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]),</span>
                <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
        <span class="c1"># settings.refresh_interval_seconds ë°˜ì˜ (ìµœì†Œ 5ì´ˆ, ìµœëŒ€ 60ì´ˆë¡œ ê°€ë“œ)
</span>        <span class="n">refresh</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span>
            <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">refresh</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">refresh</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span>
            <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LLM_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">,</span> <span class="n">refresh</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">mtime</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">keyëŠ” ëª¨ë¸ í‚¤/í‘œì‹œëª…/ìš”ì²­ìš© ëª¨ë¸ëª… ì¤‘ ì•„ë¬´ê±°ë‚˜ ê°€ëŠ¥.</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">model key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_normalize_key</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="c1"># ìµœì‹  ë°˜ì˜ ì§€ì—° ê°€ëŠ¥ì„±ì„ ê³ ë ¤í•´ í•œ ë²ˆ ë” ê°•ì œ ë¦¬ë¡œë“œ í›„ ì¬ì‹œë„
</span>            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_normalize_key</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">model not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">list_models</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="sh">"""</span><span class="s">ë””ë²„ê·¸/ì¸ìŠ¤í™ì…˜ìš©: (í‘œì‹œëª…, ìš”ì²­ëª¨ë¸, base_urlë§Œ ë…¸ì¶œí•˜ëŠ” ì•ˆì „ ë¦¬ìŠ¤íŠ¸).</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># ì—­ìœ¼ë¡œ display_name ê¸°ì¤€ ì§‘ê³„
</span>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">out</span><span class="p">[</span><span class="n">dn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
                <span class="c1"># api_keyëŠ” ë³´ì•ˆìƒ ë¯¸ë…¸ì¶œ
</span>            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="c1"># ì „ì—­ ì‹±ê¸€í†¤ ë¡œë” (ComfyUI ë…¸ë“œë“¤ì´ ê³µìœ )
</span><span class="n">_CONFIG</span> <span class="o">=</span> <span class="nc">ReadOnlyConfig</span><span class="p">()</span>

<span class="c1"># ===== ComfyUI Custom Nodes =====
</span><span class="k">class</span> <span class="nc">LLMConfigLookup</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ì…ë ¥: model_key (ë¬¸ìì—´)  â€” ì˜ˆ: </span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="s"> ë˜ëŠ” </span><span class="sh">"</span><span class="s">GPT-4o mini</span><span class="sh">"</span><span class="s"> ë˜ëŠ” </span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="s">(request_model)
    ì¶œë ¥: display_name, request_model, base_url, api_key (ëª¨ë‘ STRING)
    </span><span class="sh">"""</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">model_key</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
            <span class="p">},</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">lookup</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LLM/Config</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">_CONFIG</span><span class="p">.</span><span class="nf">get_model</span><span class="p">(</span><span class="n">model_key</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># ComfyUIì—ì„œ ì—ëŸ¬ê°€ ë³´ì´ë„ë¡ ì˜ˆì™¸ ì „ë‹¬
</span>            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[LLMConfigLookup] </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">LLMConfigListModels</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ë””ë²„ê·¸ìš©: ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ë“¤ì˜ (í‘œì‹œëª…, ìš”ì²­ëª¨ë¸, base_url) JSONì„ ë°˜í™˜.
    </span><span class="sh">"""</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">models_json</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">list_models</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LLM/Config</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">list_models</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="n">json</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">_CONFIG</span><span class="p">.</span><span class="nf">list_models</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),)</span>

<span class="c1"># ComfyUI ë“±ë¡ìš© ë§¤í•‘
</span><span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LLMConfigLookup</span><span class="sh">"</span><span class="p">:</span> <span class="n">LLMConfigLookup</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">LLMConfigListModels</span><span class="sh">"</span><span class="p">:</span> <span class="n">LLMConfigListModels</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LLMConfigLookup</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">LLM: Config Lookup (ReadOnly)</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">LLMConfigListModels</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">LLM: List Models (ReadOnly)</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">comfyui_llm_config_reader/__init__.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ë¹ˆ íŒŒì¼ì´ë©´ ì¶©ë¶„í•©ë‹ˆë‹¤. (íŒ¨í‚¤ì§€ ì¸ì‹ìš©)
</span></code></pre></div></div>

<hr />

<h1 id="4-ë™ì‘-ë³´ì¥ìš”êµ¬ì‚¬í•­-ë§¤í•‘">4) ë™ì‘ ë³´ì¥(ìš”êµ¬ì‚¬í•­ ë§¤í•‘)</h1>

<ol>
  <li>
    <p><strong>ì‚¬ëŒì´ ìˆ˜ì •í•˜ê¸° ì‰¬ìš´ í¬ë§·</strong> : TOML ì‚¬ìš© + ì£¼ì„ ê°€ëŠ¥ + ê°„ê²°í•œ í‚¤/ê°’ êµ¬ì¡°.</p>
  </li>
  <li>
    <p><strong>ì½ê¸° ì „ìš©</strong> : ì½”ë“œ ì–´ë””ì—ì„œë„ íŒŒì¼ì„ ì“°ì§€ ì•ŠìŒ. ì˜¤ì§ ì½ê¸°/íŒŒì‹±ë§Œ ìˆ˜í–‰.</p>
  </li>
  <li>
    <p><strong>ë‹¤ì¤‘ ì„¤ì •(íŠ¹íˆ LLM ì—”ë“œí¬ì¸íŠ¸)</strong> : <code class="language-plaintext highlighter-rouge">llm_models."&lt;í‚¤&gt;"</code>ë§ˆë‹¤</p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">display_name</code>, <code class="language-plaintext highlighter-rouge">request_model</code>, <code class="language-plaintext highlighter-rouge">base_url</code>, <code class="language-plaintext highlighter-rouge">api_key</code> ì €ì¥.</li>
    </ul>
  </li>
  <li>
    <p><strong>ìš”ì²­ ì‹œ í•´ë‹¹ ê°’ ë¦¬í„´</strong> : <code class="language-plaintext highlighter-rouge">LLMConfigLookup</code> ë…¸ë“œê°€ ì…ë ¥ <code class="language-plaintext highlighter-rouge">model_key</code>ë¡œ ê²€ìƒ‰í•˜ì—¬ 4ê°œ ê°’ì„ ì¶œë ¥.</p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">&lt;í‚¤&gt;</code> / <code class="language-plaintext highlighter-rouge">display_name</code> / <code class="language-plaintext highlighter-rouge">request_model</code> ì¤‘ ë¬´ì—‡ìœ¼ë¡œ ë„£ì–´ë„ ë§¤ì¹­ë¨.</li>
    </ul>
  </li>
  <li>
    <p><strong>ë³€ê²½ ë°˜ì˜(ìµœëŒ€ 1ë¶„)</strong> :</p>

    <ul>
      <li>
        <p>íŒŒì¼ <code class="language-plaintext highlighter-rouge">mtime</code> ë³€í™” ê°ì§€ + <code class="language-plaintext highlighter-rouge">refresh_interval_seconds</code>(ê¸°ë³¸ 30ì´ˆ) ë˜ëŠ” <code class="language-plaintext highlighter-rouge">LLM_CONFIG_REFRESH_SECONDS</code>(env) ê¸°ì¤€ TTL ìºì‹œ.</p>
      </li>
      <li>
        <p>í˜¸ì¶œ ì‹œë§ˆë‹¤ <strong>stale ë˜ëŠ” ë³€ê²½</strong> ì´ë©´ ì¦‰ì‹œ ì¬ë¡œë“œ â†’ <strong>ìµœëŒ€ 60ì´ˆ ì´ë‚´</strong> ìµœì‹ ê°’ ë³´ì¥.</p>
      </li>
      <li>
        <p>ì‹ ê·œ í•­ëª©ì´ ì¶”ê°€ëœ ì§í›„ì—ë„, ë‹¤ìŒ í˜¸ì¶œ ë•Œ ìµœëŒ€ TTL ë’¤ì—ëŠ” ë°˜ì˜.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ë³´ì•ˆ ê³ ë ¤</strong> :</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">${ENV}</code> ì¹˜í™˜ ì§€ì›ìœ¼ë¡œ API Keyë¥¼ í™˜ê²½ë³€ìˆ˜ì—ì„œ ì£¼ì… ê°€ëŠ¥.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">ListModels</code> ë…¸ë“œì—ì„œëŠ” API Key ë¯¸ë…¸ì¶œ.</p>
      </li>
    </ul>
  </li>
</ol>

<hr />

<h1 id="5-ì‚¬ìš©-ë°©ë²•-ê°„ë‹¨">5) ì‚¬ìš© ë°©ë²• (ê°„ë‹¨)</h1>

<ol>
  <li>
    <p>ìœ„ íŒŒì¼ êµ¬ì¡°ëŒ€ë¡œ ë³µì‚¬ â†’ ComfyUI ì¬ì‹¤í–‰.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">llm_config.toml</code> ì— ëª¨ë¸ë“¤ì„ ì¶”ê°€/ìˆ˜ì •.</p>
  </li>
  <li>
    <p>ì›Œí¬í”Œë¡œìš°ì—ì„œ <strong>LLM: Config Lookup (ReadOnly)</strong> ë…¸ë“œ ë°°ì¹˜ â†’ <code class="language-plaintext highlighter-rouge">model_key</code> ì…ë ¥(ì˜ˆ: <code class="language-plaintext highlighter-rouge">gpt-4o-mini</code>).</p>
  </li>
  <li>
    <p>ë…¸ë“œ ì¶œë ¥ 4ê°œ(í‘œì‹œëª…/ìš”ì²­ëª¨ë¸/base_url/api_key)ë¥¼ ì›í•˜ëŠ” LLM í˜¸ì¶œ ë…¸ë“œì— ì—°ê²°.</p>
  </li>
  <li>
    <p>ì„¤ì • íŒŒì¼ì„ ìˆ˜ì •í•˜ë©´, <strong>ìµœëŒ€ 30ì´ˆ(ê¸°ë³¸) ë‚´</strong> ìƒˆ ê°’ì´ ìë™ ë°˜ì˜ë©ë‹ˆë‹¤. (í™˜ê²½ë³€ìˆ˜ë¡œ 5~60ì´ˆ ì‚¬ì´ íŠœë‹ ê°€ëŠ¥)</p>
  </li>
</ol>

<hr />

<h1 id="6-ì»¤ìŠ¤í„°ë§ˆì´ì§•-íŒ">6) ì»¤ìŠ¤í„°ë§ˆì´ì§• íŒ</h1>

<ul>
  <li>
    <p><strong>YAML ì„ í˜¸ ì‹œ</strong> : <code class="language-plaintext highlighter-rouge">tomllib</code> ëŒ€ì‹  <code class="language-plaintext highlighter-rouge">yaml.safe_load</code>ë¡œ ë°”ê¾¸ê³  íŒŒì¼ í™•ì¥ìë§Œ <code class="language-plaintext highlighter-rouge">.yaml</code>ë¡œ ë°”ê¾¸ë©´ ë©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>ëª¨ë¸ í‚¤ ìë™ ë“œë¡­ë‹¤ìš´</strong> : ComfyUIì˜ ë™ì  ì…ë ¥ UIê°€ í•„ìš”í•˜ë©´, <code class="language-plaintext highlighter-rouge">INPUT_TYPES</code>ë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ ì¬êµ¬ì„±í•˜ëŠ” ì»¤ìŠ¤í…€ í”„ë¡ íŠ¸ì—”ë“œê°€ í•„ìš”í•©ë‹ˆë‹¤. ê¸°ë³¸ êµ¬í˜„ì€ ë¬¸ìì—´ ì…ë ¥ìœ¼ë¡œ ë‹¨ìˆœ/ê²¬ê³ í•˜ê²Œ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>í•„ë“œ í™•ì¥</strong> : per-model íƒ€ì„ì•„ì›ƒ, í—¤ë” ë“± ì¶”ê°€ í•„ë“œê°€ í•„ìš”í•˜ë©´ TOMLì— í‚¤ë¥¼ ëŠ˜ë¦¬ê³  <code class="language-plaintext highlighter-rouge">_build_index</code>ì—ì„œ ê·¸ëŒ€ë¡œ í†µê³¼ì‹œì¼œ ì¶œë ¥ì„ ëŠ˜ë¦¬ë©´ ë©ë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />

<p>ì›í•˜ì‹œë©´ YAML ë²„ì „ ë˜ëŠ” íŠ¹ì • LLM í˜¸ì¶œ ë…¸ë“œ(ì˜ˆ: OpenAI/Anthropic ì»¤ë„¥í„°)ê¹Œì§€ ë°”ë¡œ ì—°ê²°ë˜ëŠ” ë…¸ë“œë„ ì¶”ê°€ë¡œ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

ì¢‹ì€ë° LLM ë§ê³ ë„ ë‹¤ë¥¸ ì„¤ì •ë“¤ë„ ì €ì¥í•  ìˆ˜ ìˆëŠ” ë²”ìš©ì  config íŒŒì¼ì´ë¼ì„œ íŒŒì¼ëª…ì„ ë°”ê¿”ì£¼ë©´ ì¢‹ê² ì–´

</p>

<p>ì¢‹ì€ í¬ì¸íŠ¸ì˜ˆìš”! ë²”ìš© ì„¤ì • íŒŒì¼ë¡œ ì“°ê¸° ì¢‹ê²Œ <strong>íŒŒì¼ëª…ì„ <code class="language-plaintext highlighter-rouge">config.toml</code></strong>ë¡œ ë°”ê¾¸ê³ , ì½”ë“œ/í™˜ê²½ë³€ìˆ˜ë„ <strong>ì¼ë°˜í™”</strong> í–ˆìŠµë‹ˆë‹¤. (ì´ì „ <code class="language-plaintext highlighter-rouge">llm_config.toml</code>Â·<code class="language-plaintext highlighter-rouge">LLM_CONFIG_PATH</code>ë„ ìë™ í•˜ìœ„ í˜¸í™˜)</p>

<p>ì•„ë˜ ê·¸ëŒ€ë¡œ êµì²´/ì¶”ê°€í•˜ë©´ ë©ë‹ˆë‹¤.</p>

<hr />

<h1 id="ë³€ê²½-ìš”ì•½-step-by-step">ë³€ê²½ ìš”ì•½ (step-by-step)</h1>

<ol>
  <li>
    <p>ì„¤ì • íŒŒì¼ ê¸°ë³¸ëª…ì„ <code class="language-plaintext highlighter-rouge">config.toml</code>ë¡œ ë³€ê²½</p>
  </li>
  <li>
    <p>ê²½ë¡œ í™˜ê²½ë³€ìˆ˜ë„ ì¼ë°˜í™”: <strong><code class="language-plaintext highlighter-rouge">COMFY_CONFIG_PATH</code></strong> (êµ¬ <code class="language-plaintext highlighter-rouge">LLM_CONFIG_PATH</code>ë„ ì¸ì‹)</p>
  </li>
  <li>
    <p>ìƒˆë¡œê³ ì¹¨ ì£¼ê¸° í™˜ê²½ë³€ìˆ˜: <strong><code class="language-plaintext highlighter-rouge">COMFY_CONFIG_REFRESH_SECONDS</code></strong> (êµ¬ <code class="language-plaintext highlighter-rouge">LLM_CONFIG_REFRESH_SECONDS</code>ë„ ì¸ì‹)</p>
  </li>
  <li>
    <p>ì½”ë“œê°€ <code class="language-plaintext highlighter-rouge">config.toml</code>ì„ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ì¡´ <code class="language-plaintext highlighter-rouge">llm_config.toml</code> ìë™ í´ë°±</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">[llm_models]</code> ì™¸ì— ì„ì˜ ì„¹ì…˜(<code class="language-plaintext highlighter-rouge">[feature_flags]</code>, <code class="language-plaintext highlighter-rouge">[storage]</code> ë“±) ììœ  í™•ì¥ ê°€ëŠ¥</p>
  </li>
</ol>

<hr />

<h1 id="ë””ë ‰í† ë¦¬-êµ¬ì¡°">ë””ë ‰í† ë¦¬ êµ¬ì¡°</h1>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ComfyUI/
â””â”€ custom_nodes/
   â””â”€ comfyui_llm_config_reader/
      â”œâ”€ __init__.py
      â”œâ”€ llm_config_reader.py     <span class="c"># (êµì²´ë³¸) ë²”ìš© config ë¡œë” + LLM ì¡°íšŒ ë…¸ë“œ</span>
      â””â”€ config.toml              <span class="c"># â† ìƒˆ ê¸°ë³¸ ì„¤ì • íŒŒì¼ëª… (ë²”ìš©)</span>
      <span class="c"># â””â”€ llm_config.toml        # (ì„ íƒ) ê¸°ì¡´ íŒŒì¼ëª…ë„ ê³„ì† ë™ì‘(í´ë°±)</span>
</code></pre></div></div>

<hr />

<h1 id="ì˜ˆì‹œ-configtoml-ë²”ìš©">ì˜ˆì‹œ <code class="language-plaintext highlighter-rouge">config.toml</code> (ë²”ìš©)</h1>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">version</span> <span class="p">=</span> <span class="mi">1</span>

<span class="nn">[settings]</span>
<span class="c"># íŒŒì¼ ë³€ê²½ ë°˜ì˜ ì£¼ê¸°(ì´ˆ). 1ë¶„ ì´ë‚´ ìš”êµ¬ â†’ ê¸°ë³¸ 30ì´ˆ.</span>
<span class="py">refresh_interval_seconds</span> <span class="p">=</span> <span class="mi">30</span>

<span class="c"># â”€â”€ LLM ì—”ë“œí¬ì¸íŠ¸ë“¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nn">[llm_models."gpt-4o-mini"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"GPT-4o mini"</span>
<span class="py">request_model</span> <span class="p">=</span> <span class="s">"gpt-4o-mini"</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${OPENAI_API_KEY}"</span>

<span class="nn">[llm_models."claude-3-5-sonnet"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"Claude 3.5 Sonnet"</span>
<span class="py">request_model</span> <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>

<span class="c"># â”€â”€ (ì˜ˆ) ë‹¤ë¥¸ ë²”ìš© ì„¤ì • ì„¹ì…˜ë“¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nn">[feature_flags]</span>
<span class="py">use_cache</span> <span class="p">=</span> <span class="kc">true</span>
<span class="py">show_beta</span> <span class="p">=</span> <span class="kc">false</span>

<span class="nn">[storage.s3]</span>
<span class="py">bucket</span> <span class="p">=</span> <span class="s">"my-bucket"</span>
<span class="py">region</span> <span class="p">=</span> <span class="s">"ap-northeast-2"</span>
<span class="py">access_key</span> <span class="p">=</span> <span class="s">"${S3_ACCESS_KEY}"</span>
<span class="py">secret_key</span> <span class="p">=</span> <span class="s">"${S3_SECRET_KEY}"</span>
</code></pre></div></div>

<ul>
  <li>
    <p>ì„ì˜ ì„¹ì…˜ì€ <strong>ê·¸ëŒ€ë¡œ ì €ì¥</strong> ë˜ë©°, LLM ë…¸ë“œëŠ” <code class="language-plaintext highlighter-rouge">[llm_models]</code>ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">${ENV}</code> í‘œê¸°ê°’ì€ í™˜ê²½ë³€ìˆ˜ë¡œ ì¹˜í™˜ë©ë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />

<h1 id="êµì²´ë³¸-ì½”ë“œ-llm_config_readerpy">êµì²´ë³¸ ì½”ë“œ: <code class="language-plaintext highlighter-rouge">llm_config_reader.py</code></h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="c1"># Python 3.11+ tomllib, 3.10 ì´í•˜ë©´ tomli ì‚¬ìš©
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="k">def</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">ë¬¸ìì—´ ë‚´ ${ENV} íŒ¨í„´ì„ í™˜ê²½ë³€ìˆ˜ë¡œ ì¹˜í™˜. ê·¸ ì™¸ íƒ€ì…ì€ ê·¸ëŒ€ë¡œ.</span><span class="sh">"""</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">env_name</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">env_name</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">_normalize_key</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">ReadOnlyConfig</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - TOML ì„¤ì •ì„ ì½ì–´ ë©”ëª¨ë¦¬ ìºì‹œ
    - íŒŒì¼ mtime/TTL(ìµœì†Œ 5s, ìµœëŒ€ 60s) ê¸°ë°˜ ìë™ ì¬ë¡œë“œ
    - ì ˆëŒ€ ì“°ê¸° ì—†ìŒ (read-only)
    - íŒŒì¼ëª… ì¼ë°˜í™”:
        * ìš°ì„ ìˆœìœ„: COMFY_CONFIG_PATH &gt; LLM_CONFIG_PATH(í•˜ìœ„í˜¸í™˜) &gt;
                    ./config.toml &gt; ./llm_config.toml(í•˜ìœ„í˜¸í™˜)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="c1"># 1) ëª…ì‹œì  ì¸ì
</span>        <span class="n">explicit</span> <span class="o">=</span> <span class="n">path</span>

        <span class="c1"># 2) í™˜ê²½ë³€ìˆ˜ (ì¼ë°˜í™” + í•˜ìœ„í˜¸í™˜)
</span>        <span class="n">env_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_PATH</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LLM_CONFIG_PATH</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># 3) ê¸°ë³¸ ê²½ë¡œ íƒìƒ‰ (ìš°ì„  config.toml, ì—†ìœ¼ë©´ llm_config.toml)
</span>        <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
        <span class="n">default_primary</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">default_legacy</span>  <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">llm_config.toml</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">explicit</span><span class="p">:</span>
            <span class="n">chosen</span> <span class="o">=</span> <span class="n">explicit</span>
        <span class="k">elif</span> <span class="n">env_path</span><span class="p">:</span>
            <span class="n">chosen</span> <span class="o">=</span> <span class="n">env_path</span>
        <span class="k">elif</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">default_primary</span><span class="p">):</span>
            <span class="n">chosen</span> <span class="o">=</span> <span class="n">default_primary</span>
        <span class="k">elif</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">default_legacy</span><span class="p">):</span>
            <span class="n">chosen</span> <span class="o">=</span> <span class="n">default_legacy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># íŒŒì¼ì´ ì•„ì§ ì—†ì„ ìˆ˜ ìˆìœ¼ë‹ˆ ìƒˆ í‘œì¤€ëª…ìœ¼ë¡œ ê³ ì •
</span>            <span class="n">chosen</span> <span class="o">=</span> <span class="n">default_primary</span>

        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">chosen</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># ê¸°ë³¸ 30ì´ˆ (&lt;=60ì´ˆ ìš”êµ¬ ì¶©ì¡±)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># ì •ê·œí™” í‚¤ -&gt; LLM ëª¨ë¸ dict
</span>
    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_index_llm</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">[llm_models] ì„¹ì…˜ë§Œ ì¸ë±ì‹±. ë‹¤ë¥¸ ì„¹ì…˜ì€ ê·¸ëŒ€ë¡œ self._rawì— ë³´ì¡´.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">models</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">llm_models</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">model_key</span><span class="p">,</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">models</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># í™˜ê²½ë³€ìˆ˜ ì¹˜í™˜
</span>            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>

            <span class="c1"># í•„ìˆ˜ í•„ë“œ ì²´í¬
</span>            <span class="n">required</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">required</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()]</span>
            <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                <span class="c1"># ë¶ˆì™„ì „ í•­ëª©ì€ ìŠ¤í‚µ
</span>                <span class="k">continue</span>

            <span class="c1"># ì ‘ê·¼ í‚¤(ëª¨ë¸í‚¤/í‘œì‹œëª…/ìš”ì²­ëª¨ë¸) ì¸ë±ì‹±
</span>            <span class="n">candidates</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nf">str</span><span class="p">(</span><span class="n">model_key</span><span class="p">),</span>
                <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)),</span>
                <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)),</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">candidates</span><span class="p">):</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">[</span><span class="nf">_normalize_key</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]),</span>
                <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

        <span class="c1"># refresh_interval_seconds (ìµœì†Œ 5, ìµœëŒ€ 60) + env override(ì¼ë°˜/í•˜ìœ„í˜¸í™˜)
</span>        <span class="n">conf_val</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">conf_val</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">conf_val</span><span class="p">))</span>
        <span class="n">env_override</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LLM_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">env_override</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">conf_val</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">env_override</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span> <span class="o">=</span> <span class="n">conf_val</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index_llm</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">mtime</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="c1"># â”€â”€ LLM ì „ìš© í—¬í¼ (ê¸°ì¡´ API ìœ ì§€) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
</span>    <span class="k">def</span> <span class="nf">get_llm_model</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">model key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_normalize_key</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="c1"># ê°±ì‹  ì§€ì—° ê°€ëŠ¥ì„± â†’ ê°•ì œ ë¦¬ë¡œë“œ 1íšŒ ì¬ì‹œë„
</span>            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_normalize_key</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">model not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">list_llm_models</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">out</span><span class="p">[</span><span class="n">dn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
                <span class="c1"># api_keyëŠ” ë³´ì•ˆìƒ ë¯¸ë…¸ì¶œ
</span>            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="c1"># â”€â”€ ë²”ìš© ì ‘ê·¼(ì˜µì…˜): ì›ë³¸ íŠ¸ë¦¬ì—ì„œ ì„ì˜ ì„¹ì…˜ ì½ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
</span>    <span class="k">def</span> <span class="nf">get_raw_config</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">ì „ì²´ ì„¤ì • íŠ¸ë¦¬ë¥¼ ê·¸ëŒ€ë¡œ(ENV í™•ì¥ í›„) ë°˜í™˜. ì½ê¸° ì „ìš©.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_raw</span>

<span class="c1"># ì „ì—­ ì‹±ê¸€í†¤
</span><span class="n">_CONFIG</span> <span class="o">=</span> <span class="nc">ReadOnlyConfig</span><span class="p">()</span>

<span class="c1"># ===== ComfyUI Custom Nodes =====
</span><span class="k">class</span> <span class="nc">LLMConfigLookup</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ì…ë ¥: model_key (ë¬¸ìì—´) â€” </span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="s"> / </span><span class="sh">"</span><span class="s">GPT-4o mini</span><span class="sh">"</span><span class="s"> / </span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="s">(request_model)
    ì¶œë ¥: display_name, request_model, base_url, api_key
    </span><span class="sh">"""</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">model_key</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">})}}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">lookup</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LLM/Config</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">_CONFIG</span><span class="p">.</span><span class="nf">get_llm_model</span><span class="p">(</span><span class="n">model_key</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[LLMConfigLookup] </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">LLMConfigListModels</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">ë””ë²„ê·¸ìš©: ì‚¬ìš© ê°€ëŠ¥í•œ LLM ëª¨ë¸ ëª©ë¡(JSON) ë°˜í™˜ (API Key ë¯¸í¬í•¨).</span><span class="sh">"""</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">models_json</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">list_models</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LLM/Config</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">list_models</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="n">json</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">_CONFIG</span><span class="p">.</span><span class="nf">list_llm_models</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),)</span>

<span class="c1"># (ì„ íƒ) ë²”ìš© ì¡°íšŒ ë…¸ë“œ: ì„ì˜ ê²½ë¡œë¥¼ JSONPath ìœ ì‚¬ í‚¤ë¡œ ì¡°íšŒí•˜ê³  STRING ë°˜í™˜
</span><span class="k">class</span> <span class="nc">ConfigGetRawJSON</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ì˜ˆ) path=</span><span class="sh">"</span><span class="s">feature_flags.use_cache</span><span class="sh">"</span><span class="s"> â†’ </span><span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="s">
        path=</span><span class="sh">"</span><span class="s">storage.s3.region</span><span class="sh">"</span><span class="s"> â†’ </span><span class="sh">"</span><span class="s">ap-northeast-2</span><span class="sh">"</span><span class="s">
    </span><span class="sh">"""</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">})}}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">get_raw</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LLM/Config</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">get_raw</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="kn">import</span> <span class="n">json</span>
        <span class="k">def</span> <span class="nf">get_in</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">d</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">dotted</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                    <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">config path not found: </span><span class="si">{</span><span class="n">dotted</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cur</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">_CONFIG</span><span class="p">.</span><span class="nf">get_raw_config</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nf">get_in</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">path</span> <span class="k">else</span> <span class="n">raw</span>
            <span class="c1"># ìŠ¤ì¹¼ë¼ë©´ ë¬¸ìì—´í™”, ê·¸ ì™¸ì—” JSON ë¬¸ìì—´ë¡œ ë°˜í™˜
</span>            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">))</span> <span class="ow">or</span> <span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="nf">return </span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">val</span><span class="p">),)</span>
            <span class="nf">return </span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[ConfigGetRawJSON] </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LLMConfigLookup</span><span class="sh">"</span><span class="p">:</span> <span class="n">LLMConfigLookup</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">LLMConfigListModels</span><span class="sh">"</span><span class="p">:</span> <span class="n">LLMConfigListModels</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigGetRawJSON</span><span class="sh">"</span><span class="p">:</span> <span class="n">ConfigGetRawJSON</span><span class="p">,</span>  <span class="c1"># â† ë²”ìš© ì½ê¸° ë…¸ë“œ(ì„ íƒ)
</span><span class="p">}</span>

<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LLMConfigLookup</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">LLM: Config Lookup (ReadOnly)</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">LLMConfigListModels</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">LLM: List Models (ReadOnly)</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigGetRawJSON</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Config: Get Raw JSON (ReadOnly)</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>ë…¸ë“œ/íŒ¨í‚¤ì§€ëª…ì€ ê·¸ëŒ€ë¡œ ë‘ê³ , <strong>íŒŒì¼ëª…/í™˜ê²½ë³€ìˆ˜/ë¡œë”</strong> ë§Œ ì¼ë°˜í™”í–ˆìŠµë‹ˆë‹¤. ì›í•˜ì‹œë©´ íŒ¨í‚¤ì§€/ë…¸ë“œ ì´ë¦„ë„ <code class="language-plaintext highlighter-rouge">comfyui_config_reader</code>ë¡œ ë¦¬ë„¤ì„í•´ ë“œë¦´ ìˆ˜ ìˆì–´ìš”.</p>
</blockquote>

<hr />

<h1 id="ì‚¬ìš©-ë°©ë²•-ìš”ì•½">ì‚¬ìš© ë°©ë²• (ìš”ì•½)</h1>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">config.toml</code>ë¡œ ì„¤ì • ì €ì¥(ë²”ìš© ì„¹ì…˜ ììœ  ì¶”ê°€ ê°€ëŠ¥).</p>
  </li>
  <li>
    <p>í•„ìš” ì‹œ ê²½ë¡œ ì˜¤ë²„ë¼ì´ë“œ: <code class="language-plaintext highlighter-rouge">COMFY_CONFIG_PATH=/abs/path/to/config.toml</code></p>
  </li>
  <li>
    <p>ìƒˆë¡œê³ ì¹¨ ì£¼ê¸° ì¡°ì •: <code class="language-plaintext highlighter-rouge">COMFY_CONFIG_REFRESH_SECONDS=10</code> (5~60 ìœ íš¨)</p>
  </li>
  <li>
    <p>ComfyUIì—ì„œ</p>

    <ul>
      <li>
        <p><strong>LLM: Config Lookup</strong> â†’ LLM ì—”ë“œí¬ì¸íŠ¸ 4ì¢… ê°’ ì¶œë ¥</p>
      </li>
      <li>
        <p><strong>Config: Get Raw JSON</strong> â†’ ì„ì˜ ì„¤ì • ê°’ ì½ê¸° (ì˜ˆ: <code class="language-plaintext highlighter-rouge">feature_flags.use_cache</code>)</p>
      </li>
    </ul>
  </li>
  <li>
    <p>íŒŒì¼ì„ ìˆ˜ì •í•˜ë©´ <strong>ìµœëŒ€ 1ë¶„ ë‚´</strong>(ê¸°ë³¸ 30ì´ˆ) ë°˜ì˜ë©ë‹ˆë‹¤.</p>
  </li>
</ol>

<p>í•„ìš”í•˜ë©´ í´ë”/ë…¸ë“œ ì´ë¦„ê¹Œì§€ â€œLLMâ€ì„ ë¹¼ê³  ì „ë©´ ë¦¬ë„¤ì´ë°í•œ ë²„ì „ë„ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

ì‘ ë‹¤ ë¹¼ì¤˜

</p>

<p>ì¢‹ì•„â€”ì´ì œ â€œLLMâ€ í”ì  ì „ë¶€ ëºì–´ìš”. íŒ¨í‚¤ì§€/ë…¸ë“œ/í™˜ê²½ë³€ìˆ˜/ì¹´í…Œê³ ë¦¬/í•„ë“œ ì´ë¦„ê¹Œì§€ ì „ë¶€ <strong>ë²”ìš©(config/endpoint)</strong>ìœ¼ë¡œ ë°”ê¾¼ ìµœì¢…ë³¸ì„ ë“œë¦½ë‹ˆë‹¤. ê·¸ëŒ€ë¡œ ë„£ìœ¼ë©´ ì‘ë™í•©ë‹ˆë‹¤.</p>

<hr />

<h1 id="0-í•œëˆˆì—-ë³´ê¸°-step-by-step">0) í•œëˆˆì— ë³´ê¸° (step-by-step)</h1>

<ol>
  <li>
    <p><strong>í´ë”ëª… ë³€ê²½</strong> : <code class="language-plaintext highlighter-rouge">comfyui_config_reader</code> (ì´ì „ í´ë” ì‚­ì œí•´ë„ ë¨)</p>
  </li>
  <li>
    <p><strong>ì„¤ì • íŒŒì¼ëª…</strong> : <code class="language-plaintext highlighter-rouge">config.toml</code></p>
  </li>
  <li>
    <p><strong>í™˜ê²½ë³€ìˆ˜</strong> :</p>

    <ul>
      <li>
        <p>ê²½ë¡œ: <code class="language-plaintext highlighter-rouge">COMFY_CONFIG_PATH</code></p>
      </li>
      <li>
        <p>ìƒˆë¡œê³ ì¹¨: <code class="language-plaintext highlighter-rouge">COMFY_CONFIG_REFRESH_SECONDS</code> (5~60ì´ˆ)</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ì„¹ì…˜ ì´ë¦„</strong> : <code class="language-plaintext highlighter-rouge">[endpoints."&lt;í‚¤&gt;"]</code> (í•„ë“œ: <code class="language-plaintext highlighter-rouge">display_name</code>, <code class="language-plaintext highlighter-rouge">request_name</code>, <code class="language-plaintext highlighter-rouge">base_url</code>, <code class="language-plaintext highlighter-rouge">api_key</code>)</p>
  </li>
  <li>
    <p><strong>ë…¸ë“œ ì´ë¦„</strong> :</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">ConfigEndpointLookup</code> (ì—”ë“œí¬ì¸íŠ¸ 4ì¢… ê°’ ë°˜í™˜)</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">ConfigListEndpoints</code> (ì—”ë“œí¬ì¸íŠ¸ ëª©ë¡ JSON)</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">ConfigGetValue</code> (ì„ì˜ ê²½ë¡œ ê°’ ê°€ì ¸ì˜¤ê¸°)</p>
      </li>
    </ul>
  </li>
</ol>

<hr />

<h1 id="1-ë””ë ‰í† ë¦¬-êµ¬ì¡°">1) ë””ë ‰í† ë¦¬ êµ¬ì¡°</h1>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ComfyUI/
â””â”€ custom_nodes/
   â””â”€ comfyui_config_reader/
      â”œâ”€ __init__.py
      â”œâ”€ config_reader.py       <span class="c"># ì»¤ìŠ¤í…€ ë…¸ë“œ + ì½ê¸° ì „ìš© ë¡œë”</span>
      â””â”€ config.toml            <span class="c"># ì‚¬ëŒì´ í¸ì§‘í•˜ê¸° ì‰¬ìš´ TOML</span>
</code></pre></div></div>

<hr />

<h1 id="2-ì˜ˆì‹œ-configtoml-ë²”ìš©">2) ì˜ˆì‹œ <code class="language-plaintext highlighter-rouge">config.toml</code> (ë²”ìš©)</h1>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">version</span> <span class="p">=</span> <span class="mi">1</span>

<span class="nn">[settings]</span>
<span class="c"># íŒŒì¼ ë³€ê²½ ë°˜ì˜ ì£¼ê¸°(ì´ˆ). "1ë¶„ ë‚´ ë°˜ì˜" ìš”ê±´ â†’ ê¸°ë³¸ 30ì´ˆ.</span>
<span class="py">refresh_interval_seconds</span> <span class="p">=</span> <span class="mi">30</span>

<span class="c"># â”€â”€ ì—”ë“œí¬ì¸íŠ¸(ì˜ˆ: í…ìŠ¤íŠ¸ ëª¨ë¸, ì„ë² ë”© ì„œë¹„ìŠ¤, ì‚¬ë‚´ API ë“±) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nn">[endpoints."text-model-a"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"Text Model A"</span>
<span class="py">request_name</span>  <span class="p">=</span> <span class="s">"gpt-4o-mini"</span>         <span class="c"># ì‹¤ì œ ìš”ì²­ì— ì“¸ ì‹ë³„ì/ëª¨ë¸ëª…/ë²„ì „ ë“±</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${OPENAI_API_KEY}"</span>   <span class="c"># í™˜ê²½ë³€ìˆ˜ ì¹˜í™˜ ì§€ì›</span>

<span class="nn">[endpoints."text-model-b"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"Text Model B"</span>
<span class="py">request_name</span>  <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>

<span class="c"># â”€â”€ ë‹¤ë¥¸ ë²”ìš© ì„¤ì •ë“¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nn">[feature_flags]</span>
<span class="py">use_cache</span> <span class="p">=</span> <span class="kc">true</span>
<span class="py">show_beta</span> <span class="p">=</span> <span class="kc">false</span>

<span class="nn">[storage.s3]</span>
<span class="py">bucket</span> <span class="p">=</span> <span class="s">"my-bucket"</span>
<span class="py">region</span> <span class="p">=</span> <span class="s">"ap-northeast-2"</span>
<span class="py">access_key</span> <span class="p">=</span> <span class="s">"${S3_ACCESS_KEY}"</span>
<span class="py">secret_key</span> <span class="p">=</span> <span class="s">"${S3_SECRET_KEY}"</span>
</code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">${ENV}</code> í‘œê¸°ëŠ” í™˜ê²½ë³€ìˆ˜ë¡œ ìë™ ì¹˜í™˜ë©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">endpoints."&lt;í‚¤&gt;"</code>ì˜ <code class="language-plaintext highlighter-rouge">&lt;í‚¤&gt;</code>ë¡œ, <code class="language-plaintext highlighter-rouge">display_name</code>Â·<code class="language-plaintext highlighter-rouge">request_name</code> ê¹Œì§€ <strong>ëª¨ë‘ ì¡°íšŒ í‚¤</strong> ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”.</p>
  </li>
</ul>

<hr />

<h1 id="3-ì½”ë“œ-config_readerpy">3) ì½”ë“œ: <code class="language-plaintext highlighter-rouge">config_reader.py</code></h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="c1"># Python 3.11+ tomllib / 3.10-: tomli
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="k">def</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">ë¬¸ìì—´ ë‚´ ${ENV} íŒ¨í„´ì„ í™˜ê²½ë³€ìˆ˜ë¡œ ì¹˜í™˜. ê·¸ ì™¸ íƒ€ì…ì€ ê·¸ëŒ€ë¡œ.</span><span class="sh">"""</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">env_name</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">env_name</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">_norm</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">ReadOnlyConfig</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - TOMLì„ ì½ì–´ ë©”ëª¨ë¦¬ì— ìºì‹œ
    - mtime/TTL(ìµœì†Œ 5s, ìµœëŒ€ 60s)ë¡œ ìë™ ì¬ë¡œë“œ
    - íŒŒì¼ ì“°ê¸° ì—†ìŒ(read-only)
    - íŒŒì¼ ê²°ì • ìš°ì„ ìˆœìœ„:  (1) ì¸ì path &gt; (2) COMFY_CONFIG_PATH &gt; (3) ./config.toml
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
        <span class="n">chosen</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">path</span>
            <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_PATH</span><span class="sh">"</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">chosen</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># ê¸°ë³¸ 30ì´ˆ(&lt;=60s ìš”ê±´ ì¶©ì¡±)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># ì •ê·œí™” í‚¤ -&gt; endpoint dict
</span>
    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_index_endpoints</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">endpoints</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">ep_key</span><span class="p">,</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">eps</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>

            <span class="c1"># í•„ìˆ˜ í•„ë“œ
</span>            <span class="n">required</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">required</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()]</span>
            <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                <span class="c1"># ë¶ˆì™„ì „ í•­ëª©ì€ ìŠ¤í‚µ
</span>                <span class="k">continue</span>

            <span class="c1"># ì ‘ê·¼ í‚¤: ì •ì˜ í‚¤ / display_name / request_name
</span>            <span class="n">candidates</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nf">str</span><span class="p">(</span><span class="n">ep_key</span><span class="p">),</span>
                <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)),</span>
                <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)),</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">candidates</span><span class="p">):</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">[</span><span class="nf">_norm</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]),</span>
                <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

        <span class="c1"># refresh_interval_seconds (5~60) + env override
</span>        <span class="n">conf_val</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">conf_val</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">conf_val</span><span class="p">))</span>
        <span class="n">env_override</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_override</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">conf_val</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">env_override</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span> <span class="o">=</span> <span class="n">conf_val</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index_endpoints</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">mtime</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="c1"># â”€â”€ Endpoints ì „ìš© API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
</span>    <span class="k">def</span> <span class="nf">get_endpoint</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">endpoint key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="c1"># ê°±ì‹  ì§€ì—° ê°€ëŠ¥ì„± â†’ ê°•ì œ ë¦¬ë¡œë“œ 1íšŒ ì¬ì‹œë„
</span>            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">endpoint not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">list_endpoints</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">out</span><span class="p">[</span><span class="n">dn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
                <span class="c1"># api_keyëŠ” ë³´ì•ˆìƒ ë¯¸ë…¸ì¶œ
</span>            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="c1"># â”€â”€ ë²”ìš© ì½ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
</span>    <span class="k">def</span> <span class="nf">get_raw</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_raw</span>

<span class="c1"># ì „ì—­ ì‹±ê¸€í†¤
</span><span class="n">_CONFIG</span> <span class="o">=</span> <span class="nc">ReadOnlyConfig</span><span class="p">()</span>

<span class="c1"># ===== ComfyUI Custom Nodes =====
</span><span class="k">class</span> <span class="nc">ConfigEndpointLookup</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ì…ë ¥: key â€” </span><span class="sh">"</span><span class="s">text-model-a</span><span class="sh">"</span><span class="s"> / </span><span class="sh">"</span><span class="s">Text Model A</span><span class="sh">"</span><span class="s"> / </span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="s">(request_name)
    ì¶œë ¥: display_name, request_name, base_url, api_key (ëª¨ë‘ STRING)
    </span><span class="sh">"""</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">})}}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">lookup</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Config/Endpoints (ReadOnly)</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ep</span> <span class="o">=</span> <span class="n">_CONFIG</span><span class="p">.</span><span class="nf">get_endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[ConfigEndpointLookup] </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span> <span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">],</span> <span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span> <span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">ConfigListEndpoints</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">ë””ë²„ê·¸/ì¸ìŠ¤í™ì…˜ìš©: ì—”ë“œí¬ì¸íŠ¸ ëª©ë¡(JSON, api_key ë¯¸í¬í•¨).</span><span class="sh">"""</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">endpoints_json</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">list_endpoints</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Config/Endpoints (ReadOnly)</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">list_endpoints</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="n">json</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">_CONFIG</span><span class="p">.</span><span class="nf">list_endpoints</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),)</span>

<span class="k">class</span> <span class="nc">ConfigGetValue</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ì„ì˜ ê²½ë¡œ ê°’ ì½ê¸° (</span><span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="s"> êµ¬ë¶„)
    ì˜ˆ) path=</span><span class="sh">"</span><span class="s">feature_flags.use_cache</span><span class="sh">"</span><span class="s">  â†’ </span><span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="s">
        path=</span><span class="sh">"</span><span class="s">storage.s3.region</span><span class="sh">"</span><span class="s">        â†’ </span><span class="sh">"</span><span class="s">ap-northeast-2</span><span class="sh">"</span><span class="s">
        path=</span><span class="sh">"</span><span class="s">endpoints.text-model-a</span><span class="sh">"</span><span class="s">   â†’ í•´ë‹¹ ì—”ë“œí¬ì¸íŠ¸ JSON
    </span><span class="sh">"""</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">})}}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">get_value</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Config/General (ReadOnly)</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="kn">import</span> <span class="n">json</span>
        <span class="k">def</span> <span class="nf">get_in</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">d</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">dotted</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                    <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">config path not found: </span><span class="si">{</span><span class="n">dotted</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cur</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">_CONFIG</span><span class="p">.</span><span class="nf">get_raw</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nf">get_in</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">path</span> <span class="k">else</span> <span class="n">raw</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">))</span> <span class="ow">or</span> <span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="nf">return </span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">val</span><span class="p">),)</span>
            <span class="nf">return </span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[ConfigGetValue] </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">ConfigEndpointLookup</span><span class="sh">"</span><span class="p">:</span> <span class="n">ConfigEndpointLookup</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigListEndpoints</span><span class="sh">"</span><span class="p">:</span>  <span class="n">ConfigListEndpoints</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigGetValue</span><span class="sh">"</span><span class="p">:</span>       <span class="n">ConfigGetValue</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">ConfigEndpointLookup</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Config: Endpoint Lookup</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigListEndpoints</span><span class="sh">"</span><span class="p">:</span>  <span class="sh">"</span><span class="s">Config: List Endpoints</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigGetValue</span><span class="sh">"</span><span class="p">:</span>       <span class="sh">"</span><span class="s">Config: Get Value</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">__init__.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># íŒ¨í‚¤ì§€ ì¸ì‹ìš© (ë¹„ì›Œë‘ë©´ ë©ë‹ˆë‹¤)
</span></code></pre></div></div>

<hr />

<h1 id="4-ìš”êµ¬ì‚¬í•­-ëŒ€ì‘-ì²´í¬">4) ìš”êµ¬ì‚¬í•­ ëŒ€ì‘ ì²´í¬</h1>

<ul>
  <li>
    <p>ì‚¬ëŒì´ í¸ì§‘í•˜ê¸° ì‰¬ì›€: <strong>TOML + ì£¼ì„ ê°€ëŠ¥</strong></p>
  </li>
  <li>
    <p>ì½ê¸° ì „ìš©: <strong>íŒŒì¼ ì“°ê¸° ì—†ìŒ</strong></p>
  </li>
  <li>
    <p>ì£¼ìš” ìš©ë„(ëª¨ë¸/ì„œë¹„ìŠ¤ ì—”ë“œí¬ì¸íŠ¸): <strong><code class="language-plaintext highlighter-rouge">endpoints</code> ì„¹ì…˜ í‘œì¤€í™”</strong></p>
  </li>
  <li>
    <p>í•„ìš”í•œ ê°’ ë°˜í™˜: <code class="language-plaintext highlighter-rouge">ConfigEndpointLookup</code>ê°€ <strong>display_name, request_name, base_url, api_key</strong> ì¶œë ¥</p>
  </li>
  <li>
    <p>ë³€ê²½ ë°˜ì˜: <strong>mtime + TTL(ê¸°ë³¸ 30ì´ˆ, 5~60ì´ˆ ì¡°ì •)</strong> â†’ <strong>ìµœëŒ€ 1ë¶„ ë‚´ ë°˜ì˜</strong> ë³´ì¥</p>
  </li>
  <li>
    <p>ë³´ì•ˆ: <strong>í™˜ê²½ë³€ìˆ˜ ì¹˜í™˜</strong> , ëª©ë¡ ë…¸ë“œì—ì„œ <strong>api_key ë¯¸ë…¸ì¶œ</strong></p>
  </li>
</ul>

<hr />

<h1 id="5-ë§ˆì´ê·¸ë ˆì´ì…˜-ê°€ì´ë“œ">5) ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ</h1>

<ul>
  <li>
    <p>ì˜ˆì „ íŒŒì¼/ì´ë¦„ì„ ì“°ì…¨ë‹¤ë©´:</p>

    <ul>
      <li>
        <p>í´ë”: <code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_llm_config_reader</code> â†’ <strong>ì‚­ì œ</strong> ë˜ëŠ” ë³´ê´€</p>
      </li>
      <li>
        <p>ì„¤ì •: <code class="language-plaintext highlighter-rouge">[llm_models]</code> â†’ <strong><code class="language-plaintext highlighter-rouge">[endpoints]</code> ë¡œ ë°”ê¾¸ê³  <code class="language-plaintext highlighter-rouge">request_model</code> â†’ <code class="language-plaintext highlighter-rouge">request_name</code></strong></p>
      </li>
      <li>
        <p>ë…¸ë“œ: ê¸°ì¡´ ì›Œí¬í”Œë¡œìš°ì—ì„  ìƒˆ ë…¸ë“œë¡œ êµì²´</p>

        <ul>
          <li>
            <p><code class="language-plaintext highlighter-rouge">LLMConfigLookup</code> â†’ <strong><code class="language-plaintext highlighter-rouge">ConfigEndpointLookup</code></strong></p>
          </li>
          <li>
            <p><code class="language-plaintext highlighter-rouge">LLMConfigListModels</code> â†’ <strong><code class="language-plaintext highlighter-rouge">ConfigListEndpoints</code></strong></p>
          </li>
          <li>
            <p><code class="language-plaintext highlighter-rouge">ConfigGetRawJSON</code> â†’ <strong><code class="language-plaintext highlighter-rouge">ConfigGetValue</code></strong></p>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<hr />

<p>í•„ìš”í•˜ë©´, ê¸°ì¡´ ì›Œí¬í”Œë¡œìš° ìë™ ë³€í™˜ ìŠ¤í¬ë¦½íŠ¸(YAML/JSON ê²½ë¡œ êµì²´)ë„ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

ë‹¤ë¥¸ ë…¸ë“œ â€œíŒŒì¼ë“¤â€ì—ì„œ ì„¤ì •ì„ ì½ì–´ì•¼í•˜ëŠ”ë° ì´ê±´ ì–´ë–»ê²Œ í•´? ì‹±ê¸€í†¤ ì¸í„°í˜ì´ìŠ¤ê°€ ì¢€ ì–´ìƒ‰í•´ë³´ì—¬

</p>

<p>ì¢‹ì€ í”¼ë“œë°±! â€œì—¬ëŸ¬ ë…¸ë“œ/íŒŒì¼ì—ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ì½ëŠ”â€ íŒ¨í„´ìœ¼ë¡œ ë°”ê¿”ì¤„ê²Œìš”.<br />
ì‹±ê¸€í†¤ ëŒ€ì‹  <strong>ê²½ë¡œë³„ Multiton ë ˆì§€ìŠ¤íŠ¸ë¦¬ + ì–‡ì€ í•¨ìˆ˜í˜• API</strong> ë¥¼ ì œê³µí•©ë‹ˆë‹¤.<br />
ì¦‰, ì–´ë””ì„œë“  <code class="language-plaintext highlighter-rouge">from comfyui_config_reader.config import endpoint, get</code>ë§Œ ì„í¬íŠ¸í•´ ì“°ë©´ ë©ë‹ˆë‹¤.</p>

<p>ì•„ë˜ ì„¸ íŒŒì¼ë§Œ ì¶”ê°€/êµì²´í•˜ë©´ ë!</p>

<hr />

<h1 id="1-êµ¬ì¡°">1) êµ¬ì¡°</h1>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ComfyUI/
â””â”€ custom_nodes/
   â””â”€ comfyui_config_reader/
      â”œâ”€ __init__.py
      â”œâ”€ config_core.py     <span class="c"># í•µì‹¬: ReadOnlyStore (ê²½ë¡œë³„ ìºì‹œ/ìë™ ë¦¬ë¡œë“œ)</span>
      â”œâ”€ config.py          <span class="c"># ê³µìš© API: endpoint()/get()/get_store()</span>
      â””â”€ config_nodes.py    <span class="c"># (ì˜µì…˜) ë°ëª¨ ë…¸ë“œë“¤: Lookup/List/Get</span>
</code></pre></div></div>

<hr />

<h1 id="2-í•µì‹¬-ìŠ¤í† ì–´-ê²½ë¡œë³„-multiton-ì•„ë‹˜--ì¸ìŠ¤í„´ìŠ¤í˜•-thread-safe">2) í•µì‹¬ ìŠ¤í† ì–´ (ê²½ë¡œë³„ Multiton ì•„ë‹˜ â€” â€œì¸ìŠ¤í„´ìŠ¤í˜•â€, thread-safe)</h1>

<p><code class="language-plaintext highlighter-rouge">config_core.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="c1"># Python 3.11+: tomllib / ì´í•˜: tomli
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="k">def</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">env_name</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">env_name</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">_norm</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">ReadOnlyStore</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - TOML ì½ê¸° ì „ìš© ìŠ¤í† ì–´
    - mtime/TTL(5~60s) ê¸°ë°˜ ìë™ ì¬ë¡œë“œ â†’ </span><span class="sh">'</span><span class="s">1ë¶„ ë‚´ ë°˜ì˜</span><span class="sh">'</span><span class="s"> ë³´ì¥
    - ì—”ë“œí¬ì¸íŠ¸ ì¸ë±ì‹± + ì„ì˜ ê²½ë¡œ ì ‘ê·¼
    - íŒŒì¼ ì“°ê¸° ì—†ìŒ
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># ê¸°ë³¸ 30s
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># ë¦¬ë¡œë“œë§ˆë‹¤ ì¦ê°€
</span>
    <span class="c1"># ---------- ë‚´ë¶€ ë¡œë”© ----------
</span>    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_index_endpoints</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">endpoints</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">ep_key</span><span class="p">,</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">eps</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
            <span class="n">required</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">required</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">ep_key</span><span class="p">),</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)),</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))}:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">[</span><span class="nf">_norm</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]),</span>
                        <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">]),</span>
                        <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]),</span>
                        <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
        <span class="c1"># refresh_interval_seconds (5~60) + env override
</span>        <span class="n">conf_val</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">conf_val</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">conf_val</span><span class="p">))</span>
        <span class="n">env_override</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_override</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">conf_val</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">env_override</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span> <span class="o">=</span> <span class="n">conf_val</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index_endpoints</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_version</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">mtime</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="c1"># ---------- í¼ë¸”ë¦­ API ----------
</span>    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_version</span>

    <span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">ENV ì¹˜í™˜ í›„ ì „ì²´ íŠ¸ë¦¬ì˜ </span><span class="sh">'</span><span class="s">ì¼ê´€ëœ ìŠ¤ëƒ…ìƒ·</span><span class="sh">'</span><span class="s">ì„ ë°˜í™˜(ì–•ì€ ë³µì‚¬).</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dotted_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_raw</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">dotted_path</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">config path not found: </span><span class="si">{</span><span class="n">dotted_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cur</span>

    <span class="k">def</span> <span class="nf">get_endpoint</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">endpoint key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="c1"># ê°±ì‹  ì§€ì—° ê°€ëŠ¥ì„± â†’ ê°•ì œ ë¦¬ë¡œë“œ 1íšŒ ì¬ì‹œë„
</span>            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">endpoint not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">list_endpoints</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">out</span><span class="p">[</span><span class="n">dn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
                <span class="c1"># api_keyëŠ” ë¯¸ë…¸ì¶œ
</span>            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>
</code></pre></div></div>

<hr />

<h1 id="3-ê³µìš©-api-ì–´ë””ì„œë“ -ì„í¬íŠ¸í•´-ì“°ëŠ”-í•¨ìˆ˜í˜•-ì¸í„°í˜ì´ìŠ¤">3) ê³µìš© API (ì–´ë””ì„œë“  ì„í¬íŠ¸í•´ ì“°ëŠ” â€œí•¨ìˆ˜í˜•â€ ì¸í„°í˜ì´ìŠ¤)</h1>

<p><code class="language-plaintext highlighter-rouge">config.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="n">.config_core</span> <span class="kn">import</span> <span class="n">ReadOnlyStore</span>

<span class="c1"># ê²½ë¡œë³„ Multiton ë ˆì§€ìŠ¤íŠ¸ë¦¬
</span><span class="n">_REGISTRY</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ReadOnlyStore</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span> <span class="nf">_default_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_PATH</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">get_store</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReadOnlyStore</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - ê²½ë¡œë³„ë¡œ ReadOnlyStore ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¬ì‚¬ìš©(ë©€í‹°í†¤)
    - ëª…ì‹œ path ì—†ìœ¼ë©´ COMFY_CONFIG_PATH ë˜ëŠ” íŒ¨í‚¤ì§€ ê¸°ë³¸ config.toml
    </span><span class="sh">"""</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span> <span class="ow">or</span> <span class="nf">_default_path</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_REGISTRY</span><span class="p">:</span>
        <span class="n">_REGISTRY</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="nc">ReadOnlyStore</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_REGISTRY</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>

<span class="c1"># ---- ì–‡ì€ í•¨ìˆ˜í˜• í—¬í¼ë“¤ (ê¶Œì¥) ----
</span><span class="k">def</span> <span class="nf">endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">ì—”ë“œí¬ì¸íŠ¸ dict ë°˜í™˜: display_name, request_name, base_url, api_key</span><span class="sh">"""</span>
    <span class="k">return</span> <span class="nf">get_store</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">get_endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">endpoints</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
    <span class="sh">"""</span><span class="s">ì—”ë“œí¬ì¸íŠ¸ ëª©ë¡(JSONìš©)</span><span class="sh">"""</span>
    <span class="k">return</span> <span class="nf">get_store</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">list_endpoints</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">dotted_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">ì„ì˜ ì„¤ì •ê°’ ë°˜í™˜: </span><span class="sh">'</span><span class="s">section.sub.key</span><span class="sh">'"""</span>
    <span class="k">return</span> <span class="nf">get_store</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">get_value</span><span class="p">(</span><span class="n">dotted_path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">ì „ì²´ íŠ¸ë¦¬ ìŠ¤ëƒ…ìƒ·</span><span class="sh">"""</span>
    <span class="k">return</span> <span class="nf">get_store</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">snapshot</span><span class="p">()</span>
</code></pre></div></div>

<blockquote>
  <p>í¬ì¸íŠ¸: <strong>ë‹¤ë¥¸ ë…¸ë“œ íŒŒì¼</strong> ì—ì„œëŠ” <code class="language-plaintext highlighter-rouge">config.endpoint()</code>, <code class="language-plaintext highlighter-rouge">config.get()</code> ê°™ì€ <strong>í•¨ìˆ˜í˜• APIë§Œ</strong> ì“°ë©´ ë©ë‹ˆë‹¤.<br />
 ë‚´ë¶€ì ìœ¼ë¡œëŠ” ê²½ë¡œë³„ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¬ì‚¬ìš©í•˜ì§€ë§Œ, ë…¸ë“œ ì½”ë“œì—ì„œëŠ” ì‹±ê¸€í†¤ì— ì˜ì¡´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
</blockquote>

<hr />

<h1 id="4-ì˜µì…˜-ë°ëª¨-ë…¸ë“œ--ê¸°ì¡´-ë…¸ë“œë¥¼-ì´-apië¡œ-ì–‡ê²Œ-ë˜í•‘">4) (ì˜µì…˜) ë°ëª¨ ë…¸ë“œ â€” ê¸°ì¡´ ë…¸ë“œë¥¼ ì´ APIë¡œ ì–‡ê²Œ ë˜í•‘</h1>

<p><code class="language-plaintext highlighter-rouge">config_nodes.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">.config</span> <span class="kn">import</span> <span class="n">endpoint</span> <span class="k">as</span> <span class="n">_endpoint</span><span class="p">,</span> <span class="n">endpoints</span> <span class="k">as</span> <span class="n">_endpoints</span><span class="p">,</span> <span class="n">get</span> <span class="k">as</span> <span class="n">_get</span>
<span class="kn">import</span> <span class="n">json</span>

<span class="k">class</span> <span class="nc">ConfigEndpointLookup</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
                             <span class="sh">"</span><span class="s">config_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">})}}</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">lookup</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Config/Endpoints (ReadOnly)</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">config_path</span> <span class="ow">or</span> <span class="bp">None</span>
        <span class="n">ep</span> <span class="o">=</span> <span class="nf">_endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span> <span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">],</span> <span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span> <span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">ConfigListEndpoints</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">config_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">})}}</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">endpoints_json</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">list_endpoints</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Config/Endpoints (ReadOnly)</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">list_endpoints</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">config_path</span> <span class="ow">or</span> <span class="bp">None</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_endpoints</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),)</span>

<span class="k">class</span> <span class="nc">ConfigGetValue</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
                             <span class="sh">"</span><span class="s">config_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">})}}</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">get_value</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Config/General (ReadOnly)</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">config_path</span> <span class="ow">or</span> <span class="bp">None</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nf">_get</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">))</span> <span class="ow">or</span> <span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">val</span><span class="p">),)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),)</span>

<span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">ConfigEndpointLookup</span><span class="sh">"</span><span class="p">:</span> <span class="n">ConfigEndpointLookup</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigListEndpoints</span><span class="sh">"</span><span class="p">:</span>  <span class="n">ConfigListEndpoints</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigGetValue</span><span class="sh">"</span><span class="p">:</span>       <span class="n">ConfigGetValue</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">ConfigEndpointLookup</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Config: Endpoint Lookup</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigListEndpoints</span><span class="sh">"</span><span class="p">:</span>  <span class="sh">"</span><span class="s">Config: List Endpoints</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigGetValue</span><span class="sh">"</span><span class="p">:</span>       <span class="sh">"</span><span class="s">Config: Get Value</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h1 id="5-ë‹¤ë¥¸-ë…¸ë“œ-íŒŒì¼ë“¤ì—ì„œ-ì“°ëŠ”-ë²•-ê°€ì¥-ê¹”ë”í•œ-íŒ¨í„´">5) ë‹¤ë¥¸ ë…¸ë“œ â€œíŒŒì¼ë“¤â€ì—ì„œ ì“°ëŠ” ë²• (ê°€ì¥ ê¹”ë”í•œ íŒ¨í„´)</h1>

<p>ë‹¤ë¥¸ í”ŒëŸ¬ê·¸ì¸/ë…¸ë“œ íŒŒì¼ ì–´ë””ì—ì„œë“ :</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ì˜ˆ: OpenAI í˜¸ì¶œ ë…¸ë“œ íŒŒì¼ ë‚´ë¶€
</span><span class="kn">from</span> <span class="n">comfyui_config_reader.config</span> <span class="kn">import</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">get</span>

<span class="k">def</span> <span class="nf">_prepare_client</span><span class="p">():</span>
    <span class="n">ep</span> <span class="o">=</span> <span class="nf">endpoint</span><span class="p">(</span><span class="sh">"</span><span class="s">text-model-a</span><span class="sh">"</span><span class="p">)</span>   <span class="c1"># ë˜ëŠ” display_name / request_nameë¡œ ì¡°íšŒ
</span>    <span class="n">api_key</span> <span class="o">=</span> <span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">base_url</span> <span class="o">=</span> <span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]</span>
    <span class="c1"># ... í´ë¼ì´ì–¸íŠ¸ ìƒì„±
</span>    <span class="k">return</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">base_url</span>

<span class="k">def</span> <span class="nf">_s3_settings</span><span class="p">():</span>
    <span class="n">region</span> <span class="o">=</span> <span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">storage.s3.region</span><span class="sh">"</span><span class="p">)</span>    <span class="c1"># ë²”ìš© ì„¤ì • ì ‘ê·¼
</span>    <span class="n">bucket</span> <span class="o">=</span> <span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">storage.s3.bucket</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">region</span><span class="p">,</span> <span class="n">bucket</span>
</code></pre></div></div>

<ul>
  <li>
    <p>ê¸°ë³¸ ê²½ë¡œëŠ” <code class="language-plaintext highlighter-rouge">COMFY_CONFIG_PATH</code> ë˜ëŠ” <code class="language-plaintext highlighter-rouge">comfyui_config_reader/config.toml</code>.</p>
  </li>
  <li>
    <p>íŠ¹ì • íŒŒì¼ì„ ì“°ê³  ì‹¶ìœ¼ë©´ <code class="language-plaintext highlighter-rouge">endpoint("text-model-a", path="/abs/path/to/config.toml")</code>ì²˜ëŸ¼ <strong>í•¨ìˆ˜ ì¸ì</strong> ë¡œ ì£¼ë©´ ë©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë‚´ë¶€ëŠ” <strong>ê²½ë¡œë³„ ë ˆì§€ìŠ¤íŠ¸ë¦¬(Multiton)</strong>ë¼ ê°™ì€ ê²½ë¡œëŠ” ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê³µìœ (ì„±ëŠ¥â†‘)í•˜ì§€ë§Œ, í˜¸ì¶œë¶€ëŠ” <strong>í•¨ìˆ˜í˜•</strong> ì´ë¼ ì‹±ê¸€í†¤ì— ì¢…ì†ë˜ì§€ ì•Šì•„ìš”.</p>
  </li>
</ul>

<hr />

<h1 id="6-ìš”ê±´-ì²´í¬">6) ìš”ê±´ ì²´í¬</h1>

<ul>
  <li>
    <p>ì—¬ëŸ¬ ë…¸ë“œ/íŒŒì¼ì—ì„œ ê³µí†µ ì‚¬ìš©: <strong>í•¨ìˆ˜í˜• API</strong> ë¡œ ê°„ë‹¨ ì„í¬íŠ¸</p>
  </li>
  <li>
    <p>ì‹±ê¸€í†¤ ì–´ìƒ‰í•¨ ì œê±°: <strong>ê²½ë¡œë³„ Multiton + helper í•¨ìˆ˜</strong> â†’ ëª…ì‹œì  DIë„ ê°€ëŠ¥(<code class="language-plaintext highlighter-rouge">get_store(path)</code>)</p>
  </li>
  <li>
    <p>ì½ê¸° ì „ìš© + 1ë¶„ ë‚´ ë°˜ì˜: <strong>mtime + 5~60s TTL(ê¸°ë³¸ 30s)</strong></p>
  </li>
  <li>
    <p>ì‚¬ëŒì´ í¸ì§‘ ì‰¬ì›€: <strong>TOML + ENV ì¹˜í™˜</strong></p>
  </li>
  <li>
    <p>ì—”ë“œí¬ì¸íŠ¸ 4í•„ë“œ: <code class="language-plaintext highlighter-rouge">display_name, request_name, base_url, api_key</code></p>
  </li>
</ul>

<hr />

<p>í•„ìš”í•˜ë©´ <code class="language-plaintext highlighter-rouge">get_store(path)</code>ë¡œ <strong>ëª…ì‹œì  ì˜ì¡´ì„± ì£¼ì…(DI)</strong>ë„ ê°€ëŠ¥í•´ìš”. ì˜ˆì»¨ëŒ€ í”„ë ˆì„ì›Œí¬ ì´ˆê¸°í™” ì‹œ:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader.config</span> <span class="kn">import</span> <span class="n">get_store</span>
<span class="n">STORE</span> <span class="o">=</span> <span class="nf">get_store</span><span class="p">(</span><span class="sh">"</span><span class="s">/path/to/config.toml</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ì´í›„ ì–´ë””ì„œë“ :
</span><span class="n">ep</span> <span class="o">=</span> <span class="n">STORE</span><span class="p">.</span><span class="nf">get_endpoint</span><span class="p">(</span><span class="sh">"</span><span class="s">text-model-a</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>ì´ë ‡ê²Œ í•˜ë©´ ì•„ì˜ˆ ì „ì—­ í•¨ìˆ˜ë„ ì•ˆ ì“°ê³ , â€œë‚´ê°€ ì£¼ì…í•œ ìŠ¤í† ì–´â€ë§Œ ì°¸ì¡°í•˜ëŠ” í˜•íƒœë¡œ ì™„ì „íˆ ë¶„ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p class="chat--user">

ì•„ë‹ˆ ì‹±ê¸€í†¤ì€ ê´œì°®ì€ë° ì™¸ë¶€ì—ì„œ ì ‘ê·¼ì´ ì‰½ì§€ ì•Šì•„ë³´ì—¬ì„œ. ì‹±ê¸€í†¤ì´ ë‚«ì§€ ì•Šì•„?

</p>

<p>ì¢‹ì•„, <strong>ì‹±ê¸€í†¤ìœ¼ë¡œ ë‹¨ìˆœÂ·ì§ê´€ ì ‘ê·¼</strong> ê°€ëŠ¥í•˜ê²Œ ì •ë¦¬í•´ì¤„ê²Œ.<br />
ì™¸ë¶€ ë…¸ë“œ â€œíŒŒì¼ë“¤â€ ì–´ë””ì„œë“  í•œ ì¤„ ì„í¬íŠ¸ë¡œ ë°”ë¡œ ì“°ëŠ” í˜•íƒœì•¼:</p>

<ul>
  <li>
    <p>í•¨ìˆ˜í˜•: <code class="language-plaintext highlighter-rouge">from comfyui_config_reader import endpoint, get</code></p>
  </li>
  <li>
    <p>ê°ì²´í˜•: <code class="language-plaintext highlighter-rouge">from comfyui_config_reader import CONFIG</code></p>
  </li>
</ul>

<p>ë‘˜ ë‹¤ ê°™ì€ ì‹±ê¸€í†¤ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë’¤ì—ì„œ ì‚¬ìš©í•´. (thread-safe, read-only, 1ë¶„ ë‚´ ë°˜ì˜)</p>

<hr />

<h1 id="1-íŒŒì¼-êµ¬ì¡°-ì‹¬í”Œ">1) íŒŒì¼ êµ¬ì¡° (ì‹¬í”Œ)</h1>
<div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ComfyUI/
â””â”€ custom_nodes/
   â””â”€ comfyui_config_reader/
      â”œâ”€ __init__.py
      â”œâ”€ config_singleton.py   # ì‹±ê¸€í†¤ ë³¸ì²´
      â””â”€ config.toml
</code></pre></div></div>

<hr />

<h1 id="2-configtoml-ì˜ˆì‹œ-ë²”ìš©">2) <code class="language-plaintext highlighter-rouge">config.toml</code> ì˜ˆì‹œ (ë²”ìš©)</h1>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">version</span> <span class="p">=</span> <span class="mi">1</span>

<span class="nn">[settings]</span>
<span class="py">refresh_interval_seconds</span> <span class="p">=</span> <span class="mi">30</span>  <span class="c"># 5~60 ì‚¬ì´ ê¶Œì¥</span>

<span class="nn">[endpoints."text-model-a"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"Text Model A"</span>
<span class="py">request_name</span>  <span class="p">=</span> <span class="s">"gpt-4o-mini"</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${OPENAI_API_KEY}"</span>

<span class="nn">[feature_flags]</span>
<span class="py">use_cache</span> <span class="p">=</span> <span class="kc">true</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">${ENV}</code> ëŠ” í™˜ê²½ë³€ìˆ˜ ì¹˜í™˜ë¨.</li>
</ul>

<hr />

<h1 id="3-ì‹±ê¸€í†¤-êµ¬í˜„-config_singletonpy">3) ì‹±ê¸€í†¤ êµ¬í˜„: <code class="language-plaintext highlighter-rouge">config_singleton.py</code></h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="c1"># Python 3.11+: tomllib / ì´í•˜: tomli
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="k">def</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="sh">""</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">v</span>

<span class="k">def</span> <span class="nf">_norm</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - TOML íŒŒì¼ ì½ê¸° ì „ìš©
    - mtime ë³€ê²½ + TTL(5~60s, ê¸°ë³¸ 30s) ìë™ ì¬ë¡œë“œ
    - endpoints 4í•„ë“œ ì¸ë±ì‹±(display_name, request_name, base_url, api_key)
    - ì„ì˜ ê²½ë¡œ ì ‘ê·¼ ê°€ëŠ¥ (</span><span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="s"> êµ¬ë¶„)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ep_index</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># -------- ë‚´ë¶€ ë¡œë”© --------
</span>    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ep_index</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">endpoints</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">return</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">eps</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
            <span class="n">req</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">req</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)),</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))}:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_ep_index</span><span class="p">[</span><span class="nf">_norm</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]),</span>
                        <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">]),</span>
                        <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]),</span>
                        <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
        <span class="c1"># refresh_interval_seconds (5~60) + env override
</span>        <span class="n">r</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
        <span class="n">env_r</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_r</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">env_r</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span> <span class="k">pass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="n">r</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="c1"># -------- í¼ë¸”ë¦­ API --------
</span>    <span class="k">def</span> <span class="nf">endpoint</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">endpoint key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ep_index</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="c1"># ì¦‰ì‹œ ì¬ì‹œë„(ê°±ì‹  ì§€ì—° ë³´ì •)
</span>            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ep_index</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">endpoint not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">endpoints</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_ep_index</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">out</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>  <span class="c1"># api_key ë¯¸ë…¸ì¶œ
</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_raw</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">dotted</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">config path not found: </span><span class="si">{</span><span class="n">dotted</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cur</span>

    <span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>

<span class="c1"># ===== ëª¨ë“ˆ ì „ì—­ ì‹±ê¸€í†¤ =====
</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
<span class="n">_instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ReadOnlyConfig</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">_default_path</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># configure()ë¡œ ì§€ì • ê°€ëŠ¥
</span>
<span class="k">def</span> <span class="nf">_resolve_default_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_default_path</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_PATH</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_get_instance</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span>
    <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">_instance</span>

<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">refresh_seconds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ì‹±ê¸€í†¤ ì„¤ì •(ì„ íƒ): ê²½ë¡œ/TTL ì˜¤ë²„ë¼ì´ë“œ.
    - ê°€ëŠ¥í•œ í•œ </span><span class="sh">'</span><span class="s">ì´ˆê¸°í™” ì‹œ 1íšŒ</span><span class="sh">'</span><span class="s">ë§Œ í˜¸ì¶œ ì¶”ì²œ.
    - ì´í›„ì—ë„ í˜¸ì¶œ ê°€ëŠ¥í•˜ë©°, ìƒˆ ì¸ìŠ¤í„´ìŠ¤ë¡œ êµì²´ë¨( thread-safe ).
    </span><span class="sh">"""</span>
    <span class="k">global</span> <span class="n">_instance</span><span class="p">,</span> <span class="n">_default_path</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">_default_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">refresh_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">refresh_seconds</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
        <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>

<span class="c1"># ---- ì™¸ë¶€ì— ë…¸ì¶œí•  ì–‡ì€ API (ê°€ì¥ ì‰¬ìš´ ì ‘ê·¼) ----
</span><span class="k">def</span> <span class="nf">endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">endpoints</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
    <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">endpoints</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">snapshot</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">snapshot</span><span class="p">()</span>

<span class="c1"># ---- ê°ì²´í˜• ì ‘ê·¼ì„ ìœ„í•œ í”„ë¡ì‹œ(CONFIG) ----
</span><span class="k">class</span> <span class="nc">_ConfigProxy</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># CONFIG.endpoint(...), CONFIG.get(...) í˜•íƒœ ì§€ì›
</span>        <span class="k">return</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">_get_instance</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>

<span class="n">CONFIG</span> <span class="o">=</span> <span class="nf">_ConfigProxy</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="4-__init__py-í•œ-ì¤„-ì„í¬íŠ¸-ì§€ì›">4) <code class="language-plaintext highlighter-rouge">__init__.py</code> (í•œ ì¤„ ì„í¬íŠ¸ ì§€ì›)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ì™¸ë¶€ì—ì„œ ì•„ì£¼ ê°„ë‹¨íˆ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ re-export
</span><span class="kn">from</span> <span class="n">.config_singleton</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CONFIG</span><span class="p">,</span>        <span class="c1"># ê°ì²´í˜•: CONFIG.endpoint(...), CONFIG.get(...)
</span>    <span class="n">configure</span><span class="p">,</span>     <span class="c1"># ì„ íƒ: ì´ˆê¸°í™” ì‹œ ê²½ë¡œ/TTL ì§€ì •
</span>    <span class="n">endpoint</span><span class="p">,</span>      <span class="c1"># í•¨ìˆ˜í˜•: endpoint("text-model-a")
</span>    <span class="n">endpoints</span><span class="p">,</span>
    <span class="n">get</span><span class="p">,</span>
    <span class="n">snapshot</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<hr />

<h1 id="5-ì™¸ë¶€-ë…¸ë“œ-íŒŒì¼ë“¤ì—ì„œ-ì“°ëŠ”-ë²•">5) ì™¸ë¶€ ë…¸ë“œ â€œíŒŒì¼ë“¤â€ì—ì„œ ì“°ëŠ” ë²•</h1>

<h2 id="ê°€ì¥-ê°„ë‹¨-í•¨ìˆ˜í˜•">ê°€ì¥ ê°„ë‹¨ (í•¨ìˆ˜í˜•)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">get</span>

<span class="k">def</span> <span class="nf">build_client</span><span class="p">():</span>
    <span class="n">ep</span> <span class="o">=</span> <span class="nf">endpoint</span><span class="p">(</span><span class="sh">"</span><span class="s">text-model-a</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># í‚¤ / display_name / request_name ì¤‘ ì•„ë¬´ê±°ë‚˜ OK
</span>    <span class="n">base_url</span> <span class="o">=</span> <span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">api_key</span>  <span class="o">=</span> <span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
    <span class="c1"># ... í´ë¼ì´ì–¸íŠ¸ ìƒì„±
</span></code></pre></div></div>

<h2 id="ê°ì²´í˜•ì´-ìµìˆ™í•˜ë‹¤ë©´">ê°ì²´í˜•ì´ ìµìˆ™í•˜ë‹¤ë©´</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="n">CONFIG</span>

<span class="k">def</span> <span class="nf">build_client</span><span class="p">():</span>
    <span class="n">ep</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="p">.</span><span class="nf">endpoint</span><span class="p">(</span><span class="sh">"</span><span class="s">text-model-a</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># CONFIG.get("storage.s3.region") ë“±ë„ ë™ì¼
</span></code></pre></div></div>

<h2 id="ì‹œì‘-ì‹œ-ê²½ë¡œttl-ì§€ì •ì„ íƒ">ì‹œì‘ ì‹œ ê²½ë¡œ/TTL ì§€ì •(ì„ íƒ)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ì˜ˆ: __init__ í˜¹ì€ ComfyUI ë¶€íŒ… ì´ˆê¸°ì— í•œ ë²ˆ
</span><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="n">configure</span>
<span class="nf">configure</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="sh">"</span><span class="s">/abs/path/to/config.toml</span><span class="sh">"</span><span class="p">,</span> <span class="n">refresh_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>  <span class="c1"># 5~60 ì‚¬ì´
</span></code></pre></div></div>

<ul>
  <li>ì´í›„ ëª¨ë“  ëª¨ë“ˆì—ì„œ ê°™ì€ ì‹±ê¸€í†¤ì„ ì‚¬ìš©í•˜ê³ , íŒŒì¼ ë³€ê²½ì€ <strong>ìµœëŒ€ 1ë¶„ ë‚´</strong> ë°˜ì˜ë¼ìš”(ê¸°ë³¸ 30ì´ˆ, env/ì„¤ì •ìœ¼ë¡œ ì¡°ì ˆ).</li>
</ul>

<hr />

<h1 id="6-ìš”ê±´-ì¬í™•ì¸">6) ìš”ê±´ ì¬í™•ì¸</h1>

<ul>
  <li>
    <p>âœ… ì™¸ë¶€ ì ‘ê·¼ ì‰¬ì›€: <code class="language-plaintext highlighter-rouge">from comfyui_config_reader import endpoint</code> ë˜ëŠ” <code class="language-plaintext highlighter-rouge">CONFIG.endpoint</code></p>
  </li>
  <li>
    <p>âœ… ì‹±ê¸€í†¤: ëª¨ë“ˆ ì „ì—­ í•œ ê°œ ì¸ìŠ¤í„´ìŠ¤, thread-safe lazy init</p>
  </li>
  <li>
    <p>âœ… ì½ê¸° ì „ìš©: ì“°ê¸° ì—†ìŒ</p>
  </li>
  <li>
    <p>âœ… 1ë¶„ ë‚´ ë°˜ì˜: mtime + TTL(ê¸°ë³¸ 30s, 5~60s)</p>
  </li>
  <li>
    <p>âœ… ì‚¬ëŒì´ í¸ì§‘ ì‰¬ì›€: TOML + <code class="language-plaintext highlighter-rouge">${ENV}</code> ì¹˜í™˜</p>
  </li>
  <li>
    <p>âœ… ì—”ë“œí¬ì¸íŠ¸ 4í•„ë“œ: <code class="language-plaintext highlighter-rouge">display_name</code>, <code class="language-plaintext highlighter-rouge">request_name</code>, <code class="language-plaintext highlighter-rouge">base_url</code>, <code class="language-plaintext highlighter-rouge">api_key</code></p>
  </li>
</ul>

<p>í•„ìš”í•˜ë©´, ì§€ê¸ˆ êµ¬ì¡° ìœ„ì— â€œì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œìš© ë…¸ë“œâ€ë„ ë°”ë¡œ ì–¹ì–´ì¤„ê²Œ.</p>

<p class="chat--user">

endpoint ë§ê³  ì¢€ ë” ì¢‹ì€ ìš©ì–´ ì„ ì •í•´ì¤˜. ê·¸ë¦¬ê³  model configuration (parameter ë“±ë„ ì„¤ì •ì— ê°™ì´ í¬í•¨ì‹œí‚¤ë©´ ì¢‹ê² ì–´)

</p>

<p>ì¢‹ì•„! â€œendpointâ€ ëŒ€ì‹  ë” ìì—°ìŠ¤ëŸ¬ìš´ ìš©ì–´ë¡œ <strong>profile(í”„ë¡œí•„)</strong> ì„ ì“°ê³ , ì—¬ê¸°ì— <strong>model configuration(íŒŒë¼ë¯¸í„° ë“±)</strong> ê¹Œì§€ í•¨ê»˜ ë‹´ëŠ” ë°©í–¥ìœ¼ë¡œ ì •ë¦¬í–ˆì–´.<br />
ì™¸ë¶€ ë…¸ë“œ/íŒŒì¼ì—ì„œëŠ” <strong>ì‹±ê¸€í†¤</strong> ì„ ì•„ì£¼ ê°„ë‹¨íˆ ì“°ë©´ ë˜ê³ , ê¸°ì¡´ endpoint ëª…ì¹­ì€ <strong>í•˜ìœ„ í˜¸í™˜ ë³„ì¹­</strong> ë„ ì œê³µí•´ë‘˜ê²Œ.</p>

<hr />

<h1 id="1-ìš©ì–´-ì„ ì •-step-by-step">1) ìš©ì–´ ì„ ì • (step-by-step)</h1>

<ol>
  <li>
    <p><strong>profile (í”„ë¡œí•„)</strong> â€” ì‚¬ëŒì´ ì´í•´í•˜ê¸° ì‰¬ì›€. â€œì—°ê²° ì •ë³´ + í˜¸ì¶œ ê·œì¹™ + ëª¨ë¸ íŒŒë¼ë¯¸í„° ë¬¶ìŒâ€ì„ í•œ ì„¸íŠ¸ë¡œ ë³´ê¸°ì— ì í•©.</p>
  </li>
  <li>
    <p>ëŒ€ì•ˆ(ì°¸ê³ ): provider, backend, connector, target.</p>

    <ul>
      <li>ê¸°ìˆ ì ìœ¼ë¡œëŠ” <em>backend</em> ë„ ê´œì°®ì§€ë§Œ, â€œì„¤ì • ë¬¶ìŒâ€ ë‰˜ì•™ìŠ¤ëŠ” <em>profile</em> ì´ ê°€ì¥ ì§ê´€ì .</li>
    </ul>
  </li>
  <li>
    <p>ê²°ë¡ : <strong>profiles</strong> ì„¹ì…˜ìœ¼ë¡œ í‘œì¤€í™”í•˜ê³ , <strong>endpoints</strong> ëŠ” ìë™ ì¸ì‹(í•˜ìœ„ í˜¸í™˜) ìœ ì§€.</p>
  </li>
</ol>

<hr />

<h1 id="2-configtoml-ìŠ¤í‚¤ë§ˆ-ëª¨ë¸-íŒŒë¼ë¯¸í„°-í¬í•¨">2) config.toml ìŠ¤í‚¤ë§ˆ (ëª¨ë¸ íŒŒë¼ë¯¸í„° í¬í•¨)</h1>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">version</span> <span class="p">=</span> <span class="mi">1</span>

<span class="nn">[settings]</span>
<span class="c"># íŒŒì¼ ë³€ê²½ ê°ì§€ ì£¼ê¸°(ì´ˆ). 5~60 ê¶Œì¥. "1ë¶„ ë‚´ ë°˜ì˜" ìš”ê±´ ë§Œì¡±.</span>
<span class="py">refresh_interval_seconds</span> <span class="p">=</span> <span class="mi">30</span>

<span class="c"># ëª¨ë“  í”„ë¡œí•„ì— ê³µí†µ ì ìš©ë  ê¸°ë³¸ê°’(ì„ íƒ)</span>
<span class="nn">[defaults.params]</span>
<span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.3</span>
<span class="py">max_tokens</span>  <span class="p">=</span> <span class="mi">2048</span>

<span class="nn">[defaults.http]</span>
<span class="py">timeout_seconds</span> <span class="p">=</span> <span class="mi">30</span>
<span class="nn">[defaults.http.headers]</span>
<span class="py">User-Agent</span> <span class="p">=</span> <span class="s">"ComfyUI-ConfigReader/1.0"</span>
<span class="nn">[defaults.http.query]</span>
<span class="c"># ê³µí†µ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•˜ë©´ ì—¬ê¸°ì—</span>

<span class="c"># â”€â”€ í”„ë¡œí•„ë“¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nn">[profiles."text-model-a"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"Text Model A"</span>
<span class="py">request_name</span>  <span class="p">=</span> <span class="s">"gpt-4o-mini"</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${OPENAI_API_KEY}"</span>

<span class="c"># ì´ í”„ë¡œí•„ì˜ ëª¨ë¸ íŒŒë¼ë¯¸í„°(ê¸°ë³¸ê°’ ìœ„ì— ë®ì–´ì“°ê¸°)</span>
<span class="nn">[profiles."text-model-a".params]</span>
<span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.2</span>
<span class="py">top_p</span>       <span class="p">=</span> <span class="mf">0.9</span>
<span class="py">stop</span>        <span class="p">=</span> <span class="p">[</span><span class="s">"</span><span class="se">\n\n</span><span class="s">Human:"</span><span class="p">,</span> <span class="s">"</span><span class="se">\n\n</span><span class="s">Assistant:"</span><span class="p">]</span>

<span class="c"># HTTP ê´€ë ¨(ì„ íƒ): í—¤ë”, íƒ€ì„ì•„ì›ƒ, ì¿¼ë¦¬ ë“±</span>
<span class="nn">[profiles."text-model-a".http]</span>
<span class="py">timeout_seconds</span> <span class="p">=</span> <span class="mi">20</span>
<span class="nn">[profiles."text-model-a".http.headers]</span>
<span class="py">X-Org-Id</span> <span class="p">=</span> <span class="s">"${ORG_ID}"</span>
<span class="nn">[profiles."text-model-a".http.query]</span>
<span class="py">apiVersion</span> <span class="p">=</span> <span class="s">"2024-06-01"</span>

<span class="nn">[profiles."text-model-b"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"Text Model B"</span>
<span class="py">request_name</span>  <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>
<span class="c"># params/http ì„¹ì…˜ì´ ì—†ìœ¼ë©´ defaultsë§Œ ì ìš©</span>
</code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">${ENV}</code> ëŠ” í™˜ê²½ë³€ìˆ˜ ì¹˜í™˜ë¨.</p>
  </li>
  <li>
    <p><strong>params</strong> : temperature/top_p/max_tokens/stop/seed ë“± ì›í•˜ëŠ” íŒŒë¼ë¯¸í„° ììœ  í™•ì¥.</p>
  </li>
  <li>
    <p><strong>http</strong> : timeout_seconds / headers / query ë“± ìš”ì²­ ê´€ë ¨ ì˜µì…˜.</p>
  </li>
  <li>
    <p>ìƒë‹¨ì˜ <strong>[defaults]</strong> ëŠ” ëª¨ë“  í”„ë¡œí•„ì— <strong>ë³‘í•©(merge)</strong> ë˜ì–´ ê¸°ë³¸ê°’ ì—­í• .</p>
  </li>
</ul>

<hr />

<h1 id="3-ì‹±ê¸€í†¤-api-drop-in-profile--params--http">3) ì‹±ê¸€í†¤ API (drop-in): profile + params + http</h1>

<p>ì™¸ë¶€ ì–´ë””ì„œë“  í•œ ì¤„ë¡œ ì ‘ê·¼:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="n">profile</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">http</span><span class="p">,</span> <span class="n">get</span>
<span class="c1"># ë˜ëŠ” ê°ì²´í˜•:
</span><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="n">CONFIG</span>
</code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">profile(key)</code> â†’ ì—°ê²°ì •ë³´ + ëª¨ë¸íŒŒë¼ë¯¸í„° + http ì„¤ì •ê¹Œì§€ <strong>í•œ ë²ˆì—</strong></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">params(key)</code> â†’ í•´ë‹¹ í”„ë¡œí•„ì˜ <strong>ëª¨ë¸ íŒŒë¼ë¯¸í„° dict</strong></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">http(key)</code> â†’ í•´ë‹¹ í”„ë¡œí•„ì˜ <strong>HTTP ì˜µì…˜ dict</strong></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">get("storage.s3.region")</code> ì²˜ëŸ¼ ë²”ìš© í‚¤ ì ‘ê·¼ë„ ìœ ì§€</p>
  </li>
  <li>
    <p>í•˜ìœ„ í˜¸í™˜: <code class="language-plaintext highlighter-rouge">endpoint</code>, <code class="language-plaintext highlighter-rouge">endpoints</code> ë³„ì¹­ë„ ë‚¨ê²¨ë‘ (ê¸°ì¡´ ì½”ë“œ ì•ˆê¹¨ì§)</p>
  </li>
</ul>

<hr />

<h1 id="4-êµì²´ë³¸-ì½”ë“œ-config_singletonpy">4) êµì²´ë³¸ ì½”ë“œ (<code class="language-plaintext highlighter-rouge">config_singleton.py</code>)</h1>

<p>ì•„ë˜ íŒŒì¼ í•˜ë‚˜ë¡œ ê¸°ì¡´ ì‹±ê¸€í†¤ êµ¬í˜„ì„ ëŒ€ì²´í•˜ë©´ ë¼. (ê¸°ëŠ¥: profiles + defaults ë³‘í•© + params/http ì§€ì› + legacy <code class="language-plaintext highlighter-rouge">endpoints</code> ì¸ì‹)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="c1"># Python 3.11+: tomllib / ì´í•˜: tomli
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="k">def</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="sh">""</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">v</span>

<span class="k">def</span> <span class="nf">_norm</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">base</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">over</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">ì–•ì€ dict updateê°€ ì•„ë‹Œ, ì¤‘ì²© dictê¹Œì§€ ë³‘í•©.</span><span class="sh">"""</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">over</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - ì½ê¸° ì „ìš© TOML
    - mtime + TTL(5~60s, ê¸°ë³¸ 30s) ìë™ ì¬ë¡œë“œ â†’ 1ë¶„ ë‚´ ë³€ê²½ ë°˜ì˜
    - </span><span class="sh">'</span><span class="s">profiles</span><span class="sh">'</span><span class="s"> í‘œì¤€ + </span><span class="sh">'</span><span class="s">endpoints</span><span class="sh">'</span><span class="s"> ë ˆê±°ì‹œë„ ìë™ ì¸ì‹
    - ê° profileì—:
        * display_name, request_name, base_url, api_key (í•„ìˆ˜)
        * params(dict)  : ëª¨ë¸ íŒŒë¼ë¯¸í„°
        * http(dict)    : timeout_seconds, headers{}, query{}
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># ì •ê·œí™” í‚¤ -&gt; profile dict
</span>
    <span class="c1"># -------- ë‚´ë¶€ ë¡œë”© --------
</span>    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_extract_profiles_table</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># í‘œì¤€ 'profiles' ìš°ì„ , ì—†ìœ¼ë©´ 'endpoints'(í•˜ìœ„ í˜¸í™˜)
</span>        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">profiles</span><span class="sh">"</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">profiles</span><span class="sh">"</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">endpoints</span><span class="sh">"</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">endpoints</span><span class="sh">"</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

        <span class="c1"># defaults (ENV í™•ì¥ í¬í•¨)
</span>        <span class="n">defaults</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">defaults</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">defaults_params</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">defaults_http</span>   <span class="o">=</span> <span class="n">defaults</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">)</span>   <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">defaults_http</span><span class="p">:</span> <span class="n">defaults_http</span><span class="p">[</span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">query</span><span class="sh">"</span>   <span class="ow">not</span> <span class="ow">in</span> <span class="n">defaults_http</span><span class="p">:</span> <span class="n">defaults_http</span><span class="p">[</span><span class="sh">"</span><span class="s">query</span><span class="sh">"</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{}</span>

        <span class="n">profiles_tbl</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_extract_profiles_table</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">profiles_tbl</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">raw_cfg</span> <span class="ow">in</span> <span class="n">profiles_tbl</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_cfg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">raw_cfg</span><span class="p">)</span>  <span class="c1"># ENV ì¹˜í™˜
</span>            <span class="c1"># í•„ìˆ˜ í•„ë“œ
</span>            <span class="n">req</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">req</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># params/http ë³‘í•© (defaults â†’ profile override)
</span>            <span class="n">p_params</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">p_http</span>   <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">)</span>   <span class="ow">or</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p_http</span><span class="p">:</span> <span class="n">p_http</span><span class="p">[</span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="sh">"</span><span class="s">query</span><span class="sh">"</span>   <span class="ow">not</span> <span class="ow">in</span> <span class="n">p_http</span><span class="p">:</span> <span class="n">p_http</span><span class="p">[</span><span class="sh">"</span><span class="s">query</span><span class="sh">"</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{}</span>

            <span class="n">merged_params</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">defaults_params</span><span class="p">,</span> <span class="o">**</span><span class="n">p_params</span><span class="p">}</span>
            <span class="n">merged_http</span>   <span class="o">=</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">defaults_http</span><span class="p">,</span> <span class="n">p_http</span><span class="p">)</span>

            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]),</span>
                <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">]),</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]),</span>
                <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span>      <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]),</span>
                <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:</span>       <span class="n">merged_params</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">:</span>         <span class="n">merged_http</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># ì ‘ê·¼ í‚¤: ì •ì˜ í‚¤ / display_name / request_name
</span>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)),</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))}:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">[</span><span class="nf">_norm</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">entry</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

        <span class="c1"># refresh_interval_seconds (5~60) + env override
</span>        <span class="n">r</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
        <span class="n">env_r</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_r</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">env_r</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span> <span class="k">pass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="n">r</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="c1"># -------- í¼ë¸”ë¦­ API --------
</span>    <span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">profile key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="c1"># ì¦‰ì‹œ ì¬ì‹œë„(ê°±ì‹  ì§€ì—° ë³´ì •)
</span>            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">profile not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">profiles</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sh">"""</span><span class="s">api_keyëŠ” ìˆ¨ê¸°ê³ , ë‚˜ë¨¸ì§€ ë©”íƒ€/params/httpëŠ” ë…¸ì¶œ.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dn</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>  <span class="c1"># display_name ì¤‘ë³µ í‚¤ ë°©ì§€
</span>                <span class="k">continue</span>
            <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">dn</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="n">dn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:</span>       <span class="n">v</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span>
                <span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">:</span>         <span class="n">v</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">profile</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="k">def</span> <span class="nf">http</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">profile</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_raw</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">dotted</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">config path not found: </span><span class="si">{</span><span class="n">dotted</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cur</span>

    <span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>

<span class="c1"># ===== ëª¨ë“ˆ ì „ì—­ ì‹±ê¸€í†¤ =====
</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
<span class="n">_instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ReadOnlyConfig</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">_default_path</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># configure()ë¡œ ì§€ì • ê°€ëŠ¥
</span>
<span class="k">def</span> <span class="nf">_resolve_default_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_default_path</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_PATH</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_get_instance</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span>
    <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">_instance</span>

<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">refresh_seconds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">ì„ íƒ: ê²½ë¡œ/TTL ì˜¤ë²„ë¼ì´ë“œ(ì´ˆê¸°í™” ì‹œ 1íšŒ ê¶Œì¥).</span><span class="sh">"""</span>
    <span class="k">global</span> <span class="n">_instance</span><span class="p">,</span> <span class="n">_default_path</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">_default_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">refresh_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">refresh_seconds</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
        <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>

<span class="c1"># ---- ì™¸ë¶€ì— ë…¸ì¶œí•  ê°„ë‹¨ API ----
</span><span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">profile</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">profiles</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">profiles</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">params</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">http</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">http</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">snapshot</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">snapshot</span><span class="p">()</span>

<span class="c1"># ---- í•˜ìœ„ í˜¸í™˜ ë³„ì¹­ (endpoint*) ----
</span><span class="k">def</span> <span class="nf">endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nf">profile</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">endpoints</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="k">return</span> <span class="nf">profiles</span><span class="p">()</span>

<span class="c1"># ---- ê°ì²´í˜• ì ‘ê·¼ í”„ë¡ì‹œ(CONFIG) ----
</span><span class="k">class</span> <span class="nc">_ConfigProxy</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">_get_instance</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>

<span class="n">CONFIG</span> <span class="o">=</span> <span class="nf">_ConfigProxy</span><span class="p">()</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">__init__.py</code> (re-export)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">.config_singleton</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CONFIG</span><span class="p">,</span>
    <span class="n">configure</span><span class="p">,</span>
    <span class="n">profile</span><span class="p">,</span> <span class="n">profiles</span><span class="p">,</span>
    <span class="n">params</span><span class="p">,</span> <span class="n">http</span><span class="p">,</span>
    <span class="n">get</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">,</span>
    <span class="c1"># legacy alias
</span>    <span class="n">endpoint</span><span class="p">,</span> <span class="n">endpoints</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<hr />

<h1 id="5-ì™¸ë¶€ì—ì„œ-ì“°ëŠ”-ë²•-ì˜ˆì‹œ">5) ì™¸ë¶€ì—ì„œ ì“°ëŠ” ë²• (ì˜ˆì‹œ)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="n">profile</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">http</span>

<span class="c1"># (1) í•œ ë²ˆì— ì „ë¶€ ë°›ê¸°
</span><span class="n">cfg</span> <span class="o">=</span> <span class="nf">profile</span><span class="p">(</span><span class="sh">"</span><span class="s">Text Model A</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># ë˜ëŠ” "text-model-a" / "gpt-4o-mini"
</span><span class="n">api_key</span>   <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
<span class="n">base_url</span>  <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]</span>
<span class="n">req_name</span>  <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">]</span>
<span class="n">p</span>         <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">]</span>      <span class="c1"># dict (temperature/top_p/...)
</span><span class="n">h</span>         <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">]</span>        <span class="c1"># dict (timeout_seconds/headers/query)
</span>
<span class="c1"># (2) í•„ìš”ë§Œ ë”°ë¡œ
</span><span class="n">p</span> <span class="o">=</span> <span class="nf">params</span><span class="p">(</span><span class="sh">"</span><span class="s">text-model-a</span><span class="sh">"</span><span class="p">)</span>
<span class="n">h</span> <span class="o">=</span> <span class="nf">http</span><span class="p">(</span><span class="sh">"</span><span class="s">text-model-a</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h1 id="6-í¬ì¸íŠ¸-ì •ë¦¬">6) í¬ì¸íŠ¸ ì •ë¦¬</h1>

<ul>
  <li>
    <p>â€œendpointâ€ â†’ <strong>â€œprofileâ€</strong> ë¡œ ëª…í™•í™” (ì„¤ì • ë¬¶ìŒ)</p>
  </li>
  <li>
    <p><strong>model configuration(params)</strong> ì„ í”„ë¡œí•„ ë‚´ë¶€ì— í¬í•¨, <strong>defaults</strong> ë¡œ ê³µí†µê°’ ì§€ì›</p>
  </li>
  <li>
    <p>ì‹±ê¸€í†¤ ê·¸ëŒ€ë¡œ ìœ ì§€ + <strong>ì™¸ë¶€ ì ‘ê·¼ ê°„ë‹¨í™”</strong>(í•¨ìˆ˜/ê°ì²´í˜• ëª¨ë‘)</p>
  </li>
  <li>
    <p>í•˜ìœ„ í˜¸í™˜: <code class="language-plaintext highlighter-rouge">endpoint(s)</code> ë³„ì¹­ ì œê³µ</p>
  </li>
  <li>
    <p>íŒŒì¼ ë³€ê²½ì€ <strong>ìµœëŒ€ 1ë¶„ ë‚´ ë°˜ì˜</strong>(mtime + TTL 5~60s, ê¸°ë³¸ 30s)</p>
  </li>
</ul>

<p>ì›í•˜ë©´, ComfyUI ë…¸ë“œ(ì‹œê°ì )ë„ <code class="language-plaintext highlighter-rouge">params/http</code>ë¥¼ JSONìœ¼ë¡œ ê°™ì´ ë‚´ë³´ë‚´ëŠ” <code class="language-plaintext highlighter-rouge">ConfigProfileLookup</code> ë…¸ë“œ ë²„ì „ë„ ë°”ë¡œ ë§Œë“¤ì–´ ì¤„ê²Œ!</p>

<p class="chat--user">

profileì€ ì¢€ ë„ˆë¬´ ë²”ìš©ì ì¸ë°

</p>

<p>ì¢‹ì•„, â€œprofileâ€ì´ ë„ˆë¬´ ë²”ìš©ì ìœ¼ë¡œ ëŠê»´ì§„ë‹¤ë©´ ë” ëª©ì ì— ë”± ë§ëŠ” <strong>preset(í”„ë¦¬ì…‹)</strong> ìœ¼ë¡œ ìš©ì–´ë¥¼ ì¢íˆìê³  ì œì•ˆí• ê²Œ. â€œí”„ë¦¬ì…‹â€ì€ <em>ëª¨ë¸ ì—°ê²° ì •ë³´ + ìš”ì²­ ì‹ë³„ì + ëª¨ë¸ íŒŒë¼ë¯¸í„° + HTTP ì˜µì…˜</em> ì„ í•œ ì„¸íŠ¸ë¡œ ë‹´ëŠ” ì˜ë¯¸ê°€ ë¶„ëª…í•˜ê³ , UI/ì›Œí¬í”Œë¡œìš°ì—ì„œë„ í”íˆ ì“°ì´ëŠ” í‘œí˜„ì´ë¼ ì§ê´€ì ì´ì•¼.<br />
ì•„ë˜ëŠ” <strong>ìš©ì–´/ìŠ¤í‚¤ë§ˆ/ì½”ë“œ ì „ë¶€ â€˜presetâ€™ìœ¼ë¡œ ì •ë¦¬í•œ ìµœì¢…ë³¸</strong> ì´ì•¼. (ê¸°ì¡´ <code class="language-plaintext highlighter-rouge">profile(s)</code>/<code class="language-plaintext highlighter-rouge">endpoint(s)</code>ëŠ” í•˜ìœ„ í˜¸í™˜ ë³„ì¹­ ìœ ì§€)</p>

<hr />

<h1 id="1-ì´ë¦„--ìŠ¤í‚¤ë§ˆ-ê²°ì •-step-by-step">1) ì´ë¦„ Â· ìŠ¤í‚¤ë§ˆ ê²°ì • (step-by-step)</h1>

<ul>
  <li>
    <p>ì„¹ì…˜ëª…: <strong><code class="language-plaintext highlighter-rouge">[presets."í‚¤"]</code></strong></p>
  </li>
  <li>
    <p>í•„ìˆ˜ í•„ë“œ: <code class="language-plaintext highlighter-rouge">display_name</code>, <code class="language-plaintext highlighter-rouge">request_name</code>, <code class="language-plaintext highlighter-rouge">base_url</code>, <code class="language-plaintext highlighter-rouge">api_key</code></p>
  </li>
  <li>
    <p>ì„ íƒ í•„ë“œ: <code class="language-plaintext highlighter-rouge">params</code>(ëª¨ë¸ íŒŒë¼ë¯¸í„°), <code class="language-plaintext highlighter-rouge">http</code>(timeout/headers/query ë“±)</p>
  </li>
  <li>
    <p>ê³µí†µ ê¸°ë³¸ê°’ ë³‘í•©: <code class="language-plaintext highlighter-rouge">defaults.params</code>, <code class="language-plaintext highlighter-rouge">defaults.http</code>ë¥¼ ê° í”„ë¦¬ì…‹ì— <strong>ë¨¸ì§€</strong></p>
  </li>
</ul>

<p>ì˜ˆì‹œ <code class="language-plaintext highlighter-rouge">config.toml</code></p>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">version</span> <span class="p">=</span> <span class="mi">1</span>

<span class="nn">[settings]</span>
<span class="py">refresh_interval_seconds</span> <span class="p">=</span> <span class="mi">30</span>  <span class="c"># (5~60) 1ë¶„ ë‚´ ë°˜ì˜ ìš”ê±´ ì¶©ì¡±</span>

<span class="c"># ëª¨ë“  í”„ë¦¬ì…‹ ê³µí†µ ê¸°ë³¸ê°’(ì„ íƒ)</span>
<span class="nn">[defaults.params]</span>
<span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.3</span>
<span class="py">max_tokens</span>  <span class="p">=</span> <span class="mi">2048</span>

<span class="nn">[defaults.http]</span>
<span class="py">timeout_seconds</span> <span class="p">=</span> <span class="mi">30</span>
<span class="nn">[defaults.http.headers]</span>
<span class="py">User-Agent</span> <span class="p">=</span> <span class="s">"ComfyUI-ConfigReader/1.0"</span>

<span class="c"># â”€â”€ í”„ë¦¬ì…‹ë“¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nn">[presets."text-model-a"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"Text Model A"</span>
<span class="py">request_name</span>  <span class="p">=</span> <span class="s">"gpt-4o-mini"</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${OPENAI_API_KEY}"</span>

<span class="nn">[presets."text-model-a".params]</span>
<span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.2</span>
<span class="py">top_p</span>       <span class="p">=</span> <span class="mf">0.9</span>

<span class="nn">[presets."text-model-a".http]</span>
<span class="py">timeout_seconds</span> <span class="p">=</span> <span class="mi">20</span>
<span class="nn">[presets."text-model-a".http.headers]</span>
<span class="py">X-Org-Id</span> <span class="p">=</span> <span class="s">"${ORG_ID}"</span>

<span class="nn">[presets."text-model-b"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"Text Model B"</span>
<span class="py">request_name</span>  <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>

<span class="c"># â”€â”€ ë‹¤ë¥¸ ì¼ë°˜ ì„¤ì • ì„¹ì…˜ë“¤ë„ ììœ ë¡­ê²Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nn">[feature_flags]</span>
<span class="py">use_cache</span> <span class="p">=</span> <span class="kc">true</span>
</code></pre></div></div>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">${ENV}</code> í‘œê¸°ëŠ” í™˜ê²½ë³€ìˆ˜ë¡œ ì¹˜í™˜ë¼.<br />
 <strong>í•˜ìœ„ í˜¸í™˜</strong> : <code class="language-plaintext highlighter-rouge">[profiles]</code>ë‚˜ <code class="language-plaintext highlighter-rouge">[endpoints]</code>ë¥¼ ì¨ë„ ìë™ ì¸ì‹(ë‚´ë¶€ì—ì„œ <code class="language-plaintext highlighter-rouge">presets</code>ë¡œ ì·¨ê¸‰).</p>
</blockquote>

<hr />

<h1 id="2-ì™¸ë¶€-ì ‘ê·¼-api-ì‹±ê¸€í†¤-í•œ-ì¤„ë¡œ-ë">2) ì™¸ë¶€ ì ‘ê·¼ API (ì‹±ê¸€í†¤, í•œ ì¤„ë¡œ ë)</h1>

<ul>
  <li>
    <p>í•¨ìˆ˜í˜•:<br />
<code class="language-plaintext highlighter-rouge">from comfyui_config_reader import preset, presets, params, http, get</code></p>
  </li>
  <li>
    <p>ê°ì²´í˜•(ì›í•˜ë©´):<br />
<code class="language-plaintext highlighter-rouge">from comfyui_config_reader import CONFIG</code> â†’ <code class="language-plaintext highlighter-rouge">CONFIG.preset("...")</code></p>
  </li>
</ul>

<h3 id="ì‚¬ìš©-ì˜ˆ">ì‚¬ìš© ì˜ˆ</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="n">preset</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">http</span><span class="p">,</span> <span class="n">get</span>

<span class="n">cfg</span> <span class="o">=</span> <span class="nf">preset</span><span class="p">(</span><span class="sh">"</span><span class="s">text-model-a</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># "í‚¤" / "display_name" / "request_name" ì•„ë¬´ê±°ë‚˜ OK
</span><span class="n">api_key</span>   <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
<span class="n">base_url</span>  <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]</span>
<span class="n">req_name</span>  <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">]</span>
<span class="n">p</span>         <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">]</span>   <span class="c1"># ëª¨ë¸ íŒŒë¼ë¯¸í„° dict
</span><span class="n">h</span>         <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">]</span>     <span class="c1"># HTTP ì˜µì…˜ dict
</span>
<span class="n">temperature</span> <span class="o">=</span> <span class="nf">params</span><span class="p">(</span><span class="sh">"</span><span class="s">text-model-a</span><span class="sh">"</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>
<span class="n">timeout</span>     <span class="o">=</span> <span class="nf">http</span><span class="p">(</span><span class="sh">"</span><span class="s">text-model-a</span><span class="sh">"</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">timeout_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>

<span class="n">region</span> <span class="o">=</span> <span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">feature_flags.use_cache</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># ë²”ìš© í‚¤ ì ‘ê·¼
</span></code></pre></div></div>

<hr />

<h1 id="3-ë“œë¡­ì¸-êµì²´-ì½”ë“œ">3) ë“œë¡­ì¸ êµì²´ ì½”ë“œ</h1>

<p>ì•„ë˜ ë‘ íŒŒì¼ë§Œ êµì²´í•˜ë©´ ëì´ì•¼.</p>

<h2 id="custom_nodescomfyui_config_reader__init__py"><code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/__init__.py</code></h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">.config_singleton</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CONFIG</span><span class="p">,</span>
    <span class="n">configure</span><span class="p">,</span>
    <span class="n">preset</span><span class="p">,</span> <span class="n">presets</span><span class="p">,</span>
    <span class="n">params</span><span class="p">,</span> <span class="n">http</span><span class="p">,</span>
    <span class="n">get</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">,</span>
    <span class="c1"># legacy alias (í•˜ìœ„ í˜¸í™˜)
</span>    <span class="n">profile</span> <span class="k">as</span> <span class="n">profile</span><span class="p">,</span> <span class="n">profiles</span> <span class="k">as</span> <span class="n">profiles</span><span class="p">,</span>
    <span class="n">endpoint</span> <span class="k">as</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">endpoints</span> <span class="k">as</span> <span class="n">endpoints</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<h2 id="custom_nodescomfyui_config_readerconfig_singletonpy"><code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/config_singleton.py</code></h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># py3.11+
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>     <span class="c1"># py3.10-
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="k">def</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="sh">""</span><span class="p">);</span> <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>  <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">v</span>

<span class="k">def</span> <span class="nf">_norm</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">b</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">b</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - ì½ê¸° ì „ìš© TOML (íŒŒì¼ ì“°ê¸° ì—†ìŒ)
    - mtime + TTL(5~60s, ê¸°ë³¸ 30s) ìë™ ì¬ë¡œë“œ â†’ 1ë¶„ ë‚´ ë³€ê²½ ë°˜ì˜
    - í‘œì¤€: [presets]; ë ˆê±°ì‹œ: [profiles], [endpoints] ìë™ ì¸ì‹
    - preset í•„ìˆ˜ í•„ë“œ: display_name, request_name, base_url, api_key
      + params(dict), http(dict: timeout_seconds, headers{}, query{})
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># --- ë‚´ë¶€ ë¡œë”© ---
</span>    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_extract_presets_table</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">presets</span><span class="sh">"</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>   <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">presets</span><span class="sh">"</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">profiles</span><span class="sh">"</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>  <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">profiles</span><span class="sh">"</span><span class="p">]</span>   <span class="c1"># legacy
</span>        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">endpoints</span><span class="sh">"</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">endpoints</span><span class="sh">"</span><span class="p">]</span>  <span class="c1"># legacy
</span>        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="c1"># defaults
</span>        <span class="n">defaults</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">defaults</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">d_params</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">d_http</span>   <span class="o">=</span> <span class="n">defaults</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">)</span>   <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d_http</span><span class="p">:</span> <span class="n">d_http</span><span class="p">[</span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">query</span><span class="sh">"</span>   <span class="ow">not</span> <span class="ow">in</span> <span class="n">d_http</span><span class="p">:</span> <span class="n">d_http</span><span class="p">[</span><span class="sh">"</span><span class="s">query</span><span class="sh">"</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{}</span>

        <span class="n">tbl</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_extract_presets_table</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">return</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
            <span class="n">req</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">req</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">p_params</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">p_http</span>   <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">)</span>   <span class="ow">or</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p_http</span><span class="p">:</span> <span class="n">p_http</span><span class="p">[</span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="sh">"</span><span class="s">query</span><span class="sh">"</span>   <span class="ow">not</span> <span class="ow">in</span> <span class="n">p_http</span><span class="p">:</span> <span class="n">p_http</span><span class="p">[</span><span class="sh">"</span><span class="s">query</span><span class="sh">"</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{}</span>

            <span class="n">merged_params</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">d_params</span><span class="p">,</span> <span class="o">**</span><span class="n">p_params</span><span class="p">}</span>
            <span class="n">merged_http</span>   <span class="o">=</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">d_http</span><span class="p">,</span> <span class="n">p_http</span><span class="p">)</span>

            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]),</span>
                <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">]),</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]),</span>
                <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span>      <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]),</span>
                <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:</span>       <span class="n">merged_params</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">:</span>         <span class="n">merged_http</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)),</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))}:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">[</span><span class="nf">_norm</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">entry</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
        <span class="n">env_r</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_r</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">env_r</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span> <span class="k">pass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="n">r</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="c1"># --- í¼ë¸”ë¦­ API ---
</span>    <span class="k">def</span> <span class="nf">preset</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">preset key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">preset not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">presets</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dn</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">dn</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="n">dn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:</span>       <span class="n">v</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span>
                <span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">:</span>         <span class="n">v</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">preset</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="k">def</span> <span class="nf">http</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">preset</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_raw</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">dotted</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">config path not found: </span><span class="si">{</span><span class="n">dotted</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cur</span>

    <span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>

<span class="c1"># ----- ì‹±ê¸€í†¤ -----
</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
<span class="n">_instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ReadOnlyConfig</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">_default_path</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">_resolve_default_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_default_path</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_PATH</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_get_instance</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span>
    <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">_instance</span>

<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">refresh_seconds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span><span class="p">,</span> <span class="n">_default_path</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">_default_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">refresh_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">refresh_seconds</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
        <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>

<span class="c1"># ---- ì™¸ë¶€ API ----
</span><span class="k">def</span> <span class="nf">preset</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>     <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">preset</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">presets</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span> <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">presets</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>     <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">params</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">http</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>       <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">http</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>                <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">snapshot</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>           <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">snapshot</span><span class="p">()</span>

<span class="c1"># ---- í•˜ìœ„ í˜¸í™˜ ë³„ì¹­ ----
</span><span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>    <span class="k">return</span> <span class="nf">preset</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">profiles</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span><span class="k">return</span> <span class="nf">presets</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>   <span class="k">return</span> <span class="nf">preset</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">endpoints</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span> <span class="k">return</span> <span class="nf">presets</span><span class="p">()</span>

<span class="c1"># ---- ê°ì²´í˜• í”„ë¡ì‹œ ----
</span><span class="k">class</span> <span class="nc">_ConfigProxy</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">_get_instance</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>
<span class="n">CONFIG</span> <span class="o">=</span> <span class="nf">_ConfigProxy</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="4-ì›í•˜ë©´-comfyui-ë…¸ë“œë„-ìš©ì–´-ë§ì¶°-ë³€ê²½">4) (ì›í•˜ë©´) ComfyUI ë…¸ë“œë„ ìš©ì–´ ë§ì¶° ë³€ê²½</h1>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">ConfigPresetLookup</code> : <code class="language-plaintext highlighter-rouge">display_name</code>, <code class="language-plaintext highlighter-rouge">request_name</code>, <code class="language-plaintext highlighter-rouge">base_url</code>, <code class="language-plaintext highlighter-rouge">api_key</code>, <code class="language-plaintext highlighter-rouge">params(json)</code>, <code class="language-plaintext highlighter-rouge">http(json)</code> ì¶œë ¥</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">ConfigListPresets</code> : ëª¨ë“  í”„ë¦¬ì…‹ JSON</p>
  </li>
</ul>

<p>ì›í•˜ì‹œë©´ ë°”ë¡œ ìƒì„±í•´ ì¤„ê²Œ.</p>

<hr />

<h1 id="5-ë§ˆì´ê·¸ë ˆì´ì…˜-ì •ë¦¬">5) ë§ˆì´ê·¸ë ˆì´ì…˜ ì •ë¦¬</h1>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">profile(s)</code> / <code class="language-plaintext highlighter-rouge">endpoint(s)</code> í˜¸ì¶œ ì½”ë“œëŠ” ê·¸ëŒ€ë¡œ ë™ì‘(ë³„ì¹­ ì œê³µ).</p>
  </li>
  <li>
    <p>ì„¤ì • íŒŒì¼ì—ì„œ <code class="language-plaintext highlighter-rouge">[profiles]</code>/<code class="language-plaintext highlighter-rouge">[endpoints]</code> ìœ ì§€í•´ë„ ì¸ì‹í•˜ì§€ë§Œ, ì•ìœ¼ë¡œëŠ” <strong><code class="language-plaintext highlighter-rouge">[presets]</code> ê¶Œì¥</strong>.</p>
  </li>
  <li>
    <p>ëª¨ë¸ íŒŒë¼ë¯¸í„°/HTTP ì˜µì…˜ì€ í”„ë¦¬ì…‹ ë‚´ë¶€(<code class="language-plaintext highlighter-rouge">params</code>/<code class="language-plaintext highlighter-rouge">http</code>)ì— ë„£ìœ¼ë©´ ë˜ê³ , ê³µí†µê°’ì€ <code class="language-plaintext highlighter-rouge">defaults</code>ì— ë‘ë©´ ìë™ ë³‘í•©ë¼.</p>
  </li>
</ul>

<hr />

<p>í•„ìš”í•˜ë©´ â€œpresetâ€ ëŒ€ì‹  <strong><code class="language-plaintext highlighter-rouge">deployment</code></strong> , <strong><code class="language-plaintext highlighter-rouge">model_preset</code></strong> ê°™ì€ ë” êµ¬ì²´ì ì¸ ëŒ€ì•ˆë„ ì¤„ ìˆ˜ ìˆì–´. í•˜ì§€ë§Œ <em>ëª¨ë¸ í˜¸ì¶œìš© ì„¸íŒ… ë¬¶ìŒ</em> ì´ë¼ëŠ” ê´€ì ì—ì„œ ì‚¬ìš©ì/ì˜¤í¼ë ˆì´í„° ëª¨ë‘ì—ê²Œ ê°€ì¥ ìµìˆ™í•˜ê³  ì§§ì€ ìš©ì–´ëŠ” â€œpresetâ€ì´ë¼ ì´ê±¸ ê¸°ë³¸ ê¶Œì¥ìœ¼ë¡œ ë’€ì–´.</p>

<p class="chat--user">

ì•„ë‹ˆ llm endpoint ë¼ëŠ” ëŠë‚Œì´ ì „í˜€ ì•ˆë“¤ì–´ì„œ

</p>

<p>ì˜¤ì¼€ì´â€”â€œLLM ì—”ë“œí¬ì¸íŠ¸â€ ëŠë‚Œì„ í™•ì‹¤íˆ ì£¼ë„ë¡ <strong>ìš©ì–´ë¥¼ <code class="language-plaintext highlighter-rouge">llm_endpoints</code></strong>ë¡œ í‘œì¤€í™”í–ˆì–´ìš”.<br />
(ì´ì „ <code class="language-plaintext highlighter-rouge">presets</code>/<code class="language-plaintext highlighter-rouge">profiles</code>/<code class="language-plaintext highlighter-rouge">endpoints</code>ëŠ” <strong>ìë™ í•˜ìœ„ í˜¸í™˜</strong> ìœ¼ë¡œ ê³„ì† ì½ìŠµë‹ˆë‹¤.)</p>

<p>ì•„ë˜ ë‘ íŒŒì¼ë§Œ êµì²´í•˜ë©´ ë! ì™¸ë¶€ì—ì„œëŠ” <code class="language-plaintext highlighter-rouge">llm_endpoint(...)</code>, <code class="language-plaintext highlighter-rouge">llm_params(...)</code> ê°™ì€ ì´ë¦„ìœ¼ë¡œ ë°”ë¡œ ì”ë‹ˆë‹¤.</p>

<hr />

<h1 id="1-ìŠ¤í‚¤ë§ˆ-configtoml">1) ìŠ¤í‚¤ë§ˆ (config.toml)</h1>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">version</span> <span class="p">=</span> <span class="mi">1</span>

<span class="nn">[settings]</span>
<span class="c"># íŒŒì¼ ë³€ê²½ ê°ì§€ ì£¼ê¸°(ì´ˆ) â€” 5~60 ê¶Œì¥. "1ë¶„ ì´ë‚´ ë°˜ì˜" ìš”ê±´ ì¶©ì¡±.</span>
<span class="py">refresh_interval_seconds</span> <span class="p">=</span> <span class="mi">30</span>

<span class="c"># ê³µí†µ ê¸°ë³¸ê°’(ì„ íƒ): ëª¨ë“  LLM ì—”ë“œí¬ì¸íŠ¸ì— ë³‘í•©ë¨</span>
<span class="nn">[defaults.params]</span>
<span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.3</span>
<span class="py">max_tokens</span>  <span class="p">=</span> <span class="mi">2048</span>

<span class="nn">[defaults.http]</span>
<span class="py">timeout_seconds</span> <span class="p">=</span> <span class="mi">30</span>
<span class="nn">[defaults.http.headers]</span>
<span class="py">User-Agent</span> <span class="p">=</span> <span class="s">"ComfyUI-ConfigReader/1.0"</span>

<span class="c"># â”€â”€ LLM ì—”ë“œí¬ì¸íŠ¸ë“¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nn">[llm_endpoints."gpt-4o-mini-a"]</span>
<span class="py">display_name</span> <span class="p">=</span> <span class="s">"OpenAI GPT-4o mini A"</span>
<span class="py">model</span>        <span class="p">=</span> <span class="s">"gpt-4o-mini"</span>             <span class="c"># (= request_name ë³„ì¹­)</span>
<span class="py">base_url</span>     <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key</span>      <span class="p">=</span> <span class="s">"${OPENAI_API_KEY}"</span>

<span class="nn">[llm_endpoints."gpt-4o-mini-a".params]</span>
<span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.2</span>
<span class="py">top_p</span>       <span class="p">=</span> <span class="mf">0.9</span>

<span class="nn">[llm_endpoints."gpt-4o-mini-a".http]</span>
<span class="py">timeout_seconds</span> <span class="p">=</span> <span class="mi">20</span>
<span class="nn">[llm_endpoints."gpt-4o-mini-a".http.headers]</span>
<span class="py">X-Org-Id</span> <span class="p">=</span> <span class="s">"${ORG_ID}"</span>

<span class="nn">[llm_endpoints."claude-sonnet"]</span>
<span class="py">display_name</span> <span class="p">=</span> <span class="s">"Anthropic Claude 3.5 Sonnet"</span>
<span class="py">model</span>        <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>     <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>      <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>

<span class="c"># â”€â”€ ë‹¤ë¥¸ ì¼ë°˜ ì„¤ì •ë„ ììœ ë¡­ê²Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nn">[feature_flags]</span>
<span class="py">use_cache</span> <span class="p">=</span> <span class="kc">true</span>
</code></pre></div></div>

<ul>
  <li>
    <p>í•„ìˆ˜: <code class="language-plaintext highlighter-rouge">display_name</code>, <code class="language-plaintext highlighter-rouge">model(=request_name)</code>, <code class="language-plaintext highlighter-rouge">base_url</code>, <code class="language-plaintext highlighter-rouge">api_key</code></p>
  </li>
  <li>
    <p>ì„ íƒ: <code class="language-plaintext highlighter-rouge">params</code>(ëª¨ë¸ íŒŒë¼ë¯¸í„°), <code class="language-plaintext highlighter-rouge">http</code>(timeout/headers/query ë“±)</p>
  </li>
  <li>
    <p><strong>ë³‘í•© ê·œì¹™</strong> : <code class="language-plaintext highlighter-rouge">defaults.params</code>/<code class="language-plaintext highlighter-rouge">defaults.http</code> â†’ ê° ì—”ë“œí¬ì¸íŠ¸ì˜ <code class="language-plaintext highlighter-rouge">params</code>/<code class="language-plaintext highlighter-rouge">http</code>ì— <strong>ë®ì–´ì“°ê¸° ë³‘í•©</strong></p>
  </li>
</ul>

<blockquote>
  <p>í•˜ìœ„ í˜¸í™˜: <code class="language-plaintext highlighter-rouge">[presets]</code>, <code class="language-plaintext highlighter-rouge">[profiles]</code>, <code class="language-plaintext highlighter-rouge">[endpoints]</code>ë„ ìë™ ì¸ì‹í•©ë‹ˆë‹¤.<br />
 í•„ë“œë„ <code class="language-plaintext highlighter-rouge">request_name</code>/<code class="language-plaintext highlighter-rouge">request_model</code>/<code class="language-plaintext highlighter-rouge">model</code> ì¤‘ ì•„ë¬´ê±°ë‚˜ ì¨ë„ OK(ë‚´ë¶€ì—ì„œ <code class="language-plaintext highlighter-rouge">model</code>ë¡œ í†µì¼).</p>
</blockquote>

<hr />

<h1 id="2-ì™¸ë¶€-ì ‘ê·¼-api-ì‹±ê¸€í†¤-ì§ê´€ì ">2) ì™¸ë¶€ ì ‘ê·¼ API (ì‹±ê¸€í†¤, ì§ê´€ì )</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">llm_endpoint</span><span class="p">,</span> <span class="n">llm_endpoints</span><span class="p">,</span>   <span class="c1"># ë©”íƒ€ + ì—°ê²° ì •ë³´
</span>    <span class="n">llm_params</span><span class="p">,</span> <span class="n">llm_http</span><span class="p">,</span>          <span class="c1"># ëª¨ë¸ íŒŒë¼ë¯¸í„° / HTTP ì˜µì…˜ë§Œ
</span>    <span class="n">get</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span>                   <span class="c1"># ë²”ìš© í‚¤ ì ‘ê·¼ / ê°ì²´í˜• ì ‘ê·¼
</span><span class="p">)</span>
</code></pre></div></div>

<p>ì‚¬ìš© ì˜ˆ:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cfg</span> <span class="o">=</span> <span class="nf">llm_endpoint</span><span class="p">(</span><span class="sh">"</span><span class="s">gpt-4o-mini-a</span><span class="sh">"</span><span class="p">)</span>     <span class="c1"># í‚¤ / display_name / model ì•„ë¬´ê±°ë‚˜
</span><span class="n">api_key</span>  <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
<span class="n">base_url</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]</span>
<span class="n">model</span>    <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">]</span>
<span class="n">params</span>   <span class="o">=</span> <span class="nf">llm_params</span><span class="p">(</span><span class="sh">"</span><span class="s">gpt-4o-mini-a</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># {"temperature": 0.2, "top_p": 0.9, ...}
</span><span class="n">http</span>     <span class="o">=</span> <span class="nf">llm_http</span><span class="p">(</span><span class="sh">"</span><span class="s">gpt-4o-mini-a</span><span class="sh">"</span><span class="p">)</span>    <span class="c1"># {"timeout_seconds": ..., "headers": {...}, ...}
</span>
<span class="c1"># ë²”ìš© ì„¤ì •
</span><span class="n">use_cache</span> <span class="o">=</span> <span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">feature_flags.use_cache</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h1 id="3-ë“œë¡­ì¸-êµì²´-ì½”ë“œ-1">3) ë“œë¡­ì¸ êµì²´ ì½”ë“œ</h1>

<h2 id="custom_nodescomfyui_config_reader__init__py-1"><code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/__init__.py</code></h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">.config_singleton</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CONFIG</span><span class="p">,</span>
    <span class="n">configure</span><span class="p">,</span>
    <span class="n">llm_endpoint</span><span class="p">,</span> <span class="n">llm_endpoints</span><span class="p">,</span>
    <span class="n">llm_params</span><span class="p">,</span> <span class="n">llm_http</span><span class="p">,</span>
    <span class="n">get</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">,</span>
    <span class="c1"># legacy alias (í•˜ìœ„ í˜¸í™˜)
</span>    <span class="n">preset</span> <span class="k">as</span> <span class="n">preset</span><span class="p">,</span> <span class="n">presets</span> <span class="k">as</span> <span class="n">presets</span><span class="p">,</span>
    <span class="n">profile</span> <span class="k">as</span> <span class="n">profile</span><span class="p">,</span> <span class="n">profiles</span> <span class="k">as</span> <span class="n">profiles</span><span class="p">,</span>
    <span class="n">endpoint</span> <span class="k">as</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">endpoints</span> <span class="k">as</span> <span class="n">endpoints</span><span class="p">,</span>
    <span class="n">params</span> <span class="k">as</span> <span class="n">params</span><span class="p">,</span> <span class="n">http</span> <span class="k">as</span> <span class="n">http</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<h2 id="custom_nodescomfyui_config_readerconfig_singletonpy-1"><code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/config_singleton.py</code></h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># py3.11+
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>     <span class="c1"># py3.10-
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="k">def</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="sh">""</span><span class="p">);</span> <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>  <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">v</span>

<span class="k">def</span> <span class="nf">_norm</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">b</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">b</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="c1"># --- í•„ë“œ ë³„ì¹­ ì •ê·œí™” (model / request_name / request_model) ---
</span><span class="k">def</span> <span class="nf">_normalize_model_field</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">and</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="sh">""</span>

<span class="k">class</span> <span class="nc">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - ì½ê¸° ì „ìš© TOML
    - mtime + TTL(5~60s, ê¸°ë³¸ 30s) ìë™ ì¬ë¡œë“œ â†’ 1ë¶„ ë‚´ ë³€ê²½ ë°˜ì˜
    - í‘œì¤€ ì„¹ì…˜: [llm_endpoints]
      (í•˜ìœ„ í˜¸í™˜: [presets], [profiles], [endpoints] ë„ ìë™ ì¸ì‹)
    - ê° ì—”ë“œí¬ì¸íŠ¸:
        * display_name, model(=request_name/â€¦ ë³„ì¹­), base_url, api_key
        * params(dict), http(dict: timeout_seconds, headers{}, query{})
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># --- ë‚´ë¶€ ë¡œë”© ---
</span>    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_extract_llm_table</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># 1ìˆœìœ„ í‘œì¤€
</span>        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">llm_endpoints</span><span class="sh">"</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">llm_endpoints</span><span class="sh">"</span><span class="p">]</span>
        <span class="c1"># í•˜ìœ„ í˜¸í™˜
</span>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">presets</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">profiles</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">endpoints</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

        <span class="c1"># defaults
</span>        <span class="n">defaults</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">defaults</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">d_params</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">d_http</span>   <span class="o">=</span> <span class="n">defaults</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">)</span>   <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d_http</span><span class="p">:</span> <span class="n">d_http</span><span class="p">[</span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">query</span><span class="sh">"</span>   <span class="ow">not</span> <span class="ow">in</span> <span class="n">d_http</span><span class="p">:</span> <span class="n">d_http</span><span class="p">[</span><span class="sh">"</span><span class="s">query</span><span class="sh">"</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{}</span>

        <span class="n">tbl</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_extract_llm_table</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">return</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>

            <span class="n">display</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="n">model</span>   <span class="o">=</span> <span class="nf">_normalize_model_field</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
            <span class="n">base</span>    <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="n">api</span>     <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">display</span> <span class="ow">and</span> <span class="n">model</span> <span class="ow">and</span> <span class="n">base</span> <span class="ow">and</span> <span class="n">api</span><span class="p">):</span>
                <span class="k">continue</span>  <span class="c1"># í•„ìˆ˜ ëˆ„ë½ì€ ìŠ¤í‚µ
</span>
            <span class="n">p_params</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">p_http</span>   <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">)</span>   <span class="ow">or</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p_http</span><span class="p">:</span> <span class="n">p_http</span><span class="p">[</span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="sh">"</span><span class="s">query</span><span class="sh">"</span>   <span class="ow">not</span> <span class="ow">in</span> <span class="n">p_http</span><span class="p">:</span> <span class="n">p_http</span><span class="p">[</span><span class="sh">"</span><span class="s">query</span><span class="sh">"</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{}</span>

            <span class="n">merged_params</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">d_params</span><span class="p">,</span> <span class="o">**</span><span class="n">p_params</span><span class="p">}</span>
            <span class="n">merged_http</span>   <span class="o">=</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">d_http</span><span class="p">,</span> <span class="n">p_http</span><span class="p">)</span>

            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">display</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span>        <span class="n">model</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="n">base</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span>      <span class="n">api</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:</span>       <span class="n">merged_params</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">:</span>         <span class="n">merged_http</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="c1"># ì ‘ê·¼ í‚¤: ì •ì˜ í‚¤ / display_name / model
</span>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">display</span><span class="p">,</span> <span class="n">model</span><span class="p">}:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">[</span><span class="nf">_norm</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">entry</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
        <span class="n">env_r</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_r</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">env_r</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span> <span class="k">pass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="n">r</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="c1"># --- í¼ë¸”ë¦­ API ---
</span>    <span class="k">def</span> <span class="nf">llm_endpoint</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">llm_endpoint key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">llm_endpoint not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">llm_endpoints</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dn</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">dn</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="n">dn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span>        <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:</span>       <span class="n">v</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span>
                <span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">:</span>         <span class="n">v</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">llm_params</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">llm_endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="k">def</span> <span class="nf">llm_http</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">llm_endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_raw</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">dotted</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">config path not found: </span><span class="si">{</span><span class="n">dotted</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cur</span>

    <span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>

<span class="c1"># ----- ì‹±ê¸€í†¤ -----
</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
<span class="n">_instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ReadOnlyConfig</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">_default_path</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">_resolve_default_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_default_path</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_PATH</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_get_instance</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span>
    <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">_instance</span>

<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">refresh_seconds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span><span class="p">,</span> <span class="n">_default_path</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">_default_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">refresh_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">refresh_seconds</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
        <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>

<span class="c1"># ---- ì™¸ë¶€ API ----
</span><span class="k">def</span> <span class="nf">llm_endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>     <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">llm_endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">llm_endpoints</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span> <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">llm_endpoints</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">llm_params</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>       <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">llm_params</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">llm_http</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>         <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">llm_http</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>                      <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">snapshot</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>                 <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">snapshot</span><span class="p">()</span>

<span class="c1"># ---- í•˜ìœ„ í˜¸í™˜ ë³„ì¹­ (í•„ìš” ì‹œ ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ ë™ì‘) ----
</span><span class="k">def</span> <span class="nf">preset</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span>   <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>         <span class="k">return</span> <span class="nf">llm_endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">presets</span><span class="p">()</span>          <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span> <span class="k">return</span> <span class="nf">llm_endpoints</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span>  <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>         <span class="k">return</span> <span class="nf">llm_endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">profiles</span><span class="p">()</span>         <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span> <span class="k">return</span> <span class="nf">llm_endpoints</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>         <span class="k">return</span> <span class="nf">llm_endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">endpoints</span><span class="p">()</span>        <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span> <span class="k">return</span> <span class="nf">llm_endpoints</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span>   <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>         <span class="k">return</span> <span class="nf">llm_params</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">http</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span>     <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>         <span class="k">return</span> <span class="nf">llm_http</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="c1"># ---- ê°ì²´í˜• í”„ë¡ì‹œ ----
</span><span class="k">class</span> <span class="nc">_ConfigProxy</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">_get_instance</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>
<span class="n">CONFIG</span> <span class="o">=</span> <span class="nf">_ConfigProxy</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="4-ì™œ-ì´ê²Œ-ì¢‹ì€ê°€-ì§§ê²Œ">4) ì™œ ì´ê²Œ ì¢‹ì€ê°€ (ì§§ê²Œ)</h1>

<ul>
  <li>
    <p>ì´ë¦„ë¶€í„° <strong>LLM ì—”ë“œí¬ì¸íŠ¸</strong> ì„ì´ ë¶„ëª… (<code class="language-plaintext highlighter-rouge">llm_endpoints</code>)</p>
  </li>
  <li>
    <p>ëª¨ë¸ íŒŒë¼ë¯¸í„°/HTTP ì˜µì…˜ì„ <strong>ê°™ì€ ë¬¶ìŒ</strong> ì—ì„œ ê´€ë¦¬ (<code class="language-plaintext highlighter-rouge">params</code>, <code class="language-plaintext highlighter-rouge">http</code>)</p>
  </li>
  <li>
    <p>ê¸°ì¡´ ì„¤ì •/ì½”ë“œ <strong>ì•ˆ ê¹¨ì§</strong>(ìë™ í˜¸í™˜)</p>
  </li>
  <li>
    <p>ì½ê¸° ì „ìš© + mtime/TTL(5~60s)ë¡œ <strong>ìµœëŒ€ 1ë¶„ ë‚´ ë³€ê²½ ë°˜ì˜</strong></p>
  </li>
  <li>
    <p>ì™¸ë¶€ ì‚¬ìš©ì€ <strong>í•œ ì¤„ ì„í¬íŠ¸</strong> ë¡œ ë: <code class="language-plaintext highlighter-rouge">llm_endpoint("...")</code></p>
  </li>
</ul>

<p>ì›í•˜ë©´ ComfyUI ë…¸ë“œ ì´ë¦„ë„ <code class="language-plaintext highlighter-rouge">Config: LLM Endpoint Lookup</code>, <code class="language-plaintext highlighter-rouge">Config: List LLM Endpoints</code>ë¡œ ë§ì¶°ì„œ ì¶œë ¥(íŒŒë¼ë¯¸í„°/HTTP JSON í¬í•¨) ë²„ì „ê¹Œì§€ ë°”ë¡œ ë§Œë“¤ì–´ì¤„ê²Œ!</p>

<p class="chat--user">

api_providers display_name, model_id, base_url, api_key ì´ê±¸ë¡œ í•´ì¤˜.

</p>

<p>ì¢‹ì•„! <strong>ì´ë¦„ì€<code class="language-plaintext highlighter-rouge">api_providers</code></strong>, í•„ë“œëŠ” <strong><code class="language-plaintext highlighter-rouge">display_name</code>, <code class="language-plaintext highlighter-rouge">model_id</code>, <code class="language-plaintext highlighter-rouge">base_url</code>, <code class="language-plaintext highlighter-rouge">api_key</code></strong>ë¡œ ë”± ë§ì¶°ì„œ ì •ë¦¬í–ˆì–´.<br />
(ì½ê¸° ì „ìš© Â· ìµœëŒ€ 1ë¶„ ë‚´ ë³€ê²½ ë°˜ì˜ Â· ë‹¤ë¥¸ ë…¸ë“œ/íŒŒì¼ì—ì„œ í•œ ì¤„ë¡œ ì ‘ê·¼)</p>

<p>ì•„ë˜ ì½”ë“œ/ì˜ˆì‹œ ê·¸ëŒ€ë¡œ êµì²´í•˜ë©´ ë™ì‘í•´.</p>

<hr />

<h1 id="1-configtoml-ìŠ¤í‚¤ë§ˆ">1) <code class="language-plaintext highlighter-rouge">config.toml</code> ìŠ¤í‚¤ë§ˆ</h1>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">version</span> <span class="p">=</span> <span class="mi">1</span>

<span class="nn">[settings]</span>
<span class="c"># íŒŒì¼ ë³€ê²½ ê°ì§€ ì£¼ê¸°(ì´ˆ) â€” 5~60 ê¶Œì¥. "1ë¶„ ì´ë‚´ ë°˜ì˜" ìš”ê±´ ì¶©ì¡±.</span>
<span class="py">refresh_interval_seconds</span> <span class="p">=</span> <span class="mi">30</span>

<span class="c"># â”€â”€ API Providers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nn">[api_providers."openai-mini"]</span>
<span class="py">display_name</span> <span class="p">=</span> <span class="s">"OpenAI GPT-4o mini"</span>
<span class="py">model_id</span>     <span class="p">=</span> <span class="s">"gpt-4o-mini"</span>
<span class="py">base_url</span>     <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key</span>      <span class="p">=</span> <span class="s">"${OPENAI_API_KEY}"</span>

<span class="nn">[api_providers."anthropic-sonnet"]</span>
<span class="py">display_name</span> <span class="p">=</span> <span class="s">"Anthropic Claude 3.5 Sonnet"</span>
<span class="py">model_id</span>     <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>     <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>      <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>

<span class="c"># â”€â”€ ë‹¤ë¥¸ ë²”ìš© ì„¤ì •ë„ ììœ ë¡­ê²Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nn">[feature_flags]</span>
<span class="py">use_cache</span> <span class="p">=</span> <span class="kc">true</span>
</code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">${ENV}</code> í‘œê¸°ëŠ” í™˜ê²½ë³€ìˆ˜ë¡œ ì¹˜í™˜.</p>
  </li>
  <li>
    <p>ì¡°íšŒ í‚¤ëŠ” <strong>ì •ì˜ í‚¤ /<code class="language-plaintext highlighter-rouge">display_name</code> / <code class="language-plaintext highlighter-rouge">model_id</code></strong> ì¤‘ ì•„ë¬´ê±°ë‚˜ ì‚¬ìš© ê°€ëŠ¥.</p>
  </li>
</ul>

<hr />

<h1 id="2-ì™¸ë¶€ì—ì„œ-ì“°ëŠ”-ë²•-ì‹±ê¸€í†¤-í•œ-ì¤„">2) ì™¸ë¶€ì—ì„œ ì“°ëŠ” ë²• (ì‹±ê¸€í†¤, í•œ ì¤„)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="n">api_provider</span><span class="p">,</span> <span class="n">api_providers</span><span class="p">,</span> <span class="n">get</span>

<span class="n">cfg</span> <span class="o">=</span> <span class="nf">api_provider</span><span class="p">(</span><span class="sh">"</span><span class="s">openai-mini</span><span class="sh">"</span><span class="p">)</span>   <span class="c1"># ë˜ëŠ” "OpenAI GPT-4o mini" / "gpt-4o-mini"
</span><span class="n">api_key</span>  <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
<span class="n">base_url</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]</span>
<span class="n">model_id</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">]</span>

<span class="n">listing</span> <span class="o">=</span> <span class="nf">api_providers</span><span class="p">()</span>           <span class="c1"># {display_name: {display_name, model_id, base_url}}
</span><span class="n">use_cache</span> <span class="o">=</span> <span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">feature_flags.use_cache</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>ì„ íƒ(ì´ˆê¸°í™” ì‹œ í•œ ë²ˆ):</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="n">configure</span>
<span class="nf">configure</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="sh">"</span><span class="s">/abs/path/to/config.toml</span><span class="sh">"</span><span class="p">,</span> <span class="n">refresh_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>  <span class="c1"># 5~60
</span></code></pre></div></div>

<hr />

<h1 id="3-ë“œë¡­ì¸-ì½”ë“œ">3) ë“œë¡­ì¸ ì½”ë“œ</h1>

<h2 id="custom_nodescomfyui_config_reader__init__py-2"><code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/__init__.py</code></h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">.config_singleton</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CONFIG</span><span class="p">,</span>
    <span class="n">configure</span><span class="p">,</span>
    <span class="n">api_provider</span><span class="p">,</span> <span class="n">api_providers</span><span class="p">,</span>
    <span class="n">get</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<h2 id="custom_nodescomfyui_config_readerconfig_singletonpy-2"><code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/config_singleton.py</code></h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># py3.11+
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>     <span class="c1"># py3.10-
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="k">def</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="sh">""</span><span class="p">);</span> <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>  <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">v</span>

<span class="k">def</span> <span class="nf">_norm</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="c1"># ë ˆê±°ì‹œ í•„ë“œ í˜¸í™˜: model_id ëŒ€ì‹  model/request_name/request_model ì´ ë“¤ì–´ì™€ë„ ì¸ì‹
</span><span class="k">def</span> <span class="nf">_normalize_model_id</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">and</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="sh">""</span>

<span class="k">class</span> <span class="nc">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - ì½ê¸° ì „ìš© TOML ë¡œë” (íŒŒì¼ ì“°ê¸° ì—†ìŒ)
    - mtime + TTL(5~60s, ê¸°ë³¸ 30s) ìë™ ì¬ë¡œë“œ â†’ 1ë¶„ ë‚´ ë³€ê²½ ë°˜ì˜
    - í‘œì¤€ ì„¹ì…˜: [api_providers]
      (ì°¸ê³ : ì›í•˜ë©´ í•˜ìœ„ í˜¸í™˜ ì„¹ì…˜ì„ ì¶”ê°€ë¡œ ì¸ì‹í•˜ë„ë¡ í™•ì¥ ê°€ëŠ¥)
    - ê° provider í•„ìˆ˜ í•„ë“œ: display_name, model_id, base_url, api_key
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># --- ë‚´ë¶€ ë¡œë”© ---
</span>    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_providers_table</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_providers</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tbl</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_providers_table</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">return</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>

            <span class="n">display</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="n">model</span>   <span class="o">=</span> <span class="nf">_normalize_model_id</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
            <span class="n">base</span>    <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="n">api</span>     <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">display</span> <span class="ow">and</span> <span class="n">model</span> <span class="ow">and</span> <span class="n">base</span> <span class="ow">and</span> <span class="n">api</span><span class="p">):</span>
                <span class="k">continue</span>  <span class="c1"># í•„ìˆ˜ ëˆ„ë½ì€ ìŠ¤í‚µ
</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">display</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">:</span>     <span class="n">model</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="n">base</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span>      <span class="n">api</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># ì ‘ê·¼ í‚¤: ì •ì˜ í‚¤ / display_name / model_id
</span>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">display</span><span class="p">,</span> <span class="n">model</span><span class="p">}:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">[</span><span class="nf">_norm</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">entry</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
        <span class="n">env_r</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_r</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">env_r</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span> <span class="k">pass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="n">r</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="c1"># --- í¼ë¸”ë¦­ API ---
</span>    <span class="k">def</span> <span class="nf">api_provider</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">api_provider key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">api_provider not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">api_providers</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="sh">"""</span><span class="s">API KeyëŠ” ëª©ë¡ì—ì„  ìˆ¨ê¹€.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dn</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">dn</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="n">dn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">:</span>     <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_raw</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">dotted</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">config path not found: </span><span class="si">{</span><span class="n">dotted</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cur</span>

    <span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>

<span class="c1"># ----- ì‹±ê¸€í†¤ -----
</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
<span class="n">_instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ReadOnlyConfig</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">_default_path</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">_resolve_default_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_default_path</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_PATH</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_get_instance</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span>
    <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">_instance</span>

<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">refresh_seconds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span><span class="p">,</span> <span class="n">_default_path</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">_default_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">refresh_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">refresh_seconds</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
        <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>

<span class="c1"># ---- ì™¸ë¶€ API ----
</span><span class="k">def</span> <span class="nf">api_provider</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>         <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">api_provider</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">api_providers</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>     <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">api_providers</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>                          <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">snapshot</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>                     <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">snapshot</span><span class="p">()</span>

<span class="c1"># ---- ê°ì²´í˜• í”„ë¡ì‹œ ----
</span><span class="k">class</span> <span class="nc">_ConfigProxy</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">_get_instance</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>
<span class="n">CONFIG</span> <span class="o">=</span> <span class="nf">_ConfigProxy</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="4-ì„ íƒ-comfyui-ë…¸ë“œë„-ìš©ì–´-ë§ì¶°-ì œê³µ">4) (ì„ íƒ) ComfyUI ë…¸ë“œë„ ìš©ì–´ ë§ì¶° ì œê³µ</h1>

<p>ì›í•œë‹¤ë©´ <code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/config_nodes.py</code>ì— ì•„ë˜ì²˜ëŸ¼:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">.config_singleton</span> <span class="kn">import</span> <span class="n">api_provider</span><span class="p">,</span> <span class="n">api_providers</span>
<span class="kn">import</span> <span class="n">json</span>

<span class="k">class</span> <span class="nc">ConfigAPIProviderLookup</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">})}}</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">lookup</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Config/API Providers (ReadOnly)</span><span class="sh">"</span>
    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nf">api_provider</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">ConfigListAPIProviders</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">providers_json</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">list_providers</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Config/API Providers (ReadOnly)</span><span class="sh">"</span>
    <span class="k">def</span> <span class="nf">list_providers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="nf">api_providers</span><span class="p">(),</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),)</span>

<span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">ConfigAPIProviderLookup</span><span class="sh">"</span><span class="p">:</span> <span class="n">ConfigAPIProviderLookup</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigListAPIProviders</span><span class="sh">"</span><span class="p">:</span>  <span class="n">ConfigListAPIProviders</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">ConfigAPIProviderLookup</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Config: API Provider Lookup</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigListAPIProviders</span><span class="sh">"</span><span class="p">:</span>  <span class="sh">"</span><span class="s">Config: List API Providers</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h1 id="5-ì²´í¬ë¦¬ìŠ¤íŠ¸">5) ì²´í¬ë¦¬ìŠ¤íŠ¸</h1>

<ul>
  <li>
    <p>âœ… ì„¹ì…˜/í•„ë“œëª…: <strong><code class="language-plaintext highlighter-rouge">api_providers</code> / (display_name, model_id, base_url, api_key)</strong></p>
  </li>
  <li>
    <p>âœ… ì½ê¸° ì „ìš© + íŒŒì¼ ë³€ê²½ <strong>ìµœëŒ€ 1ë¶„ ë‚´ ë°˜ì˜</strong> (mtime + TTL 5~60, ê¸°ë³¸ 30)</p>
  </li>
  <li>
    <p>âœ… ì–´ë””ì„œë“  ê°„ë‹¨ ì ‘ê·¼: <code class="language-plaintext highlighter-rouge">api_provider("í‚¤|í‘œì‹œëª…|model_id")</code></p>
  </li>
  <li>
    <p>âœ… ì‚¬ëŒì´ í¸ì§‘ ì‰¬ìš´ TOML + <code class="language-plaintext highlighter-rouge">${ENV}</code> ì¹˜í™˜</p>
  </li>
  <li>
    <p>âœ… ëª©ë¡ ë…¸ë“œëŠ” <strong>api_key ë¹„ë…¸ì¶œ</strong></p>
  </li>
</ul>

<p>í•„ìš”í•˜ë©´, ê¸°ì¡´ ì›Œí¬í”Œë¡œìš°(ë…¸ë“œ ê·¸ë˜í”„)ì—ì„œ ìë™ìœ¼ë¡œ ì´ ì´ë¦„ë“¤ë¡œ ë°”ê¿”ì£¼ëŠ” ìŠ¤í¬ë¦½íŠ¸ë„ ë§Œë“¤ì–´ì¤„ê²Œ.</p>

<p class="chat--user">

ì•„ paramsë„ í¬í•¨í•´ì¤˜. ê·¸ëŸ°ë° [api_providers."anthropic-sonnet"] ì´ ì•ˆì— parametersë¥¼ dictionaryë¡œ ë„£ì„ ìˆ˜ ì—†ë‚˜? ë”°ë¡œ í•­ëª©ì„ ë¹¼ë‹ˆê¹Œ ë³´ê¸°ê°€ ë¶ˆí¸í•œë° ì´ëŸ°ê±´ yamlì—ì„œë§Œ ê°€ëŠ¥?

</p>

<p>ì¢‹ì•„, <strong>TOMLì—ì„œë„ ë”•ì…”ë„ˆë¦¬(ë§µ)ë¥¼ í•œ ì„¹ì…˜ ì•ˆì—</strong> ë„£ì„ ìˆ˜ ìˆì–´.<br />
YAMLë§Œ ë˜ëŠ” ê²Œ ì•„ë‹ˆê³ , TOMLì€ ë‘ ê°€ì§€ ë°©ë²•ì„ ì§€ì›í•´:</p>

<ol>
  <li>
    <p><strong>ì¸ë¼ì¸ í…Œì´ë¸”</strong> : í•œ ì¤„ <code class="language-plaintext highlighter-rouge">{ ... }</code> ë¡œ ë”•ì…”ë„ˆë¦¬ ê°’ì„ ë„£ê¸°</p>
  </li>
  <li>
    <p><strong>ì  í‘œê¸°(dotted keys)</strong> : <code class="language-plaintext highlighter-rouge">parameters.temperature = 0.7</code> ì²˜ëŸ¼ ê°™ì€ ì„¹ì…˜ ì•ˆì—ì„œ í‚¤ë¥¼ ì ìœ¼ë¡œ ì´ì–´ ì“°ê¸°</p>
  </li>
</ol>

<p>ì•„ë˜ì— ë‘˜ ë‹¤ ì˜ˆì‹œ + ì½”ë“œë¥¼ ì‹±ê¸€í†¤ APIì— ë°˜ì˜í•´ì¤„ê²Œ. <code class="language-plaintext highlighter-rouge">api_providers</code> í•­ëª© ì•ˆì— <code class="language-plaintext highlighter-rouge">parameters</code>ë¥¼ ê·¸ëŒ€ë¡œ ë„£ê³ , ê¸°ë³¸ê°’ ë³‘í•©ë„ ì§€ì›í•´.</p>

<hr />

<h1 id="1-toml-ì‘ì„±ë²•-step-by-step">1) TOML ì‘ì„±ë²• (step-by-step)</h1>

<h2 id="a-ì¸ë¼ì¸-í…Œì´ë¸”ê¹”ë”-í•œ-ì¤„">A. ì¸ë¼ì¸ í…Œì´ë¸”(ê¹”ë”, í•œ ì¤„)</h2>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[api_providers."anthropic-sonnet"]</span>
<span class="py">display_name</span> <span class="p">=</span> <span class="s">"Anthropic Claude 3.5 Sonnet"</span>
<span class="py">model_id</span>     <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>     <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>      <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>
<span class="py">parameters</span>   <span class="o">=</span> <span class="p">{</span> <span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="py">top_p</span> <span class="p">=</span> <span class="mf">0.9</span><span class="p">,</span> <span class="py">stop</span> <span class="p">=</span> <span class="p">[</span><span class="s">"</span><span class="se">\n\n</span><span class="s">Human:"</span><span class="p">,</span> <span class="s">"</span><span class="se">\n\n</span><span class="s">Assistant:"</span><span class="p">]</span> <span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>ì¥ì : í•œëˆˆì— ë³´ê¸° ì¢‹ìŒ.</p>
  </li>
  <li>
    <p>ìœ ì˜: <strong>TOML 1.0 ìŠ¤í™ìƒ ì¸ë¼ì¸ í…Œì´ë¸”ì€ í•œ ì¤„</strong> ì´ì–´ì•¼ í•´. (ì¤„ë°”ê¿ˆ/ì£¼ì„ ë„£ê¸° ì–´ë ¤ì›€)</p>
  </li>
</ul>

<h2 id="b-ì -í‘œê¸°dotted-keys-ê°™ì€-ì„¹ì…˜-ë‚´ë¶€-ë‹¤ì¤„">B. ì  í‘œê¸°(dotted keys, ê°™ì€ ì„¹ì…˜ ë‚´ë¶€ ë‹¤ì¤„)</h2>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[api_providers."anthropic-sonnet"]</span>
<span class="py">display_name</span> <span class="p">=</span> <span class="s">"Anthropic Claude 3.5 Sonnet"</span>
<span class="py">model_id</span>     <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>     <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>      <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>
<span class="py">parameters.temperature</span> <span class="p">=</span> <span class="mf">0.2</span>
<span class="py">parameters.top_p</span>       <span class="p">=</span> <span class="mf">0.9</span>
<span class="py">parameters.stop</span>        <span class="p">=</span> <span class="p">[</span><span class="s">"</span><span class="se">\n\n</span><span class="s">Human:"</span><span class="p">,</span> <span class="s">"</span><span class="se">\n\n</span><span class="s">Assistant:"</span><span class="p">]</span>  <span class="c"># â† ì£¼ì„ OK</span>
</code></pre></div></div>

<ul>
  <li>
    <p>ì¥ì : ì—¬ëŸ¬ ì¤„ë¡œ ì½ê¸° í¸í•˜ê³  <strong>ì£¼ì„ ê°€ëŠ¥</strong>.</p>
  </li>
  <li>
    <p>ë‚´ë¶€ì ìœ¼ë¡œëŠ” ë”•ì…”ë„ˆë¦¬ë¡œ íŒŒì‹±ë¨. (YAML í•„ìš” ì—†ìŒ)</p>
  </li>
</ul>

<h2 id="ì„ íƒ-ê³µí†µ-ê¸°ë³¸ê°’-ë³‘í•©">(ì„ íƒ) ê³µí†µ ê¸°ë³¸ê°’ ë³‘í•©</h2>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[defaults.parameters]</span>
<span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.3</span>
<span class="py">max_tokens</span>  <span class="p">=</span> <span class="mi">2048</span>
</code></pre></div></div>

<ul>
  <li>ê° providerì˜ <code class="language-plaintext highlighter-rouge">parameters</code> ìœ„ì— <strong>ë®ì–´ì“°ê¸° ë³‘í•©</strong> ë¼ì„œ ìµœì¢…ê°’ì´ ë§Œë“¤ì–´ì ¸.</li>
</ul>

<hr />

<h1 id="2-ì „ì²´-ì˜ˆì‹œ-configtoml">2) ì „ì²´ ì˜ˆì‹œ <code class="language-plaintext highlighter-rouge">config.toml</code></h1>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">version</span> <span class="p">=</span> <span class="mi">1</span>

<span class="nn">[settings]</span>
<span class="py">refresh_interval_seconds</span> <span class="p">=</span> <span class="mi">30</span>  <span class="c"># 5~60(ìš”êµ¬: 1ë¶„ ë‚´ ë°˜ì˜)</span>

<span class="nn">[defaults.parameters]</span>
<span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.3</span>
<span class="py">max_tokens</span>  <span class="p">=</span> <span class="mi">2048</span>

<span class="c"># â”€â”€ OpenAI (ì¸ë¼ì¸ í…Œì´ë¸”) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nn">[api_providers."openai-mini"]</span>
<span class="py">display_name</span> <span class="p">=</span> <span class="s">"OpenAI GPT-4o mini"</span>
<span class="py">model_id</span>     <span class="p">=</span> <span class="s">"gpt-4o-mini"</span>
<span class="py">base_url</span>     <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key</span>      <span class="p">=</span> <span class="s">"${OPENAI_API_KEY}"</span>
<span class="py">parameters</span>   <span class="o">=</span> <span class="p">{</span> <span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.25</span><span class="p">,</span> <span class="py">top_p</span> <span class="p">=</span> <span class="mf">0.95</span> <span class="p">}</span>

<span class="c"># â”€â”€ Anthropic (ì  í‘œê¸°) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nn">[api_providers."anthropic-sonnet"]</span>
<span class="py">display_name</span> <span class="p">=</span> <span class="s">"Anthropic Claude 3.5 Sonnet"</span>
<span class="py">model_id</span>     <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>     <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>      <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>
<span class="py">parameters.temperature</span> <span class="p">=</span> <span class="mf">0.2</span>
<span class="py">parameters.top_p</span>       <span class="p">=</span> <span class="mf">0.9</span>
<span class="py">parameters.stop</span>        <span class="p">=</span> <span class="p">[</span><span class="s">"</span><span class="se">\n\n</span><span class="s">Human:"</span><span class="p">,</span> <span class="s">"</span><span class="se">\n\n</span><span class="s">Assistant:"</span><span class="p">]</span>
</code></pre></div></div>

<hr />

<h1 id="3-ì™¸ë¶€-ì‚¬ìš©-ë°©ë²•-ê·¸ëŒ€ë¡œ--parameters-ì§€ì›">3) ì™¸ë¶€ ì‚¬ìš© ë°©ë²• (ê·¸ëŒ€ë¡œ, + <code class="language-plaintext highlighter-rouge">parameters</code> ì§€ì›)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="n">api_provider</span><span class="p">,</span> <span class="n">api_providers</span><span class="p">,</span> <span class="n">api_parameters</span><span class="p">,</span> <span class="n">get</span>

<span class="n">cfg</span> <span class="o">=</span> <span class="nf">api_provider</span><span class="p">(</span><span class="sh">"</span><span class="s">anthropic-sonnet</span><span class="sh">"</span><span class="p">)</span>   <span class="c1"># í‚¤ / display_name / model_id ì•„ë¬´ê±°ë‚˜
</span><span class="nf">print</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">],</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">])</span>
<span class="nf">print</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">])</span>                  <span class="c1"># â† ìµœì¢… ë³‘í•©ëœ dict
</span>
<span class="c1"># íŒŒë¼ë¯¸í„°ë§Œ ë°”ë¡œ
</span><span class="n">params</span> <span class="o">=</span> <span class="nf">api_parameters</span><span class="p">(</span><span class="sh">"</span><span class="s">openai-mini</span><span class="sh">"</span><span class="p">)</span>    <span class="c1"># {"temperature": 0.25, "top_p": 0.95, "max_tokens": 2048}
</span><span class="n">use_cache</span> <span class="o">=</span> <span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">feature_flags.use_cache</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h1 id="4-ë“œë¡­ì¸-êµì²´-ì½”ë“œ">4) ë“œë¡­ì¸ êµì²´ ì½”ë“œ</h1>

<h2 id="custom_nodescomfyui_config_reader__init__py-3"><code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/__init__.py</code></h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">.config_singleton</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CONFIG</span><span class="p">,</span>
    <span class="n">configure</span><span class="p">,</span>
    <span class="n">api_provider</span><span class="p">,</span> <span class="n">api_providers</span><span class="p">,</span>
    <span class="n">api_parameters</span><span class="p">,</span>                  <span class="c1"># â† ì¶”ê°€
</span>    <span class="n">get</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<h2 id="custom_nodescomfyui_config_readerconfig_singletonpy-3"><code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/config_singleton.py</code></h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># py3.11+
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>     <span class="c1"># py3.10-
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="k">def</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="sh">""</span><span class="p">);</span> <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>  <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">v</span>

<span class="k">def</span> <span class="nf">_norm</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_normalize_model_id</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">and</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">b</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">b</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - ì½ê¸° ì „ìš© TOML
    - mtime + TTL(5~60s, ê¸°ë³¸ 30s) ìë™ ì¬ë¡œë“œ â†’ 1ë¶„ ë‚´ ë³€ê²½ ë°˜ì˜
    - í‘œì¤€ ì„¹ì…˜: [api_providers]
    - ê° provider í•„ìˆ˜: display_name, model_id, base_url, api_key
      + ì„ íƒ: parameters(dict)  # ì¸ë¼ì¸ í…Œì´ë¸” ë˜ëŠ” dotted keys ëª¨ë‘ ì§€ì›
    - [defaults.parameters] ë³‘í•© ì§€ì›(ê°œë³„ provider.parametersê°€ ìš°ì„ )
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># --- ë‚´ë¶€ ë¡œë”© ---
</span>    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_providers_table</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_providers</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tbl</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

        <span class="c1"># defaults.parameters (alias: defaults.paramsë„ ì§€ì›)
</span>        <span class="n">defaults</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">defaults</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">d_params</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">defaults</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="n">tbl</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_providers_table</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">return</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>

            <span class="n">display</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="n">model</span>   <span class="o">=</span> <span class="nf">_normalize_model_id</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
            <span class="n">base</span>    <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="n">api</span>     <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">display</span> <span class="ow">and</span> <span class="n">model</span> <span class="ow">and</span> <span class="n">base</span> <span class="ow">and</span> <span class="n">api</span><span class="p">):</span>
                <span class="k">continue</span>  <span class="c1"># í•„ìˆ˜ ëˆ„ë½ ìŠ¤í‚µ
</span>
            <span class="c1"># provider.parameters (alias: params) ì¶”ì¶œ + defaults ë³‘í•©
</span>            <span class="n">p_params</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p_params</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">p_params</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># ê³¼ê±° ëª…ì¹­ í˜¸í™˜
</span>            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">p_params</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">merged_params</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">d_params</span><span class="p">,</span> <span class="o">**</span><span class="n">p_params</span><span class="p">}</span>

            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">display</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">:</span>     <span class="n">model</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="n">base</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span>      <span class="n">api</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span>   <span class="n">merged_params</span><span class="p">,</span>  <span class="c1"># â† í¬í•¨
</span>            <span class="p">}</span>

            <span class="c1"># ì ‘ê·¼ í‚¤: ì •ì˜ í‚¤ / display_name / model_id
</span>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">display</span><span class="p">,</span> <span class="n">model</span><span class="p">}:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">[</span><span class="nf">_norm</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">entry</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
        <span class="n">env_r</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_r</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">env_r</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span> <span class="k">pass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="n">r</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="c1"># --- í¼ë¸”ë¦­ API ---
</span>    <span class="k">def</span> <span class="nf">api_provider</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">api_provider key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">api_provider not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">api_providers</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sh">"""</span><span class="s">ëª©ë¡ì—ì„œëŠ” api_key ìˆ¨ê¹€, parametersëŠ” ë…¸ì¶œ.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dn</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">dn</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="n">dn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">:</span>     <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span>   <span class="n">v</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">api_parameters</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">api_provider</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_raw</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">dotted</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">config path not found: </span><span class="si">{</span><span class="n">dotted</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cur</span>

    <span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>

<span class="c1"># ----- ì‹±ê¸€í†¤ -----
</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
<span class="n">_instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ReadOnlyConfig</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">_default_path</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">_resolve_default_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_default_path</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_PATH</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_get_instance</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span>
    <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">_instance</span>

<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">refresh_seconds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span><span class="p">,</span> <span class="n">_default_path</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">_default_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">refresh_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">refresh_seconds</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
        <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>

<span class="c1"># ---- ì™¸ë¶€ API ----
</span><span class="k">def</span> <span class="nf">api_provider</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>         <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">api_provider</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">api_providers</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>     <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">api_providers</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">api_parameters</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>       <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">api_parameters</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>                          <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">snapshot</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>                     <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">snapshot</span><span class="p">()</span>

<span class="c1"># ---- ê°ì²´í˜• í”„ë¡ì‹œ ----
</span><span class="k">class</span> <span class="nc">_ConfigProxy</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">_get_instance</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>
<span class="n">CONFIG</span> <span class="o">=</span> <span class="nf">_ConfigProxy</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="5-ì •ë¦¬">5) ì •ë¦¬</h1>

<ul>
  <li>
    <p>âœ… <strong>TOMLì—ì„œë„ ë”•ì…”ë„ˆë¦¬ ê°€ëŠ¥</strong> : ì¸ë¼ì¸ í…Œì´ë¸” <code class="language-plaintext highlighter-rouge">{...}</code> ë˜ëŠ” ì  í‘œê¸° <code class="language-plaintext highlighter-rouge">parameters.foo =</code></p>
  </li>
  <li>
    <p>âœ… <code class="language-plaintext highlighter-rouge">api_providers</code> ê° í•­ëª©ì— <strong><code class="language-plaintext highlighter-rouge">parameters</code> í¬í•¨</strong> ì§€ì› (ì¸ë¼ì¸/ì í‘œê¸° ëª¨ë‘ OK)</p>
  </li>
  <li>
    <p>âœ… <code class="language-plaintext highlighter-rouge">defaults.parameters</code>ë¡œ ê³µí†µê°’ ë³‘í•©</p>
  </li>
  <li>
    <p>âœ… ì™¸ë¶€ ì ‘ê·¼: <code class="language-plaintext highlighter-rouge">api_provider("í‚¤")["parameters"]</code> ë˜ëŠ” <code class="language-plaintext highlighter-rouge">api_parameters("í‚¤")</code></p>
  </li>
  <li>
    <p>âœ… ì½ê¸° ì „ìš© + íŒŒì¼ ë³€ê²½ <strong>ìµœëŒ€ 1ë¶„ ë‚´ ë°˜ì˜</strong></p>
  </li>
</ul>

<p>ì›í•˜ë©´ <code class="language-plaintext highlighter-rouge">parameters</code> ì™¸ì— <code class="language-plaintext highlighter-rouge">http</code> ê°™ì€ ì„¹ì…˜ë„ ê°™ì€ ë°©ì‹ìœ¼ë¡œ ë¶™ì—¬ì„œ ë³‘í•© ì§€ì›í•´ì¤„ ìˆ˜ ìˆì–´!</p>

<p class="chat--user">

Pydantic ì´ìš©í•´ì„œ api provider í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ê³  ì´ê±¸ ë¦¬ìŠ¤íŠ¸ë¡œ ë¦¬í„´í•˜ëŠ” í•¨ìˆ˜ê°€ ìˆìœ¼ë©´ ì¢‹ê² ì–´. ë¦¬ìŠ¤íŠ¸ëŠ” api_provider_id ë¥¼ ì‚¬ìš©í•´ì„œ ì •ë ¬ëœ ìƒíƒœë¡œ ë¦¬í„´í•˜ê³  ì‹¶ì–´. ì˜ˆì‹œì—ì„œ "anthropic-sonnet" ì´ê±¸ idë¡œ í• ê±°ì•¼.

</p>

<p>ì¢‹ë‹¤â€”<strong>Pydantic ëª¨ë¸</strong> ë¡œ <code class="language-plaintext highlighter-rouge">ApiProvider</code> í´ë˜ìŠ¤ë¥¼ ì •ì˜í•˜ê³ , ì´ë¥¼ <strong><code class="language-plaintext highlighter-rouge">api_provider_id</code>(ì˜ˆ: <code class="language-plaintext highlighter-rouge">"anthropic-sonnet"</code>)ë¡œ ì •ë ¬</strong>í•´ì„œ ë¦¬í„´í•˜ëŠ” í•¨ìˆ˜ê¹Œì§€ ê¹”ë”í•˜ê²Œ ë¶™ì˜€ì–´.<br />
ê¸°ì¡´ ì‹±ê¸€í†¤/<code class="language-plaintext highlighter-rouge">api_providers</code> ìŠ¤í‚¤ë§ˆì™€ 100% í˜¸í™˜ë˜ë©°, <code class="language-plaintext highlighter-rouge">parameters</code>(dict)ë„ ë™ì¼í•˜ê²Œ ì§€ì›/ë³‘í•©ë¼.</p>

<p>ì•„ë˜ 3ê°œë§Œ ë„£ìœ¼ë©´ ë:</p>

<hr />

<h1 id="1-configtoml-ì˜ˆì‹œ">1) <code class="language-plaintext highlighter-rouge">config.toml</code> (ì˜ˆì‹œ)</h1>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">version</span> <span class="p">=</span> <span class="mi">1</span>

<span class="nn">[settings]</span>
<span class="py">refresh_interval_seconds</span> <span class="p">=</span> <span class="mi">30</span>

<span class="nn">[defaults.parameters]</span>
<span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.3</span>
<span class="py">max_tokens</span>  <span class="p">=</span> <span class="mi">2048</span>

<span class="nn">[api_providers."openai-mini"]</span>
<span class="py">display_name</span> <span class="p">=</span> <span class="s">"OpenAI GPT-4o mini"</span>
<span class="py">model_id</span>     <span class="p">=</span> <span class="s">"gpt-4o-mini"</span>
<span class="py">base_url</span>     <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key</span>      <span class="p">=</span> <span class="s">"${OPENAI_API_KEY}"</span>
<span class="py">parameters</span>   <span class="o">=</span> <span class="p">{</span> <span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.25</span><span class="p">,</span> <span class="py">top_p</span> <span class="p">=</span> <span class="mf">0.95</span> <span class="p">}</span>

<span class="nn">[api_providers."anthropic-sonnet"]</span>
<span class="py">display_name</span> <span class="p">=</span> <span class="s">"Anthropic Claude 3.5 Sonnet"</span>
<span class="py">model_id</span>     <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>     <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>      <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>
<span class="c"># TOML dotted-keysë¡œ dict ì±„ìš°ê¸°</span>
<span class="py">parameters.temperature</span> <span class="p">=</span> <span class="mf">0.2</span>
<span class="py">parameters.top_p</span>       <span class="p">=</span> <span class="mf">0.9</span>
<span class="py">parameters.stop</span>        <span class="p">=</span> <span class="p">[</span><span class="s">"</span><span class="se">\n\n</span><span class="s">Human:"</span><span class="p">,</span> <span class="s">"</span><span class="se">\n\n</span><span class="s">Assistant:"</span><span class="p">]</span>
</code></pre></div></div>

<hr />

<h1 id="2-custom_nodescomfyui_config_readermodelspy">2) <code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/models.py</code></h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="k">class</span> <span class="nc">ApiProvider</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    ë‹¨ì¼ API Provider ì—”íŠ¸ë¦¬ (ì •ë ¬ í‚¤: api_provider_id)
    </span><span class="sh">"""</span>
    <span class="n">api_provider_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">'</span><span class="s">ì˜ˆ: </span><span class="sh">"</span><span class="s">anthropic-sonnet</span><span class="sh">"'</span><span class="p">)</span>
    <span class="n">display_name</span><span class="p">:</span>   <span class="nb">str</span>
    <span class="n">model_id</span><span class="p">:</span>       <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span>       <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span>        <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span>     <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h1 id="3-custom_nodescomfyui_config_readerconfig_singletonpy-ë“œë¡­ì¸-êµì²´ë³¸">3) <code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/config_singleton.py</code> (ë“œë¡­ì¸ êµì²´ë³¸)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># py3.11+
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>     <span class="c1"># py3.10-
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="kn">from</span> <span class="n">.models</span> <span class="kn">import</span> <span class="n">ApiProvider</span>  <span class="c1"># â† Pydantic ëª¨ë¸
</span>
<span class="k">def</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="sh">""</span><span class="p">);</span> <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>  <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">v</span>

<span class="k">def</span> <span class="nf">_norm</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_normalize_model_id</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">and</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">b</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">b</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - ì½ê¸° ì „ìš© TOML
    - mtime + TTL(5~60s, ê¸°ë³¸ 30s) ìë™ ì¬ë¡œë“œ â†’ 1ë¶„ ë‚´ ë³€ê²½ ë°˜ì˜
    - í‘œì¤€ ì„¹ì…˜: [api_providers]
    - ê° provider í•„ìˆ˜: display_name, model_id, base_url, api_key
      + ì„ íƒ: parameters(dict)  â€” ì¸ë¼ì¸ í…Œì´ë¸”/ì  í‘œê¸° ëª¨ë‘ ì§€ì›
    - [defaults.parameters] ë³‘í•© ì§€ì› (provider.parametersê°€ ìš°ì„ )
    - Pydantic ëª¨ë¸(ApiProvider) ë³€í™˜/ì •ë ¬ ì§€ì›
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># í‚¤(ì¡°íšŒ ì‹ë³„ì: id/display_name/model_id) â†’ provider entry
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># ê³ ìœ  id â†’ provider entry (ì¤‘ë³µ ì œê±°/ì •ë ¬ ìš©)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_by_id</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># --- ë‚´ë¶€ ë¡œë”© ---
</span>    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_providers_table</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_providers</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tbl</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_by_id</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

        <span class="c1"># defaults.parameters (alias: defaults.params)
</span>        <span class="n">defaults</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">defaults</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">d_params</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">defaults</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="n">tbl</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_providers_table</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">return</span>

        <span class="k">for</span> <span class="n">provider_id</span><span class="p">,</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>

            <span class="n">display</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="n">model</span>   <span class="o">=</span> <span class="nf">_normalize_model_id</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
            <span class="n">base</span>    <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="n">api</span>     <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">display</span> <span class="ow">and</span> <span class="n">model</span> <span class="ow">and</span> <span class="n">base</span> <span class="ow">and</span> <span class="n">api</span><span class="p">):</span>
                <span class="k">continue</span>  <span class="c1"># í•„ìˆ˜ ëˆ„ë½ ìŠ¤í‚µ
</span>
            <span class="c1"># provider.parameters (alias: params) + defaults ë³‘í•©
</span>            <span class="n">p_params</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p_params</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">p_params</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">p_params</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">merged_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">d_params</span><span class="p">,</span> <span class="o">**</span><span class="n">p_params</span><span class="p">}</span>

            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">api_provider_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">provider_id</span><span class="p">),</span>   <span class="c1"># â† ì›ë³¸ TOML í‚¤
</span>                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span>    <span class="n">display</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">:</span>        <span class="n">model</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>        <span class="n">base</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span>         <span class="n">api</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span>      <span class="n">merged_parameters</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># ê³ ìœ  id ì‚¬ì „
</span>            <span class="n">self</span><span class="p">.</span><span class="n">_by_id</span><span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="n">provider_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">entry</span>
            <span class="c1"># ì¡°íšŒ ì¸ë±ìŠ¤(ì—¬ëŸ¬ í‚¤ë¡œ ì ‘ê·¼ ê°€ëŠ¥: id / display_name / model_id)
</span>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">provider_id</span><span class="p">),</span> <span class="n">display</span><span class="p">,</span> <span class="n">model</span><span class="p">}:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">[</span><span class="nf">_norm</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">entry</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
        <span class="n">env_r</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_r</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">env_r</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span> <span class="k">pass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="n">r</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="c1"># --- í¼ë¸”ë¦­ í‚¤-ê°’ API ---
</span>    <span class="k">def</span> <span class="nf">api_provider</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">api_provider key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">api_provider not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">api_providers</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sh">"""</span><span class="s">ëª©ë¡(ìš”ì•½): api_keyëŠ” ìˆ¨ê¸°ê³  parametersëŠ” ë…¸ì¶œ.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_by_id</span><span class="p">.</span><span class="nf">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">kv</span><span class="p">:</span> <span class="n">kv</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">out</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">:</span>     <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span>   <span class="n">v</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="c1"># --- Pydantic ëª¨ë¸ API ---
</span>    <span class="k">def</span> <span class="nf">api_provider_models</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ApiProvider</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">ApiProvider ë¦¬ìŠ¤íŠ¸(ì •ë ¬: api_provider_id). api_key í¬í•¨ â€” ë¡œê¹… ìœ ì˜!</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">models</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ApiProvider</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nc">ApiProvider</span><span class="p">(</span><span class="o">**</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_by_id</span><span class="p">.</span><span class="nf">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">kv</span><span class="p">:</span> <span class="n">kv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">models</span>

    <span class="k">def</span> <span class="nf">api_provider_model</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">api_provider_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ApiProvider</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_by_id</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">api_provider_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">:</span>
            <span class="c1"># ë‹¤ë¥¸ í‚¤ë¡œ ë“¤ì–´ì™”ì„ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ì¸ë±ìŠ¤ë„ ì¡°íšŒ
</span>            <span class="n">entry</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">api_provider_id</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">api_provider not found: </span><span class="si">{</span><span class="n">api_provider_id</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="nc">ApiProvider</span><span class="p">(</span><span class="o">**</span><span class="n">entry</span><span class="p">)</span>

    <span class="c1"># --- ë²”ìš© ---
</span>    <span class="k">def</span> <span class="nf">api_parameters</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">api_provider</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_raw</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">dotted</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">config path not found: </span><span class="si">{</span><span class="n">dotted</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cur</span>

    <span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>

<span class="c1"># ----- ì‹±ê¸€í†¤ -----
</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
<span class="n">_instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ReadOnlyConfig</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">_default_path</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">_resolve_default_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_default_path</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_PATH</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_get_instance</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span>
    <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">_instance</span>

<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">refresh_seconds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span><span class="p">,</span> <span class="n">_default_path</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">_default_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">refresh_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">refresh_seconds</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
        <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>

<span class="c1"># ---- ì™¸ë¶€ API (í•¨ìˆ˜í˜•) ----
</span><span class="k">def</span> <span class="nf">api_provider</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>             <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">api_provider</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">api_providers</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>         <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">api_providers</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">api_parameters</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>           <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">api_parameters</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">api_provider_models</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ApiProvider</span><span class="p">]:</span>           <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">api_provider_models</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">api_provider_model</span><span class="p">(</span><span class="n">api_provider_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ApiProvider</span><span class="p">:</span> <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">api_provider_model</span><span class="p">(</span><span class="n">api_provider_id</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>                              <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">snapshot</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>                         <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">snapshot</span><span class="p">()</span>

<span class="c1"># ---- ê°ì²´í˜• í”„ë¡ì‹œ ----
</span><span class="k">class</span> <span class="nc">_ConfigProxy</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">_get_instance</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>
<span class="n">CONFIG</span> <span class="o">=</span> <span class="nf">_ConfigProxy</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="4-custom_nodescomfyui_config_reader__init__py-re-export">4) <code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/__init__.py</code> (re-export)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">.config_singleton</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CONFIG</span><span class="p">,</span>
    <span class="n">configure</span><span class="p">,</span>
    <span class="n">api_provider</span><span class="p">,</span> <span class="n">api_providers</span><span class="p">,</span> <span class="n">api_parameters</span><span class="p">,</span>
    <span class="n">api_provider_model</span><span class="p">,</span> <span class="n">api_provider_models</span><span class="p">,</span>
    <span class="n">get</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="ì‚¬ìš©-ì˜ˆ-ê°„ë‹¨">ì‚¬ìš© ì˜ˆ (ê°„ë‹¨)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">api_provider_models</span><span class="p">,</span> <span class="n">api_provider_model</span><span class="p">,</span>
    <span class="n">api_provider</span><span class="p">,</span> <span class="n">api_parameters</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># ì „ì²´ Pydantic ë¦¬ìŠ¤íŠ¸ (ì •ë ¬: api_provider_id)
</span><span class="n">providers</span> <span class="o">=</span> <span class="nf">api_provider_models</span><span class="p">()</span>
<span class="c1"># ex) ["anthropic-sonnet", "openai-mini", ...] ìˆœì„œ
</span><span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">providers</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">api_provider_id</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">model_id</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">))</span>

<span class="c1"># ë‹¨ê±´ ì¡°íšŒ(Pydantic)
</span><span class="n">sonnet</span> <span class="o">=</span> <span class="nf">api_provider_model</span><span class="p">(</span><span class="sh">"</span><span class="s">anthropic-sonnet</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">sonnet</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">())</span>  <span class="c1"># pydantic v2 / v1ì€ .dict()
</span>
<span class="c1"># í‚¤/í‘œì‹œëª…/ëª¨ë¸ID ì•„ë¬´ê±°ë‚˜ë¡œ ì ‘ê·¼(ë”•ì…”ë„ˆë¦¬)
</span><span class="n">cfg</span> <span class="o">=</span> <span class="nf">api_provider</span><span class="p">(</span><span class="sh">"</span><span class="s">OpenAI GPT-4o mini</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">])</span>

<span class="c1"># íŒŒë¼ë¯¸í„°ë§Œ
</span><span class="n">params</span> <span class="o">=</span> <span class="nf">api_parameters</span><span class="p">(</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h3 id="ë¹„ê³ ">ë¹„ê³ </h3>

<ul>
  <li>
    <p><strong>ë³´ì•ˆ ì£¼ì˜</strong> : <code class="language-plaintext highlighter-rouge">api_provider_models()</code>ëŠ” ê°ì²´ì— <code class="language-plaintext highlighter-rouge">api_key</code>ê°€ í¬í•¨ë¼ìš”. ë¡œê¹…/ë””ë²„ê¹… ì‹œ ë§ˆìŠ¤í‚¹í•˜ì„¸ìš”.</p>
  </li>
  <li>
    <p><strong>TOML íŒŒë¼ë¯¸í„° ì…ë ¥</strong> : ì¸ë¼ì¸ í…Œì´ë¸”(<code class="language-plaintext highlighter-rouge">{...}</code>) ë˜ëŠ” ì  í‘œê¸°(<code class="language-plaintext highlighter-rouge">parameters.x = ...</code>) ë‘˜ ë‹¤ OK.</p>
  </li>
  <li>
    <p><strong>ì •ë ¬ ë³´ì¥</strong> : ë¦¬ìŠ¤íŠ¸ëŠ” <strong>í•­ìƒ<code class="language-plaintext highlighter-rouge">api_provider_id</code>(TOML í‚¤)</strong> ê¸°ì¤€ ì˜¤ë¦„ì°¨ìˆœ.</p>
  </li>
  <li>
    <p><strong>ì„±ëŠ¥/ì¼ê´€ì„±</strong> : mtime + TTL(ê¸°ë³¸ 30s) ìºì‹œ â†’ â€œìµœëŒ€ 1ë¶„ ë‚´ ë³€ê²½ ë°˜ì˜â€ ìš”ê±´ ì¶©ì¡±.</p>
  </li>
</ul>

<p>í•„ìš”í•˜ë©´ ê°™ì€ ë°©ì‹ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">http</code> ì„¹ì…˜(í—¤ë”/ì¿¼ë¦¬/íƒ€ì„ì•„ì›ƒ)ë„ ë³‘í•©í•´ì„œ ëª¨ë¸ì— ë„£ì„ ìˆ˜ ìˆê²Œ í™•ì¥í•´ì¤„ê²Œ!</p>]]></content><author><name>hvppyarchive</name></author><category term="comfyui" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">openai api Raw ë°ì´í„° í™•ì¸ ë°©ë²•</title><link href="https://hvppyarchive.github.io/python/openai-package-data-hook/" rel="alternate" type="text/html" title="openai api Raw ë°ì´í„° í™•ì¸ ë°©ë²•" /><published>2025-10-01T18:38:56+09:00</published><updated>2025-10-01T18:38:56+09:00</updated><id>https://hvppyarchive.github.io/python/openai-package-data-hook</id><content type="html" xml:base="https://hvppyarchive.github.io/python/openai-package-data-hook/"><![CDATA[<p class="chat--user">

openai python packageì—ì„œ ë‚´ê°€ ë³´ë‚´ëŠ” íŒ¨í‚·ì„ ê°€ëŠ¥í•œ raw ë°ì´í„° í˜•íƒœë¡œ ë³´ê³  ì‹¶ì–´

</p>

<p>ì¢‹ì•„ìš”. â€œopenaiâ€ Python íŒ¨í‚¤ì§€ë¡œ APIë¥¼ í˜¸ì¶œí•  ë•Œ, ë‚´ê°€ ë³´ë‚¸ <strong>HTTP ìš”ì²­(=íŒ¨í‚·)ì— ìµœëŒ€í•œ ê°€ê¹Œìš´ raw ë°ì´í„°</strong> ë¥¼ ë³´ëŠ” ëŒ€í‘œì ì¸ ë°©ë²•ì„ ë‹¨ê³„ë³„ë¡œ ì •ë¦¬í–ˆì–´ìš”. ìƒí™©/ë³´ì•ˆ ìš”êµ¬ì— ë”°ë¼ ê³¨ë¼ ì“°ì‹œë©´ ë©ë‹ˆë‹¤.</p>

<hr />

<h1 id="1-ê°€ì¥-ê°„ë‹¨í•œ-ë°©ë²•-sdk-ë””ë²„ê·¸-ë¡œê·¸-ì¼œê¸°">1) ê°€ì¥ ê°„ë‹¨í•œ ë°©ë²•: SDK ë””ë²„ê·¸ ë¡œê·¸ ì¼œê¸°</h1>

<p>OpenAI Python SDKëŠ” í™˜ê²½ë³€ìˆ˜ í•œ ì¤„ë¡œ ìƒì„¸ ë¡œê·¸ë¥¼ ë¿Œë¦´ ìˆ˜ ìˆì–´ìš”.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">OPENAI_LOG</span><span class="o">=</span>debug
python your_script.py
</code></pre></div></div>

<ul>
  <li>ì´ëŸ¬ë©´ SDK ë‚´ë¶€ì™€ í•¨ê»˜ <strong>httpx</strong>(OpenAI SDKì˜ HTTP í´ë¼ì´ì–¸íŠ¸) ë””ë²„ê·¸ ë¡œê·¸ë„ í™œì„±í™”ë¼ì„œ ìš”ì²­/ì‘ë‹µ íë¦„ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. <a href="https://stackoverflow.com/questions/76256249/logging-in-the-open-ai-python-library?utm_source=chatgpt.com">Stack Overflow</a></li>
</ul>

<blockquote>
  <p>ì¥ì : ì½”ë“œ ìˆ˜ì • ì—†ìŒ<br />
 ë‹¨ì : ë°”ë”” ì „ë¬¸ì„ í•­ìƒ ë³´ì—¬ì£¼ì§„ ì•ŠìŒ(ë¯¼ê°ì •ë³´ ë³´í˜¸ ì°¨ì›ì—ì„œ ë§ˆìŠ¤í‚¹/ìƒëµë  ìˆ˜ ìˆìŒ)</p>
</blockquote>

<hr />

<h1 id="2-í‘œì¤€-ë¡œê¹…ìœ¼ë¡œ-httpx-ë””ë²„ê¹…ìš”ì²­ì‘ë‹µ-ë¼ì¸í—¤ë”">2) í‘œì¤€ ë¡œê¹…ìœ¼ë¡œ httpx ë””ë²„ê¹…(ìš”ì²­/ì‘ë‹µ ë¼ì¸Â·í—¤ë”)</h1>

<p><code class="language-plaintext highlighter-rouge">logging</code>ìœ¼ë¡œ httpx ë¡œê±°ë¥¼ DEBUGë¡œ ì¼œë©´, ì—°ê²°/ìš”ì²­/ì‘ë‹µì˜ ë‚´ë¶€ ë™ì‘ì„ ìì„¸íˆ ë³¼ ìˆ˜ ìˆì–´ìš”.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">logging</span>

<span class="n">logging</span><span class="p">.</span><span class="nf">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="p">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="n">logging</span><span class="p">.</span><span class="nf">getLogger</span><span class="p">(</span><span class="sh">"</span><span class="s">httpx</span><span class="sh">"</span><span class="p">).</span><span class="nf">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="p">.</span><span class="n">DEBUG</span><span class="p">)</span>

<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>
<span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">()</span>

<span class="c1"># í‰ì†Œì²˜ëŸ¼ í˜¸ì¶œ
</span><span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ping</span><span class="sh">"</span><span class="p">}],</span>
<span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
</code></pre></div></div>

<ul>
  <li>ìœ„ì²˜ëŸ¼ í•˜ë©´ httpxê°€ ì¶œë ¥í•˜ëŠ” <strong>ìš”ì²­ ë©”ì„œë“œ/URL, ì‘ë‹µ ìƒíƒœ, ì¼ë¶€ í—¤ë” ë“±</strong> ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•„ìš”í•œ ê²½ìš° í¬ë§·ì„ ë” ê¾¸ë°€ ìˆ˜ ìˆì–´ìš”. <a href="https://www.python-httpx.org/logging/?utm_source=chatgpt.com">python-httpx.org</a></li>
</ul>

<blockquote>
  <p>ì¥ì : í‘œì¤€ íŒŒì´ì¬ ë¡œê¹…ìœ¼ë¡œ ì†ì‰½ê²Œ ì œì–´<br />
 ë‹¨ì : ë°”ë”” ì „ë¬¸ì€ ê¸°ë³¸ ë¡œê·¸ì— ì•ˆ ë‚˜ì˜´</p>
</blockquote>

<hr />

<h1 id="3-ì§„ì§œ-rawì—-ê°€ê¹ê²Œ--ì»¤ìŠ¤í…€-httpx-client--ì´ë²¤íŠ¸-í›…">3) â€œì§„ì§œ rawì— ê°€ê¹ê²Œâ€ â€” ì»¤ìŠ¤í…€ httpx Client + ì´ë²¤íŠ¸ í›…</h1>

<p>ê°€ì¥ íˆ¬ëª…í•œ ë°©ë²•ì€ SDKì— <strong>ì»¤ìŠ¤í…€ httpx.Client</strong> ë¥¼ ì£¼ì…í•˜ê³ , <strong>event_hooks</strong> ë¡œ ìš”ì²­Â·ì‘ë‹µ ì‹œì ì— <strong>ë°”ë””ê¹Œì§€ í¬í•¨</strong> í•´ì„œ ì°ëŠ” ê²ë‹ˆë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="k">def</span> <span class="nf">log_request</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Request</span><span class="p">):</span>
    <span class="c1"># ì£¼ì˜: ì—¬ê¸°ì„œ bodyë¥¼ ì¶œë ¥í•˜ë©´ í”„ë¡¬í”„íŠ¸/í‚¤ ë“± ë¯¼ê°ì •ë³´ê°€ ë…¸ì¶œë  ìˆ˜ ìˆìŒ
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== HTTP REQUEST ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">request</span><span class="p">.</span><span class="n">url</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># request.contentëŠ” bytesì¼ ìˆ˜ ìˆìŒ
</span>    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">-- body (utf-8) --</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">))</span>
        <span class="k">except</span> <span class="nb">UnicodeDecodeError</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">-- body (bytes) --</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">log_response</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Response</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== HTTP RESPONSE ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">HTTP/</span><span class="si">{</span><span class="n">response</span><span class="p">.</span><span class="n">http_version</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># ì£¼ì˜: ì‘ë‹µ ë°”ë””ì—ëŠ” í† í°/í…ìŠ¤íŠ¸ ë“± ë¯¼ê°ì •ë³´ í¬í•¨ ê°€ëŠ¥
</span>    <span class="n">body</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">content</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">-- body (utf-8 pretty) --</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">(),</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">-- body (raw) --</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">body</span><span class="p">[:</span><span class="mi">2000</span><span class="p">])</span>  <span class="c1"># ë„ˆë¬´ ê¸¸ë©´ ìƒ˜í”Œë§Œ
</span>
<span class="n">hooks</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">log_request</span><span class="p">],</span>
    <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">log_response</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">http_client</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">Client</span><span class="p">(</span><span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">)</span>

<span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">http_client</span><span class="o">=</span><span class="n">http_client</span><span class="p">)</span>

<span class="c1"># í…ŒìŠ¤íŠ¸ í˜¸ì¶œ
</span><span class="n">_</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Hello</span><span class="sh">"</span><span class="p">}],</span>
<span class="p">)</span>
</code></pre></div></div>

<ul>
  <li>í•µì‹¬ì€ <code class="language-plaintext highlighter-rouge">OpenAI(http_client=...)</code> ë¡œ <strong>ë‚´ httpx í´ë¼ì´ì–¸íŠ¸ë¥¼ ì£¼ì…</strong> í•˜ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤. ì´ëŸ° ì‹ìœ¼ë¡œ ìš”ì²­/ì‘ë‹µ <strong>í—¤ë” + ë°”ë””</strong> ë¥¼ ì›í•˜ëŠ” í˜•ì‹ìœ¼ë¡œ ë¤í”„í•  ìˆ˜ ìˆì–´ìš”. <a href="https://til.simonwillison.net/httpx/openai-log-requests-responses?utm_source=chatgpt.com">TIL+2</a></li>
</ul>

<blockquote>
  <p>ì¥ì : ê°€ì¥ â€œrawâ€ì— ê°€ê¹Œì›€(ë‚´ìš©Â·í—¤ë”Â·ìƒíƒœ ì „ë¶€ ë‚´ê°€ í†µì œ)<br />
 ë‹¨ì : ì§ì ‘ ë§ˆìŠ¤í‚¹ ì²˜ë¦¬ë¥¼ í•´ì•¼ ì•ˆì „</p>
</blockquote>

<hr />

<h1 id="4-ì™¸ë¶€-í”„ë¡ì‹œíŒ¨í‚·-ìº¡ì²˜ë¡œ-ì™€ì´ì–´-ê·¸ëŒ€ë¡œ-ë³´ê¸°">4) ì™¸ë¶€ í”„ë¡ì‹œ(íŒ¨í‚· ìº¡ì²˜)ë¡œ â€œì™€ì´ì–´ ê·¸ëŒ€ë¡œâ€ ë³´ê¸°</h1>

<p>ì½”ë“œë¥¼ ê±´ë“œë¦¬ê³  ì‹¶ì§€ ì•Šê±°ë‚˜, <strong>ì§„ì§œ ì „ì†¡ë˜ëŠ” TLS íŠ¸ë˜í”½</strong> ê¹Œì§€ ê´€ì°°í•˜ê³  ì‹¶ë‹¤ë©´ <strong>í”„ë¡ì‹œ/íŒ¨í‚· ë„êµ¬</strong> ë¥¼ ì“°ì„¸ìš”.</p>

<ul>
  <li>
    <p>ì˜ˆ: <strong>Proxyman</strong> , <strong>mitmproxy</strong> , <strong>Charles</strong> , <strong>Fiddler</strong> ë“±</p>
  </li>
  <li>
    <p>ë°©ë²•: ë„êµ¬ì—ì„œ ë£¨íŠ¸ ì¸ì¦ì„œë¥¼ ì‹ ë¢°í•˜ë„ë¡ ì„¤ì • â†’ Pythonì´ í•´ë‹¹ í”„ë¡ì‹œë¥¼ ì“°ê²Œ <code class="language-plaintext highlighter-rouge">HTTPS_PROXY</code>/<code class="language-plaintext highlighter-rouge">HTTP_PROXY</code> í™˜ê²½ë³€ìˆ˜ ì„¤ì • â†’ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ â†’ ë„êµ¬ì—ì„œ <strong>ìš”ì²­ ë¼ì¸/í—¤ë”/ì••ì¶• ì „/í›„ ë°”ë””</strong> ê¹Œì§€ ì—´ëŒ</p>
  </li>
  <li>
    <p>httpx/requests ê¸°ë°˜ íŒŒì´ì¬ ì½”ë“œì—ì„œ ì´ëŸ° í”„ë¡ì‹œë¡œ <strong>HTTPS íŠ¸ë˜í”½ ìº¡ì²˜</strong> ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤. <a href="https://proxyman.com/posts/2025-01-29-How-To-Capture-HTTPS-Traffic-From-Python-Requests-httpx?utm_source=chatgpt.com">Proxyman</a></p>
  </li>
</ul>

<blockquote>
  <p>ì¥ì : SDK/ì½”ë“œ ìˆ˜ì • ìµœì†Œí™”, ì‹¤ì œ ì „ì†¡ í˜•íƒœë¥¼ GUIë¡œ ì§ê´€ì ìœ¼ë¡œ í™•ì¸<br />
 ë‹¨ì : ì‚¬ë‚´ ì •ì±…/ë£¨íŠ¸ ì¸ì¦ì„œ ì„¤ì¹˜ ì´ìŠˆ ê°€ëŠ¥</p>
</blockquote>

<hr />

<h1 id="5-ë¹„êµ-ê¸°ì¤€-ì •ë¦¬-ì–¸ì œ-ë¬´ì—‡ì„-ì“¸ê¹Œ">5) ë¹„êµ ê¸°ì¤€ ì •ë¦¬ (ì–¸ì œ ë¬´ì—‡ì„ ì“¸ê¹Œ?)</h1>

<ul>
  <li>
    <p><strong>ë¹ ë¥¸ í™•ì¸</strong> : <code class="language-plaintext highlighter-rouge">OPENAI_LOG=debug</code> (1ë¶„ ì»·). <a href="https://stackoverflow.com/questions/76256249/logging-in-the-open-ai-python-library?utm_source=chatgpt.com">Stack Overflow</a></p>
  </li>
  <li>
    <p><strong>íŒŒì´ì¬ ë¡œê·¸ì— ì¼ì›í™”</strong> : httpx ë¡œê±° DEBUG (Step 2). <a href="https://www.python-httpx.org/logging/?utm_source=chatgpt.com">python-httpx.org</a></p>
  </li>
  <li>
    <p><strong>ìš”ì²­/ì‘ë‹µ ë°”ë””ê¹Œì§€ 100% í†µì œ</strong> : ì»¤ìŠ¤í…€ httpx Client + event_hooks (Step 3). <a href="https://til.simonwillison.net/httpx/openai-log-requests-responses?utm_source=chatgpt.com">TIL+1</a></p>
  </li>
  <li>
    <p><strong>ì§„ì§œ íŒ¨í‚· ê´€ì (í”„ë¡ì‹œ)</strong> : Proxyman/mitmproxy (Step 4). <a href="https://proxyman.com/posts/2025-01-29-How-To-Capture-HTTPS-Traffic-From-Python-Requests-httpx?utm_source=chatgpt.com">Proxyman</a></p>
  </li>
</ul>

<hr />

<h1 id="6-ë³´ì•ˆì»´í”Œë¼ì´ì–¸ìŠ¤-ì£¼ì˜ì¤‘ìš”">6) ë³´ì•ˆ/ì»´í”Œë¼ì´ì–¸ìŠ¤ ì£¼ì˜(ì¤‘ìš”)</h1>

<ul>
  <li>
    <p><strong>API í‚¤</strong> ì™€ <strong>í”„ë¡¬í”„íŠ¸/ì‘ë‹µ ë‚´ìš©</strong> ì´ ë¡œê·¸ì— ë‚¨ì„ ìˆ˜ ìˆì–´ìš”.</p>

    <ul>
      <li>
        <p>ë¡œì»¬ë§Œ, ì ‘ê·¼ ì œí•œëœ í™˜ê²½ì—ì„œë§Œ ì¶œë ¥í•˜ì„¸ìš”.</p>
      </li>
      <li>
        <p>ì €ì¥ ì‹œì—” <strong>ë§ˆìŠ¤í‚¹/ì•”í˜¸í™”</strong> ë˜ëŠ” <strong>ì„ì‹œ íŒŒì¼</strong> ì‚¬ìš©ì„ ê¶Œì¥.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>íšŒì‚¬/ì¡°ì§ ì •ì±…ìƒ <strong>ì¤‘ê°„ì í”„ë¡ì‹œ íˆ´</strong> ì‚¬ìš©ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤(íŠ¹íˆ í´ë¼ìš°ë“œ/ìƒì‚°í™˜ê²½). ì‚¬ì „ ìŠ¹ì¸ í•„ìš”.</p>
  </li>
</ul>

<hr />

<h1 id="7-ì°¸ê³ -ë¬¸ì„œ">7) ì°¸ê³  ë¬¸ì„œ</h1>

<ul>
  <li>
    <p>OpenAI SDK ë””ë²„ê¹… ê°œìš”/ë ˆí¼ëŸ°ìŠ¤: <a href="https://platform.openai.com/docs/api-reference/debugging-requests?utm_source=chatgpt.com">OpenAI í”Œë«í¼+1</a></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">OPENAI_LOG=debug</code> ì•ˆë‚´(Q&amp;A): <a href="https://stackoverflow.com/questions/76256249/logging-in-the-open-ai-python-library?utm_source=chatgpt.com">Stack Overflow</a></p>
  </li>
  <li>
    <p>httpx ë¡œê¹…/íŠ¸ëœìŠ¤í¬íŠ¸ ì‹¬í™”: <a href="https://www.python-httpx.org/logging/?utm_source=chatgpt.com">python-httpx.org+1</a></p>
  </li>
  <li>
    <p>ì™¸ë¶€ í”„ë¡ì‹œë¡œ httpx íŠ¸ë˜í”½ ìº¡ì²˜: <a href="https://proxyman.com/posts/2025-01-29-How-To-Capture-HTTPS-Traffic-From-Python-Requests-httpx?utm_source=chatgpt.com">Proxyman</a></p>
  </li>
</ul>

<hr />

<p>ì›í•˜ì‹œë©´, ìœ„ â‘¢ ì»¤ìŠ¤í…€ í´ë¼ì´ì–¸íŠ¸ ì½”ë“œë¥¼ <strong>ë°”ë”” ë§ˆìŠ¤í‚¹(ì˜ˆ: í† í°/ì´ë©”ì¼ ì œê±°)</strong> í¬í•¨ ë²„ì „ìœ¼ë¡œ ë°”ë¡œ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

stringì— ë°ì´í„°ê°€ ë‹´ê¸°ê²Œ í•˜ê³  ì‹¶ì–´ ìš”ì²­ì„ ë³´ë‚¼ë•Œ / ë°›ì„ë•Œ ê°ê°

</p>

<p>ì¢‹ìŠµë‹ˆë‹¤ â€” <strong>ìš”ì²­ ë³´ë‚¼ ë•Œ(request)ì™€ ë°›ì„ ë•Œ(response)</strong> ê°ê°ì˜ ë°”ë””ë¥¼ <strong>ë¬¸ìì—´(string)</strong>ìœ¼ë¡œ ì €ì¥í•˜ëŠ” ì‹¤ì „ ì½”ë“œ(ë™ê¸° + ë¹„ë™ê¸°)ë¥¼ ë°”ë¡œ ë“œë¦´ê²Œìš”. ë¯¼ê°ì •ë³´(Authorization/API Key ë“±) ë§ˆìŠ¤í‚¹ë„ í¬í•¨ë˜ì–´ ìˆìœ¼ë‹ˆ ì•ˆì „í•˜ê²Œ ì“°ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¨ê³„ë³„ë¡œ ì„¤ëª…ë„ ë§ë¶™ì˜€ì–´ìš” â€” ìš”ì²­í•˜ì‹  ëŒ€ë¡œ <strong>step-by-step</strong> ë°©ì‹ìœ¼ë¡œìš”.</p>

<hr />

<h1 id="1-í•µì‹¬-ì•„ì´ë””ì–´-ê°„ë‹¨-ìš”ì•½">1) í•µì‹¬ ì•„ì´ë””ì–´ (ê°„ë‹¨ ìš”ì•½)</h1>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">httpx.Client</code>(ë˜ëŠ” <code class="language-plaintext highlighter-rouge">httpx.AsyncClient</code>)ë¥¼ ë§Œë“¤ì–´ <code class="language-plaintext highlighter-rouge">event_hooks</code>ì— ìš”ì²­/ì‘ë‹µ í›…ì„ ë¶™ì…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>í›…ì—ì„œ <code class="language-plaintext highlighter-rouge">request.content</code> / <code class="language-plaintext highlighter-rouge">response.content</code>ë¥¼ ì½ì–´ <code class="language-plaintext highlighter-rouge">str</code>ë¡œ ë³€í™˜í•´ì„œ ì „ì—­ ë³€ìˆ˜ë‚˜ ìº¡ì²˜ìš© ë³€ìˆ˜ì— ì €ì¥í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë¡œê·¸ë¡œ ì¶œë ¥í•˜ê¸° ì „ ë¯¼ê° í•„ë“œ(í—¤ë”ì˜ Authorization ë“±)ì™€ ë°”ë”” ë‚´ë¶€ í‚¤(ì˜ˆ: <code class="language-plaintext highlighter-rouge">"api_key"</code>, <code class="language-plaintext highlighter-rouge">"key"</code>)ë¥¼ ë§ˆìŠ¤í‚¹í•©ë‹ˆë‹¤.</p>
  </li>
</ol>

<hr />

<h1 id="2-ë™ê¸°synchronous-ì˜ˆì œ--ë°”ë¡œ-ë³µì‚¬í•´ì„œ-ì“°ì„¸ìš”">2) ë™ê¸°(synchronous) ì˜ˆì œ â€” ë°”ë¡œ ë³µì‚¬í•´ì„œ ì“°ì„¸ìš”</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>    <span class="c1"># ì„¤ì¹˜ëœ ìµœì‹  openai íŒ¨í‚¤ì§€ ì‚¬ìš©
</span>
<span class="c1"># ì €ì¥í•  ë¬¸ìì—´ ë³€ìˆ˜(ìš”ì²­/ì‘ë‹µ)
</span><span class="n">captured_request_body</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">captured_response_body</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">redacted</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="o">==</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">api-key</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">k</span><span class="p">.</span><span class="nf">lower</span><span class="p">():</span>
            <span class="n">redacted</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">REDACTED</span><span class="sh">"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">redacted</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">redacted</span>

<span class="k">def</span> <span class="nf">redact_json_text</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="c1"># ì‹œë„: JSONì´ë©´ íŒŒì‹±í•´ì„œ íŠ¹ì • í‚¤ ë§ˆìŠ¤í‚¹
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">sensitive</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">apiKey</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">sensitive</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="n">obj</span><span class="p">[</span><span class="n">sensitive</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">REDACTED</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="c1"># JSONì´ ì•„ë‹ˆë©´ ê°„ë‹¨ ì¹˜í™˜(í—¤ë”ì²˜ëŸ¼)
</span>        <span class="c1"># ì˜ˆ: URL-encoded form/bodyì—ì„œ key=ê°’ í˜•íƒœë¥¼ ê°€ë³ê²Œ ë§ˆìŠ¤í‚¹
</span>        <span class="k">for</span> <span class="n">sensitive</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">apiKey</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">sensitive</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span><span class="p">,</span> <span class="n">sensitive</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=REDACTED</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span>

<span class="k">def</span> <span class="nf">request_hook</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Request</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">captured_request_body</span>
    <span class="c1"># í—¤ë” ë§ˆìŠ¤í‚¹
</span>    <span class="n">safe_headers</span> <span class="o">=</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">))</span>
    <span class="c1"># ë°”ë”” ì½ê¸° (bytes -&gt; str)
</span>    <span class="n">body_str</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># request.contentëŠ” bytes ë˜ëŠ” None
</span>    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">body_str</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">body_str</span> <span class="o">=</span> <span class="nf">repr</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># ì¤€ë¹„ë˜ì§€ ì•Šì€ ìŠ¤íŠ¸ë¦¼(rare)ì¸ ê²½ìš°
</span>        <span class="n">body_str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">&lt;no request.content available or streaming body&gt;</span><span class="sh">"</span>
    <span class="c1"># ë¯¼ê°ì •ë³´ ë§ˆìŠ¤í‚¹
</span>    <span class="n">body_str</span> <span class="o">=</span> <span class="nf">redact_json_text</span><span class="p">(</span><span class="n">body_str</span><span class="p">)</span>
    <span class="n">captured_request_body</span> <span class="o">=</span> <span class="n">body_str</span>

    <span class="c1"># (ì„ íƒ) ì½˜ì†” ì¶œë ¥
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">---- REQUEST ----</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">request</span><span class="p">.</span><span class="n">url</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">safe_headers</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">-- body --</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">body_str</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">-----------------</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">response_hook</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Response</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">captured_response_body</span>
    <span class="c1"># í—¤ë” ë§ˆìŠ¤í‚¹
</span>    <span class="n">safe_headers</span> <span class="o">=</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">))</span>
    <span class="c1"># ì‘ë‹µ ë°”ë”” ì½ìŒ (bytes -&gt; str)
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># response.contentëŠ” ì „ì²´ ë°”ë””(ì´ë¯¸ ìˆ˜ì‹ ëœ ìƒíƒœì˜ hookì—ì„œëŠ” ì•ˆì „)
</span>        <span class="n">body_str</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
        <span class="c1"># ì‹œë„í•´ì„œ JSON ì˜ˆì˜ê²Œ
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">parsed</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">body_str</span><span class="p">)</span>
            <span class="n">body_str</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">parsed</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">body_str</span> <span class="o">=</span> <span class="nf">repr</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>
    <span class="n">body_str</span> <span class="o">=</span> <span class="nf">redact_json_text</span><span class="p">(</span><span class="n">body_str</span><span class="p">)</span>
    <span class="n">captured_response_body</span> <span class="o">=</span> <span class="n">body_str</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">---- RESPONSE ----</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">HTTP/</span><span class="si">{</span><span class="n">response</span><span class="p">.</span><span class="n">http_version</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">safe_headers</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">-- body --</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">body_str</span><span class="p">[:</span><span class="mi">4000</span><span class="p">])</span>  <span class="c1"># ë„ˆë¬´ ê¸¸ë©´ ì˜ë¼ì„œ ë³´ì´ê²Œ
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">------------------</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ì´ë²¤íŠ¸ í›… ë“±ë¡
</span><span class="n">hooks</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">request_hook</span><span class="p">],</span>
    <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">response_hook</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">http_client</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">Client</span><span class="p">(</span><span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">60.0</span><span class="p">)</span>

<span class="c1"># OpenAI í´ë¼ì´ì–¸íŠ¸ì— ì£¼ì…
</span><span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">http_client</span><span class="o">=</span><span class="n">http_client</span><span class="p">)</span>

<span class="c1"># ì‹¤ì œ ìš”ì²­ (ì˜ˆì‹œ)
</span><span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì•ˆë…•</span><span class="sh">"</span><span class="p">}],</span>
<span class="p">)</span>

<span class="c1"># í•¨ìˆ˜ ì™¸ë¶€ì—ì„œ ë¬¸ìì—´ ì ‘ê·¼ ê°€ëŠ¥
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">Captured request body (string):</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">captured_request_body</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">Captured response body (string):</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">captured_response_body</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h1 id="3-ë¹„ë™ê¸°async-ì˜ˆì œ--asyncawait-í™˜ê²½ì—ì„œ">3) ë¹„ë™ê¸°(async) ì˜ˆì œ â€” async/await í™˜ê²½ì—ì„œ</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="n">captured_request_body</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">captured_response_body</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">redacted</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="o">==</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">api-key</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">k</span><span class="p">.</span><span class="nf">lower</span><span class="p">():</span>
            <span class="n">redacted</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">REDACTED</span><span class="sh">"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">redacted</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">redacted</span>

<span class="k">def</span> <span class="nf">redact_json_text</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">sensitive</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">apiKey</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">sensitive</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="n">obj</span><span class="p">[</span><span class="n">sensitive</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">REDACTED</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">sensitive</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">apiKey</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">sensitive</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span><span class="p">,</span> <span class="n">sensitive</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=REDACTED</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">request_hook</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Request</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">captured_request_body</span>
    <span class="n">safe_headers</span> <span class="o">=</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">))</span>
    <span class="n">body_str</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">body_str</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">body_str</span> <span class="o">=</span> <span class="nf">repr</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">body_str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">&lt;no request.content available or streaming body&gt;</span><span class="sh">"</span>
    <span class="n">body_str</span> <span class="o">=</span> <span class="nf">redact_json_text</span><span class="p">(</span><span class="n">body_str</span><span class="p">)</span>
    <span class="n">captured_request_body</span> <span class="o">=</span> <span class="n">body_str</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">REQ</span><span class="sh">"</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">url</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">body_str</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">response_hook</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Response</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">captured_response_body</span>
    <span class="n">safe_headers</span> <span class="o">=</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">body_str</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">body_str</span> <span class="o">=</span> <span class="nf">repr</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>
    <span class="n">body_str</span> <span class="o">=</span> <span class="nf">redact_json_text</span><span class="p">(</span><span class="n">body_str</span><span class="p">)</span>
    <span class="n">captured_response_body</span> <span class="o">=</span> <span class="n">body_str</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">RES</span><span class="sh">"</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">body_str</span><span class="p">[:</span><span class="mi">2000</span><span class="p">])</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">hooks</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">request_hook</span><span class="p">],</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">response_hook</span><span class="p">]}</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">AsyncClient</span><span class="p">(</span><span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">60.0</span><span class="p">)</span> <span class="k">as</span> <span class="n">async_http</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">http_client</span><span class="o">=</span><span class="n">async_http</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì•ˆë…•</span><span class="sh">"</span><span class="p">}],</span>
        <span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Done</span><span class="sh">"</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h1 id="4-ì£¼ì˜ì‚¬í•­--íŒ-ì¤‘ìš”">4) ì£¼ì˜ì‚¬í•­ &amp; íŒ (ì¤‘ìš”)</h1>

<ul>
  <li>
    <p>ëŒ€ë¶€ë¶„ ê²½ìš° <code class="language-plaintext highlighter-rouge">request.content</code> / <code class="language-plaintext highlighter-rouge">response.content</code>ëŠ” í›…ì—ì„œ ì½ì„ ìˆ˜ ìˆê³  ë¬¸ìì—´ë¡œ ë³€í™˜ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë‹¤ë§Œ <strong>íŒŒì¼ ì—…ë¡œë“œ(ë©€í‹°íŒŒíŠ¸)</strong> í˜¹ì€ <strong>ìŠ¤íŠ¸ë¦¬ë° ë°”ë””</strong> ë¼ë©´ ì²˜ë¦¬ ë°©ì‹ì´ ë‹¬ë¼ì§‘ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ìŠ¤íŠ¸ë¦¬ë°(ì˜ˆ: chunked transfer / SSE)ìœ¼ë¡œ ë™ì‘í•˜ëŠ” ê²½ìš°: í›…ì—ì„œ ì „ì²´ ë°”ë””ê°€ ì•„ì§ ì™„ì„±ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŸ° ìƒí™©ì´ë©´ SDKì˜ ìŠ¤íŠ¸ë¦¬ë° API(ë˜ëŠ” httpxì˜ <code class="language-plaintext highlighter-rouge">stream()</code> ì‚¬ìš©)ë¥¼ ì§ì ‘ ê°ì‹¸ì„œ ê° ì²­í¬ë¥¼ ìº¡ì²˜í•˜ëŠ” ë¡œì§ì„ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤. ì›í•˜ì‹œë©´ ìŠ¤íŠ¸ë¦¬ë° ìº¡ì²˜ ì˜ˆì œë„ ë“œë¦´ê²Œìš”.</p>
  </li>
  <li>
    <p><strong>ë¯¼ê°ì •ë³´ ë³´í˜¸</strong> : ì½˜ì†”/íŒŒì¼ì— ì§ì ‘ ë‚¨ê¸°ë©´ ì•ˆ ë©ë‹ˆë‹¤. ë¡œì»¬ ì „ìš©, ì ‘ê·¼ ì œì–´ëœ í™˜ê²½ì—ì„œë§Œ ë³´ê´€í•˜ì„¸ìš”. ì €ì¥í•´ì•¼ í•œë‹¤ë©´ ë§ˆìŠ¤í‚¹ ë˜ëŠ” ì•”í˜¸í™” ê¶Œì¥.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">event_hooks</code>ì—ì„œ ë°”ë””ë¥¼ ì½ëŠ” ê±´ ì¼ë°˜ì ìœ¼ë¡œ ì•ˆì „í•˜ì§€ë§Œ, ì¼ë¶€ ê²½ìš°(íŠ¹íˆ requestê°€ generator/streamë¡œ ë§Œë“¤ì–´ì¡Œë‹¤ë©´) ì½ìœ¼ë©´ ì›ë˜ ì „ì†¡ì„ ë§ì¹  ìˆ˜ ìˆìœ¼ë‹ˆ ì£¼ì˜í•˜ì„¸ìš”. ìœ„ ì˜ˆì œëŠ” ì¼ë°˜ JSON/í¼/ë©€í‹°íŒŒíŠ¸ ì „ì†¡ì— ì í•©í•©ë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />

<h1 id="5-ì¶”ê°€-ìš”ì²­-ê°€ëŠ¥í•œ-ê²ƒë“¤-ì›í•˜ì‹œë©´-ë°”ë¡œ-ë§Œë“­ë‹ˆë‹¤">5) ì¶”ê°€ ìš”ì²­ ê°€ëŠ¥í•œ ê²ƒë“¤ (ì›í•˜ì‹œë©´ ë°”ë¡œ ë§Œë“­ë‹ˆë‹¤)</h1>

<ul>
  <li>
    <p>ìš”ì²­/ì‘ë‹µì„ <strong>íŒŒì¼ ëŒ€ì‹  ë¬¸ìì—´ ë³€ìˆ˜</strong> ì— ì•ˆì „í•˜ê²Œ ëˆ„ì (rolling buffer)í•˜ëŠ” ë²„ì „</p>
  </li>
  <li>
    <p><strong>ìŠ¤íŠ¸ë¦¬ë°(ì„œë²„-ì „ì†¡ ì´ë²¤íŠ¸)</strong> ì‘ë‹µì„ ì²­í¬ ë‹¨ìœ„ë¡œ ìº¡ì²˜í•´ì„œ ë‹¨ì¼ ë¬¸ìì—´ë¡œ í•©ì¹˜ëŠ” ì˜ˆì œ</p>
  </li>
  <li>
    <p>ë°”ë””ì—ì„œ <strong>íŠ¹ì • í‚¤ë§Œ</strong>(ì˜ˆ: <code class="language-plaintext highlighter-rouge">messages</code> or <code class="language-plaintext highlighter-rouge">prompt</code>)ë§Œ ìº¡ì²˜í•´ì„œ ì €ì¥í•˜ê³  ë‚˜ë¨¸ì§€ëŠ” ë§ˆìŠ¤í‚¹í•˜ëŠ” ì˜ˆì œ</p>
  </li>
  <li>
    <p>ë©€í‹°íŒŒíŠ¸(íŒŒì¼ ì—…ë¡œë“œ) ìš”ì²­ì˜ ê° íŒŒíŠ¸(íŒŒì¼ ë©”íƒ€/ì½˜í…ì¸ )ë¥¼ ìº¡ì²˜í•´ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ëŠ” ì˜ˆì œ</p>
  </li>
</ul>

<p>ì›í•˜ì‹œëŠ” ê±¸ ì•Œë ¤ì£¼ì‹œë©´(ì˜ˆ: ìŠ¤íŠ¸ë¦¬ë° ìº¡ì²˜, ë©€í‹°íŒŒíŠ¸ ì²˜ë¦¬, í˜¹ì€ ë°”ë¡œ ì ìš© ê°€ëŠ¥í•œ <strong>ë§ˆìŠ¤í‚¹ ê·œì¹™</strong>) ì§€ê¸ˆ ë°”ë¡œ ì½”ë“œë¡œ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”. ì–´ë–¤ ê±¸ ë¨¼ì € ë“œë¦´ê¹Œìš”?</p>

<p class="chat--user">

ì „ì—­ ë³€ìˆ˜ ë§ê³  main ì•ˆì—ì„œ ìŠ¤íŠ¸ë§ ì €ì¥í•˜ëŠ” ë°©ë°¥

</p>

<p>ì¢‹ì•„ìš” â€” <strong>ì „ì—­ ë³€ìˆ˜ ì—†ì´<code class="language-plaintext highlighter-rouge">main()</code> ì•ˆì—ì„œ ìš”ì²­/ì‘ë‹µ ë°”ë””ë¥¼ ë¬¸ìì—´ë¡œ ì €ì¥í•˜ëŠ” ë°©ë²•</strong>ì„ ë°”ë¡œ ë“œë¦´ê²Œìš”. í•µì‹¬ì€ <strong>í´ë¡œì €(or ë¡œì»¬ ê°€ë³€ ì»¨í…Œì´ë„ˆ)</strong> ë¥¼ ì‚¬ìš©í•´ í›…ì´ <code class="language-plaintext highlighter-rouge">main</code> ì•ˆì˜ ë³€ìˆ˜ì— ì ‘ê·¼í•˜ê²Œ í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ìŠ¤íŠ¸ë¦¬ë° ì˜ˆì™¸ëŠ” ë§ˆì§€ë§‰ì— ì§§ê²Œ ì–¸ê¸‰í•©ë‹ˆë‹¤.</p>

<p>ì•„ë˜ ì½”ë“œëŠ” (1) ë™ê¸°(synchronous)ì™€ (2) ë¹„ë™ê¸°(async) ë‘ ë²„ì „ ëª¨ë‘ ì œê³µí•˜ê³ , ë¯¼ê°ì •ë³´(Authorization í—¤ë”, ëª‡ëª‡ ë°”ë”” í‚¤)ë¥¼ <strong>ë§ˆìŠ¤í‚¹</strong> í•©ë‹ˆë‹¤. ê·¸ëŒ€ë¡œ ë³µì‚¬í•´ì„œ ì“°ì‹œë©´ ë©ë‹ˆë‹¤.</p>

<h1 id="1-ì›ë¦¬ìš”ì•½-step-by-step">1) ì›ë¦¬(ìš”ì•½, step-by-step)</h1>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">main()</code> ì•ˆì— <code class="language-plaintext highlighter-rouge">captured = {"request": None, "response": None}</code> ê°™ì€ <strong>ê°€ë³€ dict</strong> ë¥¼ ë§Œë“ ë‹¤.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">request_hook</code> / <code class="language-plaintext highlighter-rouge">response_hook</code> í•¨ìˆ˜ëŠ” í´ë¡œì €ë¡œì„œ ê·¸ <code class="language-plaintext highlighter-rouge">captured</code>ë¥¼ ìˆ˜ì •í•œë‹¤. (<code class="language-plaintext highlighter-rouge">nonlocal</code> ë¶ˆí•„ìš” â€” dictëŠ” ê°€ë³€ì´ë¯€ë¡œ)</p>
  </li>
  <li>
    <p>í›…ì—ì„œ <code class="language-plaintext highlighter-rouge">request.content</code> / <code class="language-plaintext highlighter-rouge">response.content</code>ë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜ â†’ ë¯¼ê°ì •ë³´ ë§ˆìŠ¤í‚¹ â†’ <code class="language-plaintext highlighter-rouge">captured[...] = body_str</code> ì €ì¥.</p>
  </li>
  <li>
    <p>ìš”ì²­ì´ ëë‚œ ë’¤ <code class="language-plaintext highlighter-rouge">main()</code>ì—ì„œ <code class="language-plaintext highlighter-rouge">captured</code> ê°’ì„ ì‚¬ìš©(ë˜ëŠ” ë°˜í™˜)í•œë‹¤.</p>
  </li>
</ol>

<hr />

<h1 id="2-ë™ê¸°sync-ì˜ˆì œ">2) ë™ê¸°(sync) ì˜ˆì œ</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="k">def</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="o">==</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">api-key</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">k</span><span class="p">.</span><span class="nf">lower</span><span class="p">():</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">REDACTED</span><span class="sh">"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">redact_json_text</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">sensitive</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">apiKey</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">sensitive</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="n">obj</span><span class="p">[</span><span class="n">sensitive</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">REDACTED</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">sensitive</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">apiKey</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">sensitive</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span><span class="p">,</span> <span class="n">sensitive</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=REDACTED</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) ë¡œì»¬ ìº¡ì²˜ ì»¨í…Œì´ë„ˆ (ì „ì—­ ì•„ë‹˜)
</span>    <span class="n">captured</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>

    <span class="c1"># 2) í›…ë“¤ (í´ë¡œì €ë¡œ capturedì— ì ‘ê·¼)
</span>    <span class="k">def</span> <span class="nf">request_hook</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Request</span><span class="p">):</span>
        <span class="c1"># headers ë§ˆìŠ¤í‚¹(ì—¬ê¸°ì„œëŠ” ì €ì¥ìš©; ì‹¤ì œ ì¶œë ¥ì€ ì•ˆì „í•˜ê²Œ)
</span>        <span class="n">safe_headers</span> <span class="o">=</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">))</span>
        <span class="c1"># bodyë¥¼ ë¬¸ìì—´ë¡œ ì½ê¸°
</span>        <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">body_str</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">body_str</span> <span class="o">=</span> <span class="nf">repr</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">body_str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">&lt;no request.content available or streaming body&gt;</span><span class="sh">"</span>
        <span class="n">body_str</span> <span class="o">=</span> <span class="nf">redact_json_text</span><span class="p">(</span><span class="n">body_str</span><span class="p">)</span>
        <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">method</span><span class="sh">"</span><span class="p">:</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">url</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="n">safe_headers</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">:</span> <span class="n">body_str</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">response_hook</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Response</span><span class="p">):</span>
        <span class="n">safe_headers</span> <span class="o">=</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">body_str</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
            <span class="c1"># ì˜ˆì˜ê²Œ í¬ë§·(JSONì´ë©´)
</span>            <span class="k">try</span><span class="p">:</span>
                <span class="n">parsed</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">body_str</span><span class="p">)</span>
                <span class="n">body_str</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">parsed</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">body_str</span> <span class="o">=</span> <span class="nf">repr</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>
        <span class="n">body_str</span> <span class="o">=</span> <span class="nf">redact_json_text</span><span class="p">(</span><span class="n">body_str</span><span class="p">)</span>
        <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">status_code</span><span class="sh">"</span><span class="p">:</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="n">safe_headers</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">:</span> <span class="n">body_str</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">hooks</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">request_hook</span><span class="p">],</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">response_hook</span><span class="p">]}</span>
    <span class="n">http_client</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">Client</span><span class="p">(</span><span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">60.0</span><span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">http_client</span><span class="o">=</span><span class="n">http_client</span><span class="p">)</span>

    <span class="c1"># 3) ì‹¤ì œ í˜¸ì¶œ (ë™ê¸°)
</span>    <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì•ˆë…•í•˜ì„¸ìš”</span><span class="sh">"</span><span class="p">}],</span>
    <span class="p">)</span>

    <span class="c1"># 4) main ë‚´ë¶€ì—ì„œ ë¬¸ìì—´ë¡œ í™œìš© / ì¶œë ¥ / ë°˜í™˜ ê°€ëŠ¥
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Captured request body (string):</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">]</span> <span class="k">else</span> <span class="sh">"</span><span class="s">&lt;none&gt;</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">Captured response body (string):</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">]</span> <span class="k">else</span> <span class="sh">"</span><span class="s">&lt;none&gt;</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">captured</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">captured</span> <span class="o">=</span> <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="3-ë¹„ë™ê¸°async-ì˜ˆì œ">3) ë¹„ë™ê¸°(async) ì˜ˆì œ</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="k">def</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="o">==</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">api-key</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">k</span><span class="p">.</span><span class="nf">lower</span><span class="p">():</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">REDACTED</span><span class="sh">"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">redact_json_text</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">sensitive</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">apiKey</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">sensitive</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="n">obj</span><span class="p">[</span><span class="n">sensitive</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">REDACTED</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">sensitive</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">apiKey</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">sensitive</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span><span class="p">,</span> <span class="n">sensitive</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=REDACTED</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">captured</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">request_hook</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Request</span><span class="p">):</span>
        <span class="n">safe_headers</span> <span class="o">=</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">body_str</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">body_str</span> <span class="o">=</span> <span class="nf">repr</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">body_str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">&lt;no request.content available or streaming body&gt;</span><span class="sh">"</span>
        <span class="n">body_str</span> <span class="o">=</span> <span class="nf">redact_json_text</span><span class="p">(</span><span class="n">body_str</span><span class="p">)</span>
        <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">method</span><span class="sh">"</span><span class="p">:</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">url</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="n">safe_headers</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">:</span> <span class="n">body_str</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">response_hook</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Response</span><span class="p">):</span>
        <span class="n">safe_headers</span> <span class="o">=</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">body_str</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">parsed</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">body_str</span><span class="p">)</span>
                <span class="n">body_str</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">parsed</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">body_str</span> <span class="o">=</span> <span class="nf">repr</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>
        <span class="n">body_str</span> <span class="o">=</span> <span class="nf">redact_json_text</span><span class="p">(</span><span class="n">body_str</span><span class="p">)</span>
        <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">status_code</span><span class="sh">"</span><span class="p">:</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="n">safe_headers</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">:</span> <span class="n">body_str</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">hooks</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">request_hook</span><span class="p">],</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">response_hook</span><span class="p">]}</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">AsyncClient</span><span class="p">(</span><span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">60.0</span><span class="p">)</span> <span class="k">as</span> <span class="n">async_http</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">http_client</span><span class="o">=</span><span class="n">async_http</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì•ˆë…•í•˜ì„¸ìš” (async)</span><span class="sh">"</span><span class="p">}],</span>
        <span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Captured request (local):</span><span class="sh">"</span><span class="p">,</span> <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">]</span> <span class="k">else</span> <span class="sh">"</span><span class="s">&lt;none&gt;</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Captured response (local):</span><span class="sh">"</span><span class="p">,</span> <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">]</span> <span class="k">else</span> <span class="sh">"</span><span class="s">&lt;none&gt;</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">captured</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h1 id="4-ì£¼ì˜ì‚¬í•­ì¤‘ìš”">4) ì£¼ì˜ì‚¬í•­(ì¤‘ìš”)</h1>

<ul>
  <li>
    <p><strong>ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ</strong>(SSE/ì²­í¬) ë˜ëŠ” <strong>íŒŒì¼ ì—…ë¡œë“œ(ë©€í‹°íŒŒíŠ¸)</strong> ì˜ ê²½ìš° <code class="language-plaintext highlighter-rouge">request.content</code> / <code class="language-plaintext highlighter-rouge">response.content</code>ê°€ í›…ì—ì„œ ë°”ë¡œ ì „ì²´ë¡œ ì½íˆì§€ ì•Šê±°ë‚˜, ì½ìœ¼ë©´ ìŠ¤íŠ¸ë¦¼ì´ ì†Œëª¨ë˜ì–´ ì „ì†¡ì— ì˜í–¥ì´ ìƒê¸¸ ìˆ˜ ìˆìŒ. ê·¸ëŸ° ê²½ìš°ëŠ” <strong>ë³„ë„ ìŠ¤íŠ¸ë¦¬ë° í›…</strong>(ì²­í¬ë§ˆë‹¤ append)ì´ë‚˜ httpxì˜ <code class="language-plaintext highlighter-rouge">stream()</code> ì‚¬ìš© ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤. í•„ìš”í•˜ì‹œë©´ ìŠ¤íŠ¸ë¦¬ë° ë²„ì „ë„ ë°”ë¡œ ì œê³µí• ê²Œìš”.</p>
  </li>
  <li>
    <p>í›…ì—ì„œ ë°”ë””ë¥¼ ì½ëŠ” í–‰ìœ„ê°€ ì¼ë¶€ ì „ì†¡ íŒŒì´í”„ë¼ì¸ì„ ë°”ê¿€ ìˆ˜ ìˆìœ¼ë‹ˆ(íŠ¹íˆ generator/íŒŒì¼ ìŠ¤íŠ¸ë¦¼ ì „ì†¡) ì•ˆì „í•œ í™˜ê²½ì—ì„œ ë¨¼ì € í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”.</p>
  </li>
  <li>
    <p>ë¡œê·¸/íŒŒì¼ì— ì €ì¥í•˜ë©´ API í‚¤ë‚˜ ë¯¼ê°í•œ ì‚¬ìš©ì ì…ë ¥ì´ ìœ ì¶œë  ìˆ˜ ìˆìœ¼ë‹ˆ <strong>ë¡œì»¬ ì „ìš© ë˜ëŠ” ì ‘ê·¼ ì œí•œ í™˜ê²½</strong> ì—ì„œë§Œ ì €ì¥í•˜ì„¸ìš”.</p>
  </li>
</ul>

<hr />

<p>ì›í•˜ì‹œë©´:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">messages</code> í•„ë“œ(í”„ë¡¬í”„íŠ¸)ë§Œ ìº¡ì²˜í•˜ê³  ë‚˜ë¨¸ì§€ëŠ” ì™„ì „ ë§ˆìŠ¤í‚¹í•˜ëŠ” ë²„ì „</p>
  </li>
  <li>
    <p><strong>ì²­í¬ ìŠ¤íŠ¸ë¦¬ë°</strong>(streaming response)ì„ ë¡œì»¬ ë¬¸ìì—´ë¡œ í•©ì¹˜ëŠ” ì˜ˆì œ</p>
  </li>
  <li>
    <p>ë©€í‹°íŒŒíŠ¸(íŒŒì¼ ì—…ë¡œë“œ)ì—ì„œ ê° íŒŒíŠ¸ ë³„ë¡œ ë¬¸ìì—´ë¡œ ì €ì¥í•˜ëŠ” ì˜ˆì œ</p>
  </li>
</ul>

<p>ì´ ì¤‘ ì–´ë–¤ ê±¸ ë¨¼ì € ë“œë¦´ê¹Œìš”?</p>

<p class="chat--user">

response.aread()ë¥¼ í•´ì•¼ ì½ì„ ìˆ˜ ìˆëŠ”ê±° ì•„ë‹ˆì•¼?

</p>

<p>ì¢‹ì€ ì§€ì ì…ë‹ˆë‹¤ â€” ìƒí™©ì— ë”°ë¼ <strong><code class="language-plaintext highlighter-rouge">response.aread()</code>ë¥¼ <code class="language-plaintext highlighter-rouge">await</code>í•´ì•¼ë§Œ ë°”ë””ë¥¼ ì½ì„ ìˆ˜ ìˆëŠ” ê²½ìš°</strong>ê°€ ë§ìŠµë‹ˆë‹¤. ìš”ì ë§Œ ë¨¼ì € ì •ë¦¬í•˜ê³ , ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” ì½”ë“œ ì˜ˆì œ(ë¹„ë™ê¸° í›…ì—ì„œ <code class="language-plaintext highlighter-rouge">await response.aread()</code> ì‚¬ìš©)ë¥¼ ë³´ì—¬ë“œë¦´ê²Œìš”.</p>

<h1 id="í•µì‹¬-ìš”ì•½">í•µì‹¬ ìš”ì•½</h1>

<ol>
  <li>
    <p><strong>ë™ê¸°(httpx.Client)</strong> : í›…ì—ì„œ <code class="language-plaintext highlighter-rouge">response.content</code>ë¥¼ ì½ìœ¼ë©´ ë‚´ë¶€ì—ì„œ ë‚´ìš©ì„ ê°€ì ¸ì™€ ìºì‹œí•˜ë¯€ë¡œ ë°”ë¡œ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>ë¹„ë™ê¸°(httpx.AsyncClient)</strong> : í›…ì´ <code class="language-plaintext highlighter-rouge">async def</code>ì´ë©´ <code class="language-plaintext highlighter-rouge">await response.aread()</code>ë¡œ ë°”ë””(ë°”ì´íŠ¸)ë¥¼ ê°€ì ¸ì™€ì•¼ ì•ˆì „í•©ë‹ˆë‹¤. (<code class="language-plaintext highlighter-rouge">response.content</code>ëŠ” ë™ê¸° ì†ì„±ì´ë¼ async ì»¨í…ìŠ¤íŠ¸ì—ì„  ê¶Œì¥ë˜ì§€ ì•ŠìŒ.)</p>
  </li>
  <li>
    <p><strong>ì£¼ì˜ â€” ìŠ¤íŠ¸ë¦¬ë°(SSE / chunked / streaming API)</strong> : <code class="language-plaintext highlighter-rouge">aread()</code>ëŠ” <strong>ì „ì²´ ë°”ë””ë¥¼ í•œ ë²ˆì—</strong> ì½ìŠµë‹ˆë‹¤. ë§Œì•½ ì‘ë‹µì´ ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°(ì˜ˆ: ì„œë²„-ì „ì†¡-ì´ë²¤íŠ¸)ì´ë¼ë©´ <code class="language-plaintext highlighter-rouge">aread()</code>ë¡œ ì „ì²´ë¥¼ ì½ì–´ë²„ë¦¬ë©´ ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬ë¥¼ ë§ì¹  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìŠ¤íŠ¸ë¦¬ë°ì€ <code class="language-plaintext highlighter-rouge">response.aiter_bytes()</code> / <code class="language-plaintext highlighter-rouge">response.aiter_text()</code>ë¡œ ì²­í¬ ë‹¨ìœ„ë¡œ ì²˜ë¦¬í•˜ì„¸ìš”.</p>
  </li>
  <li>
    <p>httpxëŠ” í•œ ë²ˆ ì½ì€ ë°”ë””ë¥¼ ìºì‹œí•˜ë¯€ë¡œ <code class="language-plaintext highlighter-rouge">aread()</code>ë¡œ ì½ì€ ë’¤ì—ë„ <code class="language-plaintext highlighter-rouge">response.content</code>/<code class="language-plaintext highlighter-rouge">response.text</code>ë¡œ ì ‘ê·¼í•´ë„ ë©ë‹ˆë‹¤(ëŒ€ë¶€ë¶„ì˜ ê²½ìš°).</p>
  </li>
</ol>

<hr />

<h1 id="ë°”ë¡œ-ì“¸-ìˆ˜-ìˆëŠ”-ë¹„ë™ê¸°-í›…-ì˜ˆì œ-await-responsearead-ì‚¬ìš©">ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” ë¹„ë™ê¸° í›… ì˜ˆì œ (<code class="language-plaintext highlighter-rouge">await response.aread()</code> ì‚¬ìš©)</h1>

<p>ì•„ë˜ëŠ” ì´ì „ ì˜ˆì œì˜ <code class="language-plaintext highlighter-rouge">response_hook</code>ë¥¼ <code class="language-plaintext highlighter-rouge">await response.aread()</code> ë¡œ ì•ˆì „í•˜ê²Œ ë°”ê¾¼ ì½”ë“œì…ë‹ˆë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="k">def</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="o">==</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">api-key</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">k</span><span class="p">.</span><span class="nf">lower</span><span class="p">():</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">REDACTED</span><span class="sh">"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">redact_text</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="c1"># ê°„ë‹¨ ë§ˆìŠ¤í‚¹ ì˜ˆì‹œ
</span>    <span class="k">for</span> <span class="n">sensitive</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">apiKey</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">sensitive</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span><span class="p">,</span> <span class="n">sensitive</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=REDACTED</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">apiKey</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="n">obj</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">REDACTED</span><span class="sh">"</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">text</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">captured</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">request_hook</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Request</span><span class="p">):</span>
        <span class="c1"># request.contentëŠ” ì´ë¯¸ bytesì¼ ê°€ëŠ¥ì„± ë†’ìŒ
</span>        <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">body_str</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">body_str</span> <span class="o">=</span> <span class="nf">repr</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">body_str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">&lt;no request.content available or streaming body&gt;</span><span class="sh">"</span>
        <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">method</span><span class="sh">"</span><span class="p">:</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">url</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">)),</span>
            <span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">:</span> <span class="nf">redact_text</span><span class="p">(</span><span class="n">body_str</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">response_hook</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Response</span><span class="p">):</span>
        <span class="c1"># ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µì¸ì§€ ê°„ë‹¨ ì²´í¬ (Content-Type ë˜ëŠ” Transfer-Encoding ì°¸ê³ )
</span>        <span class="n">ct</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">te</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">transfer-encoding</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">is_streaming</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">text/event-stream</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">ct</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="sh">"</span><span class="s">chunked</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">te</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_streaming</span><span class="p">:</span>
            <span class="c1"># ìŠ¤íŠ¸ë¦¬ë°ì€ ì „ì²´ aread() í•˜ì§€ ì•Šê³  ì²­í¬ ë‹¨ìœ„ë¡œ ì²˜ë¦¬í•´ì•¼ í•¨
</span>            <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">response</span><span class="p">.</span><span class="nf">aiter_bytes</span><span class="p">():</span>
                <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="n">body_bytes</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ì¼ë°˜ì ì¸ ë¹„ë™ê¸° ì‘ë‹µ: ì „ì²´ ë°”ë””ë¥¼ ì•ˆì „í•˜ê²Œ ì½ìŒ
</span>            <span class="n">body_bytes</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="p">.</span><span class="nf">aread</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">body_str</span> <span class="o">=</span> <span class="n">body_bytes</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">body_str</span> <span class="o">=</span> <span class="nf">repr</span><span class="p">(</span><span class="n">body_bytes</span><span class="p">)</span>

        <span class="c1"># ì˜ˆì˜ê²Œ JSON í¬ë§· ì‹œë„
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">parsed</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">body_str</span><span class="p">)</span>
            <span class="n">body_str</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">parsed</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">status_code</span><span class="sh">"</span><span class="p">:</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">)),</span>
            <span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">:</span> <span class="nf">redact_text</span><span class="p">(</span><span class="n">body_str</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="n">hooks</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">request_hook</span><span class="p">],</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">response_hook</span><span class="p">]}</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">AsyncClient</span><span class="p">(</span><span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">60.0</span><span class="p">)</span> <span class="k">as</span> <span class="n">async_http</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">http_client</span><span class="o">=</span><span class="n">async_http</span><span class="p">)</span>
        <span class="c1"># OpenAI í˜¸ì¶œ(ë¹„ë™ê¸°)
</span>        <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì•ˆë…•í•˜ì„¸ìš” (async aread ì˜ˆì œ)</span><span class="sh">"</span><span class="p">}],</span>
        <span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Captured request:</span><span class="sh">"</span><span class="p">,</span> <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">])</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Captured response:</span><span class="sh">"</span><span class="p">,</span> <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">][:</span><span class="mi">2000</span><span class="p">]</span> <span class="k">if</span> <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">]</span> <span class="k">else</span> <span class="sh">"</span><span class="s">&lt;none&gt;</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h1 id="ì¶”ê°€-íŒ--ì£¼ì˜">ì¶”ê°€ íŒ / ì£¼ì˜</h1>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">await response.aread()</code>ëŠ” <strong>ì‘ë‹µì´ ì´ë¯¸ ì–´ëŠ ì •ë„ ì½í˜€ìˆì§€ ì•Šë‹¤ë©´ ì „ì²´ ë°”ë””ë¥¼ í•œ ë²ˆì—</strong> ì½ì–´ ìºì‹œí•©ë‹ˆë‹¤. ëŒ€ë¶€ë¶„ì˜ REST í˜¸ì¶œ(ì „ì²´ ë°”ë””ê°€ ì‘ìŒ)ì—ëŠ” ì´ ë°©ë²•ì´ í¸í•˜ê³  ì•ˆì „í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>ìŠ¤íŠ¸ë¦¬ë° API</strong>(SSE, OpenAIì˜ ì¼ë¶€ ìŠ¤íŠ¸ë¦¬ë° ì¸í„°í˜ì´ìŠ¤ ë“±)ëŠ” <code class="language-plaintext highlighter-rouge">aread()</code>ë¡œ ì½ì–´ë²„ë¦¬ë©´ ìŠ¤íŠ¸ë¦¼ ì†Œë¹„ë¡œ ì¸í•´ ì›ë˜ ì˜ë„í•œ ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬(ì‹¤ì‹œê°„ ì²­í¬ ìˆ˜ì‹ )ê°€ ë¶ˆê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤. ê·¸ëŸ´ ë• <code class="language-plaintext highlighter-rouge">aiter_bytes()</code>/<code class="language-plaintext highlighter-rouge">aiter_text()</code>ë¡œ ì²­í¬ë¥¼ ìˆœíšŒí•˜ê±°ë‚˜ SDKê°€ ì œê³µí•˜ëŠ” ìŠ¤íŠ¸ë¦¬ë° ì½œë°±ì„ ì‚¬ìš©í•˜ì„¸ìš”.</p>
  </li>
  <li>
    <p>httpxëŠ” ë°”ë””ë¥¼ ì½ì–´ ìºì‹œì— ë³´ê´€í•˜ë‹ˆ, í›…ì—ì„œ <code class="language-plaintext highlighter-rouge">aread()</code>ë¡œ ì½ì–´ë„ ì´í›„ì— <code class="language-plaintext highlighter-rouge">response.text</code>/<code class="language-plaintext highlighter-rouge">response.json()</code>ë¡œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê¸´ í•©ë‹ˆë‹¤(ì¼ë°˜ì  ë™ì‘).</p>
  </li>
</ul>

<hr />

<p>ì›í•˜ì‹œë©´ ì§€ê¸ˆ ë°”ë¡œ:</p>

<ul>
  <li>
    <p><strong>ìŠ¤íŠ¸ë¦¬ë°(ì„œë²„-ì „ì†¡-ì´ë²¤íŠ¸)</strong> ë¥¼ ì²­í¬ ë‹¨ìœ„ë¡œ ì•ˆì „í•˜ê²Œ ìº¡ì²˜í•´ <code class="language-plaintext highlighter-rouge">main()</code> ì•ˆì˜ ë¬¸ìì—´ë¡œ í•©ì¹˜ëŠ” ì˜ˆì œ,</p>
  </li>
  <li>
    <p>í˜¹ì€ <strong>OpenAI SDKì˜ ìŠ¤íŠ¸ë¦¬ë°(ì˜ˆ:<code class="language-plaintext highlighter-rouge">stream=True</code>)</strong> ì— íŠ¹í™”ëœ ìº¡ì²˜ ì½”ë“œ(ì²­í¬ë§ˆë‹¤ ì²˜ë¦¬í•´ì„œ ë‹¨ì¼ ë¬¸ìì—´ë¡œ ê²°í•©)ë„ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”. ì–´ë–¤ ê±¸ ì›í•˜ì‹œë‚˜ìš”?</p>
  </li>
</ul>

<p class="chat--user">

1. requestìª½ í•œê¸€ì´ ê¹¨ì ¸ë³´ì—¬. ê·¸ë¦¬ê³  ì—¬ê¸°ë„ areadë¡œ ë°”ê¿”ì¤˜. 2. bodyìª½ ë‚´ìš©ì´ ëª¨ë‘ í•˜ë‚˜ì˜ stringìœ¼ë¡œë§Œ ë‚˜ì™€ì„œ ì½ê¸°ê°€ í˜ë“¤ì–´. ê·¸ëƒ¥ nested jsonìœ¼ë¡œ ë³´ì´ëŠ”ê²Œ ì½ê¸° í¸í•  ê²ƒ ê°™ì•„.

</p>

<p>ì¢‹ì€ í¬ì¸íŠ¸ ë‘ ê°€ì§€ ì •ë¦¬í•´ì„œ ë°”ë¡œ ë°˜ì˜í–ˆì–´ìš”.</p>

<ul>
  <li>
    <p><strong>(1) ìš”ì²­(request) ìª½ í•œê¸€ ê¹¨ì§</strong> â†’ <code class="language-plaintext highlighter-rouge">Content-Type</code>ì˜ <code class="language-plaintext highlighter-rouge">charset</code>ì„ í™•ì¸í•´ <strong>ì •í™•í•œ ì¸ì½”ë”©</strong> ìœ¼ë¡œ ë””ì½”ë”©í•˜ê³ , ê¸°ë³¸ê°’ì€ <code class="language-plaintext highlighter-rouge">utf-8</code>ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤. (OpenAI SDKëŠ” JSON ë°”ë””ë¥¼ ê¸°ë³¸ì ìœ¼ë¡œ UTF-8ë¡œ ë³´ëƒ…ë‹ˆë‹¤.)</p>
  </li>
  <li>
    <p><strong>(2) bodyë¥¼ â€œí•œ ì¤„ì§œë¦¬ ë¬¸ìì—´â€ì´ ì•„ë‹ˆë¼ â€œì¤‘ì²© JSON(íŒŒì´ì¬ dict)â€</strong> ìœ¼ë¡œ ì €ì¥ â†’ íŒŒì‹±ì´ ë˜ë©´ <code class="language-plaintext highlighter-rouge">dict/list</code>ë¡œ ì €ì¥í•˜ê³ , ì•ˆ ë˜ë©´ í…ìŠ¤íŠ¸ ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤.</p>
  </li>
</ul>

<p>ë˜, <strong>ì‘ë‹µ(response)</strong> ì€ ë¹„ë™ê¸° í™˜ê²½ì—ì„œ í™•ì‹¤íˆ <code class="language-plaintext highlighter-rouge">await response.aread()</code>ë¡œ ì½ë„ë¡ ë°”ê¿¨ìŠµë‹ˆë‹¤.<br />
<strong>ìš”ì²­(request)</strong> ê°ì²´ëŠ” httpxì—ì„œ <code class="language-plaintext highlighter-rouge">aread()</code>ê°€ ì—†ì–´ì„œ(ì‘ë‹µì—ë§Œ ìˆìŒ) ëŒ€ì‹  <strong>ë°”ì´íŠ¸ ë°”ë””ë¥¼ ì •í™•í•œ ì¸ì½”ë”©ìœ¼ë¡œ ë””ì½”ë”©</strong> í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤. (OpenAI SDKì²˜ëŸ¼ ì¼ë°˜ JSON ìš”ì²­ì´ë©´ <code class="language-plaintext highlighter-rouge">request.content</code>ì—ì„œ ì•ˆì „í•˜ê²Œ ì½í™ë‹ˆë‹¤. ì§„ì§œ â€œìŠ¤íŠ¸ë¦¬ë° ì—…ë¡œë“œâ€ë¥¼ í•˜ì‹ ë‹¤ë©´ ë³„ë„ tee ë˜í¼ê°€ í•„ìš”í•©ë‹ˆë‹¤â€”ì•„ë˜ì— ê°„ë‹¨ ì£¼ì„ ìˆìŠµë‹ˆë‹¤.)</p>

<hr />

<h3 id="ì—…ë°ì´íŠ¸ëœ-ë¹„ë™ê¸°-ì˜ˆì œ-ì „ì—­-ë³€ìˆ˜-ì—†ì´-main-ë‚´ë¶€-ë³´ê´€-request-í•œê¸€ì¸ì½”ë”©-ê°œì„ -responseëŠ”-aread-ì‚¬ìš©-bodyëŠ”-nested-jsonìœ¼ë¡œ-ì €ì¥">ì—…ë°ì´íŠ¸ëœ ë¹„ë™ê¸° ì˜ˆì œ (ì „ì—­ ë³€ìˆ˜ ì—†ì´ <code class="language-plaintext highlighter-rouge">main()</code> ë‚´ë¶€ ë³´ê´€, request í•œê¸€/ì¸ì½”ë”© ê°œì„ , responseëŠ” <code class="language-plaintext highlighter-rouge">aread()</code> ì‚¬ìš©, bodyëŠ” nested JSONìœ¼ë¡œ ì €ì¥)</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="k">def</span> <span class="nf">pick_charset</span><span class="p">(</span><span class="n">content_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="c1"># e.g. "application/json; charset=utf-8"
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">content_type</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">content_type</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">;</span><span class="sh">"</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">charset=</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">p</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nf">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="n">default</span>
    <span class="k">return</span> <span class="n">default</span>

<span class="k">def</span> <span class="nf">try_parse_json</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="o">==</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">api-key</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">k</span><span class="p">.</span><span class="nf">lower</span><span class="p">():</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">REDACTED</span><span class="sh">"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">redact_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="c1"># dict/listë¥¼ ì¬ê·€ì ìœ¼ë¡œ ëŒë©° ë¯¼ê° í‚¤ ë§ˆìŠ¤í‚¹
</span>    <span class="n">SENSITIVE_KEYS</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">apiKey</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">REDACTED</span><span class="sh">"</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">SENSITIVE_KEYS</span> <span class="k">else</span> <span class="nf">redact_obj</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nf">redact_obj</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">obj</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">captured</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">request_hook</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Request</span><span class="p">):</span>
        <span class="c1"># 1) charset ê²°ì •
</span>        <span class="n">req_ct</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">req_charset</span> <span class="o">=</span> <span class="nf">pick_charset</span><span class="p">(</span><span class="n">req_ct</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># 2) ë°”ë”” ë°”ì´íŠ¸ â†’ í…ìŠ¤íŠ¸
</span>        <span class="c1">#    (OpenAI SDKì˜ JSON í˜¸ì¶œì´ë¼ë©´ request.contentê°€ bytesë¡œ ì±„ì›Œì ¸ ìˆìŠµë‹ˆë‹¤)
</span>        <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">body_text</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">req_charset</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="c1"># í˜¹ì‹œ ëª¨ë¥¼ ì¸ì½”ë”© ì´ìŠˆ ëŒ€ë¹„: ë§ˆì§€ë§‰ fallback
</span>                <span class="n">body_text</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ìŠ¤íŠ¸ë¦¬ë° ì—…ë¡œë“œ(ì œë„ˆë ˆì´í„°/íŒŒì¼ ìŠ¤íŠ¸ë¦¼ ë“±)ì¸ ê²½ìš° ì—¬ê¸°ì— Noneì´ ë“¤ì–´ì˜µë‹ˆë‹¤.
</span>            <span class="c1"># ê·¸ëŸ° ê²½ìš°, ë³„ë„ "tee stream" ë˜í¼ë¡œ `request.stream`ì„ ê°ì‹¸ì„œ ì „ì†¡ë˜ë©° ìº¡ì²˜í•´ì•¼ í•©ë‹ˆë‹¤.
</span>            <span class="n">body_text</span> <span class="o">=</span> <span class="sh">"</span><span class="s">&lt;streaming or no request.content&gt;</span><span class="sh">"</span>

        <span class="c1"># 3) nested JSONìœ¼ë¡œ ì €ì¥(ê°€ëŠ¥í•˜ë©´)
</span>        <span class="n">body_obj</span> <span class="o">=</span> <span class="nf">try_parse_json</span><span class="p">(</span><span class="n">body_text</span><span class="p">)</span>
        <span class="n">body_saved</span> <span class="o">=</span> <span class="nf">redact_obj</span><span class="p">(</span><span class="n">body_obj</span><span class="p">)</span> <span class="k">if</span> <span class="n">body_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">body_text</span>  <span class="c1"># dict/listë©´ ë§ˆìŠ¤í‚¹, ì•„ë‹ˆë©´ ì›ë¬¸
</span>
        <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">method</span><span class="sh">"</span><span class="p">:</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">url</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">)),</span>
            <span class="c1"># ë¬¸ìì—´ì´ ì•„ë‹ˆë¼, ê°€ëŠ¥í•˜ë©´ dict/listë¡œ ì €ì¥ë©ë‹ˆë‹¤.
</span>            <span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">:</span> <span class="n">body_saved</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">response_hook</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Response</span><span class="p">):</span>
        <span class="c1"># 1) ì „ì²´ ë°”ë””ë¥¼ ë¹„ë™ê¸°ë¡œ ì•ˆì „í•˜ê²Œ ì½ìŒ
</span>        <span class="n">body_bytes</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="p">.</span><span class="nf">aread</span><span class="p">()</span>

        <span class="c1"># 2) charset ê²°ì •
</span>        <span class="n">res_ct</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">res_charset</span> <span class="o">=</span> <span class="nf">pick_charset</span><span class="p">(</span><span class="n">res_ct</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># 3) ë°”ë”” ë°”ì´íŠ¸ â†’ í…ìŠ¤íŠ¸
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">body_text</span> <span class="o">=</span> <span class="n">body_bytes</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">res_charset</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">body_text</span> <span class="o">=</span> <span class="n">body_bytes</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># 4) nested JSONìœ¼ë¡œ ì €ì¥(ê°€ëŠ¥í•˜ë©´)
</span>        <span class="n">body_obj</span> <span class="o">=</span> <span class="nf">try_parse_json</span><span class="p">(</span><span class="n">body_text</span><span class="p">)</span>
        <span class="n">body_saved</span> <span class="o">=</span> <span class="nf">redact_obj</span><span class="p">(</span><span class="n">body_obj</span><span class="p">)</span> <span class="k">if</span> <span class="n">body_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">body_text</span>

        <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">status_code</span><span class="sh">"</span><span class="p">:</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">)),</span>
            <span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">:</span> <span class="n">body_saved</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">hooks</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">request_hook</span><span class="p">],</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">response_hook</span><span class="p">]}</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">AsyncClient</span><span class="p">(</span><span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">60.0</span><span class="p">)</span> <span class="k">as</span> <span class="n">async_http</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">http_client</span><span class="o">=</span><span class="n">async_http</span><span class="p">)</span>

        <span class="c1"># ì‹¤ì œ í˜¸ì¶œ(ì˜ˆ: chat.completions)
</span>        <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">í•œê¸€ì´ ì œëŒ€ë¡œ ë³´ì´ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤ ğŸ˜Š</span><span class="sh">"</span><span class="p">}],</span>
        <span class="p">)</span>

    <span class="c1"># ì—¬ê¸°ì„œ captured["request"]["body"], captured["response"]["body"]ëŠ”
</span>    <span class="c1"># ê°€ëŠ¥í•œ ê²½ìš° "ì¤‘ì²© JSON(dict/list)"ë¡œ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
</span>    <span class="c1"># (JSONì´ ì•„ë‹ˆë©´ ë””ì½”ë”©ëœ í…ìŠ¤íŠ¸ ë¬¸ìì—´)
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">REQUEST (nested JSON or text):</span><span class="sh">"</span><span class="p">,</span> <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">])</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">RESPONSE (nested JSON or text):</span><span class="sh">"</span><span class="p">,</span> <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">captured</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h3 id="ìŠ¤íŠ¸ë¦¬ë°-ì—…ë¡œë“œë‹¤ìš´ë¡œë“œë¥¼-ì“°ëŠ”-íŠ¹ìˆ˜-ì¼€ì´ìŠ¤">ìŠ¤íŠ¸ë¦¬ë° ì—…ë¡œë“œ/ë‹¤ìš´ë¡œë“œë¥¼ ì“°ëŠ” íŠ¹ìˆ˜ ì¼€ì´ìŠ¤</h3>

<ul>
  <li>
    <p><strong>ìš”ì²­ì´ ìŠ¤íŠ¸ë¦¬ë° ì—…ë¡œë“œ</strong>(íŒŒì¼ ì œë„ˆë ˆì´í„° ë“±)ë©´ <code class="language-plaintext highlighter-rouge">request.content</code>ê°€ <code class="language-plaintext highlighter-rouge">None</code>ì¼ ìˆ˜ ìˆì–´ìš”. ì´ë•ŒëŠ” <code class="language-plaintext highlighter-rouge">request.stream</code>(ë¹„ê³µê°œ êµ¬í˜„ì¼ ìˆ˜ ìˆìŒ)ì„ <strong>tee ë˜í¼</strong> ë¡œ ê°ì‹¸ì„œ ì „ì†¡ë˜ëŠ” ë°”ì´íŠ¸ë¥¼ ì˜†ì—ì„œ ëª¨ì•„ì•¼ í•©ë‹ˆë‹¤. í•„ìš”í•˜ì‹œë©´ tee ë˜í¼(ë¹„ë™ê¸° ì œë„ˆë ˆì´í„°ë¡œ ê°ì‹¸ì„œ bytesë¥¼ <code class="language-plaintext highlighter-rouge">yield</code>í•˜ë©´ì„œ ë‚´ë¶€ ë²„í¼ì—ë„ <code class="language-plaintext highlighter-rouge">append</code>) ì½”ë“œë¥¼ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”.</p>
  </li>
  <li>
    <p><strong>ì‘ë‹µì´ ìŠ¤íŠ¸ë¦¬ë°(SSE/ì²­í¬)</strong> ì´ë©´ <code class="language-plaintext highlighter-rouge">await response.aread()</code>ë¡œ í•œ ë²ˆì— ì½ì§€ ë§ê³ , <code class="language-plaintext highlighter-rouge">async for chunk in response.aiter_bytes():</code> ì‹ìœ¼ë¡œ <strong>ì²­í¬ë¥¼ ëˆ„ì </strong> í•´ nested JSONìœ¼ë¡œ ë³µì›(ê°€ëŠ¥ì‹œ)í•˜ê±°ë‚˜, ì²­í¬ ë¦¬ìŠ¤íŠ¸ë¥¼ í•©ì³ì„œ ë‚˜ì¤‘ì— <code class="language-plaintext highlighter-rouge">json.loads()</code>ë¥¼ ì‹œë„í•˜ì„¸ìš”. ì´ê²ƒë„ ì›í•˜ì‹œë©´ ë°”ë¡œ ì˜ˆì œ ë“œë¦´ê²Œìš”.</p>
  </li>
</ul>

<hr />

<p>í•„ìš”í•˜ì‹  ê²½ìš°:</p>

<ul>
  <li>
    <p><strong>ìš”ì²­/ì‘ë‹µ ëª¨ë‘ â€œë°˜ë“œì‹œ dictë¡œë§Œ ë³´ê´€â€</strong>í•˜ë„ë¡ ê°•ì œí•˜ëŠ” ë²„ì „</p>
  </li>
  <li>
    <p><strong>íŠ¹ì • í‚¤ë§Œ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ ë§ˆìŠ¤í‚¹</strong>(ì˜ˆ: <code class="language-plaintext highlighter-rouge">messages</code>ë§Œ ìœ ì§€)</p>
  </li>
  <li>
    <p><strong>ìŠ¤íŠ¸ë¦¬ë° ì—…/ë‹¤ìš´ë¡œë“œ tee ë˜í¼</strong></p>
  </li>
</ul>

<p>ì–´ë–¤ ê±¸ ë” ì›í•˜ì„¸ìš”?</p>

<p class="chat--user">

ì°¸ê³ ë¡œ body_strì„ json.loadí•˜ê³  dump í•˜ë‹ˆ í•œê¸€ì´ ì œëŒ€ë¡œ ë³´ì˜€ì—ˆì–´.

</p>

<p>ë§ì•„ìš” â€” <strong><code class="language-plaintext highlighter-rouge">json.loads()</code> â†’ <code class="language-plaintext highlighter-rouge">json.dumps()</code></strong> ë¥¼ ê±°ì¹˜ë©´ í•œê¸€ì´ â€œì •ìƒ ê¸€ìâ€ë¡œ ë³´ì´ëŠ” ì´ìœ ê°€ ìˆìŠµë‹ˆë‹¤. í•µì‹¬ë§Œ ì •ë¦¬í•˜ê³ , ë°”ë¡œ ì ìš© ê°€ëŠ¥í•œ íŒ¨ì¹˜ë„ ë“œë¦´ê²Œìš”.</p>

<h1 id="ì™œ-load--dump-í•˜ë©´-í•œê¸€ì´-ì œëŒ€ë¡œ-ë³´ì¼ê¹Œ">ì™œ load â†’ dump í•˜ë©´ í•œê¸€ì´ ì œëŒ€ë¡œ ë³´ì¼ê¹Œ?</h1>

<ol>
  <li>
    <p><strong>ìš”ì²­/ì‘ë‹µ ë°”ì´íŠ¸ë¥¼ ì˜¬ë°”ë¥¸ ë¬¸ìì…‹(ëŒ€ê°œ UTF-8)</strong> ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">str</code>ë¡œ ë””ì½”ë”©í•´ì•¼ í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">json.loads()</code>ë¡œ íŒŒì‹±í•˜ë©´ <strong>íŒŒì´ì¬ ë‚´ë¶€ ê°ì²´(dict/list)</strong> ê°€ ë©ë‹ˆë‹¤. ì´ ìƒíƒœì—ì„œëŠ” í•œê¸€ì´ ì´ë¯¸ ìœ ë‹ˆì½”ë“œë¡œ ì˜¬ë°”ë¥´ê²Œ ë³´ì¡´ë¼ ìˆì–´ìš”.</p>
  </li>
  <li>
    <p>ê·¸ëŸ°ë° <code class="language-plaintext highlighter-rouge">json.dumps()</code>ì˜ ê¸°ë³¸ê°’ì€ <code class="language-plaintext highlighter-rouge">ensure_ascii=True</code>ë¼ì„œ, <strong>ë¹„ ASCII ë¬¸ìë¥¼<code class="language-plaintext highlighter-rouge">\uXXXX</code>ë¡œ ì´ìŠ¤ì¼€ì´í”„</strong>í•©ë‹ˆë‹¤.<br />
â†’ ì´ëŸ¬ë©´ ë‹¤ì‹œ â€œê¹¨ì ¸ ë³´ì´ê±°ë‚˜â€ <code class="language-plaintext highlighter-rouge">\uac00</code> ê°™ì€ ì½”ë“œê°’ìœ¼ë¡œ ë³´ì¼ ìˆ˜ ìˆì£ .</p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">ensure_ascii=False</code>ë¡œ <code class="language-plaintext highlighter-rouge">json.dumps(..., ensure_ascii=False, indent=2)</code></strong> ë¥¼ ì“°ë©´ í•œê¸€ì´ ê·¸ëŒ€ë¡œ ì¶œë ¥ë©ë‹ˆë‹¤(ì´ìŠ¤ì¼€ì´í”„ ì—†ì´).</p>
  </li>
</ol>

<blockquote>
  <p>ì¦‰, â€œë””ì½”ë”© â†’ íŒŒì‹± â†’ <code class="language-plaintext highlighter-rouge">ensure_ascii=False</code>ë¡œ ì§ë ¬í™”â€ ìˆœì„œê°€ ì¤‘ìš”í•©ë‹ˆë‹¤.</p>
</blockquote>

<hr />

<h1 id="ë°”ë¡œ-ì ìš©-1-nested-json-ì €ì¥--2-ë³´ê¸°-ì¢‹ê²Œ-ì¶œë ¥ensure_asciifalse">ë°”ë¡œ ì ìš©: (1) nested JSON ì €ì¥ + (2) ë³´ê¸° ì¢‹ê²Œ ì¶œë ¥(ensure_ascii=False)</h1>

<p>ì•„ë˜ëŠ” ì•ì„œ ë“œë¦° ë¹„ë™ê¸° í›… ì˜ˆì œì—ì„œ, <strong>nested JSONìœ¼ë¡œ ì €ì¥</strong> í•˜ê³  <strong>ë³¼ ë•ŒëŠ”<code class="language-plaintext highlighter-rouge">ensure_ascii=False</code>ë¡œ ë¤í”„</strong>í•˜ë„ë¡ ì‚´ì§ ì† ë³¸ ë²„ì „ì…ë‹ˆë‹¤. (ì‘ë‹µì€ <code class="language-plaintext highlighter-rouge">await response.aread()</code> ìœ ì§€)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>
<span class="kn">import</span> <span class="n">sys</span>

<span class="k">def</span> <span class="nf">pick_charset</span><span class="p">(</span><span class="n">content_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">content_type</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">content_type</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">;</span><span class="sh">"</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">charset=</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">p</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nf">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="n">default</span>
    <span class="k">return</span> <span class="n">default</span>

<span class="k">def</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="o">==</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">api-key</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">k</span><span class="p">.</span><span class="nf">lower</span><span class="p">():</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">REDACTED</span><span class="sh">"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">redact_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="n">SENSITIVE</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">apiKey</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">REDACTED</span><span class="sh">"</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">SENSITIVE</span> <span class="k">else</span> <span class="nf">redact_obj</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nf">redact_obj</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">obj</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># (ì„ íƒ) í„°ë¯¸ë„ì´ UTF-8ì´ ì•„ë‹ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë³´ì •
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">reconfigure</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">captured</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">request_hook</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Request</span><span class="p">):</span>
        <span class="n">req_ct</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">charset</span> <span class="o">=</span> <span class="nf">pick_charset</span><span class="p">(</span><span class="n">req_ct</span><span class="p">,</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">body_text</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">charset</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">body_text</span> <span class="o">=</span> <span class="sh">"</span><span class="s">&lt;streaming or no request.content&gt;</span><span class="sh">"</span>

        <span class="c1"># ê°€ëŠ¥í•˜ë©´ nested JSON(dict/list)ë¡œ ì €ì¥
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">body_obj</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">body_text</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">body_obj</span> <span class="o">=</span> <span class="n">body_text</span>  <span class="c1"># JSONì´ ì•„ë‹ˆë©´ ì›ë¬¸ ë¬¸ìì—´
</span>
        <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">method</span><span class="sh">"</span><span class="p">:</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">url</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">)),</span>
            <span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">:</span> <span class="nf">redact_obj</span><span class="p">(</span><span class="n">body_obj</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">response_hook</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Response</span><span class="p">):</span>
        <span class="n">body_bytes</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="p">.</span><span class="nf">aread</span><span class="p">()</span>
        <span class="n">res_ct</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">charset</span> <span class="o">=</span> <span class="nf">pick_charset</span><span class="p">(</span><span class="n">res_ct</span><span class="p">,</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

        <span class="n">body_text</span> <span class="o">=</span> <span class="n">body_bytes</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">charset</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">body_obj</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">body_text</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">body_obj</span> <span class="o">=</span> <span class="n">body_text</span>

        <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">status_code</span><span class="sh">"</span><span class="p">:</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">)),</span>
            <span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">:</span> <span class="nf">redact_obj</span><span class="p">(</span><span class="n">body_obj</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="n">hooks</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">request_hook</span><span class="p">],</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">response_hook</span><span class="p">]}</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">AsyncClient</span><span class="p">(</span><span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">60.0</span><span class="p">)</span> <span class="k">as</span> <span class="n">async_http</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">http_client</span><span class="o">=</span><span class="n">async_http</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">í•œê¸€ì´ ì˜ ë³´ì´ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤. ğŸ˜„</span><span class="sh">"</span><span class="p">}],</span>
        <span class="p">)</span>

    <span class="c1"># === ë³´ê¸° ì¢‹ê²Œ ì¶œë ¥: ensure_ascii=False + indent ===
</span>    <span class="k">def</span> <span class="nf">pretty</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== REQUEST ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="nf">pretty</span><span class="p">(</span><span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">]))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== RESPONSE ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="nf">pretty</span><span class="p">(</span><span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">captured</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<h3 id="í¬ì¸íŠ¸">í¬ì¸íŠ¸</h3>

<ul>
  <li>
    <p><strong>ì €ì¥ ë‹¨ê³„</strong> : ê°€ëŠ¥í•˜ë©´ <code class="language-plaintext highlighter-rouge">dict/list</code> í˜•íƒœë¡œ <strong>ê·¸ëŒ€ë¡œ ì €ì¥</strong> í•©ë‹ˆë‹¤(â€œí•œ ì¤„ ë¬¸ìì—´â€ ëŒ€ì‹  ì¤‘ì²© êµ¬ì¡°).</p>
  </li>
  <li>
    <p><strong>ì¶œë ¥/í™•ì¸ ë‹¨ê³„</strong> : <code class="language-plaintext highlighter-rouge">json.dumps(..., ensure_ascii=False, indent=2)</code> ë¡œ ë¤í”„í•˜ë©´ <strong>í•œê¸€ì´ ê·¸ëŒ€ë¡œ</strong> ë‚˜ì˜¤ê³  <strong>ê°€ë…ì„±</strong> ë„ ì¢‹ì•„ì§‘ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>ì½˜ì†” ì¸ì½”ë”©</strong> : Windows ë“±ì—ì„œ ì½˜ì†” ì¸ì½”ë”© ë¬¸ì œë¡œ ê¹¨ì§ˆ ìˆ˜ ìˆìœ¼ë‹ˆ <code class="language-plaintext highlighter-rouge">sys.stdout.reconfigure(encoding="utf-8")</code> ì‹œë„(ì‹¤íŒ¨í•´ë„ ë¬´ì‹œ).</p>
  </li>
</ul>

<hr />

<h1 id="ë¹ ë¥¸-ì²´í¬ë¦¬ìŠ¤íŠ¸-step-by-step">ë¹ ë¥¸ ì²´í¬ë¦¬ìŠ¤íŠ¸ (step-by-step)</h1>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Content-Type</code>ì—ì„œ <strong>charset í™•ì¸</strong> (ì—†ìœ¼ë©´ UTF-8 ê°€ì •).</p>
  </li>
  <li>
    <p>ë°”ì´íŠ¸ â†’ ë¬¸ìì—´ <strong>ë””ì½”ë”©</strong>.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">json.loads()</code>ë¡œ <strong>ê°ì²´í™”</strong>(ë˜ë©´ dict/listë¡œ ì €ì¥).</p>
  </li>
  <li>
    <p>ì¶œë ¥í•  ë•Œ <code class="language-plaintext highlighter-rouge">json.dumps(..., ensure_ascii=False, indent=2)</code> ì‚¬ìš©.</p>
  </li>
  <li>
    <p>ì½˜ì†” ì¸ì½”ë”©ì´ UTF-8ì¸ì§€ í™•ì¸(í•„ìš” ì‹œ <code class="language-plaintext highlighter-rouge">PYTHONIOENCODING=UTF-8</code> í™˜ê²½ë³€ìˆ˜ ë˜ëŠ” ìœ„ ì½”ë“œ).</p>
  </li>
</ol>

<p>ì›í•˜ì‹œë©´ <strong>ìš”ì²­/ì‘ë‹µì—ì„œ íŠ¹ì • í‚¤ë§Œ ê³¨ë¼ì„œ pretty-print</strong> í•˜ë„ë¡ í•„í„°ë§ê¹Œì§€ ë„£ì–´ë“œë¦´ê²Œìš”. ì–´ë–¤ í‚¤ë“¤ë§Œ ë³´ì´ë©´ ì¢‹ì„ê¹Œìš”?</p>]]></content><author><name>hvppyarchive</name></author><category term="python" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">Pickle to JSON ë³€í™˜</title><link href="https://hvppyarchive.github.io/python/pickle-to-json/" rel="alternate" type="text/html" title="Pickle to JSON ë³€í™˜" /><published>2025-09-29T10:41:41+09:00</published><updated>2025-09-29T10:41:41+09:00</updated><id>https://hvppyarchive.github.io/python/pickle-to-json</id><content type="html" xml:base="https://hvppyarchive.github.io/python/pickle-to-json/"><![CDATA[<p class="chat--user">

ë„ˆëŠ” íŒŒì´ì¬ í”„ë¡œê·¸ë˜ë° ì „ë¬¸ê°€ì•¼. python pickleë¡œ ì €ì¥ëœ ë°ì´í„°ê°€ ìˆì–´. ì´ê±¸ ì½ì–´ì„œ ê·¸ ì•ˆì˜ ëª¨ë“  ê°ì²´ treeë¥¼ json í˜•íƒœë¡œ ë±‰ë„ë¡ í•˜ê³  ì‹¶ì–´. ì´ ë•Œ pickleì€ ì»¤ìŠ¤í…€ í´ë˜ìŠ¤ë¥¼ ë‹´ê³  ìˆì–´. ì´ê±¸ í•´ë‚´ê¸° ìœ„í•´ì„œ ì–´ë–»ê²Œ ì ‘ê·¼í•´ì•¼í• ê¹Œ? ìµœëŒ€í•œ ì—ëŸ¬ê°€ ì—†ì´ ë™ì‘í•˜ë„ë¡ ê³ ë¯¼í•´ì¤˜. Step by Stepìœ¼ë¡œ ìƒê°í•´ì¤˜.

</p>

<p>ì¢‹ì•„, â€œí”¼í´ â†’ ì•ˆì „í•˜ê³  íŠ¼íŠ¼í•œ JSONâ€ì„ ëª©í‘œë¡œ ë‹¨ê³„ë³„ë¡œ ì„¤ê³„í•´ë³¼ê²Œ. (ì½”ë“œ ìƒ˜í”Œë„ ì•„ë˜ì— í•œ ë°©ì— ë„£ì–´ë’€ì–´.)</p>

<h1 id="step-by-step-ì ‘ê·¼">Step by Step ì ‘ê·¼</h1>

<h2 id="1-ìœ„í˜‘-ëª¨ë¸ì „ëµ-ë¨¼ì €-ê²°ì •">1) ìœ„í˜‘ ëª¨ë¸/ì „ëµ ë¨¼ì € ê²°ì •</h2>

<ul>
  <li>
    <p><strong>pickleì€ ì„ì˜ ì½”ë“œ ì‹¤í–‰ ìœ„í—˜</strong> ì´ ìˆì–´. <em>ì¶œì²˜ê°€ 100% ì‹ ë¢°ë˜ëŠ” íŒŒì¼ë§Œ</em> ë°”ë¡œ <code class="language-plaintext highlighter-rouge">pickle.load</code> í•˜ë©´ ë˜ê³ , ê·¸ ì™¸ì—ëŠ” â€œì œí•œ í•´ì œâ€ë¥¼ ì ˆëŒ€ í•˜ì§€ ë§ì•„ì•¼ í•´.</p>
  </li>
  <li>
    <p>ë”°ë¼ì„œ ë‘ ê°€ì§€ ëª¨ë“œë¥¼ ì¶”ì²œ:</p>

    <ol>
      <li>
        <p><strong>ì‹ ë¢° ëª¨ë“œ(trusted)</strong> : ê·¸ëƒ¥ ë¡œë“œ â†’ ì§ë ¬í™”.</p>
      </li>
      <li>
        <p><strong>ì„¸ì´í”„ ëª¨ë“œ(safe/whitelist)</strong> : í—ˆìš© ëª©ë¡(ëª¨ë“ˆ.í´ë˜ìŠ¤)ì„ ì§€ì •í•œ <code class="language-plaintext highlighter-rouge">RestrictedUnpickler</code>ë¡œë§Œ ì–¸í”¼í´.</p>
      </li>
    </ol>
  </li>
</ul>

<h2 id="2-ë¯¸ë¦¬-ë¬´ì—‡ì´-ë“¤ì–´ìˆëŠ”ì§€-ê²€ì‚¬">2) ë¯¸ë¦¬ â€œë¬´ì—‡ì´ ë“¤ì–´ìˆëŠ”ì§€â€ ê²€ì‚¬</h2>

<ul>
  <li>
    <p>ì–¸í”¼í´ì„ ì‹¤í–‰í•˜ì§€ ì•Šê³  <code class="language-plaintext highlighter-rouge">pickletools.genops</code>ë¡œ í”¼í´ ìŠ¤íŠ¸ë¦¼ì˜ <code class="language-plaintext highlighter-rouge">GLOBAL/STACK_GLOBAL</code> opcodeë¥¼ ìŠ¤ìº”í•´ì„œ, í•„ìš”í•œ í´ë˜ìŠ¤/ëª¨ë“ˆ ëª©ë¡ì„ ë½‘ì•„ë³¸ë‹¤.</p>
  </li>
  <li>
    <p>ê·¸ ê²°ê³¼ë¥¼ ë³´ê³  <strong>í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸</strong> ë¥¼ ë§Œë“ ë‹¤. (ì˜ˆ: <code class="language-plaintext highlighter-rouge">{"mymodels.User", "numpy.ndarray"}</code>)</p>
  </li>
</ul>

<h2 id="3-ì•ˆì „í•œ-ë¡œë”-ë§Œë“¤ê¸°">3) ì•ˆì „í•œ ë¡œë” ë§Œë“¤ê¸°</h2>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">pickle.Unpickler</code>ë¥¼ ìƒì†í•´ì„œ <code class="language-plaintext highlighter-rouge">find_class</code>ë¥¼ ì˜¤ë²„ë¼ì´ë“œ.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">builtins</code>ì˜ ê¸°ë³¸ ì»¨í…Œì´ë„ˆ ì •ë„ë§Œ í—ˆìš©í•˜ê³ , ë‚˜ë¨¸ì§€ëŠ” <strong>í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ì— ìˆëŠ” ê²ƒë§Œ í†µê³¼</strong>.</p>
  </li>
  <li>
    <p>í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ì— ì—†ëŠ” ê±´ <code class="language-plaintext highlighter-rouge">UnpicklingError</code>ë¡œ ë§‰ëŠ”ë‹¤.</p>
  </li>
</ul>

<h2 id="4-json-ê°€ëŠ¥-í˜•íƒœë¡œ-ë³€í™˜ê¸°-ì„¤ê³„">4) â€œJSON ê°€ëŠ¥ í˜•íƒœâ€ë¡œ ë³€í™˜ê¸° ì„¤ê³„</h2>

<p>JSONì€ ë‹¤ìŒì„ ê·¸ëŒ€ë¡œ í‘œí˜„ ëª» í•˜ê±°ë‚˜ ê¹¨ì§€ê¸° ì‰¬ì›Œ:</p>

<ul>
  <li>
    <p>ìˆœí™˜/ê³µìœ  ì°¸ì¡°(cycles/aliases), ì‚¬ìš©ì ì •ì˜ ê°ì²´, <code class="language-plaintext highlighter-rouge">set/tuple</code>, <code class="language-plaintext highlighter-rouge">bytes</code>, <code class="language-plaintext highlighter-rouge">datetime</code>, <code class="language-plaintext highlighter-rouge">Decimal/UUID</code>, <code class="language-plaintext highlighter-rouge">numpy/pandas/torch</code> ë“±.</p>
  </li>
  <li>
    <p><strong>ì›ì¹™</strong> : â€œê°€ëŠ¥í•˜ë©´ ì†ì‹¤ ì—†ì´â€, â€œê·¸ë˜ë„ í•­ìƒ ì§ë ¬í™”ë˜ê²Œâ€.</p>

    <ul>
      <li>
        <p><strong>ìˆœí™˜/ê³µìœ  ì°¸ì¡°</strong> : <code class="language-plaintext highlighter-rouge">"$id"</code>/<code class="language-plaintext highlighter-rouge">"$ref"</code> í”„ë¡œí† ì½œì„ ì‚¬ìš© (ì˜ˆ: <code class="language-plaintext highlighter-rouge">{"$id":"obj1", "value": ...}</code>, ì°¸ì¡°ëŠ” <code class="language-plaintext highlighter-rouge">{"$ref":"obj1"}</code>).</p>
      </li>
      <li>
        <p><strong>ì»¤ìŠ¤í…€ í´ë˜ìŠ¤</strong> : ìš°ì„  ìˆœìœ„ëŒ€ë¡œ</p>

        <ol>
          <li>
            <p><code class="language-plaintext highlighter-rouge">__json__()</code> â†’ ë”•íŠ¸/ë¦¬ìŠ¤íŠ¸ ë“±</p>
          </li>
          <li>
            <p><code class="language-plaintext highlighter-rouge">to_json()</code> / <code class="language-plaintext highlighter-rouge">to_dict()</code> / <code class="language-plaintext highlighter-rouge">model_dump()</code>(pydantic)</p>
          </li>
          <li>
            <p>dataclass â†’ <code class="language-plaintext highlighter-rouge">asdict</code></p>
          </li>
          <li>
            <p><code class="language-plaintext highlighter-rouge">__getstate__()</code> or <code class="language-plaintext highlighter-rouge">__dict__</code></p>
          </li>
          <li>
            <p>ë§ˆì§€ë§‰ ìˆ˜ë‹¨: <code class="language-plaintext highlighter-rouge">repr(obj)</code>ì— íƒ€ì… ë©”íƒ€(<code class="language-plaintext highlighter-rouge">"$type"</code>).</p>
          </li>
        </ol>
      </li>
      <li>
        <p><strong>íŠ¹ìˆ˜ íƒ€ì…ë“¤</strong> (ê°€ëŠ¥í•œ í•œ ë³´ì¡´):</p>

        <ul>
          <li>
            <p><code class="language-plaintext highlighter-rouge">set/frozenset</code> â†’ <code class="language-plaintext highlighter-rouge">{"$type":"set","items":[...]}</code></p>
          </li>
          <li>
            <p><code class="language-plaintext highlighter-rouge">tuple</code> â†’ <code class="language-plaintext highlighter-rouge">{"$type":"tuple","items":[...]}</code></p>
          </li>
          <li>
            <p><code class="language-plaintext highlighter-rouge">bytes/bytearray</code> â†’ <code class="language-plaintext highlighter-rouge">{"$type":"bytes","base64":"..."}</code></p>
          </li>
          <li>
            <p><code class="language-plaintext highlighter-rouge">datetime/date/time</code> â†’ <code class="language-plaintext highlighter-rouge">{"$type":"datetime","iso":"..."}</code></p>
          </li>
          <li>
            <p><code class="language-plaintext highlighter-rouge">Decimal</code> â†’ <code class="language-plaintext highlighter-rouge">{"$type":"decimal","value":"..."}</code></p>
          </li>
          <li>
            <p><code class="language-plaintext highlighter-rouge">UUID</code> â†’ <code class="language-plaintext highlighter-rouge">{"$type":"uuid","value":"..."}</code></p>
          </li>
          <li>
            <p><code class="language-plaintext highlighter-rouge">Path</code> â†’ <code class="language-plaintext highlighter-rouge">{"$type":"path","value":"..."}</code></p>
          </li>
          <li>
            <p><code class="language-plaintext highlighter-rouge">re.Pattern</code> â†’ íŒ¨í„´/í”Œë˜ê·¸ ë³´ì¡´</p>
          </li>
          <li>
            <p><code class="language-plaintext highlighter-rouge">Enum</code> â†’ ì´ë¦„/ê°’ ë³´ì¡´</p>
          </li>
          <li>
            <p><code class="language-plaintext highlighter-rouge">Exception</code> â†’ íƒ€ì…/args/str</p>
          </li>
          <li>
            <p><strong>NumPy</strong> : <code class="language-plaintext highlighter-rouge">ndarray</code>ëŠ” <code class="language-plaintext highlighter-rouge">.tolist()</code> + shape/dtype ë©”íƒ€</p>
          </li>
          <li>
            <p><strong>pandas</strong> : DataFrame/SeriesëŠ” <code class="language-plaintext highlighter-rouge">to_dict(orient="records")</code> ë“± + ë©”íƒ€</p>
          </li>
          <li>
            <p><strong>PyTorch/TensorFlow</strong> í…ì„œëŠ” <code class="language-plaintext highlighter-rouge">.detach().cpu().numpy().tolist()</code> ë“±ìœ¼ë¡œ ê°’ë§Œ (ê°€ëŠ¥í•˜ë©´ dtype/shape ë©”íƒ€ í¬í•¨)</p>
          </li>
        </ul>
      </li>
      <li>
        <p><strong>dictì˜ ë¹„ë¬¸ìì—´ í‚¤</strong> : JSONì€ í‚¤ê°€ ë¬¸ìì—´ë§Œ ë˜ë¯€ë¡œ</p>

        <ul>
          <li>
            <p>ì „ë¶€ ë¬¸ìì—´ì´ë©´ ê·¸ëŒ€ë¡œ ìœ ì§€</p>
          </li>
          <li>
            <p>ì•„ë‹ˆë©´ <code class="language-plaintext highlighter-rouge">{"$type":"dict","entries":[[key,value], ...]}</code> í˜•íƒœë¡œ ë³´ì¡´</p>
          </li>
        </ul>
      </li>
      <li>
        <p><strong>ê¹Šì´ ì œí•œ/ë©”ëª¨</strong> : ë¬´í•œ ì¬ê·€ ë°©ì§€ ìœ„í•´ <code class="language-plaintext highlighter-rouge">seen</code>(idâ†’$id) ë©”ëª¨ì™€ <code class="language-plaintext highlighter-rouge">max_depth</code> ë„ì….</p>
      </li>
      <li>
        <p><strong>ë§ˆì§€ë§‰ ì•ˆì „íŒ</strong> : ë¬´ì—‡ì´ë“  ì‹¤íŒ¨í•˜ë©´ <code class="language-plaintext highlighter-rouge">repr</code> + <code class="language-plaintext highlighter-rouge">"$error"</code> ë©”íƒ€ë¥¼ ë‹¬ì•„ ì ˆëŒ€ ì‹¤íŒ¨í•˜ì§€ ì•Šê²Œ.</p>
      </li>
    </ul>
  </li>
</ul>

<h2 id="5-ë¤í”„-ì˜µì…˜">5) ë¤í”„ ì˜µì…˜</h2>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">json.dumps(jsonable, ensure_ascii=False, indent=2, allow_nan=False)</code>ë¥¼ ê¶Œì¥.</p>
  </li>
  <li>
    <p>íŒŒì¼ì´ í¬ë©´ <code class="language-plaintext highlighter-rouge">indent=None</code>ë¡œ ìš©ëŸ‰ ìµœì†Œí™”.</p>
  </li>
  <li>
    <p>ë¤í”„ í›„ í•œ ë²ˆ <code class="language-plaintext highlighter-rouge">json.loads</code>ë¡œ <strong>ì—­íŒŒì‹± ê²€ì¦</strong> í•˜ë©´ ì‹¤ìˆ˜ ì¤„ì¼ ìˆ˜ ìˆì–´.</p>
  </li>
</ul>

<h2 id="6-ëŒ€ì•ˆ-ë¼ì´ë¸ŒëŸ¬ë¦¬-ì‚¬ìš©">6) ëŒ€ì•ˆ: ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©</h2>

<ul>
  <li>
    <p><strong>jsonpickle</strong> ì€ ìì²´ì ìœ¼ë¡œ í´ë˜ìŠ¤/ì°¸ì¡°ë¥¼ ì˜ ì²˜ë¦¬í•œë‹¤. ë¹ ë¥´ê²Œ ë˜ê³  ë²”ìš©ì„±ì´ ì¢‹ì§€ë§Œ, <em>ì–¸í”¼í´ ë‹¨ê³„ì˜ ë³´ì•ˆì€ ë³„ë„ ì²˜ë¦¬</em> ê°€ í•„ìš”í•˜ë‹¤(ì¦‰, <code class="language-plaintext highlighter-rouge">RestrictedUnpickler</code>ëŠ” ì—¬ì „íˆ í•„ìš”).</p>
  </li>
  <li>
    <p>ì§ì ‘ ê·œì¹™ì„ í†µì œí•˜ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ ì»¤ìŠ¤í…€ ì§ë ¬í™”ê¸°ë¥¼ ì“°ëŠ” ê²Œ ì•ˆì „/ì˜ˆì¸¡ ê°€ëŠ¥.</p>
  </li>
</ul>

<hr />

<h1 id="ê²¬ê³ í•œ-ì˜ˆì‹œ-ì½”ë“œ-ìŠ¤í¬ë¦½íŠ¸-1ê°œë¡œ-ë™ì‘">ê²¬ê³ í•œ ì˜ˆì‹œ ì½”ë“œ (ìŠ¤í¬ë¦½íŠ¸ 1ê°œë¡œ ë™ì‘)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
# pickle_to_json.py
</span><span class="kn">import</span> <span class="n">io</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">base64</span><span class="p">,</span> <span class="n">math</span><span class="p">,</span> <span class="n">re</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">pickle</span><span class="p">,</span> <span class="n">pickletools</span><span class="p">,</span> <span class="n">importlib</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">is_dataclass</span><span class="p">,</span> <span class="n">asdict</span>
<span class="kn">from</span> <span class="n">decimal</span> <span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">from</span> <span class="n">uuid</span> <span class="kn">import</span> <span class="n">UUID</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span>

<span class="c1"># --- Optional dependencies detection ---
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">np</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">pd</span> <span class="o">=</span> <span class="bp">None</span>

<span class="c1"># ---------- 1) ë¶„ì„: í”¼í´ ì•ˆì˜ ê¸€ë¡œë²Œ ì‹¬ë³¼ ìŠ¤ìº” ----------
</span><span class="k">def</span> <span class="nf">audit_pickle_globals</span><span class="p">(</span><span class="n">pkl_bytes</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">ì–¸í”¼í´ ì—†ì´ GLOBAL/STACK_GLOBAL ì‚¬ìš© ë‚´ì—­ì„ (module.name) ì§‘í•©ìœ¼ë¡œ ë¦¬í„´.</span><span class="sh">"""</span>
    <span class="n">refs</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">pickletools</span><span class="p">.</span><span class="nf">genops</span><span class="p">(</span><span class="n">pkl_bytes</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">op</span><span class="p">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">GLOBAL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STACK_GLOBAL</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">mod</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">arg</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># For GLOBAL, arg like "module\nname\n"
</span>                <span class="n">parts</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">arg</span><span class="p">).</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">mod</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">refs</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">mod</span><span class="si">}</span><span class="s">.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">refs</span>

<span class="c1"># ---------- 2) í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ê¸°ë°˜ Restricted Unpickler ----------
</span><span class="k">class</span> <span class="nc">RestrictedUnpickler</span><span class="p">(</span><span class="n">pickle</span><span class="p">.</span><span class="n">Unpickler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">allowed</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">allowed</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">allowed</span> <span class="ow">or</span> <span class="p">[])</span>

    <span class="k">def</span> <span class="nf">find_class</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">module</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">full</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s">.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span>
        <span class="c1"># ë¹ŒíŠ¸ì¸ ì»¨í…Œì´ë„ˆ/ì˜ˆì™¸/ê¸°ë³¸ íƒ€ì… ì¼ë¶€ í—ˆìš©
</span>        <span class="n">allowed_builtins</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">builtins.set</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">builtins.frozenset</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">builtins.bytes</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">builtins.bytearray</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">builtins.complex</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">builtins.Exception</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">builtins.slice</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">builtins.range</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">builtins.dict</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">builtins.list</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">builtins.tuple</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">full</span> <span class="ow">in</span> <span class="n">allowed_builtins</span> <span class="ow">or</span> <span class="n">full</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">allowed</span><span class="p">:</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">importlib</span><span class="p">.</span><span class="nf">import_module</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
            <span class="k">return</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">pickle</span><span class="p">.</span><span class="nc">UnpicklingError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">forbidden global: </span><span class="si">{</span><span class="n">full</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">restricted_loads</span><span class="p">(</span><span class="n">pkl_bytes</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">allowed</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="nc">RestrictedUnpickler</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nc">BytesIO</span><span class="p">(</span><span class="n">pkl_bytes</span><span class="p">),</span> <span class="n">allowed</span><span class="o">=</span><span class="n">allowed</span><span class="p">).</span><span class="nf">load</span><span class="p">()</span>

<span class="c1"># ---------- 3) JSON ì§ë ¬í™”ê¸° ----------
</span><span class="n">JSON_PRIMITIVES</span> <span class="o">=</span> <span class="p">(</span><span class="nf">type</span><span class="p">(</span><span class="bp">None</span><span class="p">),</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">is_primitive</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">JSON_PRIMITIVES</span><span class="p">):</span>
        <span class="c1"># NaN/InfëŠ” allow_nan=Falseì— ë§‰íˆë¯€ë¡œ ë¬¸ìì—´ ì²˜ë¦¬
</span>        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">math</span><span class="p">.</span><span class="nf">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">or</span> <span class="n">math</span><span class="p">.</span><span class="nf">isinf</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="c1"># ë„ˆë¬´ í° intëŠ” JSì—ì„œ ì•ˆì „í•˜ì§€ ì•Šì§€ë§Œ JSON ìŠ¤í™ì—” ë¬¸ì œ ì—†ìŒ. í•„ìš”ì‹œ ë¬¸ìì—´í™” ê°€ëŠ¥.
</span>        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">_pattern_type</span><span class="p">():</span>
    <span class="c1"># Py&gt;=3.8: re.Pattern, Py&lt;3.8: type(re.compile(''))
</span>    <span class="n">pat</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">re</span><span class="p">,</span> <span class="sh">"</span><span class="s">Pattern</span><span class="sh">"</span><span class="p">,</span> <span class="nf">type</span><span class="p">(</span><span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sh">""</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">pat</span>

<span class="k">def</span> <span class="nf">to_jsonable</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">seen</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">max_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">ê°ì²´ ê·¸ë˜í”„ë¥¼ JSON ê°€ëŠ¥ êµ¬ì¡°ë¡œ ë³€í™˜(+ ìˆœí™˜/ì°¸ì¡° ë³´ì¡´). ì ˆëŒ€ ì˜ˆì™¸ ë˜ì§€ì§€ ì•ŠìŒ.</span><span class="sh">"""</span>
    <span class="k">if</span> <span class="n">seen</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># ê¹Šì´ ë³´í˜¸
</span>    <span class="k">if</span> <span class="n">_depth</span> <span class="o">&gt;</span> <span class="n">max_depth</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">$type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">depth_truncated</span><span class="sh">"</span><span class="p">}</span>

    <span class="c1"># ê¸°ë³¸í˜•
</span>    <span class="k">if</span> <span class="nf">is_primitive</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="n">oid</span> <span class="o">=</span> <span class="nf">id</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="c1"># ë¶ˆë³€ì´ì§€ë§Œ í° íŠœí”Œ/í”„ë¦¬ë¯¸í‹°ë¸Œ ì•„ë‹Œ ê°ì²´ì—ë„ idë¥¼ ë¶€ì—¬í•´ ì°¸ì¡° ë³´ì¡´
</span>    <span class="k">if</span> <span class="n">oid</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">$ref</span><span class="sh">"</span><span class="p">:</span> <span class="n">seen</span><span class="p">[</span><span class="n">oid</span><span class="p">]}</span>

    <span class="c1"># ìƒˆ ê°ì²´ì— $id í• ë‹¹
</span>    <span class="n">sid</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">obj</span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">seen</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="sh">"</span>
    <span class="n">seen</span><span class="p">[</span><span class="n">oid</span><span class="p">]</span> <span class="o">=</span> <span class="n">sid</span>

    <span class="c1"># bytes/bytearray
</span>    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">,</span> <span class="nb">memoryview</span><span class="p">)):</span>
        <span class="n">b</span> <span class="o">=</span> <span class="nf">bytes</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">$id</span><span class="sh">"</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span> <span class="sh">"</span><span class="s">$type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">bytes</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">base64</span><span class="sh">"</span><span class="p">:</span> <span class="n">base64</span><span class="p">.</span><span class="nf">b64encode</span><span class="p">(</span><span class="n">b</span><span class="p">).</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">ascii</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">length</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">b</span><span class="p">)}</span>

    <span class="c1"># datetime-like
</span>    <span class="kn">import</span> <span class="n">datetime</span> <span class="k">as</span> <span class="n">_dt</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">_dt</span><span class="p">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">_dt</span><span class="p">.</span><span class="n">date</span><span class="p">,</span> <span class="n">_dt</span><span class="p">.</span><span class="n">time</span><span class="p">)):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">iso</span> <span class="o">=</span> <span class="n">obj</span><span class="p">.</span><span class="nf">isoformat</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">iso</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">$id</span><span class="sh">"</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span> <span class="sh">"</span><span class="s">$type</span><span class="sh">"</span><span class="p">:</span> <span class="n">obj</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">.</span><span class="nf">lower</span><span class="p">(),</span> <span class="sh">"</span><span class="s">iso</span><span class="sh">"</span><span class="p">:</span> <span class="n">iso</span><span class="p">}</span>

    <span class="c1"># Decimal / UUID / Path
</span>    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">$id</span><span class="sh">"</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span> <span class="sh">"</span><span class="s">$type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">decimal</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">UUID</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">$id</span><span class="sh">"</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span> <span class="sh">"</span><span class="s">$type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">uuid</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">$id</span><span class="sh">"</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span> <span class="sh">"</span><span class="s">$type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)}</span>

    <span class="c1"># ì •ê·œì‹ íŒ¨í„´
</span>    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nf">_pattern_type</span><span class="p">()):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">$id</span><span class="sh">"</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span> <span class="sh">"</span><span class="s">$type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">regex</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">pattern</span><span class="sh">"</span><span class="p">:</span> <span class="n">obj</span><span class="p">.</span><span class="n">pattern</span><span class="p">,</span> <span class="sh">"</span><span class="s">flags</span><span class="sh">"</span><span class="p">:</span> <span class="n">obj</span><span class="p">.</span><span class="n">flags</span><span class="p">}</span>

    <span class="c1"># Enum
</span>    <span class="kn">import</span> <span class="n">enum</span> <span class="k">as</span> <span class="n">_enum</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">_enum</span><span class="p">.</span><span class="n">Enum</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">$id</span><span class="sh">"</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span> <span class="sh">"</span><span class="s">$type</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">enum:</span><span class="si">{</span><span class="n">obj</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">obj</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">obj</span><span class="p">.</span><span class="n">value</span><span class="p">}</span>

    <span class="c1"># ì˜ˆì™¸
</span>    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">BaseException</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">$id</span><span class="sh">"</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span> <span class="sh">"</span><span class="s">$type</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">exception:</span><span class="si">{</span><span class="n">obj</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="nf">to_jsonable</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">seen</span><span class="o">=</span><span class="n">seen</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">,</span> <span class="n">_depth</span><span class="o">=</span><span class="n">_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">.</span><span class="n">args</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">str</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="c1"># NumPy
</span>    <span class="k">if</span> <span class="n">np</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">$id</span><span class="sh">"</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span> <span class="sh">"</span><span class="s">$type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">numpy.ndarray</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">shape</span><span class="sh">"</span><span class="p">:</span> <span class="n">obj</span><span class="p">.</span><span class="n">shape</span><span class="p">,</span> <span class="sh">"</span><span class="s">dtype</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">dtype</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">:</span> <span class="n">obj</span><span class="p">.</span><span class="nf">tolist</span><span class="p">(),</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">generic</span><span class="p">):</span>  <span class="c1"># numpy scalar
</span>            <span class="k">return</span> <span class="n">obj</span><span class="p">.</span><span class="nf">item</span><span class="p">()</span>

    <span class="c1"># pandas
</span>    <span class="k">if</span> <span class="n">pd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">$id</span><span class="sh">"</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span> <span class="sh">"</span><span class="s">$type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">pandas.DataFrame</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">columns</span><span class="sh">"</span><span class="p">:</span> <span class="n">obj</span><span class="p">.</span><span class="n">columns</span><span class="p">.</span><span class="nf">tolist</span><span class="p">(),</span>
                <span class="sh">"</span><span class="s">records</span><span class="sh">"</span><span class="p">:</span> <span class="n">obj</span><span class="p">.</span><span class="nf">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="sh">"</span><span class="s">records</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">pd</span><span class="p">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">$id</span><span class="sh">"</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span> <span class="sh">"</span><span class="s">$type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">pandas.Series</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">obj</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">values</span><span class="sh">"</span><span class="p">:</span> <span class="n">obj</span><span class="p">.</span><span class="nf">to_list</span><span class="p">(),</span>
                <span class="sh">"</span><span class="s">index</span><span class="sh">"</span><span class="p">:</span> <span class="n">obj</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nf">tolist</span><span class="p">(),</span>
            <span class="p">}</span>

    <span class="c1"># torch / tf í…ì„œ (ê°€ëŠ¥í•˜ë©´ ê°’ë§Œ)
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="n">torch</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">torch</span><span class="p">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">obj</span><span class="p">.</span><span class="nf">detach</span><span class="p">().</span><span class="nf">cpu</span><span class="p">().</span><span class="nf">numpy</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">$id</span><span class="sh">"</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span> <span class="sh">"</span><span class="s">$type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">torch.Tensor</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">shape</span><span class="sh">"</span><span class="p">:</span> <span class="nf">list</span><span class="p">(</span><span class="n">arr</span><span class="p">.</span><span class="n">shape</span><span class="p">),</span> <span class="sh">"</span><span class="s">dtype</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">arr</span><span class="p">.</span><span class="n">dtype</span><span class="p">),</span> <span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">:</span> <span class="n">arr</span><span class="p">.</span><span class="nf">tolist</span><span class="p">()}</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="n">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">Tensor</span><span class="p">,)):</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">obj</span><span class="p">.</span><span class="nf">numpy</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">$id</span><span class="sh">"</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span> <span class="sh">"</span><span class="s">$type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tf.Tensor</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">shape</span><span class="sh">"</span><span class="p">:</span> <span class="nf">list</span><span class="p">(</span><span class="n">arr</span><span class="p">.</span><span class="n">shape</span><span class="p">),</span> <span class="sh">"</span><span class="s">dtype</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">arr</span><span class="p">.</span><span class="n">dtype</span><span class="p">),</span> <span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">:</span> <span class="n">arr</span><span class="p">.</span><span class="nf">tolist</span><span class="p">()}</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># set / frozenset
</span>    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">)):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">$id</span><span class="sh">"</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span> <span class="sh">"</span><span class="s">$type</span><span class="sh">"</span><span class="p">:</span> <span class="n">obj</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">items</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="nf">to_jsonable</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">seen</span><span class="o">=</span><span class="n">seen</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">,</span> <span class="n">_depth</span><span class="o">=</span><span class="n">_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">],</span>
        <span class="p">}</span>

    <span class="c1"># tuple / list
</span>    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="nf">to_jsonable</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">seen</span><span class="o">=</span><span class="n">seen</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">,</span> <span class="n">_depth</span><span class="o">=</span><span class="n">_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">$id</span><span class="sh">"</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span> <span class="sh">"</span><span class="s">$type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tuple</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">items</span><span class="sh">"</span><span class="p">:</span> <span class="n">items</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">items</span>  <span class="c1"># listëŠ” í”íˆ ê·¸ëŒ€ë¡œ
</span>
    <span class="c1"># dict / mapping
</span>    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="c1"># ëª¨ë“  í‚¤ê°€ ë¬¸ìì—´ì´ë©´ í‰ë²”í•œ dict ìœ ì§€
</span>        <span class="k">if</span> <span class="nf">all</span><span class="p">(</span><span class="nf">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">.</span><span class="nf">keys</span><span class="p">()):</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">to_jsonable</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">seen</span><span class="o">=</span><span class="n">seen</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">,</span> <span class="n">_depth</span><span class="o">=</span><span class="n">_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
        <span class="c1"># ì•„ë‹ˆë©´ entriesë¡œ ë³´ì¡´
</span>        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">$id</span><span class="sh">"</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span> <span class="sh">"</span><span class="s">$type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dict</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">[</span><span class="nf">to_jsonable</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">seen</span><span class="o">=</span><span class="n">seen</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">,</span> <span class="n">_depth</span><span class="o">=</span><span class="n">_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                 <span class="nf">to_jsonable</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">seen</span><span class="o">=</span><span class="n">seen</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">,</span> <span class="n">_depth</span><span class="o">=</span><span class="n">_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">.</span><span class="nf">items</span><span class="p">()</span>
            <span class="p">],</span>
        <span class="p">}</span>

    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">$id</span><span class="sh">"</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span> <span class="sh">"</span><span class="s">$type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OrderedDict</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">[</span><span class="nf">to_jsonable</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">seen</span><span class="o">=</span><span class="n">seen</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">,</span> <span class="n">_depth</span><span class="o">=</span><span class="n">_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                 <span class="nf">to_jsonable</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">seen</span><span class="o">=</span><span class="n">seen</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">,</span> <span class="n">_depth</span><span class="o">=</span><span class="n">_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">.</span><span class="nf">items</span><span class="p">()</span>
            <span class="p">],</span>
        <span class="p">}</span>

    <span class="c1"># dataclass / attrs / pydantic / ì‚¬ìš©ì ì •ì˜ í´ë˜ìŠ¤
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># dataclass
</span>        <span class="k">if</span> <span class="nf">is_dataclass</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="nf">asdict</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">$id</span><span class="sh">"</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span> <span class="sh">"</span><span class="s">$type</span><span class="sh">"</span><span class="p">:</span> <span class="n">obj</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">,</span> <span class="sh">"</span><span class="s">fields</span><span class="sh">"</span><span class="p">:</span>
                    <span class="nf">to_jsonable</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">seen</span><span class="o">=</span><span class="n">seen</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">,</span> <span class="n">_depth</span><span class="o">=</span><span class="n">_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)}</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># attrs
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="n">attr</span>
        <span class="k">if</span> <span class="n">attr</span><span class="p">.</span><span class="nf">has</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">__class__</span><span class="p">):</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">attr</span><span class="p">.</span><span class="nf">asdict</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">$id</span><span class="sh">"</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span> <span class="sh">"</span><span class="s">$type</span><span class="sh">"</span><span class="p">:</span> <span class="n">obj</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">,</span> <span class="sh">"</span><span class="s">fields</span><span class="sh">"</span><span class="p">:</span>
                    <span class="nf">to_jsonable</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">seen</span><span class="o">=</span><span class="n">seen</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">,</span> <span class="n">_depth</span><span class="o">=</span><span class="n">_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)}</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># pydantic
</span>    <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">model_dump</span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">callable</span><span class="p">(</span><span class="nf">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">model_dump</span><span class="sh">"</span><span class="p">)):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">obj</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">$id</span><span class="sh">"</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span> <span class="sh">"</span><span class="s">$type</span><span class="sh">"</span><span class="p">:</span> <span class="n">obj</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">,</span> <span class="sh">"</span><span class="s">fields</span><span class="sh">"</span><span class="p">:</span>
                    <span class="nf">to_jsonable</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">seen</span><span class="o">=</span><span class="n">seen</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">,</span> <span class="n">_depth</span><span class="o">=</span><span class="n">_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)}</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="c1"># ì»¤ìŠ¤í…€ ë©”ì„œë“œë“¤
</span>    <span class="k">for</span> <span class="n">meth</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">__json__</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">to_json</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">to_dict</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">meth</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">callable</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="nf">fn</span><span class="p">()</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">$id</span><span class="sh">"</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span> <span class="sh">"</span><span class="s">$type</span><span class="sh">"</span><span class="p">:</span> <span class="n">obj</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">,</span> <span class="sh">"</span><span class="s">fields</span><span class="sh">"</span><span class="p">:</span>
                        <span class="nf">to_jsonable</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">seen</span><span class="o">=</span><span class="n">seen</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">,</span> <span class="n">_depth</span><span class="o">=</span><span class="n">_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)}</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="c1"># __getstate__ / __dict__
</span>    <span class="n">state</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">__getstate__</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">obj</span><span class="p">.</span><span class="nf">__getstate__</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="sh">"</span><span class="s">__dict__</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">__dict__</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">$id</span><span class="sh">"</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span> <span class="sh">"</span><span class="s">$type</span><span class="sh">"</span><span class="p">:</span> <span class="n">obj</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">,</span> <span class="sh">"</span><span class="s">state</span><span class="sh">"</span><span class="p">:</span>
                <span class="nf">to_jsonable</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">seen</span><span class="o">=</span><span class="n">seen</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">,</span> <span class="n">_depth</span><span class="o">=</span><span class="n">_depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)}</span>

    <span class="c1"># ë§ˆì§€ë§‰ ì•ˆì „íŒ
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">rep</span> <span class="o">=</span> <span class="nf">repr</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">rep</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">&lt;unreprable </span><span class="si">{</span><span class="n">obj</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="si">}</span><span class="s">&gt;</span><span class="sh">"</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">$id</span><span class="sh">"</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span> <span class="sh">"</span><span class="s">$type</span><span class="sh">"</span><span class="p">:</span> <span class="n">obj</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">,</span> <span class="sh">"</span><span class="s">repr</span><span class="sh">"</span><span class="p">:</span> <span class="n">rep</span><span class="p">,</span> <span class="sh">"</span><span class="s">$error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">fallback_repr</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ---------- 4) ìµœì¢… ìœ í‹¸ ----------
</span><span class="k">def</span> <span class="nf">pickle_to_json_bytes</span><span class="p">(</span><span class="n">pkl_bytes</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">safe</span><span class="sh">"</span><span class="p">,</span> <span class="n">allow</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                         <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">safe</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">trusted</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">mode must be </span><span class="sh">'</span><span class="s">safe</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">trusted</span><span class="sh">'"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">safe</span><span class="sh">"</span><span class="p">:</span>
        <span class="c1"># ì‚¬ì „ ì ê²€: ì–´ë–¤ í´ë˜ìŠ¤ê°€ í•„ìš”í•œì§€
</span>        <span class="n">needed</span> <span class="o">=</span> <span class="nf">audit_pickle_globals</span><span class="p">(</span><span class="n">pkl_bytes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">allow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">allow</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">allow</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">allow</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="c1"># numpy/pandas ë“± ìë™ í—ˆìš© (ìˆì„ ë•Œ)
</span>        <span class="k">if</span> <span class="n">np</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">allow</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span><span class="sh">"</span><span class="s">numpy.ndarray</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">numpy.dtype</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">numpy.core.numeric.complexfloating</span><span class="sh">"</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">pd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">allow</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span><span class="sh">"</span><span class="s">pandas.core.frame.DataFrame</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">pandas.core.series.Series</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">pandas.core.indexes.base.Index</span><span class="sh">"</span><span class="p">})</span>
        <span class="c1"># í•„ìš”í•˜ì§€ë§Œ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ì— ì—†ëŠ” ê²ƒ ìˆìœ¼ë©´ ê²½ê³ (ì—¬ê¸°ì„  ì˜ˆì™¸ë¡œ ëª…í™•íˆ)
</span>        <span class="n">missing</span> <span class="o">=</span> <span class="n">needed</span> <span class="o">-</span> <span class="n">allow</span> <span class="o">-</span> <span class="p">{</span>
            <span class="c1"># ì¢…ì¢… í”¼í´ ìŠ¤íŠ¸ë¦¼ì— ë“±ì¥í•˜ëŠ” builtins/eval ë³´ì¡°ë“¤ (ì´ë¯¸ Restrictedì—ì„œ ê¸°ë³¸ ê±°ë¦„)
</span>        <span class="p">}</span>
        <span class="c1"># ì‹¤ì œë¡œëŠ” ì‚¬ìš©ìì—ê²Œ ë¦¬ìŠ¤íŠ¸ë¥¼ ë³´ì—¬ì£¼ê³  ìŠ¹ì¸ë°›ëŠ” ê²Œ ê°€ì¥ ì•ˆì „
</span>        <span class="c1"># ì—¬ê¸°ì„œëŠ” 'í—ˆìš© ì•ˆ ëœ ì‹¬ë³¼ì´ ìˆë‹¤'ë©´ ì‹¤íŒ¨ ì²˜ë¦¬
</span>        <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">pickle</span><span class="p">.</span><span class="nc">UnpicklingError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unapproved classes in pickle: </span><span class="si">{</span><span class="nf">sorted</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="nf">restricted_loads</span><span class="p">(</span><span class="n">pkl_bytes</span><span class="p">,</span> <span class="n">allowed</span><span class="o">=</span><span class="n">allow</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># trusted
</span>        <span class="n">obj</span> <span class="o">=</span> <span class="n">pickle</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">pkl_bytes</span><span class="p">)</span>

    <span class="n">jsonable</span> <span class="o">=</span> <span class="nf">to_jsonable</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">jsonable</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="n">ensure_ascii</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">,</span> <span class="n">allow_nan</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="c1"># ì—­íŒŒì‹± ê²€ì¦
</span>    <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">txt</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ---------- 5) CLI ----------
</span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="kn">import</span> <span class="n">argparse</span><span class="p">,</span> <span class="n">os</span>
    <span class="n">ap</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">()</span>
    <span class="n">ap</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">input .pkl file</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">output .json file</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--mode</span><span class="sh">"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">safe</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">trusted</span><span class="sh">"</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">safe</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--allow</span><span class="sh">"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[],</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">extra allowed </span><span class="sh">'</span><span class="s">module.Class</span><span class="sh">'</span><span class="s"> (repeatable)</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--no-indent</span><span class="sh">"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">"</span><span class="s">store_true</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">ap</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nb">input</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">pkl</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>

    <span class="n">indent</span> <span class="o">=</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">no_indent</span> <span class="k">else</span> <span class="mi">2</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nf">pickle_to_json_bytes</span><span class="p">(</span><span class="n">pkl</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">allow</span><span class="o">=</span><span class="nf">set</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">allow</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span>

    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">output</span><span class="p">,</span> <span class="sh">"</span><span class="s">wb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Wrote </span><span class="si">{</span><span class="n">args</span><span class="p">.</span><span class="n">output</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="ì‚¬ìš©-ì˜ˆ">ì‚¬ìš© ì˜ˆ</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 1) ë¨¼ì € ì–´ë–¤ í´ë˜ìŠ¤ê°€ í•„ìš”í•œì§€ í™•ì¸ë§Œ í•´ë³´ë ¤ë©´ (ìŠ¤í¬ë¦½íŠ¸ ìˆ˜ì • ì—†ì´ ê°„ë‹¨ í™•ì¸)</span>
python <span class="nt">-c</span> <span class="s2">"import sys, pickletools; import pathlib; p=pathlib.Path(sys.argv[1]).read_bytes(); </span><span class="se">\</span><span class="s2">
print({(a.split('</span><span class="se">\n</span><span class="s2">')[0]+'.'+a.split('</span><span class="se">\n</span><span class="s2">')[1]) for (op,a,_) in pickletools.genops(p) if op.name in ('GLOBAL','STACK_GLOBAL')})"</span> mydata.pkl

<span class="c"># 2) ì•ˆì „ ëª¨ë“œì—ì„œ í—ˆìš© í´ë˜ìŠ¤ ì§€ì • í›„ ë³€í™˜</span>
python pickle_to_json.py mydata.pkl mydata.json <span class="nt">--mode</span> safe <span class="nt">--allow</span> mypkg.models.User <span class="nt">--allow</span> mypkg.models.Order

<span class="c"># 3) ì‹ ë¢° ëª¨ë“œ(ì¶œì²˜ê°€ í™•ì‹¤í•  ë•Œë§Œ)</span>
python pickle_to_json.py mydata.pkl mydata.json <span class="nt">--mode</span> trusted
</code></pre></div></div>

<hr />

<h1 id="ì‹¤ë¬´-íŒ-ì—ëŸ¬-ìµœì†Œí™”-í¬ì¸íŠ¸">ì‹¤ë¬´ íŒ (ì—ëŸ¬ ìµœì†Œí™” í¬ì¸íŠ¸)</h1>

<ol>
  <li>
    <p><strong>í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ëŠ” ì ì§„ì ìœ¼ë¡œ ë„“í˜€ë¼</strong><br />
ë¨¼ì € â€œë§‰ê³  â†’ í•„ìš”í•œ ê²ƒë§Œ í—ˆìš©â€ì´ ì•ˆì „í•˜ê³ , ì—ëŸ¬ë„ ì°¾ê¸° ì‰½ë‹¤. í—ˆìš©í•  ë•ŒëŠ” <strong>ì •í™•í•œ í’€ë„¤ì„(module.Class)</strong> ë¡œ.</p>
  </li>
  <li>
    <p><strong>ì»¤ìŠ¤í…€ í´ë˜ìŠ¤ì—<code class="language-plaintext highlighter-rouge">__json__</code> ë˜ëŠ” <code class="language-plaintext highlighter-rouge">to_dict()</code> ì¶”ê°€</strong><br />
í”„ë¡œì íŠ¸ ë‚´ë¶€ í´ë˜ìŠ¤ë¼ë©´ ì—¬ê¸°ì— ì§ë ¬í™” ê·œì¹™ì„ ë„£ì–´ë‘ë©´, ë³€í™˜ê¸°ê°€ ì•Œì•„ì„œ í˜¸ì¶œí•˜ë¯€ë¡œ ì‹¤íŒ¨ìœ¨ì´ í¬ê²Œ ì¤€ë‹¤.</p>
  </li>
  <li>
    <p><strong>ìˆœí™˜ ì°¸ì¡°ê°€ ë§ì€ ê·¸ë˜í”„ëŠ”<code class="language-plaintext highlighter-rouge">$id/$ref</code> ìŠ¤í‚´ í•„ìˆ˜</strong><br />
JSON ìˆœí™˜ì€ ë¶ˆê°€í•˜ë‹ˆ, ìœ„ ìŠ¤í‚´ ê°™ì€ <strong>ì°¸ì¡° í‘œí˜„</strong> ì„ ë°˜ë“œì‹œ ë„ì…í•´ì•¼ ë°ì´í„° ì†ì‹¤/ì˜¤ë¥˜ê°€ ì—†ë‹¤.</p>
  </li>
  <li>
    <p><strong>ê±°ëŒ€í•œ ë°°ì—´/ë°ì´í„°í”„ë ˆì„ì€ ë³„ë„ íŒŒì¼ ê³ ë ¤</strong><br />
JSONì€ ìš©ëŸ‰/ì†ë„ì— ì•½í•˜ë‹¤. ì •ë§ í¬ë©´ <code class="language-plaintext highlighter-rouge">.npy</code>ë‚˜ <code class="language-plaintext highlighter-rouge">.parquet</code>ë¥¼ <strong>ì‚¬ì´ë“œì¹´</strong> ë¡œ ì €ì¥í•˜ê³  JSONì—ëŠ” ë©”íƒ€/ê²½ë¡œë§Œ ë„£ëŠ” ì „ëµì´ ì¢‹ë‹¤.</p>
  </li>
  <li>
    <p><strong>ë¤í”„ ì „ì— ë³€í™˜ë§Œ ë¨¼ì € ì‹¤í–‰í•´ë³´ê¸°</strong><br />
<code class="language-plaintext highlighter-rouge">to_jsonable(obj)</code> ê²°ê³¼ë¥¼ í•œ ë²ˆ ì°ì–´ë³´ë©´ ì–´ë–¤ íƒ€ì…ì´ ì–´ë–»ê²Œ ë‚˜ì˜¤ëŠ”ì§€ ë°”ë¡œ íŒŒì•… ê°€ëŠ¥. ì‹¤íŒ¨ ì§€ì ì´ ë“œëŸ¬ë‚œë‹¤.</p>
  </li>
  <li>
    <p><strong>ë¡œìŠ¤ë¦¬ìŠ¤ê°€ ì¤‘ìš”í•˜ë©´ íƒ€ì… ë©”íƒ€ë¥¼ ê¼­ ë‚¨ê²¨ë¼</strong><br />
<code class="language-plaintext highlighter-rouge">"$type"</code>, <code class="language-plaintext highlighter-rouge">shape</code>, <code class="language-plaintext highlighter-rouge">dtype</code> ê°™ì€ ë©”íƒ€ê°€ ì¬êµ¬ì„±ì— í•„ìˆ˜ë‹¤.</p>
  </li>
  <li>
    <p><strong>í…ŒìŠ¤íŠ¸</strong></p>

    <ul>
      <li>
        <p>ì‘ì€ ìƒ˜í”Œ í”¼í´ë¡œ ì‹œì‘ â†’ ì ì§„ í™•ëŒ€</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">json.loads(dumps(...))</code> ì—­íŒŒì‹± ê²€ì¦</p>
      </li>
      <li>
        <p>ëŒ€í‘œ ì¼€ì´ìŠ¤: set/tuple/bytes/datetime/enum/numpy/pandas/ì»¤ìŠ¤í…€ í´ë˜ìŠ¤ë¥¼ ëª¨ë‘ í¬í•¨í•˜ëŠ” í•©ì„± í…ŒìŠ¤íŠ¸</p>
      </li>
    </ul>
  </li>
</ol>

<hr />

<p>ì›í•˜ë©´ ìœ„ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë„¤ ìƒí™©ì— ë§ê²Œ ë” ìµœì†Œ/ê°„ê²°í™”í•˜ê±°ë‚˜, <code class="language-plaintext highlighter-rouge">jsonpickle</code>ì„ í™œìš©í•œ ì´ˆê°„ë‹¨ ë²„ì „ë„ ë§Œë“¤ì–´ì¤„ê²Œ.</p>

<p class="chat--user">

1. ê·¸ëƒ¥ ëª¨ë“ ê±¸ trustë¡œ í•˜ê³  ì‹¶ì–´. ëª¨ë‘ ë‚´ê°€ ë§Œë“  íŒŒì¼ë“¤ì´ì•¼. 2. ì§ˆë¬¸. íŒŒì´ì¬ ë²„ì „ì€ ìƒê´€ ì—†ì„ê¹Œ? 3. jsonpickleì„ ì‚¬ìš©í•´ì„œ ê°„ë‹¨í•´ì§„ë‹¤ë©´ ê·¸ë ‡ê²Œ í•´ì¤˜

</p>

<p>ì¢‹ì•„! ë„¤ 3ê°€ì§€ ì¡°ê±´(1. ì „ë¶€ trust ëª¨ë“œ, 2. íŒŒì´ì¬ ë²„ì „ ì´ìŠˆ, 3. jsonpickleë¡œ ê°„ë‹¨íˆ) ê¸°ì¤€ìœ¼ë¡œ, ì—ëŸ¬ë¥¼ ìµœì†Œí™”í•˜ëŠ” <strong>ì‹¤ì „ìš© ì ˆì°¨ + ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” ìŠ¤í¬ë¦½íŠ¸</strong> ê¹Œì§€ ì¤€ë¹„í–ˆì–´.</p>

<h1 id="step-by-step">Step by Step</h1>

<h2 id="1-ì „ëµ-ìš”ì•½-trust-ëª¨ë“œ">1) ì „ëµ ìš”ì•½ (Trust ëª¨ë“œ)</h2>

<ul>
  <li>
    <p><strong>ì „ì œ</strong> : í”¼í´ì€ ì „ë¶€ ë„¤ê°€ ë§Œë“  íŒŒì¼ â†’ <code class="language-plaintext highlighter-rouge">pickle.load</code>ë¡œ ê³§ë°”ë¡œ ë¡œë“œí•˜ê³ , ê·¸ ê°ì²´ë¥¼ <strong>jsonpickle</strong> ë¡œ JSON ë³€í™˜.</p>
  </li>
  <li>
    <p><strong>ì´ì </strong> : ì»¤ìŠ¤í…€ í´ë˜ìŠ¤/ìˆœí™˜ ì°¸ì¡°/ê³µìœ  ì°¸ì¡°ë¥¼ jsonpickleì´ ìë™ ì²˜ë¦¬(<code class="language-plaintext highlighter-rouge">py/object</code>, <code class="language-plaintext highlighter-rouge">py/id</code>, <code class="language-plaintext highlighter-rouge">py/ref</code> ë©”íƒ€).</p>
  </li>
  <li>
    <p><strong>ì„ íƒì§€</strong> :</p>

    <ul>
      <li>
        <p>íƒ€ì… ë³µì› ë©”íƒ€ í¬í•¨(ê¸°ë³¸): <code class="language-plaintext highlighter-rouge">unpicklable=True</code> â†’ ë¡œìŠ¤ë¦¬ìŠ¤ì— ê°€ê¹Œìš´ í‘œí˜„.</p>
      </li>
      <li>
        <p><strong>ìˆœìˆ˜ JSONë§Œ</strong>(íƒ€ì… ë©”íƒ€ ì œê±°): <code class="language-plaintext highlighter-rouge">unpicklable=False</code> â†’ ì•„ì£¼ ê¹”ë”í•˜ì§€ë§Œ, íƒ€ì…/ì°¸ì¡° ë³µì› ë¶ˆê°€.</p>
      </li>
    </ul>
  </li>
</ul>

<h2 id="2-íŒŒì´ì¬-ë²„ì „-í˜¸í™˜ì„±-í•„ìˆ˜-ì²´í¬">2) íŒŒì´ì¬ ë²„ì „ í˜¸í™˜ì„± (í•„ìˆ˜ ì²´í¬)</h2>

<ul>
  <li>
    <p><strong>ê°™ê±°ë‚˜ ë” ìƒˆ ë²„ì „ì˜ íŒŒì´ì¬</strong> ì—ì„œ ë¡œë“œí•˜ì. (ì˜ˆ: Py 3.8ì—ì„œ ë§Œë“  í”¼í´ â†’ Py 3.8 ì´ìƒì—ì„œ ë¡œë“œ ê¶Œì¥)</p>
  </li>
  <li>
    <p>í”¼í´ <strong>í”„ë¡œí† ì½œ</strong> ì€ â€œì‹ ë²„ì „ì´ êµ¬ë²„ì „ ì½ê¸° OK, ê·¸ ë°˜ëŒ€ëŠ” ì¢…ì¢… ë¶ˆê°€â€ê°€ ì¼ë°˜ì .</p>
  </li>
  <li>
    <p><strong>í´ë˜ìŠ¤ import ê°€ëŠ¥ì„±</strong> : í”¼í´ ì•ˆì— ì €ì¥ëœ ëª¨ë“ˆ/í´ë˜ìŠ¤ ê²½ë¡œê°€ í˜„ì¬ í™˜ê²½ì—ì„œ <strong>import</strong> ë˜ì–´ì•¼ ì–¸í”¼í´ ì„±ê³µ.</p>

    <ul>
      <li>ì¦‰, í”„ë¡œì íŠ¸ ì½”ë“œê°€ <code class="language-plaintext highlighter-rouge">PYTHONPATH</code> ì— ìˆì–´ì•¼ í•˜ê³ , <strong>ëª¨ë“ˆ/í´ë˜ìŠ¤ ì´ë¦„ì´ ë°”ë€Œì§€ ì•Šì•„ì•¼</strong> í•´.</li>
    </ul>
  </li>
  <li>
    <p>(êµ¬í”¼í´) Python 2ì—ì„œ ë§Œë“  í”¼í´ì´ë¼ë©´ Py3ì—ì„œ <code class="language-plaintext highlighter-rouge">encoding='latin1'</code> ì˜µì…˜ì´ í•„ìš”í•  ìˆ˜ ìˆìŒ.</p>
  </li>
</ul>

<h2 id="3-jsonpickleë¡œ-ê°„ë‹¨íŠ¼íŠ¼í•˜ê²Œ-ë³€í™˜">3) jsonpickleë¡œ ê°„ë‹¨/íŠ¼íŠ¼í•˜ê²Œ ë³€í™˜</h2>

<ul>
  <li>
    <p><strong>í•µì‹¬ í•œ ì¤„</strong> : <code class="language-plaintext highlighter-rouge">jsonpickle.encode(obj, unpicklable=..., make_refs=..., max_depth=...)</code></p>
  </li>
  <li>
    <p><strong>í•¸ë“¤ëŸ¬ ë“±ë¡</strong> : NumPy/Pandasê°€ ìˆë‹¤ë©´ <code class="language-plaintext highlighter-rouge">jsonpickle.ext.numpy.register_handlers()</code>, <code class="language-plaintext highlighter-rouge">jsonpickle.ext.pandas.register_handlers()</code> í˜¸ì¶œë¡œ ë°°ì—´/ë°ì´í„°í”„ë ˆì„ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì§ë ¬í™”.</p>
  </li>
  <li>
    <p><strong>Strict JSON</strong> í•„ìš”í•˜ë©´: <code class="language-plaintext highlighter-rouge">allow_nan=False</code> (NaN/Infinity ê¸ˆì§€) ë¥¼ ë°±ì—”ë“œ ì˜µì…˜ìœ¼ë¡œ ì§€ì •.</p>
  </li>
  <li>
    <p><strong>ëŒ€ìš©ëŸ‰</strong> ì´ë©´: ë“¤ì—¬ì“°ê¸° <code class="language-plaintext highlighter-rouge">None</code>(ì••ì¶•), í•„ìš” ì‹œ <code class="language-plaintext highlighter-rouge">sort_keys=False</code> ìœ ì§€ë¡œ ì„±ëŠ¥/ìš©ëŸ‰ ìµœì†Œí™”.</p>
  </li>
</ul>

<hr />

<h1 id="ë°”ë¡œ-ì‹¤í–‰-ê°€ëŠ¥í•œ-ìŠ¤í¬ë¦½íŠ¸">ë°”ë¡œ ì‹¤í–‰ ê°€ëŠ¥í•œ ìŠ¤í¬ë¦½íŠ¸</h1>

<p>ë‚´ê°€ <strong>trust ëª¨ë“œ ì „ìš© ë³€í™˜ ìŠ¤í¬ë¦½íŠ¸</strong> ë¥¼ ë§Œë“¤ì–´ ë’€ì–´. ì˜µì…˜ìœ¼ë¡œ ìˆœìˆ˜ JSON, ì°¸ì¡° íŠ¸ë˜í‚¹, strict JSON, ë“¤ì—¬ì“°ê¸° ë“± ì„¸ë°€ ì œì–´ê°€ ê°€ëŠ¥í•´.</p>

<p>Download: <code class="language-plaintext highlighter-rouge">pickle_to_json_trusted.py</code></p>

<h2 id="ì‚¬ìš©ë²•-ì˜ˆì‹œ">ì‚¬ìš©ë²• ì˜ˆì‹œ</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 1) ê¸°ë³¸: íƒ€ì…/ì°¸ì¡° ë©”íƒ€ ìœ ì§€ (ê¶Œì¥: ë¡œìŠ¤ë¦¬ìŠ¤ì— ê°€ê¹Œì›€)</span>
python pickle_to_json_trusted.py mydata.pkl mydata.json

<span class="c"># 2) ìˆœìˆ˜ JSON(ë©”íƒ€ ì œê±°) â€” ì‚¬ëŒì´ ì½ê¸°/íƒ€ ì‹œìŠ¤í…œ êµí™˜ì— ì¢‹ìŒ</span>
python pickle_to_json_trusted.py mydata.pkl mydata.json <span class="nt">--pure</span>

<span class="c"># 3) ì‚¬ì´í´ì´ ì—†ê³  ì°¸ì¡° ì¶”ì ì´ ë¶ˆí•„ìš”í•˜ë‹¤ë©´ ì•½ê°„ ë” ë‹¨ìˆœí™”</span>
python pickle_to_json_trusted.py mydata.pkl mydata.json <span class="nt">--no-refs</span>

<span class="c"># 4) Strict JSON (NaN/Infinity ê¸ˆì§€), ì»´íŒ©íŠ¸ ì¶œë ¥</span>
python pickle_to_json_trusted.py mydata.pkl mydata.json <span class="nt">--strict</span> <span class="nt">--no-indent</span>

<span class="c"># 5) NumPy/Pandasê°€ ìˆë‹¤ë©´ ìë™ í•¸ë“¤ëŸ¬ ë“±ë¡ë¨(ë³„ë„ ì˜µì…˜ ë¶ˆí•„ìš”)</span>

<span class="c"># 6) ì •ë³´ ì¶œë ¥(í”„ë¡œí† ì½œ/ê¸€ë¡œë²Œ ì‹¬ë³¼ í›‘ì–´ë³´ê¸°)</span>
python pickle_to_json_trusted.py mydata.pkl mydata.json <span class="nt">--info</span>

<span class="c"># 7) (ë ˆê±°ì‹œ) Python 2ì—ì„œ ë§Œë“  í”¼í´ì´ë¼ë©´</span>
python pickle_to_json_trusted.py mydata.pkl mydata.json <span class="nt">--py2-latin1</span>
</code></pre></div></div>

<p>ì¶œë ¥ ëª¨ë“œì— ë”°ë¥¸ JSON í˜•íƒœëŠ” ëŒ€ëµ ë‹¤ìŒê³¼ ê°™ì•„:</p>

<ul>
  <li>
    <p><strong>ê¸°ë³¸(ë©”íƒ€ í¬í•¨)</strong> : ê° ê°ì²´ì— <code class="language-plaintext highlighter-rouge">py/object</code>, ì°¸ì¡°ì—” <code class="language-plaintext highlighter-rouge">py/id</code>/<code class="language-plaintext highlighter-rouge">py/ref</code>ê°€ ë¶™ìŒ â†’ ë³µì› ì¹œí™”ì .</p>
  </li>
  <li>
    <p><strong>--pure</strong> : í‘œì¤€ JSONë§Œ ë‚¨ê¹€ â†’ ìµœëŒ€ í˜¸í™˜ì„±, ëŒ€ì‹  íƒ€ì…/ì°¸ì¡° ì •ë³´ëŠ” ì‚¬ë¼ì§.</p>
  </li>
</ul>

<hr />

<h1 id="ì—ëŸ¬ë¥¼-ë”-ì¤„ì´ëŠ”-íŒ">ì—ëŸ¬ë¥¼ ë” ì¤„ì´ëŠ” íŒ</h1>

<ol>
  <li>
    <p><strong>ëŸ°íƒ€ì„ ì •í•©ì„±</strong></p>

    <ul>
      <li>
        <p>ì–¸í”¼í´ ì‹œ <code class="language-plaintext highlighter-rouge">ModuleNotFoundError</code>, <code class="language-plaintext highlighter-rouge">AttributeError</code>ê°€ ë‚˜ë©´, í˜„ì¬ í™˜ê²½ì—ì„œ í•„ìš”í•œ ëª¨ë“ˆ/í´ë˜ìŠ¤ê°€ <strong>ê·¸ëŒ€ë¡œ import ê°€ëŠ¥</strong> í•œì§€ í™•ì¸.</p>
      </li>
      <li>
        <p>íŒ¨í‚¤ì§€/ëª¨ë“ˆ ì´ë¦„ ë³€ê²½, í´ë˜ìŠ¤ ì´ë™ì´ ìˆì—ˆë‹¤ë©´ ì„ì‹œ í˜¸í™˜ ë ˆì´ì–´(êµ¬ì´ë¦„ alias) ì¶”ê°€ê°€ í˜„ì‹¤ì .</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ë©”ëª¨ë¦¬/ì„±ëŠ¥</strong></p>

    <ul>
      <li>
        <p>ë§¤ìš° í° ë°°ì—´/í”„ë ˆì„ì€ <code class="language-plaintext highlighter-rouge">--no-indent</code>ë¡œ ìš©ëŸ‰ ì¤„ì´ê¸°.</p>
      </li>
      <li>
        <p>ì •ë§ í° ìˆ˜ì¹˜ ë°ì´í„°ëŠ” JSON ëŒ€ì‹  <strong>ì‚¬ì´ë“œì¹´ í¬ë§·</strong>(ì˜ˆ: <code class="language-plaintext highlighter-rouge">.npy</code>/<code class="language-plaintext highlighter-rouge">.parquet</code>) ê³ ë ¤ í›„ JSONì—ëŠ” ë©”íƒ€/ê²½ë¡œë§Œ ë‹´ëŠ” ì „ëµë„ ê°€ëŠ¥.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ì•ˆì „/ì •í•©ì„± ê²€ì¦</strong></p>

    <ul>
      <li>ìƒì„±ëœ JSONì„ í•œ ë²ˆ <code class="language-plaintext highlighter-rouge">json.loads</code>ë¡œ ì—­íŒŒì‹±í•˜ë©´ ë¬¸ë²• ì‹¤ìˆ˜ë¥¼ ì¡°ê¸°ì— ë°œê²¬.</li>
    </ul>
  </li>
</ol>

<hr />

<h1 id="ìš”ì•½-ë‹µë³€">ìš”ì•½ ë‹µë³€</h1>

<ol>
  <li>
    <p><strong>Trustë¡œ ê°€ì</strong> â†’ <code class="language-plaintext highlighter-rouge">pickle.load</code> í›„ <code class="language-plaintext highlighter-rouge">jsonpickle.encode</code> ê°€ ê°€ì¥ ê°„ë‹¨/ë²”ìš©.</p>
  </li>
  <li>
    <p><strong>íŒŒì´ì¬ ë²„ì „</strong> ì€ â€œê°™ê±°ë‚˜ ë” ìµœì‹ â€ì„ ì“°ë©´ ëŒ€ë¶€ë¶„ ì•ˆì „. (íŠ¹íˆ Py â‰¥3.8ì´ë©´ í”„ë¡œí† ì½œ 5 ëŒ€ì‘ OK.) ëª¨ë“ˆ/í´ë˜ìŠ¤ ê²½ë¡œê°€ ë™ì¼í•˜ê²Œ import ê°€ëŠ¥í•´ì•¼ í•¨.</p>
  </li>
  <li>
    <p><strong>jsonpickle ì‚¬ìš©</strong> ì´ ê°€ì¥ ì†ì‰¬ì›€. ìœ„ ìŠ¤í¬ë¦½íŠ¸ë¡œ ë°”ë¡œ ê°€ëŠ¥í•˜ê³ , í•„ìš” ì‹œ <code class="language-plaintext highlighter-rouge">--pure</code>(ë©”íƒ€ ì œê±°), <code class="language-plaintext highlighter-rouge">--strict</code>(NaN ê¸ˆì§€), <code class="language-plaintext highlighter-rouge">--no-indent</code>(ëŒ€ìš©ëŸ‰) ë“± ì˜µì…˜ìœ¼ë¡œ ìƒí™© ë§ì¶¤í™”í•˜ë©´ ë¼.</p>
  </li>
</ol>

<p>ì›í•˜ë©´ <code class="language-plaintext highlighter-rouge">py/object</code> ë©”íƒ€ í¬ë§· ëŒ€ì‹ , ì•„ì˜ˆ <code class="language-plaintext highlighter-rouge">$type</code> ê°™ì€ ì»¤ìŠ¤í…€ ìŠ¤í‚´ìœ¼ë¡œ ë°”ê¾¼ ë¯¸ë‹ˆ ì§ë ¬í™”ê¸°ë„ ë§Œë“¤ì–´ì¤„ ìˆ˜ ìˆì–´.</p>

<p class="chat--user">

ë³¸ë¬¸ì— ê·¸ëƒ¥ ì¨ì£¼ê³ , ì»¤ìŠ¤í…€ í´ë˜ìŠ¤ import ëŠ” ì–´ë–¤ ì‹ìœ¼ë¡œ í•´ì•¼í•´?

</p>

<p>ì¢‹ì•„â€”<strong>trust ëª¨ë“œ + jsonpickle</strong> ë¡œ â€œí”¼í´ â†’ JSONâ€ì„ <strong>ê°„ë‹¨/íŠ¼íŠ¼</strong> í•˜ê²Œ ì²˜ë¦¬í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë³¸ë¬¸ì— ë°”ë¡œ ë„£ì–´ë‘˜ê²Œ.<br />
ê·¸ë¦¬ê³  <strong>ì»¤ìŠ¤í…€ í´ë˜ìŠ¤ import</strong> ëŠ” ì–´ë–»ê²Œ í•´ì•¼ ì–¸í”¼í´ì´ ì˜ ë˜ëŠ”ì§€, ê°€ì¥ ì‹¤ì „ì ì¸ ë°©ë²•ë“¤ì„ ì•„ë˜ì— ì •ë¦¬í–ˆì–´.</p>

<hr />

<h1 id="step-by-step-1">Step by Step</h1>

<ol>
  <li>
    <p><strong>ì „ì œ</strong> : ì „ë¶€ ë„¤ê°€ ë§Œë“  í”¼í´ â†’ <code class="language-plaintext highlighter-rouge">pickle.load</code>(trust)ë¡œ ë¡œë“œí•´ë„ ë¨.</p>
  </li>
  <li>
    <p><strong>ë²„ì „</strong> : í”¼í´ì„ ë§Œë“  íŒŒì´ì¬ <strong>ë™ì¼ ë˜ëŠ” ë” ìµœì‹  ë²„ì „</strong> ì—ì„œ ë¡œë“œ(íŠ¹íˆ ëª¨ë“ˆ ê²½ë¡œê°€ ë™ì¼í•˜ê²Œ import ê°€ëŠ¥í•´ì•¼ í•¨).</p>
  </li>
  <li>
    <p><strong>í•µì‹¬</strong> : ë¡œë“œí•œ ê°ì²´ë¥¼ <code class="language-plaintext highlighter-rouge">jsonpickle.encode(...)</code>ë¡œ JSON ë³€í™˜.</p>
  </li>
  <li>
    <p><strong>ëŒ€ìš©ëŸ‰/í˜¸í™˜ì„± ì˜µì…˜</strong> :</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">--pure</code> â†’ íƒ€ì… ë©”íƒ€ ì œê±°(ì•„ì£¼ ê¹”ë”í•œ JSON), ëŒ€ì‹  ë³µì› ë¶ˆê°€.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">--no-refs</code> â†’ ì°¸ì¡°/ì‚¬ì´í´ ì¶”ì  ë¹„í™œì„±í™”(ê°„ë‹¨í•˜ì§€ë§Œ ê³µìœ ì°¸ì¡° ì •ë³´ ì‚¬ë¼ì§).</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">--strict</code> â†’ NaN/Infinity ê¸ˆì§€(ì •-í‘œì¤€ JSON).</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">--no-indent</code> â†’ ìš©ëŸ‰ ìµœì†Œí™”.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ì»¤ìŠ¤í…€ í´ë˜ìŠ¤ import</strong> ëŠ” â€œí˜„ì¬ í”„ë¡œì„¸ìŠ¤ì—ì„œ í•´ë‹¹ ëª¨ë“ˆì„ <strong>ì •í™•íˆ import ê°€ëŠ¥</strong> â€í•´ì•¼ í•¨. ì•„ë˜ â€œImport ìš”ë ¹â€ ì°¸ê³ .</p>
  </li>
</ol>

<hr />

<h1 id="ì‹ ë¢°-ëª¨ë“œ-ì „ìš©-ìŠ¤í¬ë¦½íŠ¸-jsonpickle-ì‚¬ìš©">ì‹ ë¢° ëª¨ë“œ ì „ìš© ìŠ¤í¬ë¦½íŠ¸ (jsonpickle ì‚¬ìš©)</h1>

<p>ì•„ë˜ ì½”ë“œë¥¼ <code class="language-plaintext highlighter-rouge">pickle_to_json_trusted.py</code>ë¡œ ì €ì¥í•´ì„œ ë°”ë¡œ ì¨.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
# pickle_to_json_trusted.py
# Trust-mode: loads your own pickle files, then encodes to JSON with jsonpickle.
</span>
<span class="kn">import</span> <span class="n">argparse</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">pickle</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">traceback</span><span class="p">,</span> <span class="n">importlib</span>
<span class="kn">import</span> <span class="n">pickletools</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">jsonpickle</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ERROR: jsonpickle is required. Install with: pip install jsonpickle</span><span class="sh">"</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="k">raise</span>

<span class="k">def</span> <span class="nf">register_optional_exts</span><span class="p">():</span>
    <span class="c1"># Optional handlers for numpy/pandas if available
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="n">jsonpickle.ext</span> <span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">jsonpickle_numpy</span>
        <span class="n">jsonpickle_numpy</span><span class="p">.</span><span class="nf">register_handlers</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="n">jsonpickle.ext</span> <span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">jsonpickle_pandas</span>
        <span class="n">jsonpickle_pandas</span><span class="p">.</span><span class="nf">register_handlers</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="k">def</span> <span class="nf">peek_protocol</span><span class="p">(</span><span class="n">pkl_bytes</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">pickletools</span><span class="p">.</span><span class="nf">genops</span><span class="p">(</span><span class="n">pkl_bytes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">op</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">PROTO</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">arg</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">scan_globals</span><span class="p">(</span><span class="n">pkl_bytes</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span>
    <span class="n">refs</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">pickletools</span><span class="p">.</span><span class="nf">genops</span><span class="p">(</span><span class="n">pkl_bytes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">op</span><span class="p">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">GLOBAL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STACK_GLOBAL</span><span class="sh">"</span><span class="p">):</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="n">mod</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">arg</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">parts</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">arg</span><span class="p">).</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">mod</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="n">refs</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">mod</span><span class="si">}</span><span class="s">.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">refs</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">ap</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Trust-mode: Convert a Python pickle to JSON using jsonpickle.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Input .pkl file path</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">output</span><span class="sh">"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Output .json file path</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># JSON shape options
</span>    <span class="n">ap</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--pure</span><span class="sh">"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">"</span><span class="s">store_true</span><span class="sh">"</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Emit plain JSON (unpicklable=False) without py/object metadata.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--no-refs</span><span class="sh">"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">"</span><span class="s">store_true</span><span class="sh">"</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Do not track object references/cycles (make_refs=False).</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--max-depth</span><span class="sh">"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Limit traversal depth (None = unlimited).</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--indent</span><span class="sh">"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Pretty-print indent (use 0 or --no-indent for compact).</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--no-indent</span><span class="sh">"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">"</span><span class="s">store_true</span><span class="sh">"</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Compact JSON (indent=None).</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--ensure-ascii</span><span class="sh">"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">"</span><span class="s">store_true</span><span class="sh">"</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Escape non-ASCII characters.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--strict</span><span class="sh">"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">"</span><span class="s">store_true</span><span class="sh">"</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Disallow NaN/Infinity (allow_nan=False).</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--sort-keys</span><span class="sh">"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">"</span><span class="s">store_true</span><span class="sh">"</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Sort JSON object keys.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--info</span><span class="sh">"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">"</span><span class="s">store_true</span><span class="sh">"</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Print pickle protocol &amp; referenced globals before converting.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--py2-latin1</span><span class="sh">"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">"</span><span class="s">store_true</span><span class="sh">"</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">If the pickle came from Python 2, try encoding=</span><span class="sh">'</span><span class="s">latin1</span><span class="sh">'</span><span class="s">.</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># Import help (for custom classes)
</span>    <span class="n">ap</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--sys-path</span><span class="sh">"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
                    <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Prepend a path to sys.path (repeatable).</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--preload</span><span class="sh">"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
                    <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Import module(s) before unpickling, e.g. mypkg.models (repeatable).</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">--alias</span><span class="sh">"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">"</span><span class="s">append</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
                    <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Module alias mapping OLD=NEW (repeatable).</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">ap</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="c1"># sys.path adjustments for project importability
</span>    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">args</span><span class="p">.</span><span class="n">sys_path</span><span class="p">:</span>
        <span class="n">sys</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>

    <span class="c1"># module aliasing (module path changed)
</span>    <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">args</span><span class="p">.</span><span class="n">alias</span><span class="p">:</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pair</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">WARNING: --alias expects OLD=NEW, got </span><span class="si">{</span><span class="n">pair</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">old</span><span class="p">,</span> <span class="n">new</span> <span class="o">=</span> <span class="n">pair</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">new_mod</span> <span class="o">=</span> <span class="n">importlib</span><span class="p">.</span><span class="nf">import_module</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="n">modules</span><span class="p">[</span><span class="n">old</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_mod</span>

    <span class="c1"># preload modules so that pickle can resolve classes
</span>    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">args</span><span class="p">.</span><span class="n">preload</span><span class="p">:</span>
        <span class="n">importlib</span><span class="p">.</span><span class="nf">import_module</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="c1"># read pickle bytes
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nb">input</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pkl_bytes</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ERROR: file not found: </span><span class="si">{</span><span class="n">args</span><span class="p">.</span><span class="nb">input</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">info</span><span class="p">:</span>
        <span class="n">proto</span> <span class="o">=</span> <span class="nf">peek_protocol</span><span class="p">(</span><span class="n">pkl_bytes</span><span class="p">)</span>
        <span class="n">globs</span> <span class="o">=</span> <span class="nf">scan_globals</span><span class="p">(</span><span class="n">pkl_bytes</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[info] protocol: </span><span class="si">{</span><span class="n">proto</span> <span class="k">if</span> <span class="n">proto</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="sh">'</span><span class="s">unknown</span><span class="sh">'</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">globs</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[info] referenced globals (</span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">globs</span><span class="p">)</span><span class="si">}</span><span class="s">):</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">globs</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  - </span><span class="si">{</span><span class="n">g</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[info] referenced globals: (none found)</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># jsonpickle backend setup
</span>    <span class="nf">register_optional_exts</span><span class="p">()</span>
    <span class="n">jsonpickle</span><span class="p">.</span><span class="nf">set_preferred_backend</span><span class="p">(</span><span class="sh">'</span><span class="s">json</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">indent</span> <span class="o">=</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">no_indent</span> <span class="k">else</span> <span class="n">args</span><span class="p">.</span><span class="n">indent</span>
    <span class="c1"># encoder opts
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">jsonpickle</span><span class="p">.</span><span class="nf">set_encoder_options</span><span class="p">(</span>
            <span class="sh">'</span><span class="s">json</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">ensure_ascii</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">ensure_ascii</span><span class="p">,</span>
            <span class="n">allow_nan</span><span class="o">=</span><span class="ow">not</span> <span class="n">args</span><span class="p">.</span><span class="n">strict</span><span class="p">,</span>
            <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">,</span>
            <span class="n">sort_keys</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">sort_keys</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="nb">TypeError</span><span class="p">:</span>
        <span class="n">jsonpickle</span><span class="p">.</span><span class="nf">set_encoder_options</span><span class="p">(</span><span class="sh">'</span><span class="s">json</span><span class="sh">'</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">ensure_ascii</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span>

    <span class="c1"># unpickle (TRUST)
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="n">io</span>
        <span class="n">bio</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="nc">BytesIO</span><span class="p">(</span><span class="n">pkl_bytes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">py2_latin1</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">pickle</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">'</span><span class="s">latin1</span><span class="sh">'</span><span class="p">,</span> <span class="n">fix_imports</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">pickle</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">bio</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">ModuleNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ERROR: Required module isn</span><span class="sh">'</span><span class="s">t importable.</span><span class="sh">"</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Detail: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Tip: Use --sys-path/--preload/--alias or set PYTHONPATH.</span><span class="sh">"</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ERROR: Class/attribute moved or renamed.</span><span class="sh">"</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Detail: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ERROR: Unpickling failed.</span><span class="sh">"</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">traceback</span><span class="p">.</span><span class="nf">print_exc</span><span class="p">()</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># encode with jsonpickle
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">json_str</span> <span class="o">=</span> <span class="n">jsonpickle</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span>
            <span class="n">obj</span><span class="p">,</span>
            <span class="n">unpicklable</span><span class="o">=</span><span class="ow">not</span> <span class="n">args</span><span class="p">.</span><span class="n">pure</span><span class="p">,</span>
            <span class="n">make_refs</span><span class="o">=</span><span class="ow">not</span> <span class="n">args</span><span class="p">.</span><span class="n">no_refs</span><span class="p">,</span>
            <span class="n">max_depth</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">max_depth</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ERROR: jsonpickle encoding failed.</span><span class="sh">"</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">traceback</span><span class="p">.</span><span class="nf">print_exc</span><span class="p">()</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1"># write
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">output</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ERROR: writing output failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Wrote </span><span class="si">{</span><span class="n">args</span><span class="p">.</span><span class="n">output</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="ì‹¤í–‰-ì˜ˆ">ì‹¤í–‰ ì˜ˆ</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># (ê°€ì¥ ê¸°ë³¸) íƒ€ì…/ì°¸ì¡° ë©”íƒ€ ìœ ì§€: ë³µì› ì¹œí™”ì </span>
python pickle_to_json_trusted.py data.pkl data.json

<span class="c"># ìˆœìˆ˜ JSON (ë©”íƒ€ ì œê±°)</span>
python pickle_to_json_trusted.py data.pkl data.json <span class="nt">--pure</span>

<span class="c"># ì‚¬ì´í´/ì°¸ì¡° ì¶”ì  ë„ê¸° + ì»´íŒ©íŠ¸ + Strict JSON</span>
python pickle_to_json_trusted.py data.pkl data.json <span class="nt">--no-refs</span> <span class="nt">--no-indent</span> <span class="nt">--strict</span>

<span class="c"># í”¼í´ ì •ë³´(í”„ë¡œí† ì½œ/ê¸€ë¡œë²Œ): ë””ë²„ê¹…ìš©</span>
python pickle_to_json_trusted.py data.pkl data.json <span class="nt">--info</span>
</code></pre></div></div>

<hr />

<h1 id="ì»¤ìŠ¤í…€-í´ë˜ìŠ¤-import--ì´ë ‡ê²Œ-í•˜ë©´-ëœë‹¤-ì‹¤ì „-ë ˆì‹œí”¼">ì»¤ìŠ¤í…€ í´ë˜ìŠ¤ import â€” ì´ë ‡ê²Œ í•˜ë©´ ëœë‹¤ (ì‹¤ì „ ë ˆì‹œí”¼)</h1>

<p>ì–¸í”¼í´ì´ ì»¤ìŠ¤í…€ í´ë˜ìŠ¤ë¥¼ ë³µì›í•˜ë ¤ë©´, <strong>í”¼í´ì— ê¸°ë¡ëœ â€œëª¨ë“ˆ.í´ë˜ìŠ¤â€ê°€ í˜„ì¬ ëŸ°íƒ€ì„ì—ì„œ import ê°€ëŠ¥</strong> í•´ì•¼ í•´.</p>

<h2 id="1-ê°€ì¥-ê¹”ë”-í”„ë¡œì íŠ¸ë¥¼-íŒ¨í‚¤ì§€ë¡œ-ì„¤ì¹˜">1) ê°€ì¥ ê¹”ë”: í”„ë¡œì íŠ¸ë¥¼ íŒ¨í‚¤ì§€ë¡œ ì„¤ì¹˜</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í”„ë¡œì íŠ¸ ë£¨íŠ¸ì—ì„œ</span>
pip <span class="nb">install</span> <span class="nt">-e</span> <span class="nb">.</span>
<span class="c"># ë˜ëŠ” PYTHONPATHë¡œ ì„ì‹œ ë“±ë¡</span>
<span class="nv">PYTHONPATH</span><span class="o">=</span>/path/to/project python pickle_to_json_trusted.py data.pkl out.json
</code></pre></div></div>

<ul>
  <li>ì´ëŸ¬ë©´ <code class="language-plaintext highlighter-rouge">mypkg.models.User</code> ê°™ì€ ê²½ë¡œë¥¼ íŒŒì´ì¬ì´ ìì—°ìŠ¤ëŸ½ê²Œ ì°¾ìŒ.</li>
</ul>

<h2 id="2-ê²½ë¡œë§Œ-ì¶”ê°€í•´ì„œ-import-ê°€ëŠ¥í•˜ê²Œ-ìŠ¤í¬ë¦½íŠ¸-ì˜µì…˜">2) ê²½ë¡œë§Œ ì¶”ê°€í•´ì„œ import ê°€ëŠ¥í•˜ê²Œ (ìŠ¤í¬ë¦½íŠ¸ ì˜µì…˜)</h2>

<p>í”„ë¡œì íŠ¸ ë£¨íŠ¸ë¥¼ <code class="language-plaintext highlighter-rouge">sys.path</code> ì•ì— ì¶”ê°€:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python pickle_to_json_trusted.py data.pkl out.json <span class="se">\</span>
  <span class="nt">--sys-path</span> /absolute/path/to/project_root <span class="se">\</span>
  <span class="nt">--preload</span> mypkg.models
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">--preload</code>ëŠ” í•´ë‹¹ ëª¨ë“ˆì„ ë¯¸ë¦¬ importí•´ì„œ í´ë˜ìŠ¤ ë“±ë¡ì„ í™•ì‹¤íˆ í•´ì¤˜.</li>
</ul>

<h2 id="3-ëª¨ë“ˆ-ê²½ë¡œê°€-ë°”ë€-ê²½ìš°ë¦¬íŒ©í„°ë§--ëª¨ë“ˆ-alias">3) ëª¨ë“ˆ ê²½ë¡œê°€ ë°”ë€ ê²½ìš°(ë¦¬íŒ©í„°ë§) â†’ <strong>ëª¨ë“ˆ alias</strong></h2>

<p>ì˜ˆ: ì˜ˆì „ì—ëŠ” <code class="language-plaintext highlighter-rouge">oldpkg.models</code>ì˜€ëŠ”ë° ì§€ê¸ˆì€ <code class="language-plaintext highlighter-rouge">newpkg.models</code>ë¡œ ì´ë™í–ˆë‹¤ë©´:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python pickle_to_json_trusted.py data.pkl out.json <span class="se">\</span>
  <span class="nt">--sys-path</span> /path/to/project <span class="se">\</span>
  <span class="nt">--alias</span> oldpkg.models<span class="o">=</span>newpkg.models <span class="se">\</span>
  <span class="nt">--preload</span> newpkg.models
</code></pre></div></div>

<ul>
  <li>ì´ëŸ¬ë©´ <code class="language-plaintext highlighter-rouge">pickle.load</code>ê°€ <code class="language-plaintext highlighter-rouge">oldpkg.models</code>ë¥¼ ì°¾ìœ¼ë ¤ í•  ë•Œ, ë‚´ë¶€ì ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">newpkg.models</code>ë¥¼ ëŒ€ì‹  ì‚¬ìš©.</li>
</ul>

<h2 id="4-í´ë˜ìŠ¤ê°€-ë‹¤ë¥¸-ëª¨ë“ˆë¡œ-ì´ë™í–ˆë‹¤ë©´--ëŸ°íƒ€ì„-shimê°„ë‹¨-ì˜ˆ">4) í´ë˜ìŠ¤ê°€ ë‹¤ë¥¸ ëª¨ë“ˆë¡œ ì´ë™í–ˆë‹¤ë©´ â†’ <strong>ëŸ°íƒ€ì„ shim(ê°„ë‹¨ ì˜ˆ)</strong></h2>

<p>ëª¨ë“ˆ aliasë§Œìœ¼ë¡œ ë¶€ì¡±í•  ë•Œ(í´ë˜ìŠ¤ ì´ë¦„ë„ ë°”ë€Œì—ˆê±°ë‚˜ ì„¸ë¶€ êµ¬ì¡°ê°€ ë°”ë€ ê²½ìš°), ì–¸í”¼í´ ì „ì— <strong>ì„ì‹œ shim ëª¨ë“ˆ</strong> ì„ ë§Œë“¤ì–´ ë§¤í•‘í•´ ì¤„ ìˆ˜ ìˆì–´:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ì˜ˆ: OldClassê°€ oldpkg.models â†’ newpkg.models.NewClass ë¡œ ì´ë™/ê°œëª…ëœ ê²½ìš°
</span><span class="kn">import</span> <span class="n">types</span><span class="p">,</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">newpkg.models</span> <span class="k">as</span> <span class="n">newmod</span>

<span class="n">shim</span> <span class="o">=</span> <span class="n">types</span><span class="p">.</span><span class="nc">ModuleType</span><span class="p">(</span><span class="sh">"</span><span class="s">oldpkg.models</span><span class="sh">"</span><span class="p">)</span>
<span class="c1"># ì˜ˆì „ ì´ë¦„ì„ ìƒˆ í´ë˜ìŠ¤ì— ë§¤í•‘
</span><span class="n">shim</span><span class="p">.</span><span class="n">OldClass</span> <span class="o">=</span> <span class="n">newmod</span><span class="p">.</span><span class="n">NewClass</span>
<span class="c1"># ì–¸í”¼í´ì´ ì°¾ì•„ì“°ë„ë¡ sys.modules ë“±ë¡
</span><span class="n">sys</span><span class="p">.</span><span class="n">modules</span><span class="p">[</span><span class="sh">"</span><span class="s">oldpkg.models</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">shim</span>

<span class="c1"># ì´ì œ pickle.loadë¥¼ í˜¸ì¶œ
</span></code></pre></div></div>

<blockquote>
  <p>ìœ„ shim ì½”ë“œëŠ” <strong>ìŠ¤í¬ë¦½íŠ¸ ìµœìƒë‹¨(ì–¸í”¼í´ ì§ì „)</strong>ì— ë„£ìœ¼ë©´ ë˜ê³ , ê²½ìš°ì— ë”°ë¼ ì—¬ëŸ¬ í´ë˜ìŠ¤ë¥¼ ë„£ì–´ ë§¤í•‘í•˜ë©´ ëœë‹¤.</p>
</blockquote>

<h2 id="5-python-2--3-í”¼í´ì¼-ë•Œ">5) Python 2 â†’ 3 í”¼í´ì¼ ë•Œ</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python pickle_to_json_trusted.py data.pkl out.json <span class="nt">--py2-latin1</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">encoding='latin1'</code>, <code class="language-plaintext highlighter-rouge">fix_imports=True</code>ë¡œ ê³¼ê±° í”¼í´ í˜¸í™˜ì„ ì‹œë„.</li>
</ul>

<hr />

<h1 id="ì‘ê²Œ-ìš”ì•½">ì‘ê²Œ ìš”ì•½</h1>

<ul>
  <li>
    <p><strong>Trust OK</strong> â†’ <code class="language-plaintext highlighter-rouge">pickle.load</code> + <code class="language-plaintext highlighter-rouge">jsonpickle.encode</code>ê°€ ê°€ì¥ ê°„ë‹¨.</p>
  </li>
  <li>
    <p><strong>ë²„ì „</strong> ì€ â€œê°™ê±°ë‚˜ ìµœì‹ â€ ê¶Œì¥ + ëª¨ë“ˆ/í´ë˜ìŠ¤ ê²½ë¡œê°€ í˜„ì¬ í™˜ê²½ì—ì„œ ê·¸ëŒ€ë¡œ import ê°€ëŠ¥í•´ì•¼ í•¨.</p>
  </li>
  <li>
    <p><strong>ì»¤ìŠ¤í…€ í´ë˜ìŠ¤ import</strong> ëŠ”</p>

    <ol>
      <li>
        <p>íŒ¨í‚¤ì§€ë¡œ ì„¤ì¹˜(ë˜ëŠ” PYTHONPATH),</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">--sys-path</code> / <code class="language-plaintext highlighter-rouge">--preload</code>,</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">--alias ì˜¬ë“œ=ë‰´</code>(ëª¨ë“ˆ ê²½ë¡œ ë³€ê²½),</p>
      </li>
      <li>
        <p>í•„ìš” ì‹œ <strong>shim ëª¨ë“ˆ</strong> ë¡œ í´ë˜ìŠ¤ ë ˆë²¨ ë§¤í•‘.</p>
      </li>
    </ol>
  </li>
</ul>

<p>ì›í•˜ë©´ shimì„ ì˜µì…˜í™”í•´ì„œ ìŠ¤í¬ë¦½íŠ¸ì— ë°”ë¡œ ë„£ëŠ” ë²„ì „(ì˜ˆ: <code class="language-plaintext highlighter-rouge">--shim oldpkg.models:OldClass=newpkg.models:NewClass</code>)ë„ ë§Œë“¤ì–´ì¤„ê²Œ.</p>]]></content><author><name>hvppyarchive</name></author><category term="python" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">md í•œì˜ ë³‘ê¸° í‘œê¸° ë Œë”ë§</title><link href="https://hvppyarchive.github.io/markdown/markdown-multilanguage/" rel="alternate" type="text/html" title="md í•œì˜ ë³‘ê¸° í‘œê¸° ë Œë”ë§" /><published>2025-09-13T11:23:46+09:00</published><updated>2025-09-13T11:23:46+09:00</updated><id>https://hvppyarchive.github.io/markdown/markdown-multilanguage</id><content type="html" xml:base="https://hvppyarchive.github.io/markdown/markdown-multilanguage/"><![CDATA[<p class="chat--user">

mkdocs-materialì—ì„œ md íŒŒì¼ ê¸€ì— ëŒ€í•´ í•œ/ì˜ ë³‘ê¸°ë¥¼ í•˜ê³  ì‹¶ì–´. ì•ˆë…•í•˜ì„¸ìš”. Hello. Everyone. ì´ëŸ° ì‹ìœ¼ë¡œ ë§ì´ì•¼. ì´ ë•Œ ì˜ì–´ëŠ” ì¢€ ì—°í•˜ê³  ì‘ê²Œ í‘œê¸°í•˜ê³  ì‹¶ì€ë°, ì´ê±¸ mdì— ì–´ë–¤ ë§ˆí¬ë¥¼ ì¶”ê°€í•´ì„œ ìë™ìœ¼ë¡œ ê·¸ë ‡ê²Œ ë Œë”ë§ í•´ì¤¬ìœ¼ë©´ ì¢‹ê² ì–´. ì•ˆë…•í•˜ì„¸ìš”. <en>Hello. Everyone</en> ì´ëŸ° ì‹ìœ¼ë¡œ ë§ì´ì•¼. ì´ê±´ ë‚´ê°€ ìƒê°í•œ ì˜ˆì‹œë‹ˆê¹Œ ë” ì¢‹ì€ ë°©ì•ˆì´ ìˆìœ¼ë©´ ì¶”ì²œí•´ë„ ì¢‹ì•„.

</p>

<p>ì¢‹ì•„ìš”! â€œí•œêµ­ì–´ ì›ë¬¸ + ì—°í•˜ê³  ì‘ì€ ì˜ì–´ ë²ˆì—­â€ì€ <strong>ë§ˆí¬ë‹¤ìš´ ì†ì„± ë¦¬ìŠ¤íŠ¸(attr_list)</strong> ë¥¼ ì“°ëŠ” ë°©ë²•ì´ ê°€ì¥ ê°„ë‹¨í•˜ê³ , ì›í•˜ì‹œë©´ <code class="language-plaintext highlighter-rouge">&lt;en&gt;</code> ê°™ì€ ì»¤ìŠ¤í…€ íƒœê·¸ë¡œë„ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë‘ ê°€ì§€ë¥¼ ëª¨ë‘ ë³´ì—¬ë“œë¦´ê²Œìš”.</p>

<hr />

<h1 id="ë°©ë²•-a-ê°€ì¥-ê°„ë‹¨--ë¬¸ë‹¨ì—-í´ë˜ìŠ¤-ë¶™ì´ê¸°-attr_list">ë°©ë²• A: ê°€ì¥ ê°„ë‹¨ â€” ë¬¸ë‹¨ì— í´ë˜ìŠ¤ ë¶™ì´ê¸° (attr_list)</h1>

<h2 id="1-mkdocsyml-ì„¤ì •">1) <code class="language-plaintext highlighter-rouge">mkdocs.yml</code> ì„¤ì •</h2>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">theme</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">material</span>

<span class="na">markdown_extensions</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">attr_list</span>          <span class="c1"># â† ì´ ì¤„ ì¶”ê°€</span>

<span class="na">extra_css</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">stylesheets/translation.css</span>   <span class="c1"># â† ì»¤ìŠ¤í…€ CSS ë“±ë¡</span>
</code></pre></div></div>

<h2 id="2-docsstylesheetstranslationcss-ì‘ì„±">2) <code class="language-plaintext highlighter-rouge">docs/stylesheets/translation.css</code> ì‘ì„±</h2>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/* ì˜ì–´ ë²ˆì—­ ê³µí†µ ìŠ¤íƒ€ì¼ */</span>
<span class="nc">.md-typeset</span> <span class="nc">.en</span> <span class="p">{</span>
  <span class="nl">font-size</span><span class="p">:</span> <span class="m">0.85em</span><span class="p">;</span>   <span class="c">/* ì¡°ê¸ˆ ì‘ê²Œ */</span>
  <span class="nl">opacity</span><span class="p">:</span> <span class="m">0.65</span><span class="p">;</span>       <span class="c">/* ì—°í•˜ê²Œ */</span>
<span class="p">}</span>

<span class="c">/* í•œêµ­ì–´ ë¬¸ë‹¨ ë°”ë¡œ ë‹¤ìŒì— ì˜¤ëŠ” ì˜ì–´ ë²ˆì—­ì€ ê°„ê²©ì„ ì¡°ê¸ˆë§Œ */</span>
<span class="nc">.md-typeset</span> <span class="nt">p</span> <span class="o">+</span> <span class="nt">p</span><span class="nc">.en</span> <span class="p">{</span>
  <span class="nl">margin-top</span><span class="p">:</span> <span class="m">0.25em</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="3-ë§ˆí¬ë‹¤ìš´ì—ì„œ-ì‚¬ìš©">3) ë§ˆí¬ë‹¤ìš´ì—ì„œ ì‚¬ìš©</h2>
<div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ì•ˆë…•í•˜ì„¸ìš”.
Hello. Everyone. {.en}
</code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Helloâ€¦ {.en}</code> ì²˜ëŸ¼ <strong>ë¬¸ì¥ ëì—<code class="language-plaintext highlighter-rouge">{.en}</code></strong> ì„ ë¶™ì´ë©´, ë Œë”ë§ ì‹œ <code class="language-plaintext highlighter-rouge">&lt;p class="en"&gt;â€¦&lt;/p&gt;</code>ê°€ ë˜ì–´ ìœ„ CSSê°€ ì ìš©ë©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë¬¸ì¥ ì¤‘ê°„ <strong>ì¸ë¼ì¸</strong> ìœ¼ë¡œ ì“°ê³  ì‹¶ìœ¼ë©´:</p>
    <div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ì•ˆë…•í•˜ì„¸ìš”. <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"en"</span><span class="nt">&gt;</span>Hello. Everyone.<span class="nt">&lt;/span&gt;</span>
</code></pre></div>    </div>
  </li>
</ul>

<hr />

<h1 id="ë°©ë²•-b-ì»¤ìŠ¤í…€-íƒœê·¸-en-ê·¸ëŒ€ë¡œ-ì“°ê¸°">ë°©ë²• B: ì»¤ìŠ¤í…€ íƒœê·¸ <code class="language-plaintext highlighter-rouge">&lt;en&gt;</code> ê·¸ëŒ€ë¡œ ì“°ê¸°</h1>

<p>ì›í•˜ì‹  í‘œê¸°ëŒ€ë¡œ ì¨ë„ ë©ë‹ˆë‹¤. Python-Markdownì€ ê¸°ë³¸ì ìœ¼ë¡œ <strong>ì¸ë¼ì¸ HTML í†µê³¼</strong> ë¥¼ í—ˆìš©í•˜ë¯€ë¡œ ì•„ë˜ì²˜ëŸ¼ ì‘ì„±í•˜ê³  CSSì—ì„œ <code class="language-plaintext highlighter-rouge">&lt;en&gt;</code>ì„ ìŠ¤íƒ€ì¼ë§í•˜ì„¸ìš”.</p>

<h2 id="1-ë§ˆí¬ë‹¤ìš´">1) ë§ˆí¬ë‹¤ìš´</h2>
<div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ì•ˆë…•í•˜ì„¸ìš”.
<span class="nt">&lt;en&gt;</span>Hello. Everyone.<span class="nt">&lt;/en&gt;</span>
</code></pre></div></div>

<h2 id="2-translationcss">2) <code class="language-plaintext highlighter-rouge">translation.css</code></h2>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/* ì•Œ ìˆ˜ ì—†ëŠ” íƒœê·¸ë„ CSSì—ì„œ ê·¸ëŒ€ë¡œ ì„ íƒ ê°€ëŠ¥ */</span>
<span class="nc">.md-typeset</span> <span class="nt">en</span> <span class="p">{</span>
  <span class="nl">font-size</span><span class="p">:</span> <span class="m">0.85em</span><span class="p">;</span>
  <span class="nl">opacity</span><span class="p">:</span> <span class="m">0.65</span><span class="p">;</span>
  <span class="nl">display</span><span class="p">:</span> <span class="nb">block</span><span class="p">;</span>           <span class="c">/* ì¤„ë°”ê¿ˆ í˜•íƒœë¼ë©´ blockì´ ë³´ê¸° ì¢‹ìŒ */</span>
  <span class="nl">margin-top</span><span class="p">:</span> <span class="m">0.25em</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>ì°¸ê³ : HTML í‘œì¤€ìƒ â€œì»¤ìŠ¤í…€ ìš”ì†Œâ€ëŠ” ë³´í†µ ì´ë¦„ì— í•˜ì´í”ˆì´ ë“¤ì–´ê°‘ë‹ˆë‹¤(<code class="language-plaintext highlighter-rouge">&lt;en-text&gt;</code> ë“±). êµ³ì´ í‘œì¤€ì„ ë”°ë¥´ë ¤ë©´ <code class="language-plaintext highlighter-rouge">&lt;en-text&gt;</code>ë¡œ ì“°ê³  CSSë„ <code class="language-plaintext highlighter-rouge">en-text</code>ë¡œ ì§€ì •í•´ë„ ë©ë‹ˆë‹¤. ë‹¤ë§Œ ì‹¤ì œ ë™ì‘ì€ <code class="language-plaintext highlighter-rouge">&lt;en&gt;</code>ë„ ë¬¸ì œì—†ìŠµë‹ˆë‹¤.</p>
</blockquote>

<hr />

<h1 id="ì„ íƒ-ì ‘ê·¼ì„±ê¹Œì§€-ê³ ë ¤í•œ-ë²„ì „">(ì„ íƒ) ì ‘ê·¼ì„±ê¹Œì§€ ê³ ë ¤í•œ ë²„ì „</h1>

<p>ë²ˆì—­ í…ìŠ¤íŠ¸ì— <code class="language-plaintext highlighter-rouge">lang="en"</code>ì„ ë”í•´ì£¼ë©´ ìŠ¤í¬ë¦°ë¦¬ë”ê°€ ì–¸ì–´ ì „í™˜ì„ ì¸ì§€í•©ë‹ˆë‹¤.</p>
<div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hello. Everyone. { .en lang=en }
</code></pre></div></div>

<p>CSSëŠ” ê·¸ëŒ€ë¡œ <code class="language-plaintext highlighter-rouge">.en</code>ì— ê±¸ë ¤ì„œ ì‹œê° ìŠ¤íƒ€ì¼ì€ ìœ ì§€ë˜ê³ , ë³´ì¡°ê³µí•™ ì¹œí™”ì„±ë§Œ ì˜¬ë¼ê°‘ë‹ˆë‹¤.</p>

<hr />

<h1 id="ì–´ë–¤-ë°©ë²•ì„-ì“°ë©´-ì¢‹ì„ê¹Œ">ì–´ë–¤ ë°©ë²•ì„ ì“°ë©´ ì¢‹ì„ê¹Œ?</h1>

<ul>
  <li>
    <p><strong>ê°€ì¥ ê¶Œì¥:</strong> ë°©ë²• A (attr_list)</p>

    <ul>
      <li>ë§ˆí¬ë‹¤ìš´ ë¬¸ë²•ì„ ìœ ì§€í•˜ë©´ì„œë„ ê¹”ë”í•˜ê²Œ í´ë˜ìŠ¤ë§Œ ë¶€ì—¬ â†’ ê´€ë¦¬ ì‰¬ì›€</li>
    </ul>
  </li>
  <li>
    <p><strong>ì›í•˜ì‹  í‘œê¸°ë¥¼ ê·¸ëŒ€ë¡œ ì“°ê³  ì‹¶ë‹¤ë©´:</strong> ë°©ë²• B (<code class="language-plaintext highlighter-rouge">&lt;en&gt;â€¦&lt;/en&gt;</code>)</p>

    <ul>
      <li>ì·¨í–¥/ê°€ë…ì„± ë©´ì—ì„œ ì„ í˜¸í•˜ë©´ ì‚¬ìš©, ë‹¤ë§Œ HTML íƒœê·¸ë¥¼ ì§ì ‘ ì“°ëŠ” ì ë§Œ ìœ ì˜</li>
    </ul>
  </li>
</ul>

<p>ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ì±„íƒí•˜ì…”ë„ ë˜ê³ , <strong>ë¬¸ë‹¨ì€<code class="language-plaintext highlighter-rouge">{.en}</code></strong>, <strong>ì¸ë¼ì¸ì€ <code class="language-plaintext highlighter-rouge">&lt;span class="en"&gt;â€¦&lt;/span&gt;</code></strong>ì²˜ëŸ¼ í˜¼ìš©í•´ë„ ê¹”ë”í•˜ê²Œ ê´€ë¦¬ë©ë‹ˆë‹¤.</p>

<p>í•„ìš”í•˜ì‹œë©´ ëª©ë¡/í‘œ/ì¸ìš©ë¬¸ ë“±ì—ì„œì˜ ë¯¸ì„¸ ê°„ê²© ì¡°ì •ìš© CSSë„ ì´ì–´ì„œ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

ì•ˆ ë˜ëŠ”ë° ë„ì–´ì“°ê¸°ë‚˜ ì¤„ë°”ê¿ˆ ê°™ì€ê±¸ ì˜ í•´ì•¼í•˜ë‚˜?

</p>

<p>ê°€ëŠ¥í•´! ì£¼ë¡œ <strong>ë„ì–´ì“°ê¸°/ì¤„ë°”ê¿ˆ</strong> ê³¼ <strong>ì„¤ì • ë¡œë”©</strong> ì—ì„œ ìì£¼ ë¯¸ë„ëŸ¬ì ¸ìš”. ì•„ë˜ ìˆœì„œëŒ€ë¡œ í•œ ë²ˆë§Œ ì ê²€í•´ë³´ì£ . (ë³µë¶™ìš© ìµœì†Œ ì˜ˆì œë„ ë§¨ ì•„ë˜ì— ë„£ì—ˆì–´ìš”.)</p>

<hr />

<h2 id="1-ì„¤ì •ì´-ì§„ì§œ-ì¼œì¡ŒëŠ”ì§€-í™•ì¸">1) ì„¤ì •ì´ ì§„ì§œ ì¼œì¡ŒëŠ”ì§€ í™•ì¸</h2>

<ul>
  <li><code class="language-plaintext highlighter-rouge">mkdocs.yml</code>ì— <strong>ì •í™•íˆ</strong> ë‹¤ìŒì´ ìˆì–´ì•¼ í•´ìš”.
    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">theme</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">material</span>
    
<span class="na">markdown_extensions</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">attr_list</span>        <span class="c1"># â† ì´ê²Œ ìˆì–´ì•¼ {.en}ì´ ë¨¹ìŠµë‹ˆë‹¤.</span>
    
<span class="na">extra_css</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">stylesheets/translation.css</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">docs/stylesheets/translation.css</code> íŒŒì¼ì´ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸.</p>
  </li>
  <li><code class="language-plaintext highlighter-rouge">mkdocs serve</code>ë¥¼ ëŒë¦¬ëŠ” ì¤‘ì— <code class="language-plaintext highlighter-rouge">extra_css</code>ë¥¼ ì¶”ê°€í–ˆë‹¤ë©´, <strong>ì„œë²„ë¥¼ í•œ ë²ˆ ì¬ì‹œì‘</strong> í•´ ì£¼ì„¸ìš”. (ê°€ë” ìƒˆ CSSë¥¼ ëª» ì½ê³  ìˆìŠµë‹ˆë‹¤.)</li>
</ul>

<hr />

<h2 id="2-ì¤„ë°”ê¿ˆ-ê·œì¹™-ì´í•´-ì—¬ê¸°ì„œ-ë§ì´-í‹€ì–´ì§‘ë‹ˆë‹¤">2) ì¤„ë°”ê¿ˆ ê·œì¹™ ì´í•´ (ì—¬ê¸°ì„œ ë§ì´ í‹€ì–´ì§‘ë‹ˆë‹¤)</h2>

<p>ë§ˆí¬ë‹¤ìš´ì—ì„œ:</p>

<ul>
  <li>
    <p><strong>ë¹ˆ ì¤„(ê³µë°± ì¤„)</strong> = ìƒˆ ë¬¸ë‹¨(<code class="language-plaintext highlighter-rouge">&lt;p&gt;â€¦&lt;/p&gt;</code>)</p>
  </li>
  <li>
    <p><strong>ê·¸ëƒ¥ ì¤„ë°”ê¿ˆ í•˜ë‚˜</strong> = ê°™ì€ ë¬¸ë‹¨ ì•ˆì—ì„œ <strong>ê³µë°± í•˜ë‚˜</strong>(ì¤„ë°”ê¿ˆì´ ì‚¬ë¼ì§)</p>
  </li>
  <li>
    <p><strong>ì¤„ ëì— ê³µë°± ë‘ ì¹¸ + ì—”í„°</strong> = <strong>ê°•ì œ ì¤„ë°”ê¿ˆ(<code class="language-plaintext highlighter-rouge">&lt;br&gt;</code>)</strong></p>
  </li>
</ul>

<p>ì›í•˜ëŠ” í˜•íƒœê°€ â€œí•œêµ­ì–´ í•œ ì¤„ + (ì¡°ê¸ˆ ì—°í•˜ê³  ì‘ì€) ì˜ì–´ í•œ ì¤„â€ì´ë¼ë©´,</p>

<ul>
  <li>
    <p><strong>ë¬¸ë‹¨ì„ ë¶„ë¦¬</strong> í•˜ê±°ë‚˜(<strong>ë¹ˆ ì¤„ 1ê°œ</strong>),</p>
  </li>
  <li>
    <p><strong>ê°•ì œ ì¤„ë°”ê¿ˆ</strong> ì„ ì“°ê±°ë‚˜(í•œêµ­ì–´ ì¤„ ë <strong>ë‘ ì¹¸</strong> + ì—”í„°)<br />
ë‘˜ ì¤‘ í•˜ë‚˜ë¥¼ ë°˜ë“œì‹œ í•´ ì£¼ì„¸ìš”.</p>
  </li>
</ul>

<hr />

<h2 id="3-ì‹¤ì œ-ì‘ì„±-ì˜ˆì œ-3ê°€ì§€">3) ì‹¤ì œ ì‘ì„± ì˜ˆì œ 3ê°€ì§€</h2>

<h3 id="a-ê°€ì¥-ê°„ë‹¨-ë¬¸ë‹¨-ë¶„ë¦¬--en">A. ê°€ì¥ ê°„ë‹¨: ë¬¸ë‹¨ ë¶„ë¦¬ + <code class="language-plaintext highlighter-rouge">{.en}</code></h3>
<div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ì•ˆë…•í•˜ì„¸ìš”.

Hello. Everyone. {.en}
</code></pre></div></div>

<blockquote>
  <p>í¬ì¸íŠ¸: <strong>í•œêµ­ì–´ì™€ ì˜ì–´ ì‚¬ì´ì— ë¹ˆ ì¤„</strong> ì´ ìˆì–´ì•¼ ì˜ì–´ê°€ <strong>ë³„ë„ ë¬¸ë‹¨</strong> ì´ ë˜ê³ , <code class="language-plaintext highlighter-rouge">{.en}</code>ì´ ê·¸ ë¬¸ë‹¨ì— ì ìš©ë©ë‹ˆë‹¤.</p>
</blockquote>

<h3 id="b-ê°™ì€-ë¬¸ë‹¨-ì•ˆì—ì„œ-ì¤„ë§Œ-ë°”ê¾¸ê³ -ì‹¶ì„-ë•Œ-ê°„ê²©-ë”-ì´˜ì´˜">B. ê°™ì€ ë¬¸ë‹¨ ì•ˆì—ì„œ ì¤„ë§Œ ë°”ê¾¸ê³  ì‹¶ì„ ë•Œ (ê°„ê²© ë” ì´˜ì´˜)</h3>
<div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ì•ˆë…•í•˜ì„¸ìš”.Â·Â·
<span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"en"</span><span class="nt">&gt;</span>Hello. Everyone.<span class="nt">&lt;/span&gt;</span>
</code></pre></div></div>

<blockquote>
  <p>í•œêµ­ì–´ ì¤„ ëì˜ <code class="language-plaintext highlighter-rouge">Â·Â·</code>(ê³µë°± ë‘ ì¹¸)ê°€ <strong>ê°•ì œ ì¤„ë°”ê¿ˆ</strong> ì…ë‹ˆë‹¤.<br />
 <code class="language-plaintext highlighter-rouge">&lt;span&gt;</code>ì€ HTMLì´ë¯€ë¡œ ì¤„ë°”ê¿ˆì„ ìœ„í•´ <code class="language-plaintext highlighter-rouge">&lt;br&gt;</code>ë¥¼ ì¨ë„ ë©ë‹ˆë‹¤:</p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>md

ì•ˆë…•í•˜ì„¸ìš”.&lt;br&gt;
&lt;span class="en"&gt;Hello. Everyone.&lt;/span&gt;

</code></pre></div>  </div>
</blockquote>

<h3 id="c-ì»¤ìŠ¤í…€-íƒœê·¸-en-ê·¸ëŒ€ë¡œ">C. ì»¤ìŠ¤í…€ íƒœê·¸ <code class="language-plaintext highlighter-rouge">&lt;en&gt;</code> ê·¸ëŒ€ë¡œ</h3>
<div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ì•ˆë…•í•˜ì„¸ìš”.
<span class="nt">&lt;en&gt;</span>Hello. Everyone.<span class="nt">&lt;/en&gt;</span>
</code></pre></div></div>

<blockquote>
  <p>ì¸ë¼ì¸ HTMLì€ ê¸°ë³¸ í—ˆìš©ì´ë¼ ë³„ë„ í™•ì¥ í•„ìš” ì—†ìŠµë‹ˆë‹¤. (ë¸”ë¡ HTMLë¡œ ê°ì‹¸ ë³µì¡í•˜ê²Œ ì“°ëŠ” ê²½ìš°ì—ë§Œ <code class="language-plaintext highlighter-rouge">md_in_html</code>ì´ í•„ìš”)</p>
</blockquote>

<hr />

<h2 id="4-css-material-í…Œë§ˆ-ê¸°ì¤€-ë³µë¶™">4) CSS (Material í…Œë§ˆ ê¸°ì¤€, ë³µë¶™)</h2>

<p><code class="language-plaintext highlighter-rouge">docs/stylesheets/translation.css</code></p>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/* ì˜ì–´ ë²ˆì—­ ê³µí†µ ìŠ¤íƒ€ì¼ */</span>
<span class="nc">.md-typeset</span> <span class="nc">.en</span><span class="o">,</span>
<span class="nc">.md-typeset</span> <span class="nt">en</span><span class="o">,</span>
<span class="nc">.md-typeset</span> <span class="nt">span</span><span class="nc">.en</span> <span class="p">{</span>
  <span class="nl">font-size</span><span class="p">:</span> <span class="m">0.85em</span><span class="p">;</span>   <span class="c">/* ì¡°ê¸ˆ ì‘ê²Œ */</span>
  <span class="nl">opacity</span><span class="p">:</span> <span class="m">0.65</span><span class="p">;</span>       <span class="c">/* ì—°í•˜ê²Œ */</span>
<span class="p">}</span>

<span class="c">/* ë¬¸ë‹¨ìœ¼ë¡œ ë¶„ë¦¬í•œ ê²½ìš°: í•œêµ­ì–´ ë¬¸ë‹¨ ë°”ë¡œ ë’¤ ì˜ì–´ ë¬¸ë‹¨ì˜ ìœ„ ì—¬ë°± ì¤„ì´ê¸° */</span>
<span class="nc">.md-typeset</span> <span class="nt">p</span> <span class="o">+</span> <span class="nt">p</span><span class="nc">.en</span> <span class="p">{</span>
  <span class="nl">margin-top</span><span class="p">:</span> <span class="m">0.25em</span><span class="p">;</span>
<span class="p">}</span>

<span class="c">/* ì¤„ë°”ê¿ˆ(ë¸Œë ˆì´í¬) ë’¤ì— ì˜¤ëŠ” ì¸ë¼ì¸ ë²ˆì—­ì„ 'í•œ ì¤„'ì²˜ëŸ¼ ë³´ì´ê²Œ */</span>
<span class="nc">.md-typeset</span> <span class="nt">span</span><span class="nc">.en</span> <span class="p">{</span>
  <span class="nl">display</span><span class="p">:</span> <span class="nb">inline-block</span><span class="p">;</span>   <span class="c">/* &lt;br&gt; ë‹¤ìŒì— ë‚´ë ¤ì˜¤ë©´ í•œ ì¤„ë¡œ ë–¨ì–´ì ¸ ë³´ì„ */</span>
  <span class="nl">margin-top</span><span class="p">:</span> <span class="m">0.25em</span><span class="p">;</span>
<span class="p">}</span>

<span class="c">/* ì»¤ìŠ¤í…€ íƒœê·¸ &lt;en&gt;ì„ ë¸”ë¡ì²˜ëŸ¼ ì“°ê³  ì‹¶ë‹¤ë©´ */</span>
<span class="nc">.md-typeset</span> <span class="nt">en</span> <span class="p">{</span>
  <span class="nl">display</span><span class="p">:</span> <span class="nb">block</span><span class="p">;</span>
  <span class="nl">margin-top</span><span class="p">:</span> <span class="m">0.25em</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="5-ì²´í¬ë¦¬ìŠ¤íŠ¸ë¬¸ì œ-ê³„ì†ë˜ë©´-ì—¬ê¸°ì„œ-ì¡í™ë‹ˆë‹¤">5) ì²´í¬ë¦¬ìŠ¤íŠ¸(ë¬¸ì œ ê³„ì†ë˜ë©´ ì—¬ê¸°ì„œ ì¡í™ë‹ˆë‹¤)</h2>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">mkdocs.yml</code>ì— <code class="language-plaintext highlighter-rouge">attr_list</code>ê°€ <strong>ì •í™•íˆ</strong> ë“¤ì–´ê°€ ìˆë‹¤. (ì˜¤íƒˆì, ë“¤ì—¬ì“°ê¸° ì£¼ì˜)</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">extra_css</code> ê²½ë¡œê°€ ì‹¤ì œ íŒŒì¼ ìœ„ì¹˜ì™€ <strong>ì¼ì¹˜</strong> í•œë‹¤. (<code class="language-plaintext highlighter-rouge">docs/stylesheets/translation.css</code>)</p>
  </li>
  <li>
    <p><strong>ì„œë²„ ì¬ì‹œì‘</strong> í›„ ìƒˆ CSSê°€ ë¡œë“œëœë‹¤.</p>
  </li>
  <li>
    <p>ë§ˆí¬ë‹¤ìš´ì—ì„œ ì˜ì–´ ì¤„ì„ <strong>ë³„ë„ ë¬¸ë‹¨</strong> ìœ¼ë¡œ ë§Œë“¤ë ¤ë©´ <strong>ë¹ˆ ì¤„ 1ê°œ</strong> ,<br />
ê°™ì€ ë¬¸ë‹¨ ì•ˆ <strong>ì¤„ë°”ê¿ˆ</strong> ì´ë©´ í•œêµ­ì–´ ì¤„ ëì— <strong>ê³µë°± 2ì¹¸</strong> ë˜ëŠ” <code class="language-plaintext highlighter-rouge">&lt;br&gt;</code>.</p>
  </li>
  <li>
    <p>ê°œë°œìë„êµ¬ì—ì„œ <code class="language-plaintext highlighter-rouge">.en</code> ê·œì¹™ì´ <strong>ì‹¤ì œë¡œ ì ìš©</strong> ë˜ëŠ”ì§€ í™•ì¸í•œë‹¤. (ì„ íƒì ì•ì— <code class="language-plaintext highlighter-rouge">.md-typeset</code>ë¥¼ ë¶™ì´ë©´ ìš°ì„ ìˆœìœ„ ë¬¸ì œë¥¼ ëŒ€ë¶€ë¶„ ì´ê¹ë‹ˆë‹¤.)</p>
  </li>
</ol>

<hr />

<h2 id="6-ë³µë¶™ìš©-ì™„ì „-ìµœì†Œ-ì˜ˆì œ">6) ë³µë¶™ìš© â€œì™„ì „ ìµœì†Œ ì˜ˆì œâ€</h2>

<p><strong>mkdocs.yml</strong></p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">site_name</span><span class="pi">:</span> <span class="s">demo</span>
<span class="na">theme</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">material</span>
<span class="na">markdown_extensions</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">attr_list</span>
<span class="na">extra_css</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">stylesheets/translation.css</span>
</code></pre></div></div>

<p><strong>docs/stylesheets/translation.css</strong> â†’ ìœ„ CSS ê·¸ëŒ€ë¡œ</p>

<p><strong>docs/index.md</strong></p>
<div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gh"># ë°ëª¨</span>

ì•ˆë…•í•˜ì„¸ìš”.

Hello. Everyone. {.en}
<span class="p">
---
</span>
ì•ˆë…•í•˜ì„¸ìš”.Â·Â·
<span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"en"</span><span class="nt">&gt;</span>Hello. Everyone.<span class="nt">&lt;/span&gt;</span>
<span class="p">
---
</span>
ì•ˆë…•í•˜ì„¸ìš”.
<span class="nt">&lt;en&gt;</span>Hello. Everyone.<span class="nt">&lt;/en&gt;</span>
</code></pre></div></div>

<p>ì´ëŒ€ë¡œ í•˜ë©´ 3ê°€ì§€ ë°©ì‹ ëª¨ë‘ â€œì—°í•˜ê³  ì‘ê²Œâ€ ë‚˜ì˜µë‹ˆë‹¤.<br />
ê·¸ë˜ë„ ì•ˆ ë˜ë©´, ì‚¬ìš©í•˜ì‹  <code class="language-plaintext highlighter-rouge">mkdocs.yml</code>ê³¼ í•œë‘ ì¤„ì˜ <code class="language-plaintext highlighter-rouge">md</code> ì˜ˆì œë¥¼ ë¶™ì—¬ì£¼ì‹œë©´ ë°”ë¡œ ì›ì¸ pinpoint í•´ë“œë¦´ê²Œìš”!</p>

<p class="chat--user">

ë‹¤ìŒ ì¤„ì—ë‹¤ê°€ {: .en}ì„ ì“°ë‹ˆê¹Œ ë˜ë„¤ ì•ˆë…•í•˜ì„¸ìš”. (ê³µë°± ë‘ê°œ) Hello. Everyone. {: .en} ì´ëŸ° ì‹ìœ¼ë¡œ ë§ì´ì•¼. ê·¼ë° ë¬¸ì œëŠ” í•œê¸€ê¹Œì§€ ê°™ì´ ì—°í•˜ê²Œ ë³€í•´ë²„ë ¤.

</p>

<p>ë§ì•„ìš”â€”ê·¸ ì¦ìƒì€ <strong><code class="language-plaintext highlighter-rouge">{: .en}</code>ì´ â€œì´ì „ ë¸”ë¡ ì „ì²´â€ì— ë¶™ì–´ì„œ</strong> ê·¸ë˜ìš”.<br />
ì§€ê¸ˆ ì“°ì‹  í˜•íƒœëŠ” <code class="language-plaintext highlighter-rouge">ì•ˆë…•í•˜ì„¸ìš”.</code> ë’¤ì˜ <strong>ê³µë°± ë‘ ì¹¸</strong> ë•Œë¬¸ì— í•œêµ­ì–´+ì˜ì–´ê°€ <strong>ê°™ì€ ë¬¸ë‹¨(<code class="language-plaintext highlighter-rouge">&lt;p&gt;â€¦&lt;/p&gt;</code>)</strong> ì•ˆì— ë“¤ì–´ê°‘ë‹ˆë‹¤. ê·¸ëŸ¬ë©´ <code class="language-plaintext highlighter-rouge">{: .en}</code>ì´ ê·¸ <strong>ë¬¸ë‹¨ ì „ì²´</strong> ì— ì ìš©ë˜ì–´ í•œê¸€ê¹Œì§€ ì—°í•´ì ¸ìš”.</p>

<p>ì•„ë˜ ì…‹ ì¤‘ í•˜ë‚˜ë¡œ ê³ ì¹˜ë©´ ë”± í•´ê²°ë©ë‹ˆë‹¤.</p>

<hr />

<h3 id="-ë°©ë²•-1-ë¬¸ë‹¨ì„-ë¶„ë¦¬-í•˜ê³ -ì˜ì–´-ì¤„ì—ë§Œ-í´ë˜ìŠ¤-ë¶™ì´ê¸°-ê°€ì¥-ê¹”ë”">âœ… ë°©ë²• 1: <strong>ë¬¸ë‹¨ì„ ë¶„ë¦¬</strong> í•˜ê³  ì˜ì–´ ì¤„ì—ë§Œ í´ë˜ìŠ¤ ë¶™ì´ê¸° (ê°€ì¥ ê¹”ë”)</h3>
<div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ì•ˆë…•í•˜ì„¸ìš”.

Hello. Everyone. {.en}
</code></pre></div></div>

<ul>
  <li><strong>í¬ì¸íŠ¸:</strong> í•œêµ­ì–´ì™€ ì˜ì–´ ì‚¬ì´ì— <strong>ë¹ˆ ì¤„ 1ê°œ</strong> â†’ ì„œë¡œ ë‹¤ë¥¸ ë¬¸ë‹¨ì´ ë˜ë©´ì„œ <code class="language-plaintext highlighter-rouge">.en</code>ì€ ì˜ì–´ ë¬¸ë‹¨ì—ë§Œ ì ìš©.</li>
</ul>

<hr />

<h3 id="-ë°©ë²•-2-ì•ì¤„ì—-ì†ì„±-ë°°ì¹˜-í•´ì„œ-ë‹¤ìŒ-ë¸”ë¡ì—ë§Œ-ì ìš©">âœ… ë°©ë²• 2: <strong>ì•ì¤„ì— ì†ì„± ë°°ì¹˜</strong> í•´ì„œ â€œë‹¤ìŒ ë¸”ë¡â€ì—ë§Œ ì ìš©</h3>
<div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ì•ˆë…•í•˜ì„¸ìš”.

{:.en lang=en}
Hello. Everyone.
</code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">{: .en}</code>ì„ <strong>ì˜ì–´ ë¬¸ë‹¨ ì•ì¤„</strong> ì— ë‘ë©´, ë°”ë¡œ <strong>ì•„ë˜ ë¸”ë¡(ì˜ì–´ ë¬¸ë‹¨)</strong> ì—ë§Œ ì ìš©ë©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì ‘ê·¼ì„±ê¹Œì§€ ì±™ê¸°ë ¤ë©´ <code class="language-plaintext highlighter-rouge">lang=en</code>ë„ ê°™ì´ ë‘ì„¸ìš”.</p>
  </li>
</ul>

<hr />

<h3 id="-ë°©ë²•-3-ê°™ì€-ë¬¸ë‹¨ì„-ìœ ì§€-í•˜ë ¤ë©´-br--ì¸ë¼ì¸-span">âœ… ë°©ë²• 3: <strong>ê°™ì€ ë¬¸ë‹¨ì„ ìœ ì§€</strong> í•˜ë ¤ë©´ <code class="language-plaintext highlighter-rouge">&lt;br&gt;</code> + ì¸ë¼ì¸ span</h3>
<div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ì•ˆë…•í•˜ì„¸ìš”.<span class="nt">&lt;br&gt;</span>
<span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"en"</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>Hello. Everyone.<span class="nt">&lt;/span&gt;</span>
</code></pre></div></div>

<ul>
  <li>í•œêµ­ì–´ ì¤„ ë <strong>ê³µë°± ë‘ ì¹¸</strong> ëŒ€ì‹  <code class="language-plaintext highlighter-rouge">&lt;br&gt;</code>ë¡œ ì¤„ë°”ê¿ˆí•˜ê³ , ì˜ì–´ë§Œ <code class="language-plaintext highlighter-rouge">&lt;span class="en"&gt;â€¦&lt;/span&gt;</code>ë¡œ ê°ì‹¸ë©´ ë©ë‹ˆë‹¤.</li>
</ul>

<hr />

<h3 id="ì™œ-ì´ëŸ°ê°€ìš”-í•µì‹¬-ì •ë¦¬">ì™œ ì´ëŸ°ê°€ìš”? (í•µì‹¬ ì •ë¦¬)</h3>

<ul>
  <li>
    <p><strong>ê³µë°± ë‘ ì¹¸ + ì—”í„°</strong> = ê°™ì€ ë¬¸ë‹¨ ì•ˆì˜ <code class="language-plaintext highlighter-rouge">&lt;br&gt;</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">{: .en}</code> (ë‹¨ë… ì¤„) = <strong>ë°”ë¡œ ì• ë¸”ë¡</strong> ì— ë¶™ìŒ â†’ ê°™ì€ ë¬¸ë‹¨ì´ë©´ <strong>í•œê¸€+ì˜ì–´ ëª¨ë‘</strong> ì— ì ìš©ë¨</p>
  </li>
  <li>
    <p>í•´ê²°ì±…ì€ <strong>ë¸”ë¡ì„ ë‚˜ëˆ„ê±°ë‚˜</strong>(ë°©ë²• 1/2), <strong>ì¸ë¼ì¸ë§Œ ê°ì‹¸ê¸°</strong>(ë°©ë²• 3)ì…ë‹ˆë‹¤.</p>
  </li>
</ul>

<p>í•„ìš”í•˜ë©´, ì§€ê¸ˆ ì“°ì‹œëŠ” ì‹¤ì œ í•œë‘ ì¤„ì„ ë¶™ì—¬ ì£¼ì‹œë©´ ê·¸ í˜•íƒœì— ë§ì¶° ê°€ì¥ ê°„ë‹¨í•œ ë¬¸ë²•ìœ¼ë¡œ ë”± ë§ì¶° ë“œë¦´ê²Œìš”!</p>

<p class="chat--user">

ì•„ë‹ˆ ì™œ ìê¾¸ {.en}ì´ë¼ê³  í•˜ëŠ”ê±´ë°, ì´ê±° ë™ì‘í•˜ëŠ”ê±°ì•¼?

</p>

<p>ë§ì•„ìš”, í—·ê°ˆë¦´ ë§Œí•´ìš”. ì •ë¦¬í•˜ë©´:</p>

<ol>
  <li><strong><code class="language-plaintext highlighter-rouge">{.en}</code> = <code class="language-plaintext highlighter-rouge">{:.en}</code></strong></li>
</ol>

<ul>
  <li>
    <p>ë‘˜ ë‹¤ <strong>attr_list</strong> í™•ì¥ ë¬¸ë²•ì…ë‹ˆë‹¤. (ì½œë¡ ì€ ì„ íƒ)</p>
  </li>
  <li>
    <p><strong>ë™ì‘ ì¡°ê±´:</strong> <code class="language-plaintext highlighter-rouge">mkdocs.yml</code>ì— <code class="language-plaintext highlighter-rouge">markdown_extensions: - attr_list</code>ê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.</p>
  </li>
</ul>

<ol>
  <li><strong>ë¶™ëŠ” ìœ„ì¹˜ ê·œì¹™(í•µì‹¬)</strong></li>
</ol>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">{: .en}</code> ê°™ì€ <strong>ì†ì„± ì¤„ì€ â€œë°”ë¡œ ì• ë¸”ë¡â€</strong>ì— ë¶™ìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>í•œê¸€ ì¤„ ëì— ê³µë°± ë‘ ê°œë¥¼ ë„£ìœ¼ë©´ <strong>í•œê¸€+ì˜ì–´ê°€ í•œ ë¬¸ë‹¨(ê°™ì€ ë¸”ë¡)</strong> ì´ë¼ì„œ, <code class="language-plaintext highlighter-rouge">{: .en}</code>ì´ ë‘˜ ë‹¤ì— ì ìš©ë¼ìš” â†’ ê·¸ë˜ì„œ í•œê¸€ê¹Œì§€ ì—°í•´ì§„ ê²ƒ.</p>
  </li>
</ul>

<ol>
  <li><strong>ì›í•˜ëŠ” íš¨ê³¼(ì˜ì–´ë§Œ ì—°í•˜ê²Œ) ë§Œë“œëŠ” ë²• â€“ 3ê°€ì§€ ì¤‘ í•˜ë‚˜ ì„ íƒ</strong></li>
</ol>

<ul>
  <li>âœ… <strong>ë¬¸ë‹¨ ë¶„ë¦¬ + ì˜ì–´ì—ë§Œ í´ë˜ìŠ¤</strong> (ê°€ì¥ ê°„ë‹¨)
    <div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ì•ˆë…•í•˜ì„¸ìš”.
    
Hello. Everyone. {.en}
</code></pre></div>    </div>
  </li>
</ul>

<p>ë˜ëŠ”
    ```md
    ì•ˆë…•í•˜ì„¸ìš”.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hello. Everyone.
{:.en}
```
</code></pre></div></div>

<blockquote>
  <p>ë¹ˆ ì¤„ í•˜ë‚˜ë¡œ ì˜ì–´ë¥¼ <strong>ë³„ë„ ë¬¸ë‹¨</strong> ìœ¼ë¡œ ë§Œë“¤ë©´ <code class="language-plaintext highlighter-rouge">.en</code>ì´ ì˜ì–´ ë¬¸ë‹¨ì—ë§Œ ì ìš©ë©ë‹ˆë‹¤.</p>
</blockquote>

<ul>
  <li>âœ… <strong>ê°™ì€ ë¬¸ë‹¨ì„ ìœ ì§€í•´ì•¼ í•œë‹¤ë©´</strong> â†’ ì¤„ë°”ê¿ˆì€ <code class="language-plaintext highlighter-rouge">&lt;br&gt;</code>ë¡œ, ì˜ì–´ë§Œ ê°ì‹¸ê¸°
    <div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ì•ˆë…•í•˜ì„¸ìš”.<span class="nt">&lt;br&gt;</span>
<span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"en"</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>Hello. Everyone.<span class="nt">&lt;/span&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>âœ… <strong>ì»¤ìŠ¤í…€ íƒœê·¸ ì„ í˜¸ ì‹œ</strong>
    <div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ì•ˆë…•í•˜ì„¸ìš”.
<span class="nt">&lt;en</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>Hello. Everyone.<span class="nt">&lt;/en&gt;</span>
</code></pre></div>    </div>
  </li>
</ul>

<ol>
  <li><strong>CSS ì˜ˆì‹œ(Material í…Œë§ˆ ê¸°ì¤€)</strong></li>
</ol>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/* ì˜ì–´ ë²ˆì—­ì„ ì‘ê³  ì—°í•˜ê²Œ */</span>
<span class="nc">.md-typeset</span> <span class="nc">.en</span><span class="o">,</span>
<span class="nc">.md-typeset</span> <span class="nt">en</span> <span class="p">{</span>
  <span class="nl">font-size</span><span class="p">:</span> <span class="m">0.85em</span><span class="p">;</span>
  <span class="nl">opacity</span><span class="p">:</span> <span class="m">0.65</span><span class="p">;</span>
<span class="p">}</span>

<span class="c">/* í•œêµ­ì–´ ë¬¸ë‹¨ ë°”ë¡œ ë‹¤ìŒ ì˜ì–´ ë¬¸ë‹¨ ê°„ê²© ë‹¤ë“¬ê¸° */</span>
<span class="nc">.md-typeset</span> <span class="nt">p</span> <span class="o">+</span> <span class="nt">p</span><span class="nc">.en</span> <span class="p">{</span> <span class="nl">margin-top</span><span class="p">:</span> <span class="m">0.25em</span><span class="p">;</span> <span class="p">}</span>

<span class="c">/* &lt;en&gt;ì„ ì¤„ë°”ê¿ˆ í˜•íƒœë¡œ ì“°ë ¤ë©´ */</span>
<span class="nc">.md-typeset</span> <span class="nt">en</span> <span class="p">{</span> <span class="nl">display</span><span class="p">:</span> <span class="nb">block</span><span class="p">;</span> <span class="nl">margin-top</span><span class="p">:</span> <span class="m">0.25em</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div></div>

<ol>
  <li><strong>ë¹ ë¥¸ ì²´í¬ë¦¬ìŠ¤íŠ¸</strong></li>
</ol>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">mkdocs.yml</code>ì— <code class="language-plaintext highlighter-rouge">- attr_list</code>ê°€ ìˆìŒ?</p>
  </li>
  <li>
    <p>CSSê°€ <code class="language-plaintext highlighter-rouge">extra_css</code>ë¡œ ë¡œë“œë¨?</p>
  </li>
  <li>
    <p>í•œê¸€ ì¤„ ë <strong>ê³µë°± ë‘ ê°œ</strong> ë¡œ ì¤„ë°”ê¿ˆì„ ë§Œë“¤ê³  ìˆì§€ëŠ” ì•ŠìŒ? (ê·¸ëŸ¼ ê°™ì€ ë¬¸ë‹¨ì´ ë©ë‹ˆë‹¤)</p>
  </li>
  <li>
    <p>ì˜ì–´ë¥¼ <strong>ë³„ë„ ë¬¸ë‹¨</strong> ìœ¼ë¡œ ë§Œë“¤ì—ˆëŠ”ì§€, ì•„ë‹ˆë©´ <code class="language-plaintext highlighter-rouge">&lt;span class="en"&gt;â€¦&lt;/span&gt;</code>ë¡œ <strong>ì¸ë¼ì¸ë§Œ</strong> ê°ìŒŒëŠ”ì§€</p>
  </li>
</ul>

<p>ìš”ì•½: <code class="language-plaintext highlighter-rouge">{.en}</code>/<strong><code class="language-plaintext highlighter-rouge">{:.en}</code>ì€ ì œëŒ€ë¡œ ë™ì‘</strong>í•©ë‹ˆë‹¤. ë‹¤ë§Œ â€œì†ì„±ì€ <strong>ë°”ë¡œ ì• ë¸”ë¡ ì „ì²´</strong> ì— ë¶™ëŠ”ë‹¤â€ëŠ” ê·œì¹™ ë•Œë¬¸ì—, ì˜ì–´ë§Œ ìŠ¤íƒ€ì¼ë§í•˜ë ¤ë©´ <strong>ì˜ì–´ë¥¼ ë³„ë„ ë¸”ë¡ìœ¼ë¡œ ë¶„ë¦¬</strong> í•˜ê±°ë‚˜ <strong>ì˜ì–´ë§Œ ì¸ë¼ì¸ìœ¼ë¡œ ê°ì‹¸ì•¼</strong> í•©ë‹ˆë‹¤.</p>

<p class="chat--user">

ì•„ë‹ˆ ê·¸ëƒ¥ Hello. Everyone. {.en} ì´ë ‡ê²Œ ìµœì¢… ë Œë”ë§ ë˜ëŠ”ë°

</p>

<p>ì•„í•˜, ê·¸ëŸ¼ ìƒí™©ì´ í™•ì‹¤í•´ìš”.<br />
<strong><code class="language-plaintext highlighter-rouge">Hello. Everyone. {.en}</code>ê°€ ê·¸ëŒ€ë¡œ ê¸€ìë¡œ ë³´ì´ëŠ” ê±´ MkDocs(=Python-Markdown)</strong>ì—ì„œëŠ” <strong>ë¬¸ë‹¨(paragraph) ëì—<code class="language-plaintext highlighter-rouge">{.en}</code>ì„ ë¶™ì´ëŠ” ë¬¸ë²•ì´ ë™ì‘í•˜ì§€ ì•Šê¸° ë•Œë¬¸</strong>ì…ë‹ˆë‹¤. ê·¸ê±´ ì£¼ë¡œ <strong>Kramdown(Jekyll)</strong> ìª½ ë¬¸ë²•ì´ê³ , MkDocsì—ì„œëŠ” <strong>ë‹¨ë… ì¤„ì˜ ì†ì„± ë¸”ë¡</strong> ì„ ì¨ì•¼ í•´ìš”.</p>

<p>ì•„ë˜ì²˜ëŸ¼ ê³ ì¹˜ë©´ ë©ë‹ˆë‹¤â€”ì°¨ê·¼ì°¨ê·¼:</p>

<h2 id="1-ê²°ë¡ ë¶€í„°-ì´ë ‡ê²Œ-ì“°ì„¸ìš”">1) ê²°ë¡ ë¶€í„°: ì´ë ‡ê²Œ ì“°ì„¸ìš”</h2>
<div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ì•ˆë…•í•˜ì„¸ìš”.

{:.en lang=en}
Hello. Everyone.
</code></pre></div></div>

<ul>
  <li>
    <p>í¬ì¸íŠ¸ 1: <strong>í•œêµ­ì–´ì™€ ì˜ì–´ ì‚¬ì´ì— ë¹ˆ ì¤„ 1ê°œ</strong> â†’ ì„œë¡œ <strong>ë‹¤ë¥¸ ë¬¸ë‹¨</strong> ì´ ë©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>í¬ì¸íŠ¸ 2: <code class="language-plaintext highlighter-rouge">{: .en}</code>ì€ <strong>â€œë°”ë¡œ ì•„ë˜ ë¸”ë¡(ì˜ì–´ ë¬¸ë‹¨)â€</strong> ì—ë§Œ ë¶™ê²Œ ì•ì¤„ì— ë‘¡ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>í¬ì¸íŠ¸ 3: ì ‘ê·¼ì„±ìš©ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">lang=en</code>ë„ ê°™ì´ ë‹¬ì•„ì£¼ë©´ ì¢‹ì•„ìš”.</p>
  </li>
</ul>

<h2 id="2-ì™œ-hello-everyone-enê°€-ì•ˆ-ë¨¹ë‚˜">2) ì™œ <code class="language-plaintext highlighter-rouge">Hello. Everyone. {.en}</code>ê°€ ì•ˆ ë¨¹ë‚˜?</h2>

<ul>
  <li>
    <p>MkDocsì˜ <strong>attr_list</strong> ëŠ” â€œ<strong>ë‹¨ë… ì¤„</strong> ì˜ ì†ì„± ë¸”ë¡â€ì´ë‚˜ â€œ<strong>íŠ¹ì • ìš”ì†Œ ë°”ë¡œ ë’¤</strong>(ì˜ˆ: ì´ë¯¸ì§€, ë§í¬, í—¤ë” ë“±)â€ì—ì„œ ì£¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>í‰ë²”í•œ ë¬¸ë‹¨ í…ìŠ¤íŠ¸</strong> ë’¤ì— ê°™ì€ ì¤„ë¡œ <code class="language-plaintext highlighter-rouge">{.en}</code>ì„ ë¶™ì´ëŠ” ë°©ì‹ì€ <strong>ì§€ì›í•˜ì§€ ì•Šì•„ì„œ</strong> ê·¸ëŒ€ë¡œ ë Œë”ë§ë¼ìš”.</p>
  </li>
</ul>

<h2 id="3-ê³µë°±-ë‘-ì¹¸ì—”í„°-ì“°ë©´-ì™œ-í•œê¸€ê¹Œì§€-íë ¤ì§€ë‚˜">3) ê³µë°± ë‘ ì¹¸(+ì—”í„°) ì“°ë©´ ì™œ í•œê¸€ê¹Œì§€ íë ¤ì§€ë‚˜?</h2>

<ul>
  <li>
    <p>ì¤„ ë <strong>ê³µë°± ë‘ ì¹¸</strong> ì€ <strong>ê°™ì€ ë¬¸ë‹¨ ì•ˆ <code class="language-plaintext highlighter-rouge">&lt;br&gt;</code></strong>ë§Œ ë§Œë“¤ì–´ìš”.</p>
  </li>
  <li>
    <p>ê·¸ë˜ì„œ â€œì•ˆë…•í•˜ì„¸ìš” + <code class="language-plaintext highlighter-rouge">&lt;br&gt;</code> + Hello â€¦â€ê°€ <strong>í•œ ë¬¸ë‹¨</strong> ì´ ë˜ê³ ,<br />
ë’¤ì¤„ì˜ <code class="language-plaintext highlighter-rouge">{: .en}</code>ì„ ì“°ë©´ <strong>ê·¸ í•œ ë¬¸ë‹¨ ì „ì²´</strong> ì— í´ë˜ìŠ¤ê°€ ë¶™ì–´ <strong>í•œê¸€ê¹Œì§€ ì—°í•´ì§‘ë‹ˆë‹¤.</strong></p>
  </li>
  <li>
    <p>í•´ê²°: ê³µë°± ë‘ ì¹¸ì„ <strong>ì§€ìš°ê³  ë¹ˆ ì¤„</strong> ë¡œ <strong>ë¬¸ë‹¨ ë¶„ë¦¬</strong> í•˜ê±°ë‚˜, ê°™ì€ ë¬¸ë‹¨ì„ ìœ ì§€í•˜ê³  ì‹¶ë‹¤ë©´ <strong>ì˜ì–´ë§Œ ì¸ë¼ì¸ìœ¼ë¡œ ê°ì‹¸ê¸°</strong> ğŸ‘‡</p>
  </li>
</ul>

<div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ì•ˆë…•í•˜ì„¸ìš”.<span class="nt">&lt;br&gt;</span>
<span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"en"</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>Hello. Everyone.<span class="nt">&lt;/span&gt;</span>
</code></pre></div></div>

<h2 id="4-cssê·¸ëŒ€ë¡œ-ì“°ì…”ë„-ë©ë‹ˆë‹¤">4) CSS(ê·¸ëŒ€ë¡œ ì“°ì…”ë„ ë©ë‹ˆë‹¤)</h2>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/* ì˜ì–´ ë²ˆì—­: ì¡°ê¸ˆ ì‘ê³  ì—°í•˜ê²Œ */</span>
<span class="nc">.md-typeset</span> <span class="nc">.en</span><span class="o">,</span>
<span class="nc">.md-typeset</span> <span class="nt">en</span> <span class="p">{</span>
  <span class="nl">font-size</span><span class="p">:</span> <span class="m">0.85em</span><span class="p">;</span>
  <span class="nl">opacity</span><span class="p">:</span> <span class="m">0.65</span><span class="p">;</span>
<span class="p">}</span>

<span class="c">/* &lt;en&gt; ì»¤ìŠ¤í…€ íƒœê·¸ë¥¼ ë¸”ë¡ì²˜ëŸ¼ ì“¸ ë•Œ */</span>
<span class="nc">.md-typeset</span> <span class="nt">en</span> <span class="p">{</span>
  <span class="nl">display</span><span class="p">:</span> <span class="nb">block</span><span class="p">;</span>
  <span class="nl">margin-top</span><span class="p">:</span> <span class="m">0.25em</span><span class="p">;</span>
<span class="p">}</span>

<span class="c">/* ë¬¸ë‹¨ ë¶„ë¦¬ ì¼€ì´ìŠ¤: í•œê¸€ ë¬¸ë‹¨ ë°”ë¡œ ë’¤ ì˜ì–´ ë¬¸ë‹¨ì˜ ê°„ê²© */</span>
<span class="nc">.md-typeset</span> <span class="nt">p</span> <span class="o">+</span> <span class="nt">p</span><span class="nc">.en</span> <span class="p">{</span> <span class="nl">margin-top</span><span class="p">:</span> <span class="m">0.25em</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div></div>

<h2 id="5-ë¹ ë¥¸-ì²´í¬">5) ë¹ ë¥¸ ì²´í¬</h2>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">mkdocs.yml</code> â†’ <code class="language-plaintext highlighter-rouge">markdown_extensions: - attr_list</code> ë“¤ì–´ê°€ ìˆë‚˜ìš”?</p>
  </li>
  <li>
    <p>í•œêµ­ì–´ ì¤„ ë <strong>ê³µë°± ë‘ ì¹¸</strong> ì œê±°í•˜ê³  <strong>ë¹ˆ ì¤„</strong> ë¡œ ë¬¸ë‹¨ ë¶„ë¦¬í–ˆë‚˜ìš”?</p>
  </li>
  <li>
    <p>ì˜ì–´ ë¬¸ë‹¨ <strong>ì•ì¤„</strong> ì— <code class="language-plaintext highlighter-rouge">{: .en}</code>ì„ ë’€ë‚˜ìš”? (ë’¤ì¤„Ã—, ê°™ì€ ì¤„Ã—)</p>
  </li>
</ol>

<p>ì›í•˜ì‹œë©´ ì§€ê¸ˆ ë¬¸ì œ ë‚˜ëŠ” ì‹¤ì œ 3~4ì¤„ ë¶™ì—¬ ì£¼ì‹œë©´, ê·¸ í˜•íƒœì— ë”± ë§ì¶° â€œí•œ ì¤„ ìˆ˜ì •â€ ë²„ì „ìœ¼ë¡œ ë°”ë¡œ ê³ ì³ë“œë¦´ê²Œìš”!</p>

<p class="chat--user">

markdown íŒ¨í‚¤ì§€ë§Œ ê°€ì§€ê³  í•œ ë²ˆ í…ŒìŠ¤íŠ¸ í•´ë³´ê³  ì‹¶ì–´. ì¥¬í”¼í„° ë…¸íŠ¸ë¶ ì˜ˆì‹œ ë§Œë“¤ì–´ì¤˜

</p>

<p>ì¢‹ì•„! <strong>Python-Markdownë§Œ</strong> ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•´ë³¼ ìˆ˜ ìˆëŠ” ì¥¬í”¼í„° ë…¸íŠ¸ë¶ì„ ë§Œë“¤ì–´ ë†¨ì–´.<br />
ì—¬ê¸°ì„œ ë‚´ë ¤ë°›ì•„ ë¡œì»¬ì—ì„œ ì‹¤í–‰í•´ ë³´ì„¸ìš”:</p>

<p>Download the Jupyter Notebook</p>

<h3 id="ë…¸íŠ¸ë¶ì—-ë“¤ì–´ìˆëŠ”-ê²ƒ-step-by-step">ë…¸íŠ¸ë¶ì— ë“¤ì–´ìˆëŠ” ê²ƒ (step-by-step)</h3>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">!pip install markdown</code> â€” Python-Markdown ì„¤ì¹˜</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">attr_list</code> í™•ì¥ ì¼  ë Œë” í•¨ìˆ˜ + CSS</p>
  </li>
  <li>
    <p>ì¼€ì´ìŠ¤ë³„ ë¯¸ë¦¬ë³´ê¸°:</p>

    <ul>
      <li>
        <p><strong>A</strong> : <code class="language-plaintext highlighter-rouge">Hello. Everyone. {.en}</code> â†’ <em>ë™ì‘ ì•ˆ í•˜ëŠ”</em> ì˜ˆì‹œë¥¼ ëˆˆìœ¼ë¡œ í™•ì¸</p>
      </li>
      <li>
        <p><strong>B</strong> : <code class="language-plaintext highlighter-rouge">{: .en}</code> ì¤„ì„ <strong>ì•</strong> ì— ë‘ë©´ <strong>ë‹¤ìŒ ë¸”ë¡</strong> ì— ì ìš©</p>
      </li>
      <li>
        <p><strong>C</strong> : <code class="language-plaintext highlighter-rouge">{: .en}</code> ì¤„ì„ <strong>ë’¤</strong> ì— ë‘ë©´ <strong>ì´ì „ ë¸”ë¡</strong> ì— ì ìš©</p>
      </li>
      <li>
        <p><strong>D</strong> : ë¹ˆ ì¤„ë¡œ ë¬¸ë‹¨ ë¶„ë¦¬ í›„ ì˜ì–´ ë¬¸ë‹¨ì—ë§Œ <code class="language-plaintext highlighter-rouge">{:.en}</code> ì ìš©</p>
      </li>
      <li>
        <p><strong>E</strong> : ê°™ì€ ë¬¸ë‹¨ ìœ ì§€ â†’ <code class="language-plaintext highlighter-rouge">&lt;br&gt;</code> + <code class="language-plaintext highlighter-rouge">&lt;span class="en"&gt;â€¦&lt;/span&gt;</code></p>
      </li>
      <li>
        <p><strong>F</strong> : <code class="language-plaintext highlighter-rouge">&lt;en&gt;â€¦&lt;/en&gt;</code> ì»¤ìŠ¤í…€ íƒœê·¸</p>
      </li>
    </ul>
  </li>
</ol>

<h3 id="ì‚¬ìš©-íŒ-í•µì‹¬ë§Œ">ì‚¬ìš© íŒ (í•µì‹¬ë§Œ)</h3>

<ul>
  <li>
    <p><strong>ë¬¸ë‹¨ í…ìŠ¤íŠ¸ ê°™ì€ ì¤„ ëì˜<code class="language-plaintext highlighter-rouge">{.en}</code></strong> ëŠ” ë³´í†µ <strong>ë¬¸ë‹¨ì—ëŠ” ì ìš©ë˜ì§€ ì•ŠìŒ</strong> â†’ A ì¼€ì´ìŠ¤ë¡œ í™•ì¸ ê°€ëŠ¥</p>
  </li>
  <li>
    <p>ë¬¸ë‹¨ì— í´ë˜ìŠ¤ ì£¼ë ¤ë©´ <strong>ì†ì„±ë§Œ ìˆëŠ” ì¤„</strong>(<code class="language-plaintext highlighter-rouge">{:.en}</code>)ì„ <strong>ì• ë˜ëŠ” ë’¤</strong> ì— ë‘¬ì„œ <strong>ê·¸ ë¸”ë¡ì— ë¶™ì´ê¸°</strong>(B/C)</p>
  </li>
  <li>
    <p>í•œêµ­ì–´/ì˜ì–´ë¥¼ <strong>ë‹¤ë¥¸ ë¬¸ë‹¨</strong> ìœ¼ë¡œ ë¶„ë¦¬í•˜ë©´(D) ì œì–´ê°€ ê°€ì¥ ê¹”ë”</p>
  </li>
  <li>
    <p>í•œ ë¬¸ë‹¨ ë‚´ ì¤„ë°”ê¿ˆì´ë©´(E) ì˜ì–´ë§Œ <code class="language-plaintext highlighter-rouge">&lt;span class="en"&gt;</code>ë¡œ ê°ì‹¸ê¸°</p>
  </li>
</ul>

<p>ë…¸íŠ¸ë¶ ëŒë ¤ë³´ì‹œê³ , í˜¹ì‹œ íŠ¹ì • ì¼€ì´ìŠ¤ê°€ ê¸°ëŒ€ì™€ ë‹¤ë¥´ê²Œ ë‚˜ì˜¤ë©´ ê·¸ ì…€ ì¶œë ¥ ìº¡ì²˜ë‚˜ ì›ë¬¸ì„ ë¶™ì—¬ì¤˜â€”ì›ì¸ ë”± ì§‘ì–´ì„œ ê³ ì³ë“œë¦´ê²Œ!</p>

<p class="chat--user">

ë³´ê¸° í˜ë“¤ì–´ ê·¸ëƒ¥ ë³¸ë¬¸ì— ì¨ì¤˜

</p>

<p>ì˜¤ì¼€ì´â€”ë…¸íŠ¸ë¶ íŒŒì¼ ë§ê³ , <strong>ê·¸ëŒ€ë¡œ ë³µë¶™í•´ì„œ ëŒë¦´ ìˆ˜ ìˆëŠ” ì…€</strong> ì„ ë³¸ë¬¸ì— ì”ë‹ˆë‹¤.<br />
ì•„ë˜ ë‘ ì…€ë§Œ Jupyterì— ìˆœì„œëŒ€ë¡œ ë¶™ì—¬ë„£ê³  ì‹¤í–‰í•˜ì„¸ìš”. (ì²« ì…€ì€ ì„¤ì¹˜, ë‘ ë²ˆì§¸ ì…€ì€ ì¼€ì´ìŠ¤ A~Fë¥¼ í•œ ë²ˆì— ë Œë”/ë¯¸ë¦¬ë³´ê¸°)</p>

<hr />

<h3 id="ì…€-1--ì„¤ì¹˜">ì…€ 1 â€” ì„¤ì¹˜</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">!</span><span class="n">pip</span> <span class="o">-</span><span class="n">q</span> <span class="n">install</span> <span class="n">markdown</span>
</code></pre></div></div>

<h3 id="ì…€-2--ë Œë”-ë„ìš°ë¯¸--ì¼€ì´ìŠ¤-af-ë¯¸ë¦¬ë³´ê¸°">ì…€ 2 â€” ë Œë” ë„ìš°ë¯¸ + ì¼€ì´ìŠ¤ A~F ë¯¸ë¦¬ë³´ê¸°</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">IPython.display</span> <span class="kn">import</span> <span class="n">HTML</span><span class="p">,</span> <span class="n">display</span>
<span class="kn">import</span> <span class="n">markdown</span>

<span class="n">CSS</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
.md-typeset .en,
.md-typeset en {
  font-size: 0.85em;
  opacity: 0.65;
}
.md-typeset en {
  display: block;
  margin-top: 0.25em;
}
.md-typeset p + p.en {  /* í•œêµ­ì–´ ë¬¸ë‹¨ ë°”ë¡œ ë‹¤ìŒ ì˜ì–´ ë¬¸ë‹¨ ê°„ê²© */
  margin-top: 0.25em;
}
/* ë³´ê¸° í¸í•˜ë„ë¡ í…Œë‘ë¦¬ */
.demo {
  border: 1px solid #ddd;
  padding: 12px;
  margin: 8px 0 24px 0;
  border-radius: 6px;
  background: #fafafa;
}
</span><span class="sh">'''</span>

<span class="k">def</span> <span class="nf">render_md</span><span class="p">(</span><span class="n">md_text</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sh">""</span><span class="p">):</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">markdown</span><span class="p">.</span><span class="nf">markdown</span><span class="p">(</span>
        <span class="n">md_text</span><span class="p">,</span>
        <span class="n">extensions</span><span class="o">=</span><span class="p">[</span>
            <span class="sh">"</span><span class="s">attr_list</span><span class="sh">"</span><span class="p">,</span>   <span class="c1"># í•µì‹¬ í™•ì¥
</span>            <span class="c1"># "extra",     # ì›í•˜ë©´ ì¶”ê°€(ì—¬ê¸°ì—ë„ attr_list í¬í•¨ë¨)
</span>            <span class="c1"># "md_in_html" # ë³µì¡í•œ HTML ë¸”ë¡ ë‚´ ë§ˆí¬ë‹¤ìš´ì´ í•„ìš”í•  ë•Œ
</span>        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">wrapped</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"""</span><span class="s">
    &lt;style&gt;</span><span class="si">{</span><span class="n">CSS</span><span class="si">}</span><span class="s">&lt;/style&gt;
    &lt;div class=</span><span class="sh">"</span><span class="s">demo</span><span class="sh">"</span><span class="s">&gt;
      &lt;div&gt;&lt;strong&gt;Markdown ì›ë¬¸&lt;/strong&gt;&lt;/div&gt;
      &lt;pre style=</span><span class="sh">"</span><span class="s">white-space:pre-wrap</span><span class="sh">"</span><span class="s">&gt;</span><span class="si">{</span><span class="n">md_text</span><span class="si">}</span><span class="s">&lt;/pre&gt;
      &lt;div style=</span><span class="sh">"</span><span class="s">margin-top:8px</span><span class="sh">"</span><span class="s">&gt;&lt;strong&gt;ë Œë” ê²°ê³¼&lt;/strong&gt;&lt;/div&gt;
      &lt;div class=</span><span class="sh">"</span><span class="s">md-typeset</span><span class="sh">"</span><span class="s">&gt;</span><span class="si">{</span><span class="n">html</span><span class="si">}</span><span class="s">&lt;/div&gt;
    &lt;/div&gt;
    </span><span class="sh">"""</span>
    <span class="nf">display</span><span class="p">(</span><span class="nc">HTML</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">&lt;h3&gt;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s">&lt;/h3&gt;</span><span class="sh">"</span> <span class="o">+</span> <span class="n">wrapped</span><span class="p">))</span>

<span class="c1"># â”€â”€â”€â”€â”€â”€â”€â”€â”€ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€
</span>
<span class="c1"># A) ê°™ì€ ì¤„ ëì— {.en} â†’ ì¼ë°˜ ë¬¸ë‹¨ì—ì„œëŠ” ë³´í†µ "ë™ì‘ ì•ˆ í•¨" (ê·¸ëŒ€ë¡œ í…ìŠ¤íŠ¸ë¡œ ë³´ì„)
</span><span class="n">case_A</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">Hello. Everyone. {.en}</span><span class="sh">"""</span>

<span class="c1"># B) ì†ì„± ì¤„ì„ 'ì•'ì— ë‘ë©´ â†’ "ë‹¤ìŒ ë¸”ë¡"ì— ì ìš©
</span><span class="n">case_B</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">{:.en lang=en}
Hello. Everyone.</span><span class="sh">"""</span>

<span class="c1"># C) ì†ì„± ì¤„ì„ 'ë’¤'ì— ë‘ë©´ â†’ "ì´ì „ ë¸”ë¡"ì— ì ìš©
</span><span class="n">case_C</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">Hello. Everyone.
{:.en lang=en}</span><span class="sh">"""</span>

<span class="c1"># D) ë¬¸ë‹¨ ë¶„ë¦¬(ë¹ˆ ì¤„) í›„ ì˜ì–´ ë¬¸ë‹¨ì—ë§Œ ì ìš©
</span><span class="n">case_D</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">ì•ˆë…•í•˜ì„¸ìš”.

Hello. Everyone.
{:.en}</span><span class="sh">"""</span>

<span class="c1"># E) ê°™ì€ ë¬¸ë‹¨ ìœ ì§€: ì¤„ë°”ê¿ˆì€ &lt;br&gt;, ì˜ì–´ë§Œ ì¸ë¼ì¸ìœ¼ë¡œ ê°ì‹¸ê¸°
</span><span class="n">case_E</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">ì•ˆë…•í•˜ì„¸ìš”.&lt;br&gt;
&lt;span class=</span><span class="sh">"</span><span class="s">en</span><span class="sh">"</span><span class="s"> lang=</span><span class="sh">"</span><span class="s">en</span><span class="sh">"</span><span class="s">&gt;Hello. Everyone.&lt;/span&gt;</span><span class="sh">"""</span>

<span class="c1"># F) ì»¤ìŠ¤í…€ íƒœê·¸ &lt;en&gt;
</span><span class="n">case_F</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">ì•ˆë…•í•˜ì„¸ìš”.
&lt;en lang=</span><span class="sh">"</span><span class="s">en</span><span class="sh">"</span><span class="s">&gt;Hello. Everyone.&lt;/en&gt;</span><span class="sh">"""</span>

<span class="c1"># ë Œë”
</span><span class="nf">render_md</span><span class="p">(</span><span class="n">case_A</span><span class="p">,</span> <span class="sh">"</span><span class="s">A) same-line `{.en}` (ë¬¸ë‹¨ì—ëŠ” ë³´í†µ ì ìš© ì•ˆ ë¨)</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">render_md</span><span class="p">(</span><span class="n">case_B</span><span class="p">,</span> <span class="sh">"</span><span class="s">B) attr ì¤„ì„ ì•ì— â†’ ë‹¤ìŒ ë¸”ë¡ì— ì ìš©</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">render_md</span><span class="p">(</span><span class="n">case_C</span><span class="p">,</span> <span class="sh">"</span><span class="s">C) attr ì¤„ì„ ë’¤ì— â†’ ì´ì „ ë¸”ë¡ì— ì ìš©</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">render_md</span><span class="p">(</span><span class="n">case_D</span><span class="p">,</span> <span class="sh">"</span><span class="s">D) ë¬¸ë‹¨ ë¶„ë¦¬ + ì˜ì–´ ë¬¸ë‹¨ë§Œ ìŠ¤íƒ€ì¼</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">render_md</span><span class="p">(</span><span class="n">case_E</span><span class="p">,</span> <span class="sh">"</span><span class="s">E) ê°™ì€ ë¬¸ë‹¨ ìœ ì§€: &lt;br&gt; + &lt;span class=</span><span class="sh">'</span><span class="s">en</span><span class="sh">'</span><span class="s">&gt;</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">render_md</span><span class="p">(</span><span class="n">case_F</span><span class="p">,</span> <span class="sh">"</span><span class="s">F) ì»¤ìŠ¤í…€ íƒœê·¸ &lt;en&gt;</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="ë¬´ì—‡ì´-ë³´ì´ë©´-ì •ìƒì¸ê°€-ì²´í¬-í¬ì¸íŠ¸">ë¬´ì—‡ì´ ë³´ì´ë©´ ì •ìƒì¸ê°€ (ì²´í¬ í¬ì¸íŠ¸)</h2>

<ul>
  <li>
    <p><strong>A</strong> : <code class="language-plaintext highlighter-rouge">Hello. Everyone. {.en}</code> ê°€ <strong>ê·¸ëŒ€ë¡œ ê¸€ì</strong> ë¡œ ë³´ì„ â†’ ì¼ë°˜ ë¬¸ë‹¨ì—ì„œëŠ” ê°™ì€ ì¤„ ë <code class="language-plaintext highlighter-rouge">{.en}</code>ì´ <strong>ì•ˆ ë¨¹ëŠ”ë‹¤</strong> ëŠ” ì¦ê±°.</p>
  </li>
  <li>
    <p><strong>B</strong> : ì˜ì–´ ì¤„ì´ <strong>ì‘ê³  ì—°í•˜ê²Œ</strong> ë³´ì„ â†’ <code class="language-plaintext highlighter-rouge">{:.en}</code> (ì†ì„±ë§Œ ìˆëŠ” ì¤„)ì´ <strong>ì•„ë˜ ë¸”ë¡(ë‹¤ìŒ ë¬¸ë‹¨)</strong> ì— ì ìš©.</p>
  </li>
  <li>
    <p><strong>C</strong> : ì˜ì–´ ì¤„ì´ <strong>ì‘ê³  ì—°í•˜ê²Œ</strong> ë³´ì„ â†’ <code class="language-plaintext highlighter-rouge">{:.en}</code>ì´ <strong>ìœ„ ë¸”ë¡(ì´ì „ ë¬¸ë‹¨)</strong> ì— ì ìš©.</p>
  </li>
  <li>
    <p><strong>D</strong> : í•œêµ­ì–´/ì˜ì–´ê°€ <strong>ì„œë¡œ ë‹¤ë¥¸ ë¬¸ë‹¨</strong> ì´ë©°, <strong>ì˜ì–´ë§Œ</strong> ì‘ê³  ì—°í•¨.</p>
  </li>
  <li>
    <p><strong>E</strong> : í•œ ë¬¸ë‹¨ìœ¼ë¡œ ë³´ì´ë˜, <code class="language-plaintext highlighter-rouge">&lt;br&gt;</code> ë‹¤ìŒ ì¤„ì˜ ì˜ì–´ë§Œ <strong>ì‘ê³  ì—°í•¨</strong>.</p>
  </li>
  <li>
    <p><strong>F</strong> : <code class="language-plaintext highlighter-rouge">&lt;en&gt;â€¦&lt;/en&gt;</code>ë„ <strong>ì‘ê³  ì—°í•¨</strong>. (ì»¤ìŠ¤í…€ íƒœê·¸ë¥¼ CSSì—ì„œ ì„ íƒìë¡œ ì¡ìŒ)</p>
  </li>
</ul>

<blockquote>
  <p>ê²°ë¡ : <strong>ë¬¸ë‹¨ í…ìŠ¤íŠ¸ ê°™ì€ ì¤„ ëì˜<code class="language-plaintext highlighter-rouge">{.en}</code>ì€ ê¸°ëŒ€ëŒ€ë¡œ ë™ì‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</strong><br />
 ë¬¸ë‹¨ì— í´ë˜ìŠ¤ë¥¼ ì£¼ë ¤ë©´ <strong>ì†ì„±ë§Œ ìˆëŠ” ì¤„(<code class="language-plaintext highlighter-rouge">{:.en}</code>)</strong> ì„ <strong>ì•/ë’¤</strong> ì— ë‘ê±°ë‚˜,<br />
 ê°™ì€ ë¬¸ë‹¨ì„ ìœ ì§€í•˜ë ¤ë©´ <strong><code class="language-plaintext highlighter-rouge">&lt;br&gt;</code> + <code class="language-plaintext highlighter-rouge">&lt;span class="en"&gt;â€¦&lt;/span&gt;</code></strong> ë°©ì‹ì´ ê°€ì¥ í™•ì‹¤í•©ë‹ˆë‹¤.</p>
</blockquote>

<p>ì›í•˜ì‹œë©´ ì´ ì¼€ì´ìŠ¤ ì¤‘ ë”± ë§ëŠ” íŒ¨í„´ì„ ê³¨ë¼ MkDocsì— ê·¸ëŒ€ë¡œ ì´ì‹í•˜ëŠ” ì˜ˆì‹œë„ ë°”ë¡œ ì ì–´ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

ì•„ë¬´ë¦¬ í•´ë„ ê·¸ëƒ¥ ì• ë’¤ ì¤„ ë„ì›Œì•¼í•¨

</p>

<p>ë§ì•„ìš”. <strong>ê²°ë¡  = ë¸”ë¡ ì†ì„± ì¤„(<code class="language-plaintext highlighter-rouge">{: .en}</code>)ì€ â€œë…ë¦½ ë¸”ë¡â€ì´ì–´ì•¼ í•´ì„œ ì•ë’¤ë¡œ ë¹ˆ ì¤„ì„ ë‘¬ì„œ â€˜ì™„ì „íˆ ë¶„ë¦¬â€™í•˜ë©´ ê°€ì¥ ì•ˆì „</strong>í•©ë‹ˆë‹¤. íŠ¹íˆ Python-Markdown/MkDocs ì¡°í•©ì—ì„œëŠ” ì´ ê·œì¹™ì´ ê¹Œë‹¤ë¡œì›Œì„œ, ì‹¤ì „ì—ì„œëŠ” â€œì•Â·ë’¤ ì¤„ ë„ìš°ê¸°â€ê°€ ì‚¬ì‹¤ìƒ ì •ì„ì´ì—ìš”.</p>

<p>ì•„ë˜ 3ê°€ì§€ <strong>í•­ìƒ ì˜ ë¨¹ëŠ” íŒ¨í„´</strong> ë§Œ ì¨ì£¼ì„¸ìš”.</p>

<hr />

<h2 id="1-ì´ì „-ë¬¸ë‹¨ì˜ì–´ì—-ì ìš©--ê°€ì¥-ì¶”ì²œ">1) â€œì´ì „ ë¬¸ë‹¨(ì˜ì–´)â€ì— ì ìš© â€” ê°€ì¥ ì¶”ì²œ</h2>
<div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ì•ˆë…•í•˜ì„¸ìš”.

Hello. Everyone.

{: .en lang=en}
</code></pre></div></div>

<ul>
  <li>í¬ì¸íŠ¸: <code class="language-plaintext highlighter-rouge">{: .en}</code> <strong>ìœ„Â·ì•„ë˜ ëª¨ë‘ ë¹ˆ ì¤„</strong> â†’ ì†ì„± ì¤„ì´ ì™„ì „íˆ ë…ë¦½ëœ ë‹¨ë½ì´ ë˜ì–´ <strong>ë°”ë¡œ ìœ„ ë¬¸ë‹¨(ì˜ì–´)</strong> ì—ë§Œ ë¶™ìŠµë‹ˆë‹¤.</li>
</ul>

<hr />

<h2 id="2-ë‹¤ìŒ-ë¬¸ë‹¨ì˜ì–´ì—-ì ìš©">2) â€œë‹¤ìŒ ë¬¸ë‹¨(ì˜ì–´)â€ì— ì ìš©</h2>
<div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ì•ˆë…•í•˜ì„¸ìš”.

{: .en lang=en}

Hello. Everyone.
</code></pre></div></div>

<ul>
  <li>í¬ì¸íŠ¸: ë§ˆì°¬ê°€ì§€ë¡œ ì†ì„± ì¤„ <strong>ì•Â·ë’¤ ë¹ˆ ì¤„</strong> â†’ <strong>ë°”ë¡œ ì•„ë˜ ë¬¸ë‹¨(ì˜ì–´)</strong> ì—ë§Œ ë¶™ìŠµë‹ˆë‹¤.</li>
</ul>

<hr />

<h2 id="3-ê°™ì€-ë¬¸ë‹¨ì„-ìœ ì§€í•´ì•¼-í• -ë•Œì¤„ë°”ê¿ˆë§Œ--ì¸ë¼ì¸-ë°©ì‹">3) ê°™ì€ ë¬¸ë‹¨ì„ ìœ ì§€í•´ì•¼ í•  ë•Œ(ì¤„ë°”ê¿ˆë§Œ) â€” ì¸ë¼ì¸ ë°©ì‹</h2>
<div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ì•ˆë…•í•˜ì„¸ìš”.<span class="nt">&lt;br&gt;</span>
<span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"en"</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>Hello. Everyone.<span class="nt">&lt;/span&gt;</span>
</code></pre></div></div>

<ul>
  <li>ë¸”ë¡ ì†ì„± ê·œì¹™ì„ ê±´ë“œë¦¬ì§€ ì•Šì•„ì„œ í™˜ê²½ ì°¨ì´ì— ëœ ë¯¼ê°í•©ë‹ˆë‹¤.</li>
</ul>

<hr />

<h2 id="css-material-ê¸°ì¤€-ê³µí†µ">CSS (Material ê¸°ì¤€, ê³µí†µ)</h2>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">.md-typeset</span> <span class="nc">.en</span><span class="o">,</span> <span class="nc">.md-typeset</span> <span class="nt">en</span> <span class="p">{</span>
  <span class="nl">font-size</span><span class="p">:</span> <span class="m">0.85em</span><span class="p">;</span>   <span class="c">/* ì‘ê²Œ */</span>
  <span class="nl">opacity</span><span class="p">:</span> <span class="m">0.65</span><span class="p">;</span>       <span class="c">/* ì—°í•˜ê²Œ */</span>
<span class="p">}</span>
<span class="nc">.md-typeset</span> <span class="nt">en</span> <span class="p">{</span>        <span class="c">/* &lt;en&gt;ì„ ë¸”ë¡ì²˜ëŸ¼ ì“°ê³  ì‹¶ì„ ë•Œ */</span>
  <span class="nl">display</span><span class="p">:</span> <span class="nb">block</span><span class="p">;</span>
  <span class="nl">margin-top</span><span class="p">:</span> <span class="m">0.25em</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.md-typeset</span> <span class="nt">p</span> <span class="o">+</span> <span class="nt">p</span><span class="nc">.en</span> <span class="p">{</span>  <span class="c">/* í•œê¸€ ë¬¸ë‹¨ ë°”ë¡œ ë’¤ ì˜ì–´ ë¬¸ë‹¨ ê°„ê²© ë‹¤ë“¬ê¸° */</span>
  <span class="nl">margin-top</span><span class="p">:</span> <span class="m">0.25em</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="ì™œ-ì´ë ‡ê²Œ-í•´ì•¼-í•˜ë‚˜-ì§§ê²Œ">ì™œ ì´ë ‡ê²Œ í•´ì•¼ í•˜ë‚˜? (ì§§ê²Œ)</h3>

<ul>
  <li>
    <p>ì†ì„± ì¤„ì€ <strong>ê·¸ ìì²´ê°€ í•˜ë‚˜ì˜ â€œë‹¨ë½(block)â€</strong>ì´ì–´ì•¼ ì¸ì‹ë©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë¹ˆ ì¤„ì´ ì—†ìœ¼ë©´ íŒŒì„œê°€ â€œê°™ì€ ë¬¸ë‹¨ì˜ ì¼ë°˜ í…ìŠ¤íŠ¸â€ë¡œ ì˜¤í•´í•´ì„œ <code class="language-plaintext highlighter-rouge">{:.en}</code>ì´ <strong>ê·¸ëŒ€ë¡œ ê¸€ì</strong> ë¡œ ë³´ì´ê±°ë‚˜, í•œ ë¬¸ë‹¨ ì „ì²´(í•œê¸€+ì˜ì–´)ì— ì ìš©ë˜ëŠ” ì¼ì´ ìƒê¹ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ê·¸ë˜ì„œ <strong>ì†ì„± ì¤„ì„ ìœ„/ì•„ë˜ ë¹ˆ ì¤„ë¡œ ê³ ë¦½</strong> ì‹œí‚¤ëŠ” ìŠµê´€ì„ ë“¤ì´ë©´ ì–´ë””ì„œë“  ì•ˆì •ì ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤.</p>
  </li>
</ul>

<p>ì›í•˜ì‹œë©´ ì§€ê¸ˆ ì‘ì„±í•˜ì‹  ì‹¤ì œ ëª‡ ì¤„ì„ ë³´ë‚´ ì£¼ì‹œë©´, ìœ„ íŒ¨í„´ìœ¼ë¡œ <strong>ìµœì†Œ ìˆ˜ì •</strong> ë²„ì „ì„ ë°”ë¡œ ì¡ì•„ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

pymdownxì˜ caret ì²˜ëŸ¼ ê°„ë‹¨íˆ ê°€ë§Œì˜ <span class="en"> </span>ì„ ì¶”ê°€í•  ìˆ˜ ì—†ì„ê¹Œ

</p>

<p>ì¢‹ì•„, <strong>caret(ì˜ˆ:<code class="language-plaintext highlighter-rouge">^^text^^</code>)ì²˜ëŸ¼</strong> ê°„ë‹¨í•œ ê¸°í˜¸ë¡œ<br />
<code class="language-plaintext highlighter-rouge">&lt;span class="en"&gt;â€¦&lt;/span&gt;</code>ì„ ìë™ìœ¼ë¡œ ë„£ê³  ì‹¶ë‹¤ë©´ <strong>ì‘ì€ ì»¤ìŠ¤í…€ Markdown í™•ì¥</strong> ì„ í•˜ë‚˜ ì¶”ê°€í•˜ë©´ ë”± í•´ê²°ë¼ìš”.<br />
ì•„ë˜ëŒ€ë¡œ í•˜ë©´ <code class="language-plaintext highlighter-rouge">%%ì˜ë¬¸%%</code>ì²˜ëŸ¼ ì“°ê¸°ë§Œ í•´ë„ <code class="language-plaintext highlighter-rouge">&lt;span class="en" lang="en"&gt;ì˜ë¬¸&lt;/span&gt;</code>ìœ¼ë¡œ ë Œë”ë©ë‹ˆë‹¤.</p>

<hr />

<h1 id="1-íŒŒì´ì¬-í™•ì¥-íŒŒì¼-ë§Œë“¤ê¸°-510ì¤„ì§œë¦¬-í•µì‹¬">1) íŒŒì´ì¬ í™•ì¥ íŒŒì¼ ë§Œë“¤ê¸° (5~10ì¤„ì§œë¦¬ í•µì‹¬)</h1>

<p>í”„ë¡œì íŠ¸ ë£¨íŠ¸(ë³´í†µ <code class="language-plaintext highlighter-rouge">mkdocs.yml</code> ì˜†)ì— <code class="language-plaintext highlighter-rouge">en_span.py</code> íŒŒì¼ì„ ë§Œë“¤ê³  ì•„ë˜ë¥¼ ë³µë¶™í•˜ì„¸ìš”.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># en_span.py
</span><span class="kn">import</span> <span class="n">re</span>
<span class="kn">from</span> <span class="n">markdown.extensions</span> <span class="kn">import</span> <span class="n">Extension</span>
<span class="kn">from</span> <span class="n">markdown.inlinepatterns</span> <span class="kn">import</span> <span class="n">InlineProcessor</span>
<span class="kn">from</span> <span class="n">xml.etree</span> <span class="kn">import</span> <span class="n">ElementTree</span> <span class="k">as</span> <span class="n">etree</span>

<span class="k">class</span> <span class="nc">EnSpanInline</span><span class="p">(</span><span class="n">InlineProcessor</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">klass</span><span class="o">=</span><span class="sh">"</span><span class="s">en</span><span class="sh">"</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="sh">"</span><span class="s">en</span><span class="sh">"</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">md</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">klass</span> <span class="o">=</span> <span class="n">klass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">lang</span> <span class="o">=</span> <span class="n">lang</span>

    <span class="k">def</span> <span class="nf">handleMatch</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">replace</span><span class="p">(</span><span class="sa">r</span><span class="sh">'</span><span class="s">\%%</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">%%</span><span class="sh">'</span><span class="p">)</span>  <span class="c1"># \%% â†’ %
</span>        <span class="n">el</span> <span class="o">=</span> <span class="n">etree</span><span class="p">.</span><span class="nc">Element</span><span class="p">(</span><span class="sh">"</span><span class="s">span</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">el</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">class</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">klass</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">lang</span><span class="p">:</span>
            <span class="n">el</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">lang</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">lang</span><span class="p">)</span>
        <span class="n">el</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>
        <span class="k">return</span> <span class="n">el</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">m</span><span class="p">.</span><span class="nf">end</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">EnSpanExtension</span><span class="p">(</span><span class="n">Extension</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">delim</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">%%</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Inline delimiter, e.g. %%, ^^, !!</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">class</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">en</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">CSS class name</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">lang</span><span class="sh">"</span><span class="p">:</span>  <span class="p">[</span><span class="sh">"</span><span class="s">en</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">lang attribute (</span><span class="sh">''</span><span class="s"> to disable)</span><span class="sh">"</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">extendMarkdown</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">md</span><span class="p">):</span>
        <span class="n">delim</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">getConfig</span><span class="p">(</span><span class="sh">"</span><span class="s">delim</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">rf</span><span class="sh">"</span><span class="s">(?&lt;!\\)</span><span class="si">{</span><span class="n">re</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="n">delim</span><span class="p">)</span><span class="si">}</span><span class="s">(.+?)(?&lt;!\\)</span><span class="si">{</span><span class="n">re</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="n">delim</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="nc">EnSpanInline</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span>
                            <span class="n">klass</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">getConfig</span><span class="p">(</span><span class="sh">"</span><span class="s">class</span><span class="sh">"</span><span class="p">),</span>
                            <span class="n">lang</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">getConfig</span><span class="p">(</span><span class="sh">"</span><span class="s">lang</span><span class="sh">"</span><span class="p">))</span>
        <span class="c1"># 175: em/strong(EMPHASIS)ë³´ë‹¤ ì‚´ì§ ì•ì„œë„ë¡ ë“±ë¡
</span>        <span class="n">md</span><span class="p">.</span><span class="n">inlinePatterns</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="sh">"</span><span class="s">en-span</span><span class="sh">"</span><span class="p">,</span> <span class="mi">175</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">makeExtension</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="nc">EnSpanExtension</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></div>

<ul>
  <li>
    <p>ê¸°ë³¸ êµ¬ë¶„ìëŠ” <code class="language-plaintext highlighter-rouge">%%â€¦%%</code> ì…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>í…ìŠ¤íŠ¸ ì•ˆì—ì„œ <code class="language-plaintext highlighter-rouge">%%</code>ë¥¼ <strong>ë¬¸ì ê·¸ëŒ€ë¡œ ì“°ê³  ì‹¶ìœ¼ë©´</strong> <code class="language-plaintext highlighter-rouge">\%%</code>ë¡œ ì´ìŠ¤ì¼€ì´í”„í•˜ì„¸ìš”.</p>
  </li>
  <li>
    <p>ì´ë¯¸ <code class="language-plaintext highlighter-rouge">pymdownx.caret</code>(^^)ì„ ì“°ê³  ìˆë‹¤ë©´, ì¶©ëŒ ì—†ì´ <code class="language-plaintext highlighter-rouge">%%</code>ë§Œ ì“°ë©´ ë©ë‹ˆë‹¤. (ì›í•˜ë©´ <code class="language-plaintext highlighter-rouge">delim: "^^"</code>ë¡œ ë°”ê¿€ ìˆ˜ ìˆì–´ìš”)</p>
  </li>
</ul>

<hr />

<h1 id="2-mkdocsymlì—-í™•ì¥-ë“±ë¡">2) <code class="language-plaintext highlighter-rouge">mkdocs.yml</code>ì— í™•ì¥ ë“±ë¡</h1>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">theme</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">material</span>

<span class="na">markdown_extensions</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">attr_list</span>
  <span class="pi">-</span> <span class="s1">'</span><span class="s">en_span:EnSpanExtension'</span>   <span class="c1"># ë˜ëŠ” ê·¸ëƒ¥ - en_span  (makeExtensionê°€ ìˆìœ¼ë¯€ë¡œ)</span>
  <span class="c1"># ì˜µì…˜ì„ ë°”ê¾¸ê³  ì‹¶ë‹¤ë©´:</span>
  <span class="c1"># - en_span:</span>
  <span class="c1">#     delim: "%%"   # ë°”ê¾¸ë ¤ë©´ "^^" ë“±</span>
  <span class="c1">#     class: "en"</span>
  <span class="c1">#     lang: "en"</span>

<span class="na">extra_css</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">stylesheets/translation.css</span>
</code></pre></div></div>

<blockquote>
  <p><strong>ì£¼ì˜:</strong> MkDocsê°€ ì´ ëª¨ë“ˆì„ importí•  ìˆ˜ ìˆì–´ì•¼ í•´ìš”.<br />
 ê°€ì¥ ê°„ë‹¨íˆëŠ” <strong>MkDocs ì‹¤í–‰í•  ë•Œ</strong> í”„ë¡œì íŠ¸ ë£¨íŠ¸ë¥¼ íŒŒì´ì¬ ê²½ë¡œì— ì¶”ê°€í•˜ì„¸ìš”.</p>

  <ul>
    <li>
      <p>macOS/Linux: <code class="language-plaintext highlighter-rouge">PYTHONPATH=. mkdocs serve</code></p>
    </li>
    <li>
      <p>Windows(PowerShell): <code class="language-plaintext highlighter-rouge">$env:PYTHONPATH="."; mkdocs serve</code></p>
    </li>
  </ul>

</blockquote>

<p>(í˜¹ì€ <code class="language-plaintext highlighter-rouge">en_span.py</code>ë¥¼ íŒ¨í‚¤ì§€ë¡œ ì„¤ì¹˜í•˜ê±°ë‚˜, venvì˜ <code class="language-plaintext highlighter-rouge">site-packages</code>ì— ë„£ì–´ë„ ë©ë‹ˆë‹¤.)</p>

<hr />

<h1 id="3-css-material-ê¸°ì¤€">3) CSS (Material ê¸°ì¤€)</h1>

<p><code class="language-plaintext highlighter-rouge">docs/stylesheets/translation.css</code>:</p>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">.md-typeset</span> <span class="nc">.en</span> <span class="p">{</span>
  <span class="nl">font-size</span><span class="p">:</span> <span class="m">0.85em</span><span class="p">;</span>   <span class="c">/* ì¡°ê¸ˆ ì‘ê²Œ */</span>
  <span class="nl">opacity</span><span class="p">:</span> <span class="m">0.65</span><span class="p">;</span>       <span class="c">/* ì—°í•˜ê²Œ */</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ì›í•˜ë©´ ì¤„ ê°„ê²© ì¡°ì •, ìƒ‰ìƒ ë“±ë„ ì—¬ê¸°ì„œ ì»¤ìŠ¤í…€í•˜ë©´ ë©ë‹ˆë‹¤.</p>

<hr />

<h1 id="4-ì‚¬ìš©ë²•">4) ì‚¬ìš©ë²•</h1>

<p>ê·¸ëƒ¥ ë³¸ë¬¸ì— ì´ë ‡ê²Œ ì“°ë©´ ë:</p>
<div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ì•ˆë…•í•˜ì„¸ìš”. %%Hello. Everyone.%%
</code></pre></div></div>

<p>ë Œë”ë§ ê²°ê³¼(í•µì‹¬ë§Œ):</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;p&gt;</span>ì•ˆë…•í•˜ì„¸ìš”. <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"en"</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>Hello. Everyone.<span class="nt">&lt;/span&gt;&lt;/p&gt;</span>
</code></pre></div></div>

<ul>
  <li>
    <p><strong>ë¸”ë¡ìœ¼ë¡œ</strong> ì“°ê³  ì‹¶ìœ¼ë©´ ê¸°ì¡´ëŒ€ë¡œ <code class="language-plaintext highlighter-rouge">{:.en}</code>ì„ ì“°ê±°ë‚˜, <code class="language-plaintext highlighter-rouge">&lt;en&gt;â€¦&lt;/en&gt;</code>ë¥¼ ì“°ì„¸ìš”(ì´ë¯¸ í•´ë‘ì‹  CSSë¡œ ìŠ¤íƒ€ì¼ ì ìš© ê°€ëŠ¥).</p>
  </li>
  <li>
    <p><strong>ê°™ì€ ë¬¸ë‹¨ì—ì„œ ì¤„ì„ ë°”ê¾¸ê³  ì‹¶ë‹¤ë©´</strong> ì—¬ì „íˆ <code class="language-plaintext highlighter-rouge">&lt;br&gt;</code>ì„ ì“°ëŠ” ê²Œ ê°€ì¥ í™•ì‹¤í•©ë‹ˆë‹¤:</p>
    <div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ì•ˆë…•í•˜ì„¸ìš”.<span class="nt">&lt;br&gt;</span>%%Hello. Everyone.%%
</code></pre></div>    </div>
  </li>
</ul>

<hr />

<h1 id="5-ëŒ€ì•ˆí”ŒëŸ¬ê·¸ì¸-ì—†ì´-ê°€ëŠ¥í•œ-ê¼¼ìˆ˜">5) ëŒ€ì•ˆ(í”ŒëŸ¬ê·¸ì¸ ì—†ì´ ê°€ëŠ¥í•œ ê¼¼ìˆ˜)</h1>

<p>í”ŒëŸ¬ê·¸ì¸ì„ ì „í˜€ ì“°ê¸° ì‹«ë‹¤ë©´, ì•„ë˜ ê¼¼ìˆ˜ë„ ê°€ëŠ¥ì€ í•©ë‹ˆë‹¤.</p>
<div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="ge">*Hello. Everyone.*</span>{.en}
</code></pre></div></div>

<p>CSSë¡œ ê¸°ìš¸ì„ì„ ì œê±°:</p>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">.md-typeset</span> <span class="nt">em</span><span class="nc">.en</span> <span class="p">{</span> <span class="nl">font-style</span><span class="p">:</span> <span class="nb">normal</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div></div>

<p>ì´ë ‡ê²Œ í•˜ë©´ <code class="language-plaintext highlighter-rouge">&lt;em class="en"&gt;â€¦&lt;/em&gt;</code>ì´ ë˜ëŠ”ë°, ì‹œë§¨í‹±ì´ ì‚´ì§ ì–´ê¸‹ë‚˜ë¯€ë¡œ <strong>ê¶Œì¥ë„ëŠ” ë‚®ê³ </strong> ,<br />
ê°€ëŠ¥í•˜ë©´ ìœ„ì˜ <strong>ì»¤ìŠ¤í…€ í™•ì¥(%%â€¦%%)</strong> ë°©ì‹ì„ ì¶”ì²œí•©ë‹ˆë‹¤.</p>

<hr />

<p>í•„ìš”í•˜ë©´ <strong>êµ¬ë¶„ì</strong> ë¥¼ <code class="language-plaintext highlighter-rouge">^^</code>ë‚˜ <code class="language-plaintext highlighter-rouge">!!</code> ë“±ìœ¼ë¡œ ë°”ê¾¼ ë²„ì „ë„ ë°”ë¡œ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”. (ì˜µì…˜ í•œ ì¤„ë§Œ ë°”ê¾¸ë©´ ë©ë‹ˆë‹¤)</p>

<p class="chat--user">

No module names 'en_span' íŒŒì¼ì„ ì—¬ê¸° ë„£ëŠ”ê±° ë§ì•„?

</p>

<p>ë§ì•„ìš”, ê·¸ ì—ëŸ¬ëŠ” <strong>MkDocsê°€<code class="language-plaintext highlighter-rouge">en_span</code> ëª¨ë“ˆì„ import ëª» í•´ì„œ</strong> ë‚˜ëŠ” ê±°ì˜ˆìš”.<br />
í•µì‹¬ì€ <strong>íŒŒì¼ ìœ„ì¹˜ + ì‹¤í–‰ ìœ„ì¹˜ + íŒŒì´ì¬ ê²½ë¡œ(PYTHONPATH)</strong> ì…ë‹ˆë‹¤. ì•„ë˜ëŒ€ë¡œ ì°¨ê·¼ì°¨ê·¼ í•´ë³´ì„¸ìš”.</p>

<hr />

<h2 id="0-ì˜¬ë°”ë¥¸-í´ë”-êµ¬ì¡°-ê°€ì¥-ë‹¨ìˆœí•œ-í˜•íƒœ">0) ì˜¬ë°”ë¥¸ í´ë” êµ¬ì¡° (ê°€ì¥ ë‹¨ìˆœí•œ í˜•íƒœ)</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pgsql

your-project/
â”œâ”€ mkdocs.yml
â”œâ”€ en_span.py          â† ì—¬ê¸°!
â””â”€ docs/
   â”œâ”€ index.md
   â””â”€ stylesheets/
      â””â”€ translation.css
</code></pre></div></div>

<blockquote>
  <p><strong>ì¤‘ìš”:</strong> <code class="language-plaintext highlighter-rouge">en_span.py</code>ëŠ” <code class="language-plaintext highlighter-rouge">docs/</code> ì•ˆì´ ì•„ë‹ˆë¼ <strong><code class="language-plaintext highlighter-rouge">mkdocs.yml</code>ê³¼ ê°™ì€ ë””ë ‰í„°ë¦¬(í”„ë¡œì íŠ¸ ë£¨íŠ¸)</strong> ì— ë‘ì„¸ìš”.</p>
</blockquote>

<hr />

<h2 id="1-mkdocsyml-ì„¤ì •-1">1) <code class="language-plaintext highlighter-rouge">mkdocs.yml</code> ì„¤ì •</h2>

<p>ê°€ì¥ ê¸°ë³¸:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">markdown_extensions</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">en_span</span>
</code></pre></div></div>

<p>ì˜µì…˜ì„ ì“°ê³  ì‹¶ë‹¤ë©´:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">markdown_extensions</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">en_span</span><span class="pi">:</span>
      <span class="na">delim</span><span class="pi">:</span> <span class="s2">"</span><span class="s">%%"</span>
      <span class="na">class</span><span class="pi">:</span> <span class="s2">"</span><span class="s">en"</span>
      <span class="na">lang</span><span class="pi">:</span> <span class="s2">"</span><span class="s">en"</span>
</code></pre></div></div>

<p>ë˜ëŠ” í´ë˜ìŠ¤ ê²½ë¡œë¡œë„ ê°€ëŠ¥:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">markdown_extensions</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s1">'</span><span class="s">en_span:EnSpanExtension'</span>
</code></pre></div></div>

<hr />

<h2 id="2-ì˜¬ë°”ë¥¸-ì‹¤í–‰-ìœ„ì¹˜ì—ì„œ-ì„œë²„-ì‹œì‘">2) ì˜¬ë°”ë¥¸ ì‹¤í–‰ ìœ„ì¹˜ì—ì„œ ì„œë²„ ì‹œì‘</h2>

<p>ë°˜ë“œì‹œ <strong>í”„ë¡œì íŠ¸ ë£¨íŠ¸(=<code class="language-plaintext highlighter-rouge">mkdocs.yml</code>ì´ ìˆëŠ” ìœ„ì¹˜)</strong> ë¡œ ì´ë™í•´ì„œ ì‹¤í–‰í•˜ì„¸ìš”.</p>

<ul>
  <li>macOS / Linux
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>your-project
<span class="nv">PYTHONPATH</span><span class="o">=</span><span class="nb">.</span> mkdocs serve
</code></pre></div>    </div>
  </li>
  <li>Windows PowerShell
    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cd</span><span class="w"> </span><span class="nx">your-project</span><span class="w">
</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">PYTHONPATH</span><span class="o">=</span><span class="s2">"."</span><span class="p">;</span><span class="w"> </span><span class="n">mkdocs</span><span class="w"> </span><span class="nx">serve</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>Windows CMD
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bat
    
cd your-project
set PYTHONPATH=.
mkdocs serve
</code></pre></div>    </div>
  </li>
</ul>

<blockquote>
  <p>ì™œ? MkDocsê°€ í™•ì¥ ëª¨ë“ˆì„ <strong>í˜„ì¬ íŒŒì´ì¬ ê²½ë¡œ</strong> ì—ì„œ ì°¾ëŠ”ë°, í™˜ê²½/ì‹¤í–‰ ë°©ë²•ì— ë”°ë¼ í˜„ì¬ ë””ë ‰í„°ë¦¬ê°€ ê²½ë¡œì— ì•ˆ ì¡í ìˆ˜ ìˆìŠµë‹ˆë‹¤. <code class="language-plaintext highlighter-rouge">PYTHONPATH=.</code> ë¡œ í”„ë¡œì íŠ¸ ë£¨íŠ¸ë¥¼ í™•ì‹¤íˆ ë„£ì–´ì£¼ë©´ import ì—ëŸ¬ê°€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.</p>
</blockquote>

<hr />

<h2 id="3-ë¹ ë¥¸-ìê°€-ì ê²€-ë¬¸ì œ-ê³„ì†ë˜ë©´-ì—¬ê¸°ì„œ-ì¡í™ë‹ˆë‹¤">3) ë¹ ë¥¸ ìê°€ ì ê²€ (ë¬¸ì œ ê³„ì†ë˜ë©´ ì—¬ê¸°ì„œ ì¡í™ë‹ˆë‹¤)</h2>

<ol>
  <li>
    <p><strong>íŒŒì¼ëª…</strong> ì´ ì •í™•íˆ <code class="language-plaintext highlighter-rouge">en_span.py</code> ì¸ê°€ìš”? (<code class="language-plaintext highlighter-rouge">en-span.py</code> Ã—)</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">en_span.py</code> ì•ˆì— <strong><code class="language-plaintext highlighter-rouge">makeExtension(**kwargs)</code></strong> í•¨ìˆ˜ê°€ ì¡´ì¬í•˜ë‚˜ìš”? (í•„ìˆ˜)</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">mkdocs serve</code>ë¥¼ <strong>í”„ë¡œì íŠ¸ ë£¨íŠ¸</strong> ì—ì„œ ì‹¤í–‰í–ˆë‚˜ìš”? (ë‹¤ë¥¸ í´ë”ì—ì„œ ì‹¤í–‰ Ã—)</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">mkdocs.yml</code>ì— <code class="language-plaintext highlighter-rouge">markdown_extensions: - en_span</code> ì´ ë“¤ì–´ê°”ë‚˜ìš”? (ì˜¤íƒˆì Ã—)</p>
  </li>
  <li>ê·¸ë˜ë„ ì•ˆ ë˜ë©´, <strong>ì™„ì „í•œ ëª¨ë“ˆ ê²½ë¡œ</strong> ë¡œ ì‹œë„:
```yaml
markdown_extensions:
    <ul>
      <li>'en_span:EnSpanExtension'
```</li>
    </ul>
  </li>
  <li>ì—¬ì „íˆ ì•ˆ ë˜ë©´, <strong>íŒ¨í‚¤ì§€ í´ë”ë¡œ ê°ì‹¸ê¸°</strong> :
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>your-project/
â”œâ”€ mkdocs.yml
â”œâ”€ local_ext/
â”‚  â”œâ”€ __init__.py
â”‚  â””â”€ en_span.py
â””â”€ docs/...
</code></pre></div>    </div>
  </li>
</ol>

<p>ê·¸ë¦¬ê³  <code class="language-plaintext highlighter-rouge">mkdocs.yml</code>:
     <code class="language-plaintext highlighter-rouge">yaml
     markdown_extensions:
       - local_ext.en_span
    </code></p>

<p>(ì´ë•Œë„ <code class="language-plaintext highlighter-rouge">PYTHONPATH=.</code> ê¶Œì¥)</p>

<hr />

<h2 id="4-ë™ì‘-í™•ì¸ìš©-ìµœì†Œ-ì˜ˆì œ">4) ë™ì‘ í™•ì¸ìš© ìµœì†Œ ì˜ˆì œ</h2>

<p><strong><code class="language-plaintext highlighter-rouge">docs/index.md</code></strong></p>
<div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ì•ˆë…•í•˜ì„¸ìš”. %%Hello. Everyone.%%
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">en_span.py</code></strong> (í•µì‹¬ ë¶€ë¶„ë§Œ ì¬í™•ì¸)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">re</span>
<span class="kn">from</span> <span class="n">markdown.extensions</span> <span class="kn">import</span> <span class="n">Extension</span>
<span class="kn">from</span> <span class="n">markdown.inlinepatterns</span> <span class="kn">import</span> <span class="n">InlineProcessor</span>
<span class="kn">from</span> <span class="n">xml.etree</span> <span class="kn">import</span> <span class="n">ElementTree</span> <span class="k">as</span> <span class="n">etree</span>

<span class="k">class</span> <span class="nc">EnSpanInline</span><span class="p">(</span><span class="n">InlineProcessor</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">klass</span><span class="o">=</span><span class="sh">"</span><span class="s">en</span><span class="sh">"</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="sh">"</span><span class="s">en</span><span class="sh">"</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">md</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">klass</span> <span class="o">=</span> <span class="n">klass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">lang</span> <span class="o">=</span> <span class="n">lang</span>
    <span class="k">def</span> <span class="nf">handleMatch</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">replace</span><span class="p">(</span><span class="sa">r</span><span class="sh">'</span><span class="s">\%%</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">%%</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">el</span> <span class="o">=</span> <span class="n">etree</span><span class="p">.</span><span class="nc">Element</span><span class="p">(</span><span class="sh">"</span><span class="s">span</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">el</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">class</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">klass</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">lang</span><span class="p">:</span>
            <span class="n">el</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">lang</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">lang</span><span class="p">)</span>
        <span class="n">el</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>
        <span class="k">return</span> <span class="n">el</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">m</span><span class="p">.</span><span class="nf">end</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">EnSpanExtension</span><span class="p">(</span><span class="n">Extension</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">delim</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">%%</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Inline delimiter</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">class</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">en</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">CSS class</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">lang</span><span class="sh">"</span><span class="p">:</span>  <span class="p">[</span><span class="sh">"</span><span class="s">en</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">lang attribute</span><span class="sh">"</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">extendMarkdown</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">md</span><span class="p">):</span>
        <span class="n">delim</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">getConfig</span><span class="p">(</span><span class="sh">"</span><span class="s">delim</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">rf</span><span class="sh">"</span><span class="s">(?&lt;!\\)</span><span class="si">{</span><span class="n">re</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="n">delim</span><span class="p">)</span><span class="si">}</span><span class="s">(.+?)(?&lt;!\\)</span><span class="si">{</span><span class="n">re</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="n">delim</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">md</span><span class="p">.</span><span class="n">inlinePatterns</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span>
            <span class="nc">EnSpanInline</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span>
                         <span class="n">klass</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">getConfig</span><span class="p">(</span><span class="sh">"</span><span class="s">class</span><span class="sh">"</span><span class="p">),</span>
                         <span class="n">lang</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="nf">getConfig</span><span class="p">(</span><span class="sh">"</span><span class="s">lang</span><span class="sh">"</span><span class="p">)),</span>
            <span class="sh">"</span><span class="s">en-span</span><span class="sh">"</span><span class="p">,</span> <span class="mi">175</span>
        <span class="p">)</span>

<span class="k">def</span> <span class="nf">makeExtension</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="nc">EnSpanExtension</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="5-ê·¸ë˜ë„-ê°™ì€-ì—ëŸ¬ë©´">5) ê·¸ë˜ë„ ê°™ì€ ì—ëŸ¬ë©´?</h2>

<ul>
  <li>
    <p>ì½˜ì†”ì—ì„œ í•œ ë²ˆ ì§ì ‘ import í•´ë³´ì„¸ìš”:</p>

    <ul>
      <li>macOS/Linux:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>your-project
<span class="nv">PYTHONPATH</span><span class="o">=</span><span class="nb">.</span> python <span class="nt">-c</span> <span class="s2">"import en_span; print(en_span)"</span>
</code></pre></div>        </div>
      </li>
      <li>Windows PowerShell:
        <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cd</span><span class="w"> </span><span class="nx">your-project</span><span class="w">
</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">PYTHONPATH</span><span class="o">=</span><span class="s2">"."</span><span class="p">;</span><span class="w"> </span><span class="n">python</span><span class="w"> </span><span class="nt">-c</span><span class="w"> </span><span class="s2">"import en_span; print(en_span)"</span><span class="w">
</span></code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ul>

<p>ì´ê²Œ ì‹¤íŒ¨í•˜ë©´ <strong>ê²½ë¡œ ë¬¸ì œ</strong> ê°€ í™•ì‹¤í•©ë‹ˆë‹¤. ìœ„ 2)ë²ˆ(ì‹¤í–‰ ìœ„ì¹˜)ê³¼ 3)ë²ˆ(íŒ¨í‚¤ì§€ í´ë”) ë°©ë²•ìœ¼ë¡œ ì •ë¦¬í•˜ë©´ í•´ê²°ë©ë‹ˆë‹¤.</p>

<hr />

<p>ì›í•˜ì‹œë©´ ì§€ê¸ˆ í”„ë¡œì íŠ¸ íŠ¸ë¦¬(ëŒ€ì¶© <code class="language-plaintext highlighter-rouge">tree</code> ê²°ê³¼ë‚˜ ìŠ¤í¬ë¦°ìƒ·)ì™€ <code class="language-plaintext highlighter-rouge">mkdocs.yml</code>ì˜ í•´ë‹¹ ë¶€ë¶„ì„ ë³´ë‚´ ì£¼ì„¸ìš”. ê·¸ëŒ€ë¡œ ë§ì¶°ì„œ <strong>í•œ ì¤„ë„ í—·ê°ˆë¦¬ì§€ ì•Šê²Œ</strong> ìˆ˜ì •ë³¸ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

ê·¸ëƒ¥ íŒ¨í‚¤ì§€ ì„¤ì¹˜ë¥¼ í•´ë²„ë ¤ì•¼ê² ì–´. markdown_en_span ì´ë¼ëŠ” íŒ¨í‚¤ì§€ë¡œ ë§Œë“¤ì–´ì£¼ê³  src í´ë”ì™€ pyproject.tomlì„ ì—¬ê¸°ì— í¬í•¨ì‹œì¼œì„œ ì„¤ì¹˜í•  ìˆ˜ ìˆê²Œ í•´ì¤˜

</p>

<p>ì¢‹ì•„â€”<strong>ë¡œì»¬ì—ì„œ ë°”ë¡œ ì„¤ì¹˜ ê°€ëŠ¥í•œ íŒ¨í‚¤ì§€</strong> ë¡œ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”.<br />
íŒ¨í‚¤ì§€ëª…ì€ ìš”ì²­í•˜ì‹  ëŒ€ë¡œ <code class="language-plaintext highlighter-rouge">markdown_en_span</code>, <strong>src ë ˆì´ì•„ì›ƒ</strong> + <code class="language-plaintext highlighter-rouge">pyproject.toml</code> í¬í•¨ì…ë‹ˆë‹¤.</p>

<hr />

<h1 id="1-ë””ë ‰í„°ë¦¬-êµ¬ì¡°-ë§Œë“¤ê¸°">1) ë””ë ‰í„°ë¦¬ êµ¬ì¡° ë§Œë“¤ê¸°</h1>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">your-project</span><span class="o">/</span>
<span class="err">â”œâ”€</span> <span class="nt">pyproject</span><span class="nc">.toml</span>
<span class="err">â””â”€</span> <span class="nt">src</span><span class="o">/</span>
   <span class="err">â””â”€</span> <span class="nt">markdown_en_span</span><span class="o">/</span>
      <span class="err">â””â”€</span> <span class="nt">__init__</span><span class="nc">.py</span>
</code></pre></div></div>

<hr />

<h1 id="2-pyprojecttoml">2) <code class="language-plaintext highlighter-rouge">pyproject.toml</code></h1>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[build-system]</span>
<span class="py">requires</span> <span class="p">=</span> <span class="py">["hatchling&gt;</span><span class="p">=</span><span class="mf">1.18</span><span class="s">"]</span><span class="err">
</span><span class="py">build-backend</span> <span class="p">=</span> <span class="s">"hatchling.build"</span>

<span class="nn">[project]</span>
<span class="py">name</span> <span class="p">=</span> <span class="s">"markdown_en_span"</span>
<span class="py">version</span> <span class="p">=</span> <span class="s">"0.1.0"</span>
<span class="py">description</span> <span class="p">=</span> <span class="s">"Python-Markdown inline extension to wrap %%text%% as &lt;span class='en' lang='en'&gt;text&lt;/span&gt;."</span>
<span class="py">readme</span> <span class="p">=</span> <span class="s">"README.md"</span>
<span class="py">requires-python</span> <span class="p">=</span> <span class="py">"&gt;</span><span class="p">=</span><span class="mf">3.8</span><span class="s">"</span><span class="err">
</span><span class="py">authors</span> <span class="p">=</span> <span class="py">[{name</span> <span class="p">=</span> <span class="s">"Your Name"</span><span class="err">}]</span>
<span class="py">dependencies</span> <span class="p">=</span> <span class="py">["Markdown&gt;</span><span class="p">=</span><span class="mf">3.3</span><span class="s">"]</span><span class="err">
</span>
<span class="nn">[project.urls]</span>
<span class="py">Homepage</span> <span class="p">=</span> <span class="s">"https://example.com/markdown_en_span"</span>

<span class="c"># Python-Markdownì´ ì´ í™•ì¥ì„ 'en_span' ì´ë¦„ìœ¼ë¡œ ì¸ì‹í•˜ê²Œ í•˜ëŠ” ì—”íŠ¸ë¦¬í¬ì¸íŠ¸</span>
<span class="nn">[project.entry-points."markdown.extensions"]</span>
<span class="py">en_span</span> <span class="p">=</span> <span class="s">"markdown_en_span:makeExtension"</span>
</code></pre></div></div>

<blockquote>
  <p>í¬ì¸íŠ¸</p>

  <ul>
    <li>
      <p><strong>ì—”íŠ¸ë¦¬í¬ì¸íŠ¸</strong> ë•ë¶„ì— <code class="language-plaintext highlighter-rouge">mkdocs.yml</code>ì—ì„œ <code class="language-plaintext highlighter-rouge">markdown_extensions: - en_span</code>ì²˜ëŸ¼ <strong>ì§§ì€ ì´ë¦„</strong> ìœ¼ë¡œ ì“¸ ìˆ˜ ìˆì–´ìš”.</p>
    </li>
    <li>
      <p>ë°°í¬ëª…(<code class="language-plaintext highlighter-rouge">name</code>)ê³¼ ëª¨ë“ˆëª…(í´ë”)ì€ ë‘˜ ë‹¤ <code class="language-plaintext highlighter-rouge">markdown_en_span</code>ë¡œ í†µì¼.</p>
    </li>
  </ul>

</blockquote>

<hr />

<h1 id="3-srcmarkdown_en_span__init__py">3) <code class="language-plaintext highlighter-rouge">src/markdown_en_span/__init__.py</code></h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">re</span>
<span class="kn">from</span> <span class="n">markdown.extensions</span> <span class="kn">import</span> <span class="n">Extension</span>
<span class="kn">from</span> <span class="n">markdown.inlinepatterns</span> <span class="kn">import</span> <span class="n">InlineProcessor</span>
<span class="kn">from</span> <span class="n">xml.etree</span> <span class="kn">import</span> <span class="n">ElementTree</span> <span class="k">as</span> <span class="n">etree</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">EnSpanExtension</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">makeExtension</span><span class="sh">"</span><span class="p">]</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="sh">"</span><span class="s">0.1.0</span><span class="sh">"</span>

<span class="k">class</span> <span class="nc">EnSpanInline</span><span class="p">(</span><span class="n">InlineProcessor</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Wraps %%text%% (ê¸°ë³¸) â†’ &lt;span class=</span><span class="sh">"</span><span class="s">en</span><span class="sh">"</span><span class="s"> lang=</span><span class="sh">"</span><span class="s">en</span><span class="sh">"</span><span class="s">&gt;text&lt;/span&gt;
    - êµ¬ë¶„ìëŠ” ì˜µì…˜ìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥ (ì˜ˆ: ^^ ë˜ëŠ” !!)
    - \%% ì²˜ëŸ¼ ë°±ìŠ¬ë˜ì‹œë¡œ ì´ìŠ¤ì¼€ì´í”„í•˜ë©´ ë¦¬í„°ëŸ´ %% ì¶œë ¥
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">delim</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">css_class</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">en</span><span class="sh">"</span><span class="p">,</span> <span class="n">lang</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">en</span><span class="sh">"</span><span class="p">):</span>
        <span class="c1"># DOTALL í™œì„±í™”: í•„ìš” ì‹œ ì—¬ëŸ¬ ì¤„ë„ ë§¤ì¹­
</span>        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">rf</span><span class="sh">"</span><span class="s">(?s)(?&lt;!\\)</span><span class="si">{</span><span class="n">re</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="n">delim</span><span class="p">)</span><span class="si">}</span><span class="s">(.+?)(?&lt;!\\)</span><span class="si">{</span><span class="n">re</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="n">delim</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">md</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">delim</span> <span class="o">=</span> <span class="n">delim</span>
        <span class="n">self</span><span class="p">.</span><span class="n">css_class</span> <span class="o">=</span> <span class="n">css_class</span>
        <span class="n">self</span><span class="p">.</span><span class="n">lang</span> <span class="o">=</span> <span class="n">lang</span>

    <span class="k">def</span> <span class="nf">handleMatch</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># ë³¸ë¬¸ í…ìŠ¤íŠ¸
</span>        <span class="n">text</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># \%% â†’ %% (ì‚¬ìš©ìê°€ ë¦¬í„°ëŸ´ êµ¬ë¶„ìë¥¼ ë„£ê³  ì‹¶ì„ ë•Œ)
</span>        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="se">\\</span><span class="sh">"</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">delim</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">delim</span><span class="p">)</span>

        <span class="n">el</span> <span class="o">=</span> <span class="n">etree</span><span class="p">.</span><span class="nc">Element</span><span class="p">(</span><span class="sh">"</span><span class="s">span</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">el</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">class</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">css_class</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">lang</span><span class="p">:</span>
            <span class="n">el</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="sh">"</span><span class="s">lang</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">lang</span><span class="p">)</span>
        <span class="n">el</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>
        <span class="k">return</span> <span class="n">el</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">m</span><span class="p">.</span><span class="nf">end</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">EnSpanExtension</span><span class="p">(</span><span class="n">Extension</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    í™•ì¥ ì˜µì…˜:
      - delim: ê¸°ë³¸ </span><span class="sh">"</span><span class="s">%%</span><span class="sh">"</span><span class="s">
      - class: ê¸°ë³¸ </span><span class="sh">"</span><span class="s">en</span><span class="sh">"</span><span class="s">
      - lang:  ê¸°ë³¸ </span><span class="sh">"</span><span class="s">en</span><span class="sh">"</span><span class="s"> (ë¹ˆ ë¬¸ìì—´ì´ë©´ lang ì†ì„± ìƒëµ)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">delim</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">%%</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Inline delimiter, e.g. %%, ^^, !!</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">class</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">en</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">CSS class name to set on &lt;span&gt;</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">lang</span><span class="sh">"</span><span class="p">:</span>  <span class="p">[</span><span class="sh">"</span><span class="s">en</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">lang attribute value (</span><span class="sh">''</span><span class="s"> to disable)</span><span class="sh">"</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">extendMarkdown</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">md</span><span class="p">):</span>
        <span class="n">delim</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">getConfig</span><span class="p">(</span><span class="sh">"</span><span class="s">delim</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">css_class</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">getConfig</span><span class="p">(</span><span class="sh">"</span><span class="s">class</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">lang</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">getConfig</span><span class="p">(</span><span class="sh">"</span><span class="s">lang</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="nc">EnSpanInline</span><span class="p">(</span><span class="n">delim</span><span class="o">=</span><span class="n">delim</span><span class="p">,</span> <span class="n">md</span><span class="o">=</span><span class="n">md</span><span class="p">,</span> <span class="n">css_class</span><span class="o">=</span><span class="n">css_class</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="n">lang</span><span class="p">)</span>
        <span class="c1"># emphasis(EMPHASIS=170)ë³´ë‹¤ ì•½ê°„ ì•ì„œë„ë¡ ë“±ë¡
</span>        <span class="n">md</span><span class="p">.</span><span class="n">inlinePatterns</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="sh">"</span><span class="s">en-span</span><span class="sh">"</span><span class="p">,</span> <span class="mi">175</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">makeExtension</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="nc">EnSpanExtension</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h1 id="4-ì„¤ì¹˜-ë¡œì»¬">4) ì„¤ì¹˜ (ë¡œì»¬)</h1>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í”„ë¡œì íŠ¸ ë£¨íŠ¸(= pyproject.toml ìˆëŠ” ê³³)ì—ì„œ</span>
pip <span class="nb">install</span> <span class="nt">-e</span> <span class="nb">.</span>
<span class="c"># ë˜ëŠ”</span>
pip <span class="nb">install</span> <span class="nb">.</span>
</code></pre></div></div>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">-e</code>ëŠ” ê°œë°œ ì¤‘ ìˆ˜ì •ì‚¬í•­ì´ ë°”ë¡œ ë°˜ì˜ë˜ëŠ” <strong>editable</strong> ì„¤ì¹˜.</p>
</blockquote>

<hr />

<h1 id="5-mkdocs-ì‚¬ìš©-ì˜ˆì‹œ">5) MkDocs ì‚¬ìš© ì˜ˆì‹œ</h1>

<h2 id="mkdocsyml"><code class="language-plaintext highlighter-rouge">mkdocs.yml</code></h2>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">theme</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">material</span>

<span class="na">markdown_extensions</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">en_span</span>            <span class="c1"># â† ë°©ê¸ˆ ë§Œë“  í™•ì¥ (ì—”íŠ¸ë¦¬í¬ì¸íŠ¸ë¡œ ì¸ì‹)</span>
  <span class="c1"># - attr_list        # (ì„ íƒ) ë‹¤ë¥¸ ìš©ë„ í•„ìš” ì‹œ</span>
  <span class="c1"># - en_span:</span>
  <span class="c1">#     delim: "^^"    # êµ¬ë¶„ì ë°”ê¾¸ê³  ì‹¶ì„ ë•Œ</span>
  <span class="c1">#     class: "en"</span>
  <span class="c1">#     lang: "en"</span>

<span class="na">extra_css</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">stylesheets/translation.css</span>
</code></pre></div></div>

<h2 id="docsstylesheetstranslationcss"><code class="language-plaintext highlighter-rouge">docs/stylesheets/translation.css</code></h2>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">.md-typeset</span> <span class="nc">.en</span> <span class="p">{</span>
  <span class="nl">font-size</span><span class="p">:</span> <span class="m">0.85em</span><span class="p">;</span>
  <span class="nl">opacity</span><span class="p">:</span> <span class="m">0.65</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="docsindexmd"><code class="language-plaintext highlighter-rouge">docs/index.md</code></h2>
<div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ì•ˆë…•í•˜ì„¸ìš”. %%Hello. Everyone.%%
</code></pre></div></div>

<p>â†’ ë Œë”ë§:</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;p&gt;</span>ì•ˆë…•í•˜ì„¸ìš”. <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"en"</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>Hello. Everyone.<span class="nt">&lt;/span&gt;&lt;/p&gt;</span>
</code></pre></div></div>

<hr />

<h1 id="6-íŒ--íŠ¸ëŸ¬ë¸”ìŠˆíŒ…">6) íŒ &amp; íŠ¸ëŸ¬ë¸”ìŠˆíŒ…</h1>

<ul>
  <li><strong>êµ¬ë¶„ì ë°”ê¾¸ê¸°</strong> : <code class="language-plaintext highlighter-rouge">mkdocs.yml</code>ì—
```yaml
markdown_extensions:
    <ul>
      <li>en_span:
  delim: "^^"
  class: "en"
  lang: "en"
```</li>
    </ul>
  </li>
</ul>

<p>â†’ <code class="language-plaintext highlighter-rouge">ì•ˆë…•í•˜ì„¸ìš”. ^^Hello. Everyone.^^</code></p>

<ul>
  <li>
    <p><strong>ë¦¬í„°ëŸ´ë¡œ<code class="language-plaintext highlighter-rouge">%%</code> ì¶œë ¥</strong>: <code class="language-plaintext highlighter-rouge">\%%</code> ì²˜ëŸ¼ ì´ìŠ¤ì¼€ì´í”„<br />
ì˜ˆ) <code class="language-plaintext highlighter-rouge">ê°€ê²©ì€ \%%20 í• ì¸</code> â†’ ì‹¤ì œ ë¬¸ì„œì— <code class="language-plaintext highlighter-rouge">%%20</code> ì¶œë ¥</p>
  </li>
  <li><strong>í™•ì¥ ë¡œë”© í™•ì¸</strong> (MkDocs ì™¸ì— ìˆœìˆ˜ íŒŒì´ì¬ì—ì„œ)
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">markdown</span>
<span class="n">html</span> <span class="o">=</span> <span class="n">markdown</span><span class="p">.</span><span class="nf">markdown</span><span class="p">(</span><span class="sh">"</span><span class="s">ì•ˆë…• %%Hello%%</span><span class="sh">"</span><span class="p">,</span> <span class="n">extensions</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">en_span</span><span class="sh">"</span><span class="p">])</span>
<span class="nf">print</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>ì—¬ì „íˆ ì¸ì‹ ì•ˆ ë˜ë©´</strong></p>

    <ul>
      <li>
        <p>ì„¤ì¹˜ ê²½ë¡œ í™•ì¸: <code class="language-plaintext highlighter-rouge">pip show markdown_en_span</code></p>
      </li>
      <li>
        <p>ê°€ìƒí™˜ê²½ ì¬ì‹œì‘ / MkDocs ì¬ì‹œì‘</p>
      </li>
      <li>
        <p>Markdown ë²„ì „ í™•ì¸: <code class="language-plaintext highlighter-rouge">python -c "import markdown, sys; print(markdown.__version__)"</code> (3.3 ì´ìƒ ê¶Œì¥)</p>
      </li>
    </ul>
  </li>
</ul>

<hr />

<p>í•„ìš”í•˜ë©´ <code class="language-plaintext highlighter-rouge">README.md</code>/<code class="language-plaintext highlighter-rouge">LICENSE</code> ê³¨ê²©ë„ ì¶”ê°€í•´ ë“œë¦´ê²Œìš”. ì›í•˜ì‹œëŠ” êµ¬ë¶„ì(ì˜ˆ: <code class="language-plaintext highlighter-rouge">||</code>), ê¸°ë³¸ í´ë˜ìŠ¤ëª… ë³€ê²½ ë“± ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆ ë²„ì „ë„ ë°”ë¡œ ë§Œë“¤ì–´ ì¤„ ìˆ˜ ìˆì–´ìš”.</p>

<p class="chat--user">

mkdocs ë£¨íŠ¸ í´ë” ë°‘ì— ë„ˆê°€ ë§Œë“¤ì–´ì¤€ íŒ¨í‚¤ì§€ë¥¼ ìœ„ì¹˜ ì‹œí‚¬ê±°ì•¼. requirements.txtì— ìƒëŒ€ê²½ë¡œë¡œ ì¸ìŠ¤í†¨ ì¶”ê°€í•  ìˆ˜ ìˆì–´?

</p>

<p>ê°€ëŠ¥í•´! <strong>requirements.txt</strong> ì—ì„œ <strong>ìƒëŒ€ê²½ë¡œ</strong> ë¡œ ë¡œì»¬ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•  ìˆ˜ ìˆì–´ìš”.<br />
ìš”ì²­í•˜ì‹  êµ¬ì¡°(íŒ¨í‚¤ì§€ë¥¼ MkDocs ë£¨íŠ¸ ë°”ë¡œ ì•„ë˜)ì— ë§ì¶° <strong>í•œ ë²ˆì— ë˜ëŠ”</strong> ì ˆì°¨ë¥¼ step-by-stepìœ¼ë¡œ ì •ë¦¬í• ê²Œìš”.</p>

<hr />

<h1 id="0-í´ë”-êµ¬ì¡°ì˜ˆì‹œ">0) í´ë” êµ¬ì¡°(ì˜ˆì‹œ)</h1>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>your-project/
â”œâ”€ mkdocs.yml
â”œâ”€ requirements.txt
â”œâ”€ markdown_en_span/           <span class="c"># â† ì—¬ê¸° í´ë”ê°€ â€œíŒ¨í‚¤ì§€ ë£¨íŠ¸â€</span>
â”‚  â”œâ”€ pyproject.toml
â”‚  â””â”€ src/
â”‚     â””â”€ markdown_en_span/
â”‚        â””â”€ __init__.py
â””â”€ docs/
   â””â”€ stylesheets/translation.css
</code></pre></div></div>

<blockquote>
  <p>ì¤‘ìš”: <strong><code class="language-plaintext highlighter-rouge">pyproject.toml</code>ì´ ë“¤ì–´ìˆëŠ” ë””ë ‰í„°ë¦¬</strong>(ì—¬ê¸°ì„œëŠ” <code class="language-plaintext highlighter-rouge">./markdown_en_span</code>)ê°€ pipê°€ ì¸ì‹í•˜ëŠ” â€œíŒ¨í‚¤ì§€ ë£¨íŠ¸â€ì˜ˆìš”.</p>
</blockquote>

<hr />

<h1 id="1-requirementstxt-ì‘ì„±">1) requirements.txt ì‘ì„±</h1>

<h2 id="a-ê°œë°œ-ì¤‘-ìˆ˜ì •ì‚¬í•­ì„-ë°”ë¡œ-ë°˜ì˜í•˜ê³ -ì‹¶ì„-ë•Œ-editable">(A) ê°œë°œ ì¤‘ ìˆ˜ì •ì‚¬í•­ì„ ë°”ë¡œ ë°˜ì˜í•˜ê³  ì‹¶ì„ ë•Œ (editable)</h2>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># MkDocs(ì›í•˜ë©´ ë²„ì „ ê³ ì •)</span>
mkdocs&gt;<span class="o">=</span>1.6
mkdocs-material&gt;<span class="o">=</span>9.5

<span class="c"># ë¡œì»¬ í™•ì¥ íŒ¨í‚¤ì§€(ìƒëŒ€ê²½ë¡œ, editable ëª¨ë“œ)</span>
<span class="nt">-e</span> ./markdown_en_span
</code></pre></div></div>

<h2 id="b-ê³ ì •-ì„¤ì¹˜ìˆ˜ì •-ì¦‰ì‹œ-ë°˜ì˜-í•„ìš”-ì—†ì„-ë•Œ">(B) ê³ ì • ì„¤ì¹˜(ìˆ˜ì • ì¦‰ì‹œ ë°˜ì˜ í•„ìš” ì—†ì„ ë•Œ)</h2>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdocs&gt;<span class="o">=</span>1.6
mkdocs-material&gt;<span class="o">=</span>9.5

./markdown_en_span
</code></pre></div></div>

<blockquote>
  <p>ë‘ ê²½ìš° ëª¨ë‘ <strong>ìƒëŒ€ê²½ë¡œëŠ” requirements.txt íŒŒì¼ì´ ìˆëŠ” ìœ„ì¹˜ ê¸°ì¤€</strong> ìœ¼ë¡œ í•´ì„ë©ë‹ˆë‹¤.</p>
</blockquote>

<hr />

<h1 id="2-ì„¤ì¹˜">2) ì„¤ì¹˜</h1>

<p>í”„ë¡œì íŠ¸ ë£¨íŠ¸ì—ì„œ:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python <span class="nt">-m</span> pip <span class="nb">install</span> <span class="nt">-U</span> pip          <span class="c"># ê¶Œì¥: ìµœì‹  pip (PEP 660 editable ì§€ì›)</span>
pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt
</code></pre></div></div>

<blockquote>
  <p><strong>editable(-e)</strong> ì„¤ì¹˜ê°€ ì œëŒ€ë¡œ ë˜ë ¤ë©´ pipê°€ <strong>PEP 660</strong> ì„ ì§€ì›í•´ì•¼ í•©ë‹ˆë‹¤(ëŒ€ë¶€ë¶„ ìµœì‹  pip OK).</p>
</blockquote>

<hr />

<h1 id="3-mkdocsyml-ì„¤ì •">3) mkdocs.yml ì„¤ì •</h1>

<p>ì—”íŠ¸ë¦¬í¬ì¸íŠ¸ë¥¼ ë“±ë¡í•´ë‘” ìƒíƒœë¼ë©´(ì œê°€ ì¤€ <code class="language-plaintext highlighter-rouge">pyproject.toml</code> ê¸°ì¤€) ì•„ë˜ì²˜ëŸ¼ ê°„ë‹¨íˆ ì‚¬ìš© ê°€ëŠ¥:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">theme</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">material</span>

<span class="na">markdown_extensions</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">en_span</span>               <span class="c1"># â† ë°©ê¸ˆ ì„¤ì¹˜í•œ í™•ì¥</span>
  <span class="c1"># - en_span:</span>
  <span class="c1">#     delim: "^^"       # êµ¬ë¶„ì ë°”ê¾¸ê³  ì‹¶ìœ¼ë©´ ì˜µì…˜ìœ¼ë¡œ</span>
  <span class="c1">#     class: "en"</span>
  <span class="c1">#     lang: "en"</span>

<span class="na">extra_css</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">stylesheets/translation.css</span>
</code></pre></div></div>

<hr />

<h1 id="4-ì‚¬ìš©-ì˜ˆì‹œ">4) ì‚¬ìš© ì˜ˆì‹œ</h1>

<p><code class="language-plaintext highlighter-rouge">docs/index.md</code></p>
<div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ì•ˆë…•í•˜ì„¸ìš”. %%Hello. Everyone.%%
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">docs/stylesheets/translation.css</code></p>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">.md-typeset</span> <span class="nc">.en</span> <span class="p">{</span>
  <span class="nl">font-size</span><span class="p">:</span> <span class="m">0.85em</span><span class="p">;</span>
  <span class="nl">opacity</span><span class="p">:</span> <span class="m">0.65</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h1 id="5-ìì£¼-ìƒê¸°ëŠ”-ì´ìŠˆ--ì²´í¬ë¦¬ìŠ¤íŠ¸">5) ìì£¼ ìƒê¸°ëŠ” ì´ìŠˆ &amp; ì²´í¬ë¦¬ìŠ¤íŠ¸</h1>

<ul>
  <li>
    <p><strong>ì„¤ì¹˜ê°€ ì•ˆ ëœë‹¤ë©´</strong></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">pip --version</code>ìœ¼ë¡œ ìµœì‹ ì¸ì§€ í™•ì¸(ê°€ëŠ¥í•˜ë©´ 21.3+).</p>
      </li>
      <li>
        <p>í”„ë¡œì íŠ¸ ë£¨íŠ¸ì—ì„œ <code class="language-plaintext highlighter-rouge">pip install -r requirements.txt</code> ì‹¤í–‰í–ˆëŠ”ì§€ í™•ì¸.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">markdown_en_span/pyproject.toml</code> íŒŒì¼ì´ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>MkDocsê°€ í™•ì¥ì„ ëª» ì°¾ëŠ”ë‹¤ë©´</strong></p>

    <ul>
      <li>
        <p>ì„¤ì¹˜ ì„±ê³µ ì—¬ë¶€: <code class="language-plaintext highlighter-rouge">pip show markdown_en_span</code></p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">mkdocs.yml</code>ì˜ <code class="language-plaintext highlighter-rouge">markdown_extensions:</code>ì— <code class="language-plaintext highlighter-rouge">en_span</code>ì´ ë“¤ì–´ìˆëŠ”ì§€ í™•ì¸.</p>
      </li>
      <li>
        <p>ì„œë²„ ì¬ì‹œì‘: <code class="language-plaintext highlighter-rouge">mkdocs serve</code> ë‹¤ì‹œ ì‹¤í–‰.</p>
      </li>
    </ul>
  </li>
</ul>

<hr />

<p>ì›í•˜ì‹œë©´ ì œê°€ ì œê³µí–ˆë˜ <code class="language-plaintext highlighter-rouge">pyproject.toml</code>/<code class="language-plaintext highlighter-rouge">__init__.py</code> ìƒ˜í”Œì„ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë“œë¦´ê²Œìš”(íŒŒì¼ ë‚´ìš© ë‹¤ì‹œ í•„ìš”í•˜ë©´ ë§í•´ì¤˜!).</p>]]></content><author><name>hvppyarchive</name></author><category term="markdown" /><summary type="html"><![CDATA[]]></summary></entry></feed>