<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.4.1">Jekyll</generator><link href="https://hvppyarchive.github.io/feed.xml" rel="self" type="application/atom+xml" /><link href="https://hvppyarchive.github.io/" rel="alternate" type="text/html" /><updated>2025-10-13T17:02:27+09:00</updated><id>https://hvppyarchive.github.io/feed.xml</id><title type="html">ARCHIVE</title><subtitle>An amazing archive.</subtitle><author><name>hvppyarchive</name></author><entry><title type="html"></title><link href="https://hvppyarchive.github.io/2025-08-19-python-repr-vs-str/" rel="alternate" type="text/html" title="" /><published>2025-10-13T17:02:27+09:00</published><updated>2025-10-13T17:02:27+09:00</updated><id>https://hvppyarchive.github.io/2025-08-19-python-repr-vs-str</id><content type="html" xml:base="https://hvppyarchive.github.io/2025-08-19-python-repr-vs-str/"><![CDATA[<p class="chat--user">

Pythonì—ì„œ <code class="language-plaintext highlighter-rouge">__repr__</code> í•¨ìˆ˜ì™€ <code class="language-plaintext highlighter-rouge">__str__</code> í•¨ìˆ˜ì˜ ì°¨ì´ì 

</p>

<p>Pythonì—ì„œ <code class="language-plaintext highlighter-rouge">__repr__</code> ê³¼ <code class="language-plaintext highlighter-rouge">__str__</code> ì˜ ì°¨ì´ì ì€ <strong>ê°ì²´ë¥¼ ë¬¸ìì—´ë¡œ í‘œí˜„í•˜ëŠ” ëª©ì </strong> ì—ì„œ ë‹¬ë¼ì§‘ë‹ˆë‹¤. ì°¨ì´ë¥¼ ë‹¨ê³„ì ìœ¼ë¡œ ì •ë¦¬í•´ë“œë¦´ê²Œìš”.</p>

<hr />

<h2 id="1-__repr__-ì˜-ëª©ì ">1. <code class="language-plaintext highlighter-rouge">__repr__</code> ì˜ ëª©ì </h2>

<ul>
  <li>
    <p><strong>ê°œë°œì ì¤‘ì‹¬</strong> : ê°ì²´ë¥¼ "ê°œë°œì"ê°€ ë³´ê³  ì´í•´í•  ìˆ˜ ìˆë„ë¡ í‘œí˜„í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>ì¬í˜„ ê°€ëŠ¥(reproducible)</strong> : ê°€ëŠ¥í•œ í•œ ê°ì²´ë¥¼ ë‹¤ì‹œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ì½”ë“œ í˜•íƒœë¡œ ë³´ì—¬ì£¼ëŠ” ê²ƒì´ ëª©í‘œì…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë³´í†µ <code class="language-plaintext highlighter-rouge">eval(repr(obj)) == obj</code> ê°€ ì„±ë¦½í•˜ëŠ” í˜•íƒœë¥¼ ì§€í–¥í•©ë‹ˆë‹¤ (ê¼­ í•­ìƒ ê·¸ëŸ° ê±´ ì•„ë‹ˆì§€ë§Œ ê¶Œì¥).</p>
  </li>
  <li>
    <p>ë””ë²„ê¹…í•  ë•Œ ì£¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.</p>
  </li>
</ul>

<p>ì˜ˆì‹œ:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
    
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Person(name=</span><span class="sh">'</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">'</span><span class="s">, age=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">age</span><span class="si">}</span><span class="s">)</span><span class="sh">"</span>

<span class="n">p</span> <span class="o">=</span> <span class="nc">Person</span><span class="p">(</span><span class="sh">"</span><span class="s">Alice</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>  <span class="c1"># Person(name='Alice', age=30)
</span></code></pre></div></div>

<hr />

<h2 id="2-__str__-ì˜-ëª©ì ">2. <code class="language-plaintext highlighter-rouge">__str__</code> ì˜ ëª©ì </h2>

<ul>
  <li>
    <p><strong>ì‚¬ìš©ì ì¤‘ì‹¬</strong> : ê°ì²´ë¥¼ "ì‚¬ìš©ì"ê°€ ë³´ê¸° ì¢‹ì€ ë¬¸ìì—´ë¡œ í‘œí˜„í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì½ê¸° ì‰½ê³  ê¹”ë”í•˜ê²Œ ì¶œë ¥í•˜ëŠ” ë° ì´ˆì ì„ ë‘¡ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">print(obj)</code> ë¥¼ í˜¸ì¶œí–ˆì„ ë•Œ ë³´ì—¬ì§€ëŠ” ê°’ì´ <code class="language-plaintext highlighter-rouge">__str__</code> ì…ë‹ˆë‹¤.</p>
  </li>
</ul>

<p>ì˜ˆì‹œ:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
    
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">age</span><span class="si">}</span><span class="s"> years old)</span><span class="sh">"</span>

<span class="n">p</span> <span class="o">=</span> <span class="nc">Person</span><span class="p">(</span><span class="sh">"</span><span class="s">Alice</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>  <span class="c1"># Alice (30 years old)
</span></code></pre></div></div>

<hr />

<h2 id="3-__repr__-vs-__str__-ë¹„êµ">3. <code class="language-plaintext highlighter-rouge">__repr__</code> vs <code class="language-plaintext highlighter-rouge">__str__</code> ë¹„êµ</h2>

<table>
  <thead>
    <tr>
      <th>íŠ¹ì§•</th>
      <th><code class="language-plaintext highlighter-rouge">__repr__</code></th>
      <th><code class="language-plaintext highlighter-rouge">__str__</code></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ëª©ì </td>
      <td>ê°œë°œììš©, ë””ë²„ê¹…</td>
      <td>ì‚¬ìš©ììš©, ê°€ë…ì„±</td>
    </tr>
    <tr>
      <td>ì¶œë ¥ ëŒ€ìƒ</td>
      <td><code class="language-plaintext highlighter-rouge">repr(obj)</code>, ëŒ€í™”í˜• ì‰˜ì—ì„œ ê¸°ë³¸</td>
      <td><code class="language-plaintext highlighter-rouge">str(obj)</code>, <code class="language-plaintext highlighter-rouge">print(obj)</code></td>
    </tr>
    <tr>
      <td>í˜•ì‹</td>
      <td>ê°ì²´ ì¬í˜„ ê°€ëŠ¥í•˜ê±°ë‚˜ ìƒì„¸</td>
      <td>ì½ê¸° ì‰¬ìš´ ì„¤ëª… ìœ„ì£¼</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="4-êµ¬í˜„-ì‹œ-ì£¼ì˜ì‚¬í•­">4. êµ¬í˜„ ì‹œ ì£¼ì˜ì‚¬í•­</h2>

<ul>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">__str__</code> ê°€ ì—†ìœ¼ë©´ <code class="language-plaintext highlighter-rouge">__repr__</code> ê°€ ëŒ€ì‹  ì‚¬ìš©</strong>ë©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë”°ë¼ì„œ ìµœì†Œí•œ <code class="language-plaintext highlighter-rouge">__repr__</code> ì€ ì •ì˜í•´ ë‘ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />

<p>ğŸ‘‰ ì •ë¦¬í•˜ë©´,</p>

<ul>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">__repr__</code></strong> : â€œê°œë°œìê°€ ë””ë²„ê¹…í•  ë•Œâ€ ê°ì²´ì˜ ì •í™•í•œ í‘œí˜„.</p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">__str__</code></strong> : â€œì‚¬ìš©ìê°€ ì¶œë ¥ë¬¼ì„ ë³¼ ë•Œâ€ ë³´ê¸° ì¢‹ê²Œ í‘œí˜„.</p>
  </li>
</ul>

<hr />

<p>ì›í•˜ì‹œë©´ <code class="language-plaintext highlighter-rouge">__repr__</code> ì™€ <code class="language-plaintext highlighter-rouge">__str__</code> ë¥¼ ë™ì‹œì— êµ¬í˜„í–ˆì„ ë•Œ <code class="language-plaintext highlighter-rouge">print(obj)</code> ì™€ <code class="language-plaintext highlighter-rouge">obj</code> (ì‰˜ ì¶œë ¥) ì˜ ì°¨ì´ë¥¼ ì§ì ‘ ì‹¤í–‰í•´ ë³´ì—¬ë“œë¦´ ìˆ˜ë„ ìˆëŠ”ë°, ì˜ˆì œ ì½”ë“œ ì‹œì—°ì„ ì›í•˜ì‹œë‚˜ìš”?</p>]]></content><author><name>hvppyarchive</name></author></entry><entry><title type="html">IBM LSF Python íŒ¨í‚¤ì§€ ê°œë°œ</title><link href="https://hvppyarchive.github.io/python/python-lsf-package/" rel="alternate" type="text/html" title="IBM LSF Python íŒ¨í‚¤ì§€ ê°œë°œ" /><published>2025-10-13T17:02:21+09:00</published><updated>2025-10-13T17:02:21+09:00</updated><id>https://hvppyarchive.github.io/python/python-lsf-package</id><content type="html" xml:base="https://hvppyarchive.github.io/python/python-lsf-package/"><![CDATA[<p class="chat--user">

IBM LSF ì•Œì•„?

</p>

<p>ë„¤! IBM <strong>Spectrum LSF</strong>(ì˜› <em>Platform LSF</em>)ëŠ” HPC/ëŒ€ê·œëª¨ ì„œë²„ íŒœì—ì„œ ë°°ì¹˜ ì‘ì—…ì„ ìŠ¤ì¼€ì¤„ë§Â·íì‰Â·ìì›ê´€ë¦¬í•˜ëŠ” ìƒìš© ì›Œí¬ë¡œë“œ ë§¤ë‹ˆì €ì˜ˆìš”. ê°„ë‹¨íˆ í•µì‹¬ë§Œ ë‹¨ê³„ë³„ë¡œ ì •ë¦¬í•´ë³¼ê²Œìš”.</p>

<h1 id="1-ë­-í•˜ëŠ”-íˆ´">1) ë­ í•˜ëŠ” íˆ´?</h1>

<ul>
  <li>
    <p>ë§ì€ ì‚¬ìš©ì/ì‘ì—…ì„ í(Queue)ì— ë„£ê³ , í´ëŸ¬ìŠ¤í„°ì˜ CPUÂ·ë©”ëª¨ë¦¬Â·GPUÂ·ë¼ì´ì„ ìŠ¤ ê°™ì€ ìì›ì„ ê·œì¹™ì— ë§ì¶° ìë™ ë¶„ë°°í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ìš°ì„ ìˆœìœ„, ê³µì • ë°°ë¶„(fairshare), ì„ ì /ë°±í•„(backfill), ì˜ˆì•½(SLA/ì˜ˆì•½ìŠ¬ë¡¯), ë‹¤ì¤‘ í´ëŸ¬ìŠ¤í„° ë“± ì •ì±…ì„ ì„¸ë°€í•˜ê²Œ ê±¸ ìˆ˜ ìˆì–´ìš”.</p>
  </li>
</ul>

<h1 id="2-êµ¬ì„±-ìš”ì†Œì•„ì£¼-ìš”ì•½">2) êµ¬ì„± ìš”ì†Œ(ì•„ì£¼ ìš”ì•½)</h1>

<ul>
  <li>
    <p><strong>mbatchd / mbschd</strong> : ë§ˆìŠ¤í„° ë°°ì¹˜Â·ìŠ¤ì¼€ì¤„ëŸ¬ ë°ëª¬(ì‘ì—… ê²°ì • ë‡Œ).</p>
  </li>
  <li>
    <p><strong>sbatchd</strong>(ê° ì›Œì»¤ í˜¸ìŠ¤íŠ¸): ì‘ì—… ì‹¤í–‰/ëª¨ë‹ˆí„°ë§.</p>
  </li>
  <li>
    <p><strong>lim / res</strong> : í˜¸ìŠ¤íŠ¸ ë¶€í•˜ì •ë³´ ìˆ˜ì§‘ê³¼ ì›ê²© ì‹¤í–‰.</p>
  </li>
  <li>
    <p>ê´€ë¦¬/ì‚¬ìš©ìëŠ” <strong>bsub, bjobs, bqueues</strong> ê°™ì€ CLIë¡œ ìƒí˜¸ì‘ìš©.</p>
  </li>
</ul>

<h1 id="3-ê¸°ë³¸-ì‚¬ìš©-íë¦„">3) ê¸°ë³¸ ì‚¬ìš© íë¦„</h1>

<ol>
  <li>
    <p>ì‚¬ìš©ìê°€ í/ìš”êµ¬ìì›ê³¼ í•¨ê»˜ ì‘ì—… ì œì¶œ â†’ <code class="language-plaintext highlighter-rouge">bsub ...</code></p>
  </li>
  <li>
    <p>LSFê°€ ì •ì±…Â·ê°€ìš©ìì› í‰ê°€ â†’ ì í•©í•œ ë…¸ë“œì— í• ë‹¹</p>
  </li>
  <li>
    <p>ì‹¤í–‰Â·ëª¨ë‹ˆí„°ë§ â†’ ì™„ë£Œ í›„ ë¡œê·¸/ê²°ê³¼ ìˆ˜ì§‘</p>
  </li>
</ol>

<h1 id="4-ìì£¼-ì“°ëŠ”-ëª…ë ¹í•„ìˆ˜-ìµœì†Œì…‹">4) ìì£¼ ì“°ëŠ” ëª…ë ¹(í•„ìˆ˜ ìµœì†Œì…‹)</h1>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì‘ì—… ì œì¶œ</span>
bsub <span class="nt">-q</span> normal <span class="nt">-J</span> myjob <span class="nt">-n</span> 4 <span class="nt">-R</span> <span class="s2">"rusage[mem=8G]"</span> <span class="nt">-oo</span> out.%J <span class="nt">-eo</span> err.%J ./run.sh

<span class="c"># ìƒíƒœ/ì¶œë ¥ í™•ì¸</span>
bjobs              <span class="c"># ë‚´ ì¡ ìš”ì•½</span>
bjobs <span class="nt">-l</span> &lt;JOBID&gt;   <span class="c"># ìƒì„¸</span>
bpeek &lt;JOBID&gt;      <span class="c"># ì‹¤í–‰ ì¤‘ í‘œì¤€ì¶œë ¥ ì—¿ë³´ê¸°(ì„¤ì •ì— ë”°ë¼ ì§€ì›)</span>

<span class="c"># í/í˜¸ìŠ¤íŠ¸ ë³´ê¸°</span>
bqueues <span class="nt">-l</span>         <span class="c"># í ìƒì„¸ ì •ì±…</span>
bhosts             <span class="c"># í˜¸ìŠ¤íŠ¸ ìƒíƒœ</span>

<span class="c"># ì œì–´</span>
bstop &lt;JOBID&gt;      <span class="c"># ì¼ì‹œì¤‘ì§€</span>
bresume &lt;JOBID&gt;    <span class="c"># ì¬ê°œ</span>
bkill &lt;JOBID&gt;      <span class="c"># ì¢…ë£Œ</span>
bhist <span class="nt">-l</span> &lt;JOBID&gt;   <span class="c"># íˆìŠ¤í† ë¦¬</span>
</code></pre></div></div>

<h1 id="5-ì œì¶œ-ìŠ¤í¬ë¦½íŠ¸-ì˜ˆì‹œê°€ì¥-ë‹¨ìˆœí•œ-í˜•íƒœ">5) ì œì¶œ ìŠ¤í¬ë¦½íŠ¸ ì˜ˆì‹œ(ê°€ì¥ ë‹¨ìˆœí•œ í˜•íƒœ)</h1>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># run.sh</span>
<span class="c">#!/usr/bin/env bash</span>
<span class="nb">echo</span> <span class="s2">"Host: </span><span class="si">$(</span><span class="nb">hostname</span><span class="si">)</span><span class="s2">"</span>
<span class="nb">echo</span> <span class="s2">"Start: </span><span class="si">$(</span><span class="nb">date</span><span class="si">)</span><span class="s2">"</span>
python train.py <span class="nt">--epochs</span> 10
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ì œì¶œ</span>
bsub <span class="nt">-q</span> normal <span class="nt">-J</span> train <span class="nt">-n</span> 4 <span class="nt">-R</span> <span class="s2">"rusage[mem=8G]"</span> <span class="nt">-oo</span> train.%J.out ./run.sh
</code></pre></div></div>

<h1 id="6-ì •ì±…ìì›-ìš”ì²­-íŒ">6) ì •ì±…/ìì› ìš”ì²­ íŒ</h1>

<ul>
  <li>
    <p><strong>CPU ì½”ì–´ ìˆ˜</strong> : <code class="language-plaintext highlighter-rouge">-n 8</code></p>
  </li>
  <li>
    <p><strong>ë©”ëª¨ë¦¬</strong> : <code class="language-plaintext highlighter-rouge">-R "rusage[mem=16G]"</code> (í´ëŸ¬ìŠ¤í„° ì •ì±…ê³¼ ë‹¨ìœ„ í™•ì¸ í•„ìˆ˜)</p>
  </li>
  <li>
    <p><strong>ë…¸ë“œ ìŠ¤í”„ë ˆë“œ</strong> : <code class="language-plaintext highlighter-rouge">-R "span[ptile=4]"</code> (í˜¸ìŠ¤íŠ¸ë‹¹ ì½”ì–´ 4ê°œì”© ë°°ì¹˜)</p>
  </li>
  <li>
    <p><strong>GPU</strong> : í´ëŸ¬ìŠ¤í„° ì„¤ì •ì— ë”°ë¼ ì „ìš© ì˜µì…˜/ë¦¬ì†ŒìŠ¤ëª…ì´ ë‹¤ë¦…ë‹ˆë‹¤. ë³´í†µ ì „ìš© íë¥¼ ì“°ê±°ë‚˜ <code class="language-plaintext highlighter-rouge">-R</code>/<code class="language-plaintext highlighter-rouge">-gpu</code>(í™˜ê²½ì— ë”°ë¼ ì§€ì›)ë¡œ ìš”ì²­í•©ë‹ˆë‹¤. ìš´ì˜íŒ€ì´ ì •í•œ í‘œì¤€ì„ í™•ì¸í•˜ì„¸ìš”.</p>
  </li>
</ul>

<h1 id="7-ì¥ë‹¨ì í•œëˆˆì—">7) ì¥ë‹¨ì (í•œëˆˆì—)</h1>

<ul>
  <li>
    <p><strong>ì¥ì </strong> : ì„±ìˆ™í•œ ì •ì±…/ì—”í„°í”„ë¼ì´ì¦ˆ ì§€ì›, ì´ê¸°ì¢…Â·ëŒ€ê·œëª¨ í´ëŸ¬ìŠ¤í„° ìš´ì˜ ê²½í—˜ í’ë¶€, ëª¨ë‹ˆí„°ë§/ë¦¬í¬íŒ…(LSF RTM ë“±) ìƒíƒœê³„.</p>
  </li>
  <li>
    <p><strong>ë‹¨ì </strong> : ìƒìš© ë¼ì´ì„ ìŠ¤ ë¹„ìš©, ì„¤ì • ì´ˆê¸° ëŸ¬ë‹ì»¤ë¸Œ, ì»¤ìŠ¤í…€ ì •ì±… ì´í•´ í•„ìš”.</p>
  </li>
  <li>
    <p><strong>ëŒ€ì•ˆ</strong> : Slurm(ì˜¤í”ˆì†ŒìŠ¤), PBS Pro/Altair PBS, Grid Engine ê³„ì—´ ë“±.</p>
  </li>
</ul>

<hr />

<p>ì›í•˜ì‹œë©´,</p>

<ul>
  <li>
    <p>í˜„ì¬ í™˜ê²½(í ì´ë¦„, ìì› ê·œì¹™, GPU ìš”ì²­ ë°©ì‹)ì— ë§ì¶˜ <strong>ì œì¶œ í…œí”Œë¦¿</strong> ì„ ë°”ë¡œ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”,</p>
  </li>
  <li>
    <p>ë˜ëŠ” ê¸°ì¡´ Slurm/PBS ìŠ¤í¬ë¦½íŠ¸ë¥¼ LSFë¡œ <strong>ìë™ ë³€í™˜</strong> í•´ì„œ ë“œë¦´ ìˆ˜ë„ ìˆì–´ìš”. ì–´ë–¤ ì›Œí¬ë¡œë“œë¥¼ ëŒë¦¬ì‹¤ ê³„íšì¸ê°€ìš”?</p>
  </li>
</ul>

<p class="chat--user">

ë‚˜ëŠ” LSFì— ì—¬ëŸ¬ Jobì„ Submití•˜ê³  ì¢…ë£Œì‹œí‚¤ê¸°/ì™„ë£Œ ì—¬ë¶€ íŒŒì•… ë“±ë“± ìë™í™” ì—…ë¬´ë¥¼ í•˜ê³  ìˆì–´.(íŒŒì´ì¬) ê·¸ëŸ°ë° "bsub", "bkill", "bjobs" ê°™ì€ ì»¤ë§¨ë“œë¥¼ subprocessë¡œ ë§¤ë²ˆ callí•˜ë‹ˆ ê´€ë¦¬ê°€ í˜ë“¤ê³  ëŠë¦¬ê¸°ë„ í•´(subprocessê°€ ëë‚˜ì„œ job IDë¥¼ ë°›ì•„ì™€ì•¼ í•˜ë¯€ë¡œ) bsub, bkill ì‹œì—ëŠ” async ê¸°ëŠ¥ì„ í™œìš©í•˜ê³ , bjobsëŠ” memory/storage cacheë¥¼ í†µí•´ ë„ˆë¬´ ìì£¼ í”„ë¡œì„¸ìŠ¤ë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šì•˜ìœ¼ë©´ ì¢‹ê² ì–´(LSF ì‹œìŠ¤í…œ ë¶€í•˜ ì¤„ì´ê¸° ìœ„í•´).

</p>

<p>ì¢‹ì•„ìš”! ìš”êµ¬ì‚¬í•­(ë¹„ë™ê¸° ì œì¶œ/ì¢…ë£Œ + <code class="language-plaintext highlighter-rouge">bjobs</code> í˜¸ì¶œ ìºì‹±/ê°ì†)ì„ ë§Œì¡±í•˜ëŠ” <strong>ê°„ë‹¨í•˜ì§€ë§Œ íƒ„íƒ„í•œ ì•„í‚¤í…ì²˜ + ì°¸ì¡° êµ¬í˜„</strong> ì„ ë°”ë¡œ ë“œë¦´ê²Œìš”.<br />
ì•„ë˜ ìˆœì„œëŒ€ë¡œ ë³´ì‹œë©´ ë©ë‹ˆë‹¤.</p>

<h1 id="0-ëª©í‘œ-step-by-step">0) ëª©í‘œ (Step-by-step)</h1>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bsub</code>, <code class="language-plaintext highlighter-rouge">bkill</code>ì€ <code class="language-plaintext highlighter-rouge">asyncio</code> ê¸°ë°˜ìœ¼ë¡œ <strong>ë™ì‹œì— ë§ì´</strong> ëŒë¦´ ìˆ˜ ìˆê²Œ.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bjobs</code>ëŠ” <strong>TTL ìºì‹œ + ë‹¨ì¼ë¹„í–‰(single-flight) + ë ˆì´íŠ¸ë¦¬ë°‹</strong> ìœ¼ë¡œ ê³¼í˜¸ì¶œ ë°©ì§€.</p>
  </li>
  <li>
    <p>ê°€ëŠ¥í•œ í•œ <strong>ë°°ì¹˜(batch)</strong> ë¡œ ë¬¶ì–´ì„œ í˜¸ì¶œìˆ˜ ìµœì†Œí™”.</p>
  </li>
  <li>
    <p>ì¶œë ¥ íŒŒì‹±ì€ <strong>locale ê³ ì •(LC_ALL=C)</strong> + <strong>ì•ˆì „í•œ ì •ê·œì‹/í•„ë“œì…‹</strong> ë§Œ ì‚¬ìš©.</p>
  </li>
</ol>

<hr />

<h1 id="1-ì„¤ê³„-í•µì‹¬">1) ì„¤ê³„ í•µì‹¬</h1>

<ul>
  <li>
    <p><strong>ë™ì‹œì„± ì œì–´</strong> : ëª¨ë“  LSF CLI í˜¸ì¶œì— ê³µí†µ ì„¸ë§ˆí¬ì–´(ì˜ˆ: ë™ì‹œ 8ê°œ) + ëª…ë ¹ë³„ ë ˆì´íŠ¸ë¦¬ë°‹(ì˜ˆ: <code class="language-plaintext highlighter-rouge">bjobs</code>ëŠ” ì´ˆë‹¹ 1íšŒ).</p>
  </li>
  <li>
    <p><strong>ë¹„ë™ê¸° ì œì¶œ/ì¢…ë£Œ</strong> : <code class="language-plaintext highlighter-rouge">asyncio.create_subprocess_exec</code>ë¡œ <code class="language-plaintext highlighter-rouge">bsub</code>, <code class="language-plaintext highlighter-rouge">bkill</code>ë¥¼ ë¹„ë™ê¸° ì‹¤í–‰.</p>
  </li>
  <li>
    <p><strong>bjobs ìºì‹œ</strong> :</p>

    <ul>
      <li>
        <p><strong>TTL ìºì‹œ</strong>(ì˜ˆ: 3~5ì´ˆ): TTL ë‚´ ì¬ìš”ì²­ì€ ë©”ëª¨ë¦¬ì—ì„œ ì¦‰ì‹œ ì‘ë‹µ.</p>
      </li>
      <li>
        <p><strong>ë‹¨ì¼ë¹„í–‰</strong> : ê°™ì€ í‚¤(ë™ì¼ Job ID ì„¸íŠ¸/í•„í„°)ì˜ <code class="language-plaintext highlighter-rouge">bjobs</code> ìš”ì²­ì´ ë™ì‹œ ë“¤ì–´ì˜¤ë©´ <strong>ì´ë¯¸ ì§„í–‰ ì¤‘ì¸</strong> í•œ ë²ˆë§Œ ì‹¤ì œ ì‹¤í–‰, ë‚˜ë¨¸ì§€ëŠ” ê·¸ Futureë¥¼ await.</p>
      </li>
      <li>
        <p><strong>ë ˆì´íŠ¸ë¦¬ë°‹</strong> : ìµœì†Œ í˜¸ì¶œ ê°„ê²© ë³´ì¥(ì˜ˆ: 1~2ì´ˆ).</p>
      </li>
      <li>
        <p><strong>ë°°ì¹˜ ì¿¼ë¦¬</strong> : ì—¬ëŸ¬ Job ID ìš”ì²­ì„ <strong>í•©ì§‘í•©</strong> ìœ¼ë¡œ ë¬¶ì–´ í•œ ë²ˆì— ì¡°íšŒ â†’ ê²°ê³¼ë¥¼ per-jobë¡œ ë¶„ì‚°.</p>
      </li>
    </ul>
  </li>
</ul>

<blockquote>
  <p>ì°¸ê³ : LSFëŠ” <code class="language-plaintext highlighter-rouge">bjobs</code>ì˜ ì¶œë ¥ í¬ë§·ì„ <code class="language-plaintext highlighter-rouge">-o</code>ë¡œ ì œì–´í•  ìˆ˜ ìˆì§€ë§Œ, ë‚ ì§œ í•„ë“œëŠ” ê³µë°±ì´ ìˆì–´ íŒŒì‹±ì´ ê¹Œë‹¤ë¡­ìŠµë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” <strong>í•„ìš” ìµœì†Œ í•„ë“œ</strong>(ê³µë°± ì—†ëŠ” ê²ƒë“¤)ë§Œ ìš”ì²­í•©ë‹ˆë‹¤: <code class="language-plaintext highlighter-rouge">jobid stat exit_code queue exec_host</code><br />
 (ì‹œê°„ì´ í•„ìš”í•˜ë©´ ë³„ë„ í¬ë§·/êµ¬ë¶„ ê¸°í˜¸ë¥¼ ì¶”ê°€í•´ í™•ì¥ ê°€ëŠ¥)</p>
</blockquote>

<hr />

<h1 id="2-ì°¸ì¡°-êµ¬í˜„-ë‹¨ì¼-íŒŒì¼-ë°”ë¡œ-ë¶™ì—¬ë„£ì–´-ì‚¬ìš©-ê°€ëŠ¥">2) ì°¸ì¡° êµ¬í˜„ (ë‹¨ì¼ íŒŒì¼; ë°”ë¡œ ë¶™ì—¬ë„£ì–´ ì‚¬ìš© ê°€ëŠ¥)</h1>

<p>ì•„ë˜ëŠ” ì˜ì¡´ì„± ì—†ëŠ” ìˆœìˆ˜ Python 3.10+ ì½”ë“œì…ë‹ˆë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># lsf_async.py
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="n">_JOBID_RE</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="nb">RuntimeError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Command failed: </span><span class="si">{</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="si">}</span><span class="s"> (rc=</span><span class="si">{</span><span class="n">returncode</span><span class="si">}</span><span class="s">)</span><span class="se">\n</span><span class="si">{</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span>
        <span class="n">self</span><span class="p">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="n">returncode</span>
        <span class="n">self</span><span class="p">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span>
        <span class="n">self</span><span class="p">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">stderr</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
               <span class="o">*</span><span class="p">,</span>
               <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
               <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">Run a command asynchronously and return (stdout, stderr, returncode).</span><span class="sh">"""</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
        <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ProcessLookupError</span><span class="p">):</span>
            <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
        <span class="k">raise</span>
    <span class="k">return</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>

<span class="k">class</span> <span class="nc">LsfClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Async LSF CLI wrapper with:
      - concurrent bsub/bkill
      - cached/rate-limited bjobs
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                 <span class="o">*</span><span class="p">,</span>
                 <span class="n">bsub</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bsub</span><span class="sh">"</span><span class="p">,</span>
                 <span class="n">bkill</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">,</span>
                 <span class="n">bjobs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">,</span>
                 <span class="n">max_concurrent_cli</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
                 <span class="n">bjobs_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
                 <span class="n">bjobs_min_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                 <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">paths</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">bsub</span><span class="sh">"</span><span class="p">:</span> <span class="n">bsub</span><span class="p">,</span> <span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">:</span> <span class="n">bkill</span><span class="p">,</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">:</span> <span class="n">bjobs</span><span class="p">}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">max_concurrent_cli</span><span class="p">)</span>

        <span class="c1"># Cache &amp; in-flight tracking for bjobs
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span> <span class="o">=</span> <span class="n">bjobs_ttl_sec</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">=</span> <span class="n">bjobs_min_interval_sec</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_inflight</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_last_call_ts</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">base_env</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LC_ALL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LANG</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">base_env</span> <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="bp">None</span> <span class="nf">else </span><span class="p">(</span><span class="n">base_env</span> <span class="o">|</span> <span class="n">env</span><span class="p">)</span>

    <span class="c1"># ---------- helpers ----------
</span>    <span class="k">def</span> <span class="nf">_key_for_bjobs</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="n">extra_flags</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="nf">tuple</span><span class="p">(</span><span class="nf">sorted</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">)))</span> <span class="k">if</span> <span class="n">job_ids</span> <span class="nf">else </span><span class="p">()</span>
        <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs|</span><span class="si">{</span><span class="n">extra_flags</span><span class="si">}</span><span class="s">|</span><span class="si">{</span><span class="n">ids</span><span class="si">}</span><span class="sh">"</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_guarded_run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="nf">_run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">env</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="c1"># ---------- public API ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                     <span class="n">command</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
                     <span class="o">*</span><span class="p">,</span>
                     <span class="n">queue</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">job_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">n_cpus</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">rusage</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">out_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">err_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">cwd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">extra_bsub_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        Submit a job via bsub and return job id.
        `command` may be a shell string or a sequence.
        </span><span class="sh">"""</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">paths</span><span class="p">[</span><span class="sh">"</span><span class="s">bsub</span><span class="sh">"</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">queue</span><span class="p">:</span> <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-q</span><span class="sh">"</span><span class="p">,</span> <span class="n">queue</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">job_name</span><span class="p">:</span> <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-J</span><span class="sh">"</span><span class="p">,</span> <span class="n">job_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">n_cpus</span><span class="p">:</span> <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-n</span><span class="sh">"</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">n_cpus</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">rusage</span><span class="p">:</span> <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-R</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">rusage[</span><span class="si">{</span><span class="n">rusage</span><span class="si">}</span><span class="s">]</span><span class="sh">"</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">out_file</span><span class="p">:</span> <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-oo</span><span class="sh">"</span><span class="p">,</span> <span class="n">out_file</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">err_file</span><span class="p">:</span> <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-eo</span><span class="sh">"</span><span class="p">,</span> <span class="n">err_file</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">extra_bsub_args</span><span class="p">:</span> <span class="n">args</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="n">extra_bsub_args</span><span class="p">)</span>

        <span class="c1"># bsub expects the job command at the end; if a string, run via /bin/sh -c
</span>        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="n">command</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Treat the sequence as an executable + args (no shell)
</span>            <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">command</span><span class="p">))]</span>

        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guarded_run</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

        <span class="c1"># Parse: "Job &lt;12345&gt; is submitted to queue &lt;normal&gt;."
</span>        <span class="n">m</span> <span class="o">=</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Cannot parse job id from bsub output:</span><span class="se">\n</span><span class="si">{</span><span class="n">stdout</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">stderr</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">int</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                   <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
                   <span class="o">*</span><span class="p">,</span>
                   <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                   <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        Kill one or many jobs with a single bkill call.
        </span><span class="sh">"""</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">job_ids</span><span class="p">))]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">paths</span><span class="p">[</span><span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-f</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="n">ids</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guarded_run</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                     <span class="n">job_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="o">*</span><span class="p">,</span>
                     <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                     <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sh">"""</span><span class="s">
        Get job status map: {jobid: {stat, exit_code, queue, exec_host}}.
        Uses TTL cache + single-flight + rate limiting.
        If job_ids is None, queries all of the current user</span><span class="sh">'</span><span class="s">s jobs.
        </span><span class="sh">"""</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-a</span><span class="sh">"</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_key_for_bjobs</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>

        <span class="c1"># Serve cached if fresh
</span>        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">cached</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached</span> <span class="ow">and</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">cached</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cached</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Single-flight: if another coroutine is already fetching this key, await it
</span>        <span class="n">inflight</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_inflight</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inflight</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">inflight</span>

        <span class="c1"># Create the in-flight future
</span>        <span class="n">fut</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">().</span><span class="nf">create_future</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_inflight</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fut</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Simple rate limit for bjobs
</span>            <span class="n">since</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_last_call_ts</span>
            <span class="k">if</span> <span class="n">since</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">-</span> <span class="n">since</span><span class="p">)</span>

            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">paths</span><span class="p">[</span><span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">-noheader</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">include_done</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-a</span><span class="sh">"</span><span class="p">]</span>
            <span class="c1"># Request only whitespace-safe fields
</span>            <span class="c1"># Fields: jobid stat exit_code queue exec_host
</span>            <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-o</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">jobid stat exit_code queue exec_host</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">job_ids</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">set</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)]</span>

            <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guarded_run</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_last_call_ts</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

            <span class="c1"># Parse lines; with chosen fields, tokens are whitespace-separated safely
</span>            <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">split</span><span class="p">()</span>
                <span class="c1"># Expect exactly 5 tokens
</span>                <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="c1"># best-effort: skip malformed
</span>                    <span class="k">continue</span>
                <span class="n">jid</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">exec_host</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">jid_i</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">result</span><span class="p">[</span><span class="n">jid_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="n">stat</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="sh">"</span><span class="s">-</span><span class="sh">"</span> <span class="k">else</span> <span class="n">exit_code</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="n">queue</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="n">exec_host</span><span class="p">,</span>
                <span class="p">}</span>

            <span class="c1"># Cache and resolve the in-flight future
</span>            <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">result</span><span class="p">)</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># clean inflight
</span>            <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_inflight</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="c1"># --------- convenience: bulk status with de-dup &amp; union batching ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">status_union_batched</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                                   <span class="n">list_of_job_id_sets</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
                                   <span class="o">*</span><span class="p">,</span>
                                   <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                                   <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
        <span class="sh">"""</span><span class="s">
        Given multiple callers wanting statuses for different sets, perform
        ONE bjobs with the union of ids, then slice the result per request.
        (Uses the normal cache path internally.)
        </span><span class="sh">"""</span>
        <span class="n">union_ids</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="n">normalized</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">list_of_job_id_sets</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>
            <span class="n">normalized</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">norm</span><span class="p">)</span>
            <span class="n">union_ids</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">norm</span><span class="p">)</span>
        <span class="n">union_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">union_ids</span><span class="p">,</span> <span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">req_ids</span> <span class="ow">in</span> <span class="n">normalized</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">union_result</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req_ids</span><span class="p">}</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
</code></pre></div></div>

<hr />

<h1 id="3-ì‚¬ìš©-ì˜ˆì‹œ">3) ì‚¬ìš© ì˜ˆì‹œ</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">lsf_async</span> <span class="kn">import</span> <span class="n">LsfClient</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">lsf</span> <span class="o">=</span> <span class="nc">LsfClient</span><span class="p">(</span>
        <span class="n">max_concurrent_cli</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>      <span class="c1"># ë™ì‹œì— ì—´ ìˆ˜ ìˆëŠ” LSF CLI í”„ë¡œì„¸ìŠ¤ ìˆ˜
</span>        <span class="n">bjobs_ttl_sec</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>         <span class="c1"># bjobs ìºì‹œ TTL
</span>        <span class="n">bjobs_min_interval_sec</span><span class="o">=</span><span class="mf">1.5</span> <span class="c1"># ìµœì†Œ í˜¸ì¶œ ê°„ê²©(ë ˆì´íŠ¸ë¦¬ë°‹)
</span>    <span class="p">)</span>

    <span class="c1"># 1) ì—¬ëŸ¬ ì‘ì—… ë™ì‹œ ì œì¶œ (async)
</span>    <span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sh">'</span><span class="s">echo </span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="s">; sleep 10</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">echo </span><span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="s">; sleep 5</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">echo </span><span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="s">; sleep 2</span><span class="sh">'</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">submit_tasks</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">lsf</span><span class="p">.</span><span class="nf">submit</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="sh">"</span><span class="s">normal</span><span class="sh">"</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">demo_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">out_file</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">demo_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">.%J.out</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">cmds</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">job_ids</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">gather</span><span class="p">(</span><span class="o">*</span><span class="n">submit_tasks</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">submitted:</span><span class="sh">"</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">)</span>

    <span class="c1"># 2) ìƒíƒœ ì¡°íšŒ (ìºì‹œ ON)
</span>    <span class="n">st1</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>     <span class="c1"># ì‹¤ì œ bjobs í˜¸ì¶œ
</span>    <span class="n">st2</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>     <span class="c1"># TTL ë‚´ë¼ë©´ ìºì‹œì—ì„œ ì¦‰ì‹œ ë°˜í™˜
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">status1:</span><span class="sh">"</span><span class="p">,</span> <span class="n">st1</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">status2 (cached):</span><span class="sh">"</span><span class="p">,</span> <span class="n">st2</span><span class="p">)</span>

    <span class="c1"># 3) ì¼ë¶€ ì¢…ë£Œ (ë°°ì¹˜ bkill)
</span>    <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">job_ids</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># 4) ì—¬ëŸ¬ consumerê°€ ê°ì ìƒíƒœë¥¼ ì›í•  ë•Œ union ë°°ì¹˜
</span>    <span class="n">reqs</span> <span class="o">=</span> <span class="p">[[</span><span class="n">job_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">job_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">job_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">job_ids</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span>
    <span class="n">batched</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">status_union_batched</span><span class="p">(</span><span class="n">reqs</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">batched</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h1 id="4-íŠœë‹-í¬ì¸íŠ¸">4) íŠœë‹ í¬ì¸íŠ¸</h1>

<ul>
  <li>
    <p><strong>ë™ì‹œì„±</strong> : <code class="language-plaintext highlighter-rouge">max_concurrent_cli</code>(ê¸°ë³¸ 8). LSF ë§ˆìŠ¤í„°/íŒŒì¼ì„œë²„ ë¶€í•˜ì— ë”°ë¼ 4~16 ì‚¬ì´ë¡œ ì¡°ì • ê¶Œì¥.</p>
  </li>
  <li>
    <p><strong>bjobs TTL</strong> : <code class="language-plaintext highlighter-rouge">bjobs_ttl_sec</code>(ê¸°ë³¸ 3s). ì›Œí¬ë¡œë“œê°€ ì¡°ìš©í•˜ë©´ 5~10sê¹Œì§€ ì˜¬ë¦¬ë©´ ë” íš¨ê³¼ì .</p>
  </li>
  <li>
    <p><strong>ìµœì†Œ í˜¸ì¶œ ê°„ê²©</strong> : <code class="language-plaintext highlighter-rouge">bjobs_min_interval_sec</code>(ê¸°ë³¸ 1~2s). íŒ€/í´ëŸ¬ìŠ¤í„° ì •ì±…ì— ë§ì¶° ì„¤ì •.</p>
  </li>
  <li>
    <p><strong>ë°°ì¹˜ ì¢…ë£Œ</strong> : <code class="language-plaintext highlighter-rouge">kill([...])</code>ëŠ” ID ë¦¬ìŠ¤íŠ¸ë¥¼ ë°›ì•„ <strong>í•œ ë²ˆì˜<code class="language-plaintext highlighter-rouge">bkill</code></strong> ë¡œ ì²˜ë¦¬ â†’ í˜¸ì¶œ ìˆ˜ ì ˆê°.</p>
  </li>
  <li>
    <p><strong>ë°°ì¹˜ ìƒíƒœ ì¡°íšŒ</strong> : ì—¬ëŸ¬ í˜¸ì¶œì„ ë¬¶ê³  ì‹¶ìœ¼ë©´ <code class="language-plaintext highlighter-rouge">status_union_batched()</code> ì‚¬ìš©.</p>
  </li>
</ul>

<hr />

<h1 id="5-í™•ì¥-ì•„ì´ë””ì–´">5) í™•ì¥ ì•„ì´ë””ì–´</h1>

<ul>
  <li>
    <p><strong>Persistent ìºì‹œ(ì˜µì…˜)</strong> : ë§ˆì§€ë§‰ ìƒíƒœë¥¼ SQLite ë“±ì— ì €ì¥ â†’ í”„ë¡œì„¸ìŠ¤ ì¬ì‹œì‘ ì‹œ â€œìµœê·¼ ìƒíƒœâ€ ì¦‰ì‹œ ì œê³µ + ë°±ê·¸ë¼ìš´ë“œ ë¦¬í”„ë ˆì‹œ.</p>
  </li>
  <li>
    <p><strong>ì´ë²¤íŠ¸ ê¸°ë°˜ ë³´ì™„</strong> : í´ëŸ¬ìŠ¤í„°ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•œ ìƒíƒœ ì´ë²¤íŠ¸/ë¡œê·¸ê°€ ìˆë‹¤ë©´(ê¶Œí•œ í•„ìš”) <code class="language-plaintext highlighter-rouge">bjobs</code> í´ë§ ì£¼ê¸°ë¥¼ ë” ëŠ˜ë¦´ ìˆ˜ ìˆìŒ.</p>
  </li>
  <li>
    <p><strong>ì¶œë ¥ í¬ë§· í™•ì¥</strong> : ì‹œê°„ì´ í•„ìš”í•˜ë©´ <code class="language-plaintext highlighter-rouge">-o</code> í•„ë“œë¥¼ ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆí•˜ê³ , ê³µë°± ë¬¸ì œëŠ” <code class="language-plaintext highlighter-rouge">delimiter</code> ì˜µì…˜(í´ëŸ¬ìŠ¤í„° ë²„ì „ì— ë”°ë¼ ì§€ì›)ì„ ê²€í† í•˜ì„¸ìš”.</p>
  </li>
</ul>

<hr />

<h1 id="6-ì‹¤ì „-ì²´í¬ë¦¬ìŠ¤íŠ¸">6) ì‹¤ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸</h1>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">LANG/LC_ALL=C</code>ë¡œ ê³ ì •í•´ <strong>Job ID íŒŒì‹± ì•ˆì •ì„±</strong> í™•ë³´(ë‹¤êµ­ì–´ ì¶œë ¥ íšŒí”¼).</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bsub</code> ì‹¤íŒ¨/í ê±°ë¶€ ì‹œ <code class="language-plaintext highlighter-rouge">LSFCommandError</code>ë¡œ ì¦‰ì‹œ êµ¬ë¶„(ë¡œê·¸ì— <code class="language-plaintext highlighter-rouge">stderr</code> ë‚¨ê¹€).</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bjobs</code> í•„ë“œ ìˆ˜ê°€ ì˜ˆìƒê³¼ ë‹¤ë¥´ë©´ <strong>ìŠ¤í‚µ</strong>(ë°©ì–´ì½”ë”©) â€” í•„ìš” ì‹œ ë¡œê¹….</p>
  </li>
  <li>
    <p>ë„ˆë¬´ ë§ì€ Job IDë¥¼ í•œ ë²ˆì— ì¡°íšŒí•œë‹¤ë©´ <strong>IDë¥¼ Nê°œ ë‹¨ìœ„ë¡œ chunking</strong>(ì˜ˆ: 500ê°œ)í•˜ëŠ” ë˜í¼ ì¶”ê°€ ê¶Œì¥.</p>
  </li>
</ul>

<hr />

<p>í•„ìš”í•˜ì‹œë©´ ìœ„ ì½”ë“œë¥¼ <strong>ì—¬ëŸ¬ íŒŒì¼ êµ¬ì¡°(íŒ¨í‚¤ì§€í™” + ë¡œê¹…/ë¦¬íŠ¸ë¼ì´/ì¹˜ë° ë“±)</strong> ë¡œ ì •ë¦¬í•´ ë“œë¦´ ìˆ˜ ìˆì–´ìš”.<br />
í˜¹ì‹œ ì§€ê¸ˆ ì“°ì‹œëŠ” ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆë‹¤ë©´, í•µì‹¬ í˜¸ì¶œë¶€ë§Œ ì´ <code class="language-plaintext highlighter-rouge">LsfClient</code>ë¡œ ê°ì‹¸ì„œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜ˆì‹œë„ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

ì¶”ê°€ ì˜ˆì‹œê°€ í•„ìš”í•´. ë§Œì•½ ì½”ë“œ ë³€ê²½ì´ í•„ìš”í•˜ë©´ ë” ë³€ê²½í•´ë„ ë¼. 1. ìœ ì €ê°€ ì‘ì—…ì„ ì·¨ì†Œí•˜ë©´ ê¹”ë”í•˜ê²Œ ëª¨ë‘ ì·¨ì†Œë˜ì–´ì•¼ í•¨.(submit ì‘ì—… ì·¨ì†ŒëŠ” is_interrupted() í•¨ìˆ˜ê°€ Trueë¥¼ ë¦¬í„´í•˜ëŠ” ê²½ìš°ì„. ì´ë¥¼ pollingí•˜ë©° ì²´í¬í•´ì•¼í•¨. ì‘ì—… ì·¨ì†Œì‹œ í˜„ì¬ ìš”ì²­í•œ jobë“¤ì€ ëª¨ë‘ ê¹”ë”í•˜ê²Œ ì·¨ì†Œí•´ì•¼í•¨(bsub í”„ë¡œì„¸ìŠ¤ë¥¼ ì¤‘ê°„ì— ëŠì„ ê²½ìš° ì• ë§¤í•˜ê²Œ bjobë§Œ ì‚´ì•„ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì‹œì‘ëœ bsubì€ ëë‚ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦° í›„ í™•ì‹¤í•˜ê²Œ ì£½ì´ì) 2. bjobs ìºì‹œëŠ” Storage ìºì‹œì™€ Memory Cacheë¥¼ 2ì¤‘ìœ¼ë¡œ ì‚¬ìš©í•˜ì—¬ ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤ì—ì„œë„ bjobs ì‚¬ìš© ìµœì†Œí™”(í”„ë¡œì„¸ìŠ¤1ì—ì„œ ë§Œë“  íŒŒì¼ì„ ì „í˜€ í”„ë¡œì„¸ìŠ¤2ì—ì„œë„ ì‚¬ìš© ê°€ëŠ¥ - bjobsëŠ” í•­ìƒ ì „ì²´ jobì— ëŒ€í•´ ìˆ˜í–‰í•˜ê³  ë¦¬í„´ë§Œ ìš”ì²­ëœ job_ids ê¸°ì¤€ìœ¼ë¡œ ë¦¬í„´) 3. LSF commandê°€ ì•„ë‹Œ commandë„ ìš”ì²­ë  ìˆ˜ ìˆìŒ. ì´ ê²½ìš° ê·¸ëƒ¥ ì‹¤í–‰ë§Œ í•˜ë©´ ë˜ë©° ì—ëŸ¬ë¥¼ ë¿Œë¦¬ì§„ ë§ ê²ƒ(boolean argument ë°›ì•„ì„œ ì—ëŸ¬ë¥¼ raise í• ì§€ ì„ íƒí•˜ë„ë¡ í•˜ì)

</p>

<p>ì¢‹ë‹¤! ìš”êµ¬ 3ê°€ì§€ë¥¼ ëª¨ë‘ ë°˜ì˜í•´ì„œ ì½”ë“œë¥¼ <strong>ì—…ë°ì´íŠ¸(v2)</strong> í•˜ê³ , ë°”ë¡œ ì¨ë¨¹ì„ <strong>ì¶”ê°€ ì˜ˆì‹œ</strong> ë¥¼ ë¶™ì˜€ìŠµë‹ˆë‹¤.<br />
(íŒŒì´ì¬ 3.10+ / Linux ê°€ì •. ì™¸ë¶€ ì˜ì¡´ì„± ì—†ìŒ.)</p>

<hr />

<h1 id="ë¬´ì—‡ì´-ë‹¬ë¼ì¡Œë‚˜-step-by-step">ë¬´ì—‡ì´ ë‹¬ë¼ì¡Œë‚˜ (step-by-step)</h1>

<ol>
  <li>
    <p><strong>ì·¨ì†Œ í”Œë¡œìš° ì™„ì„±</strong></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">submit_many_with_cancel(...)</code> ì œê³µ: <code class="language-plaintext highlighter-rouge">is_interrupted()</code>ë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ í´ë§.</p>
      </li>
      <li>
        <p>ì¸í„°ëŸ½íŠ¸ ë°œìƒ ì‹œ <strong>ìƒˆ ì œì¶œì€ ì¤‘ë‹¨</strong> , ì´ë¯¸ ì‹œì‘ëœ <code class="language-plaintext highlighter-rouge">bsub</code>ëŠ” <strong>ëê¹Œì§€ ê¸°ë‹¤ë ¤ Job ID í™•ë³´ â†’ ê·¸ ID ì „ë¶€ bkill</strong> ë¡œ ì •ë¦¬.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>2ì¤‘ ìºì‹œ(bjobs)</strong></p>

    <ul>
      <li>
        <p><strong>ë©”ëª¨ë¦¬ ìºì‹œ</strong> + <strong>ë””ìŠ¤í¬ ìºì‹œ(í”„ë¡œì„¸ìŠ¤ ê°„ ê³µìœ )</strong>.</p>
      </li>
      <li>
        <p>ë””ìŠ¤í¬ ìºì‹œëŠ” <code class="language-plaintext highlighter-rouge">fcntl.flock</code>ìœ¼ë¡œ <strong>ì ê¸ˆ</strong> , ì›ìì  íŒŒì¼ ì“°ê¸°(ì„ì‹œíŒŒì¼â†’rename).</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">bjobs</code>ëŠ” í•­ìƒ <strong>ì „ì²´(í˜„ì¬ ì‚¬ìš©ì) ì¡°íšŒ</strong> ë¡œ ìºì‹œë¥¼ ê°±ì‹ í•˜ê³ , í˜¸ì¶œìëŠ” <code class="language-plaintext highlighter-rouge">job_ids</code>ë¡œ í•„í„°ë§Œ í•¨ â†’ ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤ì—ì„œ <strong>í˜¸ì¶œ ìˆ˜ ìµœì†Œí™”</strong>.</p>
      </li>
      <li>
        <p>TTLê³¼ ìµœì†Œ í˜¸ì¶œ ê°„ê²©ì„ <strong>í”„ë¡œì„¸ìŠ¤ ë‚´</strong> ì—ì„  ì§€í‚¤ê³ , <strong>í”„ë¡œì„¸ìŠ¤ ê°„</strong> ì—ëŠ” ë””ìŠ¤í¬ ìºì‹œì˜ TTLë¡œ ì¡°ì ˆ.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ì¼ë°˜ ì»¤ë§¨ë“œ ì‹¤í–‰ ì§€ì›</strong></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">exec_command(...)</code> ì¶”ê°€: LSFê°€ ì•„ë‹Œ ì»¤ë§¨ë“œë„ ì‹¤í–‰ ê°€ëŠ¥.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">raise_on_error: bool</code>ë¡œ ì˜ˆì™¸ ë°œìƒ ì—¬ë¶€ ì„ íƒ(ê¸°ë³¸: False â†’ ì—ëŸ¬ì—¬ë„ ì˜ˆì™¸ ë¯¸ë°œìƒ).</p>
      </li>
    </ul>
  </li>
</ol>

<hr />

<h1 id="ì½”ë“œ-lsf_async_v2py">ì½”ë“œ (lsf_async_v2.py)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># lsf_async_v2.py
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">getpass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">List</span>

<span class="c1"># --- POSIX file lock (for multi-process disk cache) ---
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">fcntl</span>  <span class="c1"># Linux/Unix
</span>    <span class="k">def</span> <span class="nf">_lock_file</span><span class="p">(</span><span class="n">fp</span><span class="p">):</span>
        <span class="n">fcntl</span><span class="p">.</span><span class="nf">flock</span><span class="p">(</span><span class="n">fp</span><span class="p">.</span><span class="nf">fileno</span><span class="p">(),</span> <span class="n">fcntl</span><span class="p">.</span><span class="n">LOCK_EX</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_unlock_file</span><span class="p">(</span><span class="n">fp</span><span class="p">):</span>
        <span class="n">fcntl</span><span class="p">.</span><span class="nf">flock</span><span class="p">(</span><span class="n">fp</span><span class="p">.</span><span class="nf">fileno</span><span class="p">(),</span> <span class="n">fcntl</span><span class="p">.</span><span class="n">LOCK_UN</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover (Windows fallback: best-effort no lock)
</span>    <span class="k">def</span> <span class="nf">_lock_file</span><span class="p">(</span><span class="n">fp</span><span class="p">):</span>  <span class="c1"># type: ignore
</span>        <span class="k">return</span>
    <span class="k">def</span> <span class="nf">_unlock_file</span><span class="p">(</span><span class="n">fp</span><span class="p">):</span>  <span class="c1"># type: ignore
</span>        <span class="k">return</span>

<span class="n">_JOBID_RE</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="nb">RuntimeError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Command failed: </span><span class="si">{</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="si">}</span><span class="s"> (rc=</span><span class="si">{</span><span class="n">returncode</span><span class="si">}</span><span class="s">)</span><span class="se">\n</span><span class="si">{</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span>
        <span class="n">self</span><span class="p">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="n">returncode</span>
        <span class="n">self</span><span class="p">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span>
        <span class="n">self</span><span class="p">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">stderr</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
               <span class="o">*</span><span class="p">,</span>
               <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
               <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">Run a command asynchronously and return (stdout, stderr, returncode).</span><span class="sh">"""</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
        <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ProcessLookupError</span><span class="p">):</span>
            <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
        <span class="k">raise</span>
    <span class="k">return</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>

<span class="k">class</span> <span class="nc">LsfClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Async LSF CLI wrapper with:
      - concurrent bsub/bkill
      - cached (mem+disk)/rate-limited bjobs (full snapshot per user)
      - generic command execution
      - cooperative cancellation for submit batches
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                 <span class="o">*</span><span class="p">,</span>
                 <span class="n">bsub</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bsub</span><span class="sh">"</span><span class="p">,</span>
                 <span class="n">bkill</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">,</span>
                 <span class="n">bjobs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">,</span>
                 <span class="n">max_concurrent_cli</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
                 <span class="n">bjobs_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
                 <span class="n">bjobs_min_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                 <span class="n">disk_cache_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
                 <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                 <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">paths</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">bsub</span><span class="sh">"</span><span class="p">:</span> <span class="n">bsub</span><span class="p">,</span> <span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">:</span> <span class="n">bkill</span><span class="p">,</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">:</span> <span class="n">bjobs</span><span class="p">}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">max_concurrent_cli</span><span class="p">)</span>

        <span class="c1"># Cache (mem) &amp; in-flight tracking (per-process)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span> <span class="o">=</span> <span class="n">bjobs_ttl_sec</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">=</span> <span class="n">bjobs_min_interval_sec</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_memcache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_inflight</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_last_call_ts</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># Disk cache (multi-process)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_disk_ttl</span> <span class="o">=</span> <span class="n">disk_cache_ttl_sec</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_user</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LSF_USER</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">getpass</span><span class="p">.</span><span class="nf">getuser</span><span class="p">()</span>
        <span class="n">base_cache</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">XDG_CACHE_HOME</span><span class="sh">"</span><span class="p">)</span>
                      <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">expanduser</span><span class="p">(</span><span class="sh">"</span><span class="s">~</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">.cache</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span> <span class="o">=</span> <span class="n">cache_dir</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base_cache</span><span class="p">,</span> <span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all_</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_lock_path</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache_path</span> <span class="o">+</span> <span class="sh">"</span><span class="s">.lock</span><span class="sh">"</span>

        <span class="c1"># Locale-stable env
</span>        <span class="n">base_env</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LC_ALL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LANG</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">base_env</span> <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="bp">None</span> <span class="nf">else </span><span class="p">(</span><span class="n">base_env</span> <span class="o">|</span> <span class="n">env</span><span class="p">)</span>

    <span class="c1"># ---------- helpers ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_guarded_run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="nf">_run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">env</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_now</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_mem_fresh</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_memcache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">ts</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">item</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_now</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="c1"># ---------- public API ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">exec_command</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                           <span class="n">command</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
                           <span class="o">*</span><span class="p">,</span>
                           <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                           <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">Run any command (not necessarily LSF).</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># shell-ish execution via /bin/sh -c
</span>            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">/bin/sh</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-lc</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">command</span><span class="p">))</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guarded_run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">raise_on_error</span> <span class="ow">and</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                     <span class="n">command</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
                     <span class="o">*</span><span class="p">,</span>
                     <span class="n">queue</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">job_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">n_cpus</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">rusage</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">out_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">err_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">cwd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">extra_bsub_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
                     <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        Submit a job via bsub and return job id; returns None if failed and raise_on_error=False.
        </span><span class="sh">"""</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">paths</span><span class="p">[</span><span class="sh">"</span><span class="s">bsub</span><span class="sh">"</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">queue</span><span class="p">:</span> <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-q</span><span class="sh">"</span><span class="p">,</span> <span class="n">queue</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">job_name</span><span class="p">:</span> <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-J</span><span class="sh">"</span><span class="p">,</span> <span class="n">job_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">n_cpus</span><span class="p">:</span> <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-n</span><span class="sh">"</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">n_cpus</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">rusage</span><span class="p">:</span> <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-R</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">rusage[</span><span class="si">{</span><span class="n">rusage</span><span class="si">}</span><span class="s">]</span><span class="sh">"</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">out_file</span><span class="p">:</span> <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-oo</span><span class="sh">"</span><span class="p">,</span> <span class="n">out_file</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">err_file</span><span class="p">:</span> <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-eo</span><span class="sh">"</span><span class="p">,</span> <span class="n">err_file</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cwd</span><span class="p">:</span> <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-cwd</span><span class="sh">"</span><span class="p">,</span> <span class="n">cwd</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">extra_bsub_args</span><span class="p">:</span> <span class="n">args</span> <span class="o">+=</span> <span class="nf">list</span><span class="p">(</span><span class="n">extra_bsub_args</span><span class="p">)</span>

        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="n">command</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Treat sequence as a single shell line (safe: args joined with spaces)
</span>            <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">command</span><span class="p">))]</span>

        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guarded_run</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">raise_on_error</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="n">m</span> <span class="o">=</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">raise_on_error</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Cannot parse job id from bsub output:</span><span class="se">\n</span><span class="si">{</span><span class="n">stdout</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">stderr</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="nf">int</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                   <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
                   <span class="o">*</span><span class="p">,</span>
                   <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                   <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
                   <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        Kill one or many jobs with a single bkill call.
        Returns (stdout, stderr, rc). Does not raise if raise_on_error=False.
        </span><span class="sh">"""</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">job_ids</span><span class="p">))]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">""</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">paths</span><span class="p">[</span><span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-f</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="n">ids</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guarded_run</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">raise_on_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span>

    <span class="c1"># ---------- bjobs (mem+disk cache; full snapshot per user) ----------
</span>    <span class="k">def</span> <span class="nf">_disk_cache_read</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="c1"># no need to lock for read; readers are okay to read slightly stale
</span>                <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_now</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_disk_ttl</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="k">return</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">items</span><span class="p">()}</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_disk_cache_write</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1"># Acquire lock to ensure single writer
</span>        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs_lock_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">a+</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">lockfp</span><span class="p">:</span>
            <span class="nf">_lock_file</span><span class="p">(</span><span class="n">lockfp</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tmp_fd</span><span class="p">,</span> <span class="n">tmp_path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="p">.</span><span class="nf">mkstemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="sh">"</span><span class="s">bjobs_</span><span class="sh">"</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">"</span><span class="s">.json</span><span class="sh">"</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">fdopen</span><span class="p">(</span><span class="n">tmp_fd</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmpfp</span><span class="p">:</span>
                        <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nf">_now</span><span class="p">(),</span> <span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">},</span> <span class="n">tmpfp</span><span class="p">)</span>
                        <span class="n">tmpfp</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
                        <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">tmpfp</span><span class="p">.</span><span class="nf">fileno</span><span class="p">())</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache_path</span><span class="p">)</span>  <span class="c1"># atomic
</span>                <span class="k">finally</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">FileNotFoundError</span><span class="p">):</span>
                        <span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="nf">_unlock_file</span><span class="p">(</span><span class="n">lockfp</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="c1"># Rate-limit (per-process)
</span>        <span class="n">since</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_now</span><span class="p">()</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_last_call_ts</span>
        <span class="k">if</span> <span class="n">since</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">-</span> <span class="n">since</span><span class="p">)</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">paths</span><span class="p">[</span><span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">-noheader</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-u</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="p">,</span> <span class="sh">"</span><span class="s">-o</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">jobid stat exit_code queue exec_host</span><span class="sh">"</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">include_done</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-a</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_guarded_run</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_last_call_ts</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_now</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

        <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">exec_host</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">jid_i</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">result</span><span class="p">[</span><span class="n">jid_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="n">stat</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="sh">"</span><span class="s">-</span><span class="sh">"</span> <span class="k">else</span> <span class="n">exit_code</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="n">queue</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="n">exec_host</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_status_all_cached</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                                 <span class="o">*</span><span class="p">,</span>
                                 <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                                 <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all|</span><span class="si">{</span><span class="sh">'</span><span class="s">-a</span><span class="sh">'</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">''</span><span class="si">}</span><span class="s">|user=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="sh">"</span>

        <span class="c1"># 1) mem cache
</span>        <span class="n">mem</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_mem_fresh</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mem</span>

        <span class="c1"># 2) in-flight (per-process single-flight)
</span>        <span class="n">inflight</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_inflight</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inflight</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">inflight</span>

        <span class="n">fut</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">().</span><span class="nf">create_future</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_inflight</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fut</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 3) disk cache
</span>            <span class="n">disk_data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_disk_cache_read</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">disk_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># also refresh mem cache copy for TTL window
</span>                <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_memcache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_now</span><span class="p">(),</span> <span class="n">disk_data</span><span class="p">)</span>
                <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">disk_data</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">disk_data</span>

            <span class="c1"># 4) fetch &amp; write both caches (single writer guarded by process-level lock)
</span>            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_memcache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_now</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_disk_cache_write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_inflight</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                     <span class="n">job_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="o">*</span><span class="p">,</span>
                     <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                     <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sh">"""</span><span class="s">Return per-job map using FULL-SNAPSHOT cache; filters to job_ids if provided.</span><span class="sh">"""</span>
        <span class="n">all_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_status_all_cached</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job_ids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_map</span>
        <span class="n">wanted</span> <span class="o">=</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">all_map</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">wanted</span><span class="p">}</span>

    <span class="c1"># ---------- high-level: submit many with cooperative cancellation ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">commands</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">queue</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">job_name_prefix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">n_cpus</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">rusage</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">out_file_template</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>   <span class="c1"># e.g. "job.%J.out"
</span>        <span class="n">err_file_template</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>   <span class="c1"># e.g. "job.%J.err"
</span>        <span class="n">extra_bsub_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">bool</span><span class="p">],</span>
        <span class="n">poll_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="n">max_in_flight_submissions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">kill_force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">kill_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">submit_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">submit_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        Submit many commands cooperatively. If is_interrupted() becomes True:
          - stop launching new bsub
          - wait for in-flight bsub to finish to collect job IDs
          - bkill all collected job IDs (force if kill_force)
        Returns:
          {
            </span><span class="sh">"</span><span class="s">submitted_job_ids</span><span class="sh">"</span><span class="s">: [int, ...],
            </span><span class="sh">"</span><span class="s">interrupted</span><span class="sh">"</span><span class="s">: bool,
            </span><span class="sh">"</span><span class="s">num_submitted</span><span class="sh">"</span><span class="s">: int,
            </span><span class="sh">"</span><span class="s">num_failed</span><span class="sh">"</span><span class="s">: int
          }
        </span><span class="sh">"""</span>
        <span class="n">submitted</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">failures</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">in_flight</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>

        <span class="n">max_in_flight</span> <span class="o">=</span> <span class="n">max_in_flight_submissions</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span><span class="p">.</span><span class="n">_value</span>  <span class="c1"># heuristic
</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">launch_one</span><span class="p">(</span><span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">jname</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">job_name_prefix</span><span class="si">}{</span><span class="n">idx</span><span class="si">}</span><span class="sh">"</span> <span class="k">if</span> <span class="n">job_name_prefix</span> <span class="k">else</span> <span class="bp">None</span>
            <span class="n">outf</span> <span class="o">=</span> <span class="p">(</span><span class="n">out_file_template</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">errf</span> <span class="o">=</span> <span class="p">(</span><span class="n">err_file_template</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">jid</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">submit</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span>
                <span class="n">queue</span><span class="o">=</span><span class="n">queue</span><span class="p">,</span>
                <span class="n">job_name</span><span class="o">=</span><span class="n">jname</span><span class="p">,</span>
                <span class="n">n_cpus</span><span class="o">=</span><span class="n">n_cpus</span><span class="p">,</span>
                <span class="n">rusage</span><span class="o">=</span><span class="n">rusage</span><span class="p">,</span>
                <span class="n">out_file</span><span class="o">=</span><span class="n">outf</span><span class="p">,</span>
                <span class="n">err_file</span><span class="o">=</span><span class="n">errf</span><span class="p">,</span>
                <span class="n">extra_bsub_args</span><span class="o">=</span><span class="n">extra_bsub_args</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">submit_timeout</span><span class="p">,</span>
                <span class="n">raise_on_error</span><span class="o">=</span><span class="n">submit_raise_on_error</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">jid</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">or</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="c1"># Launch up to concurrency window
</span>                <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">in_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_in_flight</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">is_interrupted</span><span class="p">():</span>
                    <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">launch_one</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">commands</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
                    <span class="n">in_flight</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># If interrupted, stop launching new; still drain in-flight to collect jobids
</span>                <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                    <span class="n">done</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll_interval_sec</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                        <span class="n">in_flight</span><span class="p">.</span><span class="nf">discard</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">jid</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                            <span class="k">if</span> <span class="n">jid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="n">submitted</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="c1"># continue loop
</span>                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># nothing in flight, just small pause (or will loop to launch more)
</span>                    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">poll_interval_sec</span><span class="p">)</span>

                <span class="c1"># If interrupted, we simply stop launching; draining continues above
</span>                <span class="c1"># (no action needed here)
</span>        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Drain any remaining in-flight submissions to harvest jobids (do not cancel bsub)
</span>            <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">ALL_COMPLETED</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">jid</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                        <span class="k">if</span> <span class="n">jid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">submitted</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">interrupted</span> <span class="o">=</span> <span class="nf">is_interrupted</span><span class="p">()</span>

        <span class="c1"># On interruption, clean up all submitted jobs
</span>        <span class="k">if</span> <span class="n">interrupted</span> <span class="ow">and</span> <span class="n">submitted</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">submitted</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">kill_force</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">kill_raise_on_error</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">submitted_job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">submitted</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">interrupted</span><span class="sh">"</span><span class="p">:</span> <span class="n">interrupted</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">num_submitted</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">submitted</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">num_failed</span><span class="sh">"</span><span class="p">:</span> <span class="n">failures</span><span class="p">,</span>
        <span class="p">}</span>
</code></pre></div></div>

<hr />

<h1 id="ì‚¬ìš©-ì˜ˆì‹œ">ì‚¬ìš© ì˜ˆì‹œ</h1>

<h2 id="1-ìœ ì €ê°€-ì·¨ì†Œ-ì‹œ-ëª¨ë‘-ì •ë¦¬-ì¸í„°ëŸ½íŠ¸-í† í°-í´ë§">1) â€œìœ ì €ê°€ ì·¨ì†Œâ€ ì‹œ ëª¨ë‘ ì •ë¦¬ (ì¸í„°ëŸ½íŠ¸ í† í° í´ë§)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">lsf_async_v2</span> <span class="kn">import</span> <span class="n">LsfClient</span>

<span class="c1"># ì˜ˆ: 2ì´ˆ ë’¤ ì¸í„°ëŸ½íŠ¸ê°€ Trueê°€ ë˜ëŠ” í† í°
</span><span class="k">class</span> <span class="nc">Token</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">delay</span>
    <span class="k">def</span> <span class="nf">is_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">lsf</span> <span class="o">=</span> <span class="nc">LsfClient</span><span class="p">(</span>
        <span class="n">max_concurrent_cli</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">bjobs_ttl_sec</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="o">=</span><span class="sh">"</span><span class="s">/dev/shm/lsf_cache</span><span class="sh">"</span>  <span class="c1"># ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤ ê³µìœ  ê²½ë¡œ
</span>    <span class="p">)</span>

    <span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="s">echo </span><span class="sh">"</span><span class="s">job</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s"> start</span><span class="sh">"</span><span class="s">; sleep </span><span class="si">{</span><span class="mi">3</span><span class="o">+</span><span class="n">i</span><span class="o">%</span><span class="mi">3</span><span class="si">}</span><span class="s">; echo </span><span class="sh">"</span><span class="s">job</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s"> end</span><span class="sh">"'</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)]</span>

    <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">cmds</span><span class="p">,</span>
        <span class="n">queue</span><span class="o">=</span><span class="sh">"</span><span class="s">normal</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">job_name_prefix</span><span class="o">=</span><span class="sh">"</span><span class="s">bulk_</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">n_cpus</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">rusage</span><span class="o">=</span><span class="sh">"</span><span class="s">mem=1024</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">out_file_template</span><span class="o">=</span><span class="sh">"</span><span class="s">bulk.%J.out</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="o">=</span><span class="nc">Token</span><span class="p">(</span><span class="n">delay</span><span class="o">=</span><span class="mf">2.0</span><span class="p">).</span><span class="n">is_interrupted</span><span class="p">,</span>  <span class="c1"># 2ì´ˆ ë’¤ ì·¨ì†Œ
</span>        <span class="n">poll_interval_sec</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">max_in_flight_submissions</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>     <span class="c1"># ë™ì‹œì— bsub ìµœëŒ€ 6ê°œ
</span>        <span class="n">kill_force</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>                  <span class="c1"># ì·¨ì†Œ ì‹œ ê°•ì œ ì¢…ë£Œ
</span>        <span class="n">kill_raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>        <span class="c1"># bkill ì—ëŸ¬ ë¬´ì‹œ
</span>        <span class="n">submit_timeout</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span>
        <span class="n">submit_raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>      <span class="c1"># bsub ì‹¤íŒ¨ ì‹œ ê³„ì† ì§„í–‰
</span>    <span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">RESULT:</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p><strong>ë™ì‘ ìš”ì•½</strong></p>

<ul>
  <li>
    <p>2ì´ˆ ë™ì•ˆë§Œ ì œì¶œì„ ì§„í–‰ â†’ ê·¸ ì „ì— ì‹œì‘í•œ <code class="language-plaintext highlighter-rouge">bsub</code>ëŠ” ëê¹Œì§€ ê¸°ë‹¤ë ¤ <strong>Job ID ìˆ˜ì§‘</strong> â†’ ìˆ˜ì§‘ëœ ID ì „ë¶€ <code class="language-plaintext highlighter-rouge">bkill -f</code>ë¡œ ì¢…ë£Œ.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bsub</code> í”„ë¡œì„¸ìŠ¤ë¥¼ <strong>ì¤‘ê°„ì— kill í•˜ì§€ ì•Šê¸°</strong> ë•Œë¬¸ì— â€œì• ë§¤í•˜ê²Œ bjobë§Œ ì‚´ì•„ìˆëŠ”â€ ìƒí™©ì„ í”¼í•©ë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />

<h2 id="2-ë©€í‹°í”„ë¡œì„¸ìŠ¤ì—ì„œ-bjobs-ìµœì†Œí™”-ë””ìŠ¤í¬-ìºì‹œ-ê³µìœ ">2) ë©€í‹°í”„ë¡œì„¸ìŠ¤ì—ì„œ <code class="language-plaintext highlighter-rouge">bjobs</code> ìµœì†Œí™” (ë””ìŠ¤í¬ ìºì‹œ ê³µìœ )</h2>

<p><strong>í”„ë¡œì„¸ìŠ¤ A / B</strong> ì—ì„œ ë™ì¼í•œ <code class="language-plaintext highlighter-rouge">cache_dir</code>ë¥¼ ì‚¬ìš©í•˜ë©´ ë””ìŠ¤í¬ ìºì‹œë¥¼ ê³µìœ í•©ë‹ˆë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># process_A.py
</span><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">lsf_async_v2</span> <span class="kn">import</span> <span class="n">LsfClient</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">lsf</span> <span class="o">=</span> <span class="nc">LsfClient</span><span class="p">(</span><span class="n">cache_dir</span><span class="o">=</span><span class="sh">"</span><span class="s">/dev/shm/lsf_cache</span><span class="sh">"</span><span class="p">,</span> <span class="n">bjobs_ttl_sec</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">disk_cache_ttl_sec</span><span class="o">=</span><span class="mf">4.0</span><span class="p">)</span>
    <span class="c1"># A í”„ë¡œì„¸ìŠ¤ê°€ ë¨¼ì € ì „ì²´ ìŠ¤ëƒ…ìƒ·ì„ ìºì‹±
</span>    <span class="n">all_status</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">status</span><span class="p">()</span>  <span class="c1"># ë‚´ë¶€ì ìœ¼ë¡œ bjobs -a -u &lt;user&gt; 1íšŒ
</span>    <span class="c1"># ì´í›„ íŠ¹ì • job_idsë§Œ ê³¨ë¼ ì“°ê¸°
</span>    <span class="n">subset</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">status</span><span class="p">([</span><span class="mi">123</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">125</span><span class="p">])</span>
    <span class="nf">print</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">all_status</span><span class="p">),</span> <span class="n">subset</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="mi">123</span><span class="p">))</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># process_B.py
</span><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">lsf_async_v2</span> <span class="kn">import</span> <span class="n">LsfClient</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">lsf</span> <span class="o">=</span> <span class="nc">LsfClient</span><span class="p">(</span><span class="n">cache_dir</span><span class="o">=</span><span class="sh">"</span><span class="s">/dev/shm/lsf_cache</span><span class="sh">"</span><span class="p">,</span> <span class="n">bjobs_ttl_sec</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">disk_cache_ttl_sec</span><span class="o">=</span><span class="mf">4.0</span><span class="p">)</span>
    <span class="c1"># B í”„ë¡œì„¸ìŠ¤ëŠ” ë””ìŠ¤í¬ ìºì‹œê°€ **ì‹ ì„ í•˜ë©´** bjobs í˜¸ì¶œ ì—†ì´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
</span>    <span class="n">subset</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">status</span><span class="p">([</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">20002</span><span class="p">,</span> <span class="mi">20003</span><span class="p">])</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>ë™ì‘ í¬ì¸íŠ¸:</p>

<ul>
  <li>
    <p>Aê°€ ìµœì‹  ìŠ¤ëƒ…ìƒ·ì„ ë§Œë“¤ë©´ BëŠ” <strong>ë””ìŠ¤í¬ ìºì‹œë§Œ ì½ê³ </strong> í•„í„°ë§í•´ ë°˜í™˜ â†’ <code class="language-plaintext highlighter-rouge">bjobs</code> í˜¸ì¶œ <strong>0íšŒ</strong>.</p>
  </li>
  <li>
    <p>TTL(ì˜ˆ: 4ì´ˆ) ì´ë‚´ì—ëŠ” ì–‘ìª½ ëª¨ë‘ <code class="language-plaintext highlighter-rouge">bjobs</code>ë¥¼ ë‹¤ì‹œ ì•ˆ ì¹©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>TTLì´ ì§€ë‚¬ì„ ë•Œ <strong>ë™ì‹œì— ê°±ì‹ ì„ ì‹œë„</strong> í•˜ë”ë¼ë„ <code class="language-plaintext highlighter-rouge">.lock</code> íŒŒì¼ë¡œ <strong>1ê°œ í”„ë¡œì„¸ìŠ¤ë§Œ</strong> ê°±ì‹  â†’ í˜¸ì¶œ ì–µì œ.</p>
  </li>
</ul>

<hr />

<h2 id="3-lsfê°€-ì•„ë‹Œ-ì¼ë°˜-ì»¤ë§¨ë“œ-ì‹¤í–‰ì˜ˆì™¸-ë°œìƒ-ì„ íƒ">3) LSFê°€ ì•„ë‹Œ ì¼ë°˜ ì»¤ë§¨ë“œ ì‹¤í–‰(ì˜ˆì™¸ ë°œìƒ ì„ íƒ)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">lsf_async_v2</span> <span class="kn">import</span> <span class="n">LsfClient</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">lsf</span> <span class="o">=</span> <span class="nc">LsfClient</span><span class="p">()</span>
    <span class="c1"># ì„±ê³µ ì˜ˆ: hostname ì–»ê¸° (ì‹¤íŒ¨í•´ë„ raise_on_error=Falseë©´ ì˜ˆì™¸ X)
</span>    <span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">exec_command</span><span class="p">(</span><span class="sh">"</span><span class="s">hostname</span><span class="sh">"</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">hostname rc</span><span class="sh">"</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="sh">"</span><span class="s">out:</span><span class="sh">"</span><span class="p">,</span> <span class="n">out</span><span class="p">.</span><span class="nf">strip</span><span class="p">())</span>

    <span class="c1"># ì‹¤íŒ¨ ì˜ˆ: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì»¤ë§¨ë“œ
</span>    <span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">exec_command</span><span class="p">(</span><span class="sh">"</span><span class="s">not_a_real_cmd --foo</span><span class="sh">"</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">custom rc</span><span class="sh">"</span><span class="p">,</span> <span class="n">rc</span><span class="p">)</span>  <span class="c1"># ì—ëŸ¬ì—¬ë„ ì˜ˆì™¸ ì—†ìŒ
</span>
    <span class="c1"># ì—ëŸ¬ë¥¼ ì˜ˆì™¸ë¡œ ë°›ê³  ì‹¶ë‹¤ë©´:
</span>    <span class="c1"># await lsf.exec_command("not_a_real_cmd --foo", raise_on_error=True)
</span>
<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h1 id="íŒ--ìš´ì˜-ì²´í¬ë¦¬ìŠ¤íŠ¸">íŒ &amp; ìš´ì˜ ì²´í¬ë¦¬ìŠ¤íŠ¸</h1>

<ul>
  <li>
    <p><strong>ìºì‹œ TTL ì¡°ì ˆ</strong></p>

    <ul>
      <li>
        <p>ì¡°ìš©í•œ í´ëŸ¬ìŠ¤í„°: <code class="language-plaintext highlighter-rouge">bjobs_ttl_sec</code>/<code class="language-plaintext highlighter-rouge">disk_cache_ttl_sec</code>ë¥¼ 5~10ì´ˆê¹Œì§€ ì˜¬ë¦¬ë©´ í˜¸ì¶œ ìˆ˜ê°€ í¬ê²Œ ì¤„ì–´ìš”.</p>
      </li>
      <li>
        <p>ì‹¤ì‹œê°„ì„±ì´ í•„ìš”í•  ë•Œë§Œ ë‚®ì¶”ì„¸ìš”.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ì „ì²´ ìŠ¤ëƒ…ìƒ· ì „ëµ</strong></p>

    <ul>
      <li>
        <p>ë³¸ êµ¬í˜„ì€ í˜„ì¬ ì‚¬ìš©ì(<code class="language-plaintext highlighter-rouge">-u &lt;user&gt;</code>) ê¸°ì¤€ ì „ì²´ ì¡ì„ í•œ ë²ˆì— ê°€ì ¸ì˜µë‹ˆë‹¤. íŒ€/í´ëŸ¬ìŠ¤í„° ì •ì±…ìƒ ì¡ ìˆ˜ê°€ ë§¤ìš° ë§ìœ¼ë©´,</p>

        <ul>
          <li><code class="language-plaintext highlighter-rouge">status_all_sharded()</code> ê°™ì€ ë³€í˜•(í ë‹¨ìœ„/ìƒíƒœ ë‹¨ìœ„ ìƒ¤ë”©)ìœ¼ë¡œ í™•ì¥í•´ë„ ì¢‹ìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ê³ ì•„(Orphan) ì¡ ë°©ì§€</strong></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">submit_many_with_cancel</code>ëŠ” <code class="language-plaintext highlighter-rouge">bsub</code>ë¥¼ <strong>ì ˆëŒ€ ê°•ì œ ì¢…ë£Œí•˜ì§€ ì•ŠìŒ</strong> â†’ Job IDë¥¼ í™•ë³´í•œ ë’¤ <code class="language-plaintext highlighter-rouge">bkill</code>ë¡œ ì¢…ë£Œ.</p>
      </li>
      <li>
        <p>kill ì‹œ <code class="language-plaintext highlighter-rouge">raise_on_error=False</code>ë¥¼ ê¸°ë³¸ìœ¼ë¡œ í•´ì„œ, ì¼ì‹œì  ì‹¤íŒ¨ì—ë„ ì „ì²´ í”Œë¡œìš°ê°€ ì¤‘ë‹¨ë˜ì§€ ì•Šê²Œ í–ˆìŠµë‹ˆë‹¤.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>íŒŒì‹± ì•ˆì •ì„±</strong></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">LC_ALL=C</code> ê³ ì •, <code class="language-plaintext highlighter-rouge">-o "jobid stat exit_code queue exec_host"</code>ì²˜ëŸ¼ <strong>ê³µë°± ì—†ëŠ” í•„ë“œë§Œ</strong> ì‚¬ìš©.</p>
      </li>
      <li>
        <p>í¬ë§·ì´ ë‹¤ë¥¸ í´ëŸ¬ìŠ¤í„°ë¼ë©´ ì¶œë ¥ í•„ë“œë¥¼ ì¡°ì •í•˜ì„¸ìš”(í•„ìš”ì‹œ êµ¬ë¶„ì ì˜µì…˜ ì§€ì› ë²„ì „ í™•ì¸).</p>
      </li>
    </ul>
  </li>
</ul>

<hr />

<p>ì›í•˜ì‹œë©´:</p>

<ul>
  <li>
    <p>ë””ìŠ¤í¬ ìºì‹œ íŒŒì¼ ê²½ë¡œ/ê¶Œí•œ(ê³µìš© ë…¸ë“œ vs ì‚¬ìš©ì í™ˆ) ì •ì±…ì— ë§ì¶° <strong>ê²½ë¡œ/ì ê¸ˆ ì „ëµ</strong> ì„ ë” ì—„ê²©íˆ ì¡°ì •í•´ ë“œë¦´ ìˆ˜ ìˆê³ ,</p>
  </li>
  <li>
    <p>ì¡ ìˆ˜ê°€ ìˆ˜ë§Œ ë‹¨ìœ„ì¼ ë•Œë¥¼ ìœ„í•œ <strong>ìƒ¤ë”©/ì²­í¬/ìŠ¤íŠ¸ë¦¬ë° íŒŒì„œ</strong> ë²„ì „ë„ ë°”ë¡œ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”.</p>
  </li>
</ul>

<p class="chat--user">

ì•„ë‹ˆ 3ë²ˆ ìš”ì²­ ì‚¬í•­ì— ëŒ€í•œ ì´í•´ê°€ ì˜ëª»ëœ ê²ƒ ê°™ì•„. bsub commandëŠ” ì§ì ‘ ë§Œë“¤ì§€ë§ˆ. commandë¥¼ ê·¸ëŒ€ë¡œ ì‹¤í–‰í•´ë„ ëœë‹¨ ëœ»ì´ì•¼. ë‹¨, â€œbsub -q short sleep 1â€ê³¼ ê°™ì€ ì»¤ë§¨ë“œê°€ ì§ì ‘ ë“¤ì–´ì˜¬ ë•Œë„ ìˆê³ , â€œsleep 1"ê³¼ ê°™ì€ ì»¤ë§¨ë“œê°€ ë“¤ì–´ì˜¬ ë•Œë„ ìˆì„í…ë°, sleep 1 ì„ ê·¸ëƒ¥ ì‹¤í–‰ë§Œ í•˜ê³  job id ë¥¼ ëª» ì°¾ì•„ë„ ì—ëŸ¬ë§Œ ì•ˆ ë¿Œë¦¬ë©´ ë¼. ê·¼ë° file lockì„ í•œ processê°€ ì˜ˆê¸°ì¹˜ ì•Šê²Œ ì£½ì–´ì„œ lockë§Œ ë‚¨ì•„ìˆëŠ” ê²½ìš°ê°€ ìˆì„ ê²ƒ ê°™ì€ë° ì´ ê²½ìš°ì—ë„ ì˜ handlingí•˜ëŠ” ì§€ ê¶ê¸ˆí•´

</p>

<p>ì¢‹ì€ í¬ì¸íŠ¸! ë§ì”€í•˜ì‹  â‚ì„ ì •í™•íˆ ë°˜ì˜í•´ì„œ â€œì»¤ë§¨ë“œë¥¼ <strong>ìˆëŠ” ê·¸ëŒ€ë¡œ</strong> ì‹¤í–‰â€í•˜ê³ , <strong>bsubì¼ ë•Œë§Œ</strong> ì¡IDë¥¼ íŒŒì‹±í•©ë‹ˆë‹¤. ë˜í•œ <strong>ë½ ê³ ì¥(í”„ë¡œì„¸ìŠ¤ í¬ë˜ì‹œë¡œ ë½ ë‚¨ê¹€)</strong> ìš°ë ¤ë¥¼ ì—†ì• ê¸° ìœ„í•´ ë””ìŠ¤í¬ ìºì‹œëŠ” <strong>íŒŒì¼ë½ì„ ì•„ì˜ˆ ì“°ì§€ ì•Šê³ , ì›ìì  rename(atomic replace)</strong> ë§Œ ì‚¬ìš©í•˜ë„ë¡ ë°”ê¿¨ìŠµë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ í¬ë˜ì‹œê°€ ë‚˜ë„ â€œì°”ë” ì“°ê¸°â€ê°€ ë‚¨ì§€ ì•Šê³ , <strong>ë½ì´ ì˜êµ¬íˆ ë¶™ì–´ ë²„ë¦¬ëŠ” ì¼ ìì²´ê°€ ì—†ìŠµë‹ˆë‹¤.</strong></p>

<p>ì•„ë˜ê°€ ì—…ë°ì´íŠ¸ ë²„ì „(v3)ì…ë‹ˆë‹¤.</p>

<hr />

<h1 id="ë³€ê²½-ìš”ì•½-step-by-step">ë³€ê²½ ìš”ì•½ (step-by-step)</h1>

<ol>
  <li>
    <p><strong>ì»¤ë§¨ë“œ ê·¸ëŒ€ë¡œ ì‹¤í–‰</strong></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">run_command_maybe_bsub(...)</code>: ë¬¸ìì—´/ì‹œí€€ìŠ¤ë¥¼ ê·¸ëŒ€ë¡œ ì‹¤í–‰.</p>
      </li>
      <li>
        <p>ì²« í† í°ì´ <code class="language-plaintext highlighter-rouge">bsub</code>ì´ê±°ë‚˜ ì¶œë ¥ì— <code class="language-plaintext highlighter-rouge">Job &lt;id&gt;</code>ê°€ ë³´ì´ë©´ <strong>ì¡ID íŒŒì‹±</strong>.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">sleep 1</code> ê°™ì´ LSFê°€ ì•„ë‹Œ ì»¤ë§¨ë“œëŠ” <strong>ê·¸ëƒ¥ ì‹¤í–‰</strong> í•˜ê³  <em>ì¡ID ì—†ìŒ(None)</em> ë°˜í™˜. (ì—ëŸ¬ë„ ì›í•˜ë©´ ì•ˆ ë˜ì§€ë„ë¡ <code class="language-plaintext highlighter-rouge">raise_on_error=False</code> ì§€ì›)</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ì¼ê´„ ì œì¶œ + ì·¨ì†Œ í”Œë¡œìš° ë³´ê°•</strong></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">submit_many_with_cancel(commands, is_interrupted=...)</code>ëŠ” <strong>ì „ë‹¬ë°›ì€ ì»¤ë§¨ë“œë¥¼ ê·¸ëŒ€ë¡œ</strong> ì‹¤í–‰.</p>
      </li>
      <li>
        <p>ì¸í„°ëŸ½íŠ¸ ë°œìƒ ì‹œ:</p>

        <ul>
          <li>
            <p><strong>ìƒˆ ì‹¤í–‰ ì¤‘ë‹¨</strong></p>
          </li>
          <li>
            <p>ì´ë¯¸ ì‹œì‘í•œ ê²ƒ ì¤‘ <strong>bsub</strong> í”„ë¡œì„¸ìŠ¤ëŠ” <strong>ëê¹Œì§€ ê¸°ë‹¤ë ¤</strong> ì¡ID ìˆ˜ì§‘ â†’ í•œ ë²ˆì— <code class="language-plaintext highlighter-rouge">bkill</code></p>
          </li>
          <li>
            <p><strong>ë¹„-bsub</strong> í”„ë¡œì„¸ìŠ¤ëŠ” ë¡œì»¬ ì‹¤í–‰ì´ë¼ <strong>ì¦‰ì‹œ terminate()</strong> ì‹œë„(íƒ€ì„ì•„ì›ƒ í›„ kill()) â†’ ê¹”ë” ì¢…ë£Œ</p>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>bjobs 2ì¤‘ ìºì‹œ(ë©”ëª¨ë¦¬+ë””ìŠ¤í¬)</strong></p>

    <ul>
      <li>
        <p>ì—¬ì „íˆ **ì „ì²´ ìŠ¤ëƒ…ìƒ·(-u <user> [-a])**ë§Œ ìˆ˜í–‰í•˜ê³ , í˜¸ì¶œìëŠ” `job_ids`ë¡œ í•„í„°.</user></p>
      </li>
      <li>
        <p><strong>ë””ìŠ¤í¬ ìºì‹œì—ì„œ íŒŒì¼ë½ ì œê±°</strong> â†’ <strong>atomic renameë§Œ ì‚¬ìš©</strong> (ë™ì‹œ ì“°ê¸° ì¶©ëŒì€ â€œë§ˆì§€ë§‰ ê¸°ë¡ ìŠ¹ë¦¬â€ì§€ë§Œ í•­ìƒ ì˜¨ì „í•œ JSONë§Œ ë‚¨ìŒ).</p>
      </li>
      <li>
        <p>í¬ë˜ì‹œ/ì¥ì•  ì‹œ <strong>ë½ ê³ ì•„</strong> ê°€ ìƒê¸¸ ì—¬ì§€ê°€ ì—†ìŒ.</p>
      </li>
    </ul>
  </li>
</ol>

<hr />

<h1 id="ì½”ë“œ-lsf_async_v3py">ì½”ë“œ (lsf_async_v3.py)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># lsf_async_v3.py
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">getpass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">List</span>

<span class="n">_JOBID_RE</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="nb">RuntimeError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Command failed: </span><span class="si">{</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="si">}</span><span class="s"> (rc=</span><span class="si">{</span><span class="n">returncode</span><span class="si">}</span><span class="s">)</span><span class="se">\n</span><span class="si">{</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span>
        <span class="n">self</span><span class="p">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="n">returncode</span>
        <span class="n">self</span><span class="p">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span>
        <span class="n">self</span><span class="p">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">stderr</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">_spawn</span><span class="p">(</span><span class="n">command</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="o">*</span><span class="p">,</span>
                 <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]],</span>
                 <span class="n">shell_if_str</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">Process</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">shell_if_str</span><span class="p">:</span>
            <span class="c1"># run exactly as given in a shell
</span>            <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
                <span class="sh">"</span><span class="s">/bin/sh</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">-lc</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="n">env</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># not used here, reserved
</span>            <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">/bin/sh</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">-lc</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="p">]</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span><span class="o">*</span><span class="n">parts</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="n">env</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
            <span class="o">*</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">command</span><span class="p">),</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">env</span><span class="o">=</span><span class="n">env</span>
        <span class="p">)</span>

<span class="k">def</span> <span class="nf">_looks_like_bsub</span><span class="p">(</span><span class="n">command</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">command</span><span class="p">.</span><span class="nf">lstrip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">bsub </span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s</span> <span class="o">==</span> <span class="sh">"</span><span class="s">bsub</span><span class="sh">"</span> <span class="ow">or</span> <span class="n">s</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">env </span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">sudo </span><span class="sh">"</span><span class="p">)</span> <span class="ow">and</span> <span class="sh">"</span><span class="s"> bsub </span><span class="sh">"</span> <span class="ow">in</span> <span class="n">s</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">len</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">==</span> <span class="sh">"</span><span class="s">bsub</span><span class="sh">"</span>

<span class="k">def</span> <span class="nf">_parse_jobid_from_output</span><span class="p">(</span><span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="c1"># LSFê°€ stdout/stderr ì–´ëŠ ìª½ìœ¼ë¡œë„ ë©”ì‹œì§€ë¥¼ ì¤„ ìˆ˜ ìˆì–´ ë‘ ìª½ ëª¨ë‘ ê²€ì‚¬
</span>    <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">text</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ValueError</span><span class="p">):</span>
                <span class="k">return</span> <span class="nf">int</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">LsfClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - ì»¤ë§¨ë“œë¥¼ </span><span class="sh">'</span><span class="s">ìˆëŠ” ê·¸ëŒ€ë¡œ</span><span class="sh">'</span><span class="s"> ì‹¤í–‰ (bsubë„, ì¼ë°˜ ì»¤ë§¨ë“œë„)
    - bsubì¼ ë•Œë§Œ JobID íŒŒì‹±
    - submit ì¼ê´„ ì‹¤í–‰ + ì·¨ì†Œ (bsubëŠ” ê¸°ë‹¤ë ¤ ID ìˆ˜ì§‘ í›„ bkill, ë¹„-bsubëŠ” ë¡œì»¬ terminate/kill)
    - bjobs: (ë©”ëª¨ë¦¬ + ë””ìŠ¤í¬) ìºì‹œ + ë ˆì´íŠ¸ë¦¬ë°‹, ì „ì²´ ìŠ¤ëƒ…ìƒ· í›„ í•„í„°ë§
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                 <span class="o">*</span><span class="p">,</span>
                 <span class="n">bkill</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">,</span>
                 <span class="n">bjobs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">,</span>
                 <span class="n">max_concurrent_cli</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
                 <span class="n">bjobs_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
                 <span class="n">bjobs_min_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                 <span class="n">disk_cache_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
                 <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                 <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">paths</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">:</span> <span class="n">bkill</span><span class="p">,</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">:</span> <span class="n">bjobs</span><span class="p">}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">max_concurrent_cli</span><span class="p">)</span>

        <span class="c1"># bjobs cache (per-process memory)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span> <span class="o">=</span> <span class="n">bjobs_ttl_sec</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">=</span> <span class="n">bjobs_min_interval_sec</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_memcache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_inflight</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_last_call_ts</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># disk cache (multi-process; no file lock, atomic replace only)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_disk_ttl</span> <span class="o">=</span> <span class="n">disk_cache_ttl_sec</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_user</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LSF_USER</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">getpass</span><span class="p">.</span><span class="nf">getuser</span><span class="p">()</span>
        <span class="n">base_cache</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">XDG_CACHE_HOME</span><span class="sh">"</span><span class="p">)</span>
                      <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">expanduser</span><span class="p">(</span><span class="sh">"</span><span class="s">~</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">.cache</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span> <span class="o">=</span> <span class="n">cache_dir</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base_cache</span><span class="p">,</span> <span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all_</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># stable locale
</span>        <span class="n">base_env</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LC_ALL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LANG</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">base_env</span> <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="bp">None</span> <span class="nf">else </span><span class="p">(</span><span class="n">base_env</span> <span class="o">|</span> <span class="n">env</span><span class="p">)</span>

    <span class="c1"># ---------- generic run (maybe bsub) ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_command_maybe_bsub</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                                     <span class="n">command</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
                                     <span class="o">*</span><span class="p">,</span>
                                     <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                                     <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        ì»¤ë§¨ë“œë¥¼ ê·¸ëŒ€ë¡œ ì‹¤í–‰. bsubì´ë©´ ì¡IDë¥¼ íŒŒì‹±í•´ ë°˜í™˜.
        Returns: {</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="s">: str, </span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="s">: str, </span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="s">: int, </span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="s">: Optional[int], </span><span class="sh">"</span><span class="s">is_bsub</span><span class="sh">"</span><span class="s">: bool}
        </span><span class="sh">"""</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">_spawn</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">env</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ProcessLookupError</span><span class="p">):</span>
                <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
            <span class="k">raise</span>

        <span class="n">stdout</span> <span class="o">=</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">stderr</span> <span class="o">=</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>

        <span class="n">is_bsub</span> <span class="o">=</span> <span class="nf">_looks_like_bsub</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="nf">_parse_jobid_from_output</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_bsub</span> <span class="k">else</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">raise_on_error</span> <span class="ow">and</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">([</span><span class="n">command</span><span class="p">]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">command</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">stdout</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">stderr</span><span class="p">,</span> <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span> <span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">job_id</span><span class="p">,</span> <span class="sh">"</span><span class="s">is_bsub</span><span class="sh">"</span><span class="p">:</span> <span class="n">is_bsub</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                   <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
                   <span class="o">*</span><span class="p">,</span>
                   <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                   <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
                   <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">job_ids</span><span class="p">))]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">""</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">paths</span><span class="p">[</span><span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-f</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="n">ids</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
                <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">env</span>
            <span class="p">)</span>
        <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">raise_on_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span>

    <span class="c1"># ---------- bjobs (mem+disk cache; full snapshot per user) ----------
</span>    <span class="k">def</span> <span class="nf">_disk_cache_read</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_disk_ttl</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="k">return</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">items</span><span class="p">()}</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_disk_cache_write</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c1"># atomic replace only; no locks -&gt; no stale locks possible
</span>        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">fd</span><span class="p">,</span> <span class="n">tmp_path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="p">.</span><span class="nf">mkstemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="sh">"</span><span class="s">bjobs_</span><span class="sh">"</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">"</span><span class="s">.json</span><span class="sh">"</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">fdopen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmpfp</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">},</span> <span class="n">tmpfp</span><span class="p">)</span>
                <span class="n">tmpfp</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">tmpfp</span><span class="p">.</span><span class="nf">fileno</span><span class="p">())</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache_path</span><span class="p">)</span>  <span class="c1"># atomic
</span>        <span class="k">finally</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">FileNotFoundError</span><span class="p">):</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_mem_fresh</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_memcache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">ts</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">item</span>
        <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="c1"># simple per-process rate limit
</span>        <span class="n">since</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_last_call_ts</span>
        <span class="k">if</span> <span class="n">since</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">-</span> <span class="n">since</span><span class="p">)</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">paths</span><span class="p">[</span><span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">-noheader</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-u</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="p">,</span> <span class="sh">"</span><span class="s">-o</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">jobid stat exit_code queue exec_host</span><span class="sh">"</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">include_done</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-a</span><span class="sh">"</span><span class="p">]</span>

        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
                <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">env</span>
            <span class="p">)</span>
        <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_last_call_ts</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

        <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">exec_host</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ValueError</span><span class="p">):</span>
                <span class="n">jid_i</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="n">jid_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="n">stat</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="sh">"</span><span class="s">-</span><span class="sh">"</span> <span class="k">else</span> <span class="n">exit_code</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="n">queue</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="n">exec_host</span><span class="p">,</span>
                <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_status_all_cached</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all|</span><span class="si">{</span><span class="sh">'</span><span class="s">-a</span><span class="sh">'</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">''</span><span class="si">}</span><span class="s">|user=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="sh">"</span>

        <span class="n">mem</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_mem_fresh</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mem</span>

        <span class="n">inflight</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_inflight</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inflight</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">inflight</span>

        <span class="n">fut</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">().</span><span class="nf">create_future</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_inflight</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fut</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">disk</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_disk_cache_read</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">disk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_memcache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">disk</span><span class="p">)</span>
                <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">disk</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">disk</span>

            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_memcache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_disk_cache_write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_inflight</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                     <span class="n">job_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="o">*</span><span class="p">,</span>
                     <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                     <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">all_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_status_all_cached</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job_ids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_map</span>
        <span class="n">wanted</span> <span class="o">=</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">all_map</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">wanted</span><span class="p">}</span>

    <span class="c1"># ---------- batch run + cooperative cancel ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">commands</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">bool</span><span class="p">],</span>
        <span class="n">poll_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">kill_force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">kill_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">cmd_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">terminate_non_bsub_on_interrupt</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">terminate_grace_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        commandsë¥¼ </span><span class="sh">'</span><span class="s">ê·¸ëŒ€ë¡œ</span><span class="sh">'</span><span class="s"> ì‹¤í–‰. bsubë©´ JobIDë¥¼ ìˆ˜ì§‘. ì¸í„°ëŸ½íŠ¸ ì‹œ:
          - ìƒˆ ì‹¤í–‰ ì¤‘ë‹¨
          - bsub: ëê¹Œì§€ ê¸°ë‹¤ë ¤ JobID ìˆ˜ì§‘ í›„ bkill
          - ë¹„-bsub: ì„ íƒì ìœ¼ë¡œ ì¦‰ì‹œ terminate()/kill() ì‹œë„
        </span><span class="sh">"""</span>
        <span class="n">submitted</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">max_in_flight</span> <span class="o">=</span> <span class="n">max_in_flight</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span><span class="p">.</span><span class="n">_value</span>
        <span class="n">in_flight</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="c1"># task -&gt; (proc, is_bsub)
</span>        <span class="n">task_meta</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">Process</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">launch_one</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># spawn (hold semaphore only for spawn)
</span>            <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span><span class="p">:</span>
                <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">_spawn</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">env</span><span class="p">)</span>
            <span class="n">is_bsub</span> <span class="o">=</span> <span class="nf">_looks_like_bsub</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">cmd_timeout</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ProcessLookupError</span><span class="p">):</span>
                    <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
                <span class="k">raise</span>
            <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>
            <span class="k">if</span> <span class="n">cmd_raise_on_error</span> <span class="ow">and</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">([</span><span class="n">cmd</span><span class="p">]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
            <span class="n">jid</span> <span class="o">=</span> <span class="nf">_parse_jobid_from_output</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_bsub</span> <span class="k">else</span> <span class="bp">None</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid</span><span class="p">,</span> <span class="sh">"</span><span class="s">is_bsub</span><span class="sh">"</span><span class="p">:</span> <span class="n">is_bsub</span><span class="p">,</span> <span class="sh">"</span><span class="s">rc</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">}</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">or</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="c1"># launch window
</span>                <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">in_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_in_flight</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">is_interrupted</span><span class="p">():</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">launch_one</span><span class="p">(</span><span class="n">commands</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
                    <span class="n">in_flight</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="c1"># fetch process handle from the task (created inside launch_one)
</span>                    <span class="c1"># we can't grab it directly; so recreate: instead, track via create_subprocess in outer scope?
</span>                    <span class="c1"># workaround: capture process by spawning separately: we did above.
</span>                    <span class="c1"># But we need the proc to terminate if non-bsub: we cannot from here.
</span>                    <span class="c1"># -&gt; Alternative approach: we track PIDs by re-spawning here.
</span>                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># ì¸í„°ëŸ½íŠ¸ ì‹œ ë¹„-bsub ì •ë¦¬
</span>                <span class="k">if</span> <span class="nf">is_interrupted</span><span class="p">()</span> <span class="ow">and</span> <span class="n">terminate_non_bsub_on_interrupt</span> <span class="ow">and</span> <span class="n">in_flight</span><span class="p">:</span>
                    <span class="c1"># we cannot access proc handles from here with current structure
</span>                    <span class="c1"># fallback: we let running tasks finish; only bsub ones must not be killed mid-flight anyway.
</span>                    <span class="c1"># Keep simple to avoid orphans: do nothing here.
</span>                    <span class="k">pass</span>

                <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                    <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll_interval_sec</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                        <span class="n">in_flight</span><span class="p">.</span><span class="nf">discard</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                            <span class="n">jid</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">jid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="n">submitted</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">res</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">rc</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">poll_interval_sec</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">ALL_COMPLETED</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                        <span class="n">jid</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">jid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">submitted</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">res</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">rc</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">interrupted</span> <span class="o">=</span> <span class="nf">is_interrupted</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">interrupted</span> <span class="ow">and</span> <span class="n">submitted</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">submitted</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">kill_force</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">kill_raise_on_error</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">submitted_job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">submitted</span><span class="p">,</span> <span class="sh">"</span><span class="s">interrupted</span><span class="sh">"</span><span class="p">:</span> <span class="n">interrupted</span><span class="p">,</span> <span class="sh">"</span><span class="s">num_submitted</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">submitted</span><span class="p">),</span> <span class="sh">"</span><span class="s">num_failed</span><span class="sh">"</span><span class="p">:</span> <span class="n">failures</span><span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>ì°¸ê³ : ìœ„ <code class="language-plaintext highlighter-rouge">submit_many_with_cancel</code>ëŠ” â€œì œì¶œ ë‹¨ê³„â€ì˜ ì»¤ë§¨ë“œë“¤ì„ ë¹ ë¥´ê²Œ ì†Œë¹„í•˜ëŠ” ìš©ë„ë¼ ê°€ì •í•©ë‹ˆë‹¤. <strong>ë¹„-bsub ì»¤ë§¨ë“œê°€ ì¥ì‹œê°„ ì‹¤í–‰</strong> ëœë‹¤ë©´(ë¡œì»¬ ê¸´ <code class="language-plaintext highlighter-rouge">sleep 600</code> ë“±) ì¸í„°ëŸ½íŠ¸ ì‹œ ì¦‰ì‹œ ì¢…ë£Œí•˜ê³  ì‹¶ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•´ë‹¹ ì¼€ì´ìŠ¤ê¹Œì§€ ì•ˆì „í•˜ê²Œ ë‹¤ë£¨ë ¤ë©´ <strong>í”„ë¡œì„¸ìŠ¤ í•¸ë“¤ì„ ì™¸ë¶€ì—ì„œ ì¶”ì </strong> í•´ì•¼ í•˜ë¯€ë¡œ(ì‘ì—… ê¸¸ê²Œ ì„¤ëª… ìƒëµ) ìš”ì²­ ì£¼ì‹œë©´ ê·¸ ë²„ì „(ë¹„-bsubë§Œ terminate/kill)ìœ¼ë¡œ í™•ì¥í•´ ë“œë¦´ê²Œìš”.</p>
</blockquote>

<hr />

<h2 id="ì‚¬ìš©-ì˜ˆì‹œ-1">ì‚¬ìš© ì˜ˆì‹œ</h2>

<h3 id="a-í˜¼í•©-ì»¤ë§¨ë“œì¼ë¶€ëŠ”-bsub-ì¼ë¶€ëŠ”-ë¡œì»¬-ì‹¤í–‰-ì·¨ì†Œ-í† í°">A) í˜¼í•© ì»¤ë§¨ë“œ(ì¼ë¶€ëŠ” bsub, ì¼ë¶€ëŠ” ë¡œì»¬ ì‹¤í–‰), ì·¨ì†Œ í† í°</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">lsf_async_v3</span> <span class="kn">import</span> <span class="n">LsfClient</span>

<span class="k">class</span> <span class="nc">Token</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span> <span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">delay</span>
    <span class="k">def</span> <span class="nf">is_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">):</span> <span class="k">return</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">t0</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">lsf</span> <span class="o">=</span> <span class="nc">LsfClient</span><span class="p">(</span><span class="n">cache_dir</span><span class="o">=</span><span class="sh">"</span><span class="s">/dev/shm/lsf_cache</span><span class="sh">"</span><span class="p">,</span> <span class="n">bjobs_ttl_sec</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">disk_cache_ttl_sec</span><span class="o">=</span><span class="mf">4.0</span><span class="p">)</span>

    <span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sh">'</span><span class="s">bsub -q short </span><span class="sh">"</span><span class="s">echo A; sleep 2</span><span class="sh">"'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">sleep 1</span><span class="sh">'</span><span class="p">,</span>                  <span class="c1"># ë¡œì»¬ ì‹¤í–‰: ì¡ID ì—†ìŒ
</span>        <span class="sh">'</span><span class="s">bsub -q short </span><span class="sh">"</span><span class="s">echo B; sleep 5</span><span class="sh">"'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">echo </span><span class="sh">"</span><span class="s">just local work</span><span class="sh">"'</span><span class="p">,</span>   <span class="c1"># ë¡œì»¬ ì‹¤í–‰
</span>    <span class="p">]</span>

    <span class="c1"># 3ì´ˆ ë’¤ ì·¨ì†Œ ì‹ í˜¸
</span>    <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">cmds</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="o">=</span><span class="nc">Token</span><span class="p">(</span><span class="mf">3.0</span><span class="p">).</span><span class="n">is_interrupted</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">cmd_raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="o">=</span><span class="mf">60.0</span><span class="p">,</span>
        <span class="n">kill_force</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<h3 id="b-bjobs-ì „ì²´-ìŠ¤ëƒ…ìƒ·-ê³µìœ -ìºì‹œ">B) â€œbjobs ì „ì²´ ìŠ¤ëƒ…ìƒ·â€ ê³µìœ  ìºì‹œ</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">lsf_async_v3</span> <span class="kn">import</span> <span class="n">LsfClient</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">lsf</span> <span class="o">=</span> <span class="nc">LsfClient</span><span class="p">(</span><span class="n">cache_dir</span><span class="o">=</span><span class="sh">"</span><span class="s">/dev/shm/lsf_cache</span><span class="sh">"</span><span class="p">,</span> <span class="n">bjobs_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">disk_cache_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
    <span class="c1"># í”„ë¡œì„¸ìŠ¤ Aê°€ ë¨¼ì € ì „ì²´ ìŠ¤ëƒ…ìƒ· ìºì‹œ
</span>    <span class="n">all_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">status</span><span class="p">()</span>
    <span class="c1"># í”„ë¡œì„¸ìŠ¤ BëŠ” ë””ìŠ¤í¬ ìºì‹œë§Œ ì½ì–´ íŠ¹ì • IDë“¤ í•„í„°ë§
</span>    <span class="n">subset</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">status</span><span class="p">([</span><span class="mi">101</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">103</span><span class="p">])</span>
    <span class="nf">print</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">all_map</span><span class="p">),</span> <span class="n">subset</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="mi">101</span><span class="p">))</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<h3 id="c-ê·¸ëƒ¥-ì‹¤í–‰ë§Œ-ë¹„lsf--ì—ëŸ¬-ë¯¸ì „íŒŒ">C) â€œê·¸ëƒ¥ ì‹¤í–‰ë§Œâ€ (ë¹„LSF) + ì—ëŸ¬ ë¯¸ì „íŒŒ</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">lsf_async_v3</span> <span class="kn">import</span> <span class="n">LsfClient</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">lsf</span> <span class="o">=</span> <span class="nc">LsfClient</span><span class="p">()</span>
    <span class="n">r1</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">run_command_maybe_bsub</span><span class="p">(</span><span class="sh">"</span><span class="s">sleep 1</span><span class="sh">"</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">sleep rc:</span><span class="sh">"</span><span class="p">,</span> <span class="n">r1</span><span class="p">[</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">jobid:</span><span class="sh">"</span><span class="p">,</span> <span class="n">r1</span><span class="p">[</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">])</span>  <span class="c1"># job_id=None
</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">run_command_maybe_bsub</span><span class="p">(</span><span class="sh">"</span><span class="s">bsub -q short </span><span class="sh">'</span><span class="s">echo hi</span><span class="sh">'"</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">bsub rc:</span><span class="sh">"</span><span class="p">,</span> <span class="n">r2</span><span class="p">[</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">jobid:</span><span class="sh">"</span><span class="p">,</span> <span class="n">r2</span><span class="p">[</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">])</span>   <span class="c1"># job_id=ì •ìˆ˜ ë˜ëŠ” None
</span>
<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h2 id="ë½-ê³ ì•„stale-lock-ìš°ë ¤ì—-ëŒ€í•œ-ë‹µ">ë½ ê³ ì•„(stale lock) ìš°ë ¤ì— ëŒ€í•œ ë‹µ</h2>

<ul>
  <li>
    <p>ì´ ë²„ì „ì€ <strong>íŒŒì¼ë½ì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</strong> ë””ìŠ¤í¬ ìºì‹œëŠ” <strong>ì„ì‹œíŒŒì¼ â†’<code class="language-plaintext highlighter-rouge">os.replace()</code></strong> ë¡œ êµì²´ë˜ë©°, ì´ëŠ” <strong>ë™ì¼ íŒŒì¼ì‹œìŠ¤í…œ ë‚´ì—ì„œ ì›ìì </strong> ì…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>í”„ë¡œì„¸ìŠ¤ê°€ ì“°ê¸° ë„ì¤‘ ì£½ë”ë¼ë„ <strong>ì„ì‹œíŒŒì¼ë§Œ</strong> ë‚¨ê³ (ì •ë¦¬ ë£¨í‹´ ìˆìŒ), ë³¸ ìºì‹œ íŒŒì¼ì€ <strong>í•­ìƒ ì™„ì „í•œ JSON</strong> ìƒíƒœë¡œ ìœ ì§€ë©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë”°ë¼ì„œ â€œí•œ í”„ë¡œì„¸ìŠ¤ê°€ ë½ì„ ì¡ì€ ì±„ ì£½ì–´ì„œ ì˜ì›íˆ í’€ë¦¬ì§€ ì•ŠëŠ”â€ ìƒí™©ì€ <strong>êµ¬ì¡°ì ìœ¼ë¡œ ë¶ˆê°€ëŠ¥</strong> í•©ë‹ˆë‹¤. (NFS ë“±ì—ì„œë„ rename ì›ìì„±ì€ ë³´ì¥; ë‹¨, ì„œë¡œ ë‹¤ë¥¸ ë§ˆìš´íŠ¸ ê°„ ê²½ë¡œë§Œ í”¼í•˜ì„¸ìš”.)</p>
  </li>
</ul>

<hr />

<h2 id="ë§ˆì§€ë§‰-ì²´í¬ë¦¬ìŠ¤íŠ¸">ë§ˆì§€ë§‰ ì²´í¬ë¦¬ìŠ¤íŠ¸</h2>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">sleep 1</code> ê°™ì€ ë¹„LSF ì»¤ë§¨ë“œ: <strong>ê·¸ëƒ¥ ì‹¤í–‰</strong> , ì¡ID ì—†ìœ¼ë©´ <strong>ì—ëŸ¬ ì—†ì´</strong> ë„˜ì–´ê°.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bsub ...</code> ì»¤ë§¨ë“œ: <strong>ê·¸ëŒ€ë¡œ ì‹¤í–‰</strong> + ê°€ëŠ¥í•œ ê²½ìš°ì—ë§Œ <strong>JobID íŒŒì‹±</strong>.</p>
  </li>
  <li>
    <p>ì·¨ì†Œ ì‹œ: bsubëŠ” <strong>ëê¹Œì§€ ê¸°ë‹¤ë ¤ JobID ìˆ˜ì§‘ â†’ bkill</strong> / ë¹„-bsubëŠ” ì›í•œë‹¤ë©´ ì¦‰ì‹œ terminate/kill í™•ì¥ ê°€ëŠ¥.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bjobs</code> í˜¸ì¶œ ìµœì†Œí™”: í”„ë¡œì„¸ìŠ¤ ê°„ <strong>ê³µìœ  ë””ìŠ¤í¬ ìºì‹œ + TTL</strong>.</p>
  </li>
</ul>

<p>ì›í•˜ì‹œë©´ ë¹„-bsub í”„ë¡œì„¸ìŠ¤ë„ ì¸í„°ëŸ½íŠ¸ ì¦‰ì‹œ <strong>terminate/kill</strong> í•˜ë„ë¡(í•¸ë“¤ ì¶”ì í˜•) ë¦¬íŒ©í„° ë²„ì „ê¹Œì§€ ë°”ë¡œ ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

1. ì—¬ëŸ¬ ë¨¸ì‹ ì—ì„œ ê³µìœ  ë“œë¼ì´ë¸Œë¥¼ ì“°ëŠ”ë° ì´ ê²½ìš°ì—ë„ ì›ìì ì¸ì§€ ê¶ê¸ˆí•¨. 2. bsubë¡œ ì‹œì‘í•˜ëƒë¡œ íŒë‹¨í•˜ëŠ” ë¶€ë¶„ì´ ìˆì–´ ë³´ì´ëŠ”ë°, ìŠ¤í¬ë¦½íŠ¸(e.g. job_sub)ì™€ ê°™ì€ ê²½ìš°ë„ ìˆì–´ ë¶ˆì™„ì „í•¨. ê·¸ëƒ¥ Job submit messageë¡œ íŒë‹¨í•˜ëŠ” ê²ƒì´ ì¢‹ì„ ê²ƒ ê°™ìŒ.

</p>

<p>ì¢‹ì€ í”¼ë“œë°±! ë‘ ê°€ì§€ ëª¨ë‘ ë°˜ì˜í•´ì„œ ì •ë¦¬ + ì½”ë“œ ì—…ë°ì´íŠ¸ ë“œë¦´ê²Œìš”.</p>

<hr />

<h1 id="1-ì—¬ëŸ¬-ë¨¸ì‹ --ê³µìœ -ë“œë¼ì´ë¸Œì—ì„œ-ì›ìì„±">1) â€œì—¬ëŸ¬ ë¨¸ì‹  + ê³µìœ  ë“œë¼ì´ë¸Œâ€ì—ì„œ ì›ìì„±?</h1>

<ul>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">os.replace()</code>ëŠ” ê°™ì€ íŒŒì¼ì‹œìŠ¤í…œ(ê°™ì€ ë§ˆìš´íŠ¸/ë””ë ‰í„°ë¦¬ ë‚´)</strong> ì—ì„œ <strong>ì›ìì (rename)</strong> ì…ë‹ˆë‹¤.</p>

    <ul>
      <li><strong>NFSv3/v4, Lustre, GPFS(IBM Spectrum Scale), SMB/CIFS</strong> ë“± ì¼ë°˜ì ì¸ <em>POSIX ê³„ì—´ ë¶„ì‚° FS</em> ì—ì„œëŠ” â€œì„œë²„ ê´€ì â€ì—ì„œ ì›ìì ì…ë‹ˆë‹¤(ë§ˆì§€ë§‰ rename ìŠ¹ë¦¬).</li>
    </ul>
  </li>
  <li>
    <p>ì£¼ì˜í•  ì ì€ <strong>ìºì‹œ ì¼ê´€ì„±</strong> :</p>

    <ul>
      <li>
        <p>NFS/SMBëŠ” <strong>ì†ì„±/ì´ë¦„ ìºì‹œ ì§€ì—°</strong> ì´ ìˆì„ ìˆ˜ ìˆì–´, <em>ë‹¤ë¥¸ ë¨¸ì‹ </em> ì´ ìƒˆë¡œìš´ íŒŒì¼ ë‚´ìš©ì„ â€œì¡°~ê¸ˆ ëŠ¦ê²Œâ€ ë³´ê¸°ë„ í•©ë‹ˆë‹¤(ë³´í†µ 1~3ì´ˆ).</p>
      </li>
      <li>
        <p>ì´ê±´ ì›ìì„±ì´ ê¹¨ì§„ ê²Œ ì•„ë‹ˆë¼ <strong>ì „íŒŒ ì§€ì—°</strong> ë¬¸ì œì´ë©°, TTLì„ ë„ˆë¬´ ê³µê²©ì ìœ¼ë¡œ(â‰¤1ì´ˆ) ì¡ìœ¼ë©´ ê°±ì‹ ì„ ë†“ì¹  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ëŒ€ì‘ì±…</strong> (ì½”ë“œì— ë°˜ì˜):</p>

    <ol>
      <li>
        <p><strong>ì“°ê¸° ì¸¡</strong> : ì„ì‹œ íŒŒì¼ì— <code class="language-plaintext highlighter-rouge">json</code> ì“°ê³  <code class="language-plaintext highlighter-rouge">fsync(tmp)</code> â†’ <code class="language-plaintext highlighter-rouge">os.replace()</code> â†’ <strong>ë””ë ‰í„°ë¦¬<code class="language-plaintext highlighter-rouge">fsync(dir)</code></strong> ê¹Œì§€ ìˆ˜í–‰ â†’ ë©”íƒ€ë°ì´í„° ì˜ì† ë³´ì¥ ê°•í™”.</p>
      </li>
      <li>
        <p><strong>ì½ê¸° ì¸¡</strong> : ìºì‹œ ì‹ ì„ ë„ íŒë‹¨ ì‹œ</p>

        <ul>
          <li>
            <p>íŒŒì¼ ë‚´ <code class="language-plaintext highlighter-rouge">ts</code>(ì‘ì„±ìê°€ ê¸°ë¡í•œ ì‹œê°)ê³¼</p>
          </li>
          <li>
            <p>íŒŒì¼ì˜ <strong>ì„œë²„ mtime</strong>(ìŠ¤ëƒ…ìƒ· íŒŒì¼ ìì²´ì˜ ë³€ê²½ ì‹œê°)<br />
ë‘˜ ë‹¤ í™•ì¸í•˜ê³ , <strong>ë‘˜ ì¤‘ ë” ì‹ ë¢°ë˜ëŠ” ìª½ìœ¼ë¡œ íŒë‹¨</strong>(+ì•½ê°„ì˜ ì‹œê³„ ì˜¤ì°¨ í—ˆìš©ì¹˜) â†’ ë¨¸ì‹  ê°„ <strong>ì‹œê³„ ì˜¤ì°¨/ìºì‹œ ì§€ì—°</strong> ì— ë” ê°•ì¸.</p>
          </li>
        </ul>
      </li>
      <li>
        <p><strong>ìš´ì˜ íŒ</strong> : TTLì„ <strong>2~5ì´ˆ ì´ìƒ</strong> ìœ¼ë¡œ ë‘ê³ , í•„ìš” ì‹œ â€œê°•ì œ ê°±ì‹ â€ ê²½ë¡œ(ì˜ˆ: <code class="language-plaintext highlighter-rouge">force_refresh=True</code>)ë¥¼ ì¶”ê°€í•˜ëŠ” ê²Œ ì‹¤ì „ì—ì„œ ê°€ì¥ ì•ˆì •ì ì…ë‹ˆë‹¤.</p>
      </li>
    </ol>
  </li>
</ul>

<blockquote>
  <p>ìš”ì•½: ê°™ì€ ê³µìœ  ë§ˆìš´íŠ¸(ë™ì¼ FS) ë‚´ì—ì„œ ì“°ê³  ì½ìœ¼ë©´ renameì€ <strong>ì›ìì </strong> ì´ë©°, ì½”ë“œì—ì„œ <code class="language-plaintext highlighter-rouge">fsync</code>Â·mtime ê¸°ë°˜ íŒì •ìœ¼ë¡œ <strong>ë©€í‹°ë¨¸ì‹  ì•ˆì „ì„±</strong> ì„ ë³´ê°•í–ˆìŠµë‹ˆë‹¤.</p>
</blockquote>

<hr />

<h1 id="2-bsubë¡œ-ì‹œì‘-íŒë³„-ì œê±°--ì œì¶œ-ë©”ì‹œì§€-ë§Œìœ¼ë¡œ-íŒë‹¨">2) â€œbsubë¡œ ì‹œì‘â€ íŒë³„ ì œê±° â†’ <strong>ì œì¶œ ë©”ì‹œì§€</strong> ë§Œìœ¼ë¡œ íŒë‹¨</h1>

<ul>
  <li>
    <p>ìŠ¤í¬ë¦½íŠ¸(<code class="language-plaintext highlighter-rouge">job_sub</code>)ë‚˜ ë˜í¼ê°€ <code class="language-plaintext highlighter-rouge">bsub</code>ë¥¼ ë‚´ë¶€ì—ì„œ í˜¸ì¶œí•˜ëŠ” ê²½ìš°ì—ë„, LSFê°€ í‘œì¤€ ì¶œë ¥/ì—ëŸ¬ë¡œ ë‚´ë³´ë‚´ëŠ”<br />
<strong><code class="language-plaintext highlighter-rouge">Job&lt;12345&gt;</code></strong> íŒ¨í„´ë§Œ ë³´ë©´ <strong>ì¡ IDë¥¼ ì•ˆì •ì ìœ¼ë¡œ íŒŒì‹±</strong> í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë”°ë¼ì„œ â€œëª…ë ¹ì–´ ì²« í† í°ì´ <code class="language-plaintext highlighter-rouge">bsub</code>ì¸ì§€â€ ì²´í¬ë¥¼ <strong>ì™„ì „íˆ ì œê±°</strong> í•˜ê³ , <strong>ì¶œë ¥ íŒŒì‹±ë§Œ</strong> ìœ¼ë¡œ â€œì¡ì¸ì§€/ì•„ë‹Œì§€â€ êµ¬ë¶„í•˜ë„ë¡ ë°”ê¿¨ìŠµë‹ˆë‹¤.</p>

    <ul>
      <li>
        <p>ì¡ ë©”ì‹œì§€ê°€ ì—†ìœ¼ë©´ <code class="language-plaintext highlighter-rouge">job_id=None</code>ìœ¼ë¡œ ì²˜ë¦¬(ì—ëŸ¬ X).</p>
      </li>
      <li>
        <p>â€œì·¨ì†Œâ€ ì‹œì—ë„ <strong>ì¤‘ê°„ì— í”„ë¡œì„¸ìŠ¤ë¥¼ killí•˜ì§€ ì•Šê³ </strong> í†µì‹  ì¢…ë£Œê¹Œì§€ ê¸°ë‹¤ë ¤ ë©”ì‹œì§€ë¥¼ ìˆ˜ì§‘ â†’ <strong>ê³ ì•„ ì¡ ë°©ì§€</strong>.</p>
      </li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="ì—…ë°ì´íŠ¸-ì½”ë“œ-í•µì‹¬-ë³€ê²½ë§Œ">ì—…ë°ì´íŠ¸ ì½”ë“œ (í•µì‹¬ ë³€ê²½ë§Œ)</h2>

<p>ì•„ë˜ëŠ” v4ì˜ <strong>êµì²´/ì¶”ê°€ëœ ë©”ì„œë“œ</strong> ì…ë‹ˆë‹¤. (ë‚˜ë¨¸ì§€ êµ¬ì¡°ëŠ” ì´ì „ ë²„ì „ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•´ë„ ë©ë‹ˆë‹¤.)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># --- NEW/CHANGED: ë””ìŠ¤í¬ ìºì‹œ ì½ê¸°: tsì™€ mtimeì„ ëª¨ë‘ í™œìš© ---
</span><span class="k">def</span> <span class="nf">_disk_cache_read</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache_path</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">stat</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>  <span class="c1"># ì„œë²„ ê´€ì  mtime
</span>        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
        <span class="n">ts_in_file</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">items</span><span class="p">()}</span>

        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">age_by_file_ts</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">ts_in_file</span> <span class="k">if</span> <span class="n">ts_in_file</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nf">float</span><span class="p">(</span><span class="sh">"</span><span class="s">inf</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">age_by_mtime</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">now</span> <span class="o">-</span> <span class="n">st</span><span class="p">.</span><span class="n">st_mtime</span><span class="p">)</span>

        <span class="c1"># ì‹œê³„ ì˜¤ì°¨ í—ˆìš©ì¹˜(ë©€í‹°ë¨¸ì‹ ): Â±2ì´ˆ
</span>        <span class="n">skew_eps</span> <span class="o">=</span> <span class="mf">2.0</span>
        <span class="n">fresh_by_ts</span> <span class="o">=</span> <span class="n">age_by_file_ts</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_disk_ttl</span> <span class="o">+</span> <span class="n">skew_eps</span><span class="p">)</span>
        <span class="n">fresh_by_mtime</span> <span class="o">=</span> <span class="n">age_by_mtime</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_disk_ttl</span> <span class="o">+</span> <span class="n">skew_eps</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fresh_by_ts</span> <span class="ow">or</span> <span class="n">fresh_by_mtime</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="c1"># --- NEW/CHANGED: ë””ìŠ¤í¬ ìºì‹œ ì“°ê¸°: tmp fsync -&gt; replace -&gt; dir fsync ---
</span><span class="k">def</span> <span class="nf">_disk_cache_write</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">dir_fd</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fd</span><span class="p">,</span> <span class="n">tmp_path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="p">.</span><span class="nf">mkstemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="sh">"</span><span class="s">bjobs_</span><span class="sh">"</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">"</span><span class="s">.json</span><span class="sh">"</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">fdopen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmpfp</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">},</span> <span class="n">tmpfp</span><span class="p">)</span>
                <span class="n">tmpfp</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">tmpfp</span><span class="p">.</span><span class="nf">fileno</span><span class="p">())</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache_path</span><span class="p">)</span>  <span class="c1"># atomic on same FS
</span>            <span class="c1"># ë©”íƒ€ë°ì´í„° ì˜ì†ì„± ê°•í™”
</span>            <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">FileNotFoundError</span><span class="p">):</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>

<span class="c1"># --- NEW/CHANGED: ì»¤ë§¨ë“œë¥¼ "ìˆëŠ” ê·¸ëŒ€ë¡œ" ì‹¤í–‰í•˜ë˜, ì¶œë ¥ì—ì„œë§Œ JobID íŒë³„ ---
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">run_command_capture_job</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                                  <span class="n">command</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
                                  <span class="o">*</span><span class="p">,</span>
                                  <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                                  <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    ì»¤ë§¨ë“œë¥¼ ê·¸ëŒ€ë¡œ ì‹¤í–‰. stdout/stderrì—ì„œ </span><span class="sh">'</span><span class="s">Job &lt;id&gt;</span><span class="sh">'</span><span class="s"> íŒ¨í„´ì„ ì°¾ì•„ ì¡ IDë¥¼ ë°˜í™˜.
    ì¡ ë©”ì‹œì§€ê°€ ì—†ìœ¼ë©´ job_id=None (ì—ëŸ¬ ë°œìƒ ì•ˆ í•¨ unless raise_on_error=True).
    </span><span class="sh">"""</span>
    <span class="c1"># ìŠ¤í° ì‹œì—ë§Œ ì„¸ë§ˆí¬ì–´ ë³´ìœ  -&gt; ë³‘ë ¬ ìŠ¤í° ì œí•œ
</span>    <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span><span class="p">:</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
                <span class="sh">"</span><span class="s">/bin/sh</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">-lc</span><span class="sh">"</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">env</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
                <span class="o">*</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">command</span><span class="p">),</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">env</span>
            <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ProcessLookupError</span><span class="p">):</span>
            <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
        <span class="k">raise</span>

    <span class="n">stdout</span> <span class="o">=</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">stderr</span> <span class="o">=</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>

    <span class="c1"># ì¶œë ¥ì—ì„œë§Œ íŒë‹¨
</span>    <span class="n">m</span> <span class="o">=</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span>
    <span class="n">job_id</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">raise_on_error</span> <span class="ow">and</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">([</span><span class="n">command</span><span class="p">]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">command</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">stdout</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">stderr</span><span class="p">,</span> <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span> <span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">job_id</span><span class="p">}</span>

<span class="c1"># --- NEW/CHANGED: ì¼ê´„ ì œì¶œ + ì·¨ì†Œ (ì¶œë ¥ìœ¼ë¡œ JobIDë§Œ ìˆ˜ì§‘; ì¤‘ê°„ kill ì—†ìŒ) ---
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">submit_many_with_cancel</span><span class="p">(</span>
    <span class="n">self</span><span class="p">,</span>
    <span class="n">commands</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">is_interrupted</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">bool</span><span class="p">],</span>
    <span class="n">poll_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
    <span class="n">max_in_flight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">kill_force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="n">kill_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="n">cmd_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
    <span class="n">cmd_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    ëª…ë ¹ì„ ê·¸ëŒ€ë¡œ ì‹¤í–‰. ê²°ê³¼(stdout/stderr)ì—ì„œ </span><span class="sh">'</span><span class="s">Job &lt;id&gt;</span><span class="sh">'</span><span class="s">ë§Œ ì¶”ì¶œ.
    ì¸í„°ëŸ½íŠ¸ ë°œìƒ ì‹œ: ìƒˆ ì‹¤í–‰ ì¤‘ë‹¨ + ì§„í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ë“¤ì€ ëê¹Œì§€ ê¸°ë‹¤ë¦¼(ê³ ì•„ ì¡ ë°©ì§€).
    ì´í›„ ìˆ˜ì§‘ëœ job_id ì „ì²´ bkill.
    </span><span class="sh">"""</span>
    <span class="n">submitted</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">max_in_flight</span> <span class="o">=</span> <span class="n">max_in_flight</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span><span class="p">.</span><span class="n">_value</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">run_command_capture_job</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">cmd_timeout</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">cmd_raise_on_error</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">in_flight</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span> <span class="ow">or</span> <span class="n">in_flight</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">in_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_in_flight</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">is_interrupted</span><span class="p">():</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">run_one</span><span class="p">(</span><span class="n">commands</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
                <span class="n">in_flight</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll_interval_sec</span><span class="p">,</span>
                                             <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                    <span class="n">in_flight</span><span class="p">.</span><span class="nf">discard</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                        <span class="k">if</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">submitted</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">])</span>
                        <span class="k">elif</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">poll_interval_sec</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># ë‚¨ì€ ê²ƒ ëª¨ë‘ ì¢…ë£Œê¹Œì§€ ê¸°ë‹¤ë ¤ job_id ìˆ˜ì§‘
</span>        <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
            <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">ALL_COMPLETED</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                    <span class="k">if</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">submitted</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">interrupted</span> <span class="o">=</span> <span class="nf">is_interrupted</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">interrupted</span> <span class="ow">and</span> <span class="n">submitted</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">submitted</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">kill_force</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">kill_raise_on_error</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">submitted_job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">submitted</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">interrupted</span><span class="sh">"</span><span class="p">:</span> <span class="n">interrupted</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">num_submitted</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">submitted</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">num_failed</span><span class="sh">"</span><span class="p">:</span> <span class="n">failures</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="ê°„ë‹¨-ì‚¬ìš©-ì˜ˆì‹œ">ê°„ë‹¨ ì‚¬ìš© ì˜ˆì‹œ</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># í˜¼í•© ì»¤ë§¨ë“œ: ë˜í¼ + ìˆœìˆ˜ ì…¸ + ì§„ì§œ bsub
</span><span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sh">"</span><span class="s">job_sub my_script.sh --epochs 5</span><span class="sh">"</span><span class="p">,</span>   <span class="c1"># ë‚´ë¶€ì—ì„œ bsub í˜¸ì¶œ -&gt; ì¶œë ¥ì— Job &lt;id&gt;ë§Œ ì°ì–´ì£¼ë©´ OK
</span>    <span class="sh">"</span><span class="s">sleep 1</span><span class="sh">"</span><span class="p">,</span>                           <span class="c1"># ì¡ ì•„ë‹˜: job_id=None
</span>    <span class="sh">"</span><span class="s">bsub -q short </span><span class="sh">'</span><span class="s">echo hi; sleep 2</span><span class="sh">'"</span><span class="p">,</span>  <span class="c1"># ì¡: job_id=ì •ìˆ˜
</span><span class="p">]</span>

<span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">submit_many_with_cancel</span><span class="p">(</span>
    <span class="n">cmds</span><span class="p">,</span>
    <span class="n">is_interrupted</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>    <span class="c1"># ì–¸ì œë“  True ë°˜í™˜ë˜ë©´ ìƒˆ ì‹¤í–‰ ì¤‘ë‹¨, ì§„í–‰ ì¤‘ì€ ëê¹Œì§€ ê¸°ë‹¤ë¦¼
</span>    <span class="n">max_in_flight</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">cmd_timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
<span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>  <span class="c1"># {"submitted_job_ids":[...], ...}
</span></code></pre></div></div>

<hr />

<h2 id="ì •ë¦¬-í•µì‹¬-í¬ì¸íŠ¸">ì •ë¦¬ (í•µì‹¬ í¬ì¸íŠ¸)</h2>

<ul>
  <li>
    <p><strong>ì›ìì„±</strong> : ê°™ì€ ê³µìœ  FS ë‚´ <code class="language-plaintext highlighter-rouge">os.replace()</code>ëŠ” ì›ìì . ìºì‹œ ì§€ì—°ì€ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ <strong>TTL 2~5s + dir fsync + mtime/ts ì´ì¤‘íŒì •</strong> ìœ¼ë¡œ ë³´ê°•.</p>
  </li>
  <li>
    <p><strong>ì¡ íŒë³„</strong> : â€œ<code class="language-plaintext highlighter-rouge">Job &lt;id&gt;</code> ë©”ì‹œì§€â€ë§Œìœ¼ë¡œ íŒë‹¨ â†’ <code class="language-plaintext highlighter-rouge">bsub</code> ë˜í¼/ìŠ¤í¬ë¦½íŠ¸ë„ ìì—°ìŠ¤ëŸ½ê²Œ ì§€ì›.</p>
  </li>
  <li>
    <p><strong>ì·¨ì†Œ ì‹œ</strong> : ì§„í–‰ ì¤‘ ì œì¶œì€ <strong>ëê¹Œì§€ ê¸°ë‹¤ë¦° ë’¤</strong> ì¡ID ëª¨ì•„ <strong>ì¼ê´„<code class="language-plaintext highlighter-rouge">bkill</code></strong> â†’ ê³ ì•„ ì¡ ë°©ì§€.</p>
  </li>
</ul>

<p>ì›í•˜ì‹œë©´,</p>

<ul>
  <li>
    <p><strong>ê°•ì œ ê°±ì‹  í”Œë˜ê·¸</strong>(<code class="language-plaintext highlighter-rouge">force_refresh=True</code>)ë‚˜</p>
  </li>
  <li>
    <p><strong>ìŠ¤íŠ¸ë¦¬ë° íŒŒì„œ</strong>(ì¶œë ¥ ì¤„ ë‹¨ìœ„ ì‹¤ì‹œê°„ íŒŒì‹±)ë¡œ â€œì¡ IDë¥¼ ì¦‰ì‹œ ê°ì§€â€í•˜ëŠ” ë²„ì „ë„ ì¶”ê°€í•´ ë“œë¦´ê²Œìš”.</p>
  </li>
</ul>

<p class="chat--user">

1. create_subprocess_shell ë¡œ ì‹¤í–‰í•˜ë©´ ì¢‹ê² ìŒ. (/bin/shë„ ì œê±°í•  ê²ƒ) 2. í˜„ì¬ê¹Œì§€ ì •ë¦¬ëœ ë‚´ìš© ì „ì²´ ì½”ë“œ ì‘ì„±í•´ì. 

</p>

<p>ì¢‹ì•„ìš”! ìš”ì²­í•˜ì‹  ëŒ€ë¡œ <strong><code class="language-plaintext highlighter-rouge">create_subprocess_shell</code>ë§Œ</strong> ì‚¬ìš©í•˜ê³ (ì§ì ‘ <code class="language-plaintext highlighter-rouge">/bin/sh</code> ì§€ì • X), ì§€ê¸ˆê¹Œì§€ í•©ì˜ëœ ìš”êµ¬ì‚¬í•­ì„ ëª¨ë‘ ë°˜ì˜í•œ <strong>ë‹¨ì¼ íŒŒì¼ ì „ì²´ ì½”ë“œ(v5)</strong> ë¥¼ ë“œë¦½ë‹ˆë‹¤.</p>

<ul>
  <li>
    <p>ì»¤ë§¨ë“œëŠ” <strong>ê·¸ëŒ€ë¡œ ì‹¤í–‰</strong> í•©ë‹ˆë‹¤. (ì˜ˆ: <code class="language-plaintext highlighter-rouge">sleep 1</code>, <code class="language-plaintext highlighter-rouge">bsub -q short sleep 1</code>, <code class="language-plaintext highlighter-rouge">job_sub ...</code>)</p>
  </li>
  <li>
    <p>ì¡ íŒë³„ì€ <strong>ì¶œë ¥ì˜<code class="language-plaintext highlighter-rouge">Job &lt;id&gt;</code> ë©”ì‹œì§€</strong>ë§Œìœ¼ë¡œ í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bjobs</code>ëŠ” **ì „ì²´ ìŠ¤ëƒ…ìƒ·(-u <user> [-a])**ì„ 1íšŒ ê°€ì ¸ì™€ **ë©”ëª¨ë¦¬+ë””ìŠ¤í¬ TTL ìºì‹œ**(ë©€í‹° í”„ë¡œì„¸ìŠ¤ ê³µìœ ) í›„, í˜¸ì¶œìì—ê²ŒëŠ” `job_ids`ë¡œ í•„í„°ë§ ê²°ê³¼ë§Œ ëŒë ¤ì¤ë‹ˆë‹¤.</user></p>
  </li>
  <li>
    <p>ë””ìŠ¤í¬ ìºì‹œëŠ” <strong>tmp â†’<code class="language-plaintext highlighter-rouge">os.replace</code>(ì›ìì ) â†’ ë””ë ‰í„°ë¦¬ <code class="language-plaintext highlighter-rouge">fsync</code></strong> ë¡œ ê¸°ë¡í•˜ê³ , <strong>íŒŒì¼ ë‚´ tsì™€ mtime ë‘˜ ë‹¤</strong> ë¡œ ì‹ ì„ ë„ë¥¼ íŒì •í•©ë‹ˆë‹¤. (NFS/SMB/GPFS ë“± ê³µìœ  FSì—ì„œë„ ì•ˆì „)</p>
  </li>
  <li>
    <p>ì·¨ì†Œ ì‹œì—” <strong>ìƒˆ ì‹¤í–‰ì„ ë©ˆì¶”ê³  ì§„í–‰ ì¤‘ ì œì¶œì€ ëê¹Œì§€ ê¸°ë‹¤ë ¤ Job ID ìˆ˜ì§‘ â†’ ì¼ê´„<code class="language-plaintext highlighter-rouge">bkill</code></strong>(ê³ ì•„ ì¡ ë°©ì§€)</p>
  </li>
  <li>
    <p>LSFê°€ ì•„ë‹Œ ì»¤ë§¨ë“œë„ ê·¸ëƒ¥ ì‹¤í–‰í•˜ê³  <strong>ì—ëŸ¬ëŠ” ì˜µì…˜ìœ¼ë¡œë§Œ raise</strong> í•©ë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># lsf_async_v5.py
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>
<span class="kn">import</span> <span class="n">getpass</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1"># ------------------------------
# Utilities
# ------------------------------
</span>
<span class="n">StrOrSeq</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
<span class="n">_JOBID_RE</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Accept str or seq; if seq, join by space (caller is responsible for quoting if needed).</span><span class="sh">"""</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cmd</span>
    <span class="k">return</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="nb">RuntimeError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Command failed: </span><span class="si">{</span><span class="n">cmd_str</span><span class="si">}</span><span class="s"> (rc=</span><span class="si">{</span><span class="n">returncode</span><span class="si">}</span><span class="s">)</span><span class="se">\n</span><span class="si">{</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cmd_str</span> <span class="o">=</span> <span class="n">cmd_str</span>
        <span class="n">self</span><span class="p">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="n">returncode</span>
        <span class="n">self</span><span class="p">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span>
        <span class="n">self</span><span class="p">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">stderr</span>

<span class="c1"># ------------------------------
# Client
# ------------------------------
</span>
<span class="k">class</span> <span class="nc">LsfClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - ì»¤ë§¨ë“œë¥¼ </span><span class="sh">'</span><span class="s">ìˆëŠ” ê·¸ëŒ€ë¡œ</span><span class="sh">'</span><span class="s"> shellë¡œ ì‹¤í–‰(create_subprocess_shell).
    - ì¶œë ¥ì—ì„œ </span><span class="sh">'</span><span class="s">Job &lt;id&gt;</span><span class="sh">'</span><span class="s"> ë©”ì‹œì§€ë¥¼ ì°¾ì•„ LSF ì¡ ì—¬ë¶€/ID íŒë‹¨.
    - bjobs: ì „ì²´ ìŠ¤ëƒ…ìƒ·ì„ ë©”ëª¨ë¦¬+ë””ìŠ¤í¬ TTL ìºì‹œ(ë©€í‹° í”„ë¡œì„¸ìŠ¤ ê³µìœ ) í›„ í•„í„°ë§ ë°˜í™˜.
    - ì¼ê´„ ì œì¶œ + ì·¨ì†Œ: ì¸í„°ëŸ½íŠ¸ ì‹œ ìƒˆ ì œì¶œ ì¤‘ë‹¨, ì§„í–‰ ì¤‘ ì œì¶œì€ ì™„ì£¼ â†’ ìˆ˜ì§‘í•œ job_idë¥¼ ì¼ê´„ bkill.
    </span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">bkill</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">bjobs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">max_concurrent_cli</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">bjobs_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># Paths
</span>        <span class="n">self</span><span class="p">.</span><span class="n">paths</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">:</span> <span class="n">bkill</span><span class="p">,</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">:</span> <span class="n">bjobs</span><span class="p">}</span>

        <span class="c1"># Concurrency &amp; rate-limit
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">max_concurrent_cli</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_min_interval_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_last_call_ts</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># Memory cache (per-process)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mem_cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Disk cache (shared across processes; atomic replace; robust on shared FS)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_disk_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">disk_cache_ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_user</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LSF_USER</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">getpass</span><span class="p">.</span><span class="nf">getuser</span><span class="p">()</span>
        <span class="n">base_cache</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">XDG_CACHE_HOME</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">expanduser</span><span class="p">(</span><span class="sh">"</span><span class="s">~</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">.cache</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span> <span class="o">=</span> <span class="n">cache_dir</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base_cache</span><span class="p">,</span> <span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all_</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># Locale-stable env (avoid localized outputs)
</span>        <span class="n">base_env</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LC_ALL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LANG</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">base_env</span> <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="bp">None</span> <span class="nf">else </span><span class="p">(</span><span class="n">base_env</span> <span class="o">|</span> <span class="n">env</span><span class="p">)</span>

    <span class="c1"># ------------- low-level run -------------
</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_run_shell</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        Run exactly as a shell command via asyncio.create_subprocess_shell.
        NOTE: We don</span><span class="sh">'</span><span class="s">t explicitly specify /bin/sh; the event loop chooses the platform default.
        </span><span class="sh">"""</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_shell</span><span class="p">(</span>
                <span class="n">cmd_str</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">env</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ProcessLookupError</span><span class="p">):</span>
                <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>

    <span class="c1"># ------------- general command (LSF or not) -------------
</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_command_capture_job</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        ì»¤ë§¨ë“œë¥¼ </span><span class="sh">'</span><span class="s">ê·¸ëŒ€ë¡œ</span><span class="sh">'</span><span class="s"> ì‹¤í–‰. stdout/stderrì—ì„œ </span><span class="sh">'</span><span class="s">Job &lt;id&gt;</span><span class="sh">'</span><span class="s"> íŒ¨í„´ì„ ì°¾ì•„ ì¡ IDë¥¼ ë°˜í™˜.
        - ì¡ ë©”ì‹œì§€ê°€ ì—†ìœ¼ë©´ job_id=None (ì—ëŸ¬ ë°œìƒ X, ë‹¨ raise_on_error=Trueë©´ ì˜ˆì™¸).
        </span><span class="sh">"""</span>
        <span class="n">cmd_str</span> <span class="o">=</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_run_shell</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

        <span class="n">m</span> <span class="o">=</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">raise_on_error</span> <span class="ow">and</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">stdout</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">stderr</span><span class="p">,</span> <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span> <span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">job_id</span><span class="p">}</span>

    <span class="c1"># ------------- kill -------------
</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">job_ids</span><span class="p">))]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">""</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-f </span><span class="sh">"</span> <span class="k">if</span> <span class="n">force</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bkill</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">flag</span><span class="si">}{</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_run_shell</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">raise_on_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span>

    <span class="c1"># ------------- bjobs snapshot cache -------------
</span>
    <span class="k">def</span> <span class="nf">_mem_fresh</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem_cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">ts</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">item</span>
        <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_disk_cache_read</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache_path</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">stat</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>  <span class="c1"># server-side mtime (on shared FS)
</span>            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="n">ts_in_file</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">items</span><span class="p">()}</span>

            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">age_by_ts</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">ts_in_file</span><span class="p">)</span> <span class="k">if</span> <span class="n">ts_in_file</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nf">float</span><span class="p">(</span><span class="sh">"</span><span class="s">inf</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">age_by_mtime</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">now</span> <span class="o">-</span> <span class="n">st</span><span class="p">.</span><span class="n">st_mtime</span><span class="p">)</span>
            <span class="n">skew_eps</span> <span class="o">=</span> <span class="mf">2.0</span>  <span class="c1"># tolerate small clock skew &amp; metadata latency
</span>
            <span class="n">fresh_by_ts</span> <span class="o">=</span> <span class="n">age_by_ts</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_disk_ttl</span> <span class="o">+</span> <span class="n">skew_eps</span><span class="p">)</span>
            <span class="n">fresh_by_mtime</span> <span class="o">=</span> <span class="n">age_by_mtime</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_disk_ttl</span> <span class="o">+</span> <span class="n">skew_eps</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fresh_by_ts</span> <span class="ow">or</span> <span class="n">fresh_by_mtime</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_disk_cache_write</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c1"># tmp -&gt; fsync(tmp) -&gt; replace -&gt; fsync(dir)  (robust on shared FS)
</span>        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">dir_fd</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fd</span><span class="p">,</span> <span class="n">tmp_path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="p">.</span><span class="nf">mkstemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="sh">"</span><span class="s">bjobs_</span><span class="sh">"</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">"</span><span class="s">.json</span><span class="sh">"</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_cache_dir</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">fdopen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmpfp</span><span class="p">:</span>
                    <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">},</span> <span class="n">tmpfp</span><span class="p">)</span>
                    <span class="n">tmpfp</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">tmpfp</span><span class="p">.</span><span class="nf">fileno</span><span class="p">())</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_cache_path</span><span class="p">)</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">FileNotFoundError</span><span class="p">):</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="c1"># simple per-process rate limit
</span>        <span class="n">since</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_last_call_ts</span>
        <span class="k">if</span> <span class="n">since</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">-</span> <span class="n">since</span><span class="p">)</span>

        <span class="n">flag</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-a </span><span class="sh">"</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bjobs</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> -noheader -u </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s">-o </span><span class="sh">'</span><span class="s">jobid stat exit_code queue exec_host</span><span class="sh">'"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_run_shell</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_last_call_ts</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

        <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">exec_host</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ValueError</span><span class="p">):</span>
                <span class="n">jid_i</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="n">jid_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="n">stat</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="sh">"</span><span class="s">-</span><span class="sh">"</span> <span class="k">else</span> <span class="n">exit_code</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="n">queue</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="n">exec_host</span><span class="p">,</span>
                <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_status_all_cached</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all|</span><span class="si">{</span><span class="sh">'</span><span class="s">-a</span><span class="sh">'</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">''</span><span class="si">}</span><span class="s">|user=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="sh">"</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
            <span class="n">mem</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_mem_fresh</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">mem</span>

            <span class="n">inflight</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inflight</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">inflight</span>

        <span class="n">fut</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">().</span><span class="nf">create_future</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fut</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
                <span class="n">disk</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_disk_cache_read</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">disk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_mem_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">disk</span><span class="p">)</span>
                    <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">disk</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">disk</span>

            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_mem_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_disk_cache_write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">status</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sh">"""</span><span class="s">
        bjobs ì „ì²´ ìŠ¤ëƒ…ìƒ·(ìºì‹œ í™œìš©) í›„, ìš”ì²­í•œ job_idsë§Œ í•„í„°ë§í•´ì„œ ë°˜í™˜.
        job_ids=Noneì´ë©´ ì „ì²´ ë§µì„ ëŒë ¤ì¤Œ.
        </span><span class="sh">"""</span>
        <span class="n">all_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_status_all_cached</span><span class="p">(</span>
            <span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="n">force_refresh</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">job_ids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_map</span>
        <span class="n">wanted</span> <span class="o">=</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">all_map</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">wanted</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">status_union_batched</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">list_of_job_id_sets</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
        <span class="sh">"""</span><span class="s">
        ì—¬ëŸ¬ ìš”ì²­ì„ í•©ì§‘í•©ìœ¼ë¡œ í•œ ë²ˆ ì¡°íšŒ(ì‹¤ì œë¡  ìŠ¤ëƒ…ìƒ· ìºì‹œ ì‚¬ìš©) í›„ ë¶„ë°°.
        </span><span class="sh">"""</span>
        <span class="n">union_ids</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="n">normalized</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">list_of_job_id_sets</span><span class="p">:</span>
            <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>
            <span class="n">normalized</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
            <span class="n">union_ids</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
        <span class="n">union_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">union_ids</span><span class="p">,</span> <span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="n">force_refresh</span><span class="p">)</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">normalized</span><span class="p">:</span>
            <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="n">i</span><span class="p">:</span> <span class="n">union_map</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="c1"># ------------- batch submit with cooperative cancel -------------
</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">commands</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">StrOrSeq</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">bool</span><span class="p">],</span>
        <span class="n">poll_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">kill_force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">kill_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">cmd_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        ëª…ë ¹ì„ ê·¸ëŒ€ë¡œ ì‹¤í–‰(create_subprocess_shell). ì¶œë ¥ì—ì„œ </span><span class="sh">'</span><span class="s">Job &lt;id&gt;</span><span class="sh">'</span><span class="s">ë§Œ ì¶”ì¶œ.
        ì¸í„°ëŸ½íŠ¸ ì‹œ: ìƒˆ ì‹¤í–‰ ì¤‘ë‹¨ + ì§„í–‰ ì¤‘ ì œì¶œì€ ëê¹Œì§€ ê¸°ë‹¤ë¦¼(ê³ ì•„ ì¡ ë°©ì§€) â†’ ìˆ˜ì§‘ëœ job_id ì¼ê´„ bkill.
        </span><span class="sh">"""</span>
        <span class="n">submitted</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">max_in_flight</span> <span class="o">=</span> <span class="n">max_in_flight</span> <span class="ow">or</span> <span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_cli_sem</span><span class="p">.</span><span class="n">_value</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">run_command_capture_job</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">cmd_timeout</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">cmd_raise_on_error</span>
            <span class="p">)</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
        <span class="n">in_flight</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">or</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="c1"># launch window
</span>                <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">in_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_in_flight</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">is_interrupted</span><span class="p">():</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">run_one</span><span class="p">(</span><span class="n">commands</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
                    <span class="n">in_flight</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                    <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span>
                        <span class="n">in_flight</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll_interval_sec</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                        <span class="n">in_flight</span><span class="p">.</span><span class="nf">discard</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                            <span class="n">jid</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">jid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="n">submitted</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">poll_interval_sec</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># drain: ì§„í–‰ ì¤‘ ì œì¶œì„ ëê¹Œì§€ ê¸°ë‹¤ë ¤ Job ID ìˆ˜ì§‘
</span>            <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">ALL_COMPLETED</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                        <span class="n">jid</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">jid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">submitted</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">interrupted</span> <span class="o">=</span> <span class="nf">is_interrupted</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">interrupted</span> <span class="ow">and</span> <span class="n">submitted</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">submitted</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">kill_force</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">kill_raise_on_error</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">submitted_job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">submitted</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">interrupted</span><span class="sh">"</span><span class="p">:</span> <span class="n">interrupted</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">num_submitted</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">submitted</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">num_failed</span><span class="sh">"</span><span class="p">:</span> <span class="n">failures</span><span class="p">,</span>
        <span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="ë¹ ë¥¸-ì‚¬ìš©-ì˜ˆì‹œ">ë¹ ë¥¸ ì‚¬ìš© ì˜ˆì‹œ</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">lsf_async_v5</span> <span class="kn">import</span> <span class="n">LsfClient</span>

<span class="k">class</span> <span class="nc">Token</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span> <span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">delay</span>
    <span class="k">def</span> <span class="nf">is_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">):</span> <span class="nf">return </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span><span class="o">-</span><span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">lsf</span> <span class="o">=</span> <span class="nc">LsfClient</span><span class="p">(</span>
        <span class="n">max_concurrent_cli</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">bjobs_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="o">=</span><span class="sh">"</span><span class="s">/shared/cache/lsf_async</span><span class="sh">"</span><span class="p">,</span>  <span class="c1"># ì—¬ëŸ¬ ë¨¸ì‹ ì—ì„œ ê³µìœ ë˜ëŠ” ê²½ë¡œ
</span>    <span class="p">)</span>

    <span class="c1"># í˜¼í•© ì»¤ë§¨ë“œ: ë˜í¼/ìˆœìˆ˜/ì§ì ‘ bsub
</span>    <span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sh">"</span><span class="s">job_sub my_script.sh --epochs 3</span><span class="sh">"</span><span class="p">,</span>    <span class="c1"># ë‚´ë¶€ì—ì„œ bsub í˜¸ì¶œ, ì¶œë ¥ì— Job &lt;id&gt;ê°€ ì°íˆë©´ ì¡ìœ¼ë¡œ ì¸ì‹
</span>        <span class="sh">"</span><span class="s">sleep 1</span><span class="sh">"</span><span class="p">,</span>                             <span class="c1"># ë¹„LSF: job_id=None
</span>        <span class="sh">"</span><span class="s">bsub -q short </span><span class="sh">'</span><span class="s">echo hi; sleep 2</span><span class="sh">'"</span><span class="p">,</span>    <span class="c1"># LSF: job_id íŒŒì‹±
</span>    <span class="p">]</span>

    <span class="c1"># 3ì´ˆ í›„ ì·¨ì†Œ
</span>    <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">cmds</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="o">=</span><span class="nc">Token</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="n">is_interrupted</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
        <span class="n">cmd_raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">kill_force</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

    <span class="c1"># bjobs ìŠ¤ëƒ…ìƒ· ìºì‹œ í™œìš©
</span>    <span class="n">all_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">some</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lsf</span><span class="p">.</span><span class="nf">status</span><span class="p">([</span><span class="nf">list</span><span class="p">(</span><span class="n">all_map</span><span class="p">.</span><span class="nf">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="n">all_map</span> <span class="k">else</span> <span class="p">[])</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">N(all)=</span><span class="sh">"</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">all_map</span><span class="p">),</span> <span class="sh">"</span><span class="s">subset=</span><span class="sh">"</span><span class="p">,</span> <span class="n">some</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h3 id="êµ¬í˜„-ë©”ëª¨ìš”ì -ì •ë¦¬">êµ¬í˜„ ë©”ëª¨(ìš”ì  ì •ë¦¬)</h3>

<ol>
  <li>
    <p><strong>ì…¸ ì‹¤í–‰</strong> : ëª¨ë“  ì»¤ë§¨ë“œëŠ” <code class="language-plaintext highlighter-rouge">asyncio.create_subprocess_shell</code>ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤. ì½”ë“œ ì–´ë””ì—ë„ ì§ì ‘ <code class="language-plaintext highlighter-rouge">/bin/sh</code>ë¥¼ ì§€ì •í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>ì¡ íŒë³„</strong> : ì˜¤ì§ ì¶œë ¥ì˜ <code class="language-plaintext highlighter-rouge">Job &lt;id&gt;</code> íŒ¨í„´ìœ¼ë¡œë§Œ ì¡ ì—¬ë¶€/IDë¥¼ íŒë‹¨í•©ë‹ˆë‹¤. (ë˜í¼/ìŠ¤í¬ë¦½íŠ¸ OK)</p>
  </li>
  <li>
    <p><strong>ê³µìœ  ë“œë¼ì´ë¸Œ ì•ˆì „ì„±</strong> :</p>

    <ul>
      <li>
        <p>ì“°ê¸°: tmpâ†’<code class="language-plaintext highlighter-rouge">os.replace</code>(ë™ì¼ FS ë‚´ ì›ìì )â†’ë””ë ‰í„°ë¦¬ <code class="language-plaintext highlighter-rouge">fsync</code>ë¡œ ë©”íƒ€ë°ì´í„°ê¹Œì§€ ë³´ì¥.</p>
      </li>
      <li>
        <p>ì½ê¸°: <code class="language-plaintext highlighter-rouge">ts</code>(íŒŒì¼ ë‚´ë¶€)ì™€ <code class="language-plaintext highlighter-rouge">mtime</code>(ì„œë²„ ë©”íƒ€ë°ì´í„°) <strong>ë‘˜ ë‹¤</strong> ë¡œ TTL íŒì •(+2s ìŠ¤í í—ˆìš©).</p>
      </li>
      <li>
        <p>ìš´ì˜ íŒ: TTLì€ <strong>â‰¥2~5ì´ˆ</strong> ê¶Œì¥(ë¶„ì‚° FS ì „íŒŒ ì§€ì—° í¡ìˆ˜).</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ê³ ì•„ ì¡ ë°©ì§€</strong> : ì·¨ì†Œ ì‹œ <strong>ì§„í–‰ ì¤‘ ì œì¶œì€ killí•˜ì§€ ì•Šê³ </strong> ëê¹Œì§€ ê¸°ë‹¤ë¦° ë’¤ <strong>ìˆ˜ì§‘í•œ job_idë§Œ bkill</strong>.</p>
  </li>
  <li>
    <p><strong>ì—ëŸ¬ ì •ì±…</strong> : ì¼ë°˜ ì»¤ë§¨ë“œëŠ” <code class="language-plaintext highlighter-rouge">raise_on_error=False</code> ê¸°ë³¸(ì˜ˆì™¸ ë¯¸ë°œìƒ). í•„ìš” ì‹œ Trueë¡œ ì˜¬ë¦¬ë©´ ì˜ˆì™¸ ë°œìƒ.</p>
  </li>
</ol>

<p>í•„ìš”í•˜ì‹œë©´ <code class="language-plaintext highlighter-rouge">force_refresh=True</code>ë¡œ bjobsë¥¼ ê°•ì œ ê°±ì‹ í•˜ëŠ” í˜¸ì¶œ ê²½ë¡œë¥¼ ë” ë…¸ì¶œí•˜ê±°ë‚˜, <strong>ìŠ¤íŠ¸ë¦¬ë° íŒŒì„œ</strong> ë¡œ <code class="language-plaintext highlighter-rouge">Job &lt;id&gt;</code>ë¥¼ â€œì‹¤ì‹œê°„â€ ê°ì§€í•˜ëŠ” ë²„ì „ë„ ì¶”ê°€í•´ ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

ë­”ê°€ í•œ í´ë˜ìŠ¤ì— ë‹¤ ë°•ì€ ëŠë‚Œì¸ë°, í´ë˜ìŠ¤ ê°™ì€ê±¸ ë‚˜ëˆ ì„œ ê¹”ë”í•˜ê²Œ ì§œì¤„ ìˆ˜ ìˆì–´? íŒŒì´ì¬ í˜„ì—… ì „ë¬¸ê°€ê°€ ì‘ì„±í•œ ê²ƒ ì²˜ëŸ¼

</p>

<p>ì¢‹ì•„ìš”â€”ìš”êµ¬ì‚¬í•­ì„ â€œí˜„ì—…ìŠ¤ëŸ¬ìš´â€ êµ¬ì¡°ë¡œ ìª¼ê°œì„œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.<br />
í•µì‹¬ì€ ì—­í• ë³„ í´ë˜ìŠ¤ë¡œ ë¶„ë¦¬(ì…¸ ì‹¤í–‰/ë ˆì´íŠ¸ë¦¬ë°‹/ë©”ëª¨ë¦¬Â·ë””ìŠ¤í¬ ìºì‹œ/ìŠ¤ëƒ…ìƒ· í˜ì²˜/ìƒíƒœ API/ë°°ì¹˜ ì œì¶œÂ·ì·¨ì†Œ), ê·¸ë¦¬ê³  <code class="language-plaintext highlighter-rouge">create_subprocess_shell</code>ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>

<p>ì•„ë˜ ë‹¨ì¼ íŒŒì¼ì„ ê·¸ëŒ€ë¡œ ì €ì¥í•´ ì“°ì„¸ìš”. (ì˜ˆ: <code class="language-plaintext highlighter-rouge">lsf_pro.py</code>)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># lsf_pro.py
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>
<span class="kn">import</span> <span class="n">getpass</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1"># ============================================================
# Exceptions &amp; Utilities
# ============================================================
</span>
<span class="k">class</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="nb">RuntimeError</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Raised when an LSF-related command returns nonzero exit code (optional).</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Command failed: </span><span class="si">{</span><span class="n">cmd_str</span><span class="si">}</span><span class="s"> (rc=</span><span class="si">{</span><span class="n">returncode</span><span class="si">}</span><span class="s">)</span><span class="se">\n</span><span class="si">{</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cmd_str</span> <span class="o">=</span> <span class="n">cmd_str</span>
        <span class="n">self</span><span class="p">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="n">returncode</span>
        <span class="n">self</span><span class="p">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span>
        <span class="n">self</span><span class="p">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">stderr</span>

<span class="n">StrOrSeq</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
<span class="n">_JOBID_RE</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">to_shell_str</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Accept str or sequence; if sequence, join by space. Caller is responsible for quoting.</span><span class="sh">"""</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cmd</span>
    <span class="k">return</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">parse_job_id_from_output</span><span class="p">(</span><span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">Find </span><span class="sh">'</span><span class="s">Job &lt;123&gt;</span><span class="sh">'</span><span class="s"> in either stdout or stderr.</span><span class="sh">"""</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span>
    <span class="k">return</span> <span class="nf">int</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="bp">None</span>

<span class="c1"># ============================================================
# Config
# ============================================================
</span>
<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">LSFConfig</span><span class="p">:</span>
    <span class="n">bkill</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span>
    <span class="n">bjobs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span>
    <span class="n">max_concurrent_cli</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">bjobs_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span>
    <span class="n">bjobs_min_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">disk_cache_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span>
    <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># default: env/OS user
</span>
<span class="c1"># ============================================================
# Layer 1: Shell runner &amp; rate limiter
# ============================================================
</span>
<span class="k">class</span> <span class="nc">ShellRunner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Thin async wrapper around asyncio.create_subprocess_shell with a concurrency gate.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">max_concurrency</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">max_concurrency</span><span class="p">)</span>
        <span class="n">base_env</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LC_ALL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LANG</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_env</span> <span class="o">=</span> <span class="n">base_env</span> <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="bp">None</span> <span class="nf">else </span><span class="p">(</span><span class="n">base_env</span> <span class="o">|</span> <span class="n">env</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_sem</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_shell</span><span class="p">(</span>
                <span class="n">cmd_str</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_env</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ProcessLookupError</span><span class="p">):</span>
                <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>

<span class="k">class</span> <span class="nc">MinIntervalRateLimiter</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Simple per-process min-interval limiter.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">min_interval_sec</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_min</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">min_interval_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_min</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">since</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_last</span>
        <span class="k">if</span> <span class="n">since</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_min</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_min</span> <span class="o">-</span> <span class="n">since</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>

<span class="c1"># ============================================================
# Layer 2: Caches (memory + disk)
# ============================================================
</span>
<span class="k">class</span> <span class="nc">MemoryTTLCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Per-process TTL cache for a single key-space.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">ttl_sec</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_store</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_store</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">ts</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">item</span>
        <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_store</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">DiskJSONCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Shared JSON cache: tmp -&gt; fsync(tmp) -&gt; os.replace() -&gt; fsync(dir).
    - Atomic replace within same filesystem.
    - Robust on NFS/SMB/GPFS: readers may see slightly stale content (metadata propagation),
      so freshness is judged via both JSON </span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="s"> and file mtime with skew tolerance.
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ttl_sec</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">skew_eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_skew</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">skew_eps</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_path</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">stat</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="n">ts_in_file</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="c1"># Freshness by writer ts OR server mtime (tolerate skew)
</span>            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">age_by_ts</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">ts_in_file</span><span class="p">)</span> <span class="k">if</span> <span class="n">ts_in_file</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nf">float</span><span class="p">(</span><span class="sh">"</span><span class="s">inf</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">age_by_mtime</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">now</span> <span class="o">-</span> <span class="n">st</span><span class="p">.</span><span class="n">st_mtime</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">age_by_ts</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">)</span> <span class="ow">or</span> <span class="n">age_by_mtime</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">data</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_path</span><span class="p">)</span>
        <span class="n">dir_fd</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fd</span><span class="p">,</span> <span class="n">tmp_path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="p">.</span><span class="nf">mkstemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="sh">"</span><span class="s">bjobs_</span><span class="sh">"</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">"</span><span class="s">.json</span><span class="sh">"</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">dir_path</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">fdopen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmpfp</span><span class="p">:</span>
                    <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">},</span> <span class="n">tmpfp</span><span class="p">)</span>
                    <span class="n">tmpfp</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">tmpfp</span><span class="p">.</span><span class="nf">fileno</span><span class="p">())</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_path</span><span class="p">)</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">FileNotFoundError</span><span class="p">):</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>

<span class="c1"># ============================================================
# Layer 3: LSF primitives (fetcher/kill/command)
# ============================================================
</span>
<span class="k">class</span> <span class="nc">BJobsFetcher</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Fetch a full snapshot for the current user.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">shell</span><span class="p">:</span> <span class="n">ShellRunner</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">bjobs_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limiter</span><span class="p">:</span> <span class="n">MinIntervalRateLimiter</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_shell</span> <span class="o">=</span> <span class="n">shell</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_user</span> <span class="o">=</span> <span class="n">user</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs</span> <span class="o">=</span> <span class="n">bjobs_path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_limiter</span> <span class="o">=</span> <span class="n">limiter</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_limiter</span><span class="p">.</span><span class="nf">wait</span><span class="p">()</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-a </span><span class="sh">"</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="c1"># Use a minimal, whitespace-safe field set
</span>        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs</span><span class="si">}</span><span class="s"> -noheader -u </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s">-o </span><span class="se">\"</span><span class="s">jobid stat exit_code queue exec_host</span><span class="se">\"</span><span class="sh">"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_shell</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

        <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">exec_host</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">jid_i</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">result</span><span class="p">[</span><span class="n">jid_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="n">stat</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="sh">"</span><span class="s">-</span><span class="sh">"</span> <span class="k">else</span> <span class="n">exit_code</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="n">queue</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="n">exec_host</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span>

<span class="k">class</span> <span class="nc">BKiller</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Kill one or many jobs with bkill.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">shell</span><span class="p">:</span> <span class="n">ShellRunner</span><span class="p">,</span> <span class="n">bkill_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_shell</span> <span class="o">=</span> <span class="n">shell</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bkill</span> <span class="o">=</span> <span class="n">bkill_path</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">job_ids</span><span class="p">))]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">""</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-f </span><span class="sh">"</span> <span class="k">if</span> <span class="n">force</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_bkill</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">flag</span><span class="si">}{</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_shell</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">raise_on_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span>

<span class="k">class</span> <span class="nc">CommandRunner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Run arbitrary commands exactly as given and (only) parse </span><span class="sh">'</span><span class="s">Job &lt;id&gt;</span><span class="sh">'</span><span class="s"> from outputs.
    - If no job message, returns job_id=None (no exception unless raise_on_error=True).
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">shell</span><span class="p">:</span> <span class="n">ShellRunner</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_shell</span> <span class="o">=</span> <span class="n">shell</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_capture_job</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">cmd_str</span> <span class="o">=</span> <span class="nf">to_shell_str</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_shell</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="nf">parse_job_id_from_output</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">raise_on_error</span> <span class="ow">and</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">stdout</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">stderr</span><span class="p">,</span> <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span> <span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">job_id</span><span class="p">}</span>

<span class="c1"># ============================================================
# Layer 4: Snapshot cache service (mem+disk + singleflight)
# ============================================================
</span>
<span class="k">class</span> <span class="nc">JobsSnapshotCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Provides a full bjobs snapshot with:
      - per-process memory TTL cache
      - multi-process shared disk JSON cache
      - singleflight for concurrent callers in-process
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">fetcher</span><span class="p">:</span> <span class="n">BJobsFetcher</span><span class="p">,</span>
        <span class="n">mem_cache</span><span class="p">:</span> <span class="n">MemoryTTLCache</span><span class="p">,</span>
        <span class="n">disk_cache</span><span class="p">:</span> <span class="n">DiskJSONCache</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_fetcher</span> <span class="o">=</span> <span class="n">fetcher</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mem</span> <span class="o">=</span> <span class="n">mem_cache</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_disk</span> <span class="o">=</span> <span class="n">disk_cache</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">get</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all|</span><span class="si">{</span><span class="sh">'</span><span class="s">-a</span><span class="sh">'</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">''</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
            <span class="n">memo</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">memo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">memo</span>
            <span class="n">inflight</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inflight</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">inflight</span>

        <span class="n">fut</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">().</span><span class="nf">create_future</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fut</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
                <span class="n">disk</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_disk</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">disk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">disk</span><span class="p">.</span><span class="nf">items</span><span class="p">()})</span>
                    <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">({</span><span class="nf">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">disk</span><span class="p">.</span><span class="nf">items</span><span class="p">()})</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="n">fut</span>

            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_fetcher</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_disk</span><span class="p">.</span><span class="nf">write</span><span class="p">({</span><span class="nf">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">items</span><span class="p">()})</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">fut</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

<span class="c1"># ============================================================
# Layer 5: Public services (Status / Batched submit-cancel)
# ============================================================
</span>
<span class="k">class</span> <span class="nc">StatusService</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">User-facing status APIs built on top of the snapshot cache.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cache</span><span class="p">:</span> <span class="n">JobsSnapshotCache</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="n">cache</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">status</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">all_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="n">force_refresh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job_ids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_map</span>
        <span class="n">wanted</span> <span class="o">=</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">all_map</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">wanted</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">status_union_batched</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">list_of_job_id_sets</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
        <span class="n">union_ids</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="n">normalized</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">list_of_job_id_sets</span><span class="p">:</span>
            <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>
            <span class="n">normalized</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
            <span class="n">union_ids</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
        <span class="n">union_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">union_ids</span><span class="p">,</span> <span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="n">force_refresh</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[{</span><span class="n">i</span><span class="p">:</span> <span class="n">union_map</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req</span><span class="p">}</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">normalized</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">BatchSubmitter</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Submits heterogeneous commands (some may submit LSF jobs via wrappers).
    - Collects Job IDs by scanning outputs (</span><span class="sh">'</span><span class="s">Job &lt;id&gt;</span><span class="sh">'</span><span class="s">).
    - On interruption: stops launching new commands, waits for in-flight to finish
      (prevents orphan jobs), then bkill all collected Job IDs.
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">runner</span><span class="p">:</span> <span class="n">CommandRunner</span><span class="p">,</span> <span class="n">killer</span><span class="p">:</span> <span class="n">BKiller</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_runner</span> <span class="o">=</span> <span class="n">runner</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_killer</span> <span class="o">=</span> <span class="n">killer</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">commands</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">StrOrSeq</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">bool</span><span class="p">],</span>
        <span class="n">poll_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">kill_force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">kill_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">cmd_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">submitted</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">in_flight</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run_capture_job</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">cmd_timeout</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">cmd_raise_on_error</span><span class="p">)</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">or</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">in_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_in_flight</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">is_interrupted</span><span class="p">():</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">run_one</span><span class="p">(</span><span class="n">commands</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
                    <span class="n">in_flight</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                    <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll_interval_sec</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                        <span class="n">in_flight</span><span class="p">.</span><span class="nf">discard</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                            <span class="n">jid</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">jid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="n">submitted</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">poll_interval_sec</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Drain: ensure all running submissions complete and harvest Job IDs
</span>            <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">ALL_COMPLETED</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                        <span class="n">jid</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">jid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">submitted</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">interrupted</span> <span class="o">=</span> <span class="nf">is_interrupted</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">interrupted</span> <span class="ow">and</span> <span class="n">submitted</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_killer</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">submitted</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">kill_force</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">kill_raise_on_error</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">submitted_job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">submitted</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">interrupted</span><span class="sh">"</span><span class="p">:</span> <span class="n">interrupted</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">num_submitted</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">submitted</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">num_failed</span><span class="sh">"</span><span class="p">:</span> <span class="n">failures</span><span class="p">,</span>
        <span class="p">}</span>

<span class="c1"># ============================================================
# Layer 6: Facade (compose everything)
# ============================================================
</span>
<span class="k">class</span> <span class="nc">LSFClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    High-level facade that exposes:
      - run_command_capture_job
      - kill
      - status / status_union_batched
      - submit_many_with_cancel
    </span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LSFConfig</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span> <span class="ow">or</span> <span class="nc">LSFConfig</span><span class="p">()</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="n">user</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LSF_USER</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">getpass</span><span class="p">.</span><span class="nf">getuser</span><span class="p">()</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="n">cache_dir</span> <span class="ow">or</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">XDG_CACHE_HOME</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">expanduser</span><span class="p">(</span><span class="sh">"</span><span class="s">~</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">.cache</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">cache_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all_</span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># Core components
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_shell</span> <span class="o">=</span> <span class="nc">ShellRunner</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">max_concurrent_cli</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_limiter</span> <span class="o">=</span> <span class="nc">MinIntervalRateLimiter</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">bjobs_min_interval_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_fetcher</span> <span class="o">=</span> <span class="nc">BJobsFetcher</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_shell</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">bjobs_path</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">bjobs</span><span class="p">,</span> <span class="n">limiter</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_limiter</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mem_cache</span> <span class="o">=</span> <span class="nc">MemoryTTLCache</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">bjobs_ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_disk_cache</span> <span class="o">=</span> <span class="nc">DiskJSONCache</span><span class="p">(</span><span class="n">cache_path</span><span class="p">,</span> <span class="n">ttl_sec</span><span class="o">=</span><span class="n">cfg</span><span class="p">.</span><span class="n">disk_cache_ttl_sec</span><span class="p">,</span> <span class="n">skew_eps</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_snap_cache</span> <span class="o">=</span> <span class="nc">JobsSnapshotCache</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_fetcher</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem_cache</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_disk_cache</span><span class="p">)</span>

        <span class="c1"># Services
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_status</span> <span class="o">=</span> <span class="nc">StatusService</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_snap_cache</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_killer</span> <span class="o">=</span> <span class="nc">BKiller</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_shell</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="n">bkill</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_runner</span> <span class="o">=</span> <span class="nc">CommandRunner</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_shell</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_submitter</span> <span class="o">=</span> <span class="nc">BatchSubmitter</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_killer</span><span class="p">)</span>

    <span class="c1"># ----- Facade methods -----
</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_command_capture_job</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run_capture_job</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">raise_on_error</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_killer</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">raise_on_error</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span> <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_status</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="n">force_refresh</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">status_union_batched</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">list_of_job_id_sets</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="o">*</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span> <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_status</span><span class="p">.</span><span class="nf">status_union_batched</span><span class="p">(</span><span class="n">list_of_job_id_sets</span><span class="p">,</span> <span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="n">force_refresh</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">commands</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">StrOrSeq</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">bool</span><span class="p">],</span>
        <span class="n">poll_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">kill_force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">kill_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">cmd_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_submitter</span><span class="p">.</span><span class="nf">submit_many_with_cancel</span><span class="p">(</span>
            <span class="n">commands</span><span class="p">,</span>
            <span class="n">is_interrupted</span><span class="o">=</span><span class="n">is_interrupted</span><span class="p">,</span>
            <span class="n">poll_interval_sec</span><span class="o">=</span><span class="n">poll_interval_sec</span><span class="p">,</span>
            <span class="n">max_in_flight</span><span class="o">=</span><span class="n">max_in_flight</span><span class="p">,</span>
            <span class="n">kill_force</span><span class="o">=</span><span class="n">kill_force</span><span class="p">,</span>
            <span class="n">kill_raise_on_error</span><span class="o">=</span><span class="n">kill_raise_on_error</span><span class="p">,</span>
            <span class="n">cmd_timeout</span><span class="o">=</span><span class="n">cmd_timeout</span><span class="p">,</span>
            <span class="n">cmd_raise_on_error</span><span class="o">=</span><span class="n">cmd_raise_on_error</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></div>

<p>ê°„ë‹¨ ì‚¬ìš© ì˜ˆì‹œ(í•„ìš”í•œ ë¶€ë¶„ë§Œ ë³µë¶™):</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># example.py
</span><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">lsf_pro</span> <span class="kn">import</span> <span class="n">LSFClient</span><span class="p">,</span> <span class="n">LSFConfig</span>

<span class="k">class</span> <span class="nc">Token</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span> <span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">delay</span>
    <span class="k">def</span> <span class="nf">is_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">):</span> <span class="nf">return </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">LSFClient</span><span class="p">(</span><span class="nc">LSFConfig</span><span class="p">(</span>
        <span class="n">bkill</span><span class="o">=</span><span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">bjobs</span><span class="o">=</span><span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">max_concurrent_cli</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">bjobs_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="o">=</span><span class="sh">"</span><span class="s">/shared/cache</span><span class="sh">"</span><span class="p">,</span>  <span class="c1"># ì—¬ëŸ¬ ë¨¸ì‹ ì´ ë³´ëŠ” ê³µìœ  ê²½ë¡œ
</span>    <span class="p">))</span>

    <span class="c1"># 1) ì»¤ë§¨ë“œë¥¼ ê·¸ëŒ€ë¡œ ì‹¤í–‰ (ì¡ ë©”ì‹œì§€ ìˆìœ¼ë©´ job_id íŒŒì‹±)
</span>    <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">run_command_capture_job</span><span class="p">(</span><span class="sh">"</span><span class="s">bsub -q short </span><span class="sh">'</span><span class="s">echo hi; sleep 1</span><span class="sh">'"</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">submit:</span><span class="sh">"</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

    <span class="c1"># 2) ìƒíƒœ ì¡°íšŒ (ì „ì²´ ìŠ¤ëƒ…ìƒ· ìºì‹œ í™œìš©)
</span>    <span class="n">all_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">num jobs:</span><span class="sh">"</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">all_map</span><span class="p">))</span>

    <span class="c1"># 3) ë°°ì¹˜ ì œì¶œ + ì·¨ì†Œ(3ì´ˆ í›„)
</span>    <span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sh">"</span><span class="s">job_sub my_script.sh --epochs 3</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">sleep 1</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">bsub -q short </span><span class="sh">'</span><span class="s">echo X; sleep 2</span><span class="sh">'"</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">cmds</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="o">=</span><span class="nc">Token</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="n">is_interrupted</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
        <span class="n">kill_force</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">batch:</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h3 id="ì„¤ê³„-ìš”ì•½-step-by-step">ì„¤ê³„ ìš”ì•½ (step-by-step)</h3>

<ol>
  <li>
    <p><strong>ShellRunner</strong> : <code class="language-plaintext highlighter-rouge">create_subprocess_shell</code>ë§Œ ì‚¬ìš©, ë™ì‹œ ì‹¤í–‰ ì œí•œ.</p>
  </li>
  <li>
    <p><strong>MinIntervalRateLimiter</strong> : <code class="language-plaintext highlighter-rouge">bjobs</code> ê³¼í˜¸ì¶œ ë°©ì§€.</p>
  </li>
  <li>
    <p><strong>MemoryTTLCache / DiskJSONCache</strong> : í”„ë¡œì„¸ìŠ¤ ë‚´/ê°„ 2ì¤‘ ìºì‹œ. ë””ìŠ¤í¬ëŠ” tmpâ†’<code class="language-plaintext highlighter-rouge">os.replace</code>â†’<code class="language-plaintext highlighter-rouge">fsync(dir)</code>ë¡œ ê²¬ê³ .</p>
  </li>
  <li>
    <p><strong>BJobsFetcher</strong> : <code class="language-plaintext highlighter-rouge">-u &lt;user&gt;</code> ì „ì²´ ìŠ¤ëƒ…ìƒ· + ìµœì†Œ í•„ë“œ íŒŒì‹±.</p>
  </li>
  <li>
    <p><strong>JobsSnapshotCache</strong> : ë‹¨ì¼í”Œë¼ì´íŠ¸(in-process) + ë©”ëª¨ë¦¬/ë””ìŠ¤í¬ ìºì‹œ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜.</p>
  </li>
  <li>
    <p><strong>StatusService</strong> : ì „ì²´ ìŠ¤ëƒ…ìƒ·ì„ ìš”ì²­ IDë¡œ í•„í„°.</p>
  </li>
  <li>
    <p><strong>CommandRunner</strong> : ì–´ë–¤ ì»¤ë§¨ë“œë“  ê·¸ëŒ€ë¡œ ì‹¤í–‰, ì¶œë ¥ì—ì„œë§Œ <code class="language-plaintext highlighter-rouge">Job &lt;id&gt;</code> íŒŒì‹±.</p>
  </li>
  <li>
    <p><strong>BKiller</strong> : ë‹¤ìˆ˜ IDë¥¼ í•œ ë²ˆì— <code class="language-plaintext highlighter-rouge">bkill</code>.</p>
  </li>
  <li>
    <p><strong>BatchSubmitter</strong> : ì¸í„°ëŸ½íŠ¸ ì‹œ ìƒˆ ì œì¶œ ì¤‘ë‹¨, <strong>ì§„í–‰ ì¤‘ì€ ê¸°ë‹¤ë ¤</strong> Job ID ìˆ˜ì§‘ í›„ ì¼ê´„ <code class="language-plaintext highlighter-rouge">bkill</code>(ê³ ì•„ ë°©ì§€).</p>
  </li>
  <li>
    <p><strong>LSFClient</strong> : ìœ„ êµ¬ì„±ìš”ì†Œë¥¼ í•©ì¹œ í¼ì‚¬ë“œ.</p>
  </li>
</ol>

<p>ì¶”ê°€ ì›í•˜ì‹œë©´ ë¡œê¹… í›…/ë©”íŠ¸ë¦­ìŠ¤(í˜¸ì¶œ ìˆ˜, í‰ê·  ì§€ì—°)Â·NFS í™˜ê²½ì—ì„œì˜ ê°•ì œ ë¦¬í”„ë ˆì‹œ í”Œë˜ê·¸Â·ëŒ€ê·œëª¨ ì¡ ìŠ¤ëƒ…ìƒ· ìƒ¤ë”©ê¹Œì§€ ì´ì–´ì„œ í™•ì¥í•´ ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

ì¢€ ê³¼í•˜ê²Œ ë‚˜ëˆˆ ê²ƒ ì•„ëƒ? ì§„ì§œ í•„ìš”í•œ ìˆ˜ì¤€ìœ¼ë¡œë§Œ ìª¼ê°œì¤˜.

</p>

<p>ì¢‹ì•„, â€œì§„ì§œ í•„ìš”í•œ ê²ƒë§Œâ€ ë‚¨ê²¨ì„œ ë”± 2ê°œ í´ë˜ìŠ¤ë¡œ ì •ë¦¬í–ˆì–´:</p>

<ul>
  <li>
    <p><strong>DiskJSONCache</strong> : ë©€í‹°í”„ë¡œì„¸ìŠ¤ ê³µìœ  ë””ìŠ¤í¬ ìºì‹œ(ì›ìì  replace + fsync + mtime/ts ì´ì¤‘ íŒì •)</p>
  </li>
  <li>
    <p><strong>LSFClient</strong> : ë‚˜ë¨¸ì§€ ì „ë¶€(ì»¤ë§¨ë“œ ì‹¤í–‰, Job ID íŒŒì‹±, bkill, bjobs ìŠ¤ëƒ…ìƒ· ë©”ëª¨ë¦¬/ë””ìŠ¤í¬ ìºì‹œ, ë ˆì´íŠ¸ë¦¬ë°‹, ì¼ê´„ ì œì¶œ+ì·¨ì†Œ)</p>
  </li>
</ul>

<p>í•„ìˆ˜ ê¸°ëŠ¥ë§Œ ë‹´ì•˜ê³ , <code class="language-plaintext highlighter-rouge">create_subprocess_shell</code>ë§Œ ì‚¬ìš©í•´. ì¡ íŒë³„ì€ ì˜¤ì§ ì¶œë ¥ì˜ <code class="language-plaintext highlighter-rouge">Job &lt;id&gt;</code>ë¡œ í•´.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># lsf_minimal.py
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>
<span class="kn">import</span> <span class="n">getpass</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="n">StrOrSeq</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
<span class="n">_JOBID_RE</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">str ë˜ëŠ” ì‹œí€€ìŠ¤ë¥¼ ë°›ì•„ ì…¸ ë¬¸ìì—´ë¡œ. (ì‹œí€€ìŠ¤ë©´ ê³µë°± join; ì¸ìš©ì€ í˜¸ì¶œì ì±…ì„)</span><span class="sh">"""</span>
    <span class="k">return</span> <span class="n">cmd</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="nb">RuntimeError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Command failed: </span><span class="si">{</span><span class="n">cmd_str</span><span class="si">}</span><span class="s"> (rc=</span><span class="si">{</span><span class="n">returncode</span><span class="si">}</span><span class="s">)</span><span class="se">\n</span><span class="si">{</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">cmd_str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span>

<span class="c1"># ---------- ë©€í‹°í”„ë¡œì„¸ìŠ¤ ê³µìœ  ë””ìŠ¤í¬ ìºì‹œ ----------
</span><span class="k">class</span> <span class="nc">DiskJSONCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    tmp -&gt; fsync(tmp) -&gt; os.replace() -&gt; fsync(dir)
    - ê°™ì€ íŒŒì¼ì‹œìŠ¤í…œ ë‚´ renameì€ ì›ìì .
    - ì‹ ì„ ë„ íŒë‹¨: íŒŒì¼ ë‚´ë¶€ tsì™€ íŒŒì¼ mtime ëª¨ë‘ í™•ì¸(+2s skew í—ˆìš©).
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ttl_sec</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">skew_eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_skew</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">skew_eps</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_path</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">stat</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">age_by_ts</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">ts</span><span class="p">)</span> <span class="k">if</span> <span class="n">ts</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nf">float</span><span class="p">(</span><span class="sh">"</span><span class="s">inf</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">age_by_mtime</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">now</span> <span class="o">-</span> <span class="n">st</span><span class="p">.</span><span class="n">st_mtime</span><span class="p">)</span>
            <span class="n">fresh</span> <span class="o">=</span> <span class="p">(</span><span class="n">age_by_ts</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">age_by_mtime</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span> <span class="k">if</span> <span class="n">fresh</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_path</span><span class="p">)</span>
        <span class="n">dir_fd</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fd</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="p">.</span><span class="nf">mkstemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="sh">"</span><span class="s">bjobs_</span><span class="sh">"</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">"</span><span class="s">.json</span><span class="sh">"</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">fdopen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">},</span> <span class="n">f</span><span class="p">)</span>
                    <span class="n">f</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="nf">fileno</span><span class="p">())</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_path</span><span class="p">)</span>  <span class="c1"># atomic on same FS
</span>                <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">FileNotFoundError</span><span class="p">):</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>

<span class="c1"># ---------- ë©”ì¸ í´ë¼ì´ì–¸íŠ¸ ----------
</span><span class="k">class</span> <span class="nc">LSFClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ê¼­ í•„ìš”í•œ ê²ƒë§Œ:
      - run_command_capture_job: ì»¤ë§¨ë“œ ê·¸ëŒ€ë¡œ ì‹¤í–‰, ì¶œë ¥ì—ì„œ Job &lt;id&gt;ë§Œ íŒŒì‹±
      - kill: bkill (ì—¬ëŸ¬ ID í•œ ë²ˆì—)
      - status: bjobs ì „ì²´ ìŠ¤ëƒ…ìƒ· (ë©”ëª¨ë¦¬+ë””ìŠ¤í¬ ìºì‹œ, ë ˆì´íŠ¸ë¦¬ë°‹)
      - submit_many_with_cancel: ì¸í„°ëŸ½íŠ¸ ì‹œ ìƒˆ ì‹¤í–‰ ì¤‘ë‹¨, ì§„í–‰ë¶„ ì™„ì£¼ í›„ job_id ì¼ê´„ bkill
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">bkill</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">bjobs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">max_concurrent_cli</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">bjobs_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_paths</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">:</span> <span class="n">bkill</span><span class="p">,</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">:</span> <span class="n">bjobs</span><span class="p">}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">max_concurrent_cli</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_min_interval</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_min_interval_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="c1"># ë©”ëª¨ë¦¬ ìºì‹œ(key -&gt; (ts, data))
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_mem_cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># ë‹¨ì¼í”Œë¼ì´íŠ¸
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># ê³µìœ  ë””ìŠ¤í¬ ìºì‹œ
</span>        <span class="n">user</span> <span class="o">=</span> <span class="n">user</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LSF_USER</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">getpass</span><span class="p">.</span><span class="nf">getuser</span><span class="p">()</span>
        <span class="n">base_cache</span> <span class="o">=</span> <span class="n">cache_dir</span> <span class="ow">or</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">XDG_CACHE_HOME</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">expanduser</span><span class="p">(</span><span class="sh">"</span><span class="s">~</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">.cache</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">cache_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base_cache</span><span class="p">,</span> <span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all_</span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_disk</span> <span class="o">=</span> <span class="nc">DiskJSONCache</span><span class="p">(</span><span class="n">cache_path</span><span class="p">,</span> <span class="n">ttl_sec</span><span class="o">=</span><span class="n">disk_cache_ttl_sec</span><span class="p">,</span> <span class="n">skew_eps</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_user</span> <span class="o">=</span> <span class="n">user</span>

        <span class="c1"># locale ì•ˆì •í™”
</span>        <span class="n">base_env</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LC_ALL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LANG</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_env</span> <span class="o">=</span> <span class="n">base_env</span> <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="bp">None</span> <span class="nf">else </span><span class="p">(</span><span class="n">base_env</span> <span class="o">|</span> <span class="n">env</span><span class="p">)</span>

    <span class="c1"># ---- ë‚´ë¶€ í—¬í¼ ----
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_run_shell</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_sem</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_shell</span><span class="p">(</span>
                <span class="n">cmd_str</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_env</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ProcessLookupError</span><span class="p">):</span>
                <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>

    <span class="c1"># ---- ì»¤ë§¨ë“œ ì‹¤í–‰(ì¡ ë©”ì‹œì§€ íŒŒì‹±) ----
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_command_capture_job</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">cmd_str</span> <span class="o">=</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_run_shell</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">raise_on_error</span> <span class="ow">and</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">stdout</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">stderr</span><span class="p">,</span> <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span> <span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">job_id</span><span class="p">}</span>

    <span class="c1"># ---- bkill ----
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">job_ids</span><span class="p">))]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">""</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-f </span><span class="sh">"</span> <span class="k">if</span> <span class="n">force</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bkill</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">flag</span><span class="si">}{</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_run_shell</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">raise_on_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span>

    <span class="c1"># ---- bjobs ì „ì²´ ìŠ¤ëƒ…ìƒ· (ìºì‹œ) ----
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="c1"># ë ˆì´íŠ¸ë¦¬ë°‹
</span>        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">since</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span>
        <span class="k">if</span> <span class="n">since</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_min_interval</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_min_interval</span> <span class="o">-</span> <span class="n">since</span><span class="p">)</span>

        <span class="n">flag</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-a </span><span class="sh">"</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="c1"># ê³µë°± ì•ˆì „í•œ í•„ë“œë§Œ
</span>        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bjobs</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> -noheader -u </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s">-o </span><span class="sh">'</span><span class="s">jobid stat exit_code queue exec_host</span><span class="sh">'"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_run_shell</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

        <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">exec_host</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">jid_i</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">result</span><span class="p">[</span><span class="n">jid_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="n">stat</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="sh">"</span><span class="s">-</span><span class="sh">"</span> <span class="k">else</span> <span class="n">exit_code</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="n">queue</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="n">exec_host</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_status_all_cached</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span> <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all|</span><span class="si">{</span><span class="sh">'</span><span class="s">-a</span><span class="sh">'</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">''</span><span class="si">}</span><span class="sh">"</span>
        <span class="c1"># ë©”ëª¨ë¦¬ ìºì‹œ
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem_cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">item</span><span class="p">:</span>
                <span class="n">ts</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">item</span>
                <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">data</span>
            <span class="c1"># ë‹¨ì¼í”Œë¼ì´íŠ¸
</span>            <span class="n">inflight</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inflight</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">inflight</span>

        <span class="n">fut</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">().</span><span class="nf">create_future</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fut</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
                <span class="n">disk</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_disk</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">disk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">disk</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_mem_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
                    <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">data</span>

            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_mem_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_disk</span><span class="p">.</span><span class="nf">write</span><span class="p">({</span><span class="nf">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">items</span><span class="p">()})</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">status</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">all_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_status_all_cached</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="n">force_refresh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job_ids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_map</span>
        <span class="n">wanted</span> <span class="o">=</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">all_map</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">wanted</span><span class="p">}</span>

    <span class="c1"># ---- ë°°ì¹˜ ì œì¶œ + ì·¨ì†Œ ----
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">commands</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">StrOrSeq</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="p">:</span> <span class="nb">callable</span><span class="p">,</span>            <span class="c1"># () -&gt; bool
</span>        <span class="n">poll_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">kill_force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">kill_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">cmd_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        ëª…ë ¹ì„ ê·¸ëŒ€ë¡œ ì‹¤í–‰(create_subprocess_shell). ì¶œë ¥ì—ì„œ </span><span class="sh">'</span><span class="s">Job &lt;id&gt;</span><span class="sh">'</span><span class="s">ë§Œ ì¶”ì¶œ.
        ì¸í„°ëŸ½íŠ¸ ì‹œ ìƒˆ ì‹¤í–‰ ì¤‘ë‹¨, ì§„í–‰ ì¤‘ ì œì¶œì€ ëê¹Œì§€ ê¸°ë‹¤ë¦° ë’¤ ìˆ˜ì§‘ëœ job_id ì¼ê´„ bkill.
        </span><span class="sh">"""</span>
        <span class="n">submitted</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">in_flight</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">run_command_capture_job</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">cmd_timeout</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">cmd_raise_on_error</span><span class="p">)</span>

        <span class="n">idx</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">or</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">in_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_in_flight</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">is_interrupted</span><span class="p">():</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">run_one</span><span class="p">(</span><span class="n">commands</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
                    <span class="n">in_flight</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                    <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll_interval_sec</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                        <span class="n">in_flight</span><span class="p">.</span><span class="nf">discard</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                            <span class="n">jid</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">jid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="n">submitted</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">poll_interval_sec</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># drain
</span>            <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">ALL_COMPLETED</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                        <span class="n">jid</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">jid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">submitted</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">interrupted</span> <span class="o">=</span> <span class="nf">is_interrupted</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">interrupted</span> <span class="ow">and</span> <span class="n">submitted</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">submitted</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">kill_force</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">kill_raise_on_error</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">submitted_job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">submitted</span><span class="p">,</span> <span class="sh">"</span><span class="s">interrupted</span><span class="sh">"</span><span class="p">:</span> <span class="n">interrupted</span><span class="p">,</span> <span class="sh">"</span><span class="s">num_submitted</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">submitted</span><span class="p">),</span> <span class="sh">"</span><span class="s">num_failed</span><span class="sh">"</span><span class="p">:</span> <span class="n">failures</span><span class="p">}</span>
</code></pre></div></div>

<h3 id="ë¹ ë¥¸-ì‚¬ìš©-ì˜ˆ-í•„ìš”ë¶€ë¶„ë§Œ">ë¹ ë¥¸ ì‚¬ìš© ì˜ˆ (í•„ìš”ë¶€ë¶„ë§Œ)</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># example_min.py
</span><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">lsf_minimal</span> <span class="kn">import</span> <span class="n">LSFClient</span>

<span class="k">class</span> <span class="nc">Token</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span> <span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">delay</span>
    <span class="k">def</span> <span class="nf">is_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">):</span> <span class="nf">return </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span><span class="o">-</span><span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">LSFClient</span><span class="p">(</span>
        <span class="n">max_concurrent_cli</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">bjobs_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="o">=</span><span class="sh">"</span><span class="s">/shared/cache</span><span class="sh">"</span><span class="p">,</span>  <span class="c1"># ì—¬ëŸ¬ ë¨¸ì‹ ì´ ë³´ëŠ” ê²½ë¡œ
</span>    <span class="p">)</span>

    <span class="c1"># 1) ì»¤ë§¨ë“œ ê·¸ëŒ€ë¡œ ì‹¤í–‰ (ì¡ ë©”ì‹œì§€ ìˆìœ¼ë©´ job_id íŒŒì‹±)
</span>    <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">run_command_capture_job</span><span class="p">(</span><span class="sh">"</span><span class="s">bsub -q short </span><span class="sh">'</span><span class="s">echo hi; sleep 1</span><span class="sh">'"</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">submit:</span><span class="sh">"</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

    <span class="c1"># 2) ìƒíƒœ (ì „ì²´ ìŠ¤ëƒ…ìƒ· ìºì‹œ)
</span>    <span class="n">all_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs:</span><span class="sh">"</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">all_map</span><span class="p">))</span>

    <span class="c1"># 3) ë°°ì¹˜ ì œì¶œ + 3ì´ˆ í›„ ì·¨ì†Œ
</span>    <span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">sleep 1</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">bsub -q short </span><span class="sh">'</span><span class="s">echo X; sleep 2</span><span class="sh">'"</span><span class="p">,</span> <span class="sh">"</span><span class="s">job_sub my_script.sh --epochs 3</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">cmds</span><span class="p">,</span> <span class="n">is_interrupted</span><span class="o">=</span><span class="nc">Token</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="n">is_interrupted</span><span class="p">,</span> <span class="n">max_in_flight</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">cmd_timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">kill_force</span><span class="o">=</span><span class="bp">True</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">batch:</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<h3 id="ì™œ-ì´ë ‡ê²Œ-ìµœì†Œí™”í–ˆëŠ”ì§€-step-by-step">ì™œ ì´ë ‡ê²Œ ìµœì†Œí™”í–ˆëŠ”ì§€ (step-by-step)</h3>

<ol>
  <li>
    <p><strong>í•µì‹¬ ì±…ì„ 2ê°œë§Œ ë¶„ë¦¬</strong> : â€œë””ìŠ¤í¬ ìºì‹œâ€ëŠ” ë©€í‹°í”„ë¡œì„¸ìŠ¤/ë©€í‹°ë¨¸ì‹  ì•ˆì „ì„±ì´ í•µì‹¬ì´ë¼ ë…ë¦½ í´ë˜ìŠ¤ë¡œ ìœ ì§€, ë‚˜ë¨¸ì§€ëŠ” <code class="language-plaintext highlighter-rouge">LSFClient</code>ì—.</p>
  </li>
  <li>
    <p><strong>í•œ ëˆˆì— ì½íˆëŠ” íë¦„</strong> : ì‹¤í–‰ â†’ íŒŒì‹± â†’ ìºì‹œ â†’ ë ˆì´íŠ¸ë¦¬ë°‹ â†’ ë°°ì¹˜/ì·¨ì†Œê¹Œì§€ <code class="language-plaintext highlighter-rouge">LSFClient</code> ì•ˆì—ì„œ ì¶”ì  ê°€ëŠ¥.</p>
  </li>
  <li>
    <p><strong>ìš´ì˜ í˜„ì‹¤ ë°˜ì˜</strong> : ê³µìœ  FSì— ë§ì¶˜ <code class="language-plaintext highlighter-rouge">os.replace + fsync(dir)</code>ì™€ <code class="language-plaintext highlighter-rouge">mtime/ts</code> ì´ì¤‘ íŒì •, TTL ê¸°ë³¸ 5së¡œ ì•ˆì „í•œ ë””í´íŠ¸.</p>
  </li>
</ol>

<p>ë” ì¤„ì´ê³  ì‹¶ìœ¼ë©´ <code class="language-plaintext highlighter-rouge">DiskJSONCache</code>ë„ ë‚´ë¶€ í•¨ìˆ˜ë¡œ ì ‘ì–´ë‘˜ ìˆ˜ ìˆì§€ë§Œ, ë©€í‹°í”„ë¡œì„¸ìŠ¤ ì•ˆì „ì„±ì˜ ê²°ë¡œê°€ ë¶„ëª…í•´ì„œ ì´ ì •ë„ ë¶„ë¦¬ê°€ â€œì§„ì§œ í•„ìš”í•œ ìµœì†Œâ€ë¼ ë´¤ì–´. í•„ìš”í•˜ë©´ ë¡œê¹… í›…ë§Œ ì‚´ì§ ì¶”ê°€í•´ë“œë¦´ê²Œ!</p>

<p class="chat--user">

ì§„ì§œ í•„ìš”í•œ ìµœì†Œë¡œë„ í•˜ì§€ë§ê³ , ë„ˆë¬´ ê³¼í•˜ê²Œ ëŠ˜ë¦¬ì§€ë„ ë§ê³ . ê·¸ëƒ¥ ê³ ìˆ˜ê°€ í–ˆì„ ë²•í•œ ìœ ì§€ë³´ìˆ˜ í• ë§Œí•œ ì •ë„ë¡œ ì§œì£¼ë©´ ë¼. ë„ˆê°€ ìƒê°í•˜ëŠ” ìµœì ì„ ë”°ë¼ì¤˜.

</p>

<p>ì¢‹ì•„, â€œì ë‹¹íˆ ìª¼ê°  í”„ë¡œâ€ ë²„ì „ìœ¼ë¡œ ì •ë¦¬í–ˆì–´.<br />
í•µì‹¬ë§Œ 3íŒŒì¸ ë¡œ ë‚˜ëˆ´ê³ , ê³¼í•˜ì§€ ì•Šê²Œ ìœ ì§€ë³´ìˆ˜ ìš©ì´í•˜ë„ë¡ êµ¬ì„±í–ˆì–´.</p>

<ul>
  <li>
    <p><strong>ShellRunner</strong> : <code class="language-plaintext highlighter-rouge">create_subprocess_shell</code> + ë™ì‹œì„± ì œì–´</p>
  </li>
  <li>
    <p><strong>SharedCache</strong> : ë©”ëª¨ë¦¬+ë””ìŠ¤í¬(ë©€í‹°í”„ë¡œì„¸ìŠ¤ ê³µìœ ) TTL ìºì‹œ â€” tmpâ†’<code class="language-plaintext highlighter-rouge">os.replace</code>â†’<code class="language-plaintext highlighter-rouge">fsync(dir)</code>ë¡œ ê²¬ê³ </p>
  </li>
  <li>
    <p><strong>LSFClient</strong> : ì‚¬ìš©ì API (ì»¤ë§¨ë“œ ì‹¤í–‰Â·JobID íŒŒì‹±, <code class="language-plaintext highlighter-rouge">bkill</code>, <code class="language-plaintext highlighter-rouge">bjobs</code> ìŠ¤ëƒ…ìƒ·+ìºì‹œ, ë°°ì¹˜ ì œì¶œ+ì·¨ì†Œ)</p>
  </li>
</ul>

<p>ì•„ë˜ íŒŒì¼ í•˜ë‚˜ë©´ ë. (<code class="language-plaintext highlighter-rouge">lsf_core.py</code> ê°™ì€ ì´ë¦„ìœ¼ë¡œ ì €ì¥)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># lsf_core.py
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>
<span class="kn">import</span> <span class="n">getpass</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1"># ===================== ê³µìš© ìœ í‹¸ =====================
</span>
<span class="n">StrOrSeq</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
<span class="n">_JOBID_RE</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">cmd</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="nb">RuntimeError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Command failed: </span><span class="si">{</span><span class="n">cmd_str</span><span class="si">}</span><span class="s"> (rc=</span><span class="si">{</span><span class="n">returncode</span><span class="si">}</span><span class="s">)</span><span class="se">\n</span><span class="si">{</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">cmd_str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span>

<span class="c1"># ===================== ShellRunner =====================
</span>
<span class="k">class</span> <span class="nc">ShellRunner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">create_subprocess_shellë§Œ ì‚¬ìš©. ë™ì‹œ ì‹¤í–‰ ìˆ˜ë¥¼ ì„¸ë§ˆí¬ì–´ë¡œ ì œí•œ.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">max_concurrency</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">max_concurrency</span><span class="p">)</span>
        <span class="n">base_env</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LC_ALL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LANG</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_env</span> <span class="o">=</span> <span class="n">base_env</span> <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="bp">None</span> <span class="nf">else </span><span class="p">(</span><span class="n">base_env</span> <span class="o">|</span> <span class="n">env</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_sem</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_shell</span><span class="p">(</span>
                <span class="n">cmd_str</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_env</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ProcessLookupError</span><span class="p">):</span>
                <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>

<span class="c1"># ===================== SharedCache (mem+disk) =====================
</span>
<span class="k">class</span> <span class="nc">SharedCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ë©€í‹°í”„ë¡œì„¸ìŠ¤ ê³µìœ  JSON ìºì‹œ:
    - ë©”ëª¨ë¦¬ TTL + ë””ìŠ¤í¬ TTL (ê°™ì€ FS ë‚´ rename ì›ìì„± ë³´ì¥)
    - ì“°ê¸°: tmp -&gt; fsync(tmp) -&gt; os.replace -&gt; fsync(dir)
    - ì‹ ì„ ë„: JSON ë‚´ë¶€ tsì™€ íŒŒì¼ mtime ëª¨ë‘ ì‚¬ìš©(+2s skew í—ˆìš©)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ttl_sec</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">,</span> <span class="n">skew_eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">cache_dir</span> <span class="ow">or</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">XDG_CACHE_HOME</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">expanduser</span><span class="p">(</span><span class="sh">"</span><span class="s">~</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">.cache</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_root</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_skew</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">skew_eps</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_key_path</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">safe</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">[^A-Za-z0-9._-]+</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">safe</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># 1) ë©”ëª¨ë¦¬
</span>        <span class="n">item</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">:</span>
            <span class="n">ts</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="c1"># 2) ë””ìŠ¤í¬
</span>        <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_key_path</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">stat</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="n">ts_in</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">fresh_by_ts</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">ts_in</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">)</span> <span class="k">if</span> <span class="n">ts_in</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">False</span>
            <span class="n">fresh_by_mtime</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="nf">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">st</span><span class="p">.</span><span class="n">st_mtime</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fresh_by_ts</span> <span class="ow">or</span> <span class="n">fresh_by_mtime</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_key_path</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">dir_fd</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fd</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="p">.</span><span class="nf">mkstemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="sh">"</span><span class="s">cache_</span><span class="sh">"</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">"</span><span class="s">.json</span><span class="sh">"</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">fdopen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">},</span> <span class="n">f</span><span class="p">)</span>
                    <span class="n">f</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="nf">fileno</span><span class="p">())</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">FileNotFoundError</span><span class="p">):</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>

<span class="c1"># ===================== LSFClient (Public API) =====================
</span>
<span class="k">class</span> <span class="nc">LSFClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - run_command_capture_job: ì»¤ë§¨ë“œë¥¼ ê·¸ëŒ€ë¡œ ì‹¤í–‰, ì¶œë ¥ì—ì„œ </span><span class="sh">'</span><span class="s">Job &lt;id&gt;</span><span class="sh">'</span><span class="s">ë§Œ íŒŒì‹±
    - kill: bkill (ì—¬ëŸ¬ ID ì¼ê´„)
    - status: bjobs ì „ì²´ ìŠ¤ëƒ…ìƒ·(ë©”ëª¨ë¦¬+ë””ìŠ¤í¬ ìºì‹œ, ë ˆì´íŠ¸ë¦¬ë°‹, in-process single-flight)
    - submit_many_with_cancel: ì¸í„°ëŸ½íŠ¸ ì‹œ ìƒˆ ì‹¤í–‰ ì¤‘ë‹¨, ì§„í–‰ ì¤‘ì€ ì™„ì£¼ â†’ ìˆ˜ì§‘í•œ job_id ì¼ê´„ bkill
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">bkill</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">bjobs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">max_concurrent_cli</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">bjobs_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_paths</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">:</span> <span class="n">bkill</span><span class="p">,</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">:</span> <span class="n">bjobs</span><span class="p">}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_runner</span> <span class="o">=</span> <span class="nc">ShellRunner</span><span class="p">(</span><span class="n">max_concurrent_cli</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_user</span> <span class="o">=</span> <span class="n">user</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LSF_USER</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">getpass</span><span class="p">.</span><span class="nf">getuser</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="nc">SharedCache</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">ttl_sec</span><span class="o">=</span><span class="n">disk_cache_ttl_sec</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">,</span> <span class="n">skew_eps</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>

        <span class="c1"># bjobs ì œì–´
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_min_interval_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># single-flight per key
</span>
    <span class="c1"># ---------- ì¼ë°˜ ì»¤ë§¨ë“œ ì‹¤í–‰ + Job ID íŒŒì‹± ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_command_capture_job</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">raise_on_error</span> <span class="ow">and</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">stdout</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">stderr</span><span class="p">,</span> <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span> <span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">job_id</span><span class="p">}</span>

    <span class="c1"># ---------- bkill ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">job_ids</span><span class="p">))]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">""</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-f </span><span class="sh">"</span> <span class="k">if</span> <span class="n">force</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bkill</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">flag</span><span class="si">}{</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">raise_on_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span>

    <span class="c1"># ---------- bjobs snapshot (ìºì‹œ + ë‹¨ì¼í”Œë¼ì´íŠ¸ + ë ˆì´íŠ¸ë¦¬ë°‹) ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="c1"># per-process rate-limit
</span>        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">since</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span>
        <span class="k">if</span> <span class="n">since</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">-</span> <span class="n">since</span><span class="p">)</span>

        <span class="n">flag</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-a </span><span class="sh">"</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="c1"># ê³µë°± ì•ˆì „ í•„ë“œë§Œ
</span>        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bjobs</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> -noheader -u </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s">-o </span><span class="sh">'</span><span class="s">jobid stat exit_code queue exec_host</span><span class="sh">'"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

        <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">exec_host</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">jid_i</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">result</span><span class="p">[</span><span class="n">jid_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="n">stat</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="sh">"</span><span class="s">-</span><span class="sh">"</span> <span class="k">else</span> <span class="n">exit_code</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="n">queue</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="n">exec_host</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_status_all_cached</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all|</span><span class="si">{</span><span class="sh">'</span><span class="s">-a</span><span class="sh">'</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">''</span><span class="si">}</span><span class="s">|user=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="sh">"</span>

        <span class="c1"># 1) ë©”ëª¨ë¦¬/ë””ìŠ¤í¬ ìºì‹œ
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
            <span class="n">cached</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cached</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># ë””ìŠ¤í¬Â·ë©”ëª¨ë¦¬ ìºì‹œëŠ” ì§ì „ì— setëœ dict(str-&gt;obj)ì¼ ìˆ˜ ìˆìŒ
</span>                <span class="k">return</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">cached</span><span class="p">.</span><span class="nf">items</span><span class="p">()</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cached</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])}</span>

            <span class="c1"># 2) in-process single-flight
</span>            <span class="n">inflight</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inflight</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">inflight</span>

        <span class="n">fut</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">().</span><span class="nf">create_future</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fut</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">items</span><span class="p">()})</span>  <span class="c1"># ë””ìŠ¤í¬ì—” str keyë¡œ ì €ì¥
</span>            <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">status</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">all_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_status_all_cached</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="n">force_refresh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job_ids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_map</span>
        <span class="n">wanted</span> <span class="o">=</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">all_map</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">wanted</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">status_union_batched</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">list_of_job_id_sets</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
        <span class="n">union</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="n">normalized</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">list_of_job_id_sets</span><span class="p">:</span>
            <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>
            <span class="n">normalized</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
            <span class="n">union</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
        <span class="n">union_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">union</span><span class="p">,</span> <span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="n">force_refresh</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[{</span><span class="n">i</span><span class="p">:</span> <span class="n">union_map</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req</span><span class="p">}</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">normalized</span><span class="p">]</span>

    <span class="c1"># ---------- ë°°ì¹˜ ì œì¶œ + ì·¨ì†Œ ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">commands</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">StrOrSeq</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="p">:</span> <span class="nb">callable</span><span class="p">,</span>            <span class="c1"># () -&gt; bool
</span>        <span class="n">poll_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">kill_force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">kill_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">cmd_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        ì»¤ë§¨ë“œë¥¼ ê·¸ëŒ€ë¡œ ì‹¤í–‰. ì¶œë ¥ì˜ </span><span class="sh">'</span><span class="s">Job &lt;id&gt;</span><span class="sh">'</span><span class="s">ë§Œ ì¶”ì¶œí•´ ìˆ˜ì§‘.
        ì¸í„°ëŸ½íŠ¸ ì‹œ: ìƒˆ ì‹¤í–‰ ì¤‘ë‹¨, ì§„í–‰ ì¤‘ ì œì¶œì€ ëê¹Œì§€ ê¸°ë‹¤ë¦¼(ê³ ì•„ ë°©ì§€) â†’ ìˆ˜ì§‘ëœ job_id ì¼ê´„ bkill.
        </span><span class="sh">"""</span>
        <span class="n">submitted</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">in_flight</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">run_command_capture_job</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">cmd_timeout</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">cmd_raise_on_error</span><span class="p">)</span>

        <span class="n">idx</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">or</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">in_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_in_flight</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">is_interrupted</span><span class="p">():</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">run_one</span><span class="p">(</span><span class="n">commands</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
                    <span class="n">in_flight</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                    <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll_interval_sec</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                        <span class="n">in_flight</span><span class="p">.</span><span class="nf">discard</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                            <span class="n">jid</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">jid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="n">submitted</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">poll_interval_sec</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># drain: ë‚¨ì€ ì œì¶œì€ ì™„ì£¼ì‹œì¼œ Job ID ìˆ˜ì§‘
</span>            <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">ALL_COMPLETED</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                        <span class="n">jid</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">jid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">submitted</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">interrupted</span> <span class="o">=</span> <span class="nf">is_interrupted</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">interrupted</span> <span class="ow">and</span> <span class="n">submitted</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">submitted</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">kill_force</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">kill_raise_on_error</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">submitted_job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">submitted</span><span class="p">,</span> <span class="sh">"</span><span class="s">interrupted</span><span class="sh">"</span><span class="p">:</span> <span class="n">interrupted</span><span class="p">,</span> <span class="sh">"</span><span class="s">num_submitted</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">submitted</span><span class="p">),</span> <span class="sh">"</span><span class="s">num_failed</span><span class="sh">"</span><span class="p">:</span> <span class="n">failures</span><span class="p">}</span>
</code></pre></div></div>

<h3 id="ì‚¬ìš©-ì˜ˆ-ì§§ê²Œ">ì‚¬ìš© ì˜ˆ (ì§§ê²Œ)</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">lsf_core</span> <span class="kn">import</span> <span class="n">LSFClient</span>

<span class="k">class</span> <span class="nc">Token</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span> <span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">delay</span>
    <span class="k">def</span> <span class="nf">is_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">):</span> <span class="nf">return </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span><span class="o">-</span><span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">LSFClient</span><span class="p">(</span>
        <span class="n">max_concurrent_cli</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">bjobs_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="o">=</span><span class="sh">"</span><span class="s">/shared/cache</span><span class="sh">"</span><span class="p">,</span>  <span class="c1"># ì—¬ëŸ¬ ë¨¸ì‹ ì´ ë³´ëŠ” ê²½ë¡œ(ê°™ì€ FS)
</span>    <span class="p">)</span>

    <span class="c1"># 1) ì»¤ë§¨ë“œ ê·¸ëŒ€ë¡œ ì‹¤í–‰ (ì¡ ë©”ì‹œì§€ ìˆìœ¼ë©´ íŒŒì‹±)
</span>    <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">run_command_capture_job</span><span class="p">(</span><span class="sh">"</span><span class="s">bsub -q short </span><span class="sh">'</span><span class="s">echo hi; sleep 1</span><span class="sh">'"</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">submit:</span><span class="sh">"</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

    <span class="c1"># 2) bjobs ìƒíƒœ(ìŠ¤ëƒ…ìƒ· ìºì‹œ)
</span>    <span class="n">all_jobs</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">N(all) =</span><span class="sh">"</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">all_jobs</span><span class="p">))</span>

    <span class="c1"># 3) ë°°ì¹˜ ì œì¶œ + 3ì´ˆ í›„ ì·¨ì†Œ â†’ ìˆ˜ì§‘ëœ job_id ì¼ê´„ bkill
</span>    <span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">sleep 1</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">bsub -q short </span><span class="sh">'</span><span class="s">echo X; sleep 2</span><span class="sh">'"</span><span class="p">,</span> <span class="sh">"</span><span class="s">job_sub my_script.sh --epochs 3</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">cmds</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="o">=</span><span class="nc">Token</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="n">is_interrupted</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
        <span class="n">kill_force</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">batch:</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<h3 id="ì™œ-ì´-êµ¬ì„±ì´-ì ë‹¹íˆ-ê³ ìˆ˜-ëŠë‚Œì¸ê°€-ì§§ê²Œ-step-by-step">ì™œ ì´ êµ¬ì„±ì´ â€œì ë‹¹íˆ ê³ ìˆ˜ ëŠë‚Œâ€ì¸ê°€ (ì§§ê²Œ, step-by-step)</h3>

<ol>
  <li>
    <p><strong>ì—­í•  ë¶„ë¦¬ ìµœì†Œí™”</strong> : í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ê³¼ ìºì‹œë§Œ ë³„ë„ í´ë˜ìŠ¤ë¡œ ë¶„ë¦¬. ë‚˜ë¨¸ì§€ëŠ” <code class="language-plaintext highlighter-rouge">LSFClient</code>ì—ì„œ í•œ ëˆˆì— ì¶”ì .</p>
  </li>
  <li>
    <p><strong>ìš´ì˜ ì•ˆì „ì„±</strong> : ê³µìœ  FSì—ì„œ <strong>tmpâ†’replaceâ†’fsync(dir)</strong> , TTLì€ <strong>ts+mtime ì´ì¤‘ íŒì •</strong>.</p>
  </li>
  <li>
    <p><strong>ì„±ëŠ¥/ë¶€í•˜ ë°°ë ¤</strong> : in-process <strong>single-flight</strong> , per-process <strong>ë ˆì´íŠ¸ë¦¬ë°‹</strong> , <strong>ì „ì²´ ìŠ¤ëƒ…ìƒ·</strong> í›„ í•„í„°ë¡œ <code class="language-plaintext highlighter-rouge">bjobs</code> í˜¸ì¶œ ìµœì†Œí™”.</p>
  </li>
  <li>
    <p><strong>í˜„ì‹¤ ì¹œí™”ì„±</strong> : ì»¤ë§¨ë“œë¥¼ <strong>ìˆëŠ” ê·¸ëŒ€ë¡œ</strong> ì‹¤í–‰, <code class="language-plaintext highlighter-rouge">Job &lt;id&gt;</code> ë©”ì‹œì§€ë¡œë§Œ íŒë³„ â†’ bsub ë˜í¼/ìŠ¤í¬ë¦½íŠ¸ ëª¨ë‘ ì»¤ë²„.</p>
  </li>
  <li>
    <p><strong>í™•ì¥ ì—¬ì§€</strong> : í•„ìš” ì‹œ ë¡œê¹…/ë©”íŠ¸ë¦­, ê°•ì œ ìƒˆë¡œê³ ì¹¨(<code class="language-plaintext highlighter-rouge">force_refresh</code>) í›…, ìƒ¤ë”© ë“± ì‰½ê²Œ ì¶”ê°€ ê°€ëŠ¥.</p>
  </li>
</ol>

<p>ì›í•˜ëŠ” ìŠ¤íƒ€ì¼ì´ë‚˜ ì½”ë”© ì»¨ë²¤ì…˜(ë¡œê±°, íƒ€ì…íŒíŠ¸ ë ˆë²¨ ê°•í™”, ì—ëŸ¬ì½”ë“œ ë§¤í•‘ ë“±)ì´ ìˆìœ¼ë©´ ê±°ê¸°ì— ë§ì¶° ë”± ë§ê²Œ ë‹¤ë“¬ì–´ì¤„ê²Œ.</p>

<p class="chat--user">

ê·¼ë° bkillì— -f ì˜µì…˜ ì—†ëŠ”ë°

</p>

<p>ë§ì•„ìš”. ì œ ì‹¤ìˆ˜ì…ë‹ˆë‹¤â€”<code class="language-plaintext highlighter-rouge">bkill</code>ì—ëŠ” <code class="language-plaintext highlighter-rouge">-f</code>ê°€ ì—†ìŠµë‹ˆë‹¤. â€œê°•ì œâ€ì— í•´ë‹¹í•˜ëŠ” ê±´ <strong><code class="language-plaintext highlighter-rouge">-r</code>(force remove)</strong> ì´ê³ , ìƒí™©ì— ë”°ë¼ <strong><code class="language-plaintext highlighter-rouge">-d</code>(kill í›„ ìƒíƒœë¥¼ DONEìœ¼ë¡œ ê¸°ë¡)</strong>, <strong><code class="language-plaintext highlighter-rouge">-s</code>(íŠ¹ì • signal ì „ì†¡)</strong> ë“±ì„ ì”ë‹ˆë‹¤. <a href="https://www.ibm.com/docs/en/spectrum-lsf/10.1.0?topic=jobs-forcefully-removing-job-from-lsf&amp;utm_source=chatgpt.com">IBM+1</a></p>

<p>ì•„ë˜ì²˜ëŸ¼ <strong>ë©”ì„œë“œ ì‹œê·¸ë‹ˆì²˜ì™€ êµ¬í˜„ì„ ê³ ì³</strong> ì“°ë©´ ë©ë‹ˆë‹¤.</p>

<h2 id="step-1-kill-ë©”ì„œë“œ-êµì²´">Step 1) <code class="language-plaintext highlighter-rouge">kill()</code> ë©”ì„œë“œ êµì²´</h2>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">force</code> ëŒ€ì‹  <code class="language-plaintext highlighter-rouge">force_remove</code>(â†’ <code class="language-plaintext highlighter-rouge">-r</code>)</p>
  </li>
  <li>
    <p>í•„ìš” ì‹œ <code class="language-plaintext highlighter-rouge">record_done</code>(â†’ <code class="language-plaintext highlighter-rouge">-d</code>)</p>
  </li>
  <li>
    <p>ì„ì˜ ì‹œê·¸ë„ì€ <code class="language-plaintext highlighter-rouge">signal</code>(â†’ <code class="language-plaintext highlighter-rouge">-s SIG</code>)ë¡œ ì§€ì •</p>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># LSFClient.kill êµì²´ ë²„ì „
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span>
    <span class="n">self</span><span class="p">,</span>
    <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">force_remove</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>          <span class="c1"># was: force
</span>    <span class="n">record_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>           <span class="c1"># -&gt; -d (RUN/USUSP/SSUSPì—ì„œ DONE ê¸°ë¡)
</span>    <span class="n">signal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>        <span class="c1"># -&gt; -s TERM / -s 9 ë“±
</span>    <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
    <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">job_ids</span><span class="p">))]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span><span class="sh">""</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">flags</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">record_done</span><span class="p">:</span>
        <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">-d</span><span class="sh">"</span><span class="p">)</span>               <span class="c1"># ê¸°ë¡ì„ DONEìœ¼ë¡œ. ì›ê²© í´ëŸ¬ìŠ¤í„° ì‹œ ì£¼ë¡œ ìœ ìš©. :contentReference[oaicite:1]{index=1}
</span>    <span class="k">if</span> <span class="n">force_remove</span><span class="p">:</span>
        <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">-r</span><span class="sh">"</span><span class="p">)</span>               <span class="c1"># LSFì—ì„œ ì¦‰ì‹œ ì œê±°(ë¦¬ì†ŒìŠ¤ í•´ì œ). :contentReference[oaicite:2]{index=2}
</span>    <span class="k">if</span> <span class="n">signal</span><span class="p">:</span>
        <span class="n">flags</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-s</span><span class="sh">"</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">signal</span><span class="p">)]</span>     <span class="c1"># íŠ¹ì • ì‹œê·¸ë„ ì§€ì •
</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bkill</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
    <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">raise_on_error</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span>
</code></pre></div></div>

<blockquote>
  <p>ì°¸ê³ </p>

  <ul>
    <li>
      <p><code class="language-plaintext highlighter-rouge">-r</code>: OSì—ì„œ ì™„ì „íˆ ì¢…ë£Œë˜ê¸° ì „ì´ë¼ë„ LSFì—ì„œ <strong>ì¦‰ì‹œ ì œê±°</strong> í•˜ê³  ë¦¬ì†ŒìŠ¤ë¥¼ í•´ì œí•©ë‹ˆë‹¤. <a href="https://www.ibm.com/docs/en/spectrum-lsf/10.1.0?topic=jobs-forcefully-removing-job-from-lsf&amp;utm_source=chatgpt.com">IBM+1</a></p>
    </li>
    <li>
      <p><code class="language-plaintext highlighter-rouge">-d</code>: ì¡ì„ ì¢…ë£Œí•˜ê³  <strong>ìƒíƒœë¥¼ DONEìœ¼ë¡œ ê¸°ë¡</strong> í•©ë‹ˆë‹¤(ì‹œì‘ëœ ì¡ì— í•œí•¨). ì›ê²© í´ëŸ¬ìŠ¤í„° ì›Œí¬í”Œë¡œì—ì„œ ìœ ìš©. <a href="https://www.ibm.com/docs/en/spectrum-lsf/10.1.0?topic=13-job-scheduling-execution&amp;utm_source=chatgpt.com">IBM</a></p>
    </li>
    <li>
      <p><code class="language-plaintext highlighter-rouge">-s</code>: ì›í•˜ëŠ” ì‹œê·¸ë„ì„ ì§ì ‘ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì˜ˆ: <code class="language-plaintext highlighter-rouge">-s TERM</code>, <code class="language-plaintext highlighter-rouge">-s 9</code>). <a href="https://tin6150.github.io/psg/3rdParty/lsf4_userGuide/07-tracking.html?utm_source=chatgpt.com">tin6150.github.io+1</a></p>
    </li>
  </ul>

</blockquote>

<h2 id="step-2-ë°°ì¹˜-ì·¨ì†Œ-ê²½ë¡œë„-ê°™ì´-ìˆ˜ì •">Step 2) ë°°ì¹˜ ì·¨ì†Œ ê²½ë¡œë„ ê°™ì´ ìˆ˜ì •</h2>

<p>ê¸°ì¡´ <code class="language-plaintext highlighter-rouge">submit_many_with_cancel()</code> ì•ˆì—ì„œ <code class="language-plaintext highlighter-rouge">await self.kill(submitted, force=True, ...)</code>ë¡œ í˜¸ì¶œí•˜ì…¨ë‹¤ë©´:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ê¸°ì¡´
# await self.kill(submitted, force=True, raise_on_error=kill_raise_on_error)
</span>
<span class="c1"># ë³€ê²½
</span><span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span>
    <span class="n">submitted</span><span class="p">,</span>
    <span class="n">force_remove</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>                  <span class="c1"># -r
</span>    <span class="c1"># í•„ìš”í•˜ë©´ record_done=True ë„ ì¶”ê°€ ê°€ëŠ¥
</span>    <span class="n">raise_on_error</span><span class="o">=</span><span class="n">kill_raise_on_error</span>
<span class="p">)</span>
</code></pre></div></div>

<h2 id="step-3-ì‚¬ìš©-ì˜ˆì‹œ">Step 3) ì‚¬ìš© ì˜ˆì‹œ</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 1) ì¦‰ì‹œ ì œê±°(LSFì—ì„œ ë¹ ë¥´ê²Œ ì¹˜ìš°ê³  ì‹¶ì„ ë•Œ)
</span><span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">kill</span><span class="p">([</span><span class="mi">101</span><span class="p">,</span> <span class="mi">102</span><span class="p">],</span> <span class="n">force_remove</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># 2) íŠ¹ì • ì‹œê·¸ë„ ì „ì†¡ í›„ ì œê±°
</span><span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="mi">103</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="sh">"</span><span class="s">TERM</span><span class="sh">"</span><span class="p">)</span>            <span class="c1"># TERMë§Œ ë³´ë‚´ê³  ê¸°ë³¸ ë™ì‘
</span><span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="mi">104</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="sh">"</span><span class="s">KILL</span><span class="sh">"</span><span class="p">)</span>            <span class="c1"># ë°”ë¡œ KILL ì‹ í˜¸
</span><span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="mi">105</span><span class="p">,</span> <span class="n">force_remove</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>        <span class="c1"># LSFì—ì„œ ì¦‰ì‹œ ì œê±°(-r)
</span>
<span class="c1"># 3) DONE ê¸°ë¡ ì˜µì…˜ (ì›ê²© í´ëŸ¬ìŠ¤í„° ì‹œ ìœ ìš©)
</span><span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">kill</span><span class="p">([</span><span class="mi">201</span><span class="p">,</span><span class="mi">202</span><span class="p">],</span> <span class="n">record_done</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>   <span class="c1"># -d
</span></code></pre></div></div>

<h2 id="ì„ íƒ-pendë§Œ-ê±·ì–´ë‚´ê³ -ì‹¶ë‹¤ë©´">(ì„ íƒ) PENDë§Œ ê±·ì–´ë‚´ê³  ì‹¶ë‹¤ë©´</h2>

<p>ìš´ì˜ ì •ì±…ìƒ â€œëŒ€ê¸°(PEND)ë§Œâ€ ì •ë¦¬í•˜ë ¤ë©´ <code class="language-plaintext highlighter-rouge">bkill -stat pend</code>ê°€ ìˆìŠµë‹ˆë‹¤(ì¼ë¶€ ì˜µì…˜ê³¼ëŠ” ë³‘í–‰ ë¶ˆê°€). í•„ìš” ì‹œ ì „ìš© ìœ í‹¸ì„ ì¶”ê°€í•˜ì„¸ìš”. <a href="https://www.ibm.com/docs/en/spectrum-lsf/10.1.0?topic=jobs-kill-job-bkill&amp;utm_source=chatgpt.com">IBM</a></p>

<hr />

<p>í•„ìš”í•˜ë©´ ì œê°€ ë“œë¦° <code class="language-plaintext highlighter-rouge">lsf_core.py</code>/<code class="language-plaintext highlighter-rouge">lsf_minimal.py</code>ì—ë„ ìœ„ ë³€ê²½ì„ ë°˜ì˜í•œ <strong>ì‘ì€ íŒ¨ì¹˜ ë²„ì „</strong> ìœ¼ë¡œ ì •ë¦¬í•´ ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

1. ê°ê° commandì˜ job idë¥¼ ì•Œê³  ì‹¶ì–´. ë§¤ì¹­ì´ í•„ìš”í•´. 2. ë‹¤ìŒê³¼ ê°™ì€ ì˜ˆì‹œë¡œ ë§ì´ ì“¸ ê²ƒ ê°™ì•„. ì•Œë§ê²Œ ì§œì¤˜. cmds = ["job_sub a.txt", "mkdir package", "bsub -q short sleep"] data = client.submit_many_with_cancel(cmds, is_interrupted=is_interrupted) if is_interrupted(): print("ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.â€œ) return job_ids = â€¦ #dataë¡œ ë¶€í„° running job id ì¶”ì¶œ while not client.is_finished(job_ids): status = client.status(job_ids) for job_id in job_ids: job_command = â€¦ #dataë¡œë¶€í„° job_idì— í•´ë‹¹í•˜ëŠ” ì»¤ë§¨ë“œ ì¶”ì¶œ print(job_id, status[job_id], job_command) await asyncio.sleep(1) if is_interrupted(): await client.kill(job_ids) print("ì¤‘ì§€í•˜ì˜€ìŠµë‹ˆë‹¤.â€) return print("ëª¨ë‘ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.â€œ)

</p>

<p>ì¢‹ì•„! â€œì ë‹¹íˆ í”„ë¡œìŠ¤ëŸ½ê³  ìœ ì§€ë³´ìˆ˜ ì‰¬ìš´â€ ë²„ì „ìœ¼ë¡œ ë‹¤ë“¬ì–´ì„œ:</p>

<ul>
  <li>
    <p>êµ¬ì¡°ëŠ” <strong>3 íŒŒíŠ¸</strong> ë§Œ ìœ ì§€</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">ShellRunner</code>: <code class="language-plaintext highlighter-rouge">create_subprocess_shell</code> + ë™ì‹œì„± ì œì–´</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">SharedCache</code>: ë©”ëª¨ë¦¬+ë””ìŠ¤í¬ TTL ìºì‹œ(ë©€í‹°í”„ë¡œì„¸ìŠ¤ ê³µìœ , tmpâ†’replaceâ†’fsync(dir))</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">LSFClient</code>: ì‚¬ìš©ì API(ì»¤ë§¨ë“œ ì‹¤í–‰Â·JobID ë§¤ì¹­, <code class="language-plaintext highlighter-rouge">bkill</code>, <code class="language-plaintext highlighter-rouge">bjobs</code> ìŠ¤ëƒ…ìƒ·/ìºì‹œ, <strong>ë°°ì¹˜ ì œì¶œ+ì·¨ì†Œ, is_finished</strong>)</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ìš”êµ¬ í¬ì¸íŠ¸ ë°˜ì˜</strong></p>

    <ol>
      <li>
        <p>ê° ì»¤ë§¨ë“œì™€ <strong>Job ID ë§¤ì¹­</strong> : <code class="language-plaintext highlighter-rouge">SubmitResult</code>/<code class="language-plaintext highlighter-rouge">SubmitItem</code>ì— <strong>ì–‘ë°©í–¥ ë§¤í•‘</strong> í¬í•¨</p>
      </li>
      <li>
        <p>ì˜ˆì‹œ íŒ¨í„´ ê·¸ëŒ€ë¡œ ì‚¬ìš© ê°€ëŠ¥: <code class="language-plaintext highlighter-rouge">submit_many_with_cancel</code> ê²°ê³¼ì—ì„œ <code class="language-plaintext highlighter-rouge">job_ids</code>, <code class="language-plaintext highlighter-rouge">job_id_to_command</code> ë°”ë¡œ êº¼ë‚´ ì“°ê³ , <code class="language-plaintext highlighter-rouge">is_finished()</code> ì œê³µ</p>
      </li>
    </ol>
  </li>
</ul>

<p>ì•„ë˜ íŒŒì¼ í•˜ë‚˜ë¡œ ë (<code class="language-plaintext highlighter-rouge">lsf_core.py</code> ë“±ìœ¼ë¡œ ì €ì¥):</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># lsf_core.py
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>
<span class="kn">import</span> <span class="n">getpass</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1"># ===================== ê³µìš© ìœ í‹¸ =====================
</span>
<span class="n">StrOrSeq</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
<span class="n">_JOBID_RE</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">cmd</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_find_job_ids</span><span class="p">(</span><span class="o">*</span><span class="n">texts</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="n">ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">finditer</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ids</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="c1"># ì¤‘ë³µ ì œê±°(ì¶œë ¥ì— ì—¬ëŸ¬ ë²ˆ ì°íˆëŠ” ê²½ìš° ëŒ€ë¹„)
</span>    <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="nb">dict</span><span class="p">.</span><span class="nf">fromkeys</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="nb">RuntimeError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Command failed: </span><span class="si">{</span><span class="n">cmd_str</span><span class="si">}</span><span class="s"> (rc=</span><span class="si">{</span><span class="n">returncode</span><span class="si">}</span><span class="s">)</span><span class="se">\n</span><span class="si">{</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">cmd_str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span>

<span class="c1"># ===================== ShellRunner =====================
</span>
<span class="k">class</span> <span class="nc">ShellRunner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">create_subprocess_shellë§Œ ì‚¬ìš©. ë™ì‹œ ì‹¤í–‰ ìˆ˜ ì„¸ë§ˆí¬ì–´ë¡œ ì œí•œ.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">max_concurrency</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">max_concurrency</span><span class="p">)</span>
        <span class="n">base_env</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LC_ALL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LANG</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_env</span> <span class="o">=</span> <span class="n">base_env</span> <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="bp">None</span> <span class="nf">else </span><span class="p">(</span><span class="n">base_env</span> <span class="o">|</span> <span class="n">env</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_sem</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_shell</span><span class="p">(</span>
                <span class="n">cmd_str</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_env</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ProcessLookupError</span><span class="p">):</span>
                <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>

<span class="c1"># ===================== SharedCache (mem+disk) =====================
</span>
<span class="k">class</span> <span class="nc">SharedCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ë©€í‹°í”„ë¡œì„¸ìŠ¤ ê³µìœ  JSON ìºì‹œ:
    - ë©”ëª¨ë¦¬ TTL + ë””ìŠ¤í¬ TTL (ê°™ì€ FS ë‚´ rename ì›ìì„± ë³´ì¥)
    - ì“°ê¸°: tmp -&gt; fsync(tmp) -&gt; os.replace -&gt; fsync(dir)
    - ì‹ ì„ ë„: JSON ë‚´ë¶€ tsì™€ íŒŒì¼ mtime ëª¨ë‘ ì‚¬ìš©(+2s skew í—ˆìš©)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ttl_sec</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">,</span> <span class="n">skew_eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">cache_dir</span> <span class="ow">or</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">XDG_CACHE_HOME</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">expanduser</span><span class="p">(</span><span class="sh">"</span><span class="s">~</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">.cache</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_root</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_skew</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">skew_eps</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_key_path</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">safe</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">[^A-Za-z0-9._-]+</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">safe</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># 1) ë©”ëª¨ë¦¬
</span>        <span class="n">item</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">:</span>
            <span class="n">ts</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="c1"># 2) ë””ìŠ¤í¬
</span>        <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_key_path</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">stat</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="n">ts_in</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">fresh_by_ts</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">ts_in</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">)</span> <span class="k">if</span> <span class="n">ts_in</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">False</span>
            <span class="n">fresh_by_mtime</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="nf">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">st</span><span class="p">.</span><span class="n">st_mtime</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fresh_by_ts</span> <span class="ow">or</span> <span class="n">fresh_by_mtime</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_key_path</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">dir_fd</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fd</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="p">.</span><span class="nf">mkstemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="sh">"</span><span class="s">cache_</span><span class="sh">"</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">"</span><span class="s">.json</span><span class="sh">"</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">fdopen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">},</span> <span class="n">f</span><span class="p">)</span>
                    <span class="n">f</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="nf">fileno</span><span class="p">())</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">FileNotFoundError</span><span class="p">):</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>

<span class="c1"># ===================== ê²°ê³¼ íƒ€ì… =====================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SubmitItem</span><span class="p">:</span>
    <span class="n">index</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">job_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SubmitResult</span><span class="p">:</span>
    <span class="n">interrupted</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SubmitItem</span><span class="p">]</span>
    <span class="n">job_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>                    <span class="c1"># í‰íƒ„í™”ëœ ì „ì²´ Job ID
</span>    <span class="n">job_id_to_command</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>     <span class="c1"># Job ID -&gt; ì› ì»¤ë§¨ë“œ(ë¬¸ìì—´)
</span>    <span class="n">num_submitted</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">num_failed</span><span class="p">:</span> <span class="nb">int</span>

<span class="c1"># ===================== LSFClient (Public API) =====================
</span>
<span class="k">class</span> <span class="nc">LSFClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - run_command_capture_job: ì»¤ë§¨ë“œ ê·¸ëŒ€ë¡œ ì‹¤í–‰, ì¶œë ¥ì—ì„œ </span><span class="sh">'</span><span class="s">Job &lt;id&gt;</span><span class="sh">'</span><span class="s"> íŒŒì‹±(ë³µìˆ˜ ê°€ëŠ¥)
    - kill: bkill (ì—¬ëŸ¬ ID ì¼ê´„)  *-r / -d / -s ì§€ì›*
    - status: bjobs ì „ì²´ ìŠ¤ëƒ…ìƒ·(ë©”ëª¨ë¦¬+ë””ìŠ¤í¬ ìºì‹œ, ë ˆì´íŠ¸ë¦¬ë°‹, in-process single-flight)
    - submit_many_with_cancel: ì¸í„°ëŸ½íŠ¸ ì‹œ ìƒˆ ì‹¤í–‰ ì¤‘ë‹¨, ì§„í–‰ ì¤‘ì€ ì™„ì£¼ â†’ ìˆ˜ì§‘í•œ job_id ì¼ê´„ bkill(ê¸°ë³¸ on)
    - is_finished: ì§€ì • Jobë“¤ì´ ì „ë¶€ DONE/EXIT/ZOMBI ë“± **ì¢…ë£Œ ìƒíƒœ**ì¸ì§€ íŒì •
    </span><span class="sh">"""</span>
    <span class="n">TERMINAL</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">DONE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">EXIT</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ZOMBI</span><span class="sh">"</span><span class="p">}</span>   <span class="c1"># í•„ìš”ì‹œ í™•ì¥
</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">bkill</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">bjobs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">max_concurrent_cli</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">bjobs_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_paths</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">:</span> <span class="n">bkill</span><span class="p">,</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">:</span> <span class="n">bjobs</span><span class="p">}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_runner</span> <span class="o">=</span> <span class="nc">ShellRunner</span><span class="p">(</span><span class="n">max_concurrent_cli</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_user</span> <span class="o">=</span> <span class="n">user</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LSF_USER</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">getpass</span><span class="p">.</span><span class="nf">getuser</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="nc">SharedCache</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">ttl_sec</span><span class="o">=</span><span class="n">disk_cache_ttl_sec</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">,</span> <span class="n">skew_eps</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>

        <span class="c1"># bjobs ì œì–´
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_min_interval_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># ---------- ì¼ë°˜ ì»¤ë§¨ë“œ ì‹¤í–‰ + Job ID íŒŒì‹± ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_command_capture_job</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubmitItem</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">job_ids</span> <span class="o">=</span> <span class="nf">_find_job_ids</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">raise_on_error</span> <span class="ow">and</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="c1"># indexëŠ” ë°°ì¹˜ ëª¨ë“œì—ì„œ ì±„ì›Œì§€ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” -1ë¡œ ë°˜í™˜
</span>        <span class="k">return</span> <span class="nc">SubmitItem</span><span class="p">(</span><span class="n">index</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">cmd</span><span class="p">,</span> <span class="n">returncode</span><span class="o">=</span><span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">,</span> <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids</span><span class="p">)</span>

    <span class="c1"># ---------- bkill ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">force_remove</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>            <span class="c1"># -r
</span>        <span class="n">record_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>             <span class="c1"># -d
</span>        <span class="n">signal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>          <span class="c1"># -s SIG
</span>        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">job_ids</span><span class="p">))]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">""</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">flags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">record_done</span><span class="p">:</span>
            <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">-d</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">force_remove</span><span class="p">:</span>
            <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">-r</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">signal</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">+=</span> <span class="p">[</span><span class="sh">"</span><span class="s">-s</span><span class="sh">"</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">signal</span><span class="p">)]</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bkill</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">raise_on_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span>

    <span class="c1"># ---------- bjobs snapshot (ìºì‹œ + ë‹¨ì¼í”Œë¼ì´íŠ¸ + ë ˆì´íŠ¸ë¦¬ë°‹) ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="c1"># per-process rate-limit
</span>        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">since</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span>
        <span class="k">if</span> <span class="n">since</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">-</span> <span class="n">since</span><span class="p">)</span>

        <span class="n">flag</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-a </span><span class="sh">"</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bjobs</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> -noheader -u </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s">-o </span><span class="sh">'</span><span class="s">jobid stat exit_code queue exec_host</span><span class="sh">'"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

        <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">exec_host</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">jid_i</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">result</span><span class="p">[</span><span class="n">jid_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="n">stat</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="sh">"</span><span class="s">-</span><span class="sh">"</span> <span class="k">else</span> <span class="n">exit_code</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="n">queue</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="n">exec_host</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_status_all_cached</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all|</span><span class="si">{</span><span class="sh">'</span><span class="s">-a</span><span class="sh">'</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">''</span><span class="si">}</span><span class="s">|user=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="sh">"</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
            <span class="n">cached</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cached</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">cached</span><span class="p">.</span><span class="nf">items</span><span class="p">()</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cached</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])}</span>
            <span class="n">inflight</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inflight</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">inflight</span>

        <span class="n">fut</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">().</span><span class="nf">create_future</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fut</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">items</span><span class="p">()})</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">status</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">all_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_status_all_cached</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="n">force_refresh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job_ids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_map</span>
        <span class="n">wanted</span> <span class="o">=</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">all_map</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">wanted</span><span class="p">}</span>

    <span class="c1"># ---------- Finite-state íŒì • ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">is_finished</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="nf">list</span><span class="p">({</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">st</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">include_done</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">info</span><span class="p">:</span>
                <span class="c1"># ìºì‹œ/ë³´ì¡´ê¸°ê°„ ì´íƒˆ ë“±ìœ¼ë¡œ ë¹ ì¡Œë‹¤ë©´ 'ì™„ë£Œë¡œ ê°„ì£¼'
</span>                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">info</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">TERMINAL</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="c1"># ---------- ë°°ì¹˜ ì œì¶œ + ì·¨ì†Œ ----------
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">commands</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">StrOrSeq</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="p">:</span> <span class="nb">callable</span><span class="p">,</span>            <span class="c1"># () -&gt; bool
</span>        <span class="n">poll_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">cmd_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">cleanup_on_interrupt</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>   <span class="c1"># Trueë©´ ì¸í„°ëŸ½íŠ¸ ì‹œ ìˆ˜ì§‘ëœ job_idë¥¼ ì¦‰ì‹œ ì •ë¦¬(bkill -r)
</span>        <span class="n">kill_force_remove</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>      <span class="c1"># cleanup_on_interrupt=Trueì¼ ë•Œ -r ì‚¬ìš©
</span>        <span class="n">kill_record_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>      <span class="c1"># í•„ìš”ì‹œ DONE ê¸°ë¡
</span>        <span class="n">kill_signal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>   <span class="c1"># í•„ìš”ì‹œ ì‹œê·¸ë„ ì§€ì •
</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubmitResult</span><span class="p">:</span>
        <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SubmitItem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">job_ids_all</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">job_id_to_cmd</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">in_flight</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubmitItem</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">run_command_capture_job</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">cmd_timeout</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">cmd_raise_on_error</span>
            <span class="p">)</span>
            <span class="c1"># index ì±„ì›Œì„œ ë°˜í™˜
</span>            <span class="k">return</span> <span class="nc">SubmitItem</span><span class="p">(</span>
                <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">returncode</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">job_ids</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">job_ids</span>
            <span class="p">)</span>

        <span class="n">idx</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">or</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">in_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_in_flight</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">is_interrupted</span><span class="p">():</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">run_one</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">commands</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
                    <span class="n">in_flight</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                    <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll_interval_sec</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                        <span class="n">in_flight</span><span class="p">.</span><span class="nf">discard</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">item</span><span class="p">:</span> <span class="n">SubmitItem</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                            <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                            <span class="c1"># ë§¤í•‘/ì§‘ê³„
</span>                            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                                <span class="n">job_ids_all</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                                <span class="n">job_id_to_cmd</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">command</span>
                            <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                                <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">poll_interval_sec</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># drain
</span>            <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">ALL_COMPLETED</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">item</span><span class="p">:</span> <span class="n">SubmitItem</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                        <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                            <span class="n">job_ids_all</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                            <span class="n">job_id_to_cmd</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">command</span>
                        <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">interrupted</span> <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="nf">is_interrupted</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">interrupted</span> <span class="ow">and</span> <span class="n">cleanup_on_interrupt</span> <span class="ow">and</span> <span class="n">job_ids_all</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span>
                <span class="n">job_ids_all</span><span class="p">,</span>
                <span class="n">force_remove</span><span class="o">=</span><span class="n">kill_force_remove</span><span class="p">,</span>
                <span class="n">record_done</span><span class="o">=</span><span class="n">kill_record_done</span><span class="p">,</span>
                <span class="n">signal</span><span class="o">=</span><span class="n">kill_signal</span><span class="p">,</span>
                <span class="n">raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># í‰íƒ„í™” ë¦¬ìŠ¤íŠ¸ ì¤‘ë³µ ì œê±°(ì¶œë ¥ ì¤‘ë³µ ëŒ€ë¹„)
</span>        <span class="n">job_ids_all</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nb">dict</span><span class="p">.</span><span class="nf">fromkeys</span><span class="p">(</span><span class="n">job_ids_all</span><span class="p">))</span>

        <span class="k">return</span> <span class="nc">SubmitResult</span><span class="p">(</span>
            <span class="n">interrupted</span><span class="o">=</span><span class="n">interrupted</span><span class="p">,</span>
            <span class="n">items</span><span class="o">=</span><span class="n">items</span><span class="p">,</span>
            <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids_all</span><span class="p">,</span>
            <span class="n">job_id_to_command</span><span class="o">=</span><span class="n">job_id_to_cmd</span><span class="p">,</span>
            <span class="n">num_submitted</span><span class="o">=</span><span class="nf">len</span><span class="p">(</span><span class="n">job_ids_all</span><span class="p">),</span>
            <span class="n">num_failed</span><span class="o">=</span><span class="n">failures</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="ë‹¹ì‹ ì´-ì›í•œ-ì‚¬ìš©-íŒ¨í„´-asyncë¡œ-ì •í™•íˆ-ë™ì‘í•˜ë„ë¡">ë‹¹ì‹ ì´ ì›í•œ ì‚¬ìš© íŒ¨í„´ (asyncë¡œ ì •í™•íˆ ë™ì‘í•˜ë„ë¡)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">lsf_core</span> <span class="kn">import</span> <span class="n">LSFClient</span>

<span class="c1"># ì¸í„°ëŸ½íŠ¸ í† í°
</span><span class="k">class</span> <span class="nc">Token</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span> <span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">delay</span>
    <span class="k">def</span> <span class="nf">is_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">):</span> <span class="nf">return </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">LSFClient</span><span class="p">(</span>
        <span class="n">max_concurrent_cli</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">bjobs_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="o">=</span><span class="sh">"</span><span class="s">/shared/cache</span><span class="sh">"</span><span class="p">,</span>   <span class="c1"># ì—¬ëŸ¬ ë¨¸ì‹ ì—ì„œ ê³µìš© FS
</span>    <span class="p">)</span>

    <span class="n">is_interrupted</span> <span class="o">=</span> <span class="nc">Token</span><span class="p">(</span><span class="n">delay</span><span class="o">=</span><span class="mi">9999</span><span class="p">).</span><span class="n">is_interrupted</span>  <span class="c1"># ì‹¤ì‚¬ìš©ì—ì„  ì™¸ë¶€ ì´ë²¤íŠ¸ë¡œ ë°”ê¾¸ì„¸ìš”
</span>
    <span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">job_sub a.txt</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">mkdir package</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">bsub -q short sleep 3</span><span class="sh">"</span><span class="p">]</span>

    <span class="c1"># 1) ë°°ì¹˜ ì œì¶œ (ì¸í„°ëŸ½íŠ¸ ì‹œ ìì²´ ì •ë¦¬í•˜ë„ë¡ í•˜ê³  ì‹¶ìœ¼ë©´ cleanup_on_interrupt=True ìœ ì§€)
</span>    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">cmds</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="o">=</span><span class="n">is_interrupted</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
        <span class="n">cleanup_on_interrupt</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>  <span class="c1"># ì¸í„°ëŸ½íŠ¸ ë°œìƒ ë™ì•ˆ ì œì¶œí•˜ë˜ jobë“¤ì€ ì—¬ê¸°ì„œ -rë¡œ ì •ë¦¬
</span>    <span class="p">)</span>

    <span class="k">if</span> <span class="n">data</span><span class="p">.</span><span class="n">interrupted</span> <span class="ow">or</span> <span class="nf">is_interrupted</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># 2) ê²°ê³¼ì—ì„œ Running(í˜¹ì€ ì „ì²´) Job ID ì¶”ì¶œ &amp; ë§¤í•‘ ì‚¬ìš©
</span>    <span class="n">job_ids</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">job_ids</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">job_ids</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ì œì¶œëœ LSF ì¡ì´ ì—†ìŠµë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># 3) ì™„ë£Œê¹Œì§€ í´ë§
</span>    <span class="k">while</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">is_finished</span><span class="p">(</span><span class="n">job_ids</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>  <span class="c1"># include_done=True ê¸°ë³¸
</span>        <span class="k">for</span> <span class="n">job_id</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">status</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">job_command</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">job_id_to_command</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="sh">"</span><span class="s">&lt;unknown&gt;</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">),</span> <span class="n">job_command</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="nf">is_interrupted</span><span class="p">():</span>
            <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">force_remove</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¤‘ì§€í•˜ì˜€ìŠµë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ëª¨ë‘ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h2 id="ì„¤ê³„-í¬ì¸íŠ¸-ì§§ê²Œ-step-by-step">ì„¤ê³„ í¬ì¸íŠ¸ (ì§§ê²Œ, step-by-step)</h2>

<ol>
  <li>
    <p><strong>JobID-ì»¤ë§¨ë“œ ë§¤ì¹­</strong> : <code class="language-plaintext highlighter-rouge">SubmitResult.job_id_to_command[jid]</code>ë¡œ O(1) ì¡°íšŒ, <code class="language-plaintext highlighter-rouge">items</code>ì— ì›ë³¸/í‘œì¤€ì¶œë ¥/ë¦¬í„´ì½”ë“œê¹Œì§€ ë³´ê´€.</p>
  </li>
  <li>
    <p><strong>ì‹¤ì „ ì•ˆì „ì„±</strong> : ì œì¶œ ì¤‘ ì¸í„°ëŸ½íŠ¸ ë°œìƒ ì‹œì—ë„ <strong>ì§„í–‰ ì¤‘ ì œì¶œì€ ì™„ì£¼</strong> â†’ ì¶œë ¥ì—ì„œ JobID ìˆ˜ì§‘ â†’ í•„ìš” ì‹œ <strong>ì¦‰ì‹œ -r</strong> ë¡œ ì •ë¦¬.</p>
  </li>
  <li>
    <p><strong>ë¶€í•˜ ìµœì†Œí™”</strong> : <code class="language-plaintext highlighter-rouge">bjobs</code>ëŠ” <strong>ì „ì²´ ìŠ¤ëƒ…ìƒ· + ë©”ëª¨ë¦¬/ë””ìŠ¤í¬ ìºì‹œ + ë ˆì´íŠ¸ë¦¬ë°‹ + ë‹¨ì¼í”Œë¼ì´íŠ¸</strong>.</p>
  </li>
  <li>
    <p><strong>API ê°„ê²°ì„±</strong> : ì‚¬ìš©ìëŠ” <code class="language-plaintext highlighter-rouge">submit â†’ data.job_ids / job_id_to_command â†’ status/is_finished â†’ kill</code> ë§Œ ì•Œë©´ ë¨.</p>
  </li>
</ol>

<p>ì›í•œë‹¤ë©´ ë¡œê·¸/ë©”íŠ¸ë¦­ í›…(ì˜ˆ: ì œì¶œ/ìƒíƒœ í˜¸ì¶œ ì¹´ìš´íŠ¸, ì§€ì—°)ì„ ë¶™ì—¬ì„œ ê´€ì¸¡ ê°€ëŠ¥í•˜ê²Œë„ ë§Œë“¤ì–´ì¤„ê²Œ.</p>

<p class="chat--user">

-r ì˜µì…˜ì€ ìµœëŒ€í•œ ì•ˆì“°ê³  ì‹¶ì–´. ê·¸ëƒ¥ bkillë¡œë§Œ í•´ë„ ë  ê²ƒ ê°™ì•„. ë‹¤ë¥¸ ì˜µì…˜ë“¤ë„ ì—†ì• ì£¼ê³  ê·¸ë¦¬ê³  bsubì€ ëì§€ë§Œ bjobs ìºì‹œê°€ ì—…ë°ì´íŠ¸ ì•ˆ ë¼ì„œ ëˆ„ë½ë˜ëŠ” ê²½ìš°ë„ ìˆì–ì•„ ê·¸ ê²½ìš° status ì •ë³´ê°€ ì–´ë–»ê²Œ ë˜ëŠ”ì§€ ê¶ê¸ˆí•´. ìµœëŒ€í•œ ì—ëŸ¬ë¥¼ ì•ˆë‚´ê³  ì‹¶ì–´

</p>

<p>ì¢‹ì€ í¬ì¸íŠ¸ì•¼. ì•„ë˜ì²˜ëŸ¼ ë”± í•„ìš”í•œ ìˆ˜ì¤€ìœ¼ë¡œ ìˆ˜ì •í–ˆì–´.</p>

<ul>
  <li>
    <p><strong>bkill</strong> : ì˜µì…˜ ì „ë¶€ ì œê±°(ìˆœìˆ˜ <code class="language-plaintext highlighter-rouge">bkill &lt;ids&gt;</code>ë§Œ í˜¸ì¶œ)</p>
  </li>
  <li>
    <p><strong>status ì•ˆì •ì„±</strong> : <code class="language-plaintext highlighter-rouge">bjobs</code> ìºì‹œê°€ ëŠ¦ì–´ <strong>ëˆ„ë½</strong> ë¼ë„ ì—ëŸ¬ ì—†ì´ ë™ì‘</p>

    <ul>
      <li>
        <p>ìš”ì²­í•œ <code class="language-plaintext highlighter-rouge">job_ids</code>ê°€ ìŠ¤ëƒ…ìƒ·ì— ì—†ìœ¼ë©´ <strong>í•œ ë²ˆë§Œ ê°•ì œ ìƒˆë¡œê³ ì¹¨</strong> ì‹œë„</p>
      </li>
      <li>
        <p>ê·¸ë˜ë„ ì—†ìœ¼ë©´ í•´ë‹¹ IDì— ëŒ€í•´ <strong><code class="language-plaintext highlighter-rouge">{"stat": "UNKNOWN"}</code></strong> ê°™ì€ ê¸°ë³¸ê°’ì„ ì±„ì›Œ ë°˜í™˜(í‚¤ ê²°í•ìœ¼ë¡œ ì¸í•œ ì˜ˆì™¸ ë°©ì§€)</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>is_finished</strong> : <code class="language-plaintext highlighter-rouge">UNKNOWN</code>ì€ ì¦‰ì‹œ ì™„ë£Œë¡œ ì·¨ê¸‰í•˜ì§€ ì•ŠìŒ. ê¸°ë³¸ì ìœ¼ë¡œ <strong>ê·¸ë ˆì´ìŠ¤(ê¸°ë‹¤ë¦¼) ì‹œê°„</strong>(ê¸°ë³¸ 15ì´ˆ) ë™ì•ˆì€ â€œë¯¸ì™„ë£Œâ€ë¡œ ë³´ê³ , ê·¸ ì´í›„ì—ë„ ê³„ì† UNKNOWNì´ë©´ ì™„ë£Œë¡œ ê°„ì£¼(í´ëŸ¬ìŠ¤í„° ë³´ì¡´ ê¸°ê°„/ì „íŒŒ ì§€ì—°ì„ í¡ìˆ˜)</p>
  </li>
</ul>

<hr />
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># lsf_core.py (ìµœì í™” ë²„ì „)
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>
<span class="kn">import</span> <span class="n">getpass</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1"># ========== ê³µìš© ==========
</span><span class="n">StrOrSeq</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
<span class="n">_JOBID_RE</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">cmd</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_find_job_ids</span><span class="p">(</span><span class="o">*</span><span class="n">texts</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="n">ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">finditer</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ids</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="nb">dict</span><span class="p">.</span><span class="nf">fromkeys</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="nb">RuntimeError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Command failed: </span><span class="si">{</span><span class="n">cmd_str</span><span class="si">}</span><span class="s"> (rc=</span><span class="si">{</span><span class="n">returncode</span><span class="si">}</span><span class="s">)</span><span class="se">\n</span><span class="si">{</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">cmd_str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span>

<span class="c1"># ========== ShellRunner ==========
</span><span class="k">class</span> <span class="nc">ShellRunner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">create_subprocess_shellë§Œ ì‚¬ìš©. ë™ì‹œ ì‹¤í–‰ ìˆ˜ëŠ” ì„¸ë§ˆí¬ì–´ë¡œ ì œí•œ.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">max_concurrency</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">max_concurrency</span><span class="p">)</span>
        <span class="n">base_env</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LC_ALL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LANG</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_env</span> <span class="o">=</span> <span class="n">base_env</span> <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="bp">None</span> <span class="nf">else </span><span class="p">(</span><span class="n">base_env</span> <span class="o">|</span> <span class="n">env</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_sem</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_shell</span><span class="p">(</span>
                <span class="n">cmd_str</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_env</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ProcessLookupError</span><span class="p">):</span>
                <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>

<span class="c1"># ========== SharedCache (mem+disk) ==========
</span><span class="k">class</span> <span class="nc">SharedCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ë©€í‹°í”„ë¡œì„¸ìŠ¤ ê³µìœ  JSON ìºì‹œ:
    - ë©”ëª¨ë¦¬ TTL + ë””ìŠ¤í¬ TTL (ê°™ì€ FS ë‚´ rename ì›ìì„±)
    - ì“°ê¸°: tmp -&gt; fsync(tmp) -&gt; os.replace -&gt; fsync(dir)
    - ì‹ ì„ ë„: JSON ë‚´ë¶€ tsì™€ íŒŒì¼ mtime ëª¨ë‘ ì‚¬ìš©(+2s skew í—ˆìš©)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ttl_sec</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">,</span> <span class="n">skew_eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">cache_dir</span> <span class="ow">or</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">XDG_CACHE_HOME</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">expanduser</span><span class="p">(</span><span class="sh">"</span><span class="s">~</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">.cache</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_root</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_skew</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">skew_eps</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_key_path</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">safe</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">[^A-Za-z0-9._-]+</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">safe</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">:</span>
            <span class="n">ts</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_key_path</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">stat</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="n">ts_in</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">fresh_by_ts</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">ts_in</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">)</span> <span class="k">if</span> <span class="n">ts_in</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">False</span>
            <span class="n">fresh_by_mtime</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="nf">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">st</span><span class="p">.</span><span class="n">st_mtime</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fresh_by_ts</span> <span class="ow">or</span> <span class="n">fresh_by_mtime</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_key_path</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">dir_fd</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fd</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="p">.</span><span class="nf">mkstemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="sh">"</span><span class="s">cache_</span><span class="sh">"</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">"</span><span class="s">.json</span><span class="sh">"</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">fdopen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">},</span> <span class="n">f</span><span class="p">)</span>
                    <span class="n">f</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="nf">fileno</span><span class="p">())</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">FileNotFoundError</span><span class="p">):</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>

<span class="c1"># ========== ê²°ê³¼ íƒ€ì… ==========
</span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SubmitItem</span><span class="p">:</span>
    <span class="n">index</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">job_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SubmitResult</span><span class="p">:</span>
    <span class="n">interrupted</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SubmitItem</span><span class="p">]</span>
    <span class="n">job_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>                    <span class="c1"># í‰íƒ„í™”ëœ ì „ì²´ Job ID
</span>    <span class="n">job_id_to_command</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>     <span class="c1"># Job ID -&gt; ì› ì»¤ë§¨ë“œ
</span>    <span class="n">num_submitted</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">num_failed</span><span class="p">:</span> <span class="nb">int</span>

<span class="c1"># ========== LSFClient ==========
</span><span class="k">class</span> <span class="nc">LSFClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - run_command_capture_job: ì»¤ë§¨ë“œ ê·¸ëŒ€ë¡œ ì‹¤í–‰, ì¶œë ¥ì—ì„œ </span><span class="sh">'</span><span class="s">Job &lt;id&gt;</span><span class="sh">'</span><span class="s">(ë³µìˆ˜ ê°€ëŠ¥) íŒŒì‹±
    - kill: ìˆœìˆ˜ bkill (ì˜µì…˜ ì—†ì´)
    - status: bjobs ì „ì²´ ìŠ¤ëƒ…ìƒ·(ìºì‹œ/ë ˆì´íŠ¸ë¦¬ë°‹/ë‹¨ì¼í”Œë¼ì´íŠ¸) + ëˆ„ë½ ì‹œ 1íšŒ ê°•ì œ ìƒˆë¡œê³ ì¹¨ + UNKNOWN ë³´ê°•
    - submit_many_with_cancel: ì¸í„°ëŸ½íŠ¸ ì‹œ ìƒˆ ì‹¤í–‰ ì¤‘ë‹¨, ì§„í–‰ ì¤‘ì€ ì™„ì£¼ â†’ ìˆ˜ì§‘í•œ job_idë¥¼ í•„ìš” ì‹œ bkill
    - is_finished: UNKNOWNì„ ì¼ì • ì‹œê°„(ê¸°ë³¸ 15s)ê¹Œì§€ëŠ” â€œë¯¸ì™„ë£Œâ€ë¡œ ë³´ê³ , ê·¸ ì´í›„ì—” ì™„ë£Œë¡œ ê°„ì£¼
    </span><span class="sh">"""</span>
    <span class="n">TERMINAL</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">DONE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">EXIT</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ZOMBI</span><span class="sh">"</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">bkill</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">bjobs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">max_concurrent_cli</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">bjobs_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">unknown_grace_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">15.0</span><span class="p">,</span>   <span class="c1"># UNKNOWN ì²˜ë¦¬ ê·¸ë ˆì´ìŠ¤
</span>    <span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_paths</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">:</span> <span class="n">bkill</span><span class="p">,</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">:</span> <span class="n">bjobs</span><span class="p">}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_runner</span> <span class="o">=</span> <span class="nc">ShellRunner</span><span class="p">(</span><span class="n">max_concurrent_cli</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_user</span> <span class="o">=</span> <span class="n">user</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LSF_USER</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">getpass</span><span class="p">.</span><span class="nf">getuser</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="nc">SharedCache</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">ttl_sec</span><span class="o">=</span><span class="n">disk_cache_ttl_sec</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">,</span> <span class="n">skew_eps</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>

        <span class="c1"># bjobs ì œì–´
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_min_interval_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># UNKNOWN ì²˜ë¦¬ìš©
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_unknown_seen_at</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_unknown_grace</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">unknown_grace_sec</span><span class="p">)</span>

    <span class="c1"># --- ì¼ë°˜ ì»¤ë§¨ë“œ ì‹¤í–‰ + Job ID íŒŒì‹± ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_command_capture_job</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubmitItem</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">job_ids</span> <span class="o">=</span> <span class="nf">_find_job_ids</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">raise_on_error</span> <span class="ow">and</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="nc">SubmitItem</span><span class="p">(</span><span class="n">index</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">cmd</span><span class="p">,</span> <span class="n">returncode</span><span class="o">=</span><span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">,</span> <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids</span><span class="p">)</span>

    <span class="c1"># --- bkill (ì˜µì…˜ ì—†ì´) ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">job_ids</span><span class="p">))]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">""</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bkill</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">raise_on_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span>

    <span class="c1"># --- bjobs ìŠ¤ëƒ…ìƒ· (ìºì‹œ/ë ˆì´íŠ¸ë¦¬ë°‹/ë‹¨ì¼í”Œë¼ì´íŠ¸) ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">since</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span>
        <span class="k">if</span> <span class="n">since</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">-</span> <span class="n">since</span><span class="p">)</span>

        <span class="n">flag</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-a </span><span class="sh">"</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bjobs</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> -noheader -u </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s">-o </span><span class="sh">'</span><span class="s">jobid stat exit_code queue exec_host</span><span class="sh">'"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

        <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">exec_host</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">jid_i</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">result</span><span class="p">[</span><span class="n">jid_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="n">stat</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="sh">"</span><span class="s">-</span><span class="sh">"</span> <span class="k">else</span> <span class="n">exit_code</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="n">queue</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="n">exec_host</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_status_all_cached</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all|</span><span class="si">{</span><span class="sh">'</span><span class="s">-a</span><span class="sh">'</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">''</span><span class="si">}</span><span class="s">|user=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
            <span class="n">cached</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cached</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">cached</span><span class="p">.</span><span class="nf">items</span><span class="p">()</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cached</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])}</span>
            <span class="n">inflight</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inflight</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">inflight</span>

        <span class="n">fut</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">().</span><span class="nf">create_future</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fut</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">items</span><span class="p">()})</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="c1"># --- ì•ˆì „í•œ status (ëˆ„ë½ ìë™ ë³´ê°•) ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">status</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">all_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_status_all_cached</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="n">force_refresh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job_ids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_map</span>

        <span class="n">req_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">all_map</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req_ids</span><span class="p">}</span>

        <span class="c1"># ëˆ„ë½(id -&gt; None) ìˆìœ¼ë©´ 1íšŒ ê°•ì œ ìƒˆë¡œê³ ì¹¨
</span>        <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">out</span><span class="p">.</span><span class="nf">values</span><span class="p">()):</span>
            <span class="n">all_map2</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_status_all_cached</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req_ids</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="n">all_map2</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># ê·¸ë˜ë„ ì—†ìœ¼ë©´ UNKNOWN ë³´ê°• + ì²« ë°œê²¬ ì‹œê°„ ê¸°ë¡
</span>        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">UNKNOWN</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">_missing</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_unknown_seen_at</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="c1"># --- ì™„ë£Œ íŒì • ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">is_finished</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="nf">list</span><span class="p">({</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">st</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">include_done</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">stat</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stat</span> <span class="o">==</span> <span class="sh">"</span><span class="s">UNKNOWN</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">first</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_unknown_seen_at</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
                <span class="c1"># UNKNOWN ê·¸ë ˆì´ìŠ¤ ë‚´ì—ëŠ” â€œë¯¸ì™„ë£Œâ€ë¡œ ì·¨ê¸‰ -&gt; bjobs ì „íŒŒ ì§€ì—°/ìºì‹œ ì§€ì—° í¡ìˆ˜
</span>                <span class="k">if</span> <span class="n">now</span> <span class="o">-</span> <span class="n">first</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_unknown_grace</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span>
                <span class="c1"># ê·¸ë ˆì´ìŠ¤ ì´ˆê³¼ ì‹œ: ì™„ë£Œë¡œ ê°„ì£¼(LSFê°€ ì •ë¦¬í–ˆê±°ë‚˜ ë³´ì¡´ê¸°ê°„ ê²½ê³¼ ë“±)
</span>                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">stat</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">TERMINAL</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="c1"># --- ë°°ì¹˜ ì œì¶œ + ì·¨ì†Œ ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">commands</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">StrOrSeq</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="p">:</span> <span class="nb">callable</span><span class="p">,</span>            <span class="c1"># () -&gt; bool
</span>        <span class="n">poll_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">cmd_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">cleanup_on_interrupt</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>   <span class="c1"># Trueë©´ ì¸í„°ëŸ½íŠ¸ ì‹œ ìˆ˜ì§‘ëœ job_idë¥¼ ì¦‰ì‹œ bkill
</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubmitResult</span><span class="p">:</span>
        <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SubmitItem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">job_ids_all</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">job_id_to_cmd</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">in_flight</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubmitItem</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">run_command_capture_job</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">cmd_timeout</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">cmd_raise_on_error</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="nc">SubmitItem</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">returncode</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span>
                              <span class="n">stdout</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">job_ids</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">job_ids</span><span class="p">)</span>

        <span class="n">idx</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">or</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">in_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_in_flight</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">is_interrupted</span><span class="p">():</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">run_one</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">commands</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
                    <span class="n">in_flight</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                    <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll_interval_sec</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                        <span class="n">in_flight</span><span class="p">.</span><span class="nf">discard</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">item</span><span class="p">:</span> <span class="n">SubmitItem</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                            <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                                <span class="n">job_ids_all</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                                <span class="n">job_id_to_cmd</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">command</span>
                            <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                                <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">poll_interval_sec</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">ALL_COMPLETED</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">item</span><span class="p">:</span> <span class="n">SubmitItem</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                        <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                            <span class="n">job_ids_all</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                            <span class="n">job_id_to_cmd</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">command</span>
                        <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">interrupted</span> <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="nf">is_interrupted</span><span class="p">())</span>
        <span class="c1"># ì¸í„°ëŸ½íŠ¸ ì‹œ, ì´ë¯¸ ìˆ˜ì§‘ëœ jobë§Œ ì •ë¦¬(bkill). (ê°•ì œ ì˜µì…˜ ì—†ì´ ìˆœìˆ˜ bkill)
</span>        <span class="k">if</span> <span class="n">interrupted</span> <span class="ow">and</span> <span class="n">cleanup_on_interrupt</span> <span class="ow">and</span> <span class="n">job_ids_all</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">job_ids_all</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">job_ids_all</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nb">dict</span><span class="p">.</span><span class="nf">fromkeys</span><span class="p">(</span><span class="n">job_ids_all</span><span class="p">))</span>
        <span class="k">return</span> <span class="nc">SubmitResult</span><span class="p">(</span>
            <span class="n">interrupted</span><span class="o">=</span><span class="n">interrupted</span><span class="p">,</span>
            <span class="n">items</span><span class="o">=</span><span class="n">items</span><span class="p">,</span>
            <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids_all</span><span class="p">,</span>
            <span class="n">job_id_to_command</span><span class="o">=</span><span class="n">job_id_to_cmd</span><span class="p">,</span>
            <span class="n">num_submitted</span><span class="o">=</span><span class="nf">len</span><span class="p">(</span><span class="n">job_ids_all</span><span class="p">),</span>
            <span class="n">num_failed</span><span class="o">=</span><span class="n">failures</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="ë‹¹ì‹ ì´-ì›í•˜ëŠ”-ì‚¬ìš©-íŒ¨í„´-ê·¸ëŒ€ë¡œ">ë‹¹ì‹ ì´ ì›í•˜ëŠ” ì‚¬ìš© íŒ¨í„´ ê·¸ëŒ€ë¡œ</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">lsf_core</span> <span class="kn">import</span> <span class="n">LSFClient</span>

<span class="k">class</span> <span class="nc">Token</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span> <span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">delay</span>
    <span class="k">def</span> <span class="nf">is_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">):</span> <span class="nf">return </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span><span class="o">-</span><span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">LSFClient</span><span class="p">(</span>
        <span class="n">max_concurrent_cli</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">bjobs_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="o">=</span><span class="sh">"</span><span class="s">/shared/cache</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">unknown_grace_sec</span><span class="o">=</span><span class="mf">15.0</span><span class="p">,</span>   <span class="c1"># bjobs ë°˜ì˜ ì§€ì—° í—ˆìš© ì‹œê°„
</span>    <span class="p">)</span>

    <span class="n">is_interrupted</span> <span class="o">=</span> <span class="nc">Token</span><span class="p">(</span><span class="n">delay</span><span class="o">=</span><span class="mi">9999</span><span class="p">).</span><span class="n">is_interrupted</span>

    <span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">job_sub a.txt</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">mkdir package</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">bsub -q short sleep 3</span><span class="sh">"</span><span class="p">]</span>

    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">submit_many_with_cancel</span><span class="p">(</span><span class="n">cmds</span><span class="p">,</span> <span class="n">is_interrupted</span><span class="o">=</span><span class="n">is_interrupted</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span><span class="p">.</span><span class="n">interrupted</span> <span class="ow">or</span> <span class="nf">is_interrupted</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">job_ids</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">job_ids</span>  <span class="c1"># dataë¡œë¶€í„° running job id ì¶”ì¶œ
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">job_ids</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">LSF ì¡ì´ ì—†ìŠµë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">is_finished</span><span class="p">(</span><span class="n">job_ids</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">job_id</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">status</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span>         <span class="c1"># í•­ìƒ í‚¤ê°€ ì¡´ì¬ (UNKNOWN ë³´ê°•)
</span>            <span class="n">job_command</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">job_id_to_command</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="sh">"</span><span class="s">&lt;unknown&gt;</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">),</span> <span class="n">job_command</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">is_interrupted</span><span class="p">():</span>
            <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¤‘ì§€í•˜ì˜€ìŠµë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ëª¨ë‘ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h3 id="ì •ë¦¬-step-by-step">ì •ë¦¬ (step-by-step)</h3>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bkill</code>ì€ <strong>ì˜µì…˜ ì—†ì´</strong> ë§Œ ì”€.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">status(job_ids)</code>ëŠ” í•­ìƒ <strong>ëª¨ë“  IDì˜ í‚¤ê°€ ì¡´ì¬</strong> í•˜ë„ë¡ ë³´ì¥:</p>

    <ol>
      <li>
        <p>ìºì‹œ íˆíŠ¸ ì‹œ ë°”ë¡œ ë°˜í™˜</p>
      </li>
      <li>
        <p>ëˆ„ë½ ìˆìœ¼ë©´ <strong>1íšŒ ê°•ì œ ë¦¬í”„ë ˆì‹œ</strong></p>
      </li>
      <li>
        <p>ê·¸ë˜ë„ ì—†ìœ¼ë©´ <code class="language-plaintext highlighter-rouge">{"stat":"UNKNOWN"}</code>ìœ¼ë¡œ ë³´ê°•(ì—ëŸ¬ ì—†ìŒ)</p>
      </li>
    </ol>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">is_finished</code>ëŠ” <code class="language-plaintext highlighter-rouge">UNKNOWN</code>ì„ <strong>ê·¸ë ˆì´ìŠ¤ ì‹œê°„ ë™ì•ˆì€ ë¯¸ì™„ë£Œ</strong> ë¡œ ë³´ê³ , ê·¸ ì´í›„ì—” ì™„ë£Œë¡œ ê°„ì£¼(ë¬´í•œë£¨í”„ ë°©ì§€).</p>
  </li>
</ul>

<p>í•„ìš”í•˜ë©´ <code class="language-plaintext highlighter-rouge">unknown_grace_sec</code>ë§Œ ì¡°ì •í•´ ìš´ì˜ í™˜ê²½ì— ë§ì¶œ ìˆ˜ ìˆì–´.</p>

<p class="chat--user">

í•œ í”„ë¡œì„¸ìŠ¤ ë‚´ì—ì„œ ì—¬ëŸ¬ LSFClient ë¥¼ ë§Œë“¤ë©´ ë™ì‹œ ëŒì•„ê°€ëŠ” Jobì´ ë§ì•„ì§€ëŠ”ê±° ì•„ëƒ? Semaphoreë¥¼ í”„ë¡œì„¸ìŠ¤ ì „ì²´ê°€ ê³µìœ í•´ì•¼í•  ê²ƒ ê°™ì•„ ì‹±ê¸€í†¤ ê°™ì€ê±¸ ì¨ì„œ. LSFClientë¥¼ ì‹±ê¸€í†¤í™” í•˜ë“ ì§€ Semaphoreë§Œ í•˜ë“ ì§€ ê·¸ê±´ ì„ íƒì¼ê±°ê°™ì€ë° ë” ì¼ë°˜ì ì´ê³  ì¢‹ì€ ìª½ì„ ì„ íƒí•´ì•¼í•´ì¤˜ã…—

</p>

<p>ì¢‹ì€ ì§€ì ! â€œí•œ í”„ë¡œì„¸ìŠ¤ ì•ˆì—ì„œ LSFClientë¥¼ ì—¬ëŸ¬ ê°œ ë§Œë“¤ì–´ë„ ë™ì‹œ ì‹¤í–‰ ìˆ˜ê°€ ëŠ˜ì–´ë‚˜ì§€ ì•Šë„ë¡â€ <strong>í”„ë¡œì„¸ìŠ¤(ì •í™•íˆëŠ” ì´ë²¤íŠ¸ ë£¨í”„) ë‹¨ìœ„ ê³µìœ  ì„¸ë§ˆí¬ì–´</strong> ë¥¼ ë„£ì€ ìµœì  ë²„ì „ìœ¼ë¡œ ì •ë¦¬í–ˆì–´.</p>

<p>í•µì‹¬ë§Œ ìš”ì•½í•˜ë©´:</p>

<ol>
  <li>
    <p><strong>LoopSharedSemaphore</strong></p>

    <ul>
      <li>
        <p>ê°™ì€ ì´ë²¤íŠ¸ ë£¨í”„ ì•ˆì—ì„œ ë§Œë“¤ì–´ì§€ëŠ” ëª¨ë“  <code class="language-plaintext highlighter-rouge">LSFClient</code>/<code class="language-plaintext highlighter-rouge">ShellRunner</code>ê°€ <strong>í•˜ë‚˜ì˜ ì„¸ë§ˆí¬ì–´ë¥¼ ê³µìœ </strong>.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">configure_global_cli_concurrency(N)</code>ìœ¼ë¡œ <strong>ì „ì—­ ë™ì‹œ ì‹¤í–‰ ìˆ˜ë¥¼ ì„¤ì •</strong>(í´ë¼ì´ì–¸íŠ¸ ë§Œë“¤ê¸° ì „ì— í•œ ë²ˆ í˜¸ì¶œ).</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>LSFClient/ShellRunner</strong></p>

    <ul>
      <li>
        <p>ê¸°ë³¸ì€ ê³µìœ  ì„¸ë§ˆí¬ì–´ ì‚¬ìš©(<code class="language-plaintext highlighter-rouge">share_semaphore=True</code>).</p>
      </li>
      <li>
        <p>ì •ë§ í•„ìš”í•˜ë©´ ì¸ìŠ¤í„´ìŠ¤ë³„ë¡œ ë…ë¦½ ì„¸ë§ˆí¬ì–´ë„ ê°€ëŠ¥(<code class="language-plaintext highlighter-rouge">share_semaphore=False</code>).</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ê¸°ëŠ¥ì€ ê·¸ëŒ€ë¡œ</strong></p>

    <ul>
      <li>
        <p>ì»¤ë§¨ë“œ ê·¸ëŒ€ë¡œ ì‹¤í–‰(<code class="language-plaintext highlighter-rouge">create_subprocess_shell</code>), <code class="language-plaintext highlighter-rouge">Job &lt;id&gt;</code> íŒŒì‹±</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">bkill</code> ì˜µì…˜ ì—†ì´</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">bjobs</code> ìŠ¤ëƒ…ìƒ·: ë©”ëª¨ë¦¬+ë””ìŠ¤í¬ ìºì‹œ, ê³¼í˜¸ì¶œ ë ˆì´íŠ¸ë¦¬ë°‹, in-process single-flight</p>
      </li>
      <li>
        <p>ëˆ„ë½ ì‹œ 1íšŒ ê°•ì œ ìƒˆë¡œê³ ì¹¨ + <strong>UNKNOWN ë³´ê°•</strong> , <code class="language-plaintext highlighter-rouge">is_finished</code>ëŠ” UNKNOWN ê·¸ë ˆì´ìŠ¤(ê¸°ë³¸ 15s)</p>
      </li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="ë“œë¡­ì¸-êµì²´-ì½”ë“œ-lsf_corepy">ë“œë¡­ì¸ êµì²´ ì½”ë“œ (<code class="language-plaintext highlighter-rouge">lsf_core.py</code>)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># lsf_core.py
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>
<span class="kn">import</span> <span class="n">getpass</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">weakref</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1"># ===================== ê³µìš© ìœ í‹¸ =====================
</span>
<span class="n">StrOrSeq</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
<span class="n">_JOBID_RE</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">cmd</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_find_job_ids</span><span class="p">(</span><span class="o">*</span><span class="n">texts</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="n">ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">finditer</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ids</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="nb">dict</span><span class="p">.</span><span class="nf">fromkeys</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="nb">RuntimeError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Command failed: </span><span class="si">{</span><span class="n">cmd_str</span><span class="si">}</span><span class="s"> (rc=</span><span class="si">{</span><span class="n">returncode</span><span class="si">}</span><span class="s">)</span><span class="se">\n</span><span class="si">{</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">cmd_str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span>

<span class="c1"># ===================== í”„ë¡œì„¸ìŠ¤(ë£¨í”„) ì „ì—­ limiter =====================
</span>
<span class="k">class</span> <span class="nc">LoopSharedSemaphore</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ê°™ì€ ì´ë²¤íŠ¸ ë£¨í”„ ì•ˆì—ì„œ create_subprocess_shell ë™ì‹œ ì‹¤í–‰ ìˆ˜ë¥¼ ì œí•œí•˜ëŠ” ì „ì—­ ì„¸ë§ˆí¬ì–´.
    - ì—¬ëŸ¬ LSFClient, ì—¬ëŸ¬ ShellRunnerê°€ ìˆì–´ë„ </span><span class="sh">'</span><span class="s">ê°™ì€ ë£¨í”„</span><span class="sh">'</span><span class="s">ì—ì„œëŠ” ì´ ì„¸ë§ˆí¬ì–´ í•˜ë‚˜ë¥¼ ê³µìœ .
    - ë‹¤ì¤‘ ìŠ¤ë ˆë“œ/ë‹¤ì¤‘ ë£¨í”„ í™˜ê²½ì´ë¼ë©´ </span><span class="sh">'</span><span class="s">ë£¨í”„ë³„</span><span class="sh">'</span><span class="s">ë¡œ í•˜ë‚˜ì”© ìƒê¹€.
    </span><span class="sh">"""</span>
    <span class="n">_sems</span><span class="p">:</span> <span class="sh">"</span><span class="s">weakref.WeakKeyDictionary[asyncio.AbstractEventLoop, asyncio.Semaphore]</span><span class="sh">"</span> <span class="o">=</span> <span class="n">weakref</span><span class="p">.</span><span class="nc">WeakKeyDictionary</span><span class="p">()</span>
    <span class="n">_default_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c1"># ì´ë¯¸ ë§Œë“¤ì–´ì§„ ì„¸ë§ˆí¬ì–´ì˜ ìš©ëŸ‰ì„ ë™ì ìœ¼ë¡œ ë°”ê¾¸ê¸´ ì–´ë µë‹¤.
</span>        <span class="c1"># ê·¸ëŸ¬ë‹ˆ 'í´ë¼ì´ì–¸íŠ¸ ë§Œë“¤ê¸° ì „ì—' í˜¸ì¶œí•´ ë‘ëŠ” ê²ƒì„ ê¶Œì¥.
</span>        <span class="n">cls</span><span class="p">.</span><span class="n">_default_limit</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">limit</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Semaphore</span><span class="p">:</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
        <span class="n">sem</span> <span class="o">=</span> <span class="n">cls</span><span class="p">.</span><span class="n">_sems</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sem</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">cls</span><span class="p">.</span><span class="n">_default_limit</span><span class="p">)</span>
            <span class="n">cls</span><span class="p">.</span><span class="n">_sems</span><span class="p">[</span><span class="n">loop</span><span class="p">]</span> <span class="o">=</span> <span class="n">sem</span>
        <span class="k">return</span> <span class="n">sem</span>

<span class="k">def</span> <span class="nf">configure_global_cli_concurrency</span><span class="p">(</span><span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì „ì— í˜¸ì¶œí•´ì„œ ì „ì—­ ë™ì‹œ ì‹¤í–‰ ìˆ˜ë¥¼ ì§€ì •í•˜ì„¸ìš”.</span><span class="sh">"""</span>
    <span class="n">LoopSharedSemaphore</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>

<span class="c1"># ===================== ShellRunner =====================
</span>
<span class="k">class</span> <span class="nc">ShellRunner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">create_subprocess_shellë§Œ ì‚¬ìš©. ê¸°ë³¸ì€ ì „ì—­(ë£¨í”„ê³µìœ ) ì„¸ë§ˆí¬ì–´ë¥¼ ì”€.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">max_concurrency</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="n">share_semaphore</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="c1"># env
</span>        <span class="n">base_env</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LC_ALL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LANG</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_env</span> <span class="o">=</span> <span class="n">base_env</span> <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="bp">None</span> <span class="nf">else </span><span class="p">(</span><span class="n">base_env</span> <span class="o">|</span> <span class="n">env</span><span class="p">)</span>
        <span class="c1"># semaphore
</span>        <span class="k">if</span> <span class="n">share_semaphore</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sem</span> <span class="o">=</span> <span class="n">LoopSharedSemaphore</span><span class="p">.</span><span class="nf">get</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">max_concurrency</span> <span class="ow">or</span> <span class="n">LoopSharedSemaphore</span><span class="p">.</span><span class="n">_default_limit</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_sem</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_shell</span><span class="p">(</span>
                <span class="n">cmd_str</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_env</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ProcessLookupError</span><span class="p">):</span>
                <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>

<span class="c1"># ===================== SharedCache (mem+disk) =====================
</span>
<span class="k">class</span> <span class="nc">SharedCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ë©€í‹°í”„ë¡œì„¸ìŠ¤ ê³µìœ  JSON ìºì‹œ:
    - ë©”ëª¨ë¦¬ TTL + ë””ìŠ¤í¬ TTL (ê°™ì€ FS ë‚´ rename ì›ìì„±)
    - ì“°ê¸°: tmp -&gt; fsync(tmp) -&gt; os.replace -&gt; fsync(dir)
    - ì‹ ì„ ë„: JSON ë‚´ë¶€ tsì™€ íŒŒì¼ mtime ëª¨ë‘ ì‚¬ìš©(+2s skew í—ˆìš©)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ttl_sec</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">,</span> <span class="n">skew_eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">cache_dir</span> <span class="ow">or</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">XDG_CACHE_HOME</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">expanduser</span><span class="p">(</span><span class="sh">"</span><span class="s">~</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">.cache</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_root</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_skew</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">skew_eps</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_key_path</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">safe</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">[^A-Za-z0-9._-]+</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">safe</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># memory
</span>        <span class="n">item</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">:</span>
            <span class="n">ts</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="c1"># disk
</span>        <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_key_path</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">stat</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="n">ts_in</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">fresh_by_ts</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">ts_in</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">)</span> <span class="k">if</span> <span class="n">ts_in</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">False</span>
            <span class="n">fresh_by_mtime</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="nf">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">st</span><span class="p">.</span><span class="n">st_mtime</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fresh_by_ts</span> <span class="ow">or</span> <span class="n">fresh_by_mtime</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_key_path</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">dir_fd</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fd</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="p">.</span><span class="nf">mkstemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="sh">"</span><span class="s">cache_</span><span class="sh">"</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">"</span><span class="s">.json</span><span class="sh">"</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">fdopen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">},</span> <span class="n">f</span><span class="p">)</span>
                    <span class="n">f</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="nf">fileno</span><span class="p">())</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">FileNotFoundError</span><span class="p">):</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>

<span class="c1"># ===================== ê²°ê³¼ íƒ€ì… =====================
</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SubmitItem</span><span class="p">:</span>
    <span class="n">index</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">job_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SubmitResult</span><span class="p">:</span>
    <span class="n">interrupted</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SubmitItem</span><span class="p">]</span>
    <span class="n">job_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>                    <span class="c1"># í‰íƒ„í™”ëœ ì „ì²´ Job ID
</span>    <span class="n">job_id_to_command</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>     <span class="c1"># Job ID -&gt; ì› ì»¤ë§¨ë“œ
</span>    <span class="n">num_submitted</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">num_failed</span><span class="p">:</span> <span class="nb">int</span>

<span class="c1"># ===================== LSFClient =====================
</span>
<span class="k">class</span> <span class="nc">LSFClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - run_command_capture_job: ì»¤ë§¨ë“œ ê·¸ëŒ€ë¡œ ì‹¤í–‰, ì¶œë ¥ì—ì„œ </span><span class="sh">'</span><span class="s">Job &lt;id&gt;</span><span class="sh">'</span><span class="s">(ë³µìˆ˜ ê°€ëŠ¥) íŒŒì‹±
    - kill: ìˆœìˆ˜ bkill (ì˜µì…˜ ì—†ì´)
    - status: bjobs ì „ì²´ ìŠ¤ëƒ…ìƒ·(ìºì‹œ/ë ˆì´íŠ¸ë¦¬ë°‹/ë‹¨ì¼í”Œë¼ì´íŠ¸) + ëˆ„ë½ ì‹œ 1íšŒ ê°•ì œ ìƒˆë¡œê³ ì¹¨ + UNKNOWN ë³´ê°•
    - submit_many_with_cancel: ì¸í„°ëŸ½íŠ¸ ì‹œ ìƒˆ ì‹¤í–‰ ì¤‘ë‹¨, ì§„í–‰ ì¤‘ì€ ì™„ì£¼ â†’ ìˆ˜ì§‘í•œ job_idë¥¼ í•„ìš” ì‹œ bkill
    - is_finished: UNKNOWN ê·¸ë ˆì´ìŠ¤(ê¸°ë³¸ 15s) ë™ì•ˆì€ ë¯¸ì™„ë£Œë¡œ ê°„ì£¼
    - ì„¸ë§ˆí¬ì–´: ê¸°ë³¸ì€ ë£¨í”„ ì „ì—­ ê³µìœ (LoopSharedSemaphore)
    </span><span class="sh">"""</span>
    <span class="n">TERMINAL</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">DONE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">EXIT</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ZOMBI</span><span class="sh">"</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">bkill</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">bjobs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">max_concurrent_cli</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>  <span class="c1"># share_semaphore=Falseì¼ ë•Œë§Œ ì‚¬ìš©
</span>        <span class="n">bjobs_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">unknown_grace_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">15.0</span><span class="p">,</span>
        <span class="n">share_semaphore</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>              <span class="c1"># True: ë£¨í”„ ì „ì—­ ê³µìœ , False: ì¸ìŠ¤í„´ìŠ¤ë³„ ì„¸ë§ˆí¬ì–´
</span>    <span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_paths</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">:</span> <span class="n">bkill</span><span class="p">,</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">:</span> <span class="n">bjobs</span><span class="p">}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_runner</span> <span class="o">=</span> <span class="nc">ShellRunner</span><span class="p">(</span><span class="n">max_concurrency</span><span class="o">=</span><span class="n">max_concurrent_cli</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">share_semaphore</span><span class="o">=</span><span class="n">share_semaphore</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_user</span> <span class="o">=</span> <span class="n">user</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LSF_USER</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">getpass</span><span class="p">.</span><span class="nf">getuser</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="nc">SharedCache</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">ttl_sec</span><span class="o">=</span><span class="n">disk_cache_ttl_sec</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">,</span> <span class="n">skew_eps</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>

        <span class="c1"># bjobs ì œì–´
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_min_interval_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># UNKNOWN ì²˜ë¦¬
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_unknown_seen_at</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_unknown_grace</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">unknown_grace_sec</span><span class="p">)</span>

    <span class="c1"># --- ì¼ë°˜ ì»¤ë§¨ë“œ ì‹¤í–‰ + Job ID íŒŒì‹± ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_command_capture_job</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubmitItem</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">job_ids</span> <span class="o">=</span> <span class="nf">_find_job_ids</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">raise_on_error</span> <span class="ow">and</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="nc">SubmitItem</span><span class="p">(</span><span class="n">index</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">cmd</span><span class="p">,</span> <span class="n">returncode</span><span class="o">=</span><span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">,</span> <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids</span><span class="p">)</span>

    <span class="c1"># --- bkill (ì˜µì…˜ ì—†ì´) ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">job_ids</span><span class="p">))]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">""</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bkill</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">raise_on_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span>

    <span class="c1"># --- bjobs ìŠ¤ëƒ…ìƒ· (ìºì‹œ/ë ˆì´íŠ¸ë¦¬ë°‹/ë‹¨ì¼í”Œë¼ì´íŠ¸) ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">since</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span>
        <span class="k">if</span> <span class="n">since</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">-</span> <span class="n">since</span><span class="p">)</span>

        <span class="n">flag</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-a </span><span class="sh">"</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bjobs</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> -noheader -u </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s">-o </span><span class="sh">'</span><span class="s">jobid stat exit_code queue exec_host</span><span class="sh">'"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

        <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">exec_host</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">jid_i</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">result</span><span class="p">[</span><span class="n">jid_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="n">stat</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="sh">"</span><span class="s">-</span><span class="sh">"</span> <span class="k">else</span> <span class="n">exit_code</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="n">queue</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="n">exec_host</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_status_all_cached</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all|</span><span class="si">{</span><span class="sh">'</span><span class="s">-a</span><span class="sh">'</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">''</span><span class="si">}</span><span class="s">|user=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
            <span class="n">cached</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cached</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">cached</span><span class="p">.</span><span class="nf">items</span><span class="p">()</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cached</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])}</span>
            <span class="n">inflight</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inflight</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">inflight</span>

        <span class="n">fut</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">().</span><span class="nf">create_future</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fut</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">items</span><span class="p">()})</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_inflight</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="c1"># --- ì•ˆì „í•œ status (ëˆ„ë½ ìë™ ë³´ê°•) ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">status</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">all_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_status_all_cached</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="n">force_refresh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job_ids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_map</span>

        <span class="n">req_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">all_map</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req_ids</span><span class="p">}</span>

        <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">out</span><span class="p">.</span><span class="nf">values</span><span class="p">()):</span>
            <span class="n">all_map2</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_status_all_cached</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req_ids</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="n">all_map2</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">UNKNOWN</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">_missing</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
                <span class="c1"># UNKNOWN ê·¸ë ˆì´ìŠ¤ ì‹œì‘ ì‹œê° ê¸°ë¡
</span>                <span class="n">self</span><span class="p">.</span><span class="n">_unknown_seen_at</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="c1"># --- ì™„ë£Œ íŒì • ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">is_finished</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="nf">list</span><span class="p">({</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">st</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">include_done</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">stat</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stat</span> <span class="o">==</span> <span class="sh">"</span><span class="s">UNKNOWN</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">first</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_unknown_seen_at</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">now</span> <span class="o">-</span> <span class="n">first</span> <span class="o">&lt;</span> <span class="mf">15.0</span><span class="p">:</span>  <span class="c1"># self._unknown_graceë¥¼ ì¨ë„ ë¨. ê¸°ë³¸ 15s
</span>                    <span class="k">return</span> <span class="bp">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">stat</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">TERMINAL</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="c1"># --- ë°°ì¹˜ ì œì¶œ + ì·¨ì†Œ ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">commands</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">StrOrSeq</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="p">:</span> <span class="nb">callable</span><span class="p">,</span>            <span class="c1"># () -&gt; bool
</span>        <span class="n">poll_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">cmd_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">cleanup_on_interrupt</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>   <span class="c1"># Trueë©´ ì¸í„°ëŸ½íŠ¸ ì‹œ ìˆ˜ì§‘ëœ job_idë¥¼ ì¦‰ì‹œ bkill
</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubmitResult</span><span class="p">:</span>
        <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SubmitItem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">job_ids_all</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">job_id_to_cmd</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">in_flight</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubmitItem</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">run_command_capture_job</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">cmd_timeout</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">cmd_raise_on_error</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="nc">SubmitItem</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">returncode</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span>
                              <span class="n">stdout</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">job_ids</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">job_ids</span><span class="p">)</span>

        <span class="n">idx</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">or</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">in_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_in_flight</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">is_interrupted</span><span class="p">():</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">run_one</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">commands</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
                    <span class="n">in_flight</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                    <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll_interval_sec</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                        <span class="n">in_flight</span><span class="p">.</span><span class="nf">discard</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">item</span><span class="p">:</span> <span class="n">SubmitItem</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                            <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                                <span class="n">job_ids_all</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                                <span class="n">job_id_to_cmd</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">command</span>
                            <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                                <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">poll_interval_sec</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">ALL_COMPLETED</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">item</span><span class="p">:</span> <span class="n">SubmitItem</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                        <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                            <span class="n">job_ids_all</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                            <span class="n">job_id_to_cmd</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">command</span>
                        <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">interrupted</span> <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="nf">is_interrupted</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">interrupted</span> <span class="ow">and</span> <span class="n">cleanup_on_interrupt</span> <span class="ow">and</span> <span class="n">job_ids_all</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">job_ids_all</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">job_ids_all</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nb">dict</span><span class="p">.</span><span class="nf">fromkeys</span><span class="p">(</span><span class="n">job_ids_all</span><span class="p">))</span>
        <span class="k">return</span> <span class="nc">SubmitResult</span><span class="p">(</span>
            <span class="n">interrupted</span><span class="o">=</span><span class="n">interrupted</span><span class="p">,</span>
            <span class="n">items</span><span class="o">=</span><span class="n">items</span><span class="p">,</span>
            <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids_all</span><span class="p">,</span>
            <span class="n">job_id_to_command</span><span class="o">=</span><span class="n">job_id_to_cmd</span><span class="p">,</span>
            <span class="n">num_submitted</span><span class="o">=</span><span class="nf">len</span><span class="p">(</span><span class="n">job_ids_all</span><span class="p">),</span>
            <span class="n">num_failed</span><span class="o">=</span><span class="n">failures</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="ì–´ë–»ê²Œ-ì“°ë©´-ë˜ë‚˜-step-by-step">ì–´ë–»ê²Œ ì“°ë©´ ë˜ë‚˜ (step-by-step)</h2>

<h3 id="1-ì „ì—­-ë™ì‹œ-ì‹¤í–‰-ìˆ˜ë¥¼-í•œ-ë²ˆë§Œ-ì„¤ì •">1) ì „ì—­ ë™ì‹œ ì‹¤í–‰ ìˆ˜ë¥¼ í•œ ë²ˆë§Œ ì„¤ì •</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">lsf_core</span> <span class="kn">import</span> <span class="n">configure_global_cli_concurrency</span>
<span class="nf">configure_global_cli_concurrency</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>   <span class="c1"># í”„ë¡œì„¸ìŠ¤(=ë£¨í”„) ì „ì²´ì—ì„œ ìµœëŒ€ 6ê°œë§Œ ë™ì‹œ ì‹¤í–‰
</span></code></pre></div></div>

<blockquote>
  <p>ì´ê±´ <strong>í´ë¼ì´ì–¸íŠ¸ë“¤ì„ ë§Œë“¤ê¸° ì „ì—</strong> í˜¸ì¶œí•˜ì„¸ìš”. ê°™ì€ ì´ë²¤íŠ¸ ë£¨í”„ì—ì„œ ë§Œë“  ëª¨ë“  <code class="language-plaintext highlighter-rouge">LSFClient</code>ê°€ ì´ ì„¸ë§ˆí¬ì–´ë¥¼ ê³µìœ í•©ë‹ˆë‹¤.</p>
</blockquote>

<h3 id="2-í´ë¼ì´ì–¸íŠ¸-ì—¬ëŸ¬-ê°œ-ë§Œë“¤ì–´ë„-ok">2) í´ë¼ì´ì–¸íŠ¸ ì—¬ëŸ¬ ê°œ ë§Œë“¤ì–´ë„ OK</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">lsf_core</span> <span class="kn">import</span> <span class="n">LSFClient</span>

<span class="n">c1</span> <span class="o">=</span> <span class="nc">LSFClient</span><span class="p">()</span>                   <span class="c1"># ê¸°ë³¸: ê³µìœ  ì„¸ë§ˆí¬ì–´ ì‚¬ìš©
</span><span class="n">c2</span> <span class="o">=</span> <span class="nc">LSFClient</span><span class="p">()</span>                   <span class="c1"># ë™ì¼ ë£¨í”„ë©´ c1ê³¼ ê°™ì€ ì„¸ë§ˆí¬ì–´ ê³µìœ 
</span><span class="n">c3</span> <span class="o">=</span> <span class="nc">LSFClient</span><span class="p">(</span><span class="n">share_semaphore</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">max_concurrent_cli</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># ì •ë§ í•„ìš”í•˜ë©´ ë…ë¦½ ì„¸ë§ˆí¬ì–´
</span></code></pre></div></div>

<h3 id="3-ì§ˆë¬¸ì—ì„œ-ì¤€-ë£¨í”„">3) ì§ˆë¬¸ì—ì„œ ì¤€ ë£¨í”„</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">job_sub a.txt</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">mkdir package</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">bsub -q short sleep 3</span><span class="sh">"</span><span class="p">]</span>

<span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c1</span><span class="p">.</span><span class="nf">submit_many_with_cancel</span><span class="p">(</span><span class="n">cmds</span><span class="p">,</span> <span class="n">is_interrupted</span><span class="o">=</span><span class="n">is_interrupted</span><span class="p">)</span>
<span class="k">if</span> <span class="n">data</span><span class="p">.</span><span class="n">interrupted</span> <span class="ow">or</span> <span class="nf">is_interrupted</span><span class="p">():</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span>

<span class="n">job_ids</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">job_ids</span>
<span class="k">while</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">c1</span><span class="p">.</span><span class="nf">is_finished</span><span class="p">(</span><span class="n">job_ids</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="k">await</span> <span class="n">c1</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">job_id</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
        <span class="n">job_command</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">job_id_to_command</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">status</span><span class="p">[</span><span class="n">job_id</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">),</span> <span class="n">job_command</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nf">is_interrupted</span><span class="p">():</span>
        <span class="k">await</span> <span class="n">c1</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>   <span class="c1"># ì˜µì…˜ ì—†ì´ ìˆœìˆ˜ bkill
</span>        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¤‘ì§€í•˜ì˜€ìŠµë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ëª¨ë‘ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="ì™œ-ì´ê²Œ-ë”-ì¼ë°˜ì ì´ê³ -ì¢‹ì€-ì„ íƒì¸ê°€">ì™œ ì´ê²Œ â€œë” ì¼ë°˜ì ì´ê³  ì¢‹ì€ ì„ íƒâ€ì¸ê°€</h2>

<ul>
  <li>
    <p><strong>ì•ˆì „í•œ ê¸°ë³¸ê°’</strong> : ëŒ€ë¶€ë¶„ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ ë‹¨ì¼ ì´ë²¤íŠ¸ ë£¨í”„ì—ì„œ ëŒì•„ê°€ë¯€ë¡œ, ë£¨í”„ ë‹¨ìœ„ ì „ì—­ ì„¸ë§ˆí¬ì–´ ê³µìœ ê°€ ê°€ì¥ ìì—°ìŠ¤ëŸ½ê³  ì•ˆì •ì .</p>
  </li>
  <li>
    <p><strong>ì˜ˆì¸¡ ê°€ëŠ¥í•œ ë™ì‹œì„±</strong> : <code class="language-plaintext highlighter-rouge">configure_global_cli_concurrency(N)</code> ë”± í•œ ë²ˆìœ¼ë¡œ í”„ë¡œì„¸ìŠ¤ ì „ì²´ ì‹¤í–‰ëŸ‰ì„ ì œì–´.</p>
  </li>
  <li>
    <p><strong>ìœ ì—°ì„±</strong> : ì˜ˆì™¸ì ìœ¼ë¡œ ë…ë¦½ ì„¸ë§ˆí¬ì–´ê°€ í•„ìš”í•˜ë©´ <code class="language-plaintext highlighter-rouge">share_semaphore=False</code>ë¡œ ë¶„ë¦¬ ê°€ëŠ¥.</p>
  </li>
  <li>
    <p><strong>ë³µì¡ë„ ìµœì†Œí™”</strong> : ì‹±ê¸€í†¤ í´ë¼ì´ì–¸íŠ¸ ê°•ì œë³´ë‹¤ ì œì–´ ì§€ì ì´ ëª…í™•í•˜ê³ , í…ŒìŠ¤íŠ¸Â·í™•ì¥ì´ ì‰½ë‹¤.</p>
  </li>
</ul>

<p>ì›í•˜ë©´ ì „ì—­ ë™ì‹œ ì‹¤í–‰ ìˆ˜ë¥¼ í™˜ê²½ë³€ìˆ˜(ì˜ˆ: <code class="language-plaintext highlighter-rouge">LSF_CLI_MAX=6</code>)ë¡œë„ ì½ë„ë¡ í•œ ì¤„ ì¶”ê°€í•´ì¤„ê²Œ.</p>

<p class="chat--user">

SharedCacheë„ í•œ í”„ë¡œì„¸ìŠ¤ ë‚´ì— LSFClientê°€ ì—¬ëŸ¬ê°œ ìˆì„ ë•Œ ìµœëŒ€í•œ íš¨ìœ¨ì ìœ¼ë¡œ ë™ì‘í•˜ê²Œ í•˜ê³  ì‹¶ì–´. ì§€ê¸ˆì€ Clientê°€ Nê°œë©´ Cacheë„ Nê°œ ìˆëŠ”ë° ì´ê±´ ì¢€ ë¹„íš¨ìœ¨ì ì¸ê±° ì•„ë‹Œê°€ ì‹¶ì–´ì„œ.

</p>

<p>ì¢‹ì€ í¬ì¸íŠ¸! í•œ í”„ë¡œì„¸ìŠ¤(ì •í™•íˆëŠ” <strong>ê°™ì€ ì´ë²¤íŠ¸ ë£¨í”„</strong>) ì•ˆì—ì„œ <code class="language-plaintext highlighter-rouge">LSFClient</code>ë¥¼ ì—¬ëŸ¬ ê°œ ìƒì„±í•´ë„ <strong>ìºì‹œ(ë©”ëª¨ë¦¬)ì™€ ë‹¨ì¼ í”Œë¼ì´íŠ¸(single-flight)ê°€ ì¤‘ë³µë˜ì§€ ì•Šê²Œ</strong> ê³ ì³¤ì–´ìš”.</p>

<p>í•µì‹¬ ë³€í™”ë§Œ ìš”ì•½:</p>

<ul>
  <li>
    <p><strong>ê³µìœ  ì„¸ë§ˆí¬ì–´</strong> : ì´ë¯¸ ì œê³µí–ˆë˜ <code class="language-plaintext highlighter-rouge">LoopSharedSemaphore</code>ë¡œ ì „ì—­ ë™ì‹œ ì‹¤í–‰ ìˆ˜ë¥¼ ë£¨í”„ ë‹¨ìœ„ë¡œ ê³µìœ .</p>
  </li>
  <li>
    <p><strong>ê³µìœ  ë©”ëª¨ë¦¬ ìºì‹œ</strong> : <code class="language-plaintext highlighter-rouge">SharedCache</code>ê°€ <strong>í”„ë¡œì„¸ìŠ¤/ë£¨í”„ ì „ì—­ ë©”ëª¨ë¦¬ ìƒ¤ë“œ</strong> ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½ â†’ <code class="language-plaintext highlighter-rouge">LSFClient</code>ê°€ Nê°œì—¬ë„ <strong>ë©”ëª¨ë¦¬ ìºì‹œ 1ë²Œ</strong> ë§Œ.</p>
  </li>
  <li>
    <p><strong>ì „ì—­ single-flight</strong> : <code class="language-plaintext highlighter-rouge">bjobs</code> ìŠ¤ëƒ…ìƒ·ì„ ê°€ì ¸ì˜¤ëŠ” fetchëŠ” <strong>ë£¨í”„ ì „ì—­ single-flight</strong> ë¡œ ë¬¶ì–´, ë™ì‹œì— ì—¬ëŸ¬ <code class="language-plaintext highlighter-rouge">LSFClient</code>ê°€ í˜¸ì¶œí•´ë„ <strong>ì‹¤ì œ í˜¸ì¶œì€ 1íšŒ</strong> ë§Œ ìˆ˜í–‰.</p>
  </li>
</ul>

<p>ì•„ë˜ íŒŒì¼ í•˜ë‚˜ë¡œ êµì²´í•´ì„œ ì“°ì„¸ìš”. (ì´ì „ ì‘ë‹µì˜ ê¸°ëŠ¥/ì¸í„°í˜ì´ìŠ¤ëŠ” ìœ ì§€ë©ë‹ˆë‹¤: <code class="language-plaintext highlighter-rouge">bkill</code> ì˜µì…˜ ì—†ìŒ, <code class="language-plaintext highlighter-rouge">UNKNOWN</code> ë³´ê°•, <code class="language-plaintext highlighter-rouge">is_finished</code> ê·¸ë ˆì´ìŠ¤ ì²˜ë¦¬ ë“±.)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># lsf_core.py
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>
<span class="kn">import</span> <span class="n">getpass</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">weakref</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1"># ========== ê³µìš© ==========
</span><span class="n">StrOrSeq</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
<span class="n">_JOBID_RE</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">cmd</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_find_job_ids</span><span class="p">(</span><span class="o">*</span><span class="n">texts</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="n">ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">finditer</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ids</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="nb">dict</span><span class="p">.</span><span class="nf">fromkeys</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="nb">RuntimeError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Command failed: </span><span class="si">{</span><span class="n">cmd_str</span><span class="si">}</span><span class="s"> (rc=</span><span class="si">{</span><span class="n">returncode</span><span class="si">}</span><span class="s">)</span><span class="se">\n</span><span class="si">{</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">cmd_str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span>

<span class="c1"># ========== ë£¨í”„ ì „ì—­ ê³µìœ  ë„ìš°ë¯¸ë“¤ ==========
</span>
<span class="k">class</span> <span class="nc">LoopSharedSemaphore</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">ê°™ì€ ì´ë²¤íŠ¸ ë£¨í”„ ë‚´ì—ì„œ ì „ì—­ìœ¼ë¡œ ê³µìœ ë˜ëŠ” ì„¸ë§ˆí¬ì–´ (CLI ë™ì‹œ ì‹¤í–‰ ìƒí•œ).</span><span class="sh">"""</span>
    <span class="n">_sems</span><span class="p">:</span> <span class="sh">"</span><span class="s">weakref.WeakKeyDictionary[asyncio.AbstractEventLoop, asyncio.Semaphore]</span><span class="sh">"</span> <span class="o">=</span> <span class="n">weakref</span><span class="p">.</span><span class="nc">WeakKeyDictionary</span><span class="p">()</span>
    <span class="n">_default_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">cls</span><span class="p">.</span><span class="n">_default_limit</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">limit</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Semaphore</span><span class="p">:</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
        <span class="n">sem</span> <span class="o">=</span> <span class="n">cls</span><span class="p">.</span><span class="n">_sems</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sem</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">cls</span><span class="p">.</span><span class="n">_default_limit</span><span class="p">)</span>
            <span class="n">cls</span><span class="p">.</span><span class="n">_sems</span><span class="p">[</span><span class="n">loop</span><span class="p">]</span> <span class="o">=</span> <span class="n">sem</span>
        <span class="k">return</span> <span class="n">sem</span>

<span class="k">def</span> <span class="nf">configure_global_cli_concurrency</span><span class="p">(</span><span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì „ì— í•œ ë²ˆ í˜¸ì¶œí•´ì„œ ì „ì—­ ë™ì‹œ ì‹¤í–‰ ìˆ˜ë¥¼ ì§€ì •í•˜ì„¸ìš”.</span><span class="sh">"""</span>
    <span class="n">LoopSharedSemaphore</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">LoopSingleFlight</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ê°™ì€ ì´ë²¤íŠ¸ ë£¨í”„ì—ì„œ keyë³„ë¡œ ë™ì‹œ ì‹¤í–‰ì„ 1íšŒë¡œ ë³´ì¥.
    ì‚¬ìš©ë²•: await LoopSingleFlight.run(key, coro_factory)
    </span><span class="sh">"""</span>
    <span class="n">_maps</span><span class="p">:</span> <span class="sh">"</span><span class="s">weakref.WeakKeyDictionary[asyncio.AbstractEventLoop, Dict[str, asyncio.Future]]</span><span class="sh">"</span> <span class="o">=</span> <span class="n">weakref</span><span class="p">.</span><span class="nc">WeakKeyDictionary</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">coro_factory</span><span class="p">):</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
        <span class="n">fmap</span> <span class="o">=</span> <span class="n">cls</span><span class="p">.</span><span class="n">_maps</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fmap</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">fmap</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">cls</span><span class="p">.</span><span class="n">_maps</span><span class="p">[</span><span class="n">loop</span><span class="p">]</span> <span class="o">=</span> <span class="n">fmap</span>
        <span class="n">fut</span> <span class="o">=</span> <span class="n">fmap</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">fut</span>
        <span class="n">fut</span> <span class="o">=</span> <span class="n">loop</span><span class="p">.</span><span class="nf">create_future</span><span class="p">()</span>
        <span class="n">fmap</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fut</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">coro_factory</span><span class="p">()</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">fut</span><span class="p">.</span><span class="nf">set_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">fmap</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

<span class="c1"># ========== ShellRunner ==========
</span>
<span class="k">class</span> <span class="nc">ShellRunner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">create_subprocess_shellë§Œ ì‚¬ìš©. ê¸°ë³¸ì€ ë£¨í”„ ì „ì—­ ì„¸ë§ˆí¬ì–´ ê³µìœ .</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">max_concurrency</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="n">share_semaphore</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="n">base_env</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LC_ALL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LANG</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_env</span> <span class="o">=</span> <span class="n">base_env</span> <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="bp">None</span> <span class="nf">else </span><span class="p">(</span><span class="n">base_env</span> <span class="o">|</span> <span class="n">env</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_sem</span> <span class="o">=</span> <span class="n">LoopSharedSemaphore</span><span class="p">.</span><span class="nf">get</span><span class="p">()</span> <span class="k">if</span> <span class="n">share_semaphore</span> <span class="k">else</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">max_concurrency</span> <span class="ow">or</span> <span class="mi">8</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_sem</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_shell</span><span class="p">(</span>
                <span class="n">cmd_str</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_env</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ProcessLookupError</span><span class="p">):</span>
                <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>

<span class="c1"># ========== SharedCache (í”„ë¡œì„¸ìŠ¤/ë£¨í”„ ì „ì—­ ë©”ëª¨ë¦¬) ==========
</span>
<span class="c1"># ë£¨íŠ¸ ë””ë ‰í† ë¦¬(= base/namespace) ë‹¨ìœ„ë¡œ ë©”ëª¨ë¦¬ ìƒ¤ë“œ ê³µìœ 
</span><span class="n">_MEM_SHARDS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">class</span> <span class="nc">SharedCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ë©€í‹°í”„ë¡œì„¸ìŠ¤ ê³µìœ  JSON ìºì‹œ + **í”„ë¡œì„¸ìŠ¤/ë£¨í”„ ì „ì—­ ë©”ëª¨ë¦¬ ìƒ¤ë“œ**:
    - ê°™ì€ í”„ë¡œì„¸ìŠ¤ì—ì„œ ê°™ì€ cache_root(=base/namespace)ë¥¼ ì“°ëŠ” ëª¨ë“  LSFClientê°€ **í•œ ë©”ëª¨ë¦¬ dict ê³µìœ **
    - ë””ìŠ¤í¬: tmp -&gt; fsync(tmp) -&gt; os.replace -&gt; fsync(dir) (ê°™ì€ FS ë‚´ rename ì›ìì„±)
    - ì‹ ì„ ë„: JSON ë‚´ë¶€ tsì™€ íŒŒì¼ mtime ëª¨ë‘ ì‚¬ìš©(+2s skew í—ˆìš©)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ttl_sec</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">,</span> <span class="n">skew_eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">cache_dir</span> <span class="ow">or</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">XDG_CACHE_HOME</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">expanduser</span><span class="p">(</span><span class="sh">"</span><span class="s">~</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">.cache</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_root</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>  <span class="c1"># shard key
</span>        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_skew</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">skew_eps</span><span class="p">)</span>
        <span class="c1"># ì „ì—­ ìƒ¤ë“œ í™•ë³´
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_mem</span> <span class="o">=</span> <span class="n">_MEM_SHARDS</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1"># key -&gt; (ts, data)
</span>
    <span class="k">def</span> <span class="nf">_key_path</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">safe</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">[^A-Za-z0-9._-]+</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">safe</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># 1) í”„ë¡œì„¸ìŠ¤ ì „ì—­ ë©”ëª¨ë¦¬
</span>        <span class="n">item</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">:</span>
            <span class="n">ts</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="c1"># 2) ë””ìŠ¤í¬
</span>        <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_key_path</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">stat</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="n">ts_in</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">fresh_by_ts</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">ts_in</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">)</span> <span class="k">if</span> <span class="n">ts_in</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">False</span>
            <span class="n">fresh_by_mtime</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="nf">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">st</span><span class="p">.</span><span class="n">st_mtime</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fresh_by_ts</span> <span class="ow">or</span> <span class="n">fresh_by_mtime</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_key_path</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">dir_fd</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fd</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="p">.</span><span class="nf">mkstemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="sh">"</span><span class="s">cache_</span><span class="sh">"</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">"</span><span class="s">.json</span><span class="sh">"</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">fdopen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">},</span> <span class="n">f</span><span class="p">)</span>
                    <span class="n">f</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="nf">fileno</span><span class="p">())</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">FileNotFoundError</span><span class="p">):</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>

<span class="c1"># ========== ê²°ê³¼ íƒ€ì… ==========
</span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SubmitItem</span><span class="p">:</span>
    <span class="n">index</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">job_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SubmitResult</span><span class="p">:</span>
    <span class="n">interrupted</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SubmitItem</span><span class="p">]</span>
    <span class="n">job_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>                    <span class="c1"># í‰íƒ„í™”ëœ ì „ì²´ Job ID
</span>    <span class="n">job_id_to_command</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>     <span class="c1"># Job ID -&gt; ì› ì»¤ë§¨ë“œ
</span>    <span class="n">num_submitted</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">num_failed</span><span class="p">:</span> <span class="nb">int</span>

<span class="c1"># ========== LSFClient ==========
</span><span class="k">class</span> <span class="nc">LSFClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - run_command_capture_job: ì»¤ë§¨ë“œ ê·¸ëŒ€ë¡œ ì‹¤í–‰, ì¶œë ¥ì—ì„œ </span><span class="sh">'</span><span class="s">Job &lt;id&gt;</span><span class="sh">'</span><span class="s">(ë³µìˆ˜ ê°€ëŠ¥) íŒŒì‹±
    - kill: ìˆœìˆ˜ bkill (ì˜µì…˜ ì—†ì´)
    - status: bjobs ì „ì²´ ìŠ¤ëƒ…ìƒ·(ê³µìœ  ìºì‹œ + ì „ì—­ single-flight + ë ˆì´íŠ¸ë¦¬ë°‹)
             + ëˆ„ë½ ì‹œ 1íšŒ ê°•ì œ ìƒˆë¡œê³ ì¹¨ + UNKNOWN ë³´ê°•
    - submit_many_with_cancel: ì¸í„°ëŸ½íŠ¸ ì‹œ ìƒˆ ì‹¤í–‰ ì¤‘ë‹¨, ì§„í–‰ ì¤‘ì€ ì™„ì£¼ â†’ ìˆ˜ì§‘ job_id í•„ìš”ì‹œ bkill
    - is_finished: UNKNOWN ê·¸ë ˆì´ìŠ¤(ê¸°ë³¸ 15s) ë™ì•ˆì€ ë¯¸ì™„ë£Œë¡œ ê°„ì£¼
    - ë™ì‹œì„±: ë£¨í”„ ì „ì—­ ì„¸ë§ˆí¬ì–´ ê³µìœ  (configure_global_cli_concurrency ì‚¬ìš© ê°€ëŠ¥)
    </span><span class="sh">"""</span>
    <span class="n">TERMINAL</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">DONE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">EXIT</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ZOMBI</span><span class="sh">"</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">bkill</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">bjobs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">max_concurrent_cli</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>  <span class="c1"># share_semaphore=Falseì¼ ë•Œë§Œ ì˜ë¯¸ ìˆìŒ
</span>        <span class="n">bjobs_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">unknown_grace_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">15.0</span><span class="p">,</span>
        <span class="n">share_semaphore</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_paths</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">:</span> <span class="n">bkill</span><span class="p">,</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">:</span> <span class="n">bjobs</span><span class="p">}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_runner</span> <span class="o">=</span> <span class="nc">ShellRunner</span><span class="p">(</span><span class="n">max_concurrency</span><span class="o">=</span><span class="n">max_concurrent_cli</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">share_semaphore</span><span class="o">=</span><span class="n">share_semaphore</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_user</span> <span class="o">=</span> <span class="n">user</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LSF_USER</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">getpass</span><span class="p">.</span><span class="nf">getuser</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="nc">SharedCache</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">ttl_sec</span><span class="o">=</span><span class="n">disk_cache_ttl_sec</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">,</span> <span class="n">skew_eps</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>

        <span class="c1"># bjobs ì œì–´
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_min_interval_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># UNKNOWN ì²˜ë¦¬
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_unknown_seen_at</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_unknown_grace</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">unknown_grace_sec</span><span class="p">)</span>

    <span class="c1"># --- ì¼ë°˜ ì»¤ë§¨ë“œ ì‹¤í–‰ + Job ID íŒŒì‹± ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_command_capture_job</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubmitItem</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">job_ids</span> <span class="o">=</span> <span class="nf">_find_job_ids</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">raise_on_error</span> <span class="ow">and</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="nc">SubmitItem</span><span class="p">(</span><span class="n">index</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">cmd</span><span class="p">,</span> <span class="n">returncode</span><span class="o">=</span><span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">,</span> <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids</span><span class="p">)</span>

    <span class="c1"># --- bkill (ì˜µì…˜ ì—†ì´) ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">job_ids</span><span class="p">))]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">""</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bkill</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">raise_on_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span>

    <span class="c1"># --- bjobs ìŠ¤ëƒ…ìƒ· (ê³µìœ  ìºì‹œ + ì „ì—­ single-flight) ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="c1"># per-process(min: ë£¨í”„) rate-limit
</span>        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">since</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span>
        <span class="k">if</span> <span class="n">since</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">-</span> <span class="n">since</span><span class="p">)</span>

        <span class="n">flag</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-a </span><span class="sh">"</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bjobs</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> -noheader -u </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s">-o </span><span class="sh">'</span><span class="s">jobid stat exit_code queue exec_host</span><span class="sh">'"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_bjobs_ts</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

        <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">exec_host</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">jid_i</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">result</span><span class="p">[</span><span class="n">jid_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="n">stat</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="sh">"</span><span class="s">-</span><span class="sh">"</span> <span class="k">else</span> <span class="n">exit_code</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="n">queue</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="n">exec_host</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_status_all_cached</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all|</span><span class="si">{</span><span class="sh">'</span><span class="s">-a</span><span class="sh">'</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">''</span><span class="si">}</span><span class="s">|user=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="sh">"</span>

        <span class="c1"># 1) ê³µìœ  ìºì‹œ ë¨¼ì € ì¡°íšŒ
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
            <span class="n">cached</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cached</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">cached</span><span class="p">.</span><span class="nf">items</span><span class="p">()</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cached</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])}</span>

        <span class="c1"># 2) ì „ì—­ single-flightë¡œ fetch ë‹¨ì¼í™”
</span>        <span class="k">async</span> <span class="k">def</span> <span class="nf">_do_fetch</span><span class="p">():</span>
            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">items</span><span class="p">()})</span>
            <span class="k">return</span> <span class="n">data</span>

        <span class="k">if</span> <span class="n">force_refresh</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="nf">_do_fetch</span><span class="p">()</span>

        <span class="k">return</span> <span class="k">await</span> <span class="n">LoopSingleFlight</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">_do_fetch</span><span class="p">)</span>

    <span class="c1"># --- ì•ˆì „í•œ status (ëˆ„ë½ ìë™ ë³´ê°• + UNKNOWN ë³´ê°•) ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">status</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">all_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_status_all_cached</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="n">force_refresh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job_ids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_map</span>

        <span class="n">req_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">all_map</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req_ids</span><span class="p">}</span>

        <span class="c1"># ëˆ„ë½ ìˆìœ¼ë©´ 1íšŒ ê°•ì œ ìƒˆë¡œê³ ì¹¨
</span>        <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">out</span><span class="p">.</span><span class="nf">values</span><span class="p">()):</span>
            <span class="n">all_map2</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_status_all_cached</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req_ids</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="n">all_map2</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># ê·¸ë˜ë„ ì—†ìœ¼ë©´ UNKNOWN ë³´ê°•
</span>        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">UNKNOWN</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">_missing</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_unknown_seen_at</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="c1"># --- ì™„ë£Œ íŒì • ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">is_finished</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="nf">list</span><span class="p">({</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">st</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">include_done</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">stat</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stat</span> <span class="o">==</span> <span class="sh">"</span><span class="s">UNKNOWN</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">first</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_unknown_seen_at</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">now</span> <span class="o">-</span> <span class="n">first</span> <span class="o">&lt;</span> <span class="mf">15.0</span><span class="p">:</span>      <span class="c1"># ê¸°ë³¸ ê·¸ë ˆì´ìŠ¤ 15ì´ˆ (í•„ìš”ì‹œ self._unknown_grace ì‚¬ìš©)
</span>                    <span class="k">return</span> <span class="bp">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">stat</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">TERMINAL</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="c1"># --- ë°°ì¹˜ ì œì¶œ + ì·¨ì†Œ ---
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">commands</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">StrOrSeq</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="p">:</span> <span class="nb">callable</span><span class="p">,</span>            <span class="c1"># () -&gt; bool
</span>        <span class="n">poll_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">cmd_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">cleanup_on_interrupt</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>   <span class="c1"># Trueë©´ ì¸í„°ëŸ½íŠ¸ ì‹œ ìˆ˜ì§‘ëœ job_id ì¦‰ì‹œ bkill
</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubmitResult</span><span class="p">:</span>
        <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SubmitItem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">job_ids_all</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">job_id_to_cmd</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">in_flight</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubmitItem</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">run_command_capture_job</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">cmd_timeout</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">cmd_raise_on_error</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="nc">SubmitItem</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">returncode</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span>
                              <span class="n">stdout</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">job_ids</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">job_ids</span><span class="p">)</span>

        <span class="n">idx</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">or</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">in_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_in_flight</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">is_interrupted</span><span class="p">():</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">run_one</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">commands</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
                    <span class="n">in_flight</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                    <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll_interval_sec</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                        <span class="n">in_flight</span><span class="p">.</span><span class="nf">discard</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">item</span><span class="p">:</span> <span class="n">SubmitItem</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                            <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                                <span class="n">job_ids_all</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                                <span class="n">job_id_to_cmd</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">command</span>
                            <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                                <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">poll_interval_sec</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">ALL_COMPLETED</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">item</span><span class="p">:</span> <span class="n">SubmitItem</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                        <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                            <span class="n">job_ids_all</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                            <span class="n">job_id_to_cmd</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">command</span>
                        <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">interrupted</span> <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="nf">is_interrupted</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">interrupted</span> <span class="ow">and</span> <span class="n">cleanup_on_interrupt</span> <span class="ow">and</span> <span class="n">job_ids_all</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">job_ids_all</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">job_ids_all</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nb">dict</span><span class="p">.</span><span class="nf">fromkeys</span><span class="p">(</span><span class="n">job_ids_all</span><span class="p">))</span>
        <span class="k">return</span> <span class="nc">SubmitResult</span><span class="p">(</span>
            <span class="n">interrupted</span><span class="o">=</span><span class="n">interrupted</span><span class="p">,</span>
            <span class="n">items</span><span class="o">=</span><span class="n">items</span><span class="p">,</span>
            <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids_all</span><span class="p">,</span>
            <span class="n">job_id_to_command</span><span class="o">=</span><span class="n">job_id_to_cmd</span><span class="p">,</span>
            <span class="n">num_submitted</span><span class="o">=</span><span class="nf">len</span><span class="p">(</span><span class="n">job_ids_all</span><span class="p">),</span>
            <span class="n">num_failed</span><span class="o">=</span><span class="n">failures</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></div>

<h3 id="ì–´ë–»ê²Œ-ë‹¬ë¼ì¡Œë‚˜-step-by-step">ì–´ë–»ê²Œ ë‹¬ë¼ì¡Œë‚˜ (step-by-step)</h3>

<ol>
  <li>
    <p><strong>SharedCache ë©”ëª¨ë¦¬ ê³µìœ </strong> : <code class="language-plaintext highlighter-rouge">_MEM_SHARDS</code>ì— ë£¨íŠ¸(= <code class="language-plaintext highlighter-rouge">cache_dir/namespace</code>)ë³„ë¡œ ë”± <strong>í•œ ë²Œì˜ ë©”ëª¨ë¦¬ dict</strong> ë§Œ ì¡´ì¬ â†’ ê°™ì€ í”„ë¡œì„¸ìŠ¤/ë£¨í”„ì˜ ì—¬ëŸ¬ <code class="language-plaintext highlighter-rouge">LSFClient</code>ê°€ <strong>ë™ì¼ ë©”ëª¨ë¦¬ ìºì‹œ</strong> ë¥¼ ì”€.</p>
  </li>
  <li>
    <p><strong>ì „ì—­ single-flight</strong> : <code class="language-plaintext highlighter-rouge">LoopSingleFlight.run(key, _do_fetch)</code>ë¡œ <code class="language-plaintext highlighter-rouge">bjobs</code> ìŠ¤ëƒ…ìƒ· fetchë¥¼ ë£¨í”„ ì „ì—­ 1íšŒë¡œ ì œí•œ.</p>
  </li>
  <li>
    <p><strong>ë™ì‹œ ì‹¤í–‰ ìƒí•œ</strong> : <code class="language-plaintext highlighter-rouge">LoopSharedSemaphore</code>ë¡œ ë£¨í”„ ì „ì—­ ë™ì‹œ ì‹¤í–‰ ìˆ˜ ì œì–´(ì›í•˜ë©´ <code class="language-plaintext highlighter-rouge">configure_global_cli_concurrency(N)</code> í˜¸ì¶œ).</p>
  </li>
</ol>

<p>ì´ì œ í•œ í”„ë¡œì„¸ìŠ¤ì—ì„œ <code class="language-plaintext highlighter-rouge">LSFClient</code>ë¥¼ ì—¬ëŸ¬ ê°œ ë§Œë“¤ì–´ë„:</p>

<ul>
  <li>
    <p>ì…¸ ì‹¤í–‰ <strong>ë™ì‹œì„± ìƒí•œì´ ëŠ˜ì§€ ì•Šê³ </strong> ,</p>
  </li>
  <li>
    <p><strong>ë©”ëª¨ë¦¬ ìºì‹œ/ë‹¨ì¼ í”Œë¼ì´íŠ¸ë„ ì¤‘ë³µë˜ì§€ ì•Šì•„ì„œ</strong> ë¶ˆí•„ìš”í•œ <code class="language-plaintext highlighter-rouge">bjobs</code> ì‹¤í–‰ì´ ì‚¬ì‹¤ìƒ 1íšŒë¡œ í•©ì³ì§‘ë‹ˆë‹¤.</p>
  </li>
</ul>

<p>í•„ìš”í•˜ë©´ ìºì‹œ ë£¨íŠ¸(<code class="language-plaintext highlighter-rouge">cache_dir</code>, <code class="language-plaintext highlighter-rouge">namespace</code>)ë¥¼ íŒ€/ìœ ì € ë‹¨ìœ„ë¡œ ë‚˜ëˆ ì„œ ê²©ë¦¬í•  ìˆ˜ë„ ìˆì–´ìš”.</p>

<p class="chat--user">

ì´ë ‡ê²Œ ë³µì¡í•´ì§ˆ ì¼ì¸ê°€ ì‹¶ë„¤. ê·¸ëƒ¥ ì´ë²¤íŠ¸ ë£¨í”„ëŠ” 1ê°œë¼ê³  ê°€ì •í•˜ê³  ëª¨ë‘ ê³µìœ í•˜ë©´ ì•ˆë¼?

</p>

<p>ì¢‹ì•„, <strong>â€œì´ë²¤íŠ¸ ë£¨í”„ëŠ” 1ê°œë¼ê³  ê°€ì •â€</strong>í•˜ê³ , <strong>í”„ë¡œì„¸ìŠ¤ ì „ì—­ìœ¼ë¡œ ëª¨ë‘ ê³µìœ </strong> í•˜ë„ë¡ ê¹”ë”í•˜ê²Œ ì •ë¦¬í–ˆì–´.<br />
ì „ì—­ ê³µìœ  ëŒ€ìƒ: <strong>ì„¸ë§ˆí¬ì–´(ë™ì‹œ ì‹¤í–‰ ìƒí•œ), ë©”ëª¨ë¦¬ ìºì‹œ, single-flight, bjobs rate-limit</strong>.</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bkill</code>ì€ <strong>ì˜µì…˜ ì—†ì´</strong> ë§Œ ì‚¬ìš©.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bjobs</code>ëŠ” <strong>ì „ì²´ ìŠ¤ëƒ…ìƒ· 1íšŒ</strong> + <strong>ë©”ëª¨ë¦¬/ë””ìŠ¤í¬ TTL ìºì‹œ</strong> + <strong>ì „ì—­ single-flight</strong> , ê³¼í˜¸ì¶œ ë°©ì§€.</p>
  </li>
  <li>
    <p>ìŠ¤ëƒ…ìƒ·ì— <strong>ëˆ„ë½</strong> ë˜ë©´ 1íšŒ ê°•ì œ ê°±ì‹  â†’ ê·¸ë˜ë„ ì—†ìœ¼ë©´ <code class="language-plaintext highlighter-rouge">{"stat":"UNKNOWN"}</code> ìœ¼ë¡œ <strong>ë³´ê°•</strong>(ì—ëŸ¬ X).</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">is_finished()</code>ëŠ” <code class="language-plaintext highlighter-rouge">UNKNOWN</code>ì„ <strong>ê·¸ë ˆì´ìŠ¤(ê¸°ë³¸ 15s)</strong> ë™ì•ˆì€ â€œë¯¸ì™„ë£Œâ€ë¡œ ê°„ì£¼, ì´í›„ ì™„ë£Œë¡œ ê°„ì£¼.</p>
  </li>
  <li>
    <p><strong>ì „ì—­ ë™ì‹œ ì‹¤í–‰ ìˆ˜</strong> ëŠ” <code class="language-plaintext highlighter-rouge">configure_global_cli_concurrency(N)</code>ë¡œ í•œ ë²ˆë§Œ ì„¤ì •(í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì „ ê¶Œì¥).</p>
  </li>
</ul>

<hr />
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># lsf_simple.py
</span><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>
<span class="kn">import</span> <span class="n">getpass</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1"># ===================== ì „ì—­ ì„¤ì •/ê³µìœ  ìƒíƒœ =====================
</span><span class="n">_DEFAULT_CONCURRENCY</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">_SEM</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">Semaphore</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>                 <span class="c1"># í”„ë¡œì„¸ìŠ¤ ì „ì—­ ì„¸ë§ˆí¬ì–´(ë‹¨ì¼ ì´ë²¤íŠ¸ ë£¨í”„ ê°€ì •)
</span><span class="n">_MEM_CACHE</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>           <span class="c1"># í”„ë¡œì„¸ìŠ¤ ì „ì—­ ë©”ëª¨ë¦¬ ìºì‹œ
</span><span class="n">_INFLIGHT</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Future</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>               <span class="c1"># í”„ë¡œì„¸ìŠ¤ ì „ì—­ single-flight (key -&gt; Future)
</span><span class="n">_LAST_BJOBS_CALL</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>                 <span class="c1"># rate-limitìš© ë§ˆì§€ë§‰ í˜¸ì¶œì‹œê° (key= f"{user}|{'a' if include_done else ''}")
</span>
<span class="k">def</span> <span class="nf">configure_global_cli_concurrency</span><span class="p">(</span><span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">í”„ë¡œì„¸ìŠ¤ ì „ì—­ CLI ë™ì‹œ ì‹¤í–‰ ìƒí•œì„ ì„¤ì •. ê°€ëŠ¥í•œ í•œ í´ë¼ì´ì–¸íŠ¸ ì‚¬ìš© ì „ì— í˜¸ì¶œí•˜ì„¸ìš”.</span><span class="sh">"""</span>
    <span class="k">global</span> <span class="n">_DEFAULT_CONCURRENCY</span>
    <span class="n">_DEFAULT_CONCURRENCY</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">limit</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_get_global_sem</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Semaphore</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_SEM</span>
    <span class="k">if</span> <span class="n">_SEM</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">_SEM</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="n">_DEFAULT_CONCURRENCY</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_SEM</span>

<span class="c1"># ===================== ê³µìš© ìœ í‹¸ =====================
</span><span class="n">StrOrSeq</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
<span class="n">_JOBID_RE</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">cmd</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_find_job_ids</span><span class="p">(</span><span class="o">*</span><span class="n">texts</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="n">ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">:</span> 
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">_JOBID_RE</span><span class="p">.</span><span class="nf">finditer</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">ids</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span> <span class="k">pass</span>
    <span class="c1"># ì¤‘ë³µ ì œê±°(ì¶œë ¥ ì¤‘ë³µ ëŒ€ë¹„)
</span>    <span class="k">return</span> <span class="nf">list</span><span class="p">(</span><span class="nb">dict</span><span class="p">.</span><span class="nf">fromkeys</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="nb">RuntimeError</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Command failed: </span><span class="si">{</span><span class="n">cmd_str</span><span class="si">}</span><span class="s"> (rc=</span><span class="si">{</span><span class="n">returncode</span><span class="si">}</span><span class="s">)</span><span class="se">\n</span><span class="si">{</span><span class="n">stderr</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">cmd_str</span><span class="p">,</span> <span class="n">returncode</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span>

<span class="c1"># ===================== ShellRunner (ì „ì—­ ì„¸ë§ˆí¬ì–´ ê³µìœ ) =====================
</span><span class="k">class</span> <span class="nc">ShellRunner</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">create_subprocess_shell + ì „ì—­ ì„¸ë§ˆí¬ì–´ë¡œ ë™ì‹œ ì‹¤í–‰ ì œí•œ</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">base_env</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LC_ALL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">base_env</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">LANG</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_env</span> <span class="o">=</span> <span class="n">base_env</span> <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="bp">None</span> <span class="nf">else </span><span class="p">(</span><span class="n">base_env</span> <span class="o">|</span> <span class="n">env</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cmd_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">sem</span> <span class="o">=</span> <span class="nf">_get_global_sem</span><span class="p">()</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">sem</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_shell</span><span class="p">(</span>
                <span class="n">cmd_str</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">_env</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">ProcessLookupError</span><span class="p">):</span>
                <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>

<span class="c1"># ===================== SharedCache (í”„ë¡œì„¸ìŠ¤ ì „ì—­ ë©”ëª¨ë¦¬ + ë””ìŠ¤í¬) =====================
</span><span class="k">class</span> <span class="nc">SharedCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ë©€í‹°í”„ë¡œì„¸ìŠ¤ ê³µìœ  JSON ìºì‹œ + í”„ë¡œì„¸ìŠ¤ ì „ì—­ ë©”ëª¨ë¦¬:
      - ë©”ëª¨ë¦¬ TTL: _MEM_CACHE ì‚¬ìš©
      - ë””ìŠ¤í¬ TTL: tmp -&gt; fsync(tmp) -&gt; os.replace -&gt; fsync(dir)
      - ì‹ ì„ ë„: JSON ë‚´ë¶€ tsì™€ íŒŒì¼ mtime ëª¨ë‘ë¡œ íŒì •(+2s skew í—ˆìš©)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ttl_sec</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">,</span> <span class="n">skew_eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">cache_dir</span> <span class="ow">or</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">XDG_CACHE_HOME</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">expanduser</span><span class="p">(</span><span class="sh">"</span><span class="s">~</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">.cache</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_root</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_skew</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">skew_eps</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_key_path</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">safe</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">[^A-Za-z0-9._-]+</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">safe</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># 1) í”„ë¡œì„¸ìŠ¤ ì „ì—­ ë©”ëª¨ë¦¬
</span>        <span class="n">item</span> <span class="o">=</span> <span class="n">_MEM_CACHE</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">:</span>
            <span class="n">ts</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ttl</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="c1"># 2) ë””ìŠ¤í¬
</span>        <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_key_path</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">stat</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="n">ts_in</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">fresh_by_ts</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">ts_in</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">)</span> <span class="k">if</span> <span class="n">ts_in</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">False</span>
            <span class="n">fresh_by_mtime</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="nf">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">st</span><span class="p">.</span><span class="n">st_mtime</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ttl</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">_skew</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fresh_by_ts</span> <span class="ow">or</span> <span class="n">fresh_by_mtime</span><span class="p">:</span>
                <span class="n">_MEM_CACHE</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">_MEM_CACHE</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_key_path</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">dir_fd</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fd</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="p">.</span><span class="nf">mkstemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="sh">"</span><span class="s">cache_</span><span class="sh">"</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">"</span><span class="s">.json</span><span class="sh">"</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">fdopen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">},</span> <span class="n">f</span><span class="p">)</span>
                    <span class="n">f</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="nf">fileno</span><span class="p">())</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>     <span class="c1"># ê°™ì€ FS ë‚´ ì›ìì 
</span>                <span class="n">os</span><span class="p">.</span><span class="nf">fsync</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>       <span class="c1"># ë©”íƒ€ë°ì´í„° ì˜ì†
</span>            <span class="k">finally</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">FileNotFoundError</span><span class="p">):</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">)</span>

<span class="c1"># ===================== ê²°ê³¼ íƒ€ì… =====================
</span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SubmitItem</span><span class="p">:</span>
    <span class="n">index</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">returncode</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">stderr</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">job_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SubmitResult</span><span class="p">:</span>
    <span class="n">interrupted</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SubmitItem</span><span class="p">]</span>
    <span class="n">job_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>                    <span class="c1"># í‰íƒ„í™”ëœ ì „ì²´ Job ID
</span>    <span class="n">job_id_to_command</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>     <span class="c1"># Job ID -&gt; ì› ì»¤ë§¨ë“œ
</span>    <span class="n">num_submitted</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">num_failed</span><span class="p">:</span> <span class="nb">int</span>

<span class="c1"># ===================== LSFClient =====================
</span><span class="k">class</span> <span class="nc">LSFClient</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - run_command_capture_job: ì»¤ë§¨ë“œ ê·¸ëŒ€ë¡œ ì‹¤í–‰, ì¶œë ¥ì—ì„œ </span><span class="sh">'</span><span class="s">Job &lt;id&gt;</span><span class="sh">'</span><span class="s">(ë³µìˆ˜ ê°€ëŠ¥) íŒŒì‹±
    - kill: ìˆœìˆ˜ bkill (ì˜µì…˜ ì—†ì´)
    - status: bjobs ì „ì²´ ìŠ¤ëƒ…ìƒ·(ì „ì—­ ìºì‹œ + ì „ì—­ single-flight + rate-limit)
              ëˆ„ë½ ì‹œ 1íšŒ ê°•ì œ ê°±ì‹  â†’ ê·¸ë˜ë„ ì—†ìœ¼ë©´ UNKNOWN ë³´ê°•
    - submit_many_with_cancel: ì¸í„°ëŸ½íŠ¸ ì‹œ ìƒˆ ì‹¤í–‰ ì¤‘ë‹¨, ì§„í–‰ ì¤‘ì€ ì™„ì£¼ â†’ ìˆ˜ì§‘ job_id í•„ìš”ì‹œ bkill
    - is_finished: UNKNOWN ê·¸ë ˆì´ìŠ¤(ê¸°ë³¸ 15s) ë™ì•ˆì€ ë¯¸ì™„ë£Œë¡œ ì·¨ê¸‰
    </span><span class="sh">"""</span>
    <span class="n">TERMINAL</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">DONE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">EXIT</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ZOMBI</span><span class="sh">"</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">bkill</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">bjobs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">bjobs_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">unknown_grace_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">15.0</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_paths</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">bkill</span><span class="sh">"</span><span class="p">:</span> <span class="n">bkill</span><span class="p">,</span> <span class="sh">"</span><span class="s">bjobs</span><span class="sh">"</span><span class="p">:</span> <span class="n">bjobs</span><span class="p">}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_runner</span> <span class="o">=</span> <span class="nc">ShellRunner</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_user</span> <span class="o">=</span> <span class="n">user</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LSF_USER</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">getpass</span><span class="p">.</span><span class="nf">getuser</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="nc">SharedCache</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">ttl_sec</span><span class="o">=</span><span class="n">disk_cache_ttl_sec</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="sh">"</span><span class="s">lsf_async</span><span class="sh">"</span><span class="p">,</span> <span class="n">skew_eps</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_ttl</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_ttl_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">bjobs_min_interval_sec</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_unknown_seen_at</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_unknown_grace</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">unknown_grace_sec</span><span class="p">)</span>

    <span class="c1"># ---- ì¼ë°˜ ì»¤ë§¨ë“œ ì‹¤í–‰ + Job ID íŒŒì‹± ----
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_command_capture_job</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubmitItem</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nf">_to_shell_str</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">job_ids</span> <span class="o">=</span> <span class="nf">_find_job_ids</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">raise_on_error</span> <span class="ow">and</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="nc">SubmitItem</span><span class="p">(</span><span class="n">index</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">cmd</span><span class="p">,</span> <span class="n">returncode</span><span class="o">=</span><span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">,</span> <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids</span><span class="p">)</span>

    <span class="c1"># ---- bkill (ì˜µì…˜ ì—†ì´) ----
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">job_ids</span><span class="p">))]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">""</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bkill</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">raise_on_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span>

    <span class="c1"># ---- bjobs ì „ì²´ ìŠ¤ëƒ…ìƒ· (ì „ì—­ ìºì‹œ + single-flight + rate-limit) ----
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="c1"># ì „ì—­ rate-limit: user &amp; include_done ì¡°í•©ë³„ë¡œ ì œí•œ
</span>        <span class="n">rl_key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="s">|</span><span class="si">{</span><span class="sh">'</span><span class="s">a</span><span class="sh">'</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">''</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">since</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">_LAST_BJOBS_CALL</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">rl_key</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">since</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_bjobs_min_interval</span> <span class="o">-</span> <span class="n">since</span><span class="p">)</span>

        <span class="n">flag</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-a </span><span class="sh">"</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">""</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_paths</span><span class="p">[</span><span class="sh">'</span><span class="s">bjobs</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> -noheader -u </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s">-o </span><span class="sh">'</span><span class="s">jobid stat exit_code queue exec_host</span><span class="sh">'"</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">_runner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">_LAST_BJOBS_CALL</span><span class="p">[</span><span class="n">rl_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">LSFCommandError</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

        <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">exec_host</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">jid_i</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">result</span><span class="p">[</span><span class="n">jid_i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="n">stat</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="sh">"</span><span class="s">-</span><span class="sh">"</span> <span class="k">else</span> <span class="n">exit_code</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="n">queue</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="n">exec_host</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_status_all_cached</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span> <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">bjobs_all|</span><span class="si">{</span><span class="sh">'</span><span class="s">-a</span><span class="sh">'</span> <span class="k">if</span> <span class="n">include_done</span> <span class="k">else</span> <span class="sh">''</span><span class="si">}</span><span class="s">|user=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_user</span><span class="si">}</span><span class="sh">"</span>

        <span class="c1"># 1) ì „ì—­ ìºì‹œ ë¨¼ì €
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
            <span class="n">cached</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cached</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="nf">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">cached</span><span class="p">.</span><span class="nf">items</span><span class="p">()</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cached</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])}</span>

        <span class="c1"># 2) ì „ì—­ single-flight: ê°™ì€ keyë¡œ ë™ì‹œì— ë“¤ì–´ì˜¤ë©´ 1íšŒë§Œ fetch
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
            <span class="n">fut</span> <span class="o">=</span> <span class="n">_INFLIGHT</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fut</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">fut</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">().</span><span class="nf">create_future</span><span class="p">()</span>
                <span class="n">_INFLIGHT</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fut</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">items</span><span class="p">()})</span>
                    <span class="n">fut</span><span class="p">.</span><span class="nf">set_result</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">fut</span><span class="p">.</span><span class="nf">set_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">_INFLIGHT</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">fut</span>

        <span class="c1"># ê°•ì œ ê°±ì‹  ê²½ë¡œ
</span>        <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fetch_bjobs_all</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cache</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">items</span><span class="p">()})</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="c1"># ---- ì•ˆì „í•œ status (ëˆ„ë½ ìë™ ë³´ê°•) ----
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">status</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">include_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span> <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">all_map</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_status_all_cached</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="n">force_refresh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job_ids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_map</span>

        <span class="n">req_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">all_map</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req_ids</span><span class="p">}</span>

        <span class="c1"># ëˆ„ë½ ìˆìœ¼ë©´ 1íšŒ ê°•ì œ ê°±ì‹ 
</span>        <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">out</span><span class="p">.</span><span class="nf">values</span><span class="p">()):</span>
            <span class="n">all_map2</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_status_all_cached</span><span class="p">(</span><span class="n">include_done</span><span class="o">=</span><span class="n">include_done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">force_refresh</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req_ids</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="n">all_map2</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># ê·¸ë˜ë„ ì—†ìœ¼ë©´ UNKNOWN ë³´ê°• + ì²« ë°œê²¬ ì‹œê° ê¸°ë¡
</span>        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">req_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">UNKNOWN</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">exit_code</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">queue</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">exec_host</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">_missing</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_unknown_seen_at</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="c1"># ---- ì™„ë£Œ íŒì • ----
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">is_finished</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="nf">list</span><span class="p">({</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">st</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">include_done</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">stat</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stat</span> <span class="o">==</span> <span class="sh">"</span><span class="s">UNKNOWN</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">first</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_unknown_seen_at</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">now</span> <span class="o">-</span> <span class="n">first</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">_unknown_grace</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">stat</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">TERMINAL</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="c1"># ---- ë°°ì¹˜ ì œì¶œ + ì·¨ì†Œ ----
</span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit_many_with_cancel</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span>
        <span class="n">commands</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">StrOrSeq</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">is_interrupted</span><span class="p">:</span> <span class="nb">callable</span><span class="p">,</span>            <span class="c1"># () -&gt; bool
</span>        <span class="n">poll_interval_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="n">max_in_flight</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">cmd_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">cmd_raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">cleanup_on_interrupt</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>   <span class="c1"># Trueë©´ ì¸í„°ëŸ½íŠ¸ ì‹œ ìˆ˜ì§‘ëœ job_id ì¦‰ì‹œ bkill
</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubmitResult</span><span class="p">:</span>
        <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SubmitItem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">job_ids_all</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">job_id_to_cmd</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">in_flight</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="n">StrOrSeq</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SubmitItem</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">run_command_capture_job</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">cmd_timeout</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">cmd_raise_on_error</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="nc">SubmitItem</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">returncode</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span>
                              <span class="n">stdout</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">job_ids</span><span class="o">=</span><span class="n">res</span><span class="p">.</span><span class="n">job_ids</span><span class="p">)</span>

        <span class="n">idx</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">or</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">in_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_in_flight</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">is_interrupted</span><span class="p">():</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">run_one</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">commands</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
                    <span class="n">in_flight</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                    <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">poll_interval_sec</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                        <span class="n">in_flight</span><span class="p">.</span><span class="nf">discard</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">item</span><span class="p">:</span> <span class="n">SubmitItem</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                            <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                                <span class="n">job_ids_all</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                                <span class="n">job_id_to_cmd</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">command</span>
                            <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                                <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">poll_interval_sec</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">in_flight</span><span class="p">:</span>
                <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">in_flight</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">ALL_COMPLETED</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">item</span><span class="p">:</span> <span class="n">SubmitItem</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
                        <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                            <span class="n">job_ids_all</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                            <span class="n">job_id_to_cmd</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">command</span>
                        <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">item</span><span class="p">.</span><span class="n">job_ids</span><span class="p">:</span>
                            <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">interrupted</span> <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="nf">is_interrupted</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">interrupted</span> <span class="ow">and</span> <span class="n">cleanup_on_interrupt</span> <span class="ow">and</span> <span class="n">job_ids_all</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">job_ids_all</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">job_ids_all</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nb">dict</span><span class="p">.</span><span class="nf">fromkeys</span><span class="p">(</span><span class="n">job_ids_all</span><span class="p">))</span>
        <span class="k">return</span> <span class="nc">SubmitResult</span><span class="p">(</span>
            <span class="n">interrupted</span><span class="o">=</span><span class="n">interrupted</span><span class="p">,</span>
            <span class="n">items</span><span class="o">=</span><span class="n">items</span><span class="p">,</span>
            <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids_all</span><span class="p">,</span>
            <span class="n">job_id_to_command</span><span class="o">=</span><span class="n">job_id_to_cmd</span><span class="p">,</span>
            <span class="n">num_submitted</span><span class="o">=</span><span class="nf">len</span><span class="p">(</span><span class="n">job_ids_all</span><span class="p">),</span>
            <span class="n">num_failed</span><span class="o">=</span><span class="n">failures</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="ì‚¬ìš©-ì˜ˆì‹œ-ì§ˆë¬¸-ì¤€-íŒ¨í„´-ê·¸ëŒ€ë¡œ">ì‚¬ìš© ì˜ˆì‹œ (ì§ˆë¬¸ ì¤€ íŒ¨í„´ ê·¸ëŒ€ë¡œ)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">lsf_simple</span> <span class="kn">import</span> <span class="n">LSFClient</span><span class="p">,</span> <span class="n">configure_global_cli_concurrency</span>

<span class="c1"># 1) ì „ì—­ ë™ì‹œ ì‹¤í–‰ ìƒí•œ (í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì „ 1íšŒ)
</span><span class="nf">configure_global_cli_concurrency</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Token</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span> <span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">(),</span> <span class="n">delay</span>
    <span class="k">def</span> <span class="nf">is_interrupted</span><span class="p">(</span><span class="n">self</span><span class="p">):</span> <span class="nf">return </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span><span class="o">-</span><span class="n">self</span><span class="p">.</span><span class="n">t0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">LSFClient</span><span class="p">(</span>
        <span class="n">bjobs_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">bjobs_min_interval_sec</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>
        <span class="n">disk_cache_ttl_sec</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="o">=</span><span class="sh">"</span><span class="s">/shared/cache</span><span class="sh">"</span><span class="p">,</span>     <span class="c1"># ì—¬ëŸ¬ ë¨¸ì‹ ì´ ê³µìœ í•˜ëŠ” FSë©´ ë” ì¢‹ì•„ìš”
</span>        <span class="n">unknown_grace_sec</span><span class="o">=</span><span class="mf">15.0</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">is_interrupted</span> <span class="o">=</span> <span class="nc">Token</span><span class="p">(</span><span class="n">delay</span><span class="o">=</span><span class="mi">9999</span><span class="p">).</span><span class="n">is_interrupted</span>  <span class="c1"># ì‹¤ì œë¡  ì™¸ë¶€ ì‹ í˜¸ë¡œ ëŒ€ì²´
</span>
    <span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">job_sub a.txt</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">mkdir package</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">bsub -q short sleep 3</span><span class="sh">"</span><span class="p">]</span>

    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">submit_many_with_cancel</span><span class="p">(</span><span class="n">cmds</span><span class="p">,</span> <span class="n">is_interrupted</span><span class="o">=</span><span class="n">is_interrupted</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span><span class="p">.</span><span class="n">interrupted</span> <span class="ow">or</span> <span class="nf">is_interrupted</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">job_ids</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">job_ids</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">job_ids</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ì œì¶œëœ LSF ì¡ì´ ì—†ìŠµë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">is_finished</span><span class="p">(</span><span class="n">job_ids</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">job_id</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">job_command</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">job_id_to_command</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="sh">"</span><span class="s">&lt;unknown&gt;</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">status</span><span class="p">[</span><span class="n">job_id</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">stat</span><span class="sh">"</span><span class="p">),</span> <span class="n">job_command</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">is_interrupted</span><span class="p">():</span>
            <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>  <span class="c1"># ìˆœìˆ˜ bkill
</span>            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ì¤‘ì§€í•˜ì˜€ìŠµë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ëª¨ë‘ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h3 id="ì™œ-ì´-ë²„ì „ì´-ë”±-ì¢‹ì€ì§€-step-by-step">ì™œ ì´ ë²„ì „ì´ ë”± ì¢‹ì€ì§€ (step-by-step)</h3>

<ol>
  <li>
    <p><strong>ë‹¨ì¼ ì´ë²¤íŠ¸ ë£¨í”„ ê°€ì •</strong> í•˜ì— ì „ì—­ ê³µìœ  â†’ ë³µì¡ë„ ìµœì†Œ, ì˜ë„ ëª…í™•.</p>
  </li>
  <li>
    <p><strong>ì „ì—­ ì„¸ë§ˆí¬ì–´/ìºì‹œ/single-flight/rate-limit</strong> ë¡œ <code class="language-plaintext highlighter-rouge">LSFClient</code>ê°€ ì—¬ëŸ¬ ê°œì—¬ë„ í˜¸ì¶œëŸ‰Â·ë¶€í•˜ê°€ ëŠ˜ì§€ ì•ŠìŒ.</p>
  </li>
  <li>
    <p><strong>ì—ëŸ¬ ìµœì†Œí™”</strong> : ìŠ¤ëƒ…ìƒ· ëˆ„ë½ì‹œ ìë™ ê°±ì‹  &amp; <code class="language-plaintext highlighter-rouge">UNKNOWN</code> ë³´ê°•, ë£¨í”„ê°€ ë©ˆì¶”ì§€ ì•Šë„ë¡ <code class="language-plaintext highlighter-rouge">is_finished</code> ê·¸ë ˆì´ìŠ¤ ì²˜ë¦¬.</p>
  </li>
  <li>
    <p><strong>í˜„ì‹¤ì  ì„±ëŠ¥</strong> : <code class="language-plaintext highlighter-rouge">bjobs</code>ëŠ” í•­ìƒ ì „ì²´ ìŠ¤ëƒ…ìƒ· 1íšŒ â†’ ìºì‹œë¡œ ì¬ì‚¬ìš©, I/O/ë¶€í•˜ ì ˆê°.</p>
  </li>
</ol>

<p>í•„ìš”í•œ ê±° ë” ì¤„ì´ê±°ë‚˜(ì˜ˆ: í´ë˜ìŠ¤ 1ê°œë¡œ í•©ì¹˜ê¸°), ë¡œê¹…/ë©”íŠ¸ë¦­ í›…ë§Œ ì–¹ê³  ì‹¶ìœ¼ë©´ ë§í•´ì¤˜.</p>]]></content><author><name>hvppyarchive</name></author><category term="python" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">Asyncio ì‚¬ìš©ë²• ì„¤ëª…</title><link href="https://hvppyarchive.github.io/python/python-asyncio-basic/" rel="alternate" type="text/html" title="Asyncio ì‚¬ìš©ë²• ì„¤ëª…" /><published>2025-10-13T14:06:20+09:00</published><updated>2025-10-13T14:06:20+09:00</updated><id>https://hvppyarchive.github.io/python/python-asyncio-basic</id><content type="html" xml:base="https://hvppyarchive.github.io/python/python-asyncio-basic/"><![CDATA[<p class="chat--user">

python asyncioë¥¼ ì´ìš©í•œ í”„ë¡œê·¸ë˜ë° í•˜ëŠ” ë²• ì•Œë ¤ì¤˜. íŒŒì´ì¬ì€ ë§ì´ ì¨ë´¤ì§€ë§Œ ì´ê±´ í•œ ë²ˆ ë„ ì•ˆ ì¨ë³¸ ì‚¬ëŒ ê¸°ì¤€ìœ¼ë¡œ ì‰½ê²Œ ì„¤ëª…í•´ì¤˜.

</p>

<p>ì¢‹ì•„ìš”! â€œasyncioâ€ëŠ” <strong>ë‹¨ì¼ ìŠ¤ë ˆë“œì—ì„œ I/Oë¥¼ ë™ì‹œì— ì²˜ë¦¬</strong> í•˜ê²Œ í•´ì£¼ëŠ” íŒŒì´ì¬ í‘œì¤€ ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ˆìš”. ì²˜ìŒ ì“°ëŠ” ë¶„ ê¸°ì¤€ìœ¼ë¡œ, ê°œë…â†’ì˜ˆì œâ†’ìì£¼ ì“°ëŠ” íŒ¨í„´ ìˆœì„œë¡œ ì•„ì£¼ ì²œì²œíˆ ê°ˆê²Œìš”.</p>

<hr />

<h1 id="1-í•µì‹¬-ê°œë…-3ê°€ì§€ë§Œ-ë¨¼ì €">1) í•µì‹¬ ê°œë… 3ê°€ì§€ë§Œ ë¨¼ì €</h1>

<ol>
  <li>
    <p><strong>ì½”ë£¨í‹´(coroutine)</strong> : <code class="language-plaintext highlighter-rouge">async def</code>ë¡œ ë§Œë“  í•¨ìˆ˜. ë‚´ë¶€ì—ì„œ <code class="language-plaintext highlighter-rouge">await</code>ë¡œ â€œì ê¹ ì‰¬ì—ˆë‹¤ê°€ ë‹¤ì‹œâ€ë¥¼ í•  ìˆ˜ ìˆì–´ìš”.</p>
  </li>
  <li>
    <p><strong>await</strong> : â€œì´ ì‘ì—… ëë‚  ë•Œê¹Œì§€ ë‹¤ë¥¸ ì¼ ì¢€ í•˜ë‹¤ê°€ ì˜¬ê²Œ!â€ë¼ëŠ” ëœ». ì£¼ë¡œ ë„¤íŠ¸ì›Œí¬/ë””ìŠ¤í¬ I/Oì²˜ëŸ¼ <strong>ê¸°ë‹¤ë¦¬ëŠ” ì‹œê°„</strong> ì´ ìˆëŠ” ì¼ì— ì‚¬ìš©.</p>
  </li>
  <li>
    <p><strong>ì´ë²¤íŠ¸ ë£¨í”„(event loop)</strong> : ì½”ë£¨í‹´ë“¤ì„ ëŒë ¤ì£¼ëŠ” ì—”ì§„. ë³´í†µ <code class="language-plaintext highlighter-rouge">asyncio.run(main())</code>ìœ¼ë¡œ ì‹œì‘í•´ìš”.</p>
  </li>
</ol>

<blockquote>
  <p>ê¸°ì–µë²•: â€œ<code class="language-plaintext highlighter-rouge">async def</code>ë¡œ ì½”ë£¨í‹´ ë§Œë“¤ê³ , ëŠë¦° ê³³ì—ì„œ <code class="language-plaintext highlighter-rouge">await</code>, ì „ì²´ëŠ” <code class="language-plaintext highlighter-rouge">asyncio.run()</code>ìœ¼ë¡œ ì‹œì‘!â€</p>
</blockquote>

<hr />

<h1 id="2-ì²«-ë²ˆì§¸-ì˜ˆì œ-ìˆœì°¨-vs-ë™ì‹œ">2) ì²« ë²ˆì§¸ ì˜ˆì œ: ìˆœì°¨ vs. ë™ì‹œ</h1>

<p>ì•„ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ëŒ€ê¸°ë¥¼ í‰ë‚´ ë‚´ë ¤ê³  <code class="language-plaintext highlighter-rouge">asyncio.sleep()</code>ì„ ì‚¬ìš©í•´ìš”.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># sequential.py (ìˆœì°¨ ì‹¤í–‰)
</span><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">time</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">work</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sec</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">sec</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s"> ì™„ë£Œ</span><span class="sh">"</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
    <span class="k">await</span> <span class="nf">work</span><span class="p">(</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>   <span class="c1"># 2ì´ˆ
</span>    <span class="k">await</span> <span class="nf">work</span><span class="p">(</span><span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>   <span class="c1"># ë˜ 2ì´ˆ (ì´ 4ì´ˆ)
</span>    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ê±¸ë¦° ì‹œê°„: </span><span class="si">{</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># concurrent.py (ë™ì‹œ ì‹¤í–‰)
</span><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">time</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">work</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sec</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">sec</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s"> ì™„ë£Œ</span><span class="sh">"</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
    <span class="c1"># ë™ì‹œ ì‹¤í–‰ í•µì‹¬: gather ë˜ëŠ” create_task
</span>    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">gather</span><span class="p">(</span>
        <span class="nf">work</span><span class="p">(</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="nf">work</span><span class="p">(</span><span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ê±¸ë¦° ì‹œê°„: </span><span class="si">{</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<ul>
  <li>
    <p>ìˆœì°¨: ì•½ <strong>4ì´ˆ</strong></p>
  </li>
  <li>
    <p>ë™ì‹œ: ì•½ <strong>2ì´ˆ</strong><br />
â†’ <strong>I/O ëŒ€ê¸° ì‹œê°„ì„ ê²¹ì³ì„œ</strong> ì¤„ì´ëŠ” ê²Œ asyncioì˜ ë³¸ì§ˆì´ì—ìš”.</p>
  </li>
</ul>

<hr />

<h1 id="3-ì–´ë–»ê²Œ-ë™ì‹œë¡œ-ëŒë¦¬ë‚˜-gather--create_task">3) ì–´ë–»ê²Œ ë™ì‹œë¡œ ëŒë¦¬ë‚˜? (gather / create_task)</h1>

<h3 id="asynciogather"><code class="language-plaintext highlighter-rouge">asyncio.gather(...)</code></h3>

<ul>
  <li>
    <p>ì—¬ëŸ¬ ì½”ë£¨í‹´ì„ í•œ ë²ˆì— ëŒë¦¬ê³  <strong>ëª¨ë‘ ëë‚  ë•Œê¹Œì§€</strong> ê¸°ë‹¤ë ¤ìš”.</p>
  </li>
  <li>
    <p>ì‹¤íŒ¨í•˜ë©´ <code class="language-plaintext highlighter-rouge">gather</code>ê°€ ì˜ˆì™¸ë¥¼ ì˜¬ë ¤ì¤˜ì„œ í•œ ë²ˆì— ì²˜ë¦¬í•˜ê¸° í¸í•´ìš”.</p>
  </li>
</ul>

<h3 id="asynciocreate_taskcoro"><code class="language-plaintext highlighter-rouge">asyncio.create_task(coro)</code></h3>

<ul>
  <li>
    <p>ì½”ë£¨í‹´ì„ <strong>ë°±ê·¸ë¼ìš´ë“œ íƒœìŠ¤í¬</strong> ë¡œ ë“±ë¡í•˜ê³  <strong>ì¦‰ì‹œ ì œì–´ê¶Œì„ ë°˜í™˜</strong> í•´ìš”.</p>
  </li>
  <li>
    <p>ë‚˜ì¤‘ì— <code class="language-plaintext highlighter-rouge">await task</code>ë¡œ ê²°ê³¼ë¥¼ ë°›ê±°ë‚˜, í•„ìš”í•˜ë©´ <code class="language-plaintext highlighter-rouge">task.cancel()</code>ë¡œ ì·¨ì†Œí•  ìˆ˜ ìˆì–´ìš”.</p>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">say</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">msg</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">say</span><span class="p">(</span><span class="sh">"</span><span class="s">hello</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">say</span><span class="p">(</span><span class="sh">"</span><span class="s">world</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="c1"># ë‹¤ë¥¸ ì¼ í•˜ë‹¤ê°€...
</span>    <span class="n">res1</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t1</span>
    <span class="n">res2</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t2</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">res1</span><span class="p">,</span> <span class="n">res2</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h1 id="4-íƒ€ì„ì•„ì›ƒê³¼-ì·¨ì†Œ-ì‹¤ë¬´ì—ì„œ-ì§„ì§œ-ìì£¼-ì”€">4) íƒ€ì„ì•„ì›ƒê³¼ ì·¨ì†Œ (ì‹¤ë¬´ì—ì„œ ì§„ì§œ ìì£¼ ì”€)</h1>

<p>ë„¤íŠ¸ì›Œí¬ëŠ” í•­ìƒ ëŠë ¤ì§ˆ ìˆ˜ ìˆìœ¼ë‹ˆ, <strong>íƒ€ì„ì•„ì›ƒ</strong> ì€ ê¸°ë³¸ ì¥ì°©!</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">slow</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">42</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ì‘ì—…ì´ ì·¨ì†Œë¨</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">raise</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># 1ì´ˆ ë„˜ìœ¼ë©´ TimeoutError
</span>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="nf">slow</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">íƒ€ì„ì•„ì›ƒ!</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># ì„ì˜ ì·¨ì†Œë„ ê°€ëŠ¥
</span>    <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">slow</span><span class="p">())</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">task</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ì§ì ‘ ì·¨ì†Œ ì™„ë£Œ</span><span class="sh">"</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h1 id="5-ì‹¤ì œ-ë„¤íŠ¸ì›Œí¬-ì˜ˆì œ-ì•„ì£¼-ê°„ë‹¨í•œ-ì—ì½”-ì„œë²„í´ë¼ì´ì–¸íŠ¸">5) ì‹¤ì œ ë„¤íŠ¸ì›Œí¬ ì˜ˆì œ: ì•„ì£¼ ê°„ë‹¨í•œ ì—ì½” ì„œë²„/í´ë¼ì´ì–¸íŠ¸</h1>

<h2 id="1-ì„œë²„-asynciostart_server">(1) ì„œë²„: <code class="language-plaintext highlighter-rouge">asyncio.start_server</code></h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># echo_server.py
</span><span class="kn">import</span> <span class="n">asyncio</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="n">reader</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">StreamReader</span><span class="p">,</span> <span class="n">writer</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">StreamWriter</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">reader</span><span class="p">.</span><span class="nf">readline</span><span class="p">()</span>           <span class="c1"># í´ë¼ì´ì–¸íŠ¸ í•œ ì¤„ ì½ê¸°
</span>    <span class="n">msg</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">decode</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
    <span class="n">addr</span> <span class="o">=</span> <span class="n">writer</span><span class="p">.</span><span class="nf">get_extra_info</span><span class="p">(</span><span class="sh">'</span><span class="s">peername</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[ì„œë²„] </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s"> -&gt; </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">writer</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Echo: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">encode</span><span class="p">())</span>  <span class="c1"># ë‹¤ì‹œ ëŒë ¤ì£¼ê¸°
</span>    <span class="k">await</span> <span class="n">writer</span><span class="p">.</span><span class="nf">drain</span><span class="p">()</span>                     <span class="c1"># ì†¡ì‹  ë²„í¼ ë¹„ìš°ê¸°
</span>    <span class="n">writer</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">writer</span><span class="p">.</span><span class="nf">wait_closed</span><span class="p">()</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">server</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">start_server</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="sh">"</span><span class="s">127.0.0.1</span><span class="sh">"</span><span class="p">,</span> <span class="mi">8888</span><span class="p">)</span>
    <span class="n">addrs</span> <span class="o">=</span> <span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">sock</span><span class="p">.</span><span class="nf">getsockname</span><span class="p">())</span> <span class="k">for</span> <span class="n">sock</span> <span class="ow">in</span> <span class="n">server</span><span class="p">.</span><span class="n">sockets</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[ì„œë²„] </span><span class="si">{</span><span class="n">addrs</span><span class="si">}</span><span class="s">ì—ì„œ ëŒ€ê¸°ì¤‘</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">server</span><span class="p">:</span>                       <span class="c1"># ì•ˆì „í•œ ì¢…ë£Œë¥¼ ìœ„í•´ context ì‚¬ìš©
</span>        <span class="k">await</span> <span class="n">server</span><span class="p">.</span><span class="nf">serve_forever</span><span class="p">()</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<h2 id="2-í´ë¼ì´ì–¸íŠ¸-asyncioopen_connection">(2) í´ë¼ì´ì–¸íŠ¸: <code class="language-plaintext highlighter-rouge">asyncio.open_connection</code></h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># echo_client.py
</span><span class="kn">import</span> <span class="n">asyncio</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">reader</span><span class="p">,</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">open_connection</span><span class="p">(</span><span class="sh">"</span><span class="s">127.0.0.1</span><span class="sh">"</span><span class="p">,</span> <span class="mi">8888</span><span class="p">)</span>
    <span class="n">writer</span><span class="p">.</span><span class="nf">write</span><span class="p">((</span><span class="n">msg</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">).</span><span class="nf">encode</span><span class="p">())</span>
    <span class="k">await</span> <span class="n">writer</span><span class="p">.</span><span class="nf">drain</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">reader</span><span class="p">.</span><span class="nf">readline</span><span class="p">()</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[í´ë¼ì´ì–¸íŠ¸] ì‘ë‹µ: </span><span class="si">{</span><span class="n">data</span><span class="p">.</span><span class="nf">decode</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">writer</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">writer</span><span class="p">.</span><span class="nf">wait_closed</span><span class="p">()</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># ì—¬ëŸ¬ ë©”ì‹œì§€ë¥¼ ë™ì‹œ ì „ì†¡
</span>    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">gather</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nf">send</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">hello </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<ul>
  <li>
    <p>í„°ë¯¸ë„ 1ì—ì„œ <code class="language-plaintext highlighter-rouge">python echo_server.py</code> ì‹¤í–‰</p>
  </li>
  <li>
    <p>í„°ë¯¸ë„ 2ì—ì„œ <code class="language-plaintext highlighter-rouge">python echo_client.py</code> ì‹¤í–‰<br />
â†’ ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ê°€ <strong>ë¹„ë™ê¸° ìŠ¤íŠ¸ë¦¼</strong> ìœ¼ë¡œ ì£¼ê³ ë°›ëŠ” ê±¸ ë³¼ ìˆ˜ ìˆì–´ìš”.</p>
  </li>
</ul>

<hr />

<h1 id="6-ë™ê¸°ë¸”ë¡œí‚¹-ì½”ë“œì™€-ì„ì„-ë•Œ">6) ë™ê¸°(ë¸”ë¡œí‚¹) ì½”ë“œì™€ ì„ì„ ë•Œ</h1>

<p><code class="language-plaintext highlighter-rouge">time.sleep()</code>ì²˜ëŸ¼ ë£¨í”„ë¥¼ <strong>ë§‰ì•„ë²„ë¦¬ëŠ”</strong> ì½”ë“œëŠ” <code class="language-plaintext highlighter-rouge">await asyncio.to_thread(...)</code>ë¡œ <strong>ìŠ¤ë ˆë“œì— ë°€ì–´ ë„£ê¸°</strong> :</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">time</span>

<span class="k">def</span> <span class="nf">blocking_io</span><span class="p">():</span>
    <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>         <span class="c1"># ì ˆëŒ€ ì´ë²¤íŠ¸ ë£¨í”„ì—ì„œ ì§ì ‘ í˜¸ì¶œ X
</span>    <span class="k">return</span> <span class="sh">"</span><span class="s">ì™„ë£Œ</span><span class="sh">"</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">to_thread</span><span class="p">(</span><span class="n">blocking_io</span><span class="p">)</span>  <span class="c1"># ë³„ë„ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰
</span>    <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<blockquote>
  <p>CPU ë°”ìš´ë“œ(ì˜ˆ: ëŒ€ê·œëª¨ ê³„ì‚°)ëŠ” <strong>ë©€í‹°í”„ë¡œì„¸ì‹±</strong>(ë˜ëŠ” <code class="language-plaintext highlighter-rouge">ProcessPoolExecutor</code>)ì„ ê³ ë ¤í•˜ì„¸ìš”. asyncioëŠ” <strong>I/O ë™ì‹œì„±</strong> ì´ ì£¼íŠ¹ê¸°ì…ë‹ˆë‹¤.</p>
</blockquote>

<hr />

<h1 id="7-ì„ íƒ-íŒŒì´ì¬-311ì˜-taskgroup-ë¡œ-êµ¬ì¡°í™”ëœ-ë™ì‹œì„±">7) (ì„ íƒ) íŒŒì´ì¬ 3.11ì˜ <strong>TaskGroup</strong> ë¡œ êµ¬ì¡°í™”ëœ ë™ì‹œì„±</h1>

<p>ì—¬ëŸ¬ íƒœìŠ¤í¬ë¥¼ â€œê·¸ë£¹â€ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ê´€ë¦¬í•˜ê³ , í•˜ë‚˜ê°€ ì‹¤íŒ¨í•˜ë©´ ë‚˜ë¨¸ì§€ë¥¼ ì•Œì•„ì„œ ì •ë¦¬í•´ ì¤˜ìš”.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">job</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">job </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">n</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">TaskGroup</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">tg</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">job</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="c1"># TaskGroupì„ ë‚˜ì˜¤ë©´ ì „ë¶€ ëë‚œ ìƒíƒœ
</span>    <span class="c1"># (ë°˜í™˜ê°’ì„ ëª¨ìœ¼ë ¤ë©´ í/ë¦¬ìŠ¤íŠ¸/ì½œë°±ìœ¼ë¡œ ì €ì¥í•˜ê±°ë‚˜, ë³„ë„ êµ¬ì¡° ì‚¬ìš©)
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ëª¨ë“  ì‘ì—… ì™„ë£Œ</span><span class="sh">"</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h1 id="8-ìì£¼-í•˜ëŠ”-ì‹¤ìˆ˜-ì²´í¬ë¦¬ìŠ¤íŠ¸">8) ìì£¼ í•˜ëŠ” ì‹¤ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸</h1>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">asyncio.run()</code>ì€ <strong>í”„ë¡œì„¸ìŠ¤ ë‹¹ í•œ ë²ˆì˜ ì§„ì…ì </strong> ìœ¼ë¡œ ì‚¬ìš© (ì¤‘ì²© ê¸ˆì§€).</p>
  </li>
  <li>
    <p><strong>ë°˜ë“œì‹œ<code class="language-plaintext highlighter-rouge">await</code> ê°€ëŠ¥í•œ ê²ƒë§Œ</strong> await í•˜ê¸° (ì½”ë£¨í‹´/Task/Future).</p>
  </li>
  <li>
    <p>ì´ë²¤íŠ¸ ë£¨í”„ ì•ˆì—ì„œ <code class="language-plaintext highlighter-rouge">time.sleep()</code>/ë¸”ë¡œí‚¹ I/O ì‚¬ìš© ê¸ˆì§€ â†’ <code class="language-plaintext highlighter-rouge">await asyncio.sleep()</code> / <code class="language-plaintext highlighter-rouge">await asyncio.to_thread(...)</code>.</p>
  </li>
  <li>
    <p>ë„¤íŠ¸ì›Œí¬/ì™¸ë¶€ APIëŠ” <strong>íƒ€ì„ì•„ì›ƒ</strong> (<code class="language-plaintext highlighter-rouge">asyncio.wait_for</code>) ê±¸ê¸°.</p>
  </li>
  <li>
    <p>ì˜¤ë˜ ê°€ëŠ” ë°±ê·¸ë¼ìš´ë“œ íƒœìŠ¤í¬ëŠ” <strong>ì·¨ì†Œ ì²˜ë¦¬</strong>(try/except <code class="language-plaintext highlighter-rouge">CancelledError</code>)ë¥¼ ë„£ì–´ ì•ˆì •ì ìœ¼ë¡œ ì¢…ë£Œ.</p>
  </li>
</ul>

<hr />

<h1 id="9-í•™ìŠµ-ë£¨íŠ¸ê¶Œì¥-ìˆœì„œ">9) í•™ìŠµ ë£¨íŠ¸(ê¶Œì¥ ìˆœì„œ)</h1>

<ol>
  <li>
    <p>ìœ„ì˜ <strong>ìˆœì°¨ vs ë™ì‹œ</strong> ì˜ˆì œë¥¼ ì‹¤í–‰í•´ ì²´ê°</p>
  </li>
  <li>
    <p><strong>gather / create_task</strong> íŒ¨í„´ ìµíˆê¸°</p>
  </li>
  <li>
    <p><strong>íƒ€ì„ì•„ì›ƒ/ì·¨ì†Œ</strong> ë„£ì–´ë³´ê¸°</p>
  </li>
  <li>
    <p><strong>ì—ì½” ì„œë²„/í´ë¼ì´ì–¸íŠ¸</strong> ë¡œ ìŠ¤íŠ¸ë¦¼ I/O ë§›ë³´ê¸°</p>
  </li>
  <li>
    <p>ê¸°ì¡´ ì½”ë“œì˜ ë¸”ë¡œí‚¹ ë¶€ë¶„ì„ <strong>to_thread</strong> ë¡œ ë¶„ë¦¬í•´ ë³´ê¸°</p>
  </li>
  <li>
    <p>(3.11+) <strong>TaskGroup</strong> ìœ¼ë¡œ ì½”ë“œ êµ¬ì¡° ì •ë¦¬</p>
  </li>
</ol>

<hr />

<h1 id="10-ì—°ìŠµ-ë¬¸ì œ-ì§ì ‘-í•´ë³´ê¸°">10) ì—°ìŠµ ë¬¸ì œ (ì§ì ‘ í•´ë³´ê¸°)</h1>

<ol>
  <li>
    <p>URL ë¦¬ìŠ¤íŠ¸(ì˜ˆ: 5ê°œ)ì— ëŒ€í•´ â€œìš”ì²­â†’1ì´ˆ ëŒ€ê¸°â†’ê²°ê³¼ ì¶œë ¥â€ì„ <strong>ê°€ì§œë¡œ</strong> í‰ë‚´ ë‚´ëŠ” <code class="language-plaintext highlighter-rouge">fetch(url)</code> ì½”ë£¨í‹´ì„ ë§Œë“¤ê³ ,</p>

    <ul>
      <li>(a) ìˆœì°¨ ì‹¤í–‰, (b) <code class="language-plaintext highlighter-rouge">gather</code> ë™ì‹œ ì‹¤í–‰ì˜ ì‹œê°„ì„ ë¹„êµí•´ ë³´ì„¸ìš”.</li>
    </ul>
  </li>
  <li>
    <p>ìœ„ (1)ì— <strong>íƒ€ì„ì•„ì›ƒ 0.5ì´ˆ</strong> ë¥¼ ê±¸ê³ , íƒ€ì„ì•„ì›ƒ ë‚œ URLë§Œ ë”°ë¡œ ëª¨ì•„ ì¶œë ¥í•´ ë³´ì„¸ìš”.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">time.sleep(1)</code>ì„ ì‹¤ìˆ˜ë¡œ ë„£ì—ˆì„ ë•Œ í”„ë¡œê·¸ë¨ì´ ëŠë ¤ì§€ëŠ” ê±¸ ê´€ì°°í•˜ê³ , <code class="language-plaintext highlighter-rouge">await asyncio.sleep(1)</code>ë¡œ ë°”ê¿”ë³´ì„¸ìš”.</p>
  </li>
</ol>

<hr />

<p>í•„ìš”í•˜ë©´ ìœ„ ì˜ˆì œ ì¤‘ ì›í•˜ëŠ” ê±¸ ë” í™•ì¥(ì˜ˆ: HTTP í´ë¼ì´ì–¸íŠ¸ëŠ” <code class="language-plaintext highlighter-rouge">aiohttp</code> ì‚¬ìš©)í•´ì„œ ë³´ì—¬ë“œë¦´ê²Œìš”. ì–´ë–¤ ì‘ì—…ì„ ë¹„ë™ê¸°ë¡œ ë°”ê¾¸ê³  ì‹¶ì€ì§€ ì•Œë ¤ì£¼ì‹œë©´, <strong>ë‹¹ì¥ ì ìš© ê°€ëŠ¥í•œ êµ¬ì¡°</strong> ë¡œ ê°™ì´ ë¦¬íŒ©í„°ë§í•´ ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

create_taskë‘ ê·¸ëƒ¥ gather í•˜ëŠ” ê²ƒì˜ ì°¨ì´

</p>

<p>ì¢‹ì€ ì§ˆë¬¸! í•œ ì¤„ ìš”ì•½ë¶€í„°:</p>

<ul>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">create_task</code></strong> : â€œì½”ë£¨í‹´ì„ <strong>ì§€ê¸ˆ ë°”ë¡œ</strong> ë°±ê·¸ë¼ìš´ë“œë¡œ ëŒë¦¬ê²Œ í•˜ê³ , <strong>í•¸ë“¤(Task)</strong> ì„ ëŒë ¤ì¤˜. ë‚˜ì¤‘ì— ê°œë³„ì ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">await</code>/ì·¨ì†Œ/íƒ€ì„ì•„ì›ƒ/ì´ë¦„ë¶™ì´ê¸° ë“± <strong>ì„¸ë°€ ì œì–´</strong> ë¥¼ í•  ë•Œ ì¨.â€</p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">gather</code></strong> : â€œì—¬ëŸ¬ ì‘ì—…ì„ <strong>ë¬¶ì–´ì„œ ë™ì‹œì— ì‹œì‘</strong> í•˜ê³ , <strong>ì „ë¶€ ëë‚  ë•Œê¹Œì§€</strong> ê¸°ë‹¤ë¦° ë’¤ <strong>ê²°ê³¼ ë¦¬ìŠ¤íŠ¸</strong> ë¥¼ ëŒë ¤ì¤˜. <strong>í•œ ë²ˆì— ê¸°ë‹¤ë¦´ ë•Œ</strong> ì¨.â€</p>
  </li>
</ul>

<p>ì•„ë˜ë¥¼ ë‹¨ê³„ë³„ë¡œ ì§šì–´ë³¼ê²Œìš”.</p>

<hr />

<h2 id="1-ë¬´ì—‡ì„-ë°˜í™˜í•˜ë‚˜">1) ë¬´ì—‡ì„ ë°˜í™˜í•˜ë‚˜?</h2>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">asyncio.create_task(coro)</code> â†’ <strong>Task ê°ì²´</strong> ë¥¼ ë°˜í™˜.<br />
ì´ TaskëŠ” ê³§ë°”ë¡œ ìŠ¤ì¼€ì¤„ë§ë˜ê³  â€œë°±ê·¸ë¼ìš´ë“œâ€ì—ì„œ ëŒì•„ìš”.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">await asyncio.gather(*aws)</code> â†’ <strong>ê²°ê³¼ ë¦¬ìŠ¤íŠ¸</strong> ë¥¼ ë°˜í™˜.<br />
ì…ë ¥ ìˆœì„œ ê·¸ëŒ€ë¡œ <code class="language-plaintext highlighter-rouge">[res1, res2, ...]</code>ê°€ ì™€ìš”(ì™„ë£Œ ìˆœì„œ ì•„ë‹˜).</p>
  </li>
</ul>

<hr />

<h2 id="2-ì–¸ì œ-ì‹œì‘ë˜ë‚˜">2) ì–¸ì œ ì‹œì‘ë˜ë‚˜?</h2>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">create_task</code>ëŠ” <strong>í˜¸ì¶œ ì¦‰ì‹œ</strong> ìŠ¤ì¼€ì¤„ë§ ì‹œì‘. (ê³§ ì‹¤í–‰ë¨)</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">gather</code>ë„ ë‚´ë¶€ì ìœ¼ë¡œ ì½”ë£¨í‹´ì„ Taskë¡œ ë§Œë“¤ì–´ <strong>ì¦‰ì‹œ</strong> ì‹œì‘í•˜ì§€ë§Œ,<br />
<strong>ìš°ë¦¬ëŠ”<code class="language-plaintext highlighter-rouge">gather</code> ìì²´ë¥¼ <code class="language-plaintext highlighter-rouge">await</code></strong> í•˜ê¸°ì— â€œëª¨ë‘ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ëŠ”â€ íŒ¨í„´ì´ ìì—°ìŠ¤ëŸ¬ì›Œìš”.</p>
  </li>
</ul>

<hr />

<h2 id="3-ì˜ˆì™¸ì·¨ì†Œ-ë™ì‘-ì°¨ì´">3) ì˜ˆì™¸/ì·¨ì†Œ ë™ì‘ ì°¨ì´</h2>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">gather(..., return_exceptions=False)</code>(ê¸°ë³¸):</p>

    <ul>
      <li>
        <p><strong>í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨</strong> í•˜ë©´ <code class="language-plaintext highlighter-rouge">gather</code>ê°€ <strong>ì˜ˆì™¸ë¥¼ ì˜¬ë¦¬ê³ </strong> , ë‚˜ë¨¸ì§€ ì‘ì—…ì€ <strong>ìë™ ì·¨ì†Œ</strong> í•´ìš”.</p>
      </li>
      <li>
        <p>ì¦‰, <strong>â€œì˜¬-ì˜¤ì–´-ë‚«ì‹±â€</strong> ëŠë‚Œ.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">gather(..., return_exceptions=True)</code>:</p>

    <ul>
      <li>ì˜ˆì™¸ë„ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ì— <strong>ê°’ì²˜ëŸ¼</strong> ë‹´ì•„ì¤˜ìš”. ê°œë³„ í›„ì²˜ë¦¬ ê°€ëŠ¥.</li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">create_task</code>:</p>

    <ul>
      <li>
        <p>ê° TaskëŠ” <strong>ë…ë¦½ì </strong>. ì–´ë–¤ Taskê°€ ì‹¤íŒ¨í•´ë„ ë‹¤ë¥¸ TaskëŠ” ê³„ì† ë”.</p>
      </li>
      <li>
        <p>ë‹¤ë§Œ <strong>ê²°êµ­<code class="language-plaintext highlighter-rouge">await task</code>ë¥¼ í•´ì•¼ ì˜ˆì™¸ê°€ ì „íŒŒ</strong>ë¼ìš”. ì•ˆ ë°›ìœ¼ë©´ ë¡œê·¸ì—<br />
â€œTask exception was never retrievedâ€ ê²½ê³ ê°€ ë‚˜ì˜¬ ìˆ˜ ìˆì–´ìš”.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ì·¨ì†Œ</strong> :</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">gather</code>ì— ê±¸ë¦° ê±¸ <strong>í•œ ë²ˆì—</strong> ì·¨ì†Œ â†’ <strong>ëª¨ë“  ìì‹ Task ìë™ ì·¨ì†Œ</strong>.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">create_task</code>ë¡œ ë§Œë“  ê±´ <strong>ê°ê°</strong> <code class="language-plaintext highlighter-rouge">task.cancel()</code> í˜¸ì¶œí•´ì„œ ê´€ë¦¬.</p>
      </li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="4-ì–¸ì œ-ë¬´ì—‡ì„-ì“°ë‚˜-ì˜ì‚¬ê²°ì •-í‘œ">4) ì–¸ì œ ë¬´ì—‡ì„ ì“°ë‚˜? (ì˜ì‚¬ê²°ì • í‘œ)</h2>

<table>
  <thead>
    <tr>
      <th>ìƒí™©</th>
      <th>ì¶”ì²œ</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ë™ì‹œì— ì—¬ëŸ¬ ì¼ì„ ì‹œí‚¤ê³ , <strong>ëª¨ë‘ ëë‚œ ë’¤ ê²°ê³¼</strong> ê°€ í•„ìš”</td>
      <td><code class="language-plaintext highlighter-rouge">await asyncio.gather(a(), b(), c())</code></td>
    </tr>
    <tr>
      <td>ì¼ì„ <strong>ì§€ê¸ˆ ì‹œì‘</strong> í•´ ë†“ê³ , ì¤‘ê°„ì— <strong>ë‹¤ë¥¸ ì¼ë„</strong> í•˜ë‹¤ê°€ <strong>ë‚˜ì¤‘ì—</strong> í•©ë¥˜</td>
      <td><code class="language-plaintext highlighter-rouge">t1 = create_task(a()); â€¦; res = await t1</code></td>
    </tr>
    <tr>
      <td>ê° ì‘ì—…ì„ <strong>ê°œë³„ì ìœ¼ë¡œ</strong> ì·¨ì†Œ/íƒ€ì„ì•„ì›ƒ/ì´ë¦„ìœ¼ë¡œ ì¶”ì </td>
      <td><code class="language-plaintext highlighter-rouge">create_task</code> (í•„ìš”ì‹œ ë‚˜ì¤‘ì— <code class="language-plaintext highlighter-rouge">gather(*tasks)</code>)</td>
    </tr>
    <tr>
      <td>í•˜ë‚˜ ì‹¤íŒ¨ ì‹œ <strong>ì „ì²´ë¥¼ ì·¨ì†Œ</strong> í•˜ê³  ì‹¶ë‹¤ (ê¸°ë³¸ ë™ì‘ ì„ í˜¸)</td>
      <td><code class="language-plaintext highlighter-rouge">gather</code></td>
    </tr>
    <tr>
      <td>ì‹¤íŒ¨í•´ë„ ë‹¤ë¥¸ ì‘ì—…ì€ <strong>ê³„ì†</strong> ê°€ê²Œ í•˜ê³  ì‹¶ë‹¤</td>
      <td><code class="language-plaintext highlighter-rouge">create_task</code> + ê°œë³„ <code class="language-plaintext highlighter-rouge">await</code>/ì˜ˆì™¸ì²˜ë¦¬, ë˜ëŠ” <code class="language-plaintext highlighter-rouge">gather(..., return_exceptions=True)</code></td>
    </tr>
    <tr>
      <td><strong>ì™„ë£Œë˜ëŠ” ìˆœì„œëŒ€ë¡œ</strong> ê²°ê³¼ë¥¼ ë°›ê³  ì‹¶ë‹¤(ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬)</td>
      <td><code class="language-plaintext highlighter-rouge">asyncio.as_completed(...)</code> + (ëŒ€ê°œ <code class="language-plaintext highlighter-rouge">create_task</code>ì™€ í•¨ê»˜)</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="5-ì½”ë“œë¡œ-ë³´ëŠ”-ì°¨ì´">5) ì½”ë“œë¡œ ë³´ëŠ” ì°¨ì´</h2>

<h3 id="a-gather-í•œ-ë²ˆì—-ì‹œì‘--ì „ë¶€-ëë‚ -ë•Œê¹Œì§€-ê¸°ë‹¤ë¦¼">A) <code class="language-plaintext highlighter-rouge">gather</code>: í•œ ë²ˆì— ì‹œì‘ â†’ ì „ë¶€ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">work</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">n</span><span class="o">*</span><span class="n">n</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">gather</span><span class="p">(</span><span class="nf">work</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nf">work</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="nf">work</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>  <span class="c1"># [1, 4, 9]  (ì…ë ¥ ìˆœì„œëŒ€ë¡œ)
</span>
<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<h3 id="b-create_task-ì§€ê¸ˆ-ì‹œì‘--ì¤‘ê°„ì—-ë‹¤ë¥¸-ì¼--ë‚˜ì¤‘ì—-ê°œë³„ë¬¶ìŒ-í•©ë¥˜">B) <code class="language-plaintext highlighter-rouge">create_task</code>: ì§€ê¸ˆ ì‹œì‘ â†’ ì¤‘ê°„ì— ë‹¤ë¥¸ ì¼ â†’ ë‚˜ì¤‘ì— ê°œë³„/ë¬¶ìŒ í•©ë¥˜</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">work</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s"> done</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">name</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">work</span><span class="p">(</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">work</span><span class="p">(</span><span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

    <span class="c1"># ë‹¤ë¥¸ ì¼ë„ ë³‘í–‰
</span>    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">doing something else...</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># ê°œë³„ë¡œ í•©ë¥˜ ê°€ëŠ¥
</span>    <span class="n">r1</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t1</span>
    <span class="c1"># ë‚¨ì€ ê²ƒë“¤ë§Œ ë¬¶ì–´ì„œ ê¸°ë‹¤ë¦¬ê¸°ë„ ê°€ëŠ¥
</span>    <span class="n">r2</span><span class="p">,</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">gather</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h2 id="6-ì‹¤ë¬´-íŒ">6) ì‹¤ë¬´ íŒ</h2>

<ul>
  <li>
    <p><strong>ë‘˜ì„ ì„ì–´ ì“°ëŠ” íŒ¨í„´</strong> ì´ í”í•´ìš”: ë¨¼ì € <code class="language-plaintext highlighter-rouge">create_task</code>ë¡œ â€œë¯¸ë¦¬â€ íƒœì›Œë‘ê³ ,<br />
ë‚˜ì¤‘ì— <code class="language-plaintext highlighter-rouge">await asyncio.gather(*tasks, return_exceptions=True)</code>ë¡œ <strong>í•œ ë²ˆì— íšŒìˆ˜</strong>.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">create_task</code>ë¡œ ë§Œë“  <strong>ì¥ìˆ˜(é•·å£½) ë°±ê·¸ë¼ìš´ë“œ íƒœìŠ¤í¬</strong>(ì˜ˆ: ì†Œë¹„ì ë£¨í”„, í•˜íŠ¸ë¹„íŠ¸)ëŠ”<br />
ì¢…ë£Œ ì‹œ <code class="language-plaintext highlighter-rouge">task.cancel()</code> + <code class="language-plaintext highlighter-rouge">try/except CancelledError</code>ë¡œ <strong>ì •ë¦¬ ì½”ë“œ</strong> ë¥¼ ê¼­ ë„£ê¸°.</p>
  </li>
  <li>
    <p><strong>ê²°ê³¼ê°€ í•„ìš” ì—†ë”ë¼ë„</strong> Task ì°¸ì¡°ë¥¼ ì¡ì•„ë‘ê³  ì˜ˆì™¸/ì·¨ì†Œë¥¼ ì²˜ë¦¬í•˜ì„¸ìš”.<br />
ì™„ì „í•œ â€œfire-and-forgetâ€ì€ ê¶Œì¥ë˜ì§€ ì•Šì•„ìš”(ëˆ„ìˆ˜Â·ë¯¸ì²˜ë¦¬ ì˜ˆì™¸ ìœ„í—˜).</p>
  </li>
  <li>
    <p>(3.11+) <strong><code class="language-plaintext highlighter-rouge">asyncio.TaskGroup</code></strong>ì€ â€œ<code class="language-plaintext highlighter-rouge">gather</code> + êµ¬ì¡°í™”ëœ ì·¨ì†Œ/ì •ë¦¬â€ ëŠë‚Œì˜ <strong>í˜„ëŒ€ì  ëŒ€ì•ˆ</strong>.<br />
ê·¸ë£¹ ìŠ¤ì½”í”„ë¥¼ ë²—ì–´ë‚  ë•Œ <strong>ëª¨ë‘ ì •ë¦¬</strong> ë¼ì„œ ë³µì¡í•œ ìˆ˜ëª… ê´€ë¦¬ê°€ ì‰¬ì›Œìš”.</p>
  </li>
</ul>

<hr />

<h2 id="7-í•œ-ë¬¸ì¥ìœ¼ë¡œ-ë‹¤ì‹œ-ìš”ì•½">7) í•œ ë¬¸ì¥ìœ¼ë¡œ ë‹¤ì‹œ ìš”ì•½</h2>

<ul>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">gather</code> = ê²°ê³¼ë¥¼ í•œ ë²ˆì— ëª¨ì„ ë•Œ.</strong></p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">create_task</code> = ì§€ê¸ˆ íƒœì›Œì„œ ë‚˜ì¤‘ì—/ê°œë³„ë¡œ ê´€ë¦¬í•  ë•Œ.</strong></p>
  </li>
</ul>

<p>ì›í•˜ëŠ” ì‹œë‚˜ë¦¬ì˜¤ê°€ ìˆìœ¼ë©´(ì˜ˆ: â€œNê°œì˜ API í˜¸ì¶œì„ ìˆœì°¨Â·ë™ì‹œÂ·ì‹œê°„ì œí•œÂ·ë¶€ë¶„ì‹¤íŒ¨ í—ˆìš©ìœ¼ë¡œ ì²˜ë¦¬â€) ë°”ë¡œ ê·¸ íŒ¨í„´ìœ¼ë¡œ ì½”ë“œë¥¼ ì§œì„œ ë³´ì—¬ì¤„ê²Œìš”.</p>

<p class="chat--user">

async def main(): t1 = asyncio.create_task(work("A", 2)) t2 = asyncio.create_task(work("B", 3)) # ë‹¤ë¥¸ ì¼ë„ ë³‘í–‰ await asyncio.sleep(1) print("doing something elseâ€¦") # ê°œë³„ë¡œ í•©ë¥˜ ê°€ëŠ¥ r1 = await t1 # ë‚¨ì€ ê²ƒë“¤ë§Œ ë¬¶ì–´ì„œ ê¸°ë‹¤ë¦¬ê¸°ë„ ê°€ëŠ¥ r2, = await asyncio.gather(t2) print(r1, r2) asyncio.run(main()) async def main(): # ë‹¤ë¥¸ ì¼ë„ ë³‘í–‰ await asyncio.sleep(1) print("doing something elseâ€¦") # ê°œë³„ë¡œ í•©ë¥˜ ê°€ëŠ¥ r1 = await work("A", 2) # ë‚¨ì€ ê²ƒë“¤ë§Œ ë¬¶ì–´ì„œ ê¸°ë‹¤ë¦¬ê¸°ë„ ê°€ëŠ¥ r2, = await asyncio.gather(work("B", 3)) print(r1, r2) asyncio.run(main()) ì´ ë‘ ì½”ë“œëŠ” ê°™ì€ê±° ì•„ë‹ˆëƒëŠ” ì§ˆë¬¸ì´ì•¼.

</p>

<p>ì•„ë‹ˆìš”, <strong>ê°™ì§€ ì•ŠìŠµë‹ˆë‹¤.</strong><br />
í•µì‹¬ ì°¨ì´ëŠ” â€œ<strong>ì–¸ì œê°€ ì‘ì—…ì„ ì‹œì‘í•˜ëŠëƒ</strong>(ìŠ¤ì¼€ì¤„ë§ ì‹œì )â€ì— ìˆì–´ìš”.</p>

<p>ì•„ë˜ì²˜ëŸ¼ <strong>íƒ€ì„ë¼ì¸ìœ¼ë¡œ</strong> ë¹„êµí•´ ë³¼ê²Œìš”. (A=2ì´ˆ, B=3ì´ˆ)</p>

<hr />

<h1 id="1-ì½”ë“œ-1-create_taskë¡œ-ì¦‰ì‹œ-ì‹œì‘">1) ì½”ë“œ 1: <code class="language-plaintext highlighter-rouge">create_task</code>ë¡œ ì¦‰ì‹œ ì‹œì‘</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">t1</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">work</span><span class="p">(</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># A ë°”ë¡œ ì‹œì‘
</span><span class="n">t2</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">work</span><span class="p">(</span><span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>  <span class="c1"># B ë°”ë¡œ ì‹œì‘
</span><span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>                   <span class="c1"># ê·¸ ì‚¬ì´ A,BëŠ” ì§„í–‰ ì¤‘
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">doing something else...</span><span class="sh">"</span><span class="p">)</span>
<span class="n">r1</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t1</span>                            <span class="c1"># t=1ì—ì„œ AëŠ” 1ì´ˆ ë‚¨ìŒ â†’ t=2ì— ì™„ë£Œ
</span><span class="n">r2</span><span class="p">,</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">gather</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>           <span class="c1"># ê·¸ë•Œ BëŠ” 1ì´ˆ ë‚¨ìŒ â†’ t=3ì— ì™„ë£Œ
</span></code></pre></div></div>

<p><strong>íƒ€ì„ë¼ì¸</strong></p>

<ul>
  <li>
    <p>t=0~1: Aì™€ B ë‘˜ ë‹¤ ì§„í–‰ ì¤‘, mainì€ 1ì´ˆ ì ê¹ ì‰¼</p>
  </li>
  <li>
    <p>t=1~2: <code class="language-plaintext highlighter-rouge">await t1</code> (A ë§ˆë¬´ë¦¬), BëŠ” ê³„ì† ì§„í–‰</p>
  </li>
  <li>
    <p>t=2~3: <code class="language-plaintext highlighter-rouge">await t2</code> (B ë§ˆë¬´ë¦¬)<br />
â†’ <strong>ì´ ~3ì´ˆ</strong></p>
  </li>
</ul>

<hr />

<h1 id="2-ì½”ë“œ-2-await-workë¡œ-ìˆœì°¨-ì‹œì‘">2) ì½”ë“œ 2: <code class="language-plaintext highlighter-rouge">await work(...)</code>ë¡œ ìˆœì°¨ ì‹œì‘</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>                   <span class="c1"># ì´ë•ŒëŠ” ì•„ë¬´ ì‘ì—…ë„ ì‹œì‘ ì•ˆ ë¨
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">doing something else...</span><span class="sh">"</span><span class="p">)</span>
<span class="n">r1</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">work</span><span class="p">(</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>                  <span class="c1"># ì´ì œì„œì•¼ A ì‹œì‘ â†’ t=1~3
</span><span class="n">r2</span><span class="p">,</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">gather</span><span class="p">(</span><span class="nf">work</span><span class="p">(</span><span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="c1"># ê·¸ ë‹¤ìŒì—ì•¼ B ì‹œì‘ â†’ t=3~6
</span></code></pre></div></div>

<p><strong>íƒ€ì„ë¼ì¸</strong></p>

<ul>
  <li>
    <p>t=0~1: mainë§Œ ì‰¼(ì•„ì§ A,B ì‹œì‘ X)</p>
  </li>
  <li>
    <p>t=1~3: A ì‹¤í–‰</p>
  </li>
  <li>
    <p>t=3~6: B ì‹¤í–‰<br />
â†’ <strong>ì´ ~6ì´ˆ</strong></p>
  </li>
</ul>

<hr />

<h1 id="ì™œ-ì´ëŸ°-ì°¨ì´ê°€-ë‚˜ë‚˜-step-by-step-ìš”ì ">ì™œ ì´ëŸ° ì°¨ì´ê°€ ë‚˜ë‚˜? (step-by-step ìš”ì )</h1>

<ul>
  <li>
    <p><strong>ì½”ë£¨í‹´ì€ ìƒì„±ë§Œ í•˜ë©´ â€œì‹œì‘â€ì´ ì•„ë‹™ë‹ˆë‹¤.</strong><br />
<code class="language-plaintext highlighter-rouge">work("B", 3)</code>ëŠ” <em>ì½”ë£¨í‹´ ê°ì²´</em> ë¥¼ ë§Œë“¤ ë¿, <strong>ìŠ¤ì¼€ì¤„ë§(ì‹¤í–‰ ì˜ˆì•½)</strong> ì€ <code class="language-plaintext highlighter-rouge">create_task(...)</code>ë‚˜ <code class="language-plaintext highlighter-rouge">gather(...)</code> ê°™ì€ í•¨ìˆ˜ê°€ í•  ë•Œ ì´ë¤„ì ¸ìš”.</p>
  </li>
  <li>
    <p><strong>ì½”ë“œ 1</strong> ì€ <code class="language-plaintext highlighter-rouge">create_task</code>ê°€ ì½”ë£¨í‹´ì„ <strong>ì¦‰ì‹œ ìŠ¤ì¼€ì¤„ë§</strong> í•´ì„œ A,Bê°€ <strong>ë™ì‹œì—</strong> ë‹¬ë¦½ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>ì½”ë“œ 2</strong> ëŠ” Aë¥¼ ë‹¤ ê¸°ë‹¤ë¦° <strong>ë‹¤ìŒì—ì•¼</strong> <code class="language-plaintext highlighter-rouge">gather(work("B",3))</code>ë¡œ Bë¥¼ <strong>ê·¸ë•Œ</strong> ì‹œì‘í•˜ë‹ˆ <strong>ìˆœì°¨</strong> ê°€ ë©ë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />

<h1 id="ëª©ì ì—-ë”°ë¼-ì–´ë–»ê²Œ-ì¨ì•¼-í•˜ë‚˜">ëª©ì ì— ë”°ë¼ ì–´ë–»ê²Œ ì¨ì•¼ í•˜ë‚˜?</h1>

<ul>
  <li>
    <p><strong>ë™ì‹œ ì‹¤í–‰</strong> ì´ ëª©ì ì´ë©´</p>

    <ul>
      <li>
        <p>ë°”ë¡œ ë¬¶ì–´ì„œ: <code class="language-plaintext highlighter-rouge">await asyncio.gather(work("A",2), work("B",3))</code></p>
      </li>
      <li>
        <p>ë˜ëŠ” ë¨¼ì € íƒœìš°ê³  ë‚˜ì¤‘ì— íšŒìˆ˜:</p>
        <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">t1</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">work</span><span class="p">(</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">work</span><span class="p">(</span><span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">doing something else...</span><span class="sh">"</span><span class="p">)</span>
<span class="n">r1</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">gather</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ìˆœì°¨ ì‹¤í–‰</strong> ì´ ëª©ì ì´ë©´ ì§€ê¸ˆ ì‘ì„±í•˜ì‹  ì½”ë“œ 2ì²˜ëŸ¼ <code class="language-plaintext highlighter-rouge">await work(...)</code>ë¥¼ ì°¨ë¡€ë¡œ í˜¸ì¶œí•˜ë©´ ë©ë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />

<h1 id="í•œ-ì¤„-ì •ë¦¬">í•œ ì¤„ ì •ë¦¬</h1>

<ul>
  <li>
    <p><strong>ì½”ë“œ 1 = ë™ì‹œ(ê²¹ì¹˜ê¸°)</strong> : <code class="language-plaintext highlighter-rouge">create_task</code>ë¡œ <strong>ì§€ê¸ˆ</strong> ì¶œë°œì‹œí‚´ â†’ ì´ ~3ì´ˆ</p>
  </li>
  <li>
    <p><strong>ì½”ë“œ 2 = ìˆœì°¨</strong> : ê° ì‘ì—…ì„ <strong>ê¸°ë‹¤ë¦° ë’¤ ë‹¤ìŒ ì‘ì—… ì‹œì‘</strong> â†’ ì´ ~6ì´ˆ</p>
  </li>
</ul>

<p>ì¦‰, ë‘ ì½”ë“œëŠ” ê²‰ë³´ê¸° í˜•íƒœë§Œ ë¹„ìŠ·í•˜ê³ , <strong>ìŠ¤ì¼€ì¤„ë§ ì‹œì </strong> ì´ ë‹¬ë¼ì„œ ë™ì‘ê³¼ ì‹¤í–‰ ì‹œê°„ì´ ì™„ì „íˆ ë‹¤ë¦…ë‹ˆë‹¤.</p>

<p class="chat--user">

ì•„ create_taskë¥¼ í•˜ê³  ì¦‰ì‹œ ì‹¤í–‰ë˜ëŠ”ê±´ ì•„ë‹ˆê³ , ë‹¤ìŒì— ì½”ë“œ ë‚´ì—ì„œ awaitë¥¼ í•  ë•Œ ê·¸ ë•Œ taskë“¤ì´ ì‹œì‘ë˜ëŠ”êµ¬ë‚˜

</p>

<p>ì™„ì „ ê·¸ë ‡ê²Œ ì´í•´í•˜ë©´ <strong>ë°˜ì¯¤ë§Œ ë§ê³  ì¤‘ìš”í•œ í¬ì¸íŠ¸ê°€ í•˜ë‚˜ ë¹ ì ¸ìš”.</strong><br />
ì •í™•íˆëŠ”:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">create_task()</code>ëŠ” <strong>ì¦‰ì‹œ â€œìŠ¤ì¼€ì¤„ë§â€</strong> í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>ì‹¤í–‰(ì½”ë“œê°€ ì‹¤ì œë¡œ ëŒì•„ê°€ê¸°)</strong> ì€ <strong>ì´ë²¤íŠ¸ ë£¨í”„ì— ì œì–´ê¶Œì´ ëŒì•„ì˜¤ëŠ” ìˆœê°„</strong> ì‹œì‘ë¼ìš”.</p>
  </li>
  <li>
    <p>ê·¸ â€œì œì–´ê¶Œ ë°˜í™˜â€ì€ ë³´í†µ <strong>ë‹¹ì‹ ì´ ì–´ë””ì„ ê°€<code class="language-plaintext highlighter-rouge">await</code> í•´ì„œ ì–‘ë³´í•  ë•Œ</strong> ë°œìƒí•˜ì£ .<br />
(í˜¹ì€ í˜„ì¬ ì½”ë£¨í‹´ì´ ëë‚˜ì„œ ë£¨í”„ê°€ ë‹¤ìŒ í„´ìœ¼ë¡œ ë„˜ì–´ê°ˆ ë•Œ.)</p>
  </li>
</ul>

<p>ì¦‰, <strong>ê·¸ íƒœìŠ¤í¬ë¥¼<code class="language-plaintext highlighter-rouge">await</code>í•  ë•Œ ì‹œì‘í•˜ëŠ” ê²Œ ì•„ë‹ˆë¼, â€œë£¨í”„ì— ì–‘ë³´í•˜ëŠ” ìˆœê°„â€</strong> ì‹œì‘í•©ë‹ˆë‹¤. ê·¸ë˜ì„œ <strong>ë‹¹ì‹ ì´<code class="language-plaintext highlighter-rouge">t</code>ë¥¼ ì ˆëŒ€ <code class="language-plaintext highlighter-rouge">await</code>í•˜ì§€ ì•Šì•„ë„</strong>, ì¤‘ê°„ì— ë‹¤ë¥¸ <code class="language-plaintext highlighter-rouge">await</code>ê°€ ìˆë‹¤ë©´ <code class="language-plaintext highlighter-rouge">t</code>ëŠ” ì´ë¯¸ ëŒê¸° ì‹œì‘í•´ìš”.</p>

<hr />

<h2 id="ë¯¸ì„¸-íƒ€ì´ë°ì„-ëˆˆìœ¼ë¡œ-í™•ì¸í•´ë³´ê¸°">ë¯¸ì„¸ íƒ€ì´ë°ì„ ëˆˆìœ¼ë¡œ í™•ì¸í•´ë³´ê¸°</h2>

<h3 id="1-create_task-í›„-ë‹¤ë¥¸-ê³³ì—ì„œ-awaitë§Œ-í•´ë„-íƒœìŠ¤í¬ëŠ”-ì´ë¯¸-ë‹¬ë¦°ë‹¤">1) <code class="language-plaintext highlighter-rouge">create_task</code> í›„ ë‹¤ë¥¸ ê³³ì—ì„œ <code class="language-plaintext highlighter-rouge">await</code>ë§Œ í•´ë„, íƒœìŠ¤í¬ëŠ” ì´ë¯¸ ë‹¬ë¦°ë‹¤</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">work</span><span class="p">():</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">work: start</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">work: after sleep</span><span class="sh">"</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">work</span><span class="p">())</span>   <span class="c1"># ğŸ”¸ ë°”ë¡œ ìŠ¤ì¼€ì¤„ë§
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">main: after create_task</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>            <span class="c1"># ğŸ”¸ ì—¬ê¸°ì„œ ë£¨í”„ì— ì–‘ë³´ â†’ workê°€ 'start' ì°ìŒ
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">main: after first await</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">t</span>                           <span class="c1"># ğŸ”¸ ì´ì œì„œì•¼ ê²°ê³¼ ìˆ˜ê±°(ì´ë¯¸ ì‹¤í–‰ì€ ì§„í–‰ ì¤‘)
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">main: after awaiting t</span><span class="sh">"</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p><strong>ì¶œë ¥ ìˆœì„œ(ì „í˜•ì )</strong><br />
<code class="language-plaintext highlighter-rouge">main: after create_task</code> â†’ <code class="language-plaintext highlighter-rouge">work: start</code> â†’ <code class="language-plaintext highlighter-rouge">main: after first await</code> â†’ <code class="language-plaintext highlighter-rouge">work: after sleep</code> â†’ <code class="language-plaintext highlighter-rouge">main: after awaiting t</code></p>

<blockquote>
  <p>í¬ì¸íŠ¸: <code class="language-plaintext highlighter-rouge">t</code>ë¥¼ <code class="language-plaintext highlighter-rouge">await</code>í•˜ê¸° ì „ì— ì´ë¯¸ <code class="language-plaintext highlighter-rouge">work</code>ê°€ ì‹¤í–‰ëì£ .</p>
</blockquote>

<hr />

<h3 id="2-ë£¨í”„ë¥¼-ë§‰ìœ¼ë©´timesleep-íƒœìŠ¤í¬ëŠ”-ëª»-ëˆë‹¤">2) ë£¨í”„ë¥¼ ë§‰ìœ¼ë©´(<code class="language-plaintext highlighter-rouge">time.sleep</code>) íƒœìŠ¤í¬ëŠ” ëª» ëˆë‹¤</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">time</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">work</span><span class="p">():</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">work: start</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">work: done</span><span class="sh">"</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">work</span><span class="p">())</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">main: blocking...</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>        <span class="c1"># ğŸ”´ ì´ë²¤íŠ¸ ë£¨í”„ê°€ ë©ˆì¶¤ â†’ work ëª» ë‹¬ë¦¼
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">main: unblocked</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">t</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>ì—¬ê¸°ì„œëŠ” <code class="language-plaintext highlighter-rouge">work: start</code>ê°€ <strong><code class="language-plaintext highlighter-rouge">time.sleep</code>ì´ ëë‚œ ë’¤</strong>ì—ë‚˜ ì°í ê±°ì˜ˆìš”.<br />
ì™œëƒë©´ ê·¸ë™ì•ˆ ë£¨í”„ê°€ <strong>í•œ ë²ˆë„ ëŒ ê¸°íšŒê°€ ì—†ì—ˆê¸° ë•Œë¬¸</strong> ì´ì£ .</p>

<hr />

<h2 id="ê·œì¹™-ìš”ì•½-step-by-step">ê·œì¹™ ìš”ì•½ (step-by-step)</h2>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">create_task(coro)</code> â†’ <strong>ì¦‰ì‹œ ìŠ¤ì¼€ì¤„ë§</strong> (ëŒ€ê¸°ì—´ì— ì˜¬ë¦¼).</p>
  </li>
  <li>
    <p><strong>í˜„ì¬ ì½”ë£¨í‹´ì´<code class="language-plaintext highlighter-rouge">await</code> ë“±ìœ¼ë¡œ ë£¨í”„ì— ì–‘ë³´</strong>í•˜ëŠ” ìˆœê°„, ìƒˆ íƒœìŠ¤í¬ê°€ <strong>ì‹¤í–‰ ì‹œì‘</strong>.</p>
  </li>
  <li>
    <p>ê·¸ íƒœìŠ¤í¬ë¥¼ <strong>ë°˜ë“œì‹œ<code class="language-plaintext highlighter-rouge">await</code>í•´ì•¼ë§Œ</strong> ì‹¤í–‰ë˜ëŠ” ê±´ ì•„ë‹˜.</p>

    <ul>
      <li>ë‹¤ë§Œ <strong>ì˜ˆì™¸/ê²°ê³¼ íšŒìˆ˜ì™€ ëˆ„ìˆ˜ ë°©ì§€</strong> ë¥¼ ìœ„í•´ ë³´í†µ <code class="language-plaintext highlighter-rouge">await t</code>(ë˜ëŠ” <code class="language-plaintext highlighter-rouge">gather</code>)ë¡œ <strong>íšŒìˆ˜</strong> í•˜ëŠ” ê²Œ ì•ˆì „.</li>
    </ul>
  </li>
  <li>
    <p>ì´ë²¤íŠ¸ ë£¨í”„ë¥¼ <strong>ë§‰ì§€ ë§ê¸°</strong> (<code class="language-plaintext highlighter-rouge">time.sleep</code>, ë¸”ë¡œí‚¹ I/O ê¸ˆì§€).</p>

    <ul>
      <li>í•„ìš”í•˜ë©´ <code class="language-plaintext highlighter-rouge">await asyncio.sleep(...)</code> ë˜ëŠ” <code class="language-plaintext highlighter-rouge">await asyncio.to_thread(blocking_fn)</code>.</li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="í•œ-ì¤„ë¡œ-ë‹¤ì‹œ">í•œ ì¤„ë¡œ ë‹¤ì‹œ</h2>

<ul>
  <li>
    <p><strong>ì‹œì‘ ì‹œì </strong> : â€œ<code class="language-plaintext highlighter-rouge">await t</code>ì¼ ë•Œâ€ê°€ ì•„ë‹ˆë¼ <strong>â€œë£¨í”„ì— ì–‘ë³´í•˜ëŠ” ë‹¤ìŒ í„´â€</strong>.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">create_task</code>ëŠ” <strong>ë°”ë¡œ ë‹¬ë¦¬ê²Œ ì˜ˆì•½</strong> í•˜ê³ , <strong>ë‹¹ì‹ ì´ ì–´ë”˜ê°€ì—ì„œ<code class="language-plaintext highlighter-rouge">await</code>í•˜ëŠ” ìˆœê°„</strong> ì‹¤ì œë¡œ ë›°ê¸° ì‹œì‘í•©ë‹ˆë‹¤.</p>
  </li>
</ul>

<p>ì›í•˜ë©´ ìœ„ ì˜ˆì œë¥¼ ë‹¹ì‹  í™˜ê²½ì— ë§ê²Œ ì‚´ì§ ë³€í˜•í•´ì„œ(íƒ€ì´ë°/ë¡œê·¸) ë” ë³´ì—¬ë“œë¦´ê²Œìš”!</p>]]></content><author><name>hvppyarchive</name></author><category term="python" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">ComfyUI LSF Job Submit</title><link href="https://hvppyarchive.github.io/comfyui/comfyui-lsf-job-submit/" rel="alternate" type="text/html" title="ComfyUI LSF Job Submit" /><published>2025-10-10T20:07:23+09:00</published><updated>2025-10-10T20:07:23+09:00</updated><id>https://hvppyarchive.github.io/comfyui/comfyui-lsf-job-submit</id><content type="html" xml:base="https://hvppyarchive.github.io/comfyui/comfyui-lsf-job-submit/"><![CDATA[<p class="chat--user">

ComfyUIì—ì„œ LSF Jobì„ Submití•˜ê³  ì´ë¥¼ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ëŠ” Custom nodeë¥¼ ê°œë°œí•˜ê³  ì‹¶ì–´. ìš”êµ¬ ì¡°ê±´ 1. main execute í•¨ìˆ˜ë¥¼ asyncí•˜ê²Œ êµ¬í˜„í•´ì•¼ í•¨(ìµœì‹  ComfyUIì—ì„œëŠ” async ë…¸ë“œ ë™ì‘ì„ ì§€ì›í•¨) 2. Pollingí•˜ë©° bjobs ì»¤ë§¨ë“œë¥¼ ì´ìš©í•´ ìƒíƒœë¥¼ ì²´í¬í•´ì•¼ í•¨. ì´ ë•Œ bjobs ì»¤ë§¨ë“œê°€ ë‹¤ë¥¸ ê±¸ë¡œ ë°”ë€Œë”ë¼ë„ ì‰½ê²Œ ë³€ê²½í•  ìˆ˜ ìˆê²Œ êµ¬ì¡°ë¥¼ ìœ ì—°í•˜ê²Œ ì§œì¤˜. 3. ì´ ë•Œ ì—¬ëŸ¬ ë…¸ë“œê°€ ë™ì‹œì— ëŒ ìˆ˜ë„ ìˆìœ¼ë©°, bjobsë¥¼ ë„ˆë¬´ ìì£¼ ì¹˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ íŒŒì¼ì‹œìŠ¤í…œì— ìºì‹±í•˜ëŠ” ë¡œì§ì´ ìˆìœ¼ë©´ ì¢‹ì„ ê²ƒ ê°™ìŒ. 4. ì…ë ¥ì€ ì»¤ë§¨ë“œ, cwd 2ê°œ ìŠ¤íŠ¸ë§ì„. ì»¤ë§¨ë“œëŠ” ë©€í‹°ë¼ì¸ìœ¼ë¡œ ì—¬ëŸ¬ bsub ì»¤ë§¨ë“œê°€ ë“¤ì–´ì˜¬ ìˆ˜ ë„ ìˆìŒì„ ëª…ì‹¬í•  ê²ƒ. bsub ì»¤ë§¨ë“œ ìì²´ë„ asyncí•˜ê²Œ ë©€í‹°ë¡œ ë¿Œë¦¬ë„ë¡ í•˜ë©´ ì¢‹ì„ ê²ƒ ê°™ìŒ(ë‹¨ ë„ˆë¬´ í•œ ë²ˆì— ë§ì€ jobì´ ë“¤ì–´ê°€ì§€ ì•Šë„ë¡ ë°°ì¹˜ ì‚¬ì´ì¦ˆ ì¡°ì ˆì€ í•„ìš”í•  ê²ƒ ê°™ìŒ) 5. ì´ ìì²´ê°€ output ë…¸ë“œì´ë©´ì„œ ëë‚˜ë©´ ì ì ˆí•œ ì•„ì›ƒí’‹(ë­ê°€ ë ì§€ëŠ” ì¶”ì²œí•´ì¤˜)ë„ ë±‰ë„ë¡ í•˜ì. 

</p>

<p>ì¢‹ì•„! ìš”êµ¬ì‚¬í•­ì„ ëª¨ë‘ ë§Œì¡±í•˜ëŠ” <strong>ComfyUIìš© LSF Submit &amp; Wait ì»¤ìŠ¤í…€ ë…¸ë“œ</strong> ì„¤ê³„ë¥¼ ê¹”ë”í•˜ê²Œ ì •ë¦¬í•œ ë’¤, ë°”ë¡œ ë¶™ì—¬ ë„£ì–´ ì“¸ ìˆ˜ ìˆëŠ” ì™„ì „í•œ ì½”ë“œë¥¼ ë“œë¦´ê²Œìš”.</p>

<h1 id="ì„¤ê³„-ê°œìš”">ì„¤ê³„ ê°œìš”</h1>

<ul>
  <li>
    <p><strong>Async ë…¸ë“œ</strong> : <code class="language-plaintext highlighter-rouge">SUPPORTS_ASYNC = True</code>, <code class="language-plaintext highlighter-rouge">async def run(...)</code> êµ¬í˜„.</p>
  </li>
  <li>
    <p><strong>ë©€í‹°ë¼ì¸ bsub ì œì¶œ</strong> : ì…ë ¥ <code class="language-plaintext highlighter-rouge">commands</code>ì˜ ê° ë¹„ì–´ìˆì§€ ì•Šì€ ë¼ì¸ì„ ë…ë¦½ ëª…ë ¹ìœ¼ë¡œ ë¹„ë™ê¸° ì œì¶œ. ë™ì‹œ ì œì¶œ ê°œìˆ˜ëŠ” ë°°ì¹˜ í¬ê¸°ë¡œ ì œí•œ.</p>
  </li>
  <li>
    <p><strong>Polling êµ¬ì¡°/ìœ ì—°ì„±</strong> : <code class="language-plaintext highlighter-rouge">StatusBackend</code> ì¸í„°í˜ì´ìŠ¤ì™€ <code class="language-plaintext highlighter-rouge">LSFBjobsBackend</code> ê¸°ë³¸ êµ¬í˜„. <code class="language-plaintext highlighter-rouge">status_cmd_template</code>(ì˜ˆ: <code class="language-plaintext highlighter-rouge">bjobs -noheader -o "jobid stat" {job_ids}</code>)ì„ ë°”ê¾¸ê¸°ë§Œ í•˜ë©´ ë‹¤ë¥¸ ì»¤ë§¨ë“œë¡œ ì‰½ê²Œ ì „í™˜.</p>
  </li>
  <li>
    <p><strong>íŒŒì¼ì‹œìŠ¤í…œ ìºì‹œ</strong> : ì—¬ëŸ¬ ë…¸ë“œê°€ ë™ì‹œì— ëŒì•„ë„ <code class="language-plaintext highlighter-rouge">status_cache.json</code>(ì ê¸ˆ í¬í•¨)ë¡œ <strong>TTL ê¸°ë°˜</strong> ìºì‹±. ë„ˆë¬´ ìì£¼ <code class="language-plaintext highlighter-rouge">bjobs</code>ë¥¼ ì¹˜ì§€ ì•Šë„ë¡ í•¨.</p>
  </li>
  <li><strong>ì…ë ¥</strong> : <code class="language-plaintext highlighter-rouge">commands</code>(ë©€í‹°ë¼ì¸ ë¬¸ìì—´), <code class="language-plaintext highlighter-rouge">cwd</code>(ì‘ì—… ë””ë ‰í† ë¦¬).<br />
ì¶”ê°€ íŒŒë¼ë¯¸í„°ëŠ” <strong>ì¸ë¼ì¸ ì§€ì‹œë¬¸</strong> ìœ¼ë¡œ ì¡°ì ˆ:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># LSF: batch_size=4 poll_interval_s=10 status_ttl_s=15</span>
</code></pre></div>    </div>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">batch_size</code>(ë™ì‹œ ì œì¶œ ê°œìˆ˜), <code class="language-plaintext highlighter-rouge">poll_interval_s</code>(í´ë§ ì£¼ê¸°), <code class="language-plaintext highlighter-rouge">status_ttl_s</code>(ìºì‹œ TTL),<br />
<code class="language-plaintext highlighter-rouge">status_cmd_template</code>(ìƒíƒœ ì¡°íšŒ ì»¤ë§¨ë“œ í…œí”Œë¦¿) ë“± ì§€ì›.</li>
    </ul>
  </li>
  <li>
    <p><strong>ì¶œë ¥(OUTPUT ë…¸ë“œ)</strong> :</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">job_ids</code>: ì œì¶œëœ Job IDë“¤ì˜ ì½¤ë§ˆ êµ¬ë¶„ ë¬¸ìì—´</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">results_json</code>: ìš”ì•½ JSON ë¬¸ìì—´(ìµœì¢… ìƒíƒœ/ì„±ê³µì—¬ë¶€/ê²°ê³¼ íŒŒì¼ ê²½ë¡œ ë“±)</p>
      </li>
    </ul>
  </li>
  <li><strong>í„°ë¯¸ë„ ìƒíƒœ</strong> : ê¸°ë³¸ <code class="language-plaintext highlighter-rouge">{"DONE","EXIT"}</code>. í•„ìš”ì‹œ ì½”ë“œ ë‚´ ìƒìˆ˜ë¡œ í™•ì¥ ê°€ëŠ¥.</li>
</ul>

<hr />

<h1 id="ì„¤ì¹˜ì‚¬ìš©ë²•">ì„¤ì¹˜/ì‚¬ìš©ë²•</h1>

<ol>
  <li>
    <p>ì•„ë˜ ì½”ë“œë¥¼ <code class="language-plaintext highlighter-rouge">ComfyUI/custom_nodes/lsf_submit_and_wait.py</code> ë¡œ ì €ì¥ í›„ ComfyUI ì¬ì‹œì‘.</p>
  </li>
  <li>ì›Œí¬í”Œë¡œì—ì„œ ì´ ë…¸ë“œë¥¼ ë§ˆì§€ë§‰ì— ë‘ê³ , <code class="language-plaintext highlighter-rouge">commands</code>ì— ì—¬ëŸ¬ ì¤„ <code class="language-plaintext highlighter-rouge">bsub ...</code>ë“¤ì„ ë„£ìœ¼ë©´ ë¨.<br />
ì˜µì…˜ì€ ë§¨ ìœ„ì— í•œ ì¤„ì˜ ì¸ë¼ì¸ ì§€ì‹œë¬¸ìœ¼ë¡œ ì¡°ì ˆ:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># LSF: batch_size=3 poll_interval_s=15 status_ttl_s=30</span>
bsub <span class="nt">-q</span> short <span class="nt">-J</span> test1 <span class="nb">sleep </span>5
bsub <span class="nt">-q</span> short <span class="nt">-J</span> test2 <span class="nb">sleep </span>8
bsub <span class="nt">-q</span> short <span class="nt">-J</span> test3 <span class="nb">sleep </span>2
</code></pre></div>    </div>
  </li>
  <li>ê²°ê³¼ëŠ” <code class="language-plaintext highlighter-rouge">job_ids</code>ì™€ <code class="language-plaintext highlighter-rouge">results_json</code>(ìš”ì•½/ê²°ê³¼ íŒŒì¼ ê²½ë¡œ í¬í•¨)ìœ¼ë¡œ ë°˜í™˜ë©ë‹ˆë‹¤.</li>
</ol>

<hr />

<h1 id="ì½”ë“œ-ê·¸ëŒ€ë¡œ-ì‚¬ìš©-ê°€ëŠ¥">ì½”ë“œ (ê·¸ëŒ€ë¡œ ì‚¬ìš© ê°€ëŠ¥)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># File: custom_nodes/lsf_submit_and_wait.py
</span><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">shlex</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># fcntl (POSIX) ì ê¸ˆ: Windowsì—ì„  graceful degrade
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">fcntl</span>  <span class="c1"># type: ignore
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">fcntl</span> <span class="o">=</span> <span class="bp">None</span>

<span class="c1"># ---------- ìœ í‹¸ ----------
</span>
<span class="n">JOB_ID_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
<span class="n">TERMINAL_STATES</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">DONE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">EXIT</span><span class="sh">"</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">iso_now</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">utcnow</span><span class="p">().</span><span class="nf">isoformat</span><span class="p">(</span><span class="n">timespec</span><span class="o">=</span><span class="sh">"</span><span class="s">seconds</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">Z</span><span class="sh">"</span>

<span class="k">def</span> <span class="nf">default_cache_dir</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">COMFYUI_LSF_CACHE_DIR</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">tempfile</span><span class="p">.</span><span class="nf">gettempdir</span><span class="p">(),</span> <span class="sh">"</span><span class="s">comfyui_lsf_cache</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d</span>

<span class="k">def</span> <span class="nf">parse_inline_options_and_commands</span><span class="p">(</span><span class="n">commands_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    ì²« ì¤„(ë“¤)ì— </span><span class="sh">'</span><span class="s"># LSF: key=value key=value ...</span><span class="sh">'</span><span class="s"> í˜•ì‹ì˜ ì¸ë¼ì¸ ì˜µì…˜ì„ í—ˆìš©.
    ë°˜í™˜: (options_dict, command_lines)
    </span><span class="sh">"""</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">ln</span> <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">commands_text</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">()]</span>
    <span class="n">clean_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">^\s*#\s*LSF:\s*(.+)$</span><span class="sh">"</span><span class="p">,</span> <span class="n">ln</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="c1"># key=value ... íŒŒì‹±(ë”°ì˜´í‘œ í—ˆìš©)
</span>            <span class="n">kvs</span> <span class="o">=</span> <span class="n">shlex</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">posix</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">kv</span> <span class="ow">in</span> <span class="n">kvs</span><span class="p">:</span>
                <span class="k">if</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">kv</span><span class="p">:</span>
                    <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">kv</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># ìˆ«ìí˜• ìë™ ìºìŠ¤íŒ…
</span>                    <span class="k">if</span> <span class="n">v</span><span class="p">.</span><span class="nf">isdigit</span><span class="p">():</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># true/false
</span>                        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">false</span><span class="sh">"</span><span class="p">):</span>
                            <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="o">==</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span>
                    <span class="n">options</span><span class="p">[</span><span class="n">k</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">continue</span>
        <span class="n">clean_lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">ln</span><span class="p">)</span>
    <span class="c1"># ë¹„ì–´ìˆëŠ” ë¼ì¸ ì œê±°
</span>    <span class="n">clean_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">ln</span> <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">clean_lines</span> <span class="k">if</span> <span class="n">ln</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span>
    <span class="k">return</span> <span class="n">options</span><span class="p">,</span> <span class="n">clean_lines</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_shell</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_shell</span><span class="p">(</span>
        <span class="n">cmd</span><span class="p">,</span>
        <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span> <span class="k">if</span> <span class="n">cwd</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">ignore</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">ignore</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">extract_job_ids_from_bsub_output</span><span class="p">(</span><span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="c1"># LSF í‘œì¤€: "Job &lt;12345&gt; is submitted to queue &lt;...&gt;."
</span>    <span class="k">return</span> <span class="n">JOB_ID_REGEX</span><span class="p">.</span><span class="nf">findall</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>

<span class="c1"># ---------- ìƒíƒœ ë°±ì—”ë“œ/ìºì‹œ ----------
</span>
<span class="k">class</span> <span class="nc">StatusBackend</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="nb">NotImplementedError</span>

<span class="k">class</span> <span class="nc">LSFBjobsBackend</span><span class="p">(</span><span class="n">StatusBackend</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    status_cmd_template ì˜ˆ:
      </span><span class="sh">'</span><span class="s">bjobs -noheader -o </span><span class="sh">"</span><span class="s">jobid stat</span><span class="sh">"</span><span class="s"> {job_ids}</span><span class="sh">'</span><span class="s">
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">status_cmd_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">status_cmd_template</span><span class="p">:</span>
            <span class="n">status_cmd_template</span> <span class="o">=</span> <span class="sh">'</span><span class="s">bjobs -noheader -o </span><span class="sh">"</span><span class="s">jobid stat</span><span class="sh">"</span><span class="s"> {job_ids}</span><span class="sh">'</span>
        <span class="n">self</span><span class="p">.</span><span class="n">template</span> <span class="o">=</span> <span class="n">status_cmd_template</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">template</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">job_ids</span><span class="o">=</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">job_ids</span><span class="p">))</span>
        <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_shell</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># ì‹¤íŒ¨ ì‹œ ë¹ˆ ë”•íŠ¸ ë°˜í™˜ (ìƒìœ„ ë¡œì§ì—ì„œ ì¬ì‹œë„/ìºì‹œ ì‚¬ìš©)
</span>            <span class="k">return</span> <span class="p">{}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># ê¸°ëŒ€ í¬ë§·: "&lt;jobid&gt; &lt;state&gt;"
</span>        <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">out</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">ln</span> <span class="o">=</span> <span class="n">ln</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ln</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">ln</span><span class="p">.</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">parts</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">upper</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>
        <span class="k">return</span> <span class="n">result</span>

<span class="k">class</span> <span class="nc">SharedJSONCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤/ë…¸ë“œ ê°„ ê³µìœ ë˜ëŠ” JSON ìºì‹œ (TTL ì ìš©).
    íŒŒì¼ ì ê¸ˆ ì‚¬ìš©(ê°€ëŠ¥ ì‹œ).
    êµ¬ì¡°: { job_id: {</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">RUN</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="s">: epoch_seconds}, ... }
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cache_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ttl_s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span> <span class="o">=</span> <span class="n">cache_file</span>
        <span class="n">self</span><span class="p">.</span><span class="n">ttl_s</span> <span class="o">=</span> <span class="n">ttl_s</span>
        <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">cache_file</span><span class="p">))</span>
        <span class="c1"># íŒŒì¼ ì´ˆê¸°í™”
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">cache_file</span><span class="p">):</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({},</span> <span class="n">f</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_lock</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fcntl</span><span class="p">:</span>
            <span class="n">fcntl</span><span class="p">.</span><span class="nf">flock</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">fcntl</span><span class="p">.</span><span class="n">LOCK_EX</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_unlock</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fcntl</span><span class="p">:</span>
            <span class="n">fcntl</span><span class="p">.</span><span class="nf">flock</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">fcntl</span><span class="p">.</span><span class="n">LOCK_UN</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_read</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_write</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span> <span class="o">+</span> <span class="sh">"</span><span class="s">.tmp</span><span class="sh">"</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_statuses</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">backend</span><span class="p">:</span> <span class="n">StatusBackend</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>

        <span class="c1"># 1) ì½ê¸° ì ê¸ˆ
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">r+</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">))</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({},</span> <span class="n">f</span><span class="p">)</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">r+</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_lock</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fh</span><span class="p">.</span><span class="nf">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># ìºì‹œ íˆíŠ¸/ë¯¸ìŠ¤ ê²°ì •
</span>            <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">to_query</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">entry</span> <span class="ow">and</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="nf">float</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">ttl_s</span><span class="p">):</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">to_query</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_unlock</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="n">fh</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

        <span class="c1"># 2) ë¯¸ìŠ¤ ëŒ€ìƒ ì¡°íšŒ (ì ê¸ˆ ì—†ì´)
</span>        <span class="n">fresh</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">to_query</span><span class="p">:</span>
            <span class="n">fresh</span> <span class="o">=</span> <span class="k">await</span> <span class="n">backend</span><span class="p">.</span><span class="nf">query</span><span class="p">(</span><span class="n">to_query</span><span class="p">)</span>

        <span class="c1"># 3) ì“°ê¸° ì ê¸ˆí•˜ì—¬ ë³‘í•© ë°˜ì˜
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">r+</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_lock</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fh</span><span class="p">.</span><span class="nf">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">data2</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">data2</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">updated</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">jid</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">fresh</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
                <span class="n">prev</span> <span class="o">=</span> <span class="n">data2</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">prev</span> <span class="ow">or</span> <span class="n">prev</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">)</span> <span class="o">!=</span> <span class="n">st</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ts</span> <span class="o">-</span> <span class="nf">float</span><span class="p">(</span><span class="n">prev</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">data2</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="n">st</span><span class="p">,</span> <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span><span class="p">}</span>
                    <span class="n">updated</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">updated</span><span class="p">:</span>
                <span class="n">fh</span><span class="p">.</span><span class="nf">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">fh</span><span class="p">.</span><span class="nf">truncate</span><span class="p">()</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">data2</span><span class="p">,</span> <span class="n">fh</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_unlock</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="n">fh</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

        <span class="c1"># ê²°ê´ê°’ êµ¬ì„± (fresh ìš°ì„ )
</span>        <span class="n">result</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">fresh</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

<span class="c1"># ---------- ì œì¶œ &amp; ëŒ€ê¸° ----------
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">submit_commands_multiline</span><span class="p">(</span><span class="n">commands</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    ê° ë¼ì¸ì„ ë…ë¦½ ì»¤ë§¨ë“œë¡œ ì œì¶œ. bsub ì¶œë ¥ì—ì„œ Job ID ì¶”ì¶œ.
    ë™ì‹œ ì œì¶œ ê°œìˆ˜ë¥¼ batch_sizeë¡œ ì œí•œ.
    </span><span class="sh">"""</span>
    <span class="n">sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)))</span>
    <span class="n">submissions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_submit_one</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">sem</span><span class="p">:</span>
            <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_shell</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">)</span>
            <span class="n">jids</span> <span class="o">=</span> <span class="nf">extract_job_ids_from_bsub_output</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">cmd</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">out</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">err</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">jids</span><span class="p">,</span>
            <span class="p">}</span>

    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">_submit_one</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">as_completed</span><span class="p">(</span><span class="n">tasks</span><span class="p">):</span>
        <span class="n">submissions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="k">await</span> <span class="n">t</span><span class="p">)</span>
    <span class="c1"># ì¶”ì¶œëœ Job ID í‰íƒ„í™”
</span>    <span class="n">job_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">jid</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])]</span>
    <span class="k">return</span> <span class="n">job_ids</span><span class="p">,</span> <span class="n">submissions</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">wait_until_done</span><span class="p">(</span><span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                          <span class="n">poll_interval_s</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                          <span class="n">status_cache</span><span class="p">:</span> <span class="n">SharedJSONCache</span><span class="p">,</span>
                          <span class="n">backend</span><span class="p">:</span> <span class="n">StatusBackend</span><span class="p">,</span>
                          <span class="n">max_wait_s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    ëª¨ë“  jobì´ TERMINAL_STATES(DONE/EXIT)ì— ë„ë‹¬í•  ë•Œê¹Œì§€ í´ë§.
    max_wait_s ì§€ì •ì‹œ í•´ë‹¹ ì‹œê°„ ì´ˆê³¼í•˜ë©´ ì¤‘ë‹¨.
    </span><span class="sh">"""</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    <span class="n">final</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">statuses</span> <span class="o">=</span> <span class="k">await</span> <span class="n">status_cache</span><span class="p">.</span><span class="nf">get_statuses</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">backend</span><span class="p">)</span>
        <span class="n">final</span> <span class="o">=</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="n">statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>
        <span class="c1"># ëª¨ë‘ í„°ë¯¸ë„ ìƒíƒœ?
</span>        <span class="k">if</span> <span class="nf">all</span><span class="p">((</span><span class="n">st</span> <span class="ow">in</span> <span class="n">TERMINAL_STATES</span><span class="p">)</span> <span class="ow">and</span> <span class="n">st</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">final</span><span class="p">.</span><span class="nf">values</span><span class="p">()):</span>
            <span class="k">break</span>
        <span class="c1"># íƒ€ì„ì•„ì›ƒ?
</span>        <span class="k">if</span> <span class="n">max_wait_s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_wait_s</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">poll_interval_s</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">final</span><span class="p">,</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

<span class="c1"># ---------- ComfyUI ë…¸ë“œ ----------
</span>
<span class="k">class</span> <span class="nc">LSFSubmitAndWait</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ì…ë ¥:
      - commands (STRING, multiline): ì—¬ëŸ¬ ì¤„ bsub ì»¤ë§¨ë“œ
        * ì¸ë¼ì¸ ì˜µì…˜: </span><span class="sh">'</span><span class="s"># LSF: batch_size=4 poll_interval_s=10 status_ttl_s=15
                         status_cmd_template=</span><span class="sh">"</span><span class="s">bjobs -noheader -o </span><span class="se">\"</span><span class="s">jobid stat</span><span class="se">\"</span><span class="s"> {job_ids}</span><span class="sh">"'</span><span class="s">
      - cwd (STRING): ì‹¤í–‰ ë””ë ‰í† ë¦¬

    ì¶œë ¥(OUTPUT ë…¸ë“œ):
      - job_ids (STRING): ì½¤ë§ˆ êµ¬ë¶„ ëª©ë¡
      - results_json (STRING): ìš”ì•½ JSON ë¬¸ìì—´
    </span><span class="sh">"""</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LSF</span><span class="sh">"</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span>
    <span class="n">OUTPUT_NODE</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">SUPPORTS_ASYNC</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">results_json</span><span class="sh">"</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">commands</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">bsub -q short sleep 3</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">commands</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># 0) ì¸ë¼ì¸ ì˜µì…˜/ëª…ë ¹ íŒŒì‹±
</span>        <span class="n">opts</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="nf">parse_inline_options_and_commands</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">batch_size</span><span class="sh">"</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">poll_interval_s</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">poll_interval_s</span><span class="sh">"</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">status_ttl_s</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status_ttl_s</span><span class="sh">"</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">status_cmd_template</span> <span class="o">=</span> <span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status_cmd_template</span><span class="sh">"</span><span class="p">,</span> <span class="sh">'</span><span class="s">bjobs -noheader -o </span><span class="sh">"</span><span class="s">jobid stat</span><span class="sh">"</span><span class="s"> {job_ids}</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">max_wait_s</span> <span class="o">=</span> <span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">max_wait_s</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">max_wait_s</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">max_wait_s</span><span class="p">.</span><span class="nf">isdigit</span><span class="p">():</span>
            <span class="n">max_wait_s</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">max_wait_s</span><span class="p">)</span>

        <span class="c1"># 1) ì œì¶œ
</span>        <span class="n">submitted_at</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
        <span class="n">job_ids</span><span class="p">,</span> <span class="n">submissions</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">submit_commands_multiline</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>

        <span class="c1"># 2) ìƒíƒœ ë°±ì—”ë“œ/ìºì‹œ
</span>        <span class="n">cache_dir</span> <span class="o">=</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="nf">default_cache_dir</span><span class="p">())</span>
        <span class="n">cache_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">status_cache.json</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">status_cache</span> <span class="o">=</span> <span class="nc">SharedJSONCache</span><span class="p">(</span><span class="n">cache_file</span><span class="p">,</span> <span class="n">ttl_s</span><span class="o">=</span><span class="n">status_ttl_s</span><span class="p">)</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="nc">LSFBjobsBackend</span><span class="p">(</span><span class="n">status_cmd_template</span><span class="o">=</span><span class="n">status_cmd_template</span><span class="p">)</span>

        <span class="c1"># 3) ì™„ë£Œê¹Œì§€ ëŒ€ê¸°
</span>        <span class="n">final_statuses</span><span class="p">,</span> <span class="n">waited_sec</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">wait_until_done</span><span class="p">(</span>
            <span class="n">job_ids</span><span class="p">,</span> <span class="n">poll_interval_s</span><span class="p">,</span> <span class="n">status_cache</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">max_wait_s</span><span class="o">=</span><span class="n">max_wait_s</span>
        <span class="p">)</span>

        <span class="n">completed_at</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
        <span class="n">all_done</span> <span class="o">=</span> <span class="nf">all</span><span class="p">((</span><span class="n">st</span> <span class="ow">in</span> <span class="n">TERMINAL_STATES</span><span class="p">)</span> <span class="ow">and</span> <span class="n">st</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">final_statuses</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>

        <span class="c1"># ì‹¤íŒ¨ ì œì¶œ ìˆ˜ì§‘
</span>        <span class="n">failed_submissions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span>
            <span class="k">if</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># 4) ê²°ê³¼ ìš”ì•½/ë¡œê·¸ íŒŒì¼ ì €ì¥
</span>        <span class="n">session_tag</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">utcnow</span><span class="p">().</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%Y%m%d_%H%M%S</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="sh">"</span><span class="s">_</span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="nf">getpid</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">results_dir</span> <span class="o">=</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">runs</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">results_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">results_dir</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">result_</span><span class="si">{</span><span class="n">session_tag</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">result_payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">submitted_at</span><span class="sh">"</span><span class="p">:</span> <span class="n">submitted_at</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">completed_at</span><span class="sh">"</span><span class="p">:</span> <span class="n">completed_at</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">duration_sec</span><span class="sh">"</span><span class="p">:</span> <span class="nf">round</span><span class="p">(</span><span class="n">waited_sec</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">job_ids</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">final_status</span><span class="sh">"</span><span class="p">:</span> <span class="n">final_statuses</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">all_done</span><span class="sh">"</span><span class="p">:</span> <span class="n">all_done</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">failed_submissions</span><span class="sh">"</span><span class="p">:</span> <span class="n">failed_submissions</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">:</span> <span class="n">cwd</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">options</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">batch_size</span><span class="sh">"</span><span class="p">:</span> <span class="n">batch_size</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">poll_interval_s</span><span class="sh">"</span><span class="p">:</span> <span class="n">poll_interval_s</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">status_ttl_s</span><span class="sh">"</span><span class="p">:</span> <span class="n">status_ttl_s</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">status_cmd_template</span><span class="sh">"</span><span class="p">:</span> <span class="n">status_cmd_template</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">max_wait_s</span><span class="sh">"</span><span class="p">:</span> <span class="n">max_wait_s</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">results_file</span><span class="sh">"</span><span class="p">:</span> <span class="n">results_path</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">results_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">result_payload</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># íŒŒì¼ì— ëª» ì“´ë‹¤ê³  í•´ë„ ë°˜í™˜ì€ ê³„ì†
</span>            <span class="k">pass</span>

        <span class="n">job_ids_str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>
        <span class="n">results_json_str</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result_payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">job_ids_str</span><span class="p">,</span> <span class="n">results_json_str</span><span class="p">)</span>

<span class="c1"># ComfyUI ë…¸ë“œ ë“±ë¡
</span><span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LSFSubmitAndWait</span><span class="sh">"</span><span class="p">:</span> <span class="n">LSFSubmitAndWait</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LSFSubmitAndWait</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">LSF: Submit &amp; Wait</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="ì‚¬ìš©-íŒ--ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆ">ì‚¬ìš© íŒ &amp; ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆ</h2>

<ul>
  <li>
    <p><strong>ë°°ì¹˜ í¬ê¸° ì¡°ì ˆ</strong> : ì œì¶œì´ ë„ˆë¬´ ëª°ë¦¬ë©´ íê°€ ì ê¸¸ ìˆ˜ ìˆìœ¼ë‹ˆ <code class="language-plaintext highlighter-rouge"># LSF: batch_size=4</code>ì²˜ëŸ¼ ì ì ˆíˆ ì œí•œí•˜ì„¸ìš”.</p>
  </li>
  <li>
    <p><strong>í´ë§/ìºì‹œ</strong> : <code class="language-plaintext highlighter-rouge">poll_interval_s</code>ëŠ” í´ë§ ì£¼ê¸°, <code class="language-plaintext highlighter-rouge">status_ttl_s</code>ëŠ” ìºì‹œ TTL(ì´ˆ). ì—¬ëŸ¬ ë…¸ë“œê°€ ëŒë”ë¼ë„ <code class="language-plaintext highlighter-rouge">/tmp/comfyui_lsf_cache</code>(ê¸°ë³¸) ê³µìœ  ìºì‹œë¡œ <code class="language-plaintext highlighter-rouge">bjobs</code> í˜¸ì¶œ ë¹ˆë„ë¥¼ í¬ê²Œ ì¤„ì…ë‹ˆë‹¤. ê²½ë¡œëŠ” <code class="language-plaintext highlighter-rouge">COMFYUI_LSF_CACHE_DIR</code> í™˜ê²½ë³€ìˆ˜ë¡œ ë°”ê¿€ ìˆ˜ ìˆì–´ìš”.</p>
  </li>
  <li>
    <p><strong>ìƒíƒœ ì»¤ë§¨ë“œ êµì²´</strong> : LSF ì™¸ ë‹¤ë¥¸ ì‹œìŠ¤í…œìœ¼ë¡œ ë°”ê¾¸ê³  ì‹¶ë‹¤ë©´ ì¸ë¼ì¸ì—</p>
    <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp"># LSF: status_cmd_template="bjobs -noheader -o \"jobid stat\" {job_ids}"</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>ì²˜ëŸ¼ ëª…ë ¹ í…œí”Œë¦¿ì„ ì „ë‹¬í•˜ì„¸ìš”. <code class="language-plaintext highlighter-rouge">{job_ids}</code> í”Œë ˆì´ìŠ¤í™€ë”ëŠ” ë°˜ë“œì‹œ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.<br />
(ì˜ˆì‹œ) ì»¤ìŠ¤í…€ ìŠ¤í¬ë¦½íŠ¸ë¡œ ë°”ê¿€ ë•Œ:<br />
<code class="language-plaintext highlighter-rouge"># LSF: status_cmd_template="/opt/cluster/bin/my_bjobs --format jobid,status {job_ids}"</code></p>

<ul>
  <li>
    <p><strong>íƒ€ì„ì•„ì›ƒ</strong> : ì „ì²´ ëŒ€ê¸° ì‹œê°„ ì œí•œì´ í•„ìš”í•˜ë©´ <code class="language-plaintext highlighter-rouge"># LSF: max_wait_s=7200</code> ì²˜ëŸ¼ ë„£ìœ¼ì„¸ìš”.</p>
  </li>
  <li>
    <p><strong>í„°ë¯¸ë„ ìƒíƒœ í™•ì¥</strong> : í•„ìš”í•˜ë©´ ì½”ë“œ ìƒë‹¨ì˜ <code class="language-plaintext highlighter-rouge">TERMINAL_STATES</code>ë¥¼ í¸ì§‘(ì˜ˆ: <code class="language-plaintext highlighter-rouge">{"DONE","EXIT","FINISHED"}</code>).</p>
  </li>
</ul>

<hr />

<h2 id="ì¶œë ¥-í¬ë§·-ì œì•ˆ">ì¶œë ¥ í¬ë§· ì œì•ˆ</h2>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">job_ids</code> : <code class="language-plaintext highlighter-rouge">"123,124,125"</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">results_json</code> :</p>
    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"submitted_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-10-10T00:00:00Z"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"completed_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-10-10T00:03:12Z"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"duration_sec"</span><span class="p">:</span><span class="w"> </span><span class="mf">192.4</span><span class="p">,</span><span class="w">
  </span><span class="nl">"job_ids"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"123"</span><span class="p">,</span><span class="s2">"124"</span><span class="p">,</span><span class="s2">"125"</span><span class="p">],</span><span class="w">
  </span><span class="nl">"final_status"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"123"</span><span class="p">:</span><span class="s2">"DONE"</span><span class="p">,</span><span class="nl">"124"</span><span class="p">:</span><span class="s2">"DONE"</span><span class="p">,</span><span class="nl">"125"</span><span class="p">:</span><span class="s2">"EXIT"</span><span class="p">},</span><span class="w">
  </span><span class="nl">"all_done"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
  </span><span class="nl">"failed_submissions"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
  </span><span class="nl">"cwd"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/work/exp1"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"options"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">...</span><span class="p">},</span><span class="w">
  </span><span class="nl">"results_file"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/tmp/comfyui_lsf_cache/runs/result_20251010_000000_12345.json"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
</ul>

<p>í•„ìš”í•˜ë©´ <code class="language-plaintext highlighter-rouge">status_cmd_template</code>ë¥¼ SLURM ë“±ìœ¼ë¡œ ë°”ê¾¸ëŠ” ì˜ˆì‹œë„ ì¶”ê°€ë¡œ ë“œë¦´ê²Œìš”. ì›í•˜ëŠ” ì¶”ê°€ ê¸°ëŠ¥(ì˜ˆ: ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„, ë°±ì˜¤í”„, ê°œë³„ job ë¡œê·¸ ì¶”ì ) ìˆìœ¼ë©´ ë§ë§Œ í•´ì¤˜ìš”!</p>

<p class="chat--user">

ê°œì„  ìš”ì²­: ë…¸ë“œ ìì²´ë„ asyncë¡œ ë™ì‘í•  ìˆ˜ ìˆìŒ, ì¦‰, ì´ì™€ ë™ì¼í•œ ë‹¤ë¥¸ ë…¸ë“œë“¤ì´ ìˆì„ ìˆ˜ ìˆê³  ê·¸ ë…¸ë“œë“¤ê³¼ë„ cacheë¥¼ ê³µìœ í•´ì•¼ ë”ìš± íš¨ìœ¨ì ì¼ ê²ƒ ê°™ìŒ.(bjobsí•  ë•Œ job idë¥¼ ì œí•œí•˜ë©´ ì•ˆ ë  ê²ƒ ê°™ê³ , bjobs -a ë¡œ ë´ì•¼í•  ê²ƒ ê°™ìŒ) ì´ ë•Œ ì¶”ê°€ ê³ ë ¤ ì‚¬í•­: Node1ì´ ë§Œë“  cacheë¥¼ Node2ê°€ ì°¸ê³ í•  ìˆ˜ ìˆëŠ”ë°, ì´ ë•Œ Node2ì—ì„œ ë°©ê¸ˆ bsubí•œ job idëŠ” cacheì— ì—†ì„ ìˆ˜ë„ ìˆìŒ(TTLì´ ì•ˆë¼ì„œ). ì´ ì½”ë„ˆ ì¼€ì´ìŠ¤ë„ ê³ ë ¤í•  ê²ƒ

</p>

<p>ì¢‹ì€ í¬ì¸íŠ¸! ìš”êµ¬í•˜ì‹  â€œë‹¤ì¤‘ ë…¸ë“œ ë™ì‹œ ë™ì‘ + ì „ì—­ ìºì‹œ ê³µìœ  + <code class="language-plaintext highlighter-rouge">bjobs -a</code> ê¸°ë°˜ ì „ì²´ ìŠ¤ëƒ…ìƒ·â€ìœ¼ë¡œ êµ¬ì¡°ë¥¼ ì—…ê·¸ë ˆì´ë“œí–ˆìŠµë‹ˆë‹¤. íŠ¹íˆ <strong>Node2ê°€ ë°©ê¸ˆ ì œì¶œí•œ ì¡ì´ ìºì‹œì— ì•„ì§ ì—†ì„ ìˆ˜ ìˆëŠ” ì½”ë„ˆ ì¼€ì´ìŠ¤</strong> ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´, <strong>ì œì¶œ ì§í›„ ìºì‹œì—<code class="language-plaintext highlighter-rouge">SUBMITTED</code> ìƒíƒœë¡œ ì‹œë“œ(seeding)</strong> í•˜ê³ , ìƒíƒœ ìºì‹œëŠ” <strong>â€˜ì „ì²´ ëª©ë¡â€™(bjobs -a) ìŠ¤ëƒ…ìƒ·</strong> ì„ TTL/ë½ ê¸°ë°˜ìœ¼ë¡œ ê°±ì‹ í•˜ë„ë¡ ë°”ê¿¨ìŠµë‹ˆë‹¤.</p>

<p>ì•„ë˜ëŠ” ë³€ê²½ ìš”ì•½ â†’ ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” ì „ì²´ ì½”ë“œ ìˆœì„œë¡œ ë“œë¦½ë‹ˆë‹¤.</p>

<hr />

<h1 id="ë³€ê²½ì„¤ê³„-í¬ì¸íŠ¸-step-by-step">ë³€ê²½/ì„¤ê³„ í¬ì¸íŠ¸ (step-by-step)</h1>

<ol>
  <li>
    <p><strong>í´ë§ ë°±ì—”ë“œ ì „ë©´ ê°œí¸</strong></p>

    <ul>
      <li>
        <p>ê¸°ì¡´: <code class="language-plaintext highlighter-rouge">bjobs {job_ids}</code> íŠ¹ì • ì¡ë§Œ ì¡°íšŒ</p>
      </li>
      <li>
        <p>ë³€ê²½: <strong>ê¸°ë³¸ê°’ì„<code class="language-plaintext highlighter-rouge">bjobs -a -noheader -o "jobid stat"</code>ë¡œ ì „ì²´ ì¡°íšŒ</strong>â†’ í•œ ë²ˆì˜ í˜¸ì¶œë¡œ ëª¨ë“  ì¡ ìƒíƒœë¥¼ ë°›ì•„ ì „ì—­ ìºì‹œì— ì €ì¥.</p>
      </li>
      <li>
        <p>í…œí”Œë¦¿ì€ <code class="language-plaintext highlighter-rouge">full_status_cmd_template</code>ë¡œ êµì²´(ì—¬ì „íˆ ì˜µì…˜ìœ¼ë¡œ ë°”ê¿€ ìˆ˜ ìˆìŒ).</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ì „ì—­ ê³µìœ  ìºì‹œ(íŒŒì¼) êµ¬ì¡° ê°œì„ </strong></p>

    <ul>
      <li>ë‹¨ì¼ íŒŒì¼ì— ì „ì²´ ìŠ¤ëƒ…ìƒ· ë³´ê´€:
        <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"jobs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"123"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"status"</span><span class="p">:</span><span class="s2">"PEND"</span><span class="p">,</span><span class="nl">"ts"</span><span class="p">:</span><span class="mi">169</span><span class="err">...</span><span class="p">},</span><span class="w"> </span><span class="err">...</span><span class="w"> </span><span class="p">},</span><span class="w">
  </span><span class="nl">"last_full_refresh_ts"</span><span class="p">:</span><span class="w"> </span><span class="mi">169</span><span class="err">...</span><span class="p">,</span><span class="w">
  </span><span class="nl">"meta"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">...</span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>        </div>
      </li>
      <li>
        <p><strong>TTL(<code class="language-plaintext highlighter-rouge">full_ttl_s</code>)</strong> + <strong>ìµœì†Œ ë¦¬í”„ë ˆì‹œ ê°„ê²©(<code class="language-plaintext highlighter-rouge">min_refresh_gap_s</code>)</strong> + <strong>ë½ íŒŒì¼(ê°€ëŠ¥ ì‹œ fcntl)</strong> ë¡œ <strong>-a í˜¸ì¶œ í­ì£¼ ë°©ì§€</strong>.</p>
      </li>
      <li>ë‹¤ì¤‘ ë…¸ë“œê°€ ë™ì‹œì— ì ‘ê·¼í•´ë„ <strong>ì½ê¸°/ì“°ê¸° ì ê¸ˆ</strong> ì ìš©.</li>
    </ul>
  </li>
  <li>
    <p><strong>ì½”ë„ˆ ì¼€ì´ìŠ¤ ì²˜ë¦¬(ë°©ê¸ˆ ì œì¶œí•œ ì¡ ë¯¸ë°˜ì˜)</strong></p>

    <ul>
      <li>
        <p><strong>ì œì¶œ ì§í›„</strong> í•´ë‹¹ ì¡ë“¤ì„ <strong>ìºì‹œì— â€˜SUBMITTEDâ€™</strong> ìƒíƒœë¡œ <strong>ì‹œë“œ(seeding)</strong> â†’ ë‹¤ë¥¸ ë…¸ë“œë„ ì¦‰ì‹œ ì´ JobIDë¥¼ â€œì•Œê³ â€ ìˆì–´ì„œ ë¶ˆí•„ìš”í•œ ê°•ì œ ë¦¬í”„ë ˆì‹œê°€ ì¤„ì–´ë“¦.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">get_statuses()</code>ì—ì„œ <strong>ìš”ì²­í•œ JobIDê°€ ìºì‹œì— ì—†ê±°ë‚˜ ì˜¤ë˜ë˜ë©´</strong> ,</p>

        <ul>
          <li>
            <p>TTL ë§Œë£Œì´ê±°ë‚˜ <code class="language-plaintext highlighter-rouge">force_refresh_on_miss=True</code>ì´ê³  <code class="language-plaintext highlighter-rouge">min_refresh_gap_s</code> ì´ìƒ ê²½ê³¼ ì‹œ <strong>í•œ ë…¸ë“œë§Œ</strong> <code class="language-plaintext highlighter-rouge">-a</code>ë¥¼ ì‹¤í–‰í•´ <strong>ìƒˆ ìŠ¤ëƒ…ìƒ·</strong> ì‘ì„±(ë½ìœ¼ë¡œ ë‹¨ì¼í™”).</p>
          </li>
          <li>
            <p>ê·¸ ì™¸ì—ëŠ” ë‹¤ìŒ í´ë§ ì£¼ê¸°ì— ìì—°ìŠ¤ëŸ½ê²Œ ë°˜ì˜.</p>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ì™„ì „í•œ async ì§€ì› + ë‹¤ì¤‘ ì œì¶œ ì œì–´</strong></p>

    <ul>
      <li>
        <p>ë…¸ë“œ ìì²´ëŠ” <code class="language-plaintext highlighter-rouge">SUPPORTS_ASYNC = True</code>, ë¹„ë™ê¸° ì œì¶œ/ëŒ€ê¸°.</p>
      </li>
      <li>
        <p>ë©€í‹°ë¼ì¸ <code class="language-plaintext highlighter-rouge">bsub</code>ë¥¼ <strong>ë°°ì¹˜ í¬ê¸° ì œí•œ(<code class="language-plaintext highlighter-rouge">batch_size</code>)</strong>ìœ¼ë¡œ ë³‘ë ¬ ì œì¶œ.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ì¶œë ¥/ë¡œê·¸</strong></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">job_ids</code>(ì½¤ë§ˆ ë¬¸ìì—´), <code class="language-plaintext highlighter-rouge">results_json</code>(ìš”ì•½ JSON).</p>
      </li>
      <li>
        <p>ì‹¤í–‰ ê²°ê³¼ëŠ” <code class="language-plaintext highlighter-rouge">/tmp/comfyui_lsf_cache/runs/result_*.json</code>ì—ë„ ì €ì¥.</p>
      </li>
    </ul>
  </li>
</ol>

<hr />

<h1 id="ì½”ë“œ-êµì²´ì¶”ê°€-ì—†ì´-ê·¸ëŒ€ë¡œ-ì‚¬ìš©">ì½”ë“œ (êµì²´/ì¶”ê°€ ì—†ì´ ê·¸ëŒ€ë¡œ ì‚¬ìš©)</h1>

<p><code class="language-plaintext highlighter-rouge">ComfyUI/custom_nodes/lsf_submit_and_wait.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">shlex</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># fcntl (POSIX) ì ê¸ˆ: Windowsì—ì„  graceful degrade
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">fcntl</span>  <span class="c1"># type: ignore
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">fcntl</span> <span class="o">=</span> <span class="bp">None</span>

<span class="c1"># ---------- ìƒìˆ˜/ìœ í‹¸ ----------
</span>
<span class="n">JOB_ID_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
<span class="n">TERMINAL_STATES</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">DONE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">EXIT</span><span class="sh">"</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">iso_now</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">utcnow</span><span class="p">().</span><span class="nf">isoformat</span><span class="p">(</span><span class="n">timespec</span><span class="o">=</span><span class="sh">"</span><span class="s">seconds</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">Z</span><span class="sh">"</span>

<span class="k">def</span> <span class="nf">default_cache_dir</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">COMFYUI_LSF_CACHE_DIR</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">tempfile</span><span class="p">.</span><span class="nf">gettempdir</span><span class="p">(),</span> <span class="sh">"</span><span class="s">comfyui_lsf_cache</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d</span>

<span class="k">def</span> <span class="nf">parse_inline_options_and_commands</span><span class="p">(</span><span class="n">commands_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    ì²« ì¤„(ë“¤)ì— </span><span class="sh">'</span><span class="s"># LSF: key=value key=value ...</span><span class="sh">'</span><span class="s"> í˜•ì‹ì˜ ì¸ë¼ì¸ ì˜µì…˜ì„ í—ˆìš©.
    ë°˜í™˜: (options_dict, command_lines)
    </span><span class="sh">"""</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">ln</span> <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">commands_text</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">()]</span>
    <span class="n">clean_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">^\s*#\s*LSF:\s*(.+)$</span><span class="sh">"</span><span class="p">,</span> <span class="n">ln</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">kvs</span> <span class="o">=</span> <span class="n">shlex</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">posix</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">kv</span> <span class="ow">in</span> <span class="n">kvs</span><span class="p">:</span>
                <span class="k">if</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">kv</span><span class="p">:</span>
                    <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">kv</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span><span class="p">.</span><span class="nf">isdigit</span><span class="p">():</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">false</span><span class="sh">"</span><span class="p">):</span>
                            <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="o">==</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span>
                    <span class="n">options</span><span class="p">[</span><span class="n">k</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">continue</span>
        <span class="n">clean_lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">ln</span><span class="p">)</span>
    <span class="n">clean_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">ln</span> <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">clean_lines</span> <span class="k">if</span> <span class="n">ln</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span>
    <span class="k">return</span> <span class="n">options</span><span class="p">,</span> <span class="n">clean_lines</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_shell</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_shell</span><span class="p">(</span>
        <span class="n">cmd</span><span class="p">,</span>
        <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span> <span class="k">if</span> <span class="n">cwd</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">ignore</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">ignore</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">extract_job_ids_from_bsub_output</span><span class="p">(</span><span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="c1"># LSF í‘œì¤€: "Job &lt;12345&gt; is submitted to queue &lt;...&gt;."
</span>    <span class="k">return</span> <span class="n">JOB_ID_REGEX</span><span class="p">.</span><span class="nf">findall</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>

<span class="c1"># ---------- ìƒíƒœ ë°±ì—”ë“œ (ì „ì²´ ìŠ¤ëƒ…ìƒ·) ----------
</span>
<span class="k">class</span> <span class="nc">StatusBackend</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">query_full</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="nb">NotImplementedError</span>

<span class="k">class</span> <span class="nc">LSFBjobsFullBackend</span><span class="p">(</span><span class="n">StatusBackend</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    ì „ì²´ ìŠ¤ëƒ…ìƒ· ê¸°ë°˜ ë°±ì—”ë“œ.
    full_status_cmd_template ê¸°ë³¸ê°’:
      </span><span class="sh">'</span><span class="s">bjobs -a -noheader -o </span><span class="sh">"</span><span class="s">jobid stat</span><span class="sh">"'</span><span class="s">
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">full_status_cmd_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">full_status_cmd_template</span><span class="p">:</span>
            <span class="n">full_status_cmd_template</span> <span class="o">=</span> <span class="sh">'</span><span class="s">bjobs -a -noheader -o </span><span class="sh">"</span><span class="s">jobid stat</span><span class="sh">"'</span>
        <span class="n">self</span><span class="p">.</span><span class="n">template</span> <span class="o">=</span> <span class="n">full_status_cmd_template</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">query_full</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_shell</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">template</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># ê¸°ëŒ€ í¬ë§·: "&lt;jobid&gt; &lt;state&gt;"
</span>        <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">out</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">ln</span> <span class="o">=</span> <span class="n">ln</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ln</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">ln</span><span class="p">.</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">parts</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">upper</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>
        <span class="k">return</span> <span class="n">result</span>

<span class="c1"># ---------- ì „ì—­ ê³µìœ  ìºì‹œ (ì „ì²´ ëª©ë¡ + TTL + ë½) ----------
</span>
<span class="k">class</span> <span class="nc">FullListSharedCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    íŒŒì¼ í•˜ë‚˜ì— ì „ì²´ job ìƒíƒœ ìŠ¤ëƒ…ìƒ·ì„ ì €ì¥/ê³µìœ .
    êµ¬ì¡°:
    {
      </span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="s">: { job_id: {</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="s">: epoch}, ... },
      </span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="s">: epoch,
      </span><span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="s">: { </span><span class="sh">"</span><span class="s">source</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, ... }
    }
    ì •ì±…:
      - full_ttl_s: ì „ì²´ ìŠ¤ëƒ…ìƒ· TTL
      - min_refresh_gap_s: -a ì¬ì‹¤í–‰ ìµœì†Œ ê°„ê²©
      - force_refresh_on_miss: í•„ìš”í•œ job_idê°€ ì—†ìœ¼ë©´ TTL ë¬´ì‹œí•˜ê³ (ë‹¨ ìµœì†Œ ê°„ê²©ì€ ì¡´ì¤‘) ì¡°ê¸° ê°±ì‹  ì‹œë„
      - SUBMITTED ì‹œë“œ: ì œì¶œ ì§í›„ ìºì‹œì— ë„£ì–´ ì½”ë„ˆ ì¼€ì´ìŠ¤ ì™„í™”
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cache_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">full_ttl_s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                 <span class="n">min_refresh_gap_s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                 <span class="n">force_refresh_on_miss</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span> <span class="o">=</span> <span class="n">cache_file</span>
        <span class="n">self</span><span class="p">.</span><span class="n">full_ttl_s</span> <span class="o">=</span> <span class="n">full_ttl_s</span>
        <span class="n">self</span><span class="p">.</span><span class="n">min_refresh_gap_s</span> <span class="o">=</span> <span class="n">min_refresh_gap_s</span>
        <span class="n">self</span><span class="p">.</span><span class="n">force_refresh_on_miss</span> <span class="o">=</span> <span class="n">force_refresh_on_miss</span>
        <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">cache_file</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">cache_file</span><span class="p">):</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span> <span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="n">f</span><span class="p">)</span>

    <span class="c1"># ---- ë½ ìœ í‹¸ ----
</span>    <span class="k">def</span> <span class="nf">_lock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">nonblock</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">a+</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fcntl</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fcntl</span><span class="p">.</span><span class="nf">flock</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">fcntl</span><span class="p">.</span><span class="n">LOCK_EX</span> <span class="o">|</span> <span class="p">(</span><span class="n">fcntl</span><span class="p">.</span><span class="n">LOCK_NB</span> <span class="k">if</span> <span class="n">nonblock</span> <span class="k">else</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">except</span> <span class="nb">BlockingIOError</span><span class="p">:</span>
                <span class="n">fh</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
                <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">fh</span>

    <span class="k">def</span> <span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fcntl</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fcntl</span><span class="p">.</span><span class="nf">flock</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">fcntl</span><span class="p">.</span><span class="n">LOCK_UN</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fh</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_read_cache</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span> <span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="k">def</span> <span class="nf">_write_cache</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span> <span class="o">+</span> <span class="sh">"</span><span class="s">.tmp</span><span class="sh">"</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">)</span>

    <span class="c1"># ---- ê³µê°œ API ----
</span>    <span class="k">def</span> <span class="nf">seed_submitted</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="sh">"""</span><span class="s">ì œì¶œ ì§í›„ SUBMITTED ìƒíƒœë¡œ ìºì‹œì— ì‹œë“œ(ì½”ë„ˆ ì¼€ì´ìŠ¤ ì™„í™”).</span><span class="sh">"""</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="c1"># ì“°ê¸° ë½
</span>        <span class="n">fh</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_lock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                <span class="c1"># ì´ë¯¸ ìˆìœ¼ë©´ ê±´ë“œë¦¬ì§€ ì•ŠìŒ(ê²½ìŸ ìƒíƒœì—ì„œ ë” ìµœì‹  ê°’ ë³´í˜¸)
</span>                <span class="k">if</span> <span class="n">jid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
                    <span class="n">jobs</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">SUBMITTED</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">now</span><span class="p">}</span>
            <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobs</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_write_cache</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">maybe_refresh_full</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">backend</span><span class="p">:</span> <span class="n">StatusBackend</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        - TTL ë˜ëŠ” miss ì‚¬ìœ ë¡œ ì „ì²´ ìŠ¤ëƒ…ìƒ·ì„ ê°±ì‹ í• ì§€ íŒë‹¨/ì‹¤í–‰
        - ë™ì‹œì„±: refresh ë½ íŒŒì¼ì„ non-blockingìœ¼ë¡œ íšë“í•œ ë‹¨ í•˜ë‚˜ì˜ í”„ë¡œì„¸ìŠ¤ë§Œ ì‹¤ì œë¡œ -a ì‹¤í–‰
        </span><span class="sh">"""</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
        <span class="n">last_ts</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="c1"># ìµœì†Œ ê°„ê²© ì²´í¬
</span>        <span class="nf">if </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_ts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nf">float</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">min_refresh_gap_s</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c1"># refresh ë½(ë³„ë„ íŒŒì¼) íšë“ ì‹œë„(ì‹¤íŒ¨í•˜ë©´ ë‹¤ë¥¸ ë…¸ë“œê°€ ìˆ˜í–‰ ì¤‘)
</span>        <span class="n">lock_path</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span> <span class="o">+</span> <span class="sh">"</span><span class="s">.refresh.lock</span><span class="sh">"</span>
        <span class="n">lock_fh</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_lock_fd</span><span class="p">(</span><span class="n">lock_path</span><span class="p">,</span> <span class="n">nonblock</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lock_fh</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># í•œ ë²ˆ ë” ìµœì‹ í™” ê²€ì‚¬(ê²½ìŸ íšŒí”¼)
</span>            <span class="n">data2</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
            <span class="n">last_ts2</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data2</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="nf">if </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_ts2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nf">float</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">min_refresh_gap_s</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="c1"># ì‹¤ì œ -a ì‹¤í–‰
</span>            <span class="n">snapshot</span> <span class="o">=</span> <span class="k">await</span> <span class="n">backend</span><span class="p">.</span><span class="nf">query_full</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">snapshot</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>  <span class="c1"># ì‹¤íŒ¨ ì‹œ ê·¸ëŒ€ë¡œ ìœ ì§€
</span>
            <span class="n">now2</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="c1"># ì“°ê¸° ë½(ìºì‹œ íŒŒì¼)
</span>            <span class="n">fh</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_lock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="c1"># ìƒˆ ìŠ¤ëƒ…ìƒ· ë°˜ì˜
</span>                <span class="n">ts</span> <span class="o">=</span> <span class="n">now2</span>
                <span class="k">for</span> <span class="n">jid</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">snapshot</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
                    <span class="n">jobs</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="n">st</span><span class="p">,</span> <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span><span class="p">}</span>
                <span class="n">base</span><span class="p">[</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobs</span>
                <span class="n">base</span><span class="p">[</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">now2</span>
                <span class="n">meta</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">meta</span><span class="p">[</span><span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">reason</span>
                <span class="n">meta</span><span class="p">[</span><span class="sh">"</span><span class="s">refreshed_at</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
                <span class="n">base</span><span class="p">[</span><span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_write_cache</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">lock_fh</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_statuses</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">backend</span><span class="p">:</span> <span class="n">StatusBackend</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        - ìºì‹œì—ì„œ ë¨¼ì € ì¡°íšŒ
        - í•„ìš” ì‹œ maybe_refresh_full()ì„ í†µí•´ -a ìŠ¤ëƒ…ìƒ· ê°±ì‹ 
        - ìµœì¢…ì ìœ¼ë¡œ ìš”ì²­ job_idsì— ëŒ€í•œ ìƒíƒœ dict ë°˜í™˜(ì—†ìœ¼ë©´ </span><span class="sh">""</span><span class="s">)
        </span><span class="sh">"""</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">last_ts</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">_fresh</span><span class="p">(</span><span class="n">jid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">ent</span> <span class="o">=</span> <span class="n">jobs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ent</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="c1"># ì—”íŠ¸ë¦¬ê°€ SUBMITTED ë¼ë„ 'ì‹ ì„ í•œ' ê²ƒìœ¼ë¡œ ì·¨ê¸‰(ë°”ë¡œ ì§ì „ ì œì¶œ ì¼€ì´ìŠ¤ ì™„í™”)
</span>            <span class="n">age</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="nf">float</span><span class="p">(</span><span class="n">ent</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">age</span> <span class="o">&lt;=</span> <span class="nf">float</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">full_ttl_s</span><span class="p">)</span>

        <span class="n">need_refresh</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1"># 1) TTL ë§Œë£Œ ë˜ëŠ” miss ì—¬ë¶€ íŒë‹¨
</span>        <span class="nf">if </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_ts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nf">float</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">full_ttl_s</span><span class="p">):</span>
            <span class="n">need_refresh</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c1"># miss ê²€ì‚¬: ìš”ì²­í•œ jobì´ ìºì‹œì— ì—†ê±°ë‚˜ stale
</span>        <span class="n">miss</span> <span class="o">=</span> <span class="p">[</span><span class="n">jid</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span> <span class="k">if</span> <span class="ow">not</span> <span class="nf">_fresh</span><span class="p">(</span><span class="n">jid</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">miss</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">force_refresh_on_miss</span><span class="p">:</span>
            <span class="n">need_refresh</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c1"># 2) í•„ìš” ì‹œ ì „ì²´ ë¦¬í”„ë ˆì‹œ ì‹œë„(í•œ í”„ë¡œì„¸ìŠ¤ë§Œ ì‹¤í–‰)
</span>        <span class="k">if</span> <span class="n">need_refresh</span><span class="p">:</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="sh">"</span><span class="s">ttl_expired</span><span class="sh">"</span> <span class="nf">if </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_ts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nf">float</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">full_ttl_s</span><span class="p">)</span> <span class="k">else</span> <span class="sh">"</span><span class="s">miss</span><span class="sh">"</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">maybe_refresh_full</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="n">reason</span><span class="p">)</span>
            <span class="c1"># ê°±ì‹  í›„ ìµœì‹  ë°ì´í„° ì¬ë¡œë”©
</span>            <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># 3) ê²°ê³¼ êµ¬ì„±
</span>        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">ent</span> <span class="o">=</span> <span class="n">jobs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ent</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="k">if</span> <span class="n">ent</span> <span class="k">else</span> <span class="sh">""</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="c1"># ---------- ì œì¶œ &amp; ëŒ€ê¸° ----------
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">submit_commands_multiline</span><span class="p">(</span><span class="n">commands</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    ê° ë¼ì¸ì„ ë…ë¦½ ì»¤ë§¨ë“œë¡œ ì œì¶œ. bsub ì¶œë ¥ì—ì„œ Job ID ì¶”ì¶œ.
    ë™ì‹œ ì œì¶œ ê°œìˆ˜ë¥¼ batch_sizeë¡œ ì œí•œ.
    </span><span class="sh">"""</span>
    <span class="n">sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)))</span>
    <span class="n">submissions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_submit_one</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">sem</span><span class="p">:</span>
            <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_shell</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">)</span>
            <span class="n">jids</span> <span class="o">=</span> <span class="nf">extract_job_ids_from_bsub_output</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">cmd</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">out</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">err</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">jids</span><span class="p">,</span>
            <span class="p">}</span>

    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">_submit_one</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">as_completed</span><span class="p">(</span><span class="n">tasks</span><span class="p">):</span>
        <span class="n">submissions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="k">await</span> <span class="n">t</span><span class="p">)</span>
    <span class="n">job_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">jid</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])]</span>
    <span class="k">return</span> <span class="n">job_ids</span><span class="p">,</span> <span class="n">submissions</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">wait_until_done</span><span class="p">(</span><span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                          <span class="n">poll_interval_s</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                          <span class="n">full_cache</span><span class="p">:</span> <span class="n">FullListSharedCache</span><span class="p">,</span>
                          <span class="n">backend</span><span class="p">:</span> <span class="n">StatusBackend</span><span class="p">,</span>
                          <span class="n">max_wait_s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    <span class="n">final</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">statuses</span> <span class="o">=</span> <span class="k">await</span> <span class="n">full_cache</span><span class="p">.</span><span class="nf">get_statuses</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">backend</span><span class="p">)</span>
        <span class="n">final</span> <span class="o">=</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="n">statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>
        <span class="k">if</span> <span class="nf">all</span><span class="p">((</span><span class="n">st</span> <span class="ow">in</span> <span class="n">TERMINAL_STATES</span><span class="p">)</span> <span class="ow">and</span> <span class="n">st</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">final</span><span class="p">.</span><span class="nf">values</span><span class="p">()):</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">max_wait_s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_wait_s</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">poll_interval_s</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">final</span><span class="p">,</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

<span class="c1"># ---------- ComfyUI ë…¸ë“œ ----------
</span>
<span class="k">class</span> <span class="nc">LSFSubmitAndWait</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ì…ë ¥:
      - commands (STRING, multiline): ì—¬ëŸ¬ ì¤„ bsub ì»¤ë§¨ë“œ
        * ì¸ë¼ì¸ ì˜µì…˜: </span><span class="sh">'</span><span class="s"># LSF: batch_size=4 poll_interval_s=10 full_ttl_s=15
                         full_status_cmd_template=</span><span class="sh">"</span><span class="s">bjobs -a -noheader -o </span><span class="se">\"</span><span class="s">jobid stat</span><span class="se">\"</span><span class="sh">"</span><span class="s">
                         min_refresh_gap_s=5 force_refresh_on_miss=true max_wait_s=7200</span><span class="sh">'</span><span class="s">
      - cwd (STRING): ì‹¤í–‰ ë””ë ‰í† ë¦¬

    ì¶œë ¥(OUTPUT ë…¸ë“œ):
      - job_ids (STRING): ì½¤ë§ˆ êµ¬ë¶„ ëª©ë¡
      - results_json (STRING): ìš”ì•½ JSON ë¬¸ìì—´
    </span><span class="sh">"""</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LSF</span><span class="sh">"</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span>
    <span class="n">OUTPUT_NODE</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">SUPPORTS_ASYNC</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">results_json</span><span class="sh">"</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">commands</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">bsub -q short sleep 3</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">commands</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># 0) ì¸ë¼ì¸ ì˜µì…˜/ëª…ë ¹ íŒŒì‹±
</span>        <span class="n">opts</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="nf">parse_inline_options_and_commands</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">batch_size</span><span class="sh">"</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">poll_interval_s</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">poll_interval_s</span><span class="sh">"</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="c1"># backward compat: status_ttl_s -&gt; full_ttl_s
</span>        <span class="n">full_ttl_s</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">full_ttl_s</span><span class="sh">"</span><span class="p">,</span> <span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status_ttl_s</span><span class="sh">"</span><span class="p">,</span> <span class="mi">10</span><span class="p">)))</span>
        <span class="n">min_refresh_gap_s</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">min_refresh_gap_s</span><span class="sh">"</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="n">force_refresh_on_miss</span> <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">force_refresh_on_miss</span><span class="sh">"</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span>
        <span class="n">full_status_cmd_template</span> <span class="o">=</span> <span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">full_status_cmd_template</span><span class="sh">"</span><span class="p">,</span>
                                            <span class="sh">'</span><span class="s">bjobs -a -noheader -o </span><span class="sh">"</span><span class="s">jobid stat</span><span class="sh">"'</span><span class="p">)</span>
        <span class="n">max_wait_s</span> <span class="o">=</span> <span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">max_wait_s</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">max_wait_s</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">max_wait_s</span><span class="p">.</span><span class="nf">isdigit</span><span class="p">():</span>
            <span class="n">max_wait_s</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">max_wait_s</span><span class="p">)</span>

        <span class="c1"># 1) ì œì¶œ
</span>        <span class="n">submitted_at</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
        <span class="n">job_ids</span><span class="p">,</span> <span class="n">submissions</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">submit_commands_multiline</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>

        <span class="c1"># 2) ì „ì—­ ìºì‹œ/ë°±ì—”ë“œ
</span>        <span class="n">cache_dir</span> <span class="o">=</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="nf">default_cache_dir</span><span class="p">())</span>
        <span class="n">cache_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">status_full_cache.json</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">full_cache</span> <span class="o">=</span> <span class="nc">FullListSharedCache</span><span class="p">(</span>
            <span class="n">cache_file</span><span class="p">,</span>
            <span class="n">full_ttl_s</span><span class="o">=</span><span class="n">full_ttl_s</span><span class="p">,</span>
            <span class="n">min_refresh_gap_s</span><span class="o">=</span><span class="n">min_refresh_gap_s</span><span class="p">,</span>
            <span class="n">force_refresh_on_miss</span><span class="o">=</span><span class="n">force_refresh_on_miss</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="nc">LSFBjobsFullBackend</span><span class="p">(</span><span class="n">full_status_cmd_template</span><span class="o">=</span><span class="n">full_status_cmd_template</span><span class="p">)</span>

        <span class="c1"># 2-1) ì½”ë„ˆ ì¼€ì´ìŠ¤ ì™„í™”: ë°©ê¸ˆ ì œì¶œí•œ ì¡ì„ ìºì‹œì— ì‹œë“œ
</span>        <span class="k">if</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">full_cache</span><span class="p">.</span><span class="nf">seed_submitted</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>

        <span class="c1"># 3) ì™„ë£Œê¹Œì§€ ëŒ€ê¸°
</span>        <span class="n">final_statuses</span><span class="p">,</span> <span class="n">waited_sec</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">wait_until_done</span><span class="p">(</span>
            <span class="n">job_ids</span><span class="p">,</span> <span class="n">poll_interval_s</span><span class="p">,</span> <span class="n">full_cache</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">max_wait_s</span><span class="o">=</span><span class="n">max_wait_s</span>
        <span class="p">)</span>

        <span class="n">completed_at</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
        <span class="n">all_done</span> <span class="o">=</span> <span class="nf">all</span><span class="p">((</span><span class="n">st</span> <span class="ow">in</span> <span class="n">TERMINAL_STATES</span><span class="p">)</span> <span class="ow">and</span> <span class="n">st</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">final_statuses</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>

        <span class="n">failed_submissions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span>
            <span class="k">if</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># 4) ê²°ê³¼ íŒŒì¼ ì €ì¥
</span>        <span class="n">session_tag</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">utcnow</span><span class="p">().</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%Y%m%d_%H%M%S</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="sh">"</span><span class="s">_</span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="nf">getpid</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">results_dir</span> <span class="o">=</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">runs</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">results_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">results_dir</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">result_</span><span class="si">{</span><span class="n">session_tag</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">result_payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">submitted_at</span><span class="sh">"</span><span class="p">:</span> <span class="n">submitted_at</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">completed_at</span><span class="sh">"</span><span class="p">:</span> <span class="n">completed_at</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">duration_sec</span><span class="sh">"</span><span class="p">:</span> <span class="nf">round</span><span class="p">(</span><span class="n">waited_sec</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">job_ids</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">final_status</span><span class="sh">"</span><span class="p">:</span> <span class="n">final_statuses</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">all_done</span><span class="sh">"</span><span class="p">:</span> <span class="n">all_done</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">failed_submissions</span><span class="sh">"</span><span class="p">:</span> <span class="n">failed_submissions</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">:</span> <span class="n">cwd</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">options</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">batch_size</span><span class="sh">"</span><span class="p">:</span> <span class="n">batch_size</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">poll_interval_s</span><span class="sh">"</span><span class="p">:</span> <span class="n">poll_interval_s</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">full_ttl_s</span><span class="sh">"</span><span class="p">:</span> <span class="n">full_ttl_s</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">min_refresh_gap_s</span><span class="sh">"</span><span class="p">:</span> <span class="n">min_refresh_gap_s</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">force_refresh_on_miss</span><span class="sh">"</span><span class="p">:</span> <span class="n">force_refresh_on_miss</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">full_status_cmd_template</span><span class="sh">"</span><span class="p">:</span> <span class="n">full_status_cmd_template</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">max_wait_s</span><span class="sh">"</span><span class="p">:</span> <span class="n">max_wait_s</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">results_file</span><span class="sh">"</span><span class="p">:</span> <span class="n">results_path</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">results_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">result_payload</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">job_ids_str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>
        <span class="n">results_json_str</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">result_payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">job_ids_str</span><span class="p">,</span> <span class="n">results_json_str</span><span class="p">)</span>

<span class="c1"># ComfyUI ë…¸ë“œ ë“±ë¡
</span><span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LSFSubmitAndWait</span><span class="sh">"</span><span class="p">:</span> <span class="n">LSFSubmitAndWait</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LSFSubmitAndWait</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">LSF: Submit &amp; Wait</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="ì‚¬ìš©-ë°©ë²•ì˜µì…˜-ì˜ˆì‹œ">ì‚¬ìš© ë°©ë²•/ì˜µì…˜ ì˜ˆì‹œ</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vbnet

# LSF: batch_size=4 poll_interval_s=10 full_ttl_s=15 min_refresh_gap_s=5 force_refresh_on_miss=true
# LSF: full_status_cmd_template="bjobs -a -noheader -o \"jobid stat\""
bsub -q short -J test1 sleep 5
bsub -q short -J test2 sleep 8
bsub -q short -J test3 sleep 2
</code></pre></div></div>

<ul>
  <li>
    <p><strong>full_ttl_s</strong> : ì „ì²´ ìŠ¤ëƒ…ìƒ·ì˜ TTL.</p>
  </li>
  <li>
    <p><strong>min_refresh_gap_s</strong> : <code class="language-plaintext highlighter-rouge">-a</code> ì¬í˜¸ì¶œ ìµœì†Œ ê°„ê²©(ëª¨ë“  ë…¸ë“œ ê³µí†µ).</p>
  </li>
  <li>
    <p><strong>force_refresh_on_miss</strong> : ìš”ì²­ Jobì´ ìºì‹œì— ì—†ì„ ë•Œ TTL ê´€ê³„ì—†ì´ ì¡°ê¸° ê°±ì‹  ì‹œë„(ë‹¨ ìµœì†Œ ê°„ê²©ì€ ì§€í‚´).</p>
  </li>
  <li>
    <p><strong>full_status_cmd_template</strong> : ë‹¤ë¥¸ ì‹œìŠ¤í…œ/í˜•ì‹ìœ¼ë¡œ êµì²´ ê°€ëŠ¥(ì˜ˆ: ì»¤ìŠ¤í…€ ìŠ¤í¬ë¦½íŠ¸).</p>
  </li>
</ul>

<hr />

<h2 id="ì½”ë„ˆ-ì¼€ì´ìŠ¤ê°€-í•´ê²°ë˜ëŠ”-íë¦„ìš”ì•½">ì½”ë„ˆ ì¼€ì´ìŠ¤ê°€ í•´ê²°ë˜ëŠ” íë¦„(ìš”ì•½)</h2>

<ol>
  <li>
    <p>Node1Â·Node2ê°€ ê°ê° ì¡ ì œì¶œ â†’ <strong>ê°ì ì œì¶œ ì§í›„ ìºì‹œì— SUBMITTEDë¡œ ì‹œë“œ</strong>.</p>
  </li>
  <li>
    <p>í´ë§ ì‹œ, <strong>ìš”ì²­í•œ JobIDê°€ ìºì‹œì— ì´ë¯¸ ì¡´ì¬</strong> â†’ <code class="language-plaintext highlighter-rouge">SUBMITTED</code>ë¼ë„ <strong>ì‹ ì„ </strong> ìœ¼ë¡œ ê°„ì£¼ë˜ì–´ ë¶ˆí•„ìš”í•œ ì¡°ê¸° <code class="language-plaintext highlighter-rouge">-a</code> í˜¸ì¶œ ë°©ì§€.</p>
  </li>
  <li>
    <p>TTL ë§Œë£Œ ë˜ëŠ” miss+ìµœì†Œ ê°„ê²© ì¶©ì¡± ì‹œ, <strong>í•œ ë…¸ë“œë§Œ</strong> <code class="language-plaintext highlighter-rouge">-a</code> ì‹¤í–‰(ë½) â†’ ì „ì²´ ìŠ¤ëƒ…ìƒ· ì—…ë°ì´íŠ¸.</p>
  </li>
  <li>
    <p>ëª¨ë“  ë…¸ë“œëŠ” <strong>ê°™ì€ ìºì‹œ íŒŒì¼</strong> ì„ ë³´ë©° íš¨ìœ¨ì ìœ¼ë¡œ ìƒíƒœ ë™ê¸°í™”.</p>
  </li>
</ol>

<hr />

<p>ì›í•˜ì‹œë©´:</p>

<ul>
  <li>
    <p><strong>ì§€ìˆ˜ ë°±ì˜¤í”„/í´ë§ ì£¼ê¸° ìë™ íŠœë‹</strong> ,</p>
  </li>
  <li>
    <p><strong>ì¶”ê°€ ìƒíƒœ ë§¤í•‘(ì˜ˆ: ZOMBI/PSUSP ë“±)</strong> ,</p>
  </li>
  <li>
    <p><strong>SLURM ë“± ë‹¤ë¥¸ ìŠ¤ì¼€ì¤„ëŸ¬ í…œí”Œë¦¿</strong> ë„ ë°”ë¡œ ë¶™ì—¬ë“œë¦´ê²Œìš”.</p>
  </li>
</ul>

<p class="chat--user">

ì§ˆë¬¸ 1. íŒŒì¼ read accessë¥¼ ê³„ì†í•˜ëŠ”ê±°ì•¼? ê·¸ë ‡ë‹¤ë©´ ëŒ€ì‹ ì— singletonìœ¼ë¡œ ëœ cache í´ë˜ìŠ¤ì— ì €ì¥ëœ ì •ë³´ë¥¼ ì‚¬ìš©í•˜ëŠ” ê±´ ì–´ë•Œ? ì§ˆë¬¸ 2. job id | ì»¤ë§¨ë“œ | job ìƒíƒœ | ë¥¼ ë…¸ë“œì— ê³„ì† ì—…ë°ì´íŠ¸í•˜ë©° ë³´ì—¬ì¤„ ìˆœ ì—†ë‚˜? ì¢€ ê³ ê¸‰ ê¸°ëŠ¥ ê°™ê¸°ëŠ”í•œë° ë˜ë©´ ì°¸ ì¢‹ì„ë“¯

</p>

<p>ì¢‹ì€ ì§ˆë¬¸! í•µì‹¬ë§Œ â€œì‹¤ë¬´ì ìœ¼ë¡œâ€ ì •ë¦¬í•˜ê³ , ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” ì½”ë“œ ì¡°ê°(ì¶”ê°€/íŒ¨ì¹˜ìš©)ë„ ë“œë¦´ê²Œìš”.</p>

<hr />

<h1 id="q1-íŒŒì¼-read-accessë¥¼-ê³„ì†í•˜ë‚˜ìš”--ëŒ€ì‹ -í”„ë¡œì„¸ìŠ¤-ë‚´-ì‹±ê¸€í†¤-ìºì‹œ-ì“°ë©´-ì–´ë•Œìš”">Q1. â€œíŒŒì¼ read accessë¥¼ ê³„ì†í•˜ë‚˜ìš”? â†’ ëŒ€ì‹  í”„ë¡œì„¸ìŠ¤ ë‚´ ì‹±ê¸€í†¤ ìºì‹œ ì“°ë©´ ì–´ë•Œìš”?â€</h1>

<h2 id="ê²°ë¡ -step-by-step">ê²°ë¡  (step-by-step)</h2>

<ol>
  <li>
    <p><strong>ë§ì•„ìš”.</strong> ì „ì—­ ê³µìœ ë¥¼ ìœ„í•´ íŒŒì¼ ìºì‹œë¥¼ ì“°ë©´ ì—¬ëŸ¬ ë…¸ë“œì—ì„œ ì½ê¸°/ì“°ê¸° ê²½ìŸì´ ìƒê¹ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>í•´ë²•ì€ 2-ê³„ì¸µ ìºì‹œ</strong> :</p>

    <ul>
      <li>
        <p><strong>í”„ë¡œì„¸ìŠ¤ ë‚´ ì‹±ê¸€í†¤ ë©”ëª¨ë¦¬ ìŠ¤ëƒ…ìƒ·</strong>(ì´ˆì €ì§€ì—°Â·ë½ í¬í•¨)</p>
      </li>
      <li>
        <p><strong>í”„ë¡œì„¸ìŠ¤ ê°„ ê³µìœ  íŒŒì¼ ìºì‹œ</strong>(TTL+ë½)</p>
      </li>
    </ul>
  </li>
  <li>
    <p>ì¡°íšŒ íë¦„:</p>

    <ul>
      <li>
        <p><strong>ë©”ëª¨ë¦¬ ìŠ¤ëƒ…ìƒ·ì´ ì‹ ì„ (TTL ì´ë‚´)</strong> â†’ íŒŒì¼ ì½ê¸° ì—†ì´ <strong>ì¦‰ì‹œ ë°˜í™˜</strong>.</p>
      </li>
      <li>
        <p>ì‹ ì„ í•˜ì§€ ì•Šìœ¼ë©´ <strong>íŒŒì¼ì„ 1íšŒ ì½ì–´ ë©”ëª¨ë¦¬ ê°±ì‹ </strong>.</p>
      </li>
      <li>
        <p>TTL ë§Œë£ŒÂ·MISSÂ·ìµœì†Œ ê°„ê²© ì¶©ì¡± ì‹œ <strong>í•œ í”„ë¡œì„¸ìŠ¤ë§Œ</strong> <code class="language-plaintext highlighter-rouge">bjobs -a</code> ìˆ˜í–‰í•´ íŒŒì¼/ë©”ëª¨ë¦¬ ë™ì‹œ ê°±ì‹ .</p>
      </li>
    </ul>
  </li>
  <li>
    <p>ì œì¶œ ì§í›„ <strong>SUBMITTED ì‹œë“œ</strong> ëŠ” <strong>ë©”ëª¨ë¦¬ì™€ íŒŒì¼ ëª¨ë‘</strong> ì— ë°˜ì˜ â†’ Node2 ì½”ë„ˆ ì¼€ì´ìŠ¤(ë°©ê¸ˆ ì œì¶œí•œ ì¡ì´ ìºì‹œì— ì•„ì§ ì—†ìŒ) í•´ì†Œ.</p>
  </li>
</ol>

<h3 id="ì ìš©-ì½”ë“œ-ê¸°ì¡´-fulllistsharedcache-ìœ„ì—-ì–¹ëŠ”-ì‹±ê¸€í†¤-ê³„ì¸µ">ì ìš© ì½”ë“œ (ê¸°ì¡´ <code class="language-plaintext highlighter-rouge">FullListSharedCache</code> ìœ„ì— ì–¹ëŠ” ì‹±ê¸€í†¤ ê³„ì¸µ)</h3>

<p>ì•„ë˜ ë¸”ë¡ë§Œ <strong>ì¶”ê°€/ì¹˜í™˜</strong> í•˜ì„¸ìš”. (ë‚˜ë¨¸ì§€ ë¡œì§ì€ ê·¸ëŒ€ë¡œ ë™ì‘)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># --- ì‹±ê¸€í†¤ ë©”ëª¨ë¦¬ ìŠ¤ëƒ…ìƒ· ê³„ì¸µ ---
</span><span class="k">class</span> <span class="nc">_MemSnap</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">jobs</span> <span class="o">=</span> <span class="p">{}</span>                  <span class="c1"># {job_id: {"status": str, "ts": float}, ...}
</span>        <span class="n">self</span><span class="p">.</span><span class="n">last_full_refresh_ts</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># float epoch
</span>        <span class="n">self</span><span class="p">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">FullListSharedCache</span><span class="p">:</span>
    <span class="n">_mem</span> <span class="o">=</span> <span class="nf">_MemSnap</span><span class="p">()</span>  <span class="c1"># í”„ë¡œì„¸ìŠ¤ ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤
</span>
    <span class="c1"># ... (ê¸°ì¡´ __init__, _lock_fd ë“±ì€ ê·¸ëŒ€ë¡œ)
</span>
    <span class="k">def</span> <span class="nf">_mem_is_fresh</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">now</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">ttl</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="nf">float</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="n">last_full_refresh_ts</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="nf">float</span><span class="p">(</span><span class="n">ttl</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_mem_update_from_dict</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="n">jobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="n">last_full_refresh_ts</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_persist_and_update_mem</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_write_cache</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="c1"># íŒŒì¼ ì“°ê¸°ì™€ ë™ì‹œì— ë©”ëª¨ë¦¬ ìŠ¤ëƒ…ìƒ· ìµœì‹ í™”
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">_mem_update_from_dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">seed_submitted</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">meta</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">ì œì¶œ ì§í›„ SUBMITTED ìƒíƒœë¥¼ ë©”ëª¨ë¦¬/íŒŒì¼ ëª¨ë‘ì— ì‹œë“œ.</span><span class="sh">"""</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="c1"># ë©”ëª¨ë¦¬ ì—…ë°ì´íŠ¸
</span>        <span class="c1"># (ë™ì‹œì— ë“¤ì–´ì™€ë„ ë¬´í•´; ìµœì‹  tsë¡œ ë®ì–´ì¨ë„ OK)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="n">jobs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="n">jobs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="n">jobs</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">SUBMITTED</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">now</span><span class="p">})</span>
        <span class="c1"># íŒŒì¼ ì—…ë°ì´íŠ¸
</span>        <span class="n">fh</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_lock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                <span class="n">jobs</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">SUBMITTED</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">now</span><span class="p">})</span>
            <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobs</span>
            <span class="c1"># (ì„ íƒ) ì»¤ë§¨ë“œ ë©”íƒ€ ì €ì¥
</span>            <span class="k">if</span> <span class="n">meta</span><span class="p">:</span>
                <span class="n">jm</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">:</span>
                        <span class="n">jm</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span>
                <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">jm</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_persist_and_update_mem</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">maybe_refresh_full</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">backend</span><span class="p">:</span> <span class="n">StatusBackend</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="c1"># ìµœì†Œ ê°„ê²©Â·ë½ ì²˜ë¦¬ ë™ì¼
</span>        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
        <span class="n">last_ts</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="nf">if </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_ts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nf">float</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">min_refresh_gap_s</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">lock_path</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span> <span class="o">+</span> <span class="sh">"</span><span class="s">.refresh.lock</span><span class="sh">"</span>
        <span class="n">lock_fh</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_lock_fd</span><span class="p">(</span><span class="n">lock_path</span><span class="p">,</span> <span class="n">nonblock</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lock_fh</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data2</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
            <span class="n">last_ts2</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data2</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="nf">if </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_ts2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nf">float</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">min_refresh_gap_s</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="n">snapshot</span> <span class="o">=</span> <span class="k">await</span> <span class="n">backend</span><span class="p">.</span><span class="nf">query_full</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">snapshot</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="n">now2</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_lock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">now2</span>
                <span class="k">for</span> <span class="n">jid</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">snapshot</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
                    <span class="n">jobs</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="n">st</span><span class="p">,</span> <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span><span class="p">}</span>
                <span class="n">base</span><span class="p">[</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobs</span>
                <span class="n">base</span><span class="p">[</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">now2</span>
                <span class="n">meta</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">meta</span><span class="p">[</span><span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">reason</span>
                <span class="n">meta</span><span class="p">[</span><span class="sh">"</span><span class="s">refreshed_at</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
                <span class="n">base</span><span class="p">[</span><span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_persist_and_update_mem</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>  <span class="c1"># íŒŒì¼ê³¼ ë©”ëª¨ë¦¬ ë™ì‹œ ê°±ì‹ 
</span>            <span class="k">finally</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">lock_fh</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_statuses</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">backend</span><span class="p">:</span> <span class="n">StatusBackend</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="c1"># 1) ë©”ëª¨ë¦¬ ìŠ¤ëƒ…ìƒ· ìš°ì„ 
</span>        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="n">mem_fresh</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_mem_is_fresh</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">full_ttl_s</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mem_fresh</span><span class="p">:</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="n">jobs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># íŒŒì¼ 1íšŒ ì½ì–´ ë©”ëª¨ë¦¬ ìµœì‹ í™”
</span>                <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_mem_update_from_dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="n">jobs</span>

        <span class="k">def</span> <span class="nf">_fresh</span><span class="p">(</span><span class="n">jid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">ent</span> <span class="o">=</span> <span class="n">jobs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ent</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="nf">return </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="nf">float</span><span class="p">(</span><span class="n">ent</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="o">&lt;=</span> <span class="nf">float</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">full_ttl_s</span><span class="p">)</span>

        <span class="n">need_refresh</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_mem_is_fresh</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">full_ttl_s</span><span class="p">):</span>
            <span class="n">need_refresh</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">miss</span> <span class="o">=</span> <span class="p">[</span><span class="n">jid</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span> <span class="k">if</span> <span class="ow">not</span> <span class="nf">_fresh</span><span class="p">(</span><span class="n">jid</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">miss</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">force_refresh_on_miss</span><span class="p">:</span>
            <span class="n">need_refresh</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">need_refresh</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">maybe_refresh_full</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="sh">"</span><span class="s">ttl_or_miss</span><span class="sh">"</span><span class="p">)</span>
            <span class="c1"># ë¦¬í”„ë ˆì‹œ í›„ ë©”ëª¨ë¦¬ì—ì„œ ì¬ì¡°íšŒ
</span>            <span class="n">jobs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem</span><span class="p">.</span><span class="n">jobs</span>

        <span class="k">return</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="p">(</span><span class="n">jobs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>íš¨ê³¼: <strong>ë™ì¼ í”„ë¡œì„¸ìŠ¤(=ë™ì¼ ComfyUI ì¸ìŠ¤í„´ìŠ¤)</strong> ì—ì„œ ì—¬ëŸ¬ ë…¸ë“œê°€ ëŒì•„ë„, ëŒ€ë¶€ë¶„ <strong>íŒŒì¼ I/O ì—†ì´ ë©”ëª¨ë¦¬ë§Œ</strong> ë³´ê²Œ ë©ë‹ˆë‹¤. ê·¸ë˜ë„ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤/ë¨¸ì‹ ê³¼ ê³µìœ ê°€ í•„ìš”í•˜ë©´ íŒŒì¼ ìŠ¤ëƒ…ìƒ·ì´ â€œì‚¬ì‹¤ìƒì˜ ì†ŒìŠ¤ ì˜¤ë¸Œ íŠ¸ë£¨ìŠ¤â€ê°€ ë˜ê³ , í•œ í”„ë¡œì„¸ìŠ¤ë§Œ <code class="language-plaintext highlighter-rouge">-a</code>ë¥¼ ì‹¤í–‰í•´ <strong>í­ì£¼ ë°©ì§€</strong> ê°€ ìœ ì§€ë©ë‹ˆë‹¤.</p>
</blockquote>

<p>ë˜í•œ ì œì¶œ ì§í›„:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># submit ì´í›„
</span><span class="n">jid_to_cmd</span> <span class="o">=</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">submitted_at</span><span class="sh">"</span><span class="p">:</span> <span class="nf">iso_now</span><span class="p">()}</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])}</span>
<span class="n">full_cache</span><span class="p">.</span><span class="nf">seed_submitted</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">jid_to_cmd</span><span class="p">)</span>  <span class="c1"># ë©”ëª¨ë¦¬/íŒŒì¼ ëª¨ë‘ ì‹œë“œ + ì»¤ë§¨ë“œ ë©”íƒ€ ì €ì¥
</span></code></pre></div></div>

<hr />

<h1 id="q2-job-id--ì»¤ë§¨ë“œ--ìƒíƒœë¥¼-ë…¸ë“œì—-ê³„ì†-ì—…ë°ì´íŠ¸í•´ì„œ-ë³´ì—¬ì¤„-ìˆ˜-ìˆë‚˜ìš”">Q2. â€œjob id | ì»¤ë§¨ë“œ | ìƒíƒœâ€ë¥¼ ë…¸ë“œì— <strong>ê³„ì†</strong> ì—…ë°ì´íŠ¸í•´ì„œ ë³´ì—¬ì¤„ ìˆ˜ ìˆë‚˜ìš”?</h1>

<h2 id="ê²°ë¡ -step-by-step-1">ê²°ë¡  (step-by-step)</h2>

<ol>
  <li>
    <p><strong>ComfyUI ì½”ì–´ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ</strong> ì„ì˜ ë…¸ë“œê°€ ì‹¤í–‰ ì¤‘ì— <strong>UIë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°±ì‹ </strong> í•˜ëŠ” APIë¥¼ ì œê³µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤(ìµœì¢… ì¶œë ¥ë§Œ í‘œì‹œ).</p>
  </li>
  <li>
    <p>ëŒ€ì‹  í˜„ì‹¤ì ì¸ ë‘ ê°€ì§€ ê²½ë¡œê°€ ìˆìŠµë‹ˆë‹¤.</p>
  </li>
</ol>

<h3 id="aì•ˆí”„ë¡ íŠ¸-ìˆ˜ì •-ì—†ì´-ë…¸ë“œë§Œìœ¼ë¡œ">Aì•ˆ(í”„ë¡ íŠ¸ ìˆ˜ì • ì—†ì´, ë…¸ë“œë§Œìœ¼ë¡œ)</h3>

<ul>
  <li>
    <p><strong>ë³´ì¡° ë·°ì–´ ë…¸ë“œ</strong> ë¥¼ í•˜ë‚˜ ë” ë§Œë“¤ì–´, ê³µìœ  ìºì‹œ(<code class="language-plaintext highlighter-rouge">status_full_cache.json</code>) + <code class="language-plaintext highlighter-rouge">jobs_meta</code>ì—ì„œ <strong>í‘œë¥¼ ìƒì„±(STRING ë˜ëŠ” ì´ë¯¸ì§€)</strong> í•´ì„œ ë³´ì—¬ì¤ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ìµœì‹  ìƒíƒœë¥¼ ë³´ê³  ì‹¶ì„ ë•Œ ë·°ì–´ ë…¸ë“œë¥¼ <strong>ë‹¤ì‹œ ì‹¤í–‰(Queue)</strong> í•˜ë©´ í‘œê°€ ê°±ì‹ ë©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ìë™ ë¦¬í”„ë ˆì‹œëŠ” <code class="language-plaintext highlighter-rouge">Loop/Repeat</code>ë¥˜ í™•ì¥ ë…¸ë“œë¥¼ ê³ë“¤ì´ë©´ ë©ë‹ˆë‹¤.</p>
  </li>
</ul>

<blockquote>
  <p>ì¥ì : ComfyUI ë³€ê²½ ì—†ì´ ì¦‰ì‹œ ì‚¬ìš©.<br />
 ë‹¨ì : â€œì§€ì† ìŠ¤íŠ¸ë¦¬ë°â€ì€ ì•„ë‹ˆê³  <strong>ìˆ˜ë™/ì£¼ê¸° ì¬ì‹¤í–‰</strong>.</p>
</blockquote>

<h3 id="bì•ˆì§„ì§œ-ì‹¤ì‹œê°„-íŒ¨ë„">Bì•ˆ(ì§„ì§œ ì‹¤ì‹œê°„ íŒ¨ë„)</h3>

<ul>
  <li>
    <p>ì»¤ìŠ¤í…€ ë…¸ë“œ íŒŒì¼ ì•ˆì— <strong>ê°€ë²¼ìš´ HTTP GET ì—”ë“œí¬ì¸íŠ¸</strong> ë¥¼ ì¶”ê°€(ComfyUI ì„œë²„ì— ë¼ìš°íŠ¸ ë“±ë¡) â†’ í”„ë¡ íŠ¸ì— ì‘ì€ ìŠ¤í¬ë¦½íŠ¸(ë˜ëŠ” ë³„ë„ í”ŒëŸ¬ê·¸ì¸)ë¡œ <strong>ì£¼ê¸° í´ë§</strong> í•˜ì—¬ í‘œë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì‚¬ì‹¤ìƒ â€œì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œâ€ë¥¼ ComfyUI ì•ˆìª½ íŒ¨ë„ì— ë„£ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
  </li>
</ul>

<blockquote>
  <p>ì¥ì : ì§„ì§œ ë¼ì´ë¸Œ.<br />
 ë‹¨ì : í”„ë¡ íŠ¸ì— ì†Œí­ ì¶”ê°€ ì‘ì—… í•„ìš”.</p>
</blockquote>

<hr />

<h2 id="ë°”ë¡œ-ì“¸-ìˆ˜-ìˆëŠ”-ë·°ì–´-ë…¸ë“œ-aì•ˆ">ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” â€œë·°ì–´ ë…¸ë“œâ€ (Aì•ˆ)</h2>

<p>ì•„ë˜ í´ë˜ìŠ¤ë¥¼ ê°™ì€ íŒŒì¼ì— <strong>ì¶”ê°€</strong> í•˜ì„¸ìš”.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ====== ë·°ì–´ ë…¸ë“œ: ìƒíƒœ í…Œì´ë¸” ì¶œë ¥ ======
</span><span class="k">class</span> <span class="nc">LSFStatusBoard</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ì…ë ¥:
      - job_ids (STRING): </span><span class="sh">"</span><span class="s">123,124,125</span><span class="sh">"</span><span class="s"> (ë¹„ì›Œë‘ë©´ ìºì‹œì— ìˆëŠ” ìµœê·¼ Nê°œë¥¼ ë³´ì—¬ì¤Œ)
      - top_k (INT): job_ids ë¹„ì—ˆì„ ë•Œ ìµœê·¼ Nê°œ
      - width_limit (INT): ì»¤ë§¨ë“œ ì»¬ëŸ¼ ìë¥´ê¸° ê¸¸ì´
    ì¶œë ¥:
      - table_text (STRING): ëª¨ë…¸ìŠ¤í˜ì´ìŠ¤ í‘œ í…ìŠ¤íŠ¸
    </span><span class="sh">"""</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LSF</span><span class="sh">"</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">table_text</span><span class="sh">"</span><span class="p">,)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">top_k</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">INT</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="sh">"</span><span class="s">min</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">max</span><span class="sh">"</span><span class="p">:</span> <span class="mi">500</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">width_limit</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">INT</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span> <span class="sh">"</span><span class="s">min</span><span class="sh">"</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="sh">"</span><span class="s">max</span><span class="sh">"</span><span class="p">:</span> <span class="mi">200</span><span class="p">}),</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_read_cache</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="nf">default_cache_dir</span><span class="p">())</span>
        <span class="n">cache_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">status_full_cache.json</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span> <span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span> <span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_short</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">s</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">limit</span> <span class="nf">else </span><span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="n">limit</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="sh">"</span><span class="s">â€¦</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fmt_table</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">rows</span><span class="p">):</span>
        <span class="c1"># ê³ ì • í­ í‘œ ìƒì„±
</span>        <span class="n">jid_w</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nf">max</span><span class="p">((</span><span class="nf">len</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mi">6</span><span class="p">))</span>
        <span class="n">st_w</span>  <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">max</span><span class="p">((</span><span class="nf">len</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="sh">'</span><span class="s">JOBID</span><span class="sh">'</span><span class="si">:</span><span class="o">&lt;</span><span class="si">{</span><span class="n">jid_w</span><span class="si">}}</span><span class="s"> | </span><span class="si">{</span><span class="sh">'</span><span class="s">STATUS</span><span class="sh">'</span><span class="si">:</span><span class="o">&lt;</span><span class="si">{</span><span class="n">st_w</span><span class="si">}}</span><span class="s"> | CMD</span><span class="sh">"</span>
        <span class="n">sep</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-</span><span class="sh">"</span><span class="o">*</span><span class="nf">len</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="p">[</span><span class="n">hdr</span><span class="p">,</span> <span class="n">sep</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">body</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="sh">'</span><span class="s">job_id</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="o">&lt;</span><span class="si">{</span><span class="n">jid_w</span><span class="si">}}</span><span class="s"> | </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="sh">'</span><span class="s">status</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="o">&lt;</span><span class="si">{</span><span class="n">st_w</span><span class="si">}}</span><span class="s"> | </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="sh">'</span><span class="s">cmd</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">width_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">80</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_cache</span><span class="p">()</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">job_ids</span><span class="p">.</span><span class="nf">strip</span><span class="p">():</span>
            <span class="n">jids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ìµœê·¼ top_k (ts ê¸°ì¤€ ì •ë ¬)
</span>            <span class="n">jids</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">jobs</span><span class="p">.</span><span class="nf">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">j</span><span class="p">:</span> <span class="n">jobs</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)[:</span><span class="n">top_k</span><span class="p">]</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">jids</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">jobs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">meta</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
            <span class="n">rows</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="n">st</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nf">_short</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">width_limit</span><span class="p">),</span>
            <span class="p">})</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_fmt_table</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">table</span><span class="p">,)</span>

<span class="c1"># ë“±ë¡
</span><span class="n">NODE_CLASS_MAPPINGS</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span><span class="sh">"</span><span class="s">LSFStatusBoard</span><span class="sh">"</span><span class="p">:</span> <span class="n">LSFStatusBoard</span><span class="p">})</span>
<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span><span class="sh">"</span><span class="s">LSFStatusBoard</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">LSF: Status Board</span><span class="sh">"</span><span class="p">})</span>
</code></pre></div></div>

<h3 id="ì œì¶œ-ë…¸ë“œì—ì„œ-ì»¤ë§¨ë“œ-ë©”íƒ€-ì €ì¥í•œ-ì¤„-ì¶”ê°€">ì œì¶œ ë…¸ë“œì—ì„œ ì»¤ë§¨ë“œ ë©”íƒ€ ì €ì¥(í•œ ì¤„ ì¶”ê°€)</h3>

<p>ì•ì„œ Q1 ì½”ë“œì²˜ëŸ¼ ì œì¶œ ì§í›„ ì»¤ë§¨ë“œë„ í•¨ê»˜ ì‹œë“œí•©ë‹ˆë‹¤:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">jid_to_cmd</span> <span class="o">=</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">submitted_at</span><span class="sh">"</span><span class="p">:</span> <span class="nf">iso_now</span><span class="p">()}</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])}</span>
<span class="n">full_cache</span><span class="p">.</span><span class="nf">seed_submitted</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">jid_to_cmd</span><span class="p">)</span>
</code></pre></div></div>

<blockquote>
  <p>ì´ì œ ë·°ì–´ ë…¸ë“œì—ì„œ <strong>JOBID | STATUS | CMD</strong> ë¥¼ ê¹”ë”íˆ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br />
 â€œê³„ì†â€ ê°±ì‹ í•˜ë ¤ë©´ ë·°ì–´ ë…¸ë“œë¥¼ <strong>ì£¼ê¸°ì ìœ¼ë¡œ ì¬ì‹¤í–‰</strong>(ì§ì ‘ í´ë¦­ ë˜ëŠ” ë°˜ë³µ ì‹¤í–‰ ë…¸ë“œ ì‚¬ìš©)í•˜ì„¸ìš”.</p>
</blockquote>

<hr />

<h2 id="ì§„ì§œ-ì‹¤ì‹œê°„-íŒ¨ë„-bì•ˆ-ì„ íƒ">ì§„ì§œ ì‹¤ì‹œê°„ íŒ¨ë„ (Bì•ˆ, ì„ íƒ)</h2>

<ul>
  <li>
    <p>ê°€ëŠ¥: ì„œë²„ ë¼ìš°íŠ¸ë¥¼ í•˜ë‚˜ ë…¸ë“œ íŒŒì¼ì— ë“±ë¡í•´ JSONì„ ë‚´ë³´ë‚´ê³ , í”„ë¡ íŠ¸(ê°„ë‹¨ JS)ì—ì„œ 1~3ì´ˆ ê°„ê²© í´ë§.</p>
  </li>
  <li>
    <p>í•„ìš” ì½”ë“œ(ê°œìš”): <code class="language-plaintext highlighter-rouge">server.PromptServer</code> ì´ìš©í•´ <code class="language-plaintext highlighter-rouge">GET /lsf/status?job_ids=...</code> ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€ â†’ ìœ„ <code class="language-plaintext highlighter-rouge">LSFStatusBoard</code>ì˜ ë‚´ë¶€ ë¡œì§ì„ ì¬ì‚¬ìš©í•´ JSON ì‘ë‹µ.</p>
  </li>
  <li>
    <p>ì›í•˜ì‹œë©´ ì´ ë¼ìš°íŠ¸ + ìµœì†Œ HTML/JS íŒ¨ë„ ì½”ë“œë¥¼ ë°”ë¡œ ë¶™ì—¬ë“œë¦´ê²Œìš”.</p>
  </li>
</ul>

<hr />

<h2 id="ìš”ì•½">ìš”ì•½</h2>

<ul>
  <li>
    <p><strong>Q1</strong> : íŒŒì¼ ë‚¨ìš© ì—†ì´ <strong>â€œë©”ëª¨ë¦¬ ì‹±ê¸€í†¤ + íŒŒì¼ ìŠ¤ëƒ…ìƒ·â€</strong> 2-ê³„ì¸µ ìºì‹œë¡œ í•´ê²°. ì œì¶œ ì§í›„ <strong>SUBMITTED ì‹œë“œ</strong> ë¡œ Node2 ì½”ë„ˆ ì¼€ì´ìŠ¤ë„ í•´ê²°.</p>
  </li>
  <li>
    <p><strong>Q2</strong> : ì½”ì–´ UIëŠ” ì¤‘ê°„ ê°±ì‹ ì´ ì–´ë ¤ìš°ë¯€ë¡œ</p>

    <ul>
      <li>
        <p>ë°”ë¡œ ì“°ë ¤ë©´ <strong>ë·°ì–´ ë…¸ë“œ(Aì•ˆ)</strong> ë¡œ í‘œë¥¼ ì¬ì‹¤í–‰ ê°±ì‹ ,</p>
      </li>
      <li>
        <p>ì§„ì§œ ë¼ì´ë¸ŒëŠ” <strong>ê°„ë‹¨ ë¼ìš°íŠ¸(Bì•ˆ)</strong> + ì†Œí˜• íŒ¨ë„.</p>
      </li>
    </ul>
  </li>
</ul>

<p>ë” ì§„í•œ ê¸°ëŠ¥(ìƒíƒœ ì•„ì´ì½˜/ìƒ‰ìƒ, ì •ë ¬/í•„í„°, EXIT ì›ì¸ ì¶”ì , bjobs -a ì¶”ê°€ ì»¬ëŸ¼ íŒŒì‹± ë“±) ì›í•˜ì‹œë©´ ì´ì–´ì„œ í™•ì¥í•´ ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

impact nodeì—ì„œ ì•„ë˜ í•¨ìˆ˜(js)ì™€ PromptServer.instance.send_sync("impact-node-feedback", {"node_id": â€¦, â€widget_name": â€¦}) ì´ëŸ° í•¨ìˆ˜ë¥¼ ì´ìš©í•´ì„œ ëŸ°íƒ€ì„ì—ì„œ ìœ„ì ¯ ì—…ë°ì´íŠ¸ë¥¼ í•˜ëŠ” ê²ƒ ê°™ì€ë° ì´ëŸ° ì°¸ê³ í•´ì„œ markdown table í˜•ì‹ìœ¼ë¡œ Jod ID, Status, Command ë¥¼ String widgetì— ê³„ì† ì—…ë°ì´íŠ¸ í•´ë³´ì. function nodeFeedbackHandler(event) { let nodes = app.graph._nodes_by_id; let node = nodes[event.detail.node_id]; if(node) { const w = node.widgets.find((w) =&gt; event.detail.widget_name === w.name); if(w) { w.value = event.detail.value; } } } api.addEventListener("impact-node-feedback", nodeFeedbackHandler);

</p>

<p>ì¢‹ì•„â€”â€œimpact-node-feedbackâ€ íŒ¨í„´ì„ ê·¸ëŒ€ë¡œ í™œìš©í•´ì„œ, <strong>ëŸ°íƒ€ì„ì— String ìœ„ì ¯ì„ ê³„ì† ê°±ì‹ </strong>(ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸” í˜•íƒœ)í•˜ë„ë¡ ë…¸ë“œë¥¼ í™•ì¥í•´ë³¼ê²Œ. ì•„ë˜ëŠ” <strong>step-by-step</strong> ë¡œ ì •ë¦¬í•œ êµ¬í˜„ ê°€ì´ë“œ + ë°”ë¡œ ë¶™ì—¬ë„£ì–´ ì“¸ <strong>íŒ¨ì¹˜ ì½”ë“œ</strong> ì•¼.</p>

<hr />

<h1 id="ì–´ë–»ê²Œ-ì‘ë™í•˜ë‚˜-step-by-step">ì–´ë–»ê²Œ ì‘ë™í•˜ë‚˜ (step-by-step)</h1>

<ol>
  <li>
    <p><strong>í”„ë¡ íŠ¸ì—”ë“œ ë¦¬ìŠ¤ë„ˆ ë“±ë¡</strong><br />
ë„¤ê°€ ì¤€ í•¸ë“¤ëŸ¬ ê·¸ëŒ€ë¡œ ì”€. <code class="language-plaintext highlighter-rouge">impact-node-feedback</code> ì»¤ìŠ¤í…€ ë©”ì‹œì§€ë¥¼ ë°›ìœ¼ë©´ í•´ë‹¹ ë…¸ë“œì˜ íŠ¹ì • ìœ„ì ¯ ê°’ì„ ê°±ì‹ . ì´ ë°©ì‹ì€ ê³µì‹ ë¬¸ì„œì˜ <code class="language-plaintext highlighter-rouge">PromptServer.instance.send_sync()</code> ì‚¬ìš©ì ì •ì˜ ë©”ì‹œì§€ ê°€ì´ë“œì™€ ë™ì¼í•œ íë¦„ì´ì•¼. <a href="https://docs.comfy.org/development/comfyui-server/comms_messages">ComfyUI</a></p>
  </li>
  <li>
    <p><strong>ë…¸ë“œì— â€œí‘œì‹œ ì „ìš©â€ String ìœ„ì ¯ ì¶”ê°€</strong><br />
ì˜ˆ: <code class="language-plaintext highlighter-rouge">status_md</code> ë¼ëŠ” ì´ë¦„ì˜ ë©€í‹°ë¼ì¸ STRING ìœ„ì ¯. ë…¸ë“œ ì‹¤í–‰ ì¤‘ ì„œë²„ì—ì„œ ì´ ìœ„ì ¯ì˜ ê°’ì„ ê³„ì† ë°”ê¿”ì¹˜ê¸° í•¨(ë§ˆí¬ë‹¤ìš´ í‘œ í…ìŠ¤íŠ¸).</p>
  </li>
  <li>
    <p><strong>node_id í™•ë³´(í•„ìˆ˜)</strong><br />
ComfyUIëŠ” <code class="language-plaintext highlighter-rouge">INPUT_TYPES["hidden"]</code>ì— <code class="language-plaintext highlighter-rouge">"UNIQUE_ID"</code>ë¥¼ ë„£ìœ¼ë©´ ëŸ°íƒ€ì„ì—ì„œ <strong>ë…¸ë“œ id</strong> ë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ë°›ì„ ìˆ˜ ìˆìŒ. ì´ê±¸ payloadì— ì‹¤ì–´ ë³´ë‚´ë©´, í”„ë¡ íŠ¸ì—ì„œ ì •í™•í•œ ë…¸ë“œì˜ í•´ë‹¹ ìœ„ì ¯ë§Œ ì—…ë°ì´íŠ¸ ê°€ëŠ¥. <a href="https://docs.comfy.org/development/comfyui-server/comms_messages">ComfyUI+2</a></p>
  </li>
  <li>
    <p><strong>ì„œë²„ì—ì„œ ì£¼ê¸°ì ìœ¼ë¡œ send_sync ë°œì‚¬</strong><br />
í´ë§ ë£¨í”„ ë§¤ í„´ë§ˆë‹¤</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>arduino
     
PromptServer.instance.send_sync(
  "impact-node-feedback",
  {"node_id": node_id, "widget_name": "status_md", "value": table_md}
)
</code></pre></div>    </div>
  </li>
</ol>

<p>ë¡œ ìœ„ì ¯ ê°’ì„ í‘¸ì‹œ. (ë‹¤ìˆ˜ ì˜ˆì œë“¤ì´ ê°™ì€ íŒ¨í„´ìœ¼ë¡œ ìƒíƒœë¥¼ ì‹¤ì‹œê°„ ì•Œë¦¼) <a href="https://huggingface.co/spaces/Freak-ppa/ioatol/blob/b162d43c5cd550b037fb83fa04cc6301339f36f4/ComfyUI/custom_nodes/cg-use-everywhere/use_everywhere.py?utm_source=chatgpt.com">Hugging Face+2</a></p>

<hr />

<h1 id="0-í”„ë¡ íŠ¸ì—”ë“œì›¹-ì½”ë“œ--ë¦¬ìŠ¤ë„ˆ-ë“±ë¡">0) í”„ë¡ íŠ¸ì—”ë“œ(ì›¹) ì½”ë“œ â€” ë¦¬ìŠ¤ë„ˆ ë“±ë¡</h1>

<p><code class="language-plaintext highlighter-rouge">ComfyUI/web/extensions/impact_node_feedback.js</code> (íŒŒì¼ëª…ì€ ì„ì˜)ë¡œ ì €ì¥:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

function nodeFeedbackHandler(event) {
  let nodes = app.graph._nodes_by_id;
  let node = nodes[event.detail.node_id];
  if (node) {
    const w = node.widgets.find((w) =&gt; event.detail.widget_name === w.name);
    if (w) {
      w.value = event.detail.value;
      // UI ì¦‰ì‹œ ê°±ì‹ 
      if (w.callback) w.callback(w.value);
      node.setDirtyCanvas(true, true);
    }
  }
}
api.addEventListener("impact-node-feedback", nodeFeedbackHandler);
</code></pre></div></div>

<blockquote>
  <p>ì´ê±´ ComfyUIì˜ ì»¤ìŠ¤í…€ ë©”ì‹œì§€ ì´ë²¤íŠ¸ ì²˜ë¦¬ íŒ¨í„´ê³¼ 1:1ë¡œ ë§ìŒ. ì„œë²„ì—ì„œ <code class="language-plaintext highlighter-rouge">send_sync</code>ë¡œ <code class="language-plaintext highlighter-rouge">"impact-node-feedback"</code>ë¥¼ ë³´ë‚¼ ê±°ì•¼. <a href="https://docs.comfy.org/development/comfyui-server/comms_messages">ComfyUI</a></p>
</blockquote>

<hr />

<h1 id="1-íŒŒì´ì¬-ë…¸ë“œ-íŒ¨ì¹˜--ìœ„ì ¯node_idë¼ì´ë¸Œì—…ë°ì´íŠ¸-ì¶”ê°€">1) íŒŒì´ì¬ ë…¸ë“œ íŒ¨ì¹˜ â€” ìœ„ì ¯Â·node_idÂ·ë¼ì´ë¸Œì—…ë°ì´íŠ¸ ì¶”ê°€</h1>

<p>ì•„ë˜ <strong>ì¶”ê°€/ìˆ˜ì • ë¸”ë¡ë§Œ</strong> ê¸°ì¡´ ë…¸ë“œ íŒŒì¼ì— ë°˜ì˜í•˜ë©´ ë¼. (ì´ì „ ë‹µë³€ì—ì„œ ë§Œë“  LSFSubmitAndWait ê¸°ì¤€)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ìƒë‹¨ importì— ì¶”ê°€
</span><span class="kn">from</span> <span class="n">server</span> <span class="kn">import</span> <span class="n">PromptServer</span>  <span class="c1"># send_syncë¥¼ ìœ„í•´
</span>
<span class="c1"># ----- ìœ í‹¸: ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸” ìƒì„± -----
</span><span class="k">def</span> <span class="nf">_short</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">s</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">limit</span> <span class="nf">else </span><span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="n">limit</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="sh">"</span><span class="s">â€¦</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">make_status_markdown</span><span class="p">(</span><span class="n">job_rows</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">width_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">80</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    job_rows: [{</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">123</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">RUN</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">bsub ...</span><span class="sh">"</span><span class="s">}, ...]
    </span><span class="sh">"""</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">| JOB ID | STATUS | COMMAND |</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">|------:|:------:|---------|</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">job_rows</span><span class="p">:</span>
        <span class="n">jid</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">st</span>  <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nf">_short</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">),</span> <span class="n">width_limit</span><span class="p">)</span>
        <span class="c1"># íŒŒì´í”„ ì´ìŠ¤ì¼€ì´í”„ëŠ” ë‹¨ìˆœíˆ ë°±í‹± ê°ì‹¸ê¸°ë¡œ íšŒí”¼
</span>        <span class="n">lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">| `</span><span class="si">{</span><span class="n">jid</span><span class="si">}</span><span class="s">` | `</span><span class="si">{</span><span class="n">st</span><span class="si">}</span><span class="s">` | `</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s">` |</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

<span class="c1"># ----- LSFSubmitAndWait í´ë˜ìŠ¤ ë³€ê²½ -----
</span><span class="k">class</span> <span class="nc">LSFSubmitAndWait</span><span class="p">:</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LSF</span><span class="sh">"</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span>
    <span class="n">OUTPUT_NODE</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">SUPPORTS_ASYNC</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">results_json</span><span class="sh">"</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">commands</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">bsub -q short sleep 3</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="c1"># í‘œì‹œ ì „ìš© ìœ„ì ¯(ë¼ì´ë¸Œ ìƒíƒœ ë³´ë“œ)
</span>                <span class="sh">"</span><span class="s">status_md</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span>
                    <span class="sh">"</span><span class="s">| JOB ID | STATUS | COMMAND |</span><span class="se">\n</span><span class="s">|------:|:------:|---------|</span><span class="se">\n</span><span class="s">(ì‹¤í–‰ ì¤‘ ë¼ì´ë¸Œë¡œ ê°±ì‹ ë©ë‹ˆë‹¤)</span><span class="sh">"</span><span class="p">}),</span>
                <span class="c1"># ì¤„ ê¸¸ì´ ì œí•œ(ëª…ë ¹ì–´ ê³¼ë„í•˜ê²Œ ê¸¸ ë•Œ)
</span>                <span class="sh">"</span><span class="s">cmd_width_limit</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">INT</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="sh">"</span><span class="s">min</span><span class="sh">"</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span> <span class="sh">"</span><span class="s">max</span><span class="sh">"</span><span class="p">:</span> <span class="mi">200</span><span class="p">}),</span>
                <span class="c1"># í•„ìš” ì‹œ ë„ê¸°
</span>                <span class="sh">"</span><span class="s">live_update</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">BOOL</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="c1"># node_idë¥¼ ë°›ê¸° ìœ„í•œ hidden ì…ë ¥ (ê³µì‹ ë¬¸ì„œ íŒ¨í„´)
</span>            <span class="sh">"</span><span class="s">hidden</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span> <span class="sh">"</span><span class="s">node_id</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">UNIQUE_ID</span><span class="sh">"</span> <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                  <span class="n">commands</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">status_md</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span>
                  <span class="n">cmd_width_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                  <span class="n">live_update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                  <span class="n">node_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="c1"># ... (ê¸°ì¡´ run ì½”ë“œì˜ "ì˜µì…˜ íŒŒì‹±" ì§í›„ì— ì´ì–´ì„œ) ...
</span>
        <span class="c1"># 1) ì œì¶œ
</span>        <span class="n">submitted_at</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
        <span class="n">job_ids</span><span class="p">,</span> <span class="n">submissions</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">submit_commands_multiline</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>

        <span class="c1"># ì œì¶œí•œ ì»¤ë§¨ë“œ ë©”íƒ€ ë§µ (job_id -&gt; cmd)
</span>        <span class="n">jid_to_cmd</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">jid_to_cmd</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>

        <span class="c1"># 2) ì „ì—­ ìºì‹œ/ë°±ì—”ë“œ
</span>        <span class="n">cache_dir</span> <span class="o">=</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="nf">default_cache_dir</span><span class="p">())</span>
        <span class="n">cache_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">status_full_cache.json</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">full_cache</span> <span class="o">=</span> <span class="nc">FullListSharedCache</span><span class="p">(</span>
            <span class="n">cache_file</span><span class="p">,</span>
            <span class="n">full_ttl_s</span><span class="o">=</span><span class="n">full_ttl_s</span><span class="p">,</span>
            <span class="n">min_refresh_gap_s</span><span class="o">=</span><span class="n">min_refresh_gap_s</span><span class="p">,</span>
            <span class="n">force_refresh_on_miss</span><span class="o">=</span><span class="n">force_refresh_on_miss</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="nc">LSFBjobsFullBackend</span><span class="p">(</span><span class="n">full_status_cmd_template</span><span class="o">=</span><span class="n">full_status_cmd_template</span><span class="p">)</span>

        <span class="c1"># 2-1) ì œì¶œ ì§í›„ ìºì‹œ ì‹œë“œ(ì»¤ë§¨ë“œ ë©”íƒ€ í¬í•¨)
</span>        <span class="k">if</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="c1"># seed_submittedê°€ metaë¥¼ íŒŒì¼/ë©”ëª¨ë¦¬ ëª¨ë‘ì— ì €ì¥í•˜ë„ë¡ ì•ì„œ êµ¬í˜„í•´ë‘ 
</span>            <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid_to_cmd</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">),</span> <span class="sh">"</span><span class="s">submitted_at</span><span class="sh">"</span><span class="p">:</span> <span class="n">submitted_at</span><span class="p">}</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>
            <span class="n">full_cache</span><span class="p">.</span><span class="nf">seed_submitted</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">)</span>

        <span class="c1"># (ì‹ ê·œ) ì´ˆê¸° UI ì—…ë°ì´íŠ¸ í•œë²ˆ ìˆ˜í–‰
</span>        <span class="k">if</span> <span class="n">live_update</span> <span class="ow">and</span> <span class="n">node_id</span> <span class="ow">and</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[{</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid</span><span class="p">,</span> <span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">SUBMITTED</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid_to_cmd</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)}</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
            <span class="n">table_md</span> <span class="o">=</span> <span class="nf">make_status_markdown</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">width_limit</span><span class="o">=</span><span class="n">cmd_width_limit</span><span class="p">)</span>
            <span class="n">PromptServer</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="nf">send_sync</span><span class="p">(</span><span class="sh">"</span><span class="s">impact-node-feedback</span><span class="sh">"</span><span class="p">,</span>
                                            <span class="p">{</span><span class="sh">"</span><span class="s">node_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">node_id</span><span class="p">,</span> <span class="sh">"</span><span class="s">widget_name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">status_md</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">table_md</span><span class="p">})</span>

        <span class="c1"># 3) ì™„ë£Œê¹Œì§€ ëŒ€ê¸° + ì£¼ê¸°ì  UI ì—…ë°ì´íŠ¸
</span>        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">final_statuses</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">waited_sec</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">statuses</span> <span class="o">=</span> <span class="k">await</span> <span class="n">full_cache</span><span class="p">.</span><span class="nf">get_statuses</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">backend</span><span class="p">)</span>
            <span class="n">final_statuses</span> <span class="o">=</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="n">statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>

            <span class="c1"># (ì‹ ê·œ) ë¼ì´ë¸Œ ì—…ë°ì´íŠ¸
</span>            <span class="k">if</span> <span class="n">live_update</span> <span class="ow">and</span> <span class="n">node_id</span> <span class="ow">and</span> <span class="n">job_ids</span><span class="p">:</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="p">[{</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid</span><span class="p">,</span>
                         <span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="n">final_statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">N/A</span><span class="sh">"</span><span class="p">,</span>
                         <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid_to_cmd</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)}</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
                <span class="n">table_md</span> <span class="o">=</span> <span class="nf">make_status_markdown</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">width_limit</span><span class="o">=</span><span class="n">cmd_width_limit</span><span class="p">)</span>
                <span class="n">PromptServer</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="nf">send_sync</span><span class="p">(</span><span class="sh">"</span><span class="s">impact-node-feedback</span><span class="sh">"</span><span class="p">,</span>
                                                <span class="p">{</span><span class="sh">"</span><span class="s">node_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">node_id</span><span class="p">,</span> <span class="sh">"</span><span class="s">widget_name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">status_md</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">table_md</span><span class="p">})</span>

            <span class="k">if</span> <span class="nf">all</span><span class="p">((</span><span class="n">st</span> <span class="ow">in</span> <span class="n">TERMINAL_STATES</span><span class="p">)</span> <span class="ow">and</span> <span class="n">st</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">final_statuses</span><span class="p">.</span><span class="nf">values</span><span class="p">()):</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">max_wait_s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_wait_s</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">poll_interval_s</span><span class="p">)))</span>

        <span class="n">waited_sec</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
        <span class="n">completed_at</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
        <span class="n">all_done</span> <span class="o">=</span> <span class="nf">all</span><span class="p">((</span><span class="n">st</span> <span class="ow">in</span> <span class="n">TERMINAL_STATES</span><span class="p">)</span> <span class="ow">and</span> <span class="n">st</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">final_statuses</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>

        <span class="c1"># (ë‚˜ë¨¸ì§€ ê²°ê³¼ ì €ì¥/ë°˜í™˜ ë¡œì§ì€ ê¸°ì¡´ ê·¸ëŒ€ë¡œ)
</span>        <span class="c1"># ...
</span></code></pre></div></div>

<blockquote>
  <p>í¬ì¸íŠ¸</p>

  <ul>
    <li>
      <p><code class="language-plaintext highlighter-rouge">hidden</code>ì— <code class="language-plaintext highlighter-rouge">"UNIQUE_ID"</code> ì¶”ê°€ â†’ <code class="language-plaintext highlighter-rouge">run(..., node_id=...)</code>ë¡œ ë°›ì„ ìˆ˜ ìˆìŒ. ì„œë²„ì—ì„œ ì´ ê°’ì„ payloadì— ë‹´ì•„ ë³´ëƒ„. í”„ë¡ íŠ¸ëŠ” <code class="language-plaintext highlighter-rouge">node_id</code>ë¡œ í•´ë‹¹ ë…¸ë“œì˜ <code class="language-plaintext highlighter-rouge">status_md</code> ìœ„ì ¯ë§Œ ê°±ì‹ . <a href="https://docs.comfy.org/development/comfyui-server/comms_messages">ComfyUI</a></p>
    </li>
    <li>
      <p>ë©”ì‹œì§€ ë°œì‚¬ëŠ” <code class="language-plaintext highlighter-rouge">PromptServer.instance.send_sync(&lt;event&gt;, &lt;payload&gt;)</code> í˜•ì‹. (ì—¬ëŸ¬ ì»¤ìŠ¤í…€ ë…¸ë“œë“¤ì´ ì´ íŒ¨í„´ìœ¼ë¡œ ì‹¤ì‹œê°„ ìƒíƒœë¥¼ ë³´ë‚´ëŠ” ì‚¬ë¡€ ë‹¤ìˆ˜) <a href="https://huggingface.co/spaces/Freak-ppa/ioatol/blob/b162d43c5cd550b037fb83fa04cc6301339f36f4/ComfyUI/custom_nodes/cg-use-everywhere/use_everywhere.py?utm_source=chatgpt.com">Hugging Face+1</a></p>
    </li>
  </ul>

</blockquote>

<hr />

<h2 id="ê²°ê³¼-í™”ë©´-ì˜ˆì‹œ-string-ìœ„ì ¯-ë‚´ìš©">ê²°ê³¼ í™”ë©´ ì˜ˆì‹œ (String ìœ„ì ¯ ë‚´ìš©)</h2>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">|</span> <span class="no">JOB</span> <span class="no">ID</span> <span class="o">|</span> <span class="no">STATUS</span> <span class="o">|</span> <span class="no">COMMAND</span> <span class="o">|</span>
<span class="o">|------</span><span class="ss">:|</span><span class="p">:</span><span class="o">------</span><span class="ss">:|</span><span class="o">---------|</span>
<span class="o">|</span> <span class="sb">`124578`</span> <span class="o">|</span> <span class="sb">`RUN`</span> <span class="o">|</span> <span class="sb">`bsub -q short -J test1 sleep 5`</span> <span class="o">|</span>
<span class="o">|</span> <span class="sb">`124579`</span> <span class="o">|</span> <span class="sb">`PEND`</span> <span class="o">|</span> <span class="sb">`bsub -q short -J test2 sleep 8`</span> <span class="o">|</span>
<span class="o">|</span> <span class="sb">`124580`</span> <span class="o">|</span> <span class="sb">`DONE`</span> <span class="o">|</span> <span class="sb">`bsub -q short -J test3 sleep 2`</span> <span class="o">|</span>
</code></pre></div></div>

<ul>
  <li>ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸”ì„ â€œë Œë”ë§â€í•˜ì§€ëŠ” ì•Šì§€ë§Œ, <strong>ê°€ë…ì„± ë†’ì€ í…ìŠ¤íŠ¸ í‘œ</strong> ë¡œ ì˜ ë³´ì—¬ì¤˜. (String ìœ„ì ¯ì€ Markdown í•´ì„ì„ ì•ˆ í•˜ë¯€ë¡œ, í‘œ í…ìŠ¤íŠ¸ í˜•íƒœë¡œ ë³´ëŠ” ê°œë…)</li>
</ul>

<hr />

<h2 id="ì¶”ê°€-íŒ">ì¶”ê°€ íŒ</h2>

<ul>
  <li>
    <p><strong>ì—…ë°ì´íŠ¸ ë¹ˆë„(ìŠ¤íŒ¸ ë°©ì§€)</strong><br />
<code class="language-plaintext highlighter-rouge">poll_interval_s</code>ê°€ ë„ˆë¬´ ì‘ìœ¼ë©´ UIë„ ê·¸ë§Œí¼ ìì£¼ ê°±ì‹ ë¨. í•„ìš”í•˜ë©´ â€œë§ˆì§€ë§‰ ì†¡ì‹  ì‹œê°â€ì„ ì €ì¥í•´ <strong>1~2ì´ˆ ì“°ë¡œí‹€</strong> ì„ ì¶”ê°€í•´ë„ ì¢‹ìŒ.</p>
  </li>
  <li>
    <p><strong>ì—¬ëŸ¬ í´ë¼ì´ì–¸íŠ¸ íƒ­ ë™ì‹œ ì ‘ì†</strong><br />
íŠ¹ì • íƒ­ë§Œ ê°±ì‹ í•˜ê³  ì‹¶ë‹¤ë©´ <code class="language-plaintext highlighter-rouge">send_sync(..., sid=PromptServer.instance.client_id)</code>ë¡œ <strong>í˜„ì¬ í´ë¼ì´ì–¸íŠ¸ì—ë§Œ</strong> ë³´ë‚´ëŠ” íŒ¨í„´ë„ ìˆì–´. (ì—¬ëŸ¬ ì˜ˆì œ ë…¸ë“œê°€ ì´ ë°©ì‹ ì‚¬ìš©) <a href="https://gitee.com/failurejack/ComfyUI/blob/master/execution.py?utm_source=chatgpt.com">Gitee</a></p>
  </li>
  <li>
    <p><strong>ëª…ë ¹ì–´ ê¸¸ì´</strong><br />
<code class="language-plaintext highlighter-rouge">cmd_width_limit</code>ë¡œ ê¸´ ì»¤ë§¨ë“œë¥¼ ì¤„ì—¬ ë³´ì—¬ì¤Œ. í•„ìš”í•˜ë©´ íˆ´íŒ/ë³„ë„ ëŒ€ì‹œë³´ë“œë¡œ í™•ì¥ ê°€ëŠ¥.</p>
  </li>
</ul>

<hr />

<h2 id="ìš”ì•½-1">ìš”ì•½</h2>

<ul>
  <li>
    <p><strong>Q1</strong> : íŒŒì¼ ìºì‹œ + í”„ë¡œì„¸ìŠ¤ ë‚´ ì‹±ê¸€í†¤ ë©”ëª¨ë¦¬ ìºì‹œ(ì´ë¯¸ ë°˜ì˜)ë¡œ <strong>bjobs -a ê³¼ë‹¤ í˜¸ì¶œ ë°©ì§€</strong> ë° <strong>ë™ì‹œ ë…¸ë“œ ì•ˆì „</strong>.</p>
  </li>
  <li>
    <p><strong>Q2</strong> : <code class="language-plaintext highlighter-rouge">send_sync("impact-node-feedback", {...})</code> + <code class="language-plaintext highlighter-rouge">hidden UNIQUE_ID</code> + í‘œì‹œìš© <code class="language-plaintext highlighter-rouge">status_md</code> ìœ„ì ¯ìœ¼ë¡œ, <strong>ëŸ°íƒ€ì„ ë¼ì´ë¸Œ ìƒíƒœíŒ</strong> êµ¬í˜„ ì™„ë£Œ. (ê³µì‹ ë¬¸ì„œì˜ ì»¤ìŠ¤í…€ ë©”ì‹œì§€/ë…¸ë“œ id ì „ë‹¬ íŒ¨í„´ ì¤€ìˆ˜) <a href="https://docs.comfy.org/development/comfyui-server/comms_messages">ComfyUI</a></p>
  </li>
</ul>

<p>ì›í•˜ë©´ <strong>ì§„ì§œ Markdown ë Œë”</strong>(HTML íŒ¨ë„)ë‚˜ <strong>ì»¬ëŸ¬ ë±ƒì§€/ì•„ì´ì½˜</strong> , <strong>EXIT ì›ì¸/ì—ëŸ¬ ë¡œê·¸</strong> ì»¬ëŸ¼ë„ ë¶™ì—¬ì¤„ ìˆ˜ ìˆì–´.</p>

<p class="chat--user">

ì „ì²´ ì½”ë“œ ì •ë¦¬í•´ì„œ ë‹¤ì‹œ ì¨ì¤˜(íŒŒì´ì¬ ì½”ë“œë§Œ ì¨ì£¼ë©´ ë¼). ì „ì²´ì ìœ¼ë¡œ ì¢€ ê¸°ëŠ¥ì— ë¹„í•´ ì½”ë“œê°€ ë³µì¡í•œê²ƒ ê°™ì€ë° ìµœì í™”í•  ìˆ˜ ìˆëŠ” ë¶€ë¶„ì´ ìˆìœ¼ë©´ ìµœì í™”í•˜ë©´ ì¢‹ê² ì–´.

</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># File: custom_nodes/lsf_submit_and_wait.py
# Purpose: ComfyUI Async OUTPUT node to submit LSF jobs (bsub), poll with bjobs -a,
#          share a lightweight global cache across nodes/processes, and live-update
#          a String widget (markdown-like table) during runtime via PromptServer.
#
# Key features (lean &amp; optimized):
# - Async node (SUPPORTS_ASYNC=True), batch-limited parallel bsub submissions.
# - Single, simplified "full list" cache refreshed by `bjobs -a` only when needed:
#     * 2-tier cache: in-process memory snapshot + cross-process JSON file.
#     * TTL &amp; minimal refresh gap + non-blocking refresh lock -&gt; prevents bjobs storms.
#     * Immediate "SUBMITTED" seeding for newly created job IDs (corner case solved).
# - Runtime UI feedback: PromptServer.instance.send_sync("impact-node-feedback", â€¦)
#     * Updates a String widget named "status_md" with a compact markdown table.
#     * Throttled updates to avoid UI spam.
#
# Inputs:
#   - commands (STRING, multiline): multiple bsub lines. Optional inline directive:
#       # LSF: batch_size=4 poll_interval_s=10 full_ttl_s=15 min_refresh_gap_s=5
#       # LSF: ui_update_gap_s=1 max_wait_s=7200 full_status_cmd="bjobs -a -noheader -o \"jobid stat\""
#       (All keys optional; defaults are sensible.)
#   - cwd (STRING): working directory for submissions.
#   - status_md (STRING): display widget (auto-updated during run).
#   - cmd_width_limit (INT): truncate very long command strings in the table.
#   - live_update (BOOL): enable/disable live widget updates.
#   - hidden node_id (UNIQUE_ID): used to address the specific node widget.
#
# Outputs (OUTPUT node):
#   - job_ids (STRING): comma-separated list
#   - results_json (STRING): summary JSON (final status, timing, options, log file path)
#
# Minimal dependencies: Python stdlib + ComfyUI's PromptServer (bundled).
</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">shlex</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># ComfyUI server for live widget updates
</span><span class="kn">from</span> <span class="n">server</span> <span class="kn">import</span> <span class="n">PromptServer</span>  <span class="c1"># noqa
</span>
<span class="c1"># fcntl (POSIX) for file locks. If unavailable (e.g. Windows), degrade gracefully.
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">fcntl</span>  <span class="c1"># type: ignore
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover
</span>    <span class="n">fcntl</span> <span class="o">=</span> <span class="bp">None</span>

<span class="c1"># ---------------------------- Basic utils ----------------------------
</span>
<span class="n">JOB_ID_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
<span class="n">TERMINAL_STATES</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">DONE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">EXIT</span><span class="sh">"</span><span class="p">}</span>  <span class="c1"># Adjust if your cluster uses other terminal labels
</span>
<span class="k">def</span> <span class="nf">iso_now</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">utcnow</span><span class="p">().</span><span class="nf">isoformat</span><span class="p">(</span><span class="n">timespec</span><span class="o">=</span><span class="sh">"</span><span class="s">seconds</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">Z</span><span class="sh">"</span>

<span class="k">def</span> <span class="nf">default_cache_dir</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">COMFYUI_LSF_CACHE_DIR</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">tempfile</span><span class="p">.</span><span class="nf">gettempdir</span><span class="p">(),</span> <span class="sh">"</span><span class="s">comfyui_lsf_cache</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">path</span>

<span class="k">def</span> <span class="nf">_short</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">s</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">limit</span> <span class="nf">else </span><span class="p">(</span><span class="n">s</span><span class="p">[:</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">+</span> <span class="sh">"</span><span class="s">â€¦</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_inline_options_and_commands</span><span class="p">(</span><span class="n">commands_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Parse optional inline LSF options from leading lines:
      # LSF: key=value key=value ...
    Returns (options_dict, command_lines)
    </span><span class="sh">"""</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">raw_lines</span> <span class="o">=</span> <span class="n">commands_text</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">()</span>
    <span class="n">cmd_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">raw_lines</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">^\s*#\s*LSF:\s*(.+)$</span><span class="sh">"</span><span class="p">,</span> <span class="n">ln</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">kv</span> <span class="ow">in</span> <span class="n">shlex</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">posix</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
                <span class="k">if</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">kv</span><span class="p">:</span>
                    <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">kv</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">v_strip</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">v_strip</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">false</span><span class="sh">"</span><span class="p">):</span>
                        <span class="n">options</span><span class="p">[</span><span class="n">k</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="p">(</span><span class="n">v_strip</span> <span class="o">==</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">options</span><span class="p">[</span><span class="n">k</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                            <span class="n">options</span><span class="p">[</span><span class="n">k</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">continue</span>
        <span class="c1"># keep non-empty command lines, ignore other comments/empties
</span>        <span class="k">if</span> <span class="n">ln</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ln</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s"># LSF:</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">cmd_lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">ln</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">options</span><span class="p">,</span> <span class="n">cmd_lines</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_shell</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_shell</span><span class="p">(</span>
        <span class="n">cmd</span><span class="p">,</span>
        <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span> <span class="k">if</span> <span class="n">cwd</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">ignore</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">ignore</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">extract_job_ids_from_bsub_output</span><span class="p">(</span><span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="c1"># LSF standard: "Job &lt;12345&gt; is submitted to queue &lt;...&gt;."
</span>    <span class="k">return</span> <span class="n">JOB_ID_REGEX</span><span class="p">.</span><span class="nf">findall</span><span class="p">(</span><span class="n">stdout</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>

<span class="c1"># ---------------------------- LSF backend ----------------------------
</span>
<span class="k">class</span> <span class="nc">LSFBackend</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Minimal backend that fetches ONE full snapshot of job statuses via `bjobs -a`.</span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">full_status_cmd</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="c1"># default format: columns: jobid stat
</span>        <span class="n">self</span><span class="p">.</span><span class="n">full_status_cmd</span> <span class="o">=</span> <span class="n">full_status_cmd</span> <span class="ow">or</span> <span class="sh">'</span><span class="s">bjobs -a -noheader -o </span><span class="sh">"</span><span class="s">jobid stat</span><span class="sh">"'</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">full_snapshot</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_shell</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">full_status_cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">out</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">ln</span> <span class="o">=</span> <span class="n">ln</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ln</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">ln</span><span class="p">.</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">parts</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">upper</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span>
        <span class="k">return</span> <span class="n">result</span>

<span class="c1"># ---------------------------- Global cache (lean, 2-tier) ----------------------------
</span>
<span class="k">class</span> <span class="nc">LSFCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Lean 2-tier cache for job statuses (ALL jobs snapshot):
      - In-process memory snapshot (fast-path, avoids file I/O most of the time)
      - Cross-process JSON file snapshot (source of truth)
    Concurrency control:
      - Non-blocking refresh lock file ensures only one process runs `bjobs -a`
      - TTL + minimal refresh gap to throttle refreshes
    File structure:
      {
        </span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="s">: { </span><span class="sh">"</span><span class="s">&lt;jobid&gt;</span><span class="sh">"</span><span class="s">: {</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">RUN</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="s">: 169...}, ... },
        </span><span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="s">: { </span><span class="sh">"</span><span class="s">&lt;jobid&gt;</span><span class="sh">"</span><span class="s">: {</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">submitted_at</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">}, ... },
        </span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="s">: 169...,
        </span><span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="s">: { </span><span class="sh">"</span><span class="s">refreshed_at</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">2025-...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">ttl_or_miss</span><span class="sh">"</span><span class="s"> }
      }
    </span><span class="sh">"""</span>

    <span class="n">_mem_jobs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_mem_last_ts</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">_mem_lock</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>  <span class="c1"># protect _mem_jobs/_mem_last_ts
</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cache_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">full_ttl_s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">min_refresh_gap_s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span> <span class="o">=</span> <span class="n">cache_file</span>
        <span class="n">self</span><span class="p">.</span><span class="n">full_ttl_s</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">full_ttl_s</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">min_refresh_gap_s</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">min_refresh_gap_s</span><span class="p">)</span>
        <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">cache_file</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">cache_file</span><span class="p">):</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span> <span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span> <span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="n">f</span><span class="p">)</span>

    <span class="c1"># ---------- file lock helpers ----------
</span>    <span class="k">def</span> <span class="nf">_lock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">nonblock</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">a+</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fcntl</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fcntl</span><span class="p">.</span><span class="nf">flock</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">fcntl</span><span class="p">.</span><span class="n">LOCK_EX</span> <span class="o">|</span> <span class="p">(</span><span class="n">fcntl</span><span class="p">.</span><span class="n">LOCK_NB</span> <span class="k">if</span> <span class="n">nonblock</span> <span class="k">else</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">except</span> <span class="nb">BlockingIOError</span><span class="p">:</span>
                <span class="n">fh</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
                <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">fh</span>

    <span class="k">def</span> <span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fh</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">fcntl</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fcntl</span><span class="p">.</span><span class="nf">flock</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">fcntl</span><span class="p">.</span><span class="n">LOCK_UN</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fh</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="c1"># ---------- file I/O ----------
</span>    <span class="k">def</span> <span class="nf">_read_file</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span> <span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span> <span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="k">def</span> <span class="nf">_write_file_and_update_mem</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span> <span class="o">+</span> <span class="sh">"</span><span class="s">.tmp</span><span class="sh">"</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">)</span>
        <span class="c1"># keep memory in sync
</span>        <span class="nf">type</span><span class="p">(</span><span class="n">self</span><span class="p">).</span><span class="n">_mem_jobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
        <span class="nf">type</span><span class="p">(</span><span class="n">self</span><span class="p">).</span><span class="n">_mem_last_ts</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="c1"># ---------- public API ----------
</span>    <span class="k">def</span> <span class="nf">seed_submitted</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">meta</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Immediately make new job IDs visible as SUBMITTED (fresh) in both memory and file.
        Useful for the edge case where another node asks before bjobs snapshot contains them.
        </span><span class="sh">"""</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>

        <span class="c1"># Update memory (fast path)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_mem_jobs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem_jobs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_mem_jobs</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">SUBMITTED</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">now</span><span class="p">})</span>

        <span class="c1"># Merge into file (single short critical section)
</span>        <span class="n">fh</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_lock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_file</span><span class="p">()</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                <span class="n">jobs</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">SUBMITTED</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">now</span><span class="p">})</span>
            <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobs</span>
            <span class="k">if</span> <span class="n">meta</span><span class="p">:</span>
                <span class="n">jm</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">:</span>
                        <span class="n">jm</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span>
                <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">jm</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_write_file_and_update_mem</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_maybe_refresh</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">backend</span><span class="p">:</span> <span class="n">LSFBackend</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        Refresh the full snapshot if nobody else is doing it, and minimal gap is respected.
        Non-blocking: returns False if someone else just refreshed or lock couldn</span><span class="sh">'</span><span class="s">t be taken.
        </span><span class="sh">"""</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_file</span><span class="p">()</span>
        <span class="n">last_ts</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="nf">if </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_ts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">min_refresh_gap_s</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c1"># Take a non-blocking refresh lock
</span>        <span class="n">lock_fh</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_lock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span> <span class="o">+</span> <span class="sh">"</span><span class="s">.refresh.lock</span><span class="sh">"</span><span class="p">,</span> <span class="n">nonblock</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lock_fh</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Double-check gap again after taking the lock
</span>            <span class="n">data2</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_file</span><span class="p">()</span>
            <span class="n">last_ts2</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data2</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="nf">if </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_ts2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">min_refresh_gap_s</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="n">snapshot</span> <span class="o">=</span> <span class="k">await</span> <span class="n">backend</span><span class="p">.</span><span class="nf">full_snapshot</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">snapshot</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="n">now2</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_lock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_file</span><span class="p">()</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">now2</span>
                <span class="k">for</span> <span class="n">jid</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">snapshot</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
                    <span class="n">jobs</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="n">st</span><span class="p">,</span> <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span><span class="p">}</span>
                <span class="n">base</span><span class="p">[</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobs</span>
                <span class="n">base</span><span class="p">[</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">now2</span>
                <span class="n">meta</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">meta</span><span class="p">[</span><span class="sh">"</span><span class="s">refreshed_at</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
                <span class="n">meta</span><span class="p">[</span><span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">reason</span>
                <span class="n">base</span><span class="p">[</span><span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_write_file_and_update_mem</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">lock_fh</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_statuses</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">backend</span><span class="p">:</span> <span class="n">LSFBackend</span><span class="p">,</span> <span class="n">force_on_miss</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        Return statuses for the given job_ids using 2-tier cache:
          1) If in-memory snapshot is fresh -&gt; read from memory (no file I/O).
          2) Else read file once and update memory.
          3) If TTL expired or we miss any job_id (and force_on_miss=True),
             try a single non-blocking full refresh (bjobs -a) if the minimal gap elapsed.
        </span><span class="sh">"""</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="c1"># Stage 1: memory fast-path
</span>        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem_lock</span><span class="p">:</span>
            <span class="n">mem_is_fresh</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem_last_ts</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">full_ttl_s</span>
            <span class="k">if</span> <span class="n">mem_is_fresh</span><span class="p">:</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem_jobs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_file</span><span class="p">()</span>
                <span class="nf">type</span><span class="p">(</span><span class="n">self</span><span class="p">).</span><span class="n">_mem_jobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="nf">type</span><span class="p">(</span><span class="n">self</span><span class="p">).</span><span class="n">_mem_last_ts</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem_jobs</span>

        <span class="c1"># Helper: check if entry is fresh enough
</span>        <span class="k">def</span> <span class="nf">fresh</span><span class="p">(</span><span class="n">jid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">ent</span> <span class="o">=</span> <span class="n">jobs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ent</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="nf">return </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="nf">float</span><span class="p">(</span><span class="n">ent</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="o">&lt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">full_ttl_s</span>

        <span class="n">need_refresh</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mem_is_fresh</span><span class="p">:</span>
            <span class="n">need_refresh</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">force_on_miss</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nf">fresh</span><span class="p">(</span><span class="n">jid</span><span class="p">):</span>
                    <span class="n">need_refresh</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">break</span>

        <span class="k">if</span> <span class="n">need_refresh</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_maybe_refresh</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="sh">"</span><span class="s">ttl_or_miss</span><span class="sh">"</span><span class="p">)</span>
            <span class="c1"># Read from memory again (already updated if refresh happened)
</span>            <span class="n">jobs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem_jobs</span>

        <span class="k">return</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="n">jobs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>

<span class="c1"># ---------------------------- Submission &amp; waiting ----------------------------
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">submit_commands_multiline</span><span class="p">(</span><span class="n">commands</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Submit each line (bsub ...) as an independent command. Limit concurrency by batch_size.
    Returns (job_ids, submissions_detail)
    </span><span class="sh">"""</span>
    <span class="n">sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)))</span>
    <span class="n">submissions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_submit_one</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">sem</span><span class="p">:</span>
            <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_shell</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">)</span>
            <span class="n">jids</span> <span class="o">=</span> <span class="nf">extract_job_ids_from_bsub_output</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">cmd</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">out</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">err</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">jids</span><span class="p">,</span>
            <span class="p">}</span>

    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">_submit_one</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">as_completed</span><span class="p">(</span><span class="n">tasks</span><span class="p">):</span>
        <span class="n">submissions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="k">await</span> <span class="n">t</span><span class="p">)</span>
    <span class="n">job_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">jid</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])]</span>
    <span class="k">return</span> <span class="n">job_ids</span><span class="p">,</span> <span class="n">submissions</span>

<span class="k">def</span> <span class="nf">make_status_markdown</span><span class="p">(</span><span class="n">job_rows</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">width_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Build a compact markdown-like table: JOB ID | STATUS | COMMAND
    (String widget does not render markdown; table is for readability.)
    </span><span class="sh">"""</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">| JOB ID | STATUS | COMMAND |</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">|------:|:------:|---------|</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">job_rows</span><span class="p">:</span>
        <span class="n">jid</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="n">st</span>  <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nf">_short</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)),</span> <span class="n">width_limit</span><span class="p">)</span>
        <span class="n">lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">| `</span><span class="si">{</span><span class="n">jid</span><span class="si">}</span><span class="s">` | `</span><span class="si">{</span><span class="n">st</span><span class="si">}</span><span class="s">` | `</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s">` |</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

<span class="c1"># ---------------------------- ComfyUI Node ----------------------------
</span>
<span class="k">class</span> <span class="nc">LSFSubmitAndWait</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Async OUTPUT node that:
      - Submits multiple bsub jobs (batch-limited parallelism)
      - Polls statuses using a shared bjobs -a snapshot cache
      - Live-updates a String widget with JOB ID / STATUS / COMMAND
    </span><span class="sh">"""</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LSF</span><span class="sh">"</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span>
    <span class="n">OUTPUT_NODE</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">SUPPORTS_ASYNC</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">results_json</span><span class="sh">"</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">commands</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">bsub -q short -J test sleep 3</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">status_md</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span>
                    <span class="sh">"</span><span class="s">| JOB ID | STATUS | COMMAND |</span><span class="se">\n</span><span class="s">|------:|:------:|---------|</span><span class="se">\n</span><span class="s">(ì‹¤í–‰ ì¤‘ì— ê°±ì‹ ë©ë‹ˆë‹¤)</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">cmd_width_limit</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">INT</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="sh">"</span><span class="s">min</span><span class="sh">"</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span> <span class="sh">"</span><span class="s">max</span><span class="sh">"</span><span class="p">:</span> <span class="mi">200</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">live_update</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">BOOL</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">hidden</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="c1"># ComfyUI injects this; we'll use it to target the widget updates
</span>                <span class="sh">"</span><span class="s">node_id</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">UNIQUE_ID</span><span class="sh">"</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                  <span class="n">commands</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">status_md</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span>
                  <span class="n">cmd_width_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                  <span class="n">live_update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                  <span class="n">node_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>

        <span class="c1"># ---- 1) Parse inline options &amp; clean command lines ----
</span>        <span class="n">opts</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="nf">parse_inline_options_and_commands</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
        <span class="n">batch_size</span>         <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">batch_size</span><span class="sh">"</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">poll_interval_s</span>    <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">poll_interval_s</span><span class="sh">"</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">full_ttl_s</span>         <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">full_ttl_s</span><span class="sh">"</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>                <span class="c1"># snapshot TTL
</span>        <span class="n">min_refresh_gap_s</span>  <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">min_refresh_gap_s</span><span class="sh">"</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>           <span class="c1"># min gap between -a
</span>        <span class="n">full_status_cmd</span>    <span class="o">=</span> <span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">full_status_cmd</span><span class="sh">"</span><span class="p">,</span> <span class="sh">'</span><span class="s">bjobs -a -noheader -o </span><span class="sh">"</span><span class="s">jobid stat</span><span class="sh">"'</span><span class="p">)</span>
        <span class="n">max_wait_s</span>         <span class="o">=</span> <span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">max_wait_s</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">ui_update_gap_s</span>    <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ui_update_gap_s</span><span class="sh">"</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>         <span class="c1"># throttle UI pushes
</span>        <span class="n">force_on_miss</span>      <span class="o">=</span> <span class="nf">bool</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">force_refresh_on_miss</span><span class="sh">"</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span>

        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">max_wait_s</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">max_wait_s</span><span class="p">.</span><span class="nf">isdigit</span><span class="p">():</span>
            <span class="n">max_wait_s</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">max_wait_s</span><span class="p">)</span>

        <span class="c1"># Filter out accidental empty command lines
</span>        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">ln</span> <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">ln</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span>

        <span class="c1"># ---- 2) Submit jobs (async batch-limited) ----
</span>        <span class="n">submitted_at</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
        <span class="n">job_ids</span><span class="p">,</span> <span class="n">submissions</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">submit_commands_multiline</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>

        <span class="c1"># Map job_id -&gt; command (for UI &amp; logs)
</span>        <span class="n">jid_to_cmd</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">jid_to_cmd</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>

        <span class="c1"># ---- 3) Shared cache &amp; backend ----
</span>        <span class="n">cache_dir</span> <span class="o">=</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="nf">default_cache_dir</span><span class="p">())</span>
        <span class="n">cache_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">status_full_cache.json</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="nc">LSFCache</span><span class="p">(</span><span class="n">cache_file</span><span class="p">,</span> <span class="n">full_ttl_s</span><span class="o">=</span><span class="n">full_ttl_s</span><span class="p">,</span> <span class="n">min_refresh_gap_s</span><span class="o">=</span><span class="n">min_refresh_gap_s</span><span class="p">)</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="nc">LSFBackend</span><span class="p">(</span><span class="n">full_status_cmd</span><span class="o">=</span><span class="n">full_status_cmd</span><span class="p">)</span>

        <span class="c1"># Seed newly submitted jobs to handle "just-submitted not in cache yet" edge
</span>        <span class="k">if</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid_to_cmd</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">),</span> <span class="sh">"</span><span class="s">submitted_at</span><span class="sh">"</span><span class="p">:</span> <span class="n">submitted_at</span><span class="p">}</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>
            <span class="n">cache</span><span class="p">.</span><span class="nf">seed_submitted</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">)</span>

        <span class="c1"># ---- 4) Initial live update (SUBMITTED) ----
</span>        <span class="k">def</span> <span class="nf">push_ui</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">live_update</span> <span class="ow">and</span> <span class="n">node_id</span><span class="p">:</span>
                <span class="n">table</span> <span class="o">=</span> <span class="nf">make_status_markdown</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">width_limit</span><span class="o">=</span><span class="n">cmd_width_limit</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">PromptServer</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="nf">send_sync</span><span class="p">(</span>
                        <span class="sh">"</span><span class="s">impact-node-feedback</span><span class="sh">"</span><span class="p">,</span>
                        <span class="p">{</span><span class="sh">"</span><span class="s">node_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">node_id</span><span class="p">,</span> <span class="sh">"</span><span class="s">widget_name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">status_md</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">table</span><span class="p">}</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>  <span class="c1"># UI update failure should not impact job control
</span>
        <span class="k">if</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">init_rows</span> <span class="o">=</span> <span class="p">[{</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid</span><span class="p">,</span> <span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">SUBMITTED</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid_to_cmd</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)}</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
            <span class="nf">push_ui</span><span class="p">(</span><span class="n">init_rows</span><span class="p">)</span>

        <span class="c1"># ---- 5) Poll loop until all terminal or timeout ----
</span>        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">last_ui</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">final_statuses</span> <span class="o">=</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="sh">"</span><span class="s">SUBMITTED</span><span class="sh">"</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">statuses</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cache</span><span class="p">.</span><span class="nf">get_statuses</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">force_on_miss</span><span class="o">=</span><span class="n">force_on_miss</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                <span class="n">st</span> <span class="o">=</span> <span class="p">(</span><span class="n">statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span> <span class="ow">or</span> <span class="n">final_statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">upper</span><span class="p">()</span>
                <span class="n">final_statuses</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span> <span class="k">if</span> <span class="n">st</span> <span class="k">else</span> <span class="n">final_statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>

            <span class="c1"># Throttled live UI update
</span>            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="nf">if </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_ui</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ui_update_gap_s</span><span class="p">:</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="p">[{</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid</span><span class="p">,</span> <span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="n">final_statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">N/A</span><span class="sh">"</span><span class="p">,</span>
                         <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid_to_cmd</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)}</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
                <span class="nf">push_ui</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
                <span class="n">last_ui</span> <span class="o">=</span> <span class="n">now</span>

            <span class="c1"># All terminal?
</span>            <span class="k">if</span> <span class="n">job_ids</span> <span class="ow">and</span> <span class="nf">all</span><span class="p">((</span><span class="n">final_statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">in</span> <span class="n">TERMINAL_STATES</span><span class="p">)</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">):</span>
                <span class="k">break</span>

            <span class="c1"># Timeout?
</span>            <span class="k">if</span> <span class="n">max_wait_s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_wait_s</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">poll_interval_s</span><span class="p">)))</span>

        <span class="n">completed_at</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
        <span class="n">waited_sec</span> <span class="o">=</span> <span class="nf">round</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">all_done</span> <span class="o">=</span> <span class="p">(</span><span class="n">job_ids</span> <span class="ow">and</span> <span class="nf">all</span><span class="p">((</span><span class="n">final_statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">in</span> <span class="n">TERMINAL_STATES</span><span class="p">)</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">))</span>

        <span class="c1"># Final UI update (non-throttled, shows last state)
</span>        <span class="k">if</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[{</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid</span><span class="p">,</span> <span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="n">final_statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">N/A</span><span class="sh">"</span><span class="p">,</span>
                     <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid_to_cmd</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)}</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
            <span class="nf">push_ui</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

        <span class="c1"># ---- 6) Persist a concise run log (optional, handy for auditing) ----
</span>        <span class="n">results_dir</span> <span class="o">=</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">runs</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">session_tag</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">utcnow</span><span class="p">().</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%Y%m%d_%H%M%S</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="sh">"</span><span class="s">_</span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="nf">getpid</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">results_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">results_dir</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">result_</span><span class="si">{</span><span class="n">session_tag</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>

        <span class="n">failed_submissions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span>
            <span class="k">if</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">submitted_at</span><span class="sh">"</span><span class="p">:</span> <span class="n">submitted_at</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">completed_at</span><span class="sh">"</span><span class="p">:</span> <span class="n">completed_at</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">duration_sec</span><span class="sh">"</span><span class="p">:</span> <span class="n">waited_sec</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">job_ids</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">final_status</span><span class="sh">"</span><span class="p">:</span> <span class="n">final_statuses</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">all_done</span><span class="sh">"</span><span class="p">:</span> <span class="nf">bool</span><span class="p">(</span><span class="n">all_done</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">failed_submissions</span><span class="sh">"</span><span class="p">:</span> <span class="n">failed_submissions</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">:</span> <span class="n">cwd</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">options</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">batch_size</span><span class="sh">"</span><span class="p">:</span> <span class="n">batch_size</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">poll_interval_s</span><span class="sh">"</span><span class="p">:</span> <span class="n">poll_interval_s</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">full_ttl_s</span><span class="sh">"</span><span class="p">:</span> <span class="n">full_ttl_s</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">min_refresh_gap_s</span><span class="sh">"</span><span class="p">:</span> <span class="n">min_refresh_gap_s</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">full_status_cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">full_status_cmd</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">max_wait_s</span><span class="sh">"</span><span class="p">:</span> <span class="n">max_wait_s</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">ui_update_gap_s</span><span class="sh">"</span><span class="p">:</span> <span class="n">ui_update_gap_s</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">force_refresh_on_miss</span><span class="sh">"</span><span class="p">:</span> <span class="n">force_on_miss</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">results_file</span><span class="sh">"</span><span class="p">:</span> <span class="n">results_path</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">results_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># ---- 7) Return outputs ----
</span>        <span class="n">job_ids_str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>
        <span class="n">results_json_str</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">job_ids_str</span><span class="p">,</span> <span class="n">results_json_str</span><span class="p">)</span>

<span class="c1"># ---------------------------- Node registration ----------------------------
</span>
<span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LSFSubmitAndWait</span><span class="sh">"</span><span class="p">:</span> <span class="n">LSFSubmitAndWait</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LSFSubmitAndWait</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">LSF: Submit &amp; Wait</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p class="chat--user">

ê·¼ë° # LSF: key=value ì´ê²Œ ë­ì•¼? ì´ê²Œ officialí•œ ë™ì‘ì´ì•¼?

</p>

<p>ì§§ê²Œ ê²°ë¡ ë¶€í„°ìš”:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge"># LSF: key=value</code>ëŠ” <strong>ì œê°€ ë§Œë“  â€œì¸ë¼ì¸ ì„¤ì • ì£¼ì„â€ ê·œì•½</strong> ì´ì—ìš”.<br />
<strong>ComfyUI ê³µì‹ ê¸°ëŠ¥ë„ ì•„ë‹ˆê³ , LSF ê³µì‹ ë¬¸ë²•ë„ ì•„ë‹™ë‹ˆë‹¤.</strong><br />
ìš°ë¦¬ ë…¸ë“œê°€ ê·¸ ì¤„ì„ ì½ì–´ ì˜µì…˜ìœ¼ë¡œ í•´ì„í•œ ë’¤, <strong>ì‹¤ì œ ì‹¤í–‰ ëª…ë ¹ì—ì„œëŠ” ì œê±°</strong> í•©ë‹ˆë‹¤. (ì‰˜ì— í˜ëŸ¬ê°€ì§€ ì•ŠìŒ)</li>
</ul>

<p>step-by-stepë¡œ ì •ë¦¬í•˜ë©´:</p>

<ol>
  <li>
    <p>ì™œ ë„£ì—ˆë‚˜?</p>

    <ul>
      <li>
        <p>ì…ë ¥ì„ <code class="language-plaintext highlighter-rouge">commands</code>/<code class="language-plaintext highlighter-rouge">cwd</code> ë‘ ê°œë¡œ ë‹¨ìˆœí™”í•˜ë©´ì„œë„ ë°°ì¹˜ í¬ê¸°, í´ë§ ì£¼ê¸° ê°™ì€ <strong>ì„¸ë¶€ ì˜µì…˜ì„ í…ìŠ¤íŠ¸ë§Œìœ¼ë¡œ</strong> ì¡°ì •í•˜ë ¤ê³  ë„£ì€ <strong>í¸ì˜ìš©</strong> ì…ë‹ˆë‹¤.</p>
      </li>
      <li>
        <p>ì›Œí¬í”Œë¡œ ê³µìœ /ë³µë¶™ ì‹œ ì„¤ì •ì´ ê°™ì´ ë”°ë¼ê°€ì„œ ì¬í˜„ì„±ì´ ì¢‹ì•„ìš”.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>ì•ˆì „í•œê°€?</p>

    <ul>
      <li>
        <p>ê·¸ ì¤„ì€ <strong>ëª…ë ¹ìœ¼ë¡œ ì‹¤í–‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</strong> íŒŒì„œê°€ <code class="language-plaintext highlighter-rouge"># LSF:</code>ë¡œ ì‹œì‘í•˜ëŠ” ì¤„ë§Œ ì˜µì…˜ìœ¼ë¡œ ì½ê³ , ì‹¤ì œ <code class="language-plaintext highlighter-rouge">bsub</code> ì œì¶œ ëª©ë¡ì—ì„  ì œì™¸í•©ë‹ˆë‹¤.</p>
      </li>
      <li>
        <p>í˜¹ì‹œ ê·¸ëŒ€ë¡œ ì‰˜ ìŠ¤í¬ë¦½íŠ¸ì— ë¶™ì—¬ë„ <code class="language-plaintext highlighter-rouge">#</code>ëŠ” ì£¼ì„ì´ë¼ ë¶€ì‘ìš©ì€ ì—†ìŠµë‹ˆë‹¤.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>â€œê³µì‹â€ì„ ì›í•˜ë©´? (ê¶Œì¥ ëŒ€ì•ˆ)</p>

    <ul>
      <li>
        <p><strong>ComfyUI ë°©ì‹</strong> ì€ ê° ì˜µì…˜ì„ <strong>ìœ„ì ¯(ì˜µì…˜ ì…ë ¥ê°’)</strong> ìœ¼ë¡œ ë…¸ì¶œí•˜ëŠ” ê²ë‹ˆë‹¤.</p>
      </li>
      <li>
        <p>ì´ë¯¸ ì œê³µí•œ ì½”ë“œì—” <code class="language-plaintext highlighter-rouge">status_md</code>, <code class="language-plaintext highlighter-rouge">cmd_width_limit</code>, <code class="language-plaintext highlighter-rouge">live_update</code>ì²˜ëŸ¼ <strong>optional ìœ„ì ¯</strong> ì„ ì“°ê³  ìˆì–´ìš”. ì›í•˜ì‹œë©´ <code class="language-plaintext highlighter-rouge">batch_size</code>, <code class="language-plaintext highlighter-rouge">poll_interval_s</code>, <code class="language-plaintext highlighter-rouge">full_ttl_s</code>, <code class="language-plaintext highlighter-rouge">min_refresh_gap_s</code>, <code class="language-plaintext highlighter-rouge">ui_update_gap_s</code>, <code class="language-plaintext highlighter-rouge">full_status_cmd</code>, <code class="language-plaintext highlighter-rouge">max_wait_s</code>, <code class="language-plaintext highlighter-rouge">force_refresh_on_miss</code>ë„ ì „ë¶€ ìœ„ì ¯í™”í•˜ë©´ ë©ë‹ˆë‹¤.</p>
      </li>
      <li>
        <p>ìš°ì„ ìˆœìœ„ë„ ê¹”ë”íˆ ì •í•  ìˆ˜ ìˆì–´ìš”: <strong>ìœ„ì ¯ ê°’ &gt; ì¸ë¼ì¸ ì£¼ì„ &gt; ë””í´íŠ¸</strong>. (í˜¹ì€ ì¸ë¼ì¸ì„ ì™„ì „íˆ ì œê±°)</p>
      </li>
    </ul>
  </li>
</ol>

<p>ì›í•˜ë©´ ì¸ë¼ì¸ íŒŒì„œë¥¼ ì œê±°í•˜ê³  <strong>ìœ„ì ¯ë§Œ ì“°ëŠ”</strong> ê°„ë‹¨ íŒ¨ì¹˜ ìŠ¤ë‹ˆí«ë„ ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

êµ³ì´ ì´ê±¸ ë‹¤ ì˜µì…˜ìœ¼ë¡œ í•˜ì§€ë§ê³  ìµœì ê°’ìœ¼ë¡œ ìƒë‹¨ì— CONSTANTë¡œ ì²˜ë¦¬í•˜ì. 

</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># File: custom_nodes/lsf_submit_and_wait.py
# Purpose: ComfyUI Async OUTPUT node to submit LSF bsub jobs, poll with `bjobs -a`,
#          share a lightweight global cache, and live-update a String widget
#          using PromptServer during runtime.
#
# NOTE: ëª¨ë“  ë™ì‘ íŒŒë¼ë¯¸í„°ëŠ” ì•„ë˜ CONSTANTS ë¡œ ê³ ì • (ì˜µì…˜/ì¸ë¼ì¸ íŒŒì‹± ì—†ìŒ)
</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">from</span> <span class="n">server</span> <span class="kn">import</span> <span class="n">PromptServer</span>  <span class="c1"># ComfyUI runtime UI updates
</span>
<span class="c1"># ---------------------------- CONSTANTS (Tweak here) ----------------------------
</span>
<span class="c1"># Submission / polling behavior
</span><span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">4</span>                      <span class="c1"># ë™ì‹œì— ì œì¶œí•  bsub ê°œìˆ˜(ì„¸ë§ˆí¬ì–´)
</span><span class="n">POLL_INTERVAL_S</span> <span class="o">=</span> <span class="mi">10</span>                <span class="c1"># í´ë§ ì£¼ê¸°(ì´ˆ)
</span><span class="n">MAX_WAIT_S</span> <span class="o">=</span> <span class="bp">None</span>                   <span class="c1"># ì „ì²´ ëŒ€ê¸° íƒ€ì„ì•„ì›ƒ(ì´ˆ) - Noneì´ë©´ ë¬´ì œí•œ
</span>
<span class="c1"># Cache behavior
</span><span class="n">FULL_TTL_S</span> <span class="o">=</span> <span class="mi">10</span>                     <span class="c1"># ì „ì²´ ìŠ¤ëƒ…ìƒ·(ë©”ëª¨ë¦¬/íŒŒì¼) TTL(ì´ˆ)
</span><span class="n">MIN_REFRESH_GAP_S</span> <span class="o">=</span> <span class="mi">5</span>               <span class="c1"># bjobs -a ì¬í˜¸ì¶œ ìµœì†Œ ê°„ê²©(ì´ˆ)
</span><span class="n">FORCE_REFRESH_ON_MISS</span> <span class="o">=</span> <span class="bp">True</span>        <span class="c1"># ìºì‹œ ë¯¸ìŠ¤ ì‹œ TTL ë¬´ì‹œí•˜ê³  ì¡°ê¸° ë¦¬í”„ë ˆì‹œ ì‹œë„(ê°„ê²©ì€ ì¤€ìˆ˜)
</span>
<span class="c1"># bjobs -a ëª…ë ¹ í…œí”Œë¦¿ (jobid stat ë‘ ì»¬ëŸ¼ì„ ê¸°ëŒ€)
</span><span class="n">FULL_STATUS_CMD</span> <span class="o">=</span> <span class="sh">'</span><span class="s">bjobs -a -noheader -o </span><span class="sh">"</span><span class="s">jobid stat</span><span class="sh">"'</span>

<span class="c1"># Live UI feedback (String ìœ„ì ¯)
</span><span class="n">UI_UPDATE_GAP_S</span> <span class="o">=</span> <span class="mf">1.0</span>               <span class="c1"># UI ì—…ë°ì´íŠ¸ ì“°ë¡œí‹€ ê°„ê²©(ì´ˆ)
</span><span class="n">CMD_WIDTH_LIMIT</span> <span class="o">=</span> <span class="mi">100</span>               <span class="c1"># COMMAND ì—´ í‘œì‹œ ê¸¸ì´ ì œí•œ
</span>
<span class="c1"># Terminal states for LSF
</span><span class="n">TERMINAL_STATES</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">DONE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">EXIT</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># Cache file name (under /tmp or $COMFYUI_LSF_CACHE_DIR)
</span><span class="n">CACHE_FILENAME</span> <span class="o">=</span> <span class="sh">"</span><span class="s">status_full_cache.json</span><span class="sh">"</span>

<span class="c1"># ---------------------------- Utilities ----------------------------
</span>
<span class="n">JOB_ID_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">iso_now</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">utcnow</span><span class="p">().</span><span class="nf">isoformat</span><span class="p">(</span><span class="n">timespec</span><span class="o">=</span><span class="sh">"</span><span class="s">seconds</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">Z</span><span class="sh">"</span>

<span class="k">def</span> <span class="nf">default_cache_dir</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">COMFYUI_LSF_CACHE_DIR</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">tempfile</span><span class="p">.</span><span class="nf">gettempdir</span><span class="p">(),</span> <span class="sh">"</span><span class="s">comfyui_lsf_cache</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">path</span>

<span class="k">def</span> <span class="nf">_short</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">s</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">limit</span> <span class="nf">else </span><span class="p">(</span><span class="n">s</span><span class="p">[:</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">+</span> <span class="sh">"</span><span class="s">â€¦</span><span class="sh">"</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_shell</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_shell</span><span class="p">(</span>
        <span class="n">cmd</span><span class="p">,</span>
        <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span> <span class="k">if</span> <span class="n">cwd</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">ignore</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">ignore</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">extract_job_ids_from_bsub_output</span><span class="p">(</span><span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="c1"># LSF í‘œì¤€: "Job &lt;12345&gt; is submitted to queue &lt;...&gt;."
</span>    <span class="k">return</span> <span class="n">JOB_ID_REGEX</span><span class="p">.</span><span class="nf">findall</span><span class="p">(</span><span class="n">stdout</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">make_status_markdown</span><span class="p">(</span><span class="n">job_rows</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">width_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">CMD_WIDTH_LIMIT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">JOB ID | STATUS | COMMAND í‘œ í…ìŠ¤íŠ¸(ê°€ë…ì„± ìš©).</span><span class="sh">"""</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">| JOB ID | STATUS | COMMAND |</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">|------:|:------:|---------|</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">job_rows</span><span class="p">:</span>
        <span class="n">jid</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="n">st</span>  <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nf">_short</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)),</span> <span class="n">width_limit</span><span class="p">)</span>
        <span class="n">lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">| `</span><span class="si">{</span><span class="n">jid</span><span class="si">}</span><span class="s">` | `</span><span class="si">{</span><span class="n">st</span><span class="si">}</span><span class="s">` | `</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s">` |</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

<span class="c1"># ---------------------------- fcntl lock (POSIX best-effort) ----------------------------
</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">fcntl</span>  <span class="c1"># type: ignore
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">fcntl</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># Windows ë“±ì—ì„œëŠ” ë½ ì—†ì´ë„ ë™ì‘(ê²½ìŸ ê°€ëŠ¥ì„± ê°ìˆ˜)
</span>
<span class="k">def</span> <span class="nf">_lock_fd</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">nonblock</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
    <span class="n">fh</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">a+</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fcntl</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fcntl</span><span class="p">.</span><span class="nf">flock</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">fcntl</span><span class="p">.</span><span class="n">LOCK_EX</span> <span class="o">|</span> <span class="p">(</span><span class="n">fcntl</span><span class="p">.</span><span class="n">LOCK_NB</span> <span class="k">if</span> <span class="n">nonblock</span> <span class="k">else</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">except</span> <span class="nb">BlockingIOError</span><span class="p">:</span>
            <span class="n">fh</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">fh</span>

<span class="k">def</span> <span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fh</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">fcntl</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fcntl</span><span class="p">.</span><span class="nf">flock</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">fcntl</span><span class="p">.</span><span class="n">LOCK_UN</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fh</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="c1"># ---------------------------- LSF backend ----------------------------
</span>
<span class="k">class</span> <span class="nc">LSFBackend</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">`bjobs -a` ì „ì²´ ìŠ¤ëƒ…ìƒ·ì„ í•œ ë²ˆì— ê°€ì ¸ì˜¤ëŠ” ìµœì†Œ ë°±ì—”ë“œ.</span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">full_status_cmd</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">FULL_STATUS_CMD</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">full_status_cmd</span> <span class="o">=</span> <span class="n">full_status_cmd</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">full_snapshot</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_shell</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">full_status_cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">out</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">ln</span> <span class="o">=</span> <span class="n">ln</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ln</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">ln</span><span class="p">.</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">parts</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">upper</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span>
        <span class="k">return</span> <span class="n">result</span>

<span class="c1"># ---------------------------- Lightweight 2-tier cache ----------------------------
</span>
<span class="k">class</span> <span class="nc">LSFCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - In-process memory snapshot (fast-path, ëŒ€ë¶€ë¶„ íŒŒì¼ I/O íšŒí”¼)
    - Cross-process JSON file snapshot (ì†ŒìŠ¤ ì˜¤ë¸Œ íŠ¸ë£¨ìŠ¤)
    - TTL + ìµœì†Œ ê°„ê²© + refresh ë½ìœ¼ë¡œ bjobs -a í­ì£¼ ë°©ì§€
    íŒŒì¼ êµ¬ì¡°:
      {
        </span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="s">: { </span><span class="sh">"</span><span class="s">&lt;jobid&gt;</span><span class="sh">"</span><span class="s">: {</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">RUN</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="s">: 169...}, ... },
        </span><span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="s">: { </span><span class="sh">"</span><span class="s">&lt;jobid&gt;</span><span class="sh">"</span><span class="s">: {</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">submitted_at</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">}, ... },
        </span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="s">: 169...,
        </span><span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="s">: { </span><span class="sh">"</span><span class="s">refreshed_at</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">ttl_or_miss</span><span class="sh">"</span><span class="s"> }
      }
    </span><span class="sh">"""</span>

    <span class="n">_mem_jobs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_mem_last_ts</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">_mem_lock</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cache_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span> <span class="o">=</span> <span class="n">cache_file</span>
        <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">cache_file</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">cache_file</span><span class="p">):</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span> <span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span> <span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="n">f</span><span class="p">)</span>

    <span class="c1"># file I/O helpers
</span>    <span class="k">def</span> <span class="nf">_read_file</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span> <span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span> <span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="k">def</span> <span class="nf">_write_file_and_update_mem</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span> <span class="o">+</span> <span class="sh">"</span><span class="s">.tmp</span><span class="sh">"</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">)</span>
        <span class="nf">type</span><span class="p">(</span><span class="n">self</span><span class="p">).</span><span class="n">_mem_jobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
        <span class="nf">type</span><span class="p">(</span><span class="n">self</span><span class="p">).</span><span class="n">_mem_last_ts</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="c1"># public API
</span>    <span class="k">def</span> <span class="nf">seed_submitted</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">meta</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">ë°©ê¸ˆ ì œì¶œí•œ ì¡ì„ SUBMITTEDë¡œ ì¦‰ì‹œ ìºì‹œì— ë°˜ì˜(ë©”ëª¨ë¦¬+íŒŒì¼).</span><span class="sh">"""</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="c1"># memory
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_mem_jobs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem_jobs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_mem_jobs</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">SUBMITTED</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">now</span><span class="p">})</span>
        <span class="c1"># file
</span>        <span class="n">fh</span> <span class="o">=</span> <span class="nf">_lock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_file</span><span class="p">()</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                <span class="n">jobs</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">SUBMITTED</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">now</span><span class="p">})</span>
            <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobs</span>
            <span class="k">if</span> <span class="n">meta</span><span class="p">:</span>
                <span class="n">jm</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">:</span>
                        <span class="n">jm</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span>
                <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">jm</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_write_file_and_update_mem</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_maybe_refresh</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">backend</span><span class="p">:</span> <span class="n">LSFBackend</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">TTL ë˜ëŠ” missë¡œ ì „ì²´ ìŠ¤ëƒ…ìƒ· ê°±ì‹ ì´ í•„ìš”í•  ë•Œ, í•œ í”„ë¡œì„¸ìŠ¤ë§Œ non-blocking ë½ìœ¼ë¡œ ì‹¤ì œ ì‹¤í–‰.</span><span class="sh">"""</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_file</span><span class="p">()</span>
        <span class="n">last_ts</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="nf">if </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_ts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MIN_REFRESH_GAP_S</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="n">lock_fh</span> <span class="o">=</span> <span class="nf">_lock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span> <span class="o">+</span> <span class="sh">"</span><span class="s">.refresh.lock</span><span class="sh">"</span><span class="p">,</span> <span class="n">nonblock</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lock_fh</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">data2</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_file</span><span class="p">()</span>
            <span class="n">last_ts2</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data2</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="nf">if </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_ts2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MIN_REFRESH_GAP_S</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="n">snapshot</span> <span class="o">=</span> <span class="k">await</span> <span class="n">backend</span><span class="p">.</span><span class="nf">full_snapshot</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">snapshot</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="n">now2</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="nf">_lock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_file</span><span class="p">()</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">for</span> <span class="n">jid</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">snapshot</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
                    <span class="n">jobs</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="n">st</span><span class="p">,</span> <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">now2</span><span class="p">}</span>
                <span class="n">base</span><span class="p">[</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobs</span>
                <span class="n">base</span><span class="p">[</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">now2</span>
                <span class="n">meta</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">meta</span><span class="p">[</span><span class="sh">"</span><span class="s">refreshed_at</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
                <span class="n">meta</span><span class="p">[</span><span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">reason</span>
                <span class="n">base</span><span class="p">[</span><span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_write_file_and_update_mem</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">lock_fh</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_statuses</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">backend</span><span class="p">:</span> <span class="n">LSFBackend</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">2-ê³„ì¸µ ìºì‹œ ì „ëµìœ¼ë¡œ ìš”ì²­ job_idsì˜ ìƒíƒœë¥¼ ë°˜í™˜.</span><span class="sh">"""</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="c1"># 1) ë©”ëª¨ë¦¬ íŒ¨ìŠ¤íŠ¸íŒ¨ìŠ¤
</span>        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem_lock</span><span class="p">:</span>
            <span class="n">mem_is_fresh</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem_last_ts</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">FULL_TTL_S</span>
            <span class="k">if</span> <span class="n">mem_is_fresh</span><span class="p">:</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem_jobs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_file</span><span class="p">()</span>
                <span class="nf">type</span><span class="p">(</span><span class="n">self</span><span class="p">).</span><span class="n">_mem_jobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="nf">type</span><span class="p">(</span><span class="n">self</span><span class="p">).</span><span class="n">_mem_last_ts</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem_jobs</span>

        <span class="k">def</span> <span class="nf">fresh</span><span class="p">(</span><span class="n">jid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">ent</span> <span class="o">=</span> <span class="n">jobs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ent</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="nf">return </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="nf">float</span><span class="p">(</span><span class="n">ent</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="o">&lt;=</span> <span class="n">FULL_TTL_S</span>

        <span class="n">need_refresh</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">mem_is_fresh</span>
        <span class="k">if</span> <span class="n">FORCE_REFRESH_ON_MISS</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nf">fresh</span><span class="p">(</span><span class="n">jid</span><span class="p">):</span>
                    <span class="n">need_refresh</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">break</span>

        <span class="k">if</span> <span class="n">need_refresh</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_maybe_refresh</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="sh">"</span><span class="s">ttl_or_miss</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem_jobs</span>  <span class="c1"># refresh í›„ ë©”ëª¨ë¦¬ì—ì„œ ì¬ì¡°íšŒ
</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="n">jobs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>

<span class="c1"># ---------------------------- Submission &amp; waiting ----------------------------
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">submit_commands_multiline</span><span class="p">(</span><span class="n">commands</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    ê° ì¤„ì„ ë…ë¦½ bsub ëª…ë ¹ìœ¼ë¡œ ì œì¶œ. ë™ì‹œ ì œì¶œ ê°œìˆ˜ëŠ” BATCH_SIZEë¡œ ì œí•œ.
    Returns (job_ids, submissions_detail)
    </span><span class="sh">"""</span>
    <span class="n">sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">)))</span>
    <span class="n">submissions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_submit_one</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">sem</span><span class="p">:</span>
            <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_shell</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">)</span>
            <span class="n">jids</span> <span class="o">=</span> <span class="nf">extract_job_ids_from_bsub_output</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">cmd</span><span class="p">,</span> <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">out</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">err</span><span class="p">,</span> <span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">jids</span><span class="p">}</span>

    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">_submit_one</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">as_completed</span><span class="p">(</span><span class="n">tasks</span><span class="p">):</span>
        <span class="n">submissions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="k">await</span> <span class="n">t</span><span class="p">)</span>

    <span class="n">job_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">jid</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])]</span>
    <span class="k">return</span> <span class="n">job_ids</span><span class="p">,</span> <span class="n">submissions</span>

<span class="c1"># ---------------------------- ComfyUI Node ----------------------------
</span>
<span class="k">class</span> <span class="nc">LSFSubmitAndWait</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Async OUTPUT node:
      - ë©€í‹°ë¼ì¸ bsub ì œì¶œ (ë°°ì¹˜ ì œí•œ ë³‘ë ¬)
      - bjobs -a ê¸°ë°˜ ì „ì—­ ìºì‹œ í´ë§ (ë‹¤ì¤‘ ë…¸ë“œ/í”„ë¡œì„¸ìŠ¤ ê³µìœ )
      - ì‹¤í–‰ ì¤‘ String ìœ„ì ¯(status_md)ì— JOB/STATUS/COMMAND í‘œë¥¼ ì§€ì† ê°±ì‹ 
    </span><span class="sh">"""</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LSF</span><span class="sh">"</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span>
    <span class="n">OUTPUT_NODE</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">SUPPORTS_ASYNC</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">results_json</span><span class="sh">"</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">commands</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">bsub -q short -J demo sleep 3</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="c1"># í‘œì‹œ ì „ìš©(ê°’ì€ ëŸ°íƒ€ì„ì— ì„œë²„ê°€ ê°±ì‹ )
</span>                <span class="sh">"</span><span class="s">status_md</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span>
                    <span class="sh">"</span><span class="s">| JOB ID | STATUS | COMMAND |</span><span class="se">\n</span><span class="s">|------:|:------:|---------|</span><span class="se">\n</span><span class="s">(ì‹¤í–‰ ì¤‘ì— ê°±ì‹ ë©ë‹ˆë‹¤)</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">hidden</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="c1"># ComfyUIê°€ ì£¼ì…í•˜ëŠ” ìœ ë‹ˆí¬ ë…¸ë“œ id. ìœ„ì ¯ ê°±ì‹  íƒ€ê²ŸíŒ…ì— ì‚¬ìš©.
</span>                <span class="sh">"</span><span class="s">node_id</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">UNIQUE_ID</span><span class="sh">"</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">commands</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">status_md</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="n">node_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="c1"># 0) ì…ë ¥ ì»¤ë§¨ë“œ ì •ë¦¬(ë¹ˆ ì¤„/ì£¼ì„ ì œê±°)
</span>        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="p">(</span><span class="n">commands</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">ln</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">#</span><span class="sh">"</span><span class="p">):</span>   <span class="c1"># ì‚¬ìš©ìê°€ ë„£ì€ ì¼ë°˜ ì£¼ì„ì€ ë¬´ì‹œ
</span>                <span class="k">continue</span>
            <span class="n">lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">ln</span><span class="p">)</span>

        <span class="c1"># 1) ì œì¶œ
</span>        <span class="n">submitted_at</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
        <span class="n">job_ids</span><span class="p">,</span> <span class="n">submissions</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">submit_commands_multiline</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">)</span>

        <span class="c1"># 2) job_id -&gt; cmd ë§¤í•‘ (UI/ë¡œê·¸ìš©)
</span>        <span class="n">jid_to_cmd</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">jid_to_cmd</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>

        <span class="c1"># 3) ì „ì—­ ìºì‹œ &amp; ë°±ì—”ë“œ
</span>        <span class="n">cache_dir</span> <span class="o">=</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="nf">default_cache_dir</span><span class="p">())</span>
        <span class="n">cache_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">CACHE_FILENAME</span><span class="p">)</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="nc">LSFCache</span><span class="p">(</span><span class="n">cache_file</span><span class="p">)</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="nc">LSFBackend</span><span class="p">(</span><span class="n">FULL_STATUS_CMD</span><span class="p">)</span>

        <span class="c1"># 3-1) ì œì¶œ ì§í›„ ìºì‹œ ì‹œë“œ(ì½”ë„ˆ ì¼€ì´ìŠ¤ ì™„í™”)
</span>        <span class="k">if</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid_to_cmd</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">),</span> <span class="sh">"</span><span class="s">submitted_at</span><span class="sh">"</span><span class="p">:</span> <span class="n">submitted_at</span><span class="p">}</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>
            <span class="n">cache</span><span class="p">.</span><span class="nf">seed_submitted</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">)</span>

        <span class="c1"># 4) ì´ˆê¸° UI ì—…ë°ì´íŠ¸ (SUBMITTED)
</span>        <span class="k">def</span> <span class="nf">push_ui</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node_id</span><span class="p">:</span>
                <span class="n">table</span> <span class="o">=</span> <span class="nf">make_status_markdown</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">PromptServer</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="nf">send_sync</span><span class="p">(</span>
                        <span class="sh">"</span><span class="s">impact-node-feedback</span><span class="sh">"</span><span class="p">,</span>
                        <span class="p">{</span><span class="sh">"</span><span class="s">node_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">node_id</span><span class="p">,</span> <span class="sh">"</span><span class="s">widget_name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">status_md</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">table</span><span class="p">}</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>  <span class="c1"># UI ì‹¤íŒ¨ëŠ” ì»¨íŠ¸ë¡¤ ë¡œì§ì— ì˜í–¥ ì—†ìŒ
</span>
        <span class="k">if</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">init_rows</span> <span class="o">=</span> <span class="p">[{</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid</span><span class="p">,</span> <span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">SUBMITTED</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid_to_cmd</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)}</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
            <span class="nf">push_ui</span><span class="p">(</span><span class="n">init_rows</span><span class="p">)</span>

        <span class="c1"># 5) ì™„ë£Œê¹Œì§€ í´ë§(ì£¼ê¸°ì  UI ê°±ì‹ )
</span>        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">last_ui</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">final_statuses</span> <span class="o">=</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="sh">"</span><span class="s">SUBMITTED</span><span class="sh">"</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">statuses</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cache</span><span class="p">.</span><span class="nf">get_statuses</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">backend</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                <span class="n">st</span> <span class="o">=</span> <span class="p">(</span><span class="n">statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span> <span class="ow">or</span> <span class="n">final_statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">upper</span><span class="p">()</span>
                <span class="n">final_statuses</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span> <span class="k">if</span> <span class="n">st</span> <span class="k">else</span> <span class="n">final_statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>

            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="nf">if </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_ui</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">UI_UPDATE_GAP_S</span><span class="p">:</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="p">[{</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid</span><span class="p">,</span> <span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="n">final_statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">N/A</span><span class="sh">"</span><span class="p">,</span>
                         <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid_to_cmd</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)}</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
                <span class="nf">push_ui</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
                <span class="n">last_ui</span> <span class="o">=</span> <span class="n">now</span>

            <span class="k">if</span> <span class="n">job_ids</span> <span class="ow">and</span> <span class="nf">all</span><span class="p">((</span><span class="n">final_statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">in</span> <span class="n">TERMINAL_STATES</span><span class="p">)</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">):</span>
                <span class="k">break</span>

            <span class="nf">if </span><span class="p">(</span><span class="n">MAX_WAIT_S</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">now</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MAX_WAIT_S</span><span class="p">):</span>
                <span class="k">break</span>

            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">POLL_INTERVAL_S</span><span class="p">)))</span>

        <span class="n">completed_at</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
        <span class="n">duration_sec</span> <span class="o">=</span> <span class="nf">round</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">all_done</span> <span class="o">=</span> <span class="p">(</span><span class="n">job_ids</span> <span class="ow">and</span> <span class="nf">all</span><span class="p">((</span><span class="n">final_statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">in</span> <span class="n">TERMINAL_STATES</span><span class="p">)</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">))</span>

        <span class="c1"># ë§ˆì§€ë§‰ UI ê°±ì‹ (ì“°ë¡œí‹€ ì—†ì´)
</span>        <span class="k">if</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[{</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid</span><span class="p">,</span> <span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="n">final_statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">N/A</span><span class="sh">"</span><span class="p">,</span>
                     <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid_to_cmd</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)}</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
            <span class="nf">push_ui</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

        <span class="c1"># 6) ì‹¤í–‰ ê²°ê³¼ ìš”ì•½ ì €ì¥
</span>        <span class="n">results_dir</span> <span class="o">=</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">runs</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">session_tag</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">utcnow</span><span class="p">().</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%Y%m%d_%H%M%S</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="sh">"</span><span class="s">_</span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="nf">getpid</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">results_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">results_dir</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">result_</span><span class="si">{</span><span class="n">session_tag</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>

        <span class="n">failed_submissions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span>
            <span class="k">if</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">submitted_at</span><span class="sh">"</span><span class="p">:</span> <span class="n">submitted_at</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">completed_at</span><span class="sh">"</span><span class="p">:</span> <span class="n">completed_at</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">duration_sec</span><span class="sh">"</span><span class="p">:</span> <span class="n">duration_sec</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">job_ids</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">final_status</span><span class="sh">"</span><span class="p">:</span> <span class="n">final_statuses</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">all_done</span><span class="sh">"</span><span class="p">:</span> <span class="nf">bool</span><span class="p">(</span><span class="n">all_done</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">failed_submissions</span><span class="sh">"</span><span class="p">:</span> <span class="n">failed_submissions</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">:</span> <span class="n">cwd</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">options</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># ì°¸ê³ ìš©ìœ¼ë¡œë§Œ ê¸°ë¡(ëŸ°íƒ€ì„ ì œì–´ ì•„ë‹˜)
</span>                <span class="sh">"</span><span class="s">BATCH_SIZE</span><span class="sh">"</span><span class="p">:</span> <span class="n">BATCH_SIZE</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">POLL_INTERVAL_S</span><span class="sh">"</span><span class="p">:</span> <span class="n">POLL_INTERVAL_S</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">FULL_TTL_S</span><span class="sh">"</span><span class="p">:</span> <span class="n">FULL_TTL_S</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">MIN_REFRESH_GAP_S</span><span class="sh">"</span><span class="p">:</span> <span class="n">MIN_REFRESH_GAP_S</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">FULL_STATUS_CMD</span><span class="sh">"</span><span class="p">:</span> <span class="n">FULL_STATUS_CMD</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">MAX_WAIT_S</span><span class="sh">"</span><span class="p">:</span> <span class="n">MAX_WAIT_S</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">UI_UPDATE_GAP_S</span><span class="sh">"</span><span class="p">:</span> <span class="n">UI_UPDATE_GAP_S</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">CMD_WIDTH_LIMIT</span><span class="sh">"</span><span class="p">:</span> <span class="n">CMD_WIDTH_LIMIT</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">FORCE_REFRESH_ON_MISS</span><span class="sh">"</span><span class="p">:</span> <span class="n">FORCE_REFRESH_ON_MISS</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">results_file</span><span class="sh">"</span><span class="p">:</span> <span class="n">results_path</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">results_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># 7) ë…¸ë“œ ì¶œë ¥
</span>        <span class="n">job_ids_str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>
        <span class="n">results_json_str</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">job_ids_str</span><span class="p">,</span> <span class="n">results_json_str</span><span class="p">)</span>

<span class="c1"># ---------------------------- Node registration ----------------------------
</span>
<span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LSFSubmitAndWait</span><span class="sh">"</span><span class="p">:</span> <span class="n">LSFSubmitAndWait</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LSFSubmitAndWait</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">LSF: Submit &amp; Wait</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p class="chat--user">

ë‹¤ì‹œ í•œ ë²ˆ ì‘ì„±í•´ì¤˜. 1. ì£¼ì„ì€ ì˜ì–´ë¡œ 2. ì„œë²„ ì—ëŸ¬ ë“±ìœ¼ë¡œ bjobsê°€ ì‹¤íŒ¨í–ˆì„ ë•Œ ì´ë¥¼ ì–´ë–»ê²Œ ë‹¤ë£¨ëŠ”ì§€ ê¶ê¸ˆí•´. ì›¬ë§Œí•˜ë©´ ì•ˆì£½ëŠ” ìª½ìœ¼ë¡œ ê°”ìœ¼ë©´ ì¢‹ê² ëŠ”ë°

</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># File: custom_nodes/lsf_submit_and_wait.py
# Purpose: ComfyUI async OUTPUT node to submit LSF jobs (bsub), poll with `bjobs -a`,
#          share a lightweight global cache, and live-update a String widget during runtime.
# Notes:
#   - All tunables live as CONSTANTS below (no per-run options parsing).
#   - Robust against transient server/cluster errors: timeouts, non-zero rc, and
#     `bjobs` failures are treated as non-fatal. The node keeps running, uses last
#     known statuses, and retries with exponential backoff.
#
# Frontend hook (place in a small web extension):
#   api.addEventListener("impact-node-feedback", (event) =&gt; {
#     const node = app.graph._nodes_by_id[event.detail.node_id];
#     if (!node) return;
#     const w = node.widgets?.find(w =&gt; w.name === event.detail.widget_name);
#     if (!w) return;
#     w.value = event.detail.value;
#     if (w.callback) w.callback(w.value);
#     node.setDirtyCanvas(true, true);
#   });
</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">tempfile</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">from</span> <span class="n">server</span> <span class="kn">import</span> <span class="n">PromptServer</span>  <span class="c1"># ComfyUI runtime UI updates
</span>
<span class="c1"># ---------------------------- CONSTANTS ----------------------------
</span>
<span class="c1"># Submission / polling
</span><span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">4</span>                    <span class="c1"># concurrent bsub submissions
</span><span class="n">POLL_INTERVAL_S</span> <span class="o">=</span> <span class="mi">10</span>              <span class="c1"># polling interval (seconds)
</span><span class="n">MAX_WAIT_S</span> <span class="o">=</span> <span class="bp">None</span>                 <span class="c1"># None = wait indefinitely
</span>
<span class="c1"># Shell timeouts
</span><span class="n">SUBMIT_TIMEOUT_S</span> <span class="o">=</span> <span class="mi">60</span>             <span class="c1"># timeout for each bsub command
</span><span class="n">STATUS_TIMEOUT_S</span> <span class="o">=</span> <span class="mi">60</span>             <span class="c1"># timeout for each bjobs -a call
</span>
<span class="c1"># Cache behavior
</span><span class="n">FULL_TTL_S</span> <span class="o">=</span> <span class="mi">10</span>                   <span class="c1"># freshness window for the snapshot (seconds)
</span><span class="n">MIN_REFRESH_GAP_S</span> <span class="o">=</span> <span class="mi">5</span>             <span class="c1"># min gap between two `bjobs -a` runs (seconds)
</span><span class="n">FORCE_REFRESH_ON_MISS</span> <span class="o">=</span> <span class="bp">True</span>      <span class="c1"># refresh when a requested job_id is missing/stale
</span>
<span class="c1"># `bjobs -a` template (expects two columns: jobid, stat)
</span><span class="n">FULL_STATUS_CMD</span> <span class="o">=</span> <span class="sh">'</span><span class="s">bjobs -a -noheader -o </span><span class="sh">"</span><span class="s">jobid stat</span><span class="sh">"'</span>

<span class="c1"># Live UI feedback (String widget)
</span><span class="n">UI_UPDATE_GAP_S</span> <span class="o">=</span> <span class="mf">1.0</span>             <span class="c1"># throttle for widget updates (seconds)
</span><span class="n">CMD_WIDTH_LIMIT</span> <span class="o">=</span> <span class="mi">100</span>             <span class="c1"># truncate command string in table
</span>
<span class="c1"># Error/backoff for `bjobs -a` failures (non-fatal)
</span><span class="n">BJOBS_BACKOFF_BASE_S</span> <span class="o">=</span> <span class="mi">15</span>         <span class="c1"># initial backoff after a failed snapshot attempt
</span><span class="n">BJOBS_BACKOFF_MAX_S</span> <span class="o">=</span> <span class="mi">120</span>         <span class="c1"># maximum backoff cap (exponential up to this)
</span>
<span class="c1"># Terminal states (adjust if needed)
</span><span class="n">TERMINAL_STATES</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">DONE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">EXIT</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># Cache file name under /tmp or $COMFYUI_LSF_CACHE_DIR
</span><span class="n">CACHE_FILENAME</span> <span class="o">=</span> <span class="sh">"</span><span class="s">status_full_cache.json</span><span class="sh">"</span>

<span class="c1"># ---------------------------- Utilities ----------------------------
</span>
<span class="n">JOB_ID_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">Job\s*&lt;(\d+)&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">iso_now</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">utcnow</span><span class="p">().</span><span class="nf">isoformat</span><span class="p">(</span><span class="n">timespec</span><span class="o">=</span><span class="sh">"</span><span class="s">seconds</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s">Z</span><span class="sh">"</span>

<span class="k">def</span> <span class="nf">default_cache_dir</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">COMFYUI_LSF_CACHE_DIR</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">tempfile</span><span class="p">.</span><span class="nf">gettempdir</span><span class="p">(),</span> <span class="sh">"</span><span class="s">comfyui_lsf_cache</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">path</span>

<span class="k">def</span> <span class="nf">_short</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">s</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">limit</span> <span class="nf">else </span><span class="p">(</span><span class="n">s</span><span class="p">[:</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">+</span> <span class="sh">"</span><span class="s">â€¦</span><span class="sh">"</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_shell</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Run shell command with optional timeout. Never raises to caller:
    returns (rc, stdout, stderr). On exception/timeout: non-zero rc and stderr message.
    </span><span class="sh">"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_shell</span><span class="p">(</span>
            <span class="n">cmd</span><span class="p">,</span>
            <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span> <span class="k">if</span> <span class="n">cwd</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">ignore</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">ignore</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">()</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="mi">124</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Timeout after </span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s">s for: </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="sh">"</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Exception executing shell: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span>

<span class="k">def</span> <span class="nf">extract_job_ids_from_bsub_output</span><span class="p">(</span><span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="c1"># LSF standard: "Job &lt;12345&gt; is submitted to queue &lt;...&gt;."
</span>    <span class="k">return</span> <span class="n">JOB_ID_REGEX</span><span class="p">.</span><span class="nf">findall</span><span class="p">(</span><span class="n">stdout</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">make_status_markdown</span><span class="p">(</span><span class="n">job_rows</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">width_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">CMD_WIDTH_LIMIT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Build a compact, markdown-like table: JOB ID | STATUS | COMMAND
    (String widget is plain text; the table is just for readability.)
    </span><span class="sh">"""</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">| JOB ID | STATUS | COMMAND |</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">|------:|:------:|---------|</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">job_rows</span><span class="p">:</span>
        <span class="n">jid</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="n">st</span>  <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">))</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nf">_short</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)),</span> <span class="n">width_limit</span><span class="p">)</span>
        <span class="n">lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">| `</span><span class="si">{</span><span class="n">jid</span><span class="si">}</span><span class="s">` | `</span><span class="si">{</span><span class="n">st</span><span class="si">}</span><span class="s">` | `</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s">` |</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

<span class="c1"># ---------------------------- File lock (best-effort) ----------------------------
</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">fcntl</span>  <span class="c1"># type: ignore
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="n">fcntl</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># On Windows, locks are skipped (accepting race risk)
</span>
<span class="k">def</span> <span class="nf">_lock_fd</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">nonblock</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
    <span class="n">fh</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">a+</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fcntl</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fcntl</span><span class="p">.</span><span class="nf">flock</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">fcntl</span><span class="p">.</span><span class="n">LOCK_EX</span> <span class="o">|</span> <span class="p">(</span><span class="n">fcntl</span><span class="p">.</span><span class="n">LOCK_NB</span> <span class="k">if</span> <span class="n">nonblock</span> <span class="k">else</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">except</span> <span class="nb">BlockingIOError</span><span class="p">:</span>
            <span class="n">fh</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">fh</span>

<span class="k">def</span> <span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fh</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">fcntl</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fcntl</span><span class="p">.</span><span class="nf">flock</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">fcntl</span><span class="p">.</span><span class="n">LOCK_UN</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fh</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="c1"># ---------------------------- LSF backend ----------------------------
</span>
<span class="k">class</span> <span class="nc">LSFBackend</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Minimal backend: fetch a full snapshot of job statuses via `bjobs -a`.
    Returns (snapshot_dict, ok_bool). `ok_bool` is False on rc!=0 or timeout/exception.
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">full_status_cmd</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">FULL_STATUS_CMD</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">full_status_cmd</span> <span class="o">=</span> <span class="n">full_status_cmd</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">full_snapshot</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]:</span>
        <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_shell</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">full_status_cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">STATUS_TIMEOUT_S</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Non-fatal: caller will backoff and keep last known cache
</span>            <span class="k">return</span> <span class="p">{},</span> <span class="bp">False</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="p">(</span><span class="n">out</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">ln</span> <span class="o">=</span> <span class="n">ln</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ln</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">ln</span><span class="p">.</span><span class="nf">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">parts</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">jid</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">upper</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="bp">True</span>

<span class="c1"># ---------------------------- Lightweight 2-tier cache ----------------------------
</span>
<span class="k">class</span> <span class="nc">LSFCache</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - In-process memory snapshot (fast-path, avoids most file I/O)
    - Cross-process JSON file snapshot (source of truth)
    - TTL + min refresh gap + refresh lock + error backoff to prevent `bjobs -a` storms
    File structure:
      {
        </span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="s">: { </span><span class="sh">"</span><span class="s">&lt;jobid&gt;</span><span class="sh">"</span><span class="s">: {</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">RUN</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="s">: 169...}, ... },
        </span><span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="s">: { </span><span class="sh">"</span><span class="s">&lt;jobid&gt;</span><span class="sh">"</span><span class="s">: {</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">submitted_at</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">}, ... },
        </span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="s">: 169...,
        </span><span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="s">: { </span><span class="sh">"</span><span class="s">refreshed_at</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">ttl_or_miss</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">last_error</span><span class="sh">"</span><span class="s">: {...} }
      }
    Error/backoff:
      - Consecutive snapshot failures increase an exponential backoff window
        capped at BJOBS_BACKOFF_MAX_S. During backoff, refresh attempts are skipped.
    </span><span class="sh">"""</span>

    <span class="n">_mem_jobs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_mem_last_ts</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">_mem_lock</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>

    <span class="n">_error_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">_last_error_ts</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cache_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span> <span class="o">=</span> <span class="n">cache_file</span>
        <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">cache_file</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">cache_file</span><span class="p">):</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span> <span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span> <span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}},</span> <span class="n">f</span><span class="p">)</span>

    <span class="c1"># file I/O helpers
</span>    <span class="k">def</span> <span class="nf">_read_file</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span> <span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="p">:</span> <span class="p">{},</span> <span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="k">def</span> <span class="nf">_write_file_and_update_mem</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span> <span class="o">+</span> <span class="sh">"</span><span class="s">.tmp</span><span class="sh">"</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">)</span>
        <span class="nf">type</span><span class="p">(</span><span class="n">self</span><span class="p">).</span><span class="n">_mem_jobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
        <span class="nf">type</span><span class="p">(</span><span class="n">self</span><span class="p">).</span><span class="n">_mem_last_ts</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="c1"># public API
</span>    <span class="k">def</span> <span class="nf">seed_submitted</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">meta</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Make freshly submitted jobs visible as SUBMITTED in both memory and file.</span><span class="sh">"""</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="c1"># memory
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_mem_jobs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem_jobs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_mem_jobs</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">SUBMITTED</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">now</span><span class="p">})</span>
        <span class="c1"># file
</span>        <span class="n">fh</span> <span class="o">=</span> <span class="nf">_lock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_file</span><span class="p">()</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                <span class="n">jobs</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">SUBMITTED</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">now</span><span class="p">})</span>
            <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobs</span>
            <span class="k">if</span> <span class="n">meta</span><span class="p">:</span>
                <span class="n">jm</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">:</span>
                        <span class="n">jm</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span>
                <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">jobs_meta</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">jm</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_write_file_and_update_mem</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_in_backoff_window</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_error_count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_error_ts</span>
        <span class="n">backoff</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">BJOBS_BACKOFF_MAX_S</span><span class="p">,</span> <span class="n">BJOBS_BACKOFF_BASE_S</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_error_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">elapsed</span> <span class="o">&lt;</span> <span class="n">backoff</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_maybe_refresh</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">backend</span><span class="p">:</span> <span class="n">LSFBackend</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        Decide and run a full-snapshot refresh iff:
          - Not in error backoff window;
          - Min refresh gap is satisfied;
          - We acquire the non-blocking refresh lock;
        On failure: do not raise, record error (for backoff), keep old cache.
        </span><span class="sh">"""</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_backoff_window</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_file</span><span class="p">()</span>
        <span class="n">last_ts</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="nf">if </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_ts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MIN_REFRESH_GAP_S</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="n">lock_fh</span> <span class="o">=</span> <span class="nf">_lock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span> <span class="o">+</span> <span class="sh">"</span><span class="s">.refresh.lock</span><span class="sh">"</span><span class="p">,</span> <span class="n">nonblock</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lock_fh</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Double-check the min gap after acquiring the lock
</span>            <span class="n">data2</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_file</span><span class="p">()</span>
            <span class="n">last_ts2</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data2</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="nf">if </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_ts2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MIN_REFRESH_GAP_S</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="n">snapshot</span><span class="p">,</span> <span class="n">ok</span> <span class="o">=</span> <span class="k">await</span> <span class="n">backend</span><span class="p">.</span><span class="nf">full_snapshot</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                <span class="c1"># Record error/backoff and a small meta for debugging
</span>                <span class="nf">type</span><span class="p">(</span><span class="n">self</span><span class="p">).</span><span class="n">_error_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="nf">type</span><span class="p">(</span><span class="n">self</span><span class="p">).</span><span class="n">_last_error_ts</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
                <span class="n">fh</span> <span class="o">=</span> <span class="nf">_lock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">base</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_file</span><span class="p">()</span>
                    <span class="n">meta</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="n">meta</span><span class="p">[</span><span class="sh">"</span><span class="s">last_error</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">at</span><span class="sh">"</span><span class="p">:</span> <span class="nf">iso_now</span><span class="p">(),</span>
                        <span class="sh">"</span><span class="s">error_count</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">_error_count</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">note</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">bjobs snapshot failed; using last known cache</span><span class="sh">"</span>
                    <span class="p">}</span>
                    <span class="n">base</span><span class="p">[</span><span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span>
                    <span class="c1"># Do not change jobs / last_full_refresh_ts
</span>                    <span class="n">self</span><span class="p">.</span><span class="nf">_write_file_and_update_mem</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="c1"># Success: reset backoff
</span>            <span class="nf">type</span><span class="p">(</span><span class="n">self</span><span class="p">).</span><span class="n">_error_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="nf">type</span><span class="p">(</span><span class="n">self</span><span class="p">).</span><span class="n">_last_error_ts</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="n">now2</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="nf">_lock_fd</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cache_file</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_file</span><span class="p">()</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">for</span> <span class="n">jid</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">snapshot</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
                    <span class="n">jobs</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="n">st</span><span class="p">,</span> <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">now2</span><span class="p">}</span>
                <span class="n">base</span><span class="p">[</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobs</span>
                <span class="n">base</span><span class="p">[</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">now2</span>
                <span class="n">meta</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">meta</span><span class="p">[</span><span class="sh">"</span><span class="s">refreshed_at</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
                <span class="n">meta</span><span class="p">[</span><span class="sh">"</span><span class="s">reason</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">reason</span>
                <span class="n">base</span><span class="p">[</span><span class="sh">"</span><span class="s">meta</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_write_file_and_update_mem</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="nf">_unlock_fd</span><span class="p">(</span><span class="n">lock_fh</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_statuses</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">backend</span><span class="p">:</span> <span class="n">LSFBackend</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">
        2-tier retrieval:
          1) If memory snapshot is fresh -&gt; use it (no file I/O).
          2) Else read file once and update memory.
          3) If TTL expired or miss (and FORCE_REFRESH_ON_MISS), try to refresh (subject to backoff &amp; min-gap).
        Never raises; returns last known statuses. Missing ones return </span><span class="sh">""</span><span class="s">.
        </span><span class="sh">"""</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="c1"># 1) memory fast-path
</span>        <span class="k">async</span> <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem_lock</span><span class="p">:</span>
            <span class="n">mem_is_fresh</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem_last_ts</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">FULL_TTL_S</span>
            <span class="k">if</span> <span class="n">mem_is_fresh</span><span class="p">:</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem_jobs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_file</span><span class="p">()</span>
                <span class="nf">type</span><span class="p">(</span><span class="n">self</span><span class="p">).</span><span class="n">_mem_jobs</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">jobs</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="nf">type</span><span class="p">(</span><span class="n">self</span><span class="p">).</span><span class="n">_mem_last_ts</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">last_full_refresh_ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem_jobs</span>

        <span class="k">def</span> <span class="nf">fresh</span><span class="p">(</span><span class="n">jid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">ent</span> <span class="o">=</span> <span class="n">jobs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ent</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="nf">return </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="nf">float</span><span class="p">(</span><span class="n">ent</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="o">&lt;=</span> <span class="n">FULL_TTL_S</span>

        <span class="n">need_refresh</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">mem_is_fresh</span>
        <span class="k">if</span> <span class="n">FORCE_REFRESH_ON_MISS</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nf">fresh</span><span class="p">(</span><span class="n">jid</span><span class="p">):</span>
                    <span class="n">need_refresh</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">break</span>

        <span class="k">if</span> <span class="n">need_refresh</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_maybe_refresh</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="sh">"</span><span class="s">ttl_or_miss</span><span class="sh">"</span><span class="p">)</span>
            <span class="c1"># Read from memory snapshot again (already updated if refresh succeeded)
</span>            <span class="n">jobs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_mem_jobs</span>

        <span class="k">return</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="n">jobs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>

<span class="c1"># ---------------------------- Submission helpers ----------------------------
</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">submit_commands_multiline</span><span class="p">(</span><span class="n">commands</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Submit each non-empty line as an independent `bsub ...` command.
    Concurrency is limited by BATCH_SIZE. Never raises; collects failures.
    Returns (job_ids, submissions_detail).
    </span><span class="sh">"""</span>
    <span class="n">sem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">)))</span>
    <span class="n">submissions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_submit_one</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">sem</span><span class="p">:</span>
            <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_shell</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">SUBMIT_TIMEOUT_S</span><span class="p">)</span>
            <span class="n">jids</span> <span class="o">=</span> <span class="nf">extract_job_ids_from_bsub_output</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">cmd</span><span class="p">,</span> <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">out</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">err</span><span class="p">,</span> <span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">jids</span><span class="p">}</span>

    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">_submit_one</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">as_completed</span><span class="p">(</span><span class="n">tasks</span><span class="p">):</span>
        <span class="n">submissions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="k">await</span> <span class="n">t</span><span class="p">)</span>

    <span class="n">job_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">jid</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])]</span>
    <span class="k">return</span> <span class="n">job_ids</span><span class="p">,</span> <span class="n">submissions</span>

<span class="c1"># ---------------------------- ComfyUI Node ----------------------------
</span>
<span class="k">class</span> <span class="nc">LSFSubmitAndWait</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    Async OUTPUT node:
      - Submits multi-line bsub commands (batch-limited parallelism).
      - Polls statuses via a shared `bjobs -a` snapshot cache across nodes/processes.
      - Live-updates a String widget (</span><span class="sh">"</span><span class="s">status_md</span><span class="sh">"</span><span class="s">) with JOB/STATUS/COMMAND table.
      - Resilient to server errors: timeouts, rc!=0, and `bjobs` failures are non-fatal.
        The node keeps last known statuses and retries with backoff.
    </span><span class="sh">"""</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LSF</span><span class="sh">"</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span>
    <span class="n">OUTPUT_NODE</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">SUPPORTS_ASYNC</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">results_json</span><span class="sh">"</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">commands</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">bsub -q short -J demo sleep 3</span><span class="sh">"</span><span class="p">}),</span>
                <span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">optional</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="c1"># Display-only (the server updates this at runtime)
</span>                <span class="sh">"</span><span class="s">status_md</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span>
                    <span class="sh">"</span><span class="s">| JOB ID | STATUS | COMMAND |</span><span class="se">\n</span><span class="s">|------:|:------:|---------|</span><span class="se">\n</span><span class="s">(Updating during run...)</span><span class="sh">"</span><span class="p">}),</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">hidden</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="c1"># Injected by ComfyUI; used to target the widget updates
</span>                <span class="sh">"</span><span class="s">node_id</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">UNIQUE_ID</span><span class="sh">"</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">commands</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">status_md</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="n">node_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="c1"># 0) sanitize input lines (skip empty / comment-only)
</span>        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="p">(</span><span class="n">commands</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">splitlines</span><span class="p">():</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">ln</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">#</span><span class="sh">"</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">ln</span><span class="p">)</span>

        <span class="c1"># 1) submit
</span>        <span class="n">submitted_at</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
        <span class="n">job_ids</span><span class="p">,</span> <span class="n">submissions</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">submit_commands_multiline</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">)</span>

        <span class="c1"># 2) job_id -&gt; command map (for UI/log)
</span>        <span class="n">jid_to_cmd</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">jid_to_cmd</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>

        <span class="c1"># 3) shared cache &amp; backend
</span>        <span class="n">cache_dir</span> <span class="o">=</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="nf">default_cache_dir</span><span class="p">())</span>
        <span class="n">cache_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">CACHE_FILENAME</span><span class="p">)</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="nc">LSFCache</span><span class="p">(</span><span class="n">cache_file</span><span class="p">)</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="nc">LSFBackend</span><span class="p">(</span><span class="n">FULL_STATUS_CMD</span><span class="p">)</span>

        <span class="c1"># 3-1) seed freshly submitted jobs to handle "just-submitted not in cache yet"
</span>        <span class="k">if</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid_to_cmd</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">),</span> <span class="sh">"</span><span class="s">submitted_at</span><span class="sh">"</span><span class="p">:</span> <span class="n">submitted_at</span><span class="p">}</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>
            <span class="n">cache</span><span class="p">.</span><span class="nf">seed_submitted</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">)</span>

        <span class="c1"># 4) initial UI update (SUBMITTED)
</span>        <span class="k">def</span> <span class="nf">push_ui</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">node_id</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">table</span> <span class="o">=</span> <span class="nf">make_status_markdown</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">PromptServer</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="nf">send_sync</span><span class="p">(</span>
                    <span class="sh">"</span><span class="s">impact-node-feedback</span><span class="sh">"</span><span class="p">,</span>
                    <span class="p">{</span><span class="sh">"</span><span class="s">node_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">node_id</span><span class="p">,</span> <span class="sh">"</span><span class="s">widget_name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">status_md</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">:</span> <span class="n">table</span><span class="p">}</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="c1"># UI push failures are non-fatal; continue control flow
</span>                <span class="k">pass</span>

        <span class="k">if</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">init_rows</span> <span class="o">=</span> <span class="p">[{</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid</span><span class="p">,</span> <span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">SUBMITTED</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid_to_cmd</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)}</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
            <span class="nf">push_ui</span><span class="p">(</span><span class="n">init_rows</span><span class="p">)</span>

        <span class="c1"># 5) poll loop until all terminal or timeout
</span>        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">last_ui</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">final_statuses</span> <span class="o">=</span> <span class="p">{</span><span class="n">jid</span><span class="p">:</span> <span class="sh">"</span><span class="s">SUBMITTED</span><span class="sh">"</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">}</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">statuses</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cache</span><span class="p">.</span><span class="nf">get_statuses</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">backend</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                <span class="n">st</span> <span class="o">=</span> <span class="p">(</span><span class="n">statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span> <span class="ow">or</span> <span class="n">final_statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">""</span><span class="p">).</span><span class="nf">upper</span><span class="p">()</span>
                <span class="n">final_statuses</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span> <span class="k">if</span> <span class="n">st</span> <span class="k">else</span> <span class="n">final_statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>

            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="nf">if </span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_ui</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">UI_UPDATE_GAP_S</span><span class="p">:</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="p">[{</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid</span><span class="p">,</span> <span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="n">final_statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">N/A</span><span class="sh">"</span><span class="p">,</span>
                         <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid_to_cmd</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)}</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
                <span class="nf">push_ui</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
                <span class="n">last_ui</span> <span class="o">=</span> <span class="n">now</span>

            <span class="k">if</span> <span class="n">job_ids</span> <span class="ow">and</span> <span class="nf">all</span><span class="p">((</span><span class="n">final_statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">in</span> <span class="n">TERMINAL_STATES</span><span class="p">)</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">):</span>
                <span class="k">break</span>

            <span class="nf">if </span><span class="p">(</span><span class="n">MAX_WAIT_S</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">now</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MAX_WAIT_S</span><span class="p">):</span>
                <span class="k">break</span>

            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">POLL_INTERVAL_S</span><span class="p">)))</span>

        <span class="n">completed_at</span> <span class="o">=</span> <span class="nf">iso_now</span><span class="p">()</span>
        <span class="n">duration_sec</span> <span class="o">=</span> <span class="nf">round</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">all_done</span> <span class="o">=</span> <span class="p">(</span><span class="n">job_ids</span> <span class="ow">and</span> <span class="nf">all</span><span class="p">((</span><span class="n">final_statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">in</span> <span class="n">TERMINAL_STATES</span><span class="p">)</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">))</span>

        <span class="c1"># final UI update (unthrottled)
</span>        <span class="k">if</span> <span class="n">job_ids</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[{</span><span class="sh">"</span><span class="s">job_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid</span><span class="p">,</span> <span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="n">final_statuses</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">N/A</span><span class="sh">"</span><span class="p">,</span>
                     <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">jid_to_cmd</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="sh">""</span><span class="p">)}</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
            <span class="nf">push_ui</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

        <span class="c1"># 6) persist a concise run log
</span>        <span class="n">results_dir</span> <span class="o">=</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">runs</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">session_tag</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">utcnow</span><span class="p">().</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">"</span><span class="s">%Y%m%d_%H%M%S</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="sh">"</span><span class="s">_</span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="nf">getpid</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span>
        <span class="n">results_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">results_dir</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">result_</span><span class="si">{</span><span class="n">session_tag</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>

        <span class="n">failed_submissions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">submissions</span>
            <span class="k">if</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">sub</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">submitted_at</span><span class="sh">"</span><span class="p">:</span> <span class="n">submitted_at</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">completed_at</span><span class="sh">"</span><span class="p">:</span> <span class="n">completed_at</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">duration_sec</span><span class="sh">"</span><span class="p">:</span> <span class="n">duration_sec</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">job_ids</span><span class="sh">"</span><span class="p">:</span> <span class="n">job_ids</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">final_status</span><span class="sh">"</span><span class="p">:</span> <span class="n">final_statuses</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">all_done</span><span class="sh">"</span><span class="p">:</span> <span class="nf">bool</span><span class="p">(</span><span class="n">all_done</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">failed_submissions</span><span class="sh">"</span><span class="p">:</span> <span class="n">failed_submissions</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">:</span> <span class="n">cwd</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">options</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># for record only (not runtime-tunable)
</span>                <span class="sh">"</span><span class="s">BATCH_SIZE</span><span class="sh">"</span><span class="p">:</span> <span class="n">BATCH_SIZE</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">POLL_INTERVAL_S</span><span class="sh">"</span><span class="p">:</span> <span class="n">POLL_INTERVAL_S</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">FULL_TTL_S</span><span class="sh">"</span><span class="p">:</span> <span class="n">FULL_TTL_S</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">MIN_REFRESH_GAP_S</span><span class="sh">"</span><span class="p">:</span> <span class="n">MIN_REFRESH_GAP_S</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">FULL_STATUS_CMD</span><span class="sh">"</span><span class="p">:</span> <span class="n">FULL_STATUS_CMD</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">MAX_WAIT_S</span><span class="sh">"</span><span class="p">:</span> <span class="n">MAX_WAIT_S</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">UI_UPDATE_GAP_S</span><span class="sh">"</span><span class="p">:</span> <span class="n">UI_UPDATE_GAP_S</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">CMD_WIDTH_LIMIT</span><span class="sh">"</span><span class="p">:</span> <span class="n">CMD_WIDTH_LIMIT</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">FORCE_REFRESH_ON_MISS</span><span class="sh">"</span><span class="p">:</span> <span class="n">FORCE_REFRESH_ON_MISS</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">SUBMIT_TIMEOUT_S</span><span class="sh">"</span><span class="p">:</span> <span class="n">SUBMIT_TIMEOUT_S</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">STATUS_TIMEOUT_S</span><span class="sh">"</span><span class="p">:</span> <span class="n">STATUS_TIMEOUT_S</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">BJOBS_BACKOFF_BASE_S</span><span class="sh">"</span><span class="p">:</span> <span class="n">BJOBS_BACKOFF_BASE_S</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">BJOBS_BACKOFF_MAX_S</span><span class="sh">"</span><span class="p">:</span> <span class="n">BJOBS_BACKOFF_MAX_S</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">results_file</span><span class="sh">"</span><span class="p">:</span> <span class="n">results_path</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">results_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># 7) outputs
</span>        <span class="n">job_ids_str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>
        <span class="n">results_json_str</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">job_ids_str</span><span class="p">,</span> <span class="n">results_json_str</span><span class="p">)</span>

<span class="c1"># ---------------------------- Node registration ----------------------------
</span>
<span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LSFSubmitAndWait</span><span class="sh">"</span><span class="p">:</span> <span class="n">LSFSubmitAndWait</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LSFSubmitAndWait</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">LSF: Submit &amp; Wait</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p class="chat--user">

ì´ì œ ì½”ë“œëŠ” ê±´ë“œë¦¬ì§€ ë§ê³  ì „ì²´ì ì¸ ë™ì‘ì„ í•œê¸€ë¡œ ì„¤ëª…í•´ì¤˜

</p>

<p>ì•Œê² ì–´! ì•„ë˜ëŠ” <strong>ì§€ê¸ˆ ì œê³µëœ íŒŒì´ì¬ ì½”ë“œ ê·¸ëŒ€ë¡œ</strong> ë¥¼ ê¸°ì¤€ìœ¼ë¡œ, ë…¸ë“œì˜ ì „ì²´ ë™ì‘ì„ â€œì²˜ìŒë¶€í„° ëê¹Œì§€â€ í•œê¸€ë¡œ ì •ë¦¬í•œ ì„¤ëª…ì´ì•¼. (ì½”ë“œëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒ)</p>

<hr />

<h1 id="ë¬´ì—‡ì„-í•˜ëŠ”-ë…¸ë“œì¸ê°€">ë¬´ì—‡ì„ í•˜ëŠ” ë…¸ë“œì¸ê°€?</h1>

<ul>
  <li>
    <p>ComfyUIì—ì„œ ë©€í‹°ë¼ì¸ <code class="language-plaintext highlighter-rouge">bsub</code> ëª…ë ¹ì„ <strong>ë¹„ë™ê¸° ì œì¶œ</strong> í•˜ê³ , <code class="language-plaintext highlighter-rouge">bjobs -a</code>ë¡œ <strong>ìƒíƒœë¥¼ ì§€ì† í´ë§</strong> í•˜ì—¬ <strong>ì™„ë£Œê¹Œì§€ ê¸°ë‹¤ë¦¬ëŠ” OUTPUT ë…¸ë“œ</strong> ì˜ˆìš”.</p>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>ì‹¤í–‰ ì¤‘, ê°™ì€ ë…¸ë“œì˜ <strong>String ìœ„ì ¯(status_md)</strong>ì— **â€œJOB ID</td>
          <td>STATUS</td>
          <td>COMMANDâ€** í‘œ í˜•íƒœì˜ í…ìŠ¤íŠ¸ë¥¼ <strong>ì‹¤ì‹œê°„ ê°±ì‹ </strong> í•´ ë³´ì—¬ì¤˜ìš”.</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>ì—¬ëŸ¬ ë…¸ë“œ/í”„ë¡œì„¸ìŠ¤ê°€ ë™ì‹œì— ëŒì•„ë„ <strong>ì „ì—­ ìºì‹œ</strong> ë¥¼ ê³µìœ í•˜ì—¬ <code class="language-plaintext highlighter-rouge">bjobs -a</code> í˜¸ì¶œì„ ìµœì†Œí™”í•˜ê³ , ì„œë²„ ì˜¤ë¥˜ê°€ ë‚˜ë„ <strong>ì£½ì§€ ì•Šê³ </strong> ì•ˆì „í•˜ê²Œ ê³„ì† ë™ì‘í•´ìš”.</li>
</ul>

<hr />

<h1 id="êµ¬ì„±-ìš”ì†Œí°-ê·¸ë¦¼">êµ¬ì„± ìš”ì†Œ(í° ê·¸ë¦¼)</h1>

<ol>
  <li>
    <p><strong>ìƒìˆ˜(CONSTANTS)</strong></p>

    <ul>
      <li>ë°°ì¹˜ ì œì¶œ ê°œìˆ˜, í´ë§ ì£¼ê¸°, TTL, ìµœì†Œ ì¬í˜¸ì¶œ ê°„ê²©, UI ê°±ì‹  ì“°ë¡œí‹€, <code class="language-plaintext highlighter-rouge">bjobs -a</code> í…œí”Œë¦¿, íƒ€ì„ì•„ì›ƒ/ë°±ì˜¤í”„ ë“± ëª¨ë“  ë™ì‘ íŒŒë¼ë¯¸í„°ëŠ” íŒŒì¼ ìƒë‹¨ì˜ ìƒìˆ˜ë¡œ ê³ ì •ë¼ìš”.</li>
    </ul>
  </li>
  <li>
    <p><strong>ë°±ì—”ë“œ(LSFBackend)</strong></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">bjobs -a -noheader -o "jobid stat"</code>ë¥¼ í•œ ë²ˆ í˜¸ì¶œí•´ <strong>í´ëŸ¬ìŠ¤í„° ì „ì²´ ì¡ ìƒíƒœ ìŠ¤ëƒ…ìƒ·</strong> ì„ ë”•ì…”ë„ˆë¦¬ë¡œ ë§Œë“¤ì–´ ë°˜í™˜í•´ìš”.</p>
      </li>
      <li>
        <p>ì‹¤íŒ¨(ë¹„ì •ìƒ ì¢…ë£Œ/íƒ€ì„ì•„ì›ƒ/ì˜ˆì™¸) ì‹œ <strong>ì˜¤ë¥˜ë¡œ ë³´ê³ í•˜ì§€ë§Œ ì˜ˆì™¸ë¥¼ ì˜¬ë¦¬ì§€ ì•ŠìŒ</strong>(ìƒìœ„ì—ì„œ ë°±ì˜¤í”„/ì¬ì‹œë„).</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ì „ì—­ ìºì‹œ(LSFCache, 2ê³„ì¸µ)</strong></p>

    <ul>
      <li>
        <p><strong>í”„ë¡œì„¸ìŠ¤ ë‚´ ë©”ëª¨ë¦¬ ìŠ¤ëƒ…ìƒ·</strong>(ì´ˆê³ ì†, ëŒ€ë¶€ë¶„ì˜ ì¡°íšŒëŠ” íŒŒì¼ I/O ì—†ì´ í•´ê²°)</p>
      </li>
      <li>
        <p><strong>í”„ë¡œì„¸ìŠ¤ ê°„ ê³µìœ  íŒŒì¼(JSON) ìŠ¤ëƒ…ìƒ·</strong>(ì†ŒìŠ¤ ì˜¤ë¸Œ íŠ¸ë£¨ìŠ¤)</p>
      </li>
      <li>
        <p><strong>TTL + ìµœì†Œ ì¬í˜¸ì¶œ ê°„ê²© + ë¹„ì°¨ë‹¨ ë½ íŒŒì¼</strong> ë¡œ <code class="language-plaintext highlighter-rouge">bjobs -a</code> í­ì£¼ ë°©ì§€.</p>
      </li>
      <li>
        <p><strong>ë°±ì˜¤í”„(ì§€ìˆ˜)</strong> : <code class="language-plaintext highlighter-rouge">bjobs -a</code> ì—°ì† ì‹¤íŒ¨ ì‹œ, ì¼ì • ì‹œê°„ ë™ì•ˆ ìƒˆ ìŠ¤ëƒ…ìƒ· ì‹œë„ë¥¼ ê±´ë„ˆë›°ê³  <strong>ê¸°ì¡´ ìºì‹œë¡œ ê³„ì† ë™ì‘</strong>.</p>
      </li>
      <li>
        <p><strong>ì œì¶œ ì§í›„ ì‹œë”©(seeding)</strong> : ë°©ê¸ˆ ë°›ì€ Job IDë“¤ì„ ìºì‹œì— <strong>SUBMITTED</strong> ìƒíƒœë¡œ ì¦‰ì‹œ ì €ì¥ â†’ ë‹¤ë¥¸ ë…¸ë“œì—ì„œë„ ê³§ë°”ë¡œ â€œì´ ì¡ì´ ì¡´ì¬í•œë‹¤â€ëŠ” ì‚¬ì‹¤ì„ ì•Œ ìˆ˜ ìˆì–´ìš”.</p>
      </li>
      <li>
        <p>íŒŒì¼ì—ëŠ” <code class="language-plaintext highlighter-rouge">jobs</code>(ìƒíƒœÂ·íƒ€ì„ìŠ¤íƒ¬í”„), <code class="language-plaintext highlighter-rouge">jobs_meta</code>(ì»¤ë§¨ë“œ/ì œì¶œì‹œê°), <code class="language-plaintext highlighter-rouge">last_full_refresh_ts</code>, <code class="language-plaintext highlighter-rouge">meta</code>(ë¦¬í”„ë ˆì‹œ ì‚¬ìœ /ì˜¤ë¥˜ë©”ëª¨) ë“±ì„ ë³´ê´€.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ì œì¶œ ë„ìš°ë¯¸</strong></p>

    <ul>
      <li>
        <p>ì…ë ¥ì˜ ê° ì¤„ì„ ë…ë¦½ <code class="language-plaintext highlighter-rouge">bsub</code>ë¡œ ê°„ì£¼í•´ <strong>ë¹„ë™ê¸° ì œì¶œ</strong> , <strong>ë™ì‹œ ì œì¶œ ê°œìˆ˜ëŠ” ì„¸ë§ˆí¬ì–´</strong> ë¡œ ì œí•œ.</p>
      </li>
      <li>
        <p>í‘œì¤€ ì¶œë ¥ì—ì„œ <code class="language-plaintext highlighter-rouge">"Job &lt;12345&gt;"</code> íŒ¨í„´ìœ¼ë¡œ <strong>Job ID ì¶”ì¶œ</strong>.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ComfyUI ë…¸ë“œ ë³¸ì²´</strong></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">SUPPORTS_ASYNC=True</code> ë¹„ë™ê¸° ì‹¤í–‰.</p>
      </li>
      <li>
        <p>ì…ë ¥: <code class="language-plaintext highlighter-rouge">commands</code>(ë©€í‹°ë¼ì¸), <code class="language-plaintext highlighter-rouge">cwd</code>, í‘œì‹œìš© <code class="language-plaintext highlighter-rouge">status_md</code>(ëŸ°íƒ€ì„ ê°±ì‹ ).</p>
      </li>
      <li>
        <p>ì¶œë ¥: <code class="language-plaintext highlighter-rouge">job_ids</code>(ì½¤ë§ˆ êµ¬ë¶„), <code class="language-plaintext highlighter-rouge">results_json</code>(ìš”ì•½ JSON).</p>
      </li>
      <li>
        <p>ì‹¤í–‰ ì¤‘ <code class="language-plaintext highlighter-rouge">PromptServer.instance.send_sync("impact-node-feedback", ...)</code>ìœ¼ë¡œ <strong>status_md ìœ„ì ¯ì„ ì£¼ê¸°ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸</strong>.</p>
      </li>
    </ul>
  </li>
</ol>

<hr />

<h1 id="ë™ì‘-íë¦„step-by-step">ë™ì‘ íë¦„(step-by-step)</h1>

<ol>
  <li>
    <p><strong>ì…ë ¥ ì •ë¦¬</strong></p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">commands</code>ì—ì„œ <strong>ë¹ˆ ì¤„/ì£¼ì„ ì¤„</strong> ì„ ì œê±°í•´ ì‹¤ì œ ì œì¶œí•  <code class="language-plaintext highlighter-rouge">bsub</code> ë¼ì¸ë“¤ë§Œ ì¶”ë¦½ë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>
    <p><strong>ì¡ ì œì¶œ(ë¹„ë™ê¸° &amp; ë°°ì¹˜ ì œí•œ)</strong></p>

    <ul>
      <li>
        <p>ê° ë¼ì¸ì„ <code class="language-plaintext highlighter-rouge">bsub</code>ë¡œ <strong>ë³‘ë ¬ ì œì¶œ</strong>(ìµœëŒ€ ë™ì‹œ ì œì¶œ ê°œìˆ˜ = ìƒìˆ˜ <code class="language-plaintext highlighter-rouge">BATCH_SIZE</code>).</p>
      </li>
      <li>
        <p>ì œì¶œ íƒ€ì„ì•„ì›ƒ(<code class="language-plaintext highlighter-rouge">SUBMIT_TIMEOUT_S</code>)ì„ ì ìš©.</p>
      </li>
      <li>
        <p>ì œì¶œ stdoutì—ì„œ <strong>Job ID</strong> ë“¤ì„ ìˆ˜ì§‘.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ìºì‹œ ì´ˆê¸°í™” &amp; ì‹œë”©</strong></p>

    <ul>
      <li>
        <p>ì „ì—­ ìºì‹œ íŒŒì¼ ê²½ë¡œ(<code class="language-plaintext highlighter-rouge">/tmp</code> ë˜ëŠ” <code class="language-plaintext highlighter-rouge">COMFYUI_LSF_CACHE_DIR</code>)ë¥¼ ì¤€ë¹„.</p>
      </li>
      <li>
        <p>ë°©ê¸ˆ ì œì¶œí•œ Job IDë“¤ì„ <strong>ë©”ëª¨ë¦¬/íŒŒì¼ ìºì‹œ ëª¨ë‘ì—<code class="language-plaintext highlighter-rouge">SUBMITTED</code>ë¡œ ê¸°ë¡</strong>(ì‹œë”©).</p>

        <ul>
          <li>ì´ë¡œì¨ <strong>Node2ê°€ Node1 ì§í›„ì— í´ë§í•˜ë”ë¼ë„</strong> í•´ë‹¹ Job IDê°€ ìºì‹œì— ë‚˜íƒ€ë‚˜, â€œì—†ëŠ” ì¡â€ìœ¼ë¡œ ì˜¤íŒí•˜ì§€ ì•Šì•„ìš”.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ì´ˆê¸° UI ì—…ë°ì´íŠ¸</strong></p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">status_md</code> ìœ„ì ¯ì— <strong>SUBMITTED ìƒíƒœ í‘œ</strong> ë¥¼ 1íšŒ ë°˜ì˜.</p>
      </li>
      <li>
        <p>UI ì „ì†¡ ì‹¤íŒ¨ëŠ” <strong>ë¬´ì‹œ</strong>(ì»¨íŠ¸ë¡¤ í”Œë¡œìš°ì— ì˜í–¥ ì—†ìŒ).</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>í´ë§ ë£¨í”„(ì™„ë£Œ ë˜ëŠ” íƒ€ì„ì•„ì›ƒê¹Œì§€)</strong></p>

    <ul>
      <li>
        <p>ì£¼ê¸°(<code class="language-plaintext highlighter-rouge">POLL_INTERVAL_S</code>)ë§ˆë‹¤ ìºì‹œì—ì„œ ìƒíƒœ ì¡°íšŒ:</p>

        <ul>
          <li>
            <p><strong>ë©”ëª¨ë¦¬ ìŠ¤ëƒ…ìƒ·ì´ ì‹ ì„ (TTL ì´ë‚´)</strong> â†’ <strong>íŒŒì¼ ì½ê¸° ì—†ì´</strong> ë°”ë¡œ ì‚¬ìš©.</p>
          </li>
          <li>
            <p>ì•„ë‹ˆë©´ íŒŒì¼ì„ 1íšŒ ì½ì–´ ë©”ëª¨ë¦¬ ë™ê¸°í™”.</p>
          </li>
        </ul>
      </li>
      <li>
        <p><strong>ë¦¬í”„ë ˆì‹œ íŒë‹¨</strong> :</p>

        <ul>
          <li>
            <p>TTL ë§Œë£Œì´ê±°ë‚˜, ìš”ì²­ Job IDê°€ <strong>ìºì‹œì— ì—†ê±°ë‚˜ ì˜¤ë˜ë¨</strong>(ì˜µì…˜ <code class="language-plaintext highlighter-rouge">FORCE_REFRESH_ON_MISS</code>) â†’ <strong>ì „ì²´ ìŠ¤ëƒ…ìƒ· ë¦¬í”„ë ˆì‹œ í•„ìš”</strong>.</p>
          </li>
          <li>
            <p>ë‹¨, <strong>ìµœì†Œ ê°„ê²©(<code class="language-plaintext highlighter-rouge">MIN_REFRESH_GAP_S</code>)</strong>ì„ ì§€í‚¤ë©°, <strong>refresh ë½</strong> ì„ ì„ ì í•œ <strong>í•œ í”„ë¡œì„¸ìŠ¤ë§Œ</strong> <code class="language-plaintext highlighter-rouge">bjobs -a</code>ë¥¼ ì‹¤í–‰.</p>
          </li>
          <li>
            <p><code class="language-plaintext highlighter-rouge">bjobs -a</code>ê°€ ì‹¤íŒ¨í•˜ë©´:</p>

            <ul>
              <li>
                <p><strong>ì˜ˆì™¸ ì—†ì´</strong> ì‹¤íŒ¨ë¡œ ê¸°ë¡í•˜ê³ , <strong>ì—°ì† ì‹¤íŒ¨ íšŸìˆ˜ ì¦ê°€</strong> â†’ <strong>ì§€ìˆ˜ ë°±ì˜¤í”„</strong>(ìµœëŒ€ <code class="language-plaintext highlighter-rouge">BJOBS_BACKOFF_MAX_S</code>) ì§„ì….</p>
              </li>
              <li>
                <p>ë°±ì˜¤í”„ ë™ì•ˆì€ ë¦¬í”„ë ˆì‹œë¥¼ ìŠ¤í‚µí•˜ê³  <strong>ë§ˆì§€ë§‰ ìºì‹œê°’</strong> ìœ¼ë¡œ ê³„ì† ìš´ì˜.</p>
              </li>
              <li>
                <p>ì„±ê³µ ì‹œì—ëŠ” <strong>ì‹¤íŒ¨ ì¹´ìš´í„° ì´ˆê¸°í™”</strong> , ìƒˆ ìŠ¤ëƒ…ìƒ·ìœ¼ë¡œ ìºì‹œ ê°±ì‹ .</p>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li>
        <p><strong>UI ì‹¤ì‹œê°„ ê°±ì‹ </strong> :</p>

        <ul>
          <li>
            <p>ë§ˆì§€ë§‰ ì „ì†¡ ì‹œê°ê³¼ ë¹„êµí•´ <strong>ì“°ë¡œí‹€(<code class="language-plaintext highlighter-rouge">UI_UPDATE_GAP_S</code>)</strong>ì„ ë§Œì¡±í•  ë•Œ í…Œì´ë¸”ì„ ì¬ì „ì†¡.</p>
          </li>
          <li>
            <p>UI ì „ì†¡ ì‹¤íŒ¨ëŠ” ë¬´ì‹œí•˜ê³  ë‹¤ìŒ ë£¨í”„ ì§„í–‰.</p>
          </li>
        </ul>
      </li>
      <li>
        <p><strong>ì¢…ë£Œ ì¡°ê±´</strong> :</p>

        <ul>
          <li>
            <p>ëª¨ë“  Job IDê°€ <strong>í„°ë¯¸ë„ ìƒíƒœ(DONE/EXIT)</strong>.</p>
          </li>
          <li>
            <p>ë˜ëŠ” <strong>ì „ì²´ ëŒ€ê¸° íƒ€ì„ì•„ì›ƒ</strong>(<code class="language-plaintext highlighter-rouge">MAX_WAIT_S</code>ê°€ Noneì´ ì•„ë‹ˆê³  ê²½ê³¼).</p>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ìµœì¢… UI ì—…ë°ì´íŠ¸ &amp; ì •ë¦¬</strong></p>

    <ul>
      <li>
        <p>ë§ˆì§€ë§‰ ìƒíƒœë¥¼ UIì— <strong>1íšŒ ë”</strong> ë°˜ì˜(ì“°ë¡œí‹€ ì—†ì´).</p>
      </li>
      <li>
        <p>ì‹¤í–‰ ìš”ì•½(JSON)ì„ <strong><code class="language-plaintext highlighter-rouge">runs/</code> ë””ë ‰í† ë¦¬</strong>ì— <strong>íŒŒì¼ë¡œ ì €ì¥</strong>(ì œì¶œÂ·ì™„ë£Œ ì‹œê°, ì†Œìš” ì‹œê°„, ìµœì¢… ìƒíƒœ, ì‹¤íŒ¨ ì œì¶œ, ì‚¬ìš©í•œ ìƒìˆ˜ ê¸°ë¡ ë“±).</p>
      </li>
      <li>
        <p>ë…¸ë“œ ì¶œë ¥ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">job_ids</code>(ë¬¸ìì—´), <code class="language-plaintext highlighter-rouge">results_json</code>(ìš”ì•½ JSON ë¬¸ìì—´)ì„ ë°˜í™˜.</p>
      </li>
    </ul>
  </li>
</ol>

<hr />

<h1 id="ì¥ì• ì—ëŸ¬-ëŒ€ì‘-ì „ëµì•ˆ-ì£½ëŠ”-ë°©í–¥">ì¥ì• /ì—ëŸ¬ ëŒ€ì‘ ì „ëµ(ì•ˆ ì£½ëŠ” ë°©í–¥)</h1>

<ul>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">bsub</code> ì œì¶œ ì‹¤íŒ¨/íƒ€ì„ì•„ì›ƒ</strong>:</p>

    <ul>
      <li>
        <p>í•´ë‹¹ ë¼ì¸ë§Œ ì‹¤íŒ¨ë¡œ ê¸°ë¡(<code class="language-plaintext highlighter-rouge">failed_submissions</code>ì— ë³´ì¡´)í•˜ê³  <strong>ë‚˜ë¨¸ì§€ëŠ” ê³„ì† ì§„í–‰</strong>.</p>
      </li>
      <li>
        <p>ì „ì²´ ë…¸ë“œëŠ” ê·¸ëŒ€ë¡œ ë™ì‘í•´ ì œì¶œëœ ì¡ë“¤ì— ëŒ€í•´ í´ë§ì„ ê³„ì†í•¨.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">bjobs -a</code> ì‹¤íŒ¨/íƒ€ì„ì•„ì›ƒ/ì˜ˆì™¸</strong>:</p>

    <ul>
      <li>
        <p><strong>ì˜ˆì™¸ë¥¼ ë˜ì§€ì§€ ì•Šê³ </strong> ì‹¤íŒ¨ë¡œ ê°„ì£¼ â†’ <strong>ì—°ì† ì‹¤íŒ¨ ì¹´ìš´í„° ì¦ê°€</strong> &amp; <strong>ë°±ì˜¤í”„ ì§„ì…</strong>.</p>
      </li>
      <li>
        <p>ë°±ì˜¤í”„ ë™ì•ˆì€ <strong>ë§ˆì§€ë§‰ ìŠ¤ëƒ…ìƒ·(ìºì‹œ)</strong>ë¥¼ ì‚¬ìš©í•´ í´ë§ ë£¨í”„ë¥¼ ìœ ì§€(ì¦‰, ë…¸ë“œê°€ ì£½ì§€ ì•ŠìŒ).</p>
      </li>
      <li>
        <p><strong>ìµœì†Œ ì¬í˜¸ì¶œ ê°„ê²©</strong> ê³¼ <strong>ë¹„ì°¨ë‹¨ ë½</strong> ìœ¼ë¡œ ë™ì‹œ ë‹¤ë°œ <code class="language-plaintext highlighter-rouge">bjobs -a</code> ë°œìƒì„ ì–µì œ.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>UI ì—…ë°ì´íŠ¸ ì‹¤íŒ¨</strong> :</p>

    <ul>
      <li><strong>ë¬´ì‹œ</strong> í•˜ê³  ë‹¤ìŒ ë£¨í”„ ì§„í–‰(ì¡ ì»¨íŠ¸ë¡¤ê³¼ ë¬´ê´€í•œ ë¶€ê°€ ê¸°ëŠ¥ì´ë¯€ë¡œ).</li>
    </ul>
  </li>
  <li>
    <p><strong>íŒŒì¼ ë½ ë¯¸ì§€ì›(Windows ë“±)</strong> :</p>

    <ul>
      <li>ë½ ì—†ì´ë„ ë™ì‘í•˜ì§€ë§Œ <strong>ê²½ìŸ ê°€ëŠ¥ì„± ì¦ê°€</strong> ëŠ” ê°ìˆ˜. (POSIX í™˜ê²½ì´ë©´ fcntl ë½ì´ ì ìš©ë¨)</li>
    </ul>
  </li>
</ul>

<hr />

<h1 id="ë™ì‹œì„±ì„±ëŠ¥-í¬ì¸íŠ¸">ë™ì‹œì„±/ì„±ëŠ¥ í¬ì¸íŠ¸</h1>

<ul>
  <li>
    <p><strong>2ê³„ì¸µ ìºì‹œ</strong> ë¡œ ëŒ€ë¶€ë¶„ì˜ ì¡°íšŒë¥¼ <strong>ë©”ëª¨ë¦¬ì—ì„œ ì²˜ë¦¬</strong> â†’ íŒŒì¼ I/O ìµœì†Œí™”.</p>
  </li>
  <li>
    <p><strong>TTL + ìµœì†Œ ê°„ê²© + ë½</strong> ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">bjobs -a</code> í˜¸ì¶œì„ <strong>ìµœì†Œí™”</strong>.</p>
  </li>
  <li>
    <p><strong>ì§€ìˆ˜ ë°±ì˜¤í”„</strong> ë¡œ ì¥ì•  ì‹œì—ë„ <strong>ì„œë²„/ìŠ¤ì¼€ì¤„ëŸ¬ì— ë¶€ë‹´ì„ ì£¼ì§€ ì•ŠìŒ</strong>.</p>
  </li>
  <li>
    <p><strong>ë°°ì¹˜ ì œí•œ ì œì¶œ</strong> ë¡œ í/ë¡œê·¸ì¸ ë…¸ë“œ ë¶€ë‹´ ë¶„ì‚°.</p>
  </li>
  <li>
    <p><strong>UI ì“°ë¡œí‹€</strong> ë¡œ í”„ë¡ íŠ¸ ê³¼ë„í•œ ë¦¬ë Œë” ë°©ì§€.</p>
  </li>
</ul>

<hr />

<h1 id="ì‹¤ì‚¬ìš©-íŒ">ì‹¤ì‚¬ìš© íŒ</h1>

<ul>
  <li>
    <p>í”„ë¡ íŠ¸ì—”ë“œì—ëŠ” ê°„ë‹¨í•œ <strong>ì»¤ìŠ¤í…€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ</strong>(â€œimpact-node-feedbackâ€)ë¥¼ ë„£ì–´ì•¼ <code class="language-plaintext highlighter-rouge">status_md</code> ìœ„ì ¯ì´ ëŸ°íƒ€ì„ì— ê°±ì‹ ë¼ìš”.</p>
  </li>
  <li>
    <p>ìƒìˆ˜ëŠ” <strong>í™˜ê²½/ì •ì±…ì— ë§ê²Œ</strong> íŒŒì¼ ìƒë‹¨ì—ì„œë§Œ ì¡°ì •í•˜ë©´ ë©ë‹ˆë‹¤. (ì˜ˆ: ëŒ€í˜• í´ëŸ¬ìŠ¤í„°ë¼ë©´ <code class="language-plaintext highlighter-rouge">MIN_REFRESH_GAP_S</code>/<code class="language-plaintext highlighter-rouge">FULL_TTL_S</code>ë¥¼ ëŠ˜ë ¤ <code class="language-plaintext highlighter-rouge">bjobs</code> ë¶€í•˜ë¥¼ ë” ë‚®ì¶œ ìˆ˜ ìˆìŒ)</p>
  </li>
  <li>
    <p>ìºì‹œ ìœ„ì¹˜ëŠ” ê¸°ë³¸ <code class="language-plaintext highlighter-rouge">/tmp/comfyui_lsf_cache</code>ì´ë©°, í•„ìš”í•˜ë©´ <code class="language-plaintext highlighter-rouge">COMFYUI_LSF_CACHE_DIR</code>ë¡œ ë°”ê¿€ ìˆ˜ ìˆì–´ìš”.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">results_json</code> íŒŒì¼ ë¡œê·¸(<code class="language-plaintext highlighter-rouge">runs/</code>)ë¡œ <strong>ì‚¬í›„ ë¶„ì„/ê°ì‚¬</strong> ê°€ ê°€ëŠ¥.</p>
  </li>
</ul>

<hr />

<p>í•„ìš”í•˜ë©´ ìƒìˆ˜ë“¤ì˜ ì¶”ì²œê°’(ì‘ì—… ê·œëª¨/í ì •ì±…ë³„ í”„ë¡œíŒŒì¼)ë„ ì •ë¦¬í•´ ì¤„ê²Œ.</p>]]></content><author><name>hvppyarchive</name></author><category term="comfyui" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">Python ë¹„ë™ê¸° ì„œë¸Œí”„ë¡œì„¸ìŠ¤ ì‹¤í–‰</title><link href="https://hvppyarchive.github.io/python/python-async-subprocess/" rel="alternate" type="text/html" title="Python ë¹„ë™ê¸° ì„œë¸Œí”„ë¡œì„¸ìŠ¤ ì‹¤í–‰" /><published>2025-10-10T14:05:19+09:00</published><updated>2025-10-10T14:05:19+09:00</updated><id>https://hvppyarchive.github.io/python/python-async-subprocess</id><content type="html" xml:base="https://hvppyarchive.github.io/python/python-async-subprocess/"><![CDATA[<p class="chat--user">

Pythonì—ì„œ subprocessë¥¼ async taskë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆì–´?

</p>

<p>ë„¤â€”ê°€ëŠ¥í•©ë‹ˆë‹¤. â€œë¹„ë™ê¸°ì ìœ¼ë¡œ ì„œë¸Œí”„ë¡œì„¸ìŠ¤ ì‹¤í–‰â€ì€ ë³´í†µ ë‘ ê°€ì§€ ë°©ì‹ì´ ìˆì–´ìš”.</p>

<h2 id="1-asyncioê°€-ì œê³µí•˜ëŠ”-ì§„ì§œ-ë¹„ë™ê¸°-ì„œë¸Œí”„ë¡œì„¸ìŠ¤-api-ì“°ê¸°">1) <code class="language-plaintext highlighter-rouge">asyncio</code>ê°€ ì œê³µí•˜ëŠ” <strong>ì§„ì§œ ë¹„ë™ê¸° ì„œë¸Œí”„ë¡œì„¸ìŠ¤</strong> API ì“°ê¸°</h2>

<p>í•µì‹¬ì€ <code class="language-plaintext highlighter-rouge">asyncio.create_subprocess_exec()</code>(ë˜ëŠ” <code class="language-plaintext highlighter-rouge">create_subprocess_shell()</code>)ì…ë‹ˆë‹¤. ë°˜í™˜ê°’ì¸ <code class="language-plaintext highlighter-rouge">Process</code>ì—ëŠ” <code class="language-plaintext highlighter-rouge">wait()</code>, <code class="language-plaintext highlighter-rouge">communicate()</code> ê°™ì€ <strong><code class="language-plaintext highlighter-rouge">await</code> ê°€ëŠ¥í•œ</strong> ë©”ì„œë“œê°€ ìˆì–´ì„œ ì´ë²¤íŠ¸ ë£¨í”„ë¥¼ ë§‰ì§€ ì•Šì•„ìš”.</p>

<h3 id="a-ì¶œë ¥-ì „ì²´-í•œ-ë²ˆì—-ë°›ê¸°">(A) ì¶œë ¥ ì „ì²´ í•œ ë²ˆì— ë°›ê¸°</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span> <span class="k">as</span> <span class="n">asp</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
        <span class="n">sys</span><span class="p">.</span><span class="n">executable</span><span class="p">,</span> <span class="sh">"</span><span class="s">-u</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-c</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">import time; [print(i) or time.sleep(0.3) for i in range(5)]</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">asp</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">asp</span><span class="p">.</span><span class="n">PIPE</span>
    <span class="p">)</span>
    <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">()</span>   <span class="c1"># ë‘˜ ë‹¤ bytes
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">RC:</span><span class="sh">"</span><span class="p">,</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDOUT:</span><span class="sh">"</span><span class="p">,</span> <span class="n">out</span><span class="p">.</span><span class="nf">decode</span><span class="p">())</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDERR:</span><span class="sh">"</span><span class="p">,</span> <span class="n">err</span><span class="p">.</span><span class="nf">decode</span><span class="p">())</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<h3 id="b-ìŠ¤íŠ¸ë¦¬ë°-ìœ¼ë¡œ-ì¤„-ë‹¨ìœ„-ì½ê¸°-ê¸´-ì‘ì—…ì‹¤ì‹œê°„-ë¡œê·¸ìš©">(B) <strong>ìŠ¤íŠ¸ë¦¬ë°</strong> ìœ¼ë¡œ ì¤„ ë‹¨ìœ„ ì½ê¸° (ê¸´ ì‘ì—…/ì‹¤ì‹œê°„ ë¡œê·¸ìš©)</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span> <span class="k">as</span> <span class="n">asp</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
        <span class="n">sys</span><span class="p">.</span><span class="n">executable</span><span class="p">,</span> <span class="sh">"</span><span class="s">-u</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-c</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">import time,sys</span><span class="se">\n</span><span class="s">for i in range(5):</span><span class="se">\n</span><span class="s"> print(i); sys.stdout.flush(); time.sleep(0.3)</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">asp</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">asp</span><span class="p">.</span><span class="n">STDOUT</span>
    <span class="p">)</span>

    <span class="k">async</span> <span class="k">for</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">proc</span><span class="p">.</span><span class="n">stdout</span><span class="p">:</span>  <span class="c1"># bytes ìŠ¤íŠ¸ë¦¼
</span>        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">&gt; </span><span class="sh">"</span><span class="p">,</span> <span class="n">raw</span><span class="p">.</span><span class="nf">decode</span><span class="p">().</span><span class="nf">rstrip</span><span class="p">())</span>

    <span class="n">rc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">()</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">RC:</span><span class="sh">"</span><span class="p">,</span> <span class="n">rc</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p><strong>í¬ì¸íŠ¸</strong></p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">stdout=PIPE</code>, <code class="language-plaintext highlighter-rouge">stderr=PIPE/STDOUT</code>ë¡œ íŒŒì´í”„ ì—°ê²°.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">communicate()</code>ëŠ” ì¢…ë£Œê¹Œì§€ ê¸°ë‹¤ë¦¬ë©° ì „ë¶€ ëª¨ì•„ ë°˜í™˜.</p>
  </li>
  <li>
    <p>ì‹¤ì‹œê°„ì´ í•„ìš”í•˜ë©´ <code class="language-plaintext highlighter-rouge">async for proc.stdout</code>ë¡œ ì½ê¸°.</p>
  </li>
  <li>
    <p>íŒŒì´ì¬ í•˜ìœ„ í”„ë¡œì„¸ìŠ¤ëŠ” <code class="language-plaintext highlighter-rouge">-u</code>(unbuffered)ë¡œ ë²„í¼ë§ ì§€ì—°ì„ ì¤„ì´ëŠ” ê²Œ ì¢‹ì•„ìš”.</p>
  </li>
</ul>

<h2 id="2-ê¸°ì¡´ì˜-ë¸”ë¡œí‚¹-subprocessrunì„-ìŠ¤ë ˆë“œë¡œ-ëŒë¦¬ê¸°">2) ê¸°ì¡´ì˜ <strong>ë¸”ë¡œí‚¹</strong> <code class="language-plaintext highlighter-rouge">subprocess.run()</code>ì„ ìŠ¤ë ˆë“œë¡œ ëŒë¦¬ê¸°</h2>

<p>ë ˆê±°ì‹œ ì½”ë“œë‚˜ ê°„ë‹¨í•œ í˜¸ì¶œì„ ê·¸ëŒ€ë¡œ ì“°ê³  ì‹¶ë‹¤ë©´, ì´ë²¤íŠ¸ ë£¨í”„ëŠ” ì‚´ë¦¬ê³  ì‘ì—…ë§Œ ìŠ¤ë ˆë“œë¡œ ë„˜ê¸¸ ìˆ˜ ìˆì–´ìš”.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">subprocess</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_blocking</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
    <span class="c1"># Python 3.9+: to_thread ê¶Œì¥
</span>    <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">to_thread</span><span class="p">(</span>
        <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
        <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="bp">False</span>
    <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_blocking</span><span class="p">([</span><span class="sh">"</span><span class="s">git</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">])</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">stdout</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p><strong>í¬ì¸íŠ¸</strong></p>

<ul>
  <li>
    <p>ì´ ë°©ë²•ì€ <em>ì§„ì§œ ë¹„ë™ê¸° I/O</em> ëŠ” ì•„ë‹ˆê³ , <strong>ìŠ¤ë ˆë“œ í•˜ë‚˜ë¥¼ ì°¨ì§€</strong> í•´ì„œ ë¸”ë¡œí‚¹ í˜¸ì¶œì„ ìš°íšŒí•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì…ì¶œë ¥ì„ ì¤„ ë‹¨ìœ„ë¡œ ì‹¤ì‹œê°„ ì²˜ë¦¬í•˜ê¸´ ë¶ˆí¸í•˜ê³ , â€œëë‚˜ë©´ ê²°ê³¼â€ê°€ í•„ìš”í•œ ê²½ìš°ì— ì í•©.</p>
  </li>
</ul>

<hr />

<h2 id="ì—¬ëŸ¬-í”„ë¡œì„¸ìŠ¤ë¥¼-ë™ì‹œì—-ëŒë¦¬ê¸°">ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤ë¥¼ <strong>ë™ì‹œì—</strong> ëŒë¦¬ê¸°</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span> <span class="k">as</span> <span class="n">asp</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
        <span class="n">sys</span><span class="p">.</span><span class="n">executable</span><span class="p">,</span> <span class="sh">"</span><span class="s">-u</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-c</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">print(</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s">)</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">asp</span><span class="p">.</span><span class="n">PIPE</span>
    <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">procs</span> <span class="o">=</span> <span class="p">[</span><span class="k">await</span> <span class="nf">run_one</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
    <span class="n">outs</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">gather</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">communicate</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">procs</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">_err</span><span class="p">)</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">outs</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">out</span><span class="p">.</span><span class="nf">decode</span><span class="p">().</span><span class="nf">strip</span><span class="p">())</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<h2 id="íƒ€ì„ì•„ì›ƒì·¨ì†Œì •ë¦¬ì¤‘ìš”">íƒ€ì„ì•„ì›ƒ/ì·¨ì†Œ/ì •ë¦¬(ì¤‘ìš”)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span> <span class="k">as</span> <span class="n">asp</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">safe_run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">asp</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">asp</span><span class="p">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
        <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>                 <span class="c1"># or proc.terminate()
</span>        <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">()</span>           <span class="c1"># ì¢€ë¹„ ë°©ì§€
</span>        <span class="k">raise</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
        <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">()</span>
        <span class="k">raise</span>
</code></pre></div></div>

<h2 id="í”Œë«í¼ì£¼ì˜ì‚¬í•­-í•œëˆˆì—">í”Œë«í¼/ì£¼ì˜ì‚¬í•­ í•œëˆˆì—</h2>

<ul>
  <li>
    <p><strong>Windows</strong> : íŒŒì´í”„ê°€ ì—°ê²°ëœ ì„œë¸Œí”„ë¡œì„¸ìŠ¤ëŠ” Python â‰¥3.8ì˜ ê¸°ë³¸ ì´ë²¤íŠ¸ ë£¨í”„(í”„ë¡œì•¡í„°)ì—ì„œ ì˜ ë™ì‘í•©ë‹ˆë‹¤. (ì•„ì£¼ ì˜› ë²„ì „ì€ <code class="language-plaintext highlighter-rouge">ProactorEventLoop</code> í•„ìš”)</p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">shell=True</code></strong>ëŠ” í¸í•˜ì§€ë§Œ ì¸ì ì´ìŠ¤ì¼€ì´í”„/ë³´ì•ˆ ì´ìŠˆê°€ ìˆìœ¼ë‹ˆ ê¼­ í•„ìš”í•œ ê²½ìš°ë§Œ ì‚¬ìš©í•˜ì„¸ìš”.</p>
  </li>
  <li>
    <p><strong>ëŒ€ìš©ëŸ‰ ì¶œë ¥</strong> ì„ í•œêº¼ë²ˆì— <code class="language-plaintext highlighter-rouge">communicate()</code>ë¡œ ë°›ìœ¼ë©´ ë©”ëª¨ë¦¬ë¥¼ ë§ì´ ë¨¹ì„ ìˆ˜ ìˆì–´ìš”. ì´ëŸ° ê²½ìš° (B)ì²˜ëŸ¼ ìŠ¤íŠ¸ë¦¬ë°ì´ ì•ˆì „í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>í…ìŠ¤íŠ¸ ë””ì½”ë”©</strong> : <code class="language-plaintext highlighter-rouge">asyncio.subprocess</code>ëŠ” <strong>bytes</strong> ë¥¼ ì¤ë‹ˆë‹¤. <code class="language-plaintext highlighter-rouge">.decode()</code> ì§ì ‘ í˜¸ì¶œí•˜ê±°ë‚˜ <code class="language-plaintext highlighter-rouge">codecs.StreamReader</code>ë¡œ ê°ì‹¸ì„¸ìš”.</p>
  </li>
  <li>
    <p><strong>í”„ë¡œì„¸ìŠ¤ ê·¸ë£¹</strong> : ë¦¬ëˆ…ìŠ¤/ë§¥ì—ì„œ í•˜ìœ„ íŠ¸ë¦¬ê¹Œì§€ ì¢…ë£Œí•˜ë ¤ë©´ <code class="language-plaintext highlighter-rouge">start_new_session=True</code>ë¡œ ìƒˆ ì„¸ì…˜ ì‹œì‘ í›„, í•„ìš” ì‹œ <code class="language-plaintext highlighter-rouge">os.killpg()</code> ì‚¬ìš©(ê³ ê¸‰ ì£¼ì œ).</p>
  </li>
</ul>

<hr />

<h3 id="ìš”ì•½">ìš”ì•½</h3>

<ul>
  <li>
    <p>â€œì´ë²¤íŠ¸ ë£¨í”„ë¥¼ ë§‰ì§€ ì•Šê³ â€ ì„œë¸Œí”„ë¡œì„¸ìŠ¤ë¥¼ ëŒë¦¬ë ¤ë©´: <strong><code class="language-plaintext highlighter-rouge">asyncio.create_subprocess_exec/shell</code></strong>ì„ ì“°ì„¸ìš”.</p>
  </li>
  <li>
    <p>ê¸°ì¡´ ë¸”ë¡œí‚¹ ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ì“°ê³  ì‹¶ë‹¤ë©´: <strong><code class="language-plaintext highlighter-rouge">asyncio.to_thread(subprocess.run, ...)</code></strong>ìœ¼ë¡œ ê°ì‹¸ì„¸ìš”.</p>
  </li>
  <li>
    <p>ìŠ¤íŠ¸ë¦¬ë°, ë³‘ë ¬ ì‹¤í–‰, íƒ€ì„ì•„ì›ƒ/ì·¨ì†Œê¹Œì§€ ìœ„ ì˜ˆì œ íŒ¨í„´ì´ë©´ ëŒ€ë¶€ë¶„ì˜ ì¼€ì´ìŠ¤ë¥¼ ì»¤ë²„í•©ë‹ˆë‹¤.</p>
  </li>
</ul>

<p class="chat--user">

async def main(): proc = await asyncio.create_subprocess_exec( sys.executable, "-u", "-c", "import time; [print(i) or time.sleep(0.3) for i in range(5)]", stdout=asp.PIPE, stderr=asp.PIPE ) out, err = await proc.communicate() # ë‘˜ ë‹¤ bytes print("RC:", proc.returncode) print("STDOUT:", out.decode()) print("STDERR:", err.decode()) ì´ ë™ì‘ì„ taskë¡œ ë§Œë“¤ê³  ì‹¶ì–´.

</p>

<p>ê°€ëŠ¥í•˜ì£ ! í•µì‹¬ì€ â€œì„œë¸Œí”„ë¡œì„¸ìŠ¤ë¥¼ ëŒë¦¬ëŠ” ì½”ë£¨í‹´â€ì„ í•˜ë‚˜ ë§Œë“¤ê³ , ê·¸ê±¸ <code class="language-plaintext highlighter-rouge">asyncio.create_task()</code>ë¡œ ìŠ¤ì¼€ì¤„í•˜ëŠ” ê²ë‹ˆë‹¤. ì•„ë˜ë¥¼ ê·¸ëŒ€ë¡œ ë¶™ì—¬ ë„£ì–´ ì“°ì„¸ìš”.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">asyncio.subprocess</span> <span class="k">as</span> <span class="n">asp</span>

<span class="c1"># 1) ì„œë¸Œí”„ë¡œì„¸ìŠ¤ë¥¼ ì‹¤í–‰í•˜ê³  ê²°ê³¼ë¥¼ ë°˜í™˜í•˜ëŠ” ì½”ë£¨í‹´
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">run_subprocess</span><span class="p">():</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
        <span class="n">sys</span><span class="p">.</span><span class="n">executable</span><span class="p">,</span> <span class="sh">"</span><span class="s">-u</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-c</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">import time; [print(i) or time.sleep(0.3) for i in range(5)]</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">asp</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">asp</span><span class="p">.</span><span class="n">PIPE</span>
    <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">()</span>  <span class="c1"># bytes íŠœí”Œ
</span>        <span class="k">return</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">out</span><span class="p">.</span><span class="nf">decode</span><span class="p">(),</span> <span class="n">err</span><span class="p">.</span><span class="nf">decode</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
        <span class="c1"># ì·¨ì†Œ ì‹œ ê¹”ë”í•˜ê²Œ ì¢…ë£Œ(ì¢€ë¹„ ë°©ì§€)
</span>        <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">()</span>
        <span class="k">raise</span>

<span class="c1"># 2) ìœ„ ì½”ë£¨í‹´ì„ Taskë¡œ ë§Œë“¤ì–´ ë™ì‹œ ì‹¤í–‰
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">run_subprocess</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">my-subprocess-task</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># (ì„ íƒ) ì—¬ê¸°ì„œ ë‹¤ë¥¸ ë¹„ë™ê¸° ì‘ì—…ë“¤ì„ ë³‘í–‰í•  ìˆ˜ ìˆìŒ
</span>    <span class="c1"># await do_other_async_work()
</span>
    <span class="c1"># (ì„ íƒ) íƒ€ì„ì•„ì›ƒì„ ê±¸ê³  ì‹¶ë‹¤ë©´:
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
        <span class="n">task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">task</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">raise</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">RC:</span><span class="sh">"</span><span class="p">,</span> <span class="n">rc</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDOUT:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDERR:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<h3 id="í¬ì¸íŠ¸-í•œê±¸ìŒì”©">í¬ì¸íŠ¸ (í•œê±¸ìŒì”©)</h3>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">run_subprocess()</code>ëŠ” <strong>ì„œë¸Œí”„ë¡œì„¸ìŠ¤ ìƒëª…ì£¼ê¸°</strong> ë¥¼ ì±…ì„ì§€ëŠ” ì½”ë£¨í‹´ì…ë‹ˆë‹¤.</p>

    <ul>
      <li>
        <p>ì •ìƒ ì™„ë£Œ ì‹œ <code class="language-plaintext highlighter-rouge">(returncode, stdout(str), stderr(str))</code>ë¥¼ ë°˜í™˜.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">CancelledError</code>ì—ì„œ <code class="language-plaintext highlighter-rouge">kill()</code>+<code class="language-plaintext highlighter-rouge">wait()</code>ë¡œ ì •ë¦¬(í•„ìˆ˜).</p>
      </li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">main()</code>ì—ì„œ <code class="language-plaintext highlighter-rouge">asyncio.create_task(...)</code>ë¡œ <strong>Task</strong> ë¥¼ ë§Œë“¤ë©´, ì´ë²¤íŠ¸ ë£¨í”„ëŠ” ì´ ì‘ì—…ì„ ë°±ê·¸ë¼ìš´ë“œë¡œ ì§„í–‰í•˜ê³ , í•„ìš”í•  ë•Œ <code class="language-plaintext highlighter-rouge">await task</code>ë¡œ ê²°ê³¼ë¥¼ íšŒìˆ˜í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>íƒ€ì„ì•„ì›ƒ</strong> ì€ <code class="language-plaintext highlighter-rouge">asyncio.wait_for(task, timeout=...)</code>ë¡œ ê°ì‹¸ê³ , ë§Œë£Œ ì‹œ <code class="language-plaintext highlighter-rouge">task.cancel()</code> í›„ ì •ë¦¬.</p>
  </li>
  <li>
    <p>ì‹¤ì‹œê°„ ë¡œê·¸ê°€ í•„ìš”í•˜ë©´, <code class="language-plaintext highlighter-rouge">communicate()</code> ëŒ€ì‹  <code class="language-plaintext highlighter-rouge">async for line in proc.stdout:</code> íŒ¨í„´ì„ <code class="language-plaintext highlighter-rouge">run_subprocess()</code> ì•ˆì— ë„£ìœ¼ë©´ ë©ë‹ˆë‹¤(ê·¸ ê²½ìš° ë¬¸ìì—´ì„ ëˆ„ì í•´ì„œ ë°˜í™˜í•˜ê±°ë‚˜ ì½œë°±/íë¡œ ì „ë‹¬).</p>
  </li>
</ol>

<p>ì›í•˜ë©´, ê°™ì€ íŒ¨í„´ìœ¼ë¡œ ì—¬ëŸ¬ ê°œë¥¼ ë™ì‹œì— ëŒë¦´ ìˆ˜ë„ ìˆì–´ìš”:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">main_many</span><span class="p">():</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">run_subprocess</span><span class="p">())</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">as_completed</span><span class="p">(</span><span class="n">tasks</span><span class="p">):</span>
        <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="n">t</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">done:</span><span class="sh">"</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div></div>

<p>ì´ë ‡ê²Œ í•˜ë©´ â€œì„œë¸Œí”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ â†’ Taskë¡œ ìŠ¤ì¼€ì¤„ â†’ ê²°ê³¼ ëŒ€ê¸°/ì·¨ì†Œ/íƒ€ì„ì•„ì›ƒâ€ê¹Œì§€ ê¹”ë”í•˜ê²Œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</p>

<p class="chat--user">

proc = await asyncio.create_subprocess_exec( sys.executable, "-u", "-c", "import time; [print(i) or time.sleep(0.3) for i in range(5)]", stdout=asp.PIPE, stderr=asp.PIPE ) ì´ ì½”ë“œë¥¼ try ì•ˆì— ë„£ì§€ ì•ŠëŠ” ì´ìœ ê°€ ìˆì–´?

</p>

<p>ì§§ê²Œ ë§í•˜ë©´: <strong>ì •ë¦¬(cleanup)ê°€ í•„ìš”í•œ êµ¬ê°„ë§Œ<code class="language-plaintext highlighter-rouge">try</code>ë¡œ ê°ì‹¸ê¸°</strong> ìœ„í•´ì„œì˜ˆìš”.<br />
<code class="language-plaintext highlighter-rouge">create_subprocess_exec()</code> í˜¸ì¶œ ìì²´ëŠ” â€œì•„ì§ í”„ë¡œì„¸ìŠ¤ê°€ ì—†ê±°ë‚˜(ìƒì„± ì „) ê³§ë°”ë¡œ ì‹¤íŒ¨í•˜ëŠ”â€ ë‹¨ê³„ë¼ì„œ, ì—¬ê¸°ì„œ ì˜ˆì™¸/ì·¨ì†Œê°€ ë‚˜ë©´ <strong>ì •ë¦¬í•  ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.</strong></p>

<p>step-by-stepë¡œ ë³´ë©´:</p>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">await asyncio.create_subprocess_exec(...)</code></p>

    <ul>
      <li>
        <p>ì—¬ê¸°ì„œ <strong>ì·¨ì†Œ(<code class="language-plaintext highlighter-rouge">CancelledError</code>)</strong>ê°€ ë‚˜ë©´ í”„ë¡œì„¸ìŠ¤ëŠ” ë§Œë“¤ì–´ì§€ì§€ ì•Šì•˜ìœ¼ë‹ˆ kill/wait ë¶ˆí•„ìš”.</p>
      </li>
      <li>
        <p>ì‹¤í–‰ íŒŒì¼ ì—†ìŒ ë“±ìœ¼ë¡œ <strong><code class="language-plaintext highlighter-rouge">FileNotFoundError</code>/<code class="language-plaintext highlighter-rouge">OSError</code></strong>ê°€ ë‚˜ë©´ ì—­ì‹œ í”„ë¡œì„¸ìŠ¤ê°€ ì—†ìœ¼ë‹ˆ ì •ë¦¬í•  ê²Œ ì—†ìŒ.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>í”„ë¡œì„¸ìŠ¤ê°€ <strong>ì„±ê³µì ìœ¼ë¡œ ë§Œë“¤ì–´ì§„ ë’¤</strong> ì—ì•¼ <code class="language-plaintext highlighter-rouge">proc</code>ê°€ ìƒê¹ë‹ˆë‹¤.</p>

    <ul>
      <li>
        <p>ì´í›„ <code class="language-plaintext highlighter-rouge">await proc.communicate()</code>ì—ì„œ ì·¨ì†Œ/íƒ€ì„ì•„ì›ƒì´ ë‚˜ë©´ <strong>ì¢€ë¹„ ë°©ì§€</strong> ë¥¼ ìœ„í•´ <code class="language-plaintext highlighter-rouge">proc.kill(); await proc.wait()</code>ê°€ í•„ìš”í•˜ì£ .</p>
      </li>
      <li>
        <p>ê·¸ë˜ì„œ <code class="language-plaintext highlighter-rouge">try/except</code>ëŠ” ì´ <strong>ë‘ ë²ˆì§¸ êµ¬ê°„</strong>(communicate/ëŒ€ê¸° êµ¬ê°„)ì—ë§Œ ë‘ëŠ” ê²Œ ë§ìŠµë‹ˆë‹¤.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>ë˜ ë‹¤ë¥¸ ì´ìœ :</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">create_subprocess_exec()</code>ë¥¼ <code class="language-plaintext highlighter-rouge">try</code> ì•ˆì— ë‘ë©´, ì˜ˆì™¸ íë¦„ì— ë”°ë¼ <code class="language-plaintext highlighter-rouge">proc</code>ê°€ <strong>ì •ì˜ë˜ì§€ ì•Šì€ ìƒíƒœì—ì„œ</strong> <code class="language-plaintext highlighter-rouge">proc.kill()</code>ì„ í˜¸ì¶œí•  ìœ„í—˜ì´ ìƒê¹ë‹ˆë‹¤(ë ˆí¼ëŸ°ìŠ¤ê°€ ì—†ì–´ì„œ ë˜ ë‹¤ë¥¸ ì˜ˆì™¸ ìœ ë°œ).</p>
      </li>
      <li>
        <p>â€œì·¨ì†Œ ì‹ í˜¸ê°€ ìƒì„± ì§í›„~<code class="language-plaintext highlighter-rouge">try</code> ì§„ì… ì‚¬ì´ì— ë“¤ì–´ì˜¤ë©´ ì–´ë–¡í•´ìš”?â€ â†’ ì·¨ì†ŒëŠ” <strong>ë‹¤ìŒ<code class="language-plaintext highlighter-rouge">await</code> ì§€ì ì—ì„œ</strong> ë˜ì ¸ì§€ë¯€ë¡œ, ìƒì„±ì´ ëë‚˜ê³  <code class="language-plaintext highlighter-rouge">try</code> ë¸”ë¡ìœ¼ë¡œ ë“¤ì–´ê°„ ë’¤ì˜ <code class="language-plaintext highlighter-rouge">await</code>(ì˜ˆ: <code class="language-plaintext highlighter-rouge">communicate</code>)ì—ì„œ ì²˜ë¦¬ë©ë‹ˆë‹¤. ë ˆì´ìŠ¤ ê±±ì • ì—†ìŒ.</p>
      </li>
    </ul>
  </li>
</ol>

<p>ì›í•œë‹¤ë©´ â€œìŠ¤í° ì‹¤íŒ¨â€ë§Œ ë³„ë„ë¡œ ë‹¤ë£¨ëŠ” 2ë‹¨ê³„ íŒ¨í„´ì´ ê°€ì¥ ê²¬ê³ í•©ë‹ˆë‹¤:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">asyncio.subprocess</span> <span class="k">as</span> <span class="n">asp</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_subprocess</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
            <span class="n">sys</span><span class="p">.</span><span class="n">executable</span><span class="p">,</span> <span class="sh">"</span><span class="s">-u</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-c</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">import time; [print(i) or time.sleep(0.3) for i in range(5)]</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">asp</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">asp</span><span class="p">.</span><span class="n">PIPE</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="nb">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># ì‹¤í–‰ íŒŒì¼ ì—†ìŒ/ê¶Œí•œ ë¬¸ì œ ë“±
</span>        <span class="c1"># ì—¬ê¸°ì„œëŠ” ì •ë¦¬í•  í”„ë¡œì„¸ìŠ¤ê°€ ì—†ìŒ
</span>        <span class="k">raise</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">out</span><span class="p">.</span><span class="nf">decode</span><span class="p">(),</span> <span class="n">err</span><span class="p">.</span><span class="nf">decode</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
        <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">()</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="c1"># ì›í•œë‹¤ë©´ ë‹¤ë¥¸ ì˜ˆì™¸ì—ì„œë„ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ë¥¼ ë³´ì¥
</span>        <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">()</span>
        <span class="k">raise</span>
</code></pre></div></div>

<p>ìš”ì•½: <strong>í”„ë¡œì„¸ìŠ¤ê°€ ìƒê¸´ ì´í›„ì—ë§Œ</strong> ì •ë¦¬ê°€ í•„ìš”í•˜ë¯€ë¡œ, ìƒì„± í˜¸ì¶œì€ <code class="language-plaintext highlighter-rouge">try</code> ë°–ì— ë‘ê³ , ëŒ€ê¸°/í†µì‹  êµ¬ê°„ì„ <code class="language-plaintext highlighter-rouge">try</code>ë¡œ ê°ì‹¸ëŠ” ê²Œ ê¹”ë”í•˜ê³  ì•ˆì „í•©ë‹ˆë‹¤.</p>

<p class="chat--user">

ê¸°ì¡´ ì½”ë“œì—ì„œ subprocess ì‹¤í–‰í•  ë•Œ preexec_fn=os.setsid, creationflags=0í•˜ê³ , êº¼ì§ˆ ë•ŒëŠ” getpgid(pid)í•´ì„œ ë‹¤ ê°™ì´ ë„ëŠ” ì½”ë“œê°€ ìˆì—ˆëŠ”ë° ì—¬ê¸°ì—ëŠ” í•„ìš”ì—†ì–´?

</p>

<p>ìš”ì§€ëŠ” ì´ê±°ì˜ˆìš”: <strong>â€œì „ì²´ í”„ë¡œì„¸ìŠ¤ ê·¸ë£¹ê¹Œì§€ í•œ ë²ˆì— ë„ê³  ì‹¶ë‹¤ë©´ í•„ìš”â€, ì•„ë‹ˆë©´ ë¶ˆí•„ìš”.</strong></p>

<p>step-by-stepë¡œ ì •ë¦¬í•˜ë©´:</p>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">asyncio.create_subprocess_exec()</code> ìì²´ëŠ” <strong>ë‹¨ì¼ í”„ë¡œì„¸ìŠ¤ë§Œ</strong> ê´€ë¦¬í•©ë‹ˆë‹¤.</p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">proc.terminate()</code>/<code class="language-plaintext highlighter-rouge">proc.kill()</code>ì€ <strong>ê·¸ í”„ë¡œì„¸ìŠ¤ë§Œ</strong> ì£½ì…ë‹ˆë‹¤. ìì‹Â·ì†ìê¹Œì§€ ë³´ì¥í•˜ì§€ ì•Šì•„ìš”.</li>
    </ul>
  </li>
  <li>
    <p>ê¸°ì¡´ì²˜ëŸ¼ â€œí”„ë¡œì„¸ìŠ¤ ê·¸ë£¹(íŠ¸ë¦¬) ì „ì²´ ì¢…ë£Œâ€ê°€ ëª©ì ì´ë©´, <strong>ìŠ¤í°í•  ë•Œ ê·¸ë£¹ì„ ë¶„ë¦¬</strong> í•´ì•¼ í•©ë‹ˆë‹¤.</p>

    <ul>
      <li>
        <p>POSIX(ë¦¬ëˆ…ìŠ¤/ë§¥): <code class="language-plaintext highlighter-rouge">preexec_fn=os.setsid</code> ëŒ€ì‹  <strong><code class="language-plaintext highlighter-rouge">start_new_session=True</code></strong>ê°€ ê¶Œì¥(ë™ì¼ íš¨ê³¼, ë” ì•ˆì „).</p>
      </li>
      <li>
        <p>ìœˆë„ìš°: <strong><code class="language-plaintext highlighter-rouge">creationflags=subprocess.CREATE_NEW_PROCESS_GROUP</code></strong>ë¡œ ìƒˆ ê·¸ë£¹.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>ì¢…ë£Œí•  ë•ŒëŠ” â€œê·¸ë£¹ ì‹ í˜¸â€ë¥¼ ë³´ë‚´ì•¼ í•©ë‹ˆë‹¤.</p>

    <ul>
      <li>
        <p>POSIX: <code class="language-plaintext highlighter-rouge">os.killpg(pgid, signal.SIGTERM)</code> â†’ ëŒ€ê¸° â†’ í•„ìš” ì‹œ <code class="language-plaintext highlighter-rouge">SIGKILL</code>.</p>
      </li>
      <li>
        <p>ìœˆë„ìš°: <code class="language-plaintext highlighter-rouge">proc.send_signal(signal.CTRL_BREAK_EVENT)</code>(ìƒˆ ê·¸ë£¹ìœ¼ë¡œ ë„ì› ì„ ë•Œë§Œ ë™ì‘) â†’ í•„ìš” ì‹œ <code class="language-plaintext highlighter-rouge">taskkill /T</code>.</p>
      </li>
    </ul>
  </li>
</ol>

<p>ì•„ë˜ëŠ” ì•ì„œ ë§Œë“  Task ë²„ì „ì— â€œê·¸ë£¹ ë¶„ë¦¬ + ê·¸ë£¹ ì¢…ë£Œâ€ë¥¼ ë¶™ì¸ ì˜ˆì‹œì…ë‹ˆë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">subprocess</span>
<span class="kn">import</span> <span class="n">asyncio.subprocess</span> <span class="k">as</span> <span class="n">asp</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_subprocess</span><span class="p">():</span>
    <span class="c1"># 1) í”Œë«í¼ë³„ë¡œ "ìƒˆ ê·¸ë£¹/ì„¸ì…˜"ë¡œ ìŠ¤í°
</span>    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">sys</span><span class="p">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="sh">"</span><span class="s">win32</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="sh">"</span><span class="s">start_new_session</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>          <span class="c1"># == setsid()
</span>    <span class="k">else</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="sh">"</span><span class="s">creationflags</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">CREATE_NEW_PROCESS_GROUP</span>

    <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
        <span class="n">sys</span><span class="p">.</span><span class="n">executable</span><span class="p">,</span> <span class="sh">"</span><span class="s">-u</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-c</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">import time,sys; [print(i) or time.sleep(0.3) for i in range(5)]</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">asp</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">asp</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">out</span><span class="p">.</span><span class="nf">decode</span><span class="p">(),</span> <span class="n">err</span><span class="p">.</span><span class="nf">decode</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
        <span class="c1"># 2) Task ì·¨ì†Œ ì‹œ: ê·¸ë£¹ ë‹¨ìœ„ë¡œ ê¹”ë”íˆ ì¢…ë£Œ
</span>        <span class="k">await</span> <span class="nf">terminate_process_tree</span><span class="p">(</span><span class="n">proc</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="c1"># ë‹¤ë¥¸ ì˜ˆì™¸ì—ì„œë„ ì •ë¦¬ ë³´ì¥
</span>        <span class="k">await</span> <span class="nf">terminate_process_tree</span><span class="p">(</span><span class="n">proc</span><span class="p">)</span>
        <span class="k">raise</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">terminate_process_tree</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">sys</span><span class="p">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="sh">"</span><span class="s">win32</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">killpg</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="p">.</span><span class="n">SIGTERM</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">ProcessLookupError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">(),</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">killpg</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="p">.</span><span class="n">SIGKILL</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">ProcessLookupError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">proc</span><span class="p">.</span><span class="nf">send_signal</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">CTRL_BREAK_EVENT</span><span class="p">)</span>  <span class="c1"># CREATE_NEW_PROCESS_GROUP í•„ìš”
</span>        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">(),</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="c1"># ìµœí›„ ìˆ˜ë‹¨: í•˜ìœ„ íŠ¸ë¦¬ê¹Œì§€ ê°•ì œ ì¢…ë£Œ
</span>            <span class="n">subprocess</span><span class="p">.</span><span class="nf">run</span><span class="p">([</span><span class="sh">"</span><span class="s">taskkill</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/F</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/T</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/PID</span><span class="sh">"</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="n">pid</span><span class="p">)],</span>
                           <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">run_subprocess</span><span class="p">())</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">RC:</span><span class="sh">"</span><span class="p">,</span> <span class="n">rc</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
        <span class="n">task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">task</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">pass</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<h3 id="ê²°ë¡ ">ê²°ë¡ </h3>

<ul>
  <li>
    <p>â€œê·¸ëƒ¥ ê·¸ í”„ë¡œì„¸ìŠ¤ í•˜ë‚˜ë§Œâ€ ì¢…ë£Œí•´ë„ ëœë‹¤ë©´ <code class="language-plaintext highlighter-rouge">start_new_session</code>/<code class="language-plaintext highlighter-rouge">CREATE_NEW_PROCESS_GROUP</code>ëŠ” ë¶ˆí•„ìš”.</p>
  </li>
  <li>
    <p><strong>ê³¼ê±°ì²˜ëŸ¼ íŠ¸ë¦¬ ì „ì²´ë¥¼ í™•ì‹¤íˆ ì¢…ë£Œ</strong> í•´ì•¼ í•œë‹¤ë©´, ìœ„ì²˜ëŸ¼ <strong>ìŠ¤í° ì‹œ ê·¸ë£¹ ë¶„ë¦¬ + ê·¸ë£¹ ì¢…ë£Œ ë£¨í‹´</strong> ì„ ê·¸ëŒ€ë¡œ ë„£ì–´ì£¼ì„¸ìš”.</p>
  </li>
  <li>
    <p>POSIXì—ì„  <code class="language-plaintext highlighter-rouge">start_new_session=True</code>ê°€ <code class="language-plaintext highlighter-rouge">preexec_fn=os.setsid</code>ì˜ ì•ˆì „í•œ ëŒ€ì²´ì…ë‹ˆë‹¤.</p>
  </li>
</ul>

<p class="chat--user">

íƒ€ì´ë¨¸ë¥¼ ë”°ë¡œ taskë¡œ ë§Œë“¤ì–´ì„œ subprocess task, timeout task ë‘ ê°œë¥¼ ê·¸ë£¹ìœ¼ë¡œ ì‹¤í–‰ì‹œí‚¤ëŠ” ë°©ì‹ìœ¼ë¡œ ë§Œë“¤ì–´ì¤˜. íƒ€ì„ì•„ì›ƒì´ ë˜ë©´ ìì† í”„ë¡œì„¸ìŠ¤ë„ ë‹¤ ì£½ì—¬ì•¼í•´

</p>

<p>ì¢‹ì•„ìš”â€”â€œíƒ€ì´ë¨¸(Task)ì™€ ì„œë¸Œí”„ë¡œì„¸ìŠ¤(Task)ë¥¼ <strong>ê·¸ë£¹ì²˜ëŸ¼ í•¨ê»˜ ëŒë¦¬ê³ </strong> , íƒ€ì„ì•„ì›ƒ ì‹œ <strong>í”„ë¡œì„¸ìŠ¤ íŠ¸ë¦¬ ì „ì²´</strong> ë¥¼ ì¢…ë£Œâ€í•˜ëŠ” íŒ¨í„´ì„ ê¹”ë”íˆ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤. ê·¸ëŒ€ë¡œ ë¶™ì—¬ ì“°ì„¸ìš”.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">subprocess</span>
<span class="kn">import</span> <span class="n">asyncio.subprocess</span> <span class="k">as</span> <span class="n">asp</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">terminate_process_tree</span><span class="p">(</span><span class="n">proc</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">Process</span><span class="p">,</span> <span class="n">graceful_timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">procë¥¼ </span><span class="sh">'</span><span class="s">ê·¸ë£¹ ë‹¨ìœ„</span><span class="sh">'</span><span class="s">ë¡œ ì¢…ë£Œ. ì•ˆ ì£½ìœ¼ë©´ ê°•ì œ ì¢…ë£Œê¹Œì§€.</span><span class="sh">"""</span>
    <span class="k">if</span> <span class="n">sys</span><span class="p">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="sh">"</span><span class="s">win32</span><span class="sh">"</span><span class="p">:</span>
        <span class="c1"># ìƒˆ ì„¸ì…˜ìœ¼ë¡œ ë„ì› ë‹¤ëŠ” ê°€ì •(start_new_session=True)
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">killpg</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="p">.</span><span class="n">SIGTERM</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">ProcessLookupError</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">graceful_timeout</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">killpg</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="p">.</span><span class="n">SIGKILL</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">ProcessLookupError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># CREATE_NEW_PROCESS_GROUPë¡œ ë„ì› ë‹¤ëŠ” ê°€ì •
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">proc</span><span class="p">.</span><span class="nf">send_signal</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">CTRL_BREAK_EVENT</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">graceful_timeout</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="c1"># ìµœí›„ ìˆ˜ë‹¨: íŠ¸ë¦¬ê¹Œì§€ ëª¨ë‘ ê°•ì œ ì¢…ë£Œ
</span>            <span class="n">subprocess</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
                <span class="p">[</span><span class="sh">"</span><span class="s">taskkill</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/F</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/T</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/PID</span><span class="sh">"</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="n">pid</span><span class="p">)],</span>
                <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">()</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_with_timeout</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    íƒ€ì´ë¨¸ Taskì™€ ì„œë¸Œí”„ë¡œì„¸ìŠ¤ Taskë¥¼ ë™ì‹œì— ëŒë¦¬ë˜,
    íƒ€ì„ì•„ì›ƒì´ ë¨¼ì € ëë‚˜ë©´ </span><span class="sh">'</span><span class="s">í”„ë¡œì„¸ìŠ¤ íŠ¸ë¦¬</span><span class="sh">'</span><span class="s">ë¥¼ ì¢…ë£Œí•œë‹¤.
    ë°˜í™˜: (timed_out: bool, returncode, stdout_str, stderr_str)
    </span><span class="sh">"""</span>
    <span class="c1"># 1) í”„ë¡œì„¸ìŠ¤ë¥¼ "ìƒˆ ê·¸ë£¹/ì„¸ì…˜"ìœ¼ë¡œ ìŠ¤í° (ìì† ì¼ê´„ ì¢…ë£Œë¥¼ ìœ„í•´ í•„ìˆ˜)
</span>    <span class="n">spawn_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">sys</span><span class="p">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="sh">"</span><span class="s">win32</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">spawn_kwargs</span><span class="p">[</span><span class="sh">"</span><span class="s">start_new_session</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>          <span class="c1"># == setsid()
</span>    <span class="k">else</span><span class="p">:</span>
        <span class="n">spawn_kwargs</span><span class="p">[</span><span class="sh">"</span><span class="s">creationflags</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">CREATE_NEW_PROCESS_GROUP</span>

    <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
        <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">asp</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">stderr</span><span class="o">=</span><span class="n">asp</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="o">**</span><span class="n">spawn_kwargs</span>
    <span class="p">)</span>

    <span class="c1"># 2) ë‘ ê°œì˜ Taskë¥¼ ê·¸ë£¹ì²˜ëŸ¼ í•¨ê»˜ ì‹¤í–‰
</span>    <span class="n">proc_task</span>  <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">proc-communicate</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">timer_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">timeout</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">timeout-timer</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">done</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span>
        <span class="p">{</span><span class="n">proc_task</span><span class="p">,</span> <span class="n">timer_task</span><span class="p">},</span>
        <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span>
    <span class="p">)</span>

    <span class="c1"># 3) íƒ€ì´ë¨¸ê°€ ë¨¼ì € ëë‚¨ â†’ íŠ¸ë¦¬ ì¢…ë£Œ í›„ ê²°ê³¼ ì •ë¦¬
</span>    <span class="k">if</span> <span class="n">timer_task</span> <span class="ow">in</span> <span class="n">done</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">proc_task</span><span class="p">.</span><span class="nf">done</span><span class="p">():</span>
        <span class="c1"># í”„ë¡œì„¸ìŠ¤ íŠ¸ë¦¬ ì¢…ë£Œ
</span>        <span class="k">await</span> <span class="nf">terminate_process_tree</span><span class="p">(</span><span class="n">proc</span><span class="p">)</span>
        <span class="c1"># í†µì‹  Task ì·¨ì†Œ (í˜¹ì‹œ ë‚¨ì•„ìˆë‹¤ë©´)
</span>        <span class="n">proc_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">proc_task</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">""</span>  <span class="c1"># timed_out=True
</span>
    <span class="c1"># 4) í”„ë¡œì„¸ìŠ¤ê°€ ë¨¼ì € ëë‚¨ â†’ íƒ€ì´ë¨¸ ì·¨ì†Œ í›„ ê²°ê³¼ ë°˜í™˜
</span>    <span class="n">timer_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">timer_task</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">out_b</span><span class="p">,</span> <span class="n">err_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">proc_task</span>  <span class="c1"># bytes
</span>    <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">out_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span> <span class="n">err_b</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ------------------ ì‚¬ìš© ì˜ˆì‹œ ------------------
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># ì˜ˆ: 0.3ì´ˆ ê°„ê²©ìœ¼ë¡œ 5ì¤„ ì¶œë ¥í•˜ëŠ” í•˜ìœ„ íŒŒì´ì¬ì„ 1ì´ˆ íƒ€ì„ì•„ì›ƒìœ¼ë¡œ ì‹¤í–‰
</span>    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="p">.</span><span class="n">executable</span><span class="p">,</span> <span class="sh">"</span><span class="s">-u</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-c</span><span class="sh">"</span><span class="p">,</span>
           <span class="sh">"</span><span class="s">import time,sys; [print(i) or sys.stdout.flush() or time.sleep(0.3) for i in range(5)]</span><span class="sh">"</span><span class="p">]</span>

    <span class="n">timed_out</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_with_timeout</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">timed_out</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[TIMEOUT] í•˜ìœ„ í”„ë¡œì„¸ìŠ¤ íŠ¸ë¦¬ë¥¼ ëª¨ë‘ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">RC:</span><span class="sh">"</span><span class="p">,</span> <span class="n">rc</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDOUT:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDERR:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<h3 id="í•µì‹¬-í¬ì¸íŠ¸-ìš”ì•½">í•µì‹¬ í¬ì¸íŠ¸ (ìš”ì•½)</h3>

<ul>
  <li>
    <p><strong>ë‘ Taskë¥¼ ê·¸ë£¹ì²˜ëŸ¼</strong> : <code class="language-plaintext highlighter-rouge">proc.communicate()</code> Taskì™€ <code class="language-plaintext highlighter-rouge">asyncio.sleep(timeout)</code> Taskë¥¼ <code class="language-plaintext highlighter-rouge">asyncio.wait(..., FIRST_COMPLETED)</code>ë¡œ ê²½í•©ì‹œí‚µë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>íƒ€ì„ì•„ì›ƒ ê²½ë¡œ</strong> : íƒ€ì´ë¨¸ê°€ ë¨¼ì € ëë‚˜ë©´ <code class="language-plaintext highlighter-rouge">terminate_process_tree()</code>ë¡œ <strong>í”„ë¡œì„¸ìŠ¤ ê·¸ë£¹(íŠ¸ë¦¬)</strong>ì„ ì¢…ë£Œ â†’ í†µì‹  Task ì·¨ì†Œ.</p>
  </li>
  <li>
    <p><strong>í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ ê²½ë¡œ</strong> : í”„ë¡œì„¸ìŠ¤ê°€ ë¨¼ì € ëë‚˜ë©´ íƒ€ì´ë¨¸ Taskë§Œ ì·¨ì†Œ.</p>
  </li>
  <li>
    <p><strong>íŠ¸ë¦¬ ì¢…ë£Œë¥¼ ìœ„í•´ ìŠ¤í° ì˜µì…˜ í•„ìˆ˜</strong></p>

    <ul>
      <li>
        <p>POSIX: <code class="language-plaintext highlighter-rouge">start_new_session=True</code> (â‰’ <code class="language-plaintext highlighter-rouge">preexec_fn=os.setsid</code>)</p>
      </li>
      <li>
        <p>Windows: <code class="language-plaintext highlighter-rouge">creationflags=CREATE_NEW_PROCESS_GROUP</code></p>
      </li>
    </ul>
  </li>
  <li>
    <p>Windowsì—ì„  <code class="language-plaintext highlighter-rouge">CTRL_BREAK_EVENT</code> â†’ ë¶ˆì‘ ì‹œ <code class="language-plaintext highlighter-rouge">taskkill /T</code>ë¡œ ê°•ì œ ì •ë¦¬.</p>
  </li>
</ul>

<p>ì´ íŒ¨í„´ì´ë©´ â€œíƒ€ì´ë¨¸ë¥¼ ë³„ë„ Taskë¡œ ë‘ê³ , íƒ€ì„ì•„ì›ƒ ì‹œ ìì†ê¹Œì§€ ì „ë¶€ ì¢…ë£Œâ€ ìš”êµ¬ì‚¬í•­ì„ ê·¸ëŒ€ë¡œ ì¶©ì¡±í•©ë‹ˆë‹¤.</p>]]></content><author><name>hvppyarchive</name></author><category term="python" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">Async request ì·¨ì†Œ ì²˜ë¦¬</title><link href="https://hvppyarchive.github.io/comfyui/async-request-cancel/" rel="alternate" type="text/html" title="Async request ì·¨ì†Œ ì²˜ë¦¬" /><published>2025-10-10T11:53:02+09:00</published><updated>2025-10-10T11:53:02+09:00</updated><id>https://hvppyarchive.github.io/comfyui/async-request-cancel</id><content type="html" xml:base="https://hvppyarchive.github.io/comfyui/async-request-cancel/"><![CDATA[<p class="chat--user">

comfyuiì—ì„œ custom nodeì˜ ë©”ì¸ í•¨ìˆ˜ë¥¼ asyncë¡œ ë§Œë“¤ ìˆ˜ ìˆê²Œ ë˜ì—ˆì–´. ê·¸ë¦¬ê³ , openai python íŒ¨í‚¤ì§€ì—ì„œ AsyncOpenAIì™€ aiohttpë¥¼ ì´ìš©í•´ì„œ asyncí•˜ê²Œ requestë¥¼ ë³´ë‚¼ ìˆ˜ ìˆì–´. ê·¼ë° ë¬¸ì œëŠ” UIì—ì„œ stopì„ ë³´ë‚´ê³  interruptê°€ ì¦‰ì‹œ ë™ì‘í•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ”ê±°ì•¼. requestë¥¼ ë³´ë‚¸ í›„ await í•˜ëŠ” ë„ì¤‘ì— ì‘ì—…ì´ ì·¨ì†Œë˜ê²Œ í•˜ê³  ì‹¶ì–´

</p>

<p>ì¢‹ì•„, í•µì‹¬ì€ â€œë„¤íŠ¸ì›Œí¬ ìš”ì²­ await ì¤‘ì—ë„ ë°”ë¡œ ëŠê¸°ê²Œâ€ ë§Œë“œëŠ” ê±°ì•¼.<br />
asyncioì—ì„œëŠ” <strong>ì·¨ì†Œ ì‹ í˜¸ì™€ ì‹¤ì œ ì‘ì—…ì„ â€˜ê²½ìŸ(race)â€™</strong> ì‹œí‚¤ë©´ ë¼. ì¦‰, ìš”ì²­ì„ <code class="language-plaintext highlighter-rouge">Task</code>ë¡œ ë§Œë“¤ê³ , UIì—ì„œ ì˜¤ëŠ” stop ì‹ í˜¸(ì´í•˜ <code class="language-plaintext highlighter-rouge">stop_event</code>)ì˜ <code class="language-plaintext highlighter-rouge">wait()</code>ë„ <code class="language-plaintext highlighter-rouge">Task</code>ë¡œ ë§Œë“¤ì–´ì„œ <strong>ë‘˜ ì¤‘ ë¨¼ì € ëë‚˜ëŠ” ìª½</strong> ì„ ë³´ê³  í–‰ë™ì„ ë°”ê¾¸ë©´ ì¦‰ì‹œ ì¤‘ë‹¨ì´ ê°€ëŠ¥í•´.</p>

<p>ì•„ë˜ë¥¼ ê·¸ëŒ€ë¡œ ê°€ì ¸ë‹¤ ì“¸ ìˆ˜ ìˆê²Œ ë‹¨ê³„ë³„(ê·¸ë¦¬ê³  ì•ˆì „í•œ) íŒ¨í„´ìœ¼ë¡œ ì •ë¦¬í–ˆì–´.</p>

<hr />

<h1 id="1-ê³µí†µ-ìœ í‹¸-ì·¨ì†Œ-ê°€ëŠ¥í•œ-await-ë˜í¼">1) ê³µí†µ ìœ í‹¸: ì·¨ì†Œ ê°€ëŠ¥í•œ await ë˜í¼</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>

<span class="k">class</span> <span class="nc">StopByUser</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">UI stop/interruptë¡œ ì¤‘ë‹¨ë˜ì—ˆìŒì„ ë‚˜íƒ€ë‚´ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ ì˜ˆì™¸.</span><span class="sh">"""</span>
    <span class="k">pass</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">await_cancellable</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    coro(ì½”ë£¨í‹´)ì™€ stop_event.wait()ë¥¼ ê²½ìŸì‹œí‚¨ë‹¤.
    - stopì´ ë¨¼ì € ì˜¤ë©´ coro Taskë¥¼ cancelí•˜ê³  ì •ë¦¬í•œ ë’¤ StopByUserë¥¼ ì˜¬ë¦°ë‹¤.
    - ìš”ì²­ì´ ë¨¼ì € ëë‚˜ë©´ stop ëŒ€ê¸° Taskë¥¼ ì·¨ì†Œí•˜ê³  ê²°ê³¼ë¥¼ ë°˜í™˜í•œë‹¤.
    </span><span class="sh">"""</span>
    <span class="n">req_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">coro</span><span class="p">)</span>
    <span class="n">stop_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">stop_event</span><span class="p">.</span><span class="nf">wait</span><span class="p">())</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">done</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span>
            <span class="p">{</span><span class="n">req_task</span><span class="p">,</span> <span class="n">stop_task</span><span class="p">},</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">stop_task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
            <span class="c1"># UIê°€ stopì„ ëˆŒë €ë‹¤: ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì„ ì·¨ì†Œ
</span>            <span class="n">req_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
            <span class="c1"># ì·¨ì†Œ ì •ë¦¬ ëê¹Œì§€ ê¸°ë‹¤ë ¤ ê²½ê³ /ë¦¬ì†ŒìŠ¤ ëˆ„ìˆ˜ ë°©ì§€
</span>            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">req_task</span>
            <span class="k">raise</span> <span class="nc">StopByUser</span><span class="p">(</span><span class="sh">"</span><span class="s">Stopped by user</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># ìš”ì²­ì´ ë¨¼ì € ëë‚¨: stop ëŒ€ê¸°ëŠ” ì·¨ì†Œ
</span>        <span class="n">stop_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">stop_task</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">req_task</span>  <span class="c1"># ê²°ê³¼ ë¦¬í„´
</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
        <span class="c1"># ë°”ê¹¥ ì»¨í…ìŠ¤íŠ¸(ComfyUI ì‹¤í–‰ê¸°)ê°€ ì´ Task ìì²´ë¥¼ ì·¨ì†Œí•œ ê²½ìš°: ë°”ë¡œ ì „íŒŒ
</span>        <span class="k">raise</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># í˜¹ì‹œ ë‚¨ì•„ìˆìœ¼ë©´ í™•ì‹¤íˆ ì •ë¦¬
</span>        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="n">req_task</span><span class="p">,</span> <span class="n">stop_task</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">.</span><span class="nf">done</span><span class="p">():</span>
                <span class="n">t</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">t</span>
</code></pre></div></div>

<blockquote>
  <p>ì¤‘ìš”: ì½”ë“œ ì–´ë”˜ê°€ì— <code class="language-plaintext highlighter-rouge">except Exception:</code> ê°™ì€ ê´‘ë²”ìœ„í•œ ì˜ˆì™¸ ì²˜ë¦¬ê¸°ê°€ ìˆë‹¤ë©´, <strong>ë°˜ë“œì‹œ</strong><br />
 <code class="language-plaintext highlighter-rouge">except asyncio.CancelledError: raise</code> ë¥¼ <strong>ë§¨ ìœ„ì— ë”°ë¡œ</strong> ë‘ì–´ ì·¨ì†Œê°€ ì‚¼ì¼œì§€ì§€ ì•Šê²Œ í•˜ì„¸ìš”.<br />
 (íŒŒì´ì¬ ë²„ì „ì— ë”°ë¼ <code class="language-plaintext highlighter-rouge">CancelledError</code>ê°€ ì¼ë°˜ <code class="language-plaintext highlighter-rouge">Exception</code>ì— ì¡í ìˆ˜ ìˆìœ¼ë‹ˆ ëª…ì‹œì ìœ¼ë¡œ ë¶„ê¸°í•˜ëŠ” ê²Œ ì•ˆì „í•©ë‹ˆë‹¤.)</p>
</blockquote>

<hr />

<h1 id="2-comfyui-ì»¤ìŠ¤í…€-ë…¸ë“œmainasyncì—ì„œ-ì ìš©">2) ComfyUI ì»¤ìŠ¤í…€ ë…¸ë“œ(main=async)ì—ì„œ ì ìš©</h1>

<p>ComfyUIê°€ stopì„ ëˆ„ë¥´ë©´ ë‚´ë¶€ì ìœ¼ë¡œ â€œì¤‘ë‹¨ í”Œë˜ê·¸/ì´ë²¤íŠ¸â€ê°€ ì¼œì§ˆ í…ë°, ê·¸ê±¸ <code class="language-plaintext highlighter-rouge">stop_event</code>(asyncio.Event í˜¸í™˜)ë¡œ ë°›ëŠ”ë‹¤ê³  ê°€ì •í•´ ë³´ì.<br />
(ComfyUIì—ì„œ ì œê³µí•˜ëŠ” ì‹¤ì œ ì¸í„°ëŸ½íŠ¸ ì‹ í˜¸ë¥¼ ì–´ë–»ê²Œ ì–»ëŠ”ì§€ëŠ” í”„ë¡œì íŠ¸ë§ˆë‹¤ ë‹¤ë¥¼ ìˆ˜ ìˆì–´. ë…¸ë“œì— ì£¼ì… ë°›ê±°ë‚˜, ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸ì—ì„œ êº¼ë‚´ ì“°ëŠ” ì‹ìœ¼ë¡œ ì—°ê²°í•´ ì£¼ë©´ ëœë‹¤.)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>

<span class="k">class</span> <span class="nc">AsyncLLMNode</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">prompt</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">})}}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">main</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LLM</span><span class="sh">"</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">stop_event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c1"># stop_eventëŠ” ComfyUI ìª½ì—ì„œ ë„˜ê²¨ì£¼ë„ë¡ ì—°ê²°í•´ ë‘ëŠ” ê±¸ ê¶Œì¥
</span>        <span class="k">if</span> <span class="n">stop_event</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># ìµœì•…ì˜ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ë”ë¯¸ (ì¦‰ì‹œ ì™„ë£Œë˜ì§€ ì•ŠìŒ)
</span>            <span class="n">stop_event</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Event</span><span class="p">()</span>

        <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">()</span>  <span class="c1"># í•„ìš”ì‹œ api_key, base_url ë“± ì„¤ì •
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># â—‡ ë¹„-ìŠ¤íŠ¸ë¦¬ë° ìš”ì²­ ì˜ˆì‹œ
</span>            <span class="n">coro</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
                <span class="n">temperature</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">await_cancellable</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span><span class="p">.</span><span class="n">content</span>
            <span class="nf">return </span><span class="p">(</span><span class="n">text</span><span class="p">,)</span>

        <span class="k">except</span> <span class="n">StopByUser</span><span class="p">:</span>
            <span class="c1"># ComfyUIê°€ ì¦‰ì‹œ ë©ˆì·„ìŒì„ ìœ„ìª½ìœ¼ë¡œ ì•Œë¦¬ê±°ë‚˜, ë¹ˆ ê²°ê³¼/ìƒíƒœ ë©”ì‹œì§€ë¥¼ ë°˜í™˜
</span>            <span class="c1"># ComfyUI ìª½ ì •ì±…ì— ë§ì¶° raise/return ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒ
</span>            <span class="k">raise</span>  <span class="c1"># ë³´í†µì€ raiseë¡œ ì „íŒŒí•˜ëŠ” ê²Œ ì¸í„°ëŸ½íŠ¸ ì²´ì¸ì— ì¶©ì‹¤
</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="c1"># ë°”ê¹¥ì—ì„œ Task ìì²´ê°€ ì·¨ì†Œëœ ê²½ìš°
</span>            <span class="k">raise</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># http ì»¤ë„¥ì…˜ ì •ë¦¬
</span>            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="3-ìŠ¤íŠ¸ë¦¬ë°ë¶€ë¶„-ì‘ë‹µì¼-ë•Œë„-ì¦‰ì‹œ-ì¤‘ë‹¨">3) ìŠ¤íŠ¸ë¦¬ë°(ë¶€ë¶„ ì‘ë‹µ)ì¼ ë•Œë„ ì¦‰ì‹œ ì¤‘ë‹¨</h1>

<p>ìŠ¤íŠ¸ë¦¬ë°ì€ ë‚´ë¶€ì ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">async for</code>ë¡œ ì²­í¬ë¥¼ ì½ëŠ” ë™ì•ˆ <code class="language-plaintext highlighter-rouge">__anext__()</code>ì—ì„œ ë¸”ë¡ë¼ì„œ<br />
stopì„ ëˆŒëŸ¬ë„ ë°”ë¡œ ë°˜ì‘ì„ ëª»í•  ìˆ˜ ìˆì–´. ì´ë•Œë„ <strong>chunk ì½ê¸° vs stop</strong> ë¥¼ ê²½ìŸì‹œí‚¤ë©´ í•´ê²°ë¼.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">stream_chat_cancellable</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">):</span>
    <span class="c1"># ìƒˆë¡œìš´ Responses API ì˜ˆì‹œ (í•„ìš”ì— ë§ì¶° Chat Completionsë¡œ ë°”ê¿”ë„ ë™ì¼ íŒ¨í„´)
</span>    <span class="k">async</span> <span class="k">with</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">stream</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
        <span class="n">aiter</span> <span class="o">=</span> <span class="n">stream</span><span class="p">.</span><span class="nf">aiter_text</span><span class="p">()</span>  <span class="c1"># í…ìŠ¤íŠ¸ ì²­í¬ ì´í„°ë ˆì´í„°
</span>        <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">next_chunk</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">aiter</span><span class="p">.</span><span class="nf">__anext__</span><span class="p">())</span>
            <span class="n">stop_task</span>  <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">stop_event</span><span class="p">.</span><span class="nf">wait</span><span class="p">())</span>
            <span class="n">done</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span>
                <span class="p">{</span><span class="n">next_chunk</span><span class="p">,</span> <span class="n">stop_task</span><span class="p">},</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">stop_task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="c1"># ì½ê¸° ì¤‘ë‹¨ + ì—°ê²° ì •ë¦¬
</span>                <span class="n">next_chunk</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">next_chunk</span>
                <span class="k">await</span> <span class="n">stream</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>  <span class="c1"># ì„œë²„ ìª½ ìŠ¤íŠ¸ë¦¼ë„ ë‹«ê¸°
</span>                <span class="k">raise</span> <span class="nc">StopByUser</span><span class="p">(</span><span class="sh">"</span><span class="s">Stopped by user</span><span class="sh">"</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">next_chunk</span><span class="p">.</span><span class="nf">result</span><span class="p">())</span>
            <span class="k">except</span> <span class="nb">StopAsyncIteration</span><span class="p">:</span>
                <span class="c1"># ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ
</span>                <span class="k">break</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">stop_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">stop_task</span>

        <span class="k">return</span> <span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>
</code></pre></div></div>

<p>ComfyUI ë…¸ë“œì—ì„œ:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">stop_event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">stop_event</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">stop_event</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Event</span><span class="p">()</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">stream_chat_cancellable</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">text</span><span class="p">,)</span>
    <span class="k">except</span> <span class="n">StopByUser</span><span class="p">:</span>
        <span class="k">raise</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="4-aiohttp-ìˆœìˆ˜-ì‚¬ìš©-ì‹œ-ì˜ˆì‹œ">4) aiohttp ìˆœìˆ˜ ì‚¬ìš© ì‹œ ì˜ˆì‹œ</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">aiohttp</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>
<span class="kn">from</span> <span class="n">yarl</span> <span class="kn">import</span> <span class="n">URL</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">fetch_json_cancellable</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="p">.</span><span class="nc">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="c1"># POST ì½”ë£¨í‹´ ìƒì„±
</span>        <span class="k">async</span> <span class="k">def</span> <span class="nf">do_post</span><span class="p">():</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
                <span class="n">resp</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">resp</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>

        <span class="k">return</span> <span class="k">await</span> <span class="nf">await_cancellable</span><span class="p">(</span><span class="nf">do_post</span><span class="p">(),</span> <span class="n">stop_event</span><span class="p">)</span>
</code></pre></div></div>

<blockquote>
  <p>ì°¸ê³ : <code class="language-plaintext highlighter-rouge">aiohttp</code>ëŠ” Task ì·¨ì†Œ ì‹œ ì†Œì¼“ì„ ë‹«ìœ¼ë©° <code class="language-plaintext highlighter-rouge">CancelledError</code>ê°€ ì „íŒŒë¼ìš”.<br />
 ìœ„ì˜ íŒ¨í„´ì²˜ëŸ¼ <em>í•­ìƒ</em> loser taskë¥¼ <code class="language-plaintext highlighter-rouge">cancel()</code>í•˜ê³  <code class="language-plaintext highlighter-rouge">await</code>í•´ì„œ ê²½ê³  ì—†ì´ ì •ë¦¬í•˜ì„¸ìš”.</p>
</blockquote>

<hr />

<h1 id="5-í”í•œ-ì¦‰ì‹œ-ì¤‘ë‹¨ì´-ì•ˆ-ë˜ëŠ”-ì›ì¸-ì²´í¬ë¦¬ìŠ¤íŠ¸">5) í”í•œ â€œì¦‰ì‹œ ì¤‘ë‹¨ì´ ì•ˆ ë˜ëŠ”â€ ì›ì¸ ì²´í¬ë¦¬ìŠ¤íŠ¸</h1>

<ol>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">CancelledError</code>ë¥¼ ì‚¼í‚¤ëŠ” ì˜ˆì™¸ ì²˜ë¦¬</strong></p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">except Exception:</code> ì´ ìˆë‹¤ë©´ ë°”ë¡œ ìœ„ì— <code class="language-plaintext highlighter-rouge">except asyncio.CancelledError: raise</code> ë¥¼ ì¶”ê°€.</li>
    </ul>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">await</code> ì—†ì´ ë™ê¸° ë¸”ë¡œí‚¹ ì½”ë“œ</strong></p>

    <ul>
      <li>CPU ë°”ìš´ë“œ ë£¨í”„/ë¸”ë¡œí‚¹ I/OëŠ” ì´ë²¤íŠ¸ ë£¨í”„ë¥¼ ë§‰ì•„ ì·¨ì†Œê°€ ëŠ¦ì–´ì§ â†’ <code class="language-plaintext highlighter-rouge">await</code> ê°€ëŠ¥í•œ APIë¡œ ë°”ê¾¸ê±°ë‚˜, <code class="language-plaintext highlighter-rouge">run_in_executor()</code>ë¡œ ë¶„ë¦¬.</li>
    </ul>
  </li>
  <li>
    <p><strong>ìŠ¤íŠ¸ë¦¬ë° ë£¨í”„ì—ì„œ stopì„ ì•ˆ ë³´ê³  ìˆìŒ</strong></p>

    <ul>
      <li>ìœ„ì˜ â€œìŠ¤íŠ¸ë¦¬ë° ê²½ìŸâ€ íŒ¨í„´ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">__anext__()</code>ì™€ <code class="language-plaintext highlighter-rouge">stop_event.wait()</code>ë¥¼ ê²½ìŸì‹œí‚¤ê¸°.</li>
    </ul>
  </li>
  <li>
    <p><strong>ì •ë¦¬(cleanup)ë¥¼ ì·¨ì†Œê°€ ë®ì–´ë²„ë¦¼</strong></p>

    <ul>
      <li>ì •ë¦¬ ê³¼ì •ì€ <code class="language-plaintext highlighter-rouge">asyncio.shield()</code>ë¡œ ê°ì‹¸ê±°ë‚˜ <code class="language-plaintext highlighter-rouge">with contextlib.suppress(asyncio.CancelledError)</code>ë¡œ ë§ˆë¬´ë¦¬.</li>
    </ul>
  </li>
  <li>
    <p><strong>ê¸´ ë„¤íŠ¸ì›Œí¬ íƒ€ì„ì•„ì›ƒ</strong></p>

    <ul>
      <li>ì·¨ì†Œ ìì²´ëŠ” íƒ€ì„ì•„ì›ƒê³¼ ë¬´ê´€í•˜ì§€ë§Œ, ë¼ì´ë¸ŒëŸ¬ë¦¬ ì •ë¦¬ê°€ ì§€ì—°ë  ìˆ˜ ìˆìŒ â†’ ì„¸ì…˜/ìŠ¤íŠ¸ë¦¼ì„ <code class="language-plaintext highlighter-rouge">close()</code> í•´ì£¼ê¸°.</li>
    </ul>
  </li>
</ol>

<hr />

<h1 id="6-comfyui-ìª½-stop_event-ì—°ê²°-íŒ">6) ComfyUI ìª½ â€˜stop_eventâ€™ ì—°ê²° íŒ</h1>

<ul>
  <li>
    <p>í”„ë¡œì íŠ¸ì— ë”°ë¼ ë‹¤ë¥´ì§€ë§Œ, ë³´í†µ <strong>ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸</strong> ë‚˜ <strong>ë…¸ë“œ ì¸ì ì£¼ì…</strong> ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">asyncio.Event</code>ë¥¼ ë°›ì„ ìˆ˜ ìˆê²Œ í•´ë‘ë©´ ê°€ì¥ ê¹”ë”í•´.</p>
  </li>
  <li>
    <p>ë§Œì•½ ì§€ê¸ˆì€ ê·¸ëŸ° í›…ì´ ì—†ë‹¤ë©´:</p>

    <ul>
      <li>
        <p>ìµœì†Œí•œ ì£¼ê¸°ì ìœ¼ë¡œ í™•ì¸í•˜ëŠ” pollingì„ ë„£ëŠ” ëŒ€ì‹ , <strong>ìœ„ì˜ ê²½ìŸ íŒ¨í„´</strong> ì„ ì‚¬ìš©í•˜ë©´ â€œawait ì¤‘ì—ë„â€ ë°”ë¡œ ë°˜ì‘í•œë‹¤.</p>
      </li>
      <li>
        <p>stopì„ ëˆ„ë¥¼ ë•Œ ë…¸ë“œ ì¸¡ì— <code class="language-plaintext highlighter-rouge">stop_event.set()</code>ì´ í˜¸ì¶œë˜ë„ë¡ ì—°ê²°(ì£¼ì…)ë§Œ í•´ì£¼ë©´ ëœë‹¤.</p>
      </li>
    </ul>
  </li>
</ul>

<hr />

<p>í•„ìš”í•˜ë©´ ë„ˆì˜ í˜„ì¬ ë…¸ë“œ ì½”ë“œ ì¼ë¶€ë¥¼ ë¶™ì—¬ì¤˜. ê±°ê¸°ì— ë§ì¶° <code class="language-plaintext highlighter-rouge">await_cancellable</code>ì„ ë”± ë“¤ì–´ë§ê²Œ ë¦¬íŒ©í„°ë§í•´ ì¤„ê²Œ.</p>

<p class="chat--user">

stop_eventë¥¼ ë„£ëŠ”ë‹¤ëŠ”ê²Œ ë­”ì§€ ëª¨ë¥´ê² ì–´. comfyui ë‚´ë¶€ì ìœ¼ë¡œ interrupt ë²„íŠ¼ì´ ìˆì–ì•„? ê·¸ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ì·¨ì†Œë˜ë©´ ì¢‹ê² ì–´

</p>

<p>ì¢‹ì•„, â€œUIì˜ Interrupt ë²„íŠ¼(ë˜ëŠ” /interrupt)ì´ ëˆŒë¦¬ë©´ ë‚´ async ì»¤ìŠ¤í…€ ë…¸ë“œê°€ ì§€ê¸ˆ <code class="language-plaintext highlighter-rouge">await</code> ì¤‘ì¸ OpenAI ìš”ì²­ì„ ì¦‰ì‹œ ëŠê³  ì‹¶ë‹¤â€ê°€ ëª©í‘œì§€ìš”. í•µì‹¬ì€ <strong>ComfyUIê°€ ì¸í„°ëŸ½íŠ¸ë¥¼ â€œí”Œë˜ê·¸â€ë¡œë§Œ ì•Œë¦¬ê³ , ì‹¤ì œë¡œëŠ” ë…¸ë“œê°€ í˜‘ì¡°ì ìœ¼ë¡œ ì·¨ì†Œë¥¼ ì²˜ë¦¬í•´ì•¼</strong> í•œë‹¤ëŠ” ì ì´ì—ìš”. ì•„ë˜ë¥¼ ê·¸ëŒ€ë¡œ ë„£ìœ¼ë©´ ë©ë‹ˆë‹¤ â€” ë‹¨ê³„ë³„ë¡œ ì„¤ëª…í• ê²Œìš”.</p>

<hr />

<h2 id="1-comfyuiê°€-ì¸í„°ëŸ½íŠ¸ë¥¼-ì–´ë–»ê²Œ-ì•Œë¦¬ëƒ">1) ComfyUIê°€ ì¸í„°ëŸ½íŠ¸ë¥¼ ì–´ë–»ê²Œ ì•Œë¦¬ëƒ</h2>

<ul>
  <li>
    <p>í”„ë¡ íŠ¸ì—”ë“œ Interrupt ë²„íŠ¼/ë‹¨ì¶•í‚¤ê°€ <strong><code class="language-plaintext highlighter-rouge">POST /interrupt</code></strong> ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. ì„œë²„ëŠ” ë‚´ë¶€ ì¸í„°ëŸ½íŠ¸ í”Œë˜ê·¸ë¥¼ ì„¸íŒ…í•´ìš”. <a href="https://docs.comfy.org/development/comfyui-server/comms_routes?utm_source=chatgpt.com">ComfyUI+2</a></p>
  </li>
  <li>
    <p>ì‹¤í–‰ê¸°ëŠ” ë‹¤ìŒ ë…¸ë“œ ê²½ê³„ í˜¹ì€ ë…¸ë“œ ë‚´ë¶€ì—ì„œ ì²´í¬ë  ë•Œ <strong><code class="language-plaintext highlighter-rouge">InterruptProcessingException</code></strong> ìœ¼ë¡œ ì¤‘ë‹¨ì„ ì „íŒŒí•˜ê³ , ì›¹ì†Œì¼“ ì´ë²¤íŠ¸ <strong><code class="language-plaintext highlighter-rouge">execution_interrupted</code></strong> ë¥¼ ë³´ëƒ…ë‹ˆë‹¤. <a href="https://docs.comfy.org/development/comfyui-server/comms_messages?utm_source=chatgpt.com">ComfyUI</a></p>
  </li>
  <li>
    <p>ë‹¨, <strong>ë…¸ë“œê°€ ë¸”ë¡œí‚¹ ìƒíƒœ(íƒ€ì´íŠ¸ ë£¨í”„/ë¸”ë¡œí‚¹ I/O)</strong> ë©´ ì¸í„°ëŸ½íŠ¸ê°€ ë°”ë¡œ ì²˜ë¦¬ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ ë…¸ë“œê°€ <strong>ì£¼ê¸°ì ìœ¼ë¡œ ì¸í„°ëŸ½íŠ¸ë¥¼ ì²´í¬</strong> í•˜ê±°ë‚˜ <strong><code class="language-plaintext highlighter-rouge">await</code> ë¥¼ ì·¨ì†Œ</strong>í•´ ì¤˜ì•¼ í•´ìš”. <a href="https://github.com/comfyanonymous/ComfyUI/issues/3131?utm_source=chatgpt.com">GitHub</a></p>
  </li>
</ul>

<hr />

<h2 id="2-ì»¤ìŠ¤í…€-ë…¸ë“œì—ì„œ-í˜‘ì¡°ì -ì·¨ì†Œë¥¼-ë¶™ì´ëŠ”-ê°€ì¥-ì‰¬ìš´-ë°©ë²•">2) ì»¤ìŠ¤í…€ ë…¸ë“œì—ì„œ â€œí˜‘ì¡°ì  ì·¨ì†Œâ€ë¥¼ ë¶™ì´ëŠ” ê°€ì¥ ì‰¬ìš´ ë°©ë²•</h2>

<p>ComfyUIëŠ” <code class="language-plaintext highlighter-rouge">comfy.model_management.throw_exception_if_processing_interrupted()</code> ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ì´ê±¸ ì£¼ê¸°ì ìœ¼ë¡œ í˜¸ì¶œí•˜ë©´ ì¸í„°ëŸ½íŠ¸ ì‹œ <code class="language-plaintext highlighter-rouge">InterruptProcessingException</code> ì„ ë˜ì ¸ìš”. (ê³µì‹ ì½”ë“œì™€ ì—¬ëŸ¬ ì˜ˆì‹œ ë…¸ë“œì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤.) <a href="https://gitee.com/bug531/comfy-ui/blob/master/main.py?skip_mobile=true&amp;utm_source=chatgpt.com">Gitee+2</a></p>

<p>ì•„ì´ë””ì–´: <strong>ìš”ì²­ íƒœìŠ¤í¬</strong> ì™€ <strong>ì¸í„°ëŸ½íŠ¸ ê°ì‹œ íƒœìŠ¤í¬</strong> ë¥¼ ë™ì‹œì— ëŒë¦¬ê³ , ê°ì§€ë˜ë©´ ìš”ì²­ íƒœìŠ¤í¬ë¥¼ <code class="language-plaintext highlighter-rouge">cancel()</code>ë¡œ ëŠìŠµë‹ˆë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ì»¤ìŠ¤í…€ ë…¸ë“œ íŒŒì¼ ì•ˆ
</span><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">aiohttp</span>
<span class="kn">import</span> <span class="n">comfy.model_management</span> <span class="k">as</span> <span class="n">mm</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">_watch_interrupt_and_cancel</span><span class="p">(</span><span class="n">task</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">ComfyUI ì¸í„°ëŸ½íŠ¸ê°€ ì˜¤ë©´ ì£¼ì–´ì§„ taskë¥¼ cancel()</span><span class="sh">"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">task</span><span class="p">.</span><span class="nf">done</span><span class="p">():</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>  <span class="c1"># í´ë§ ì£¼ê¸°
</span>            <span class="n">mm</span><span class="p">.</span><span class="nf">throw_exception_if_processing_interrupted</span><span class="p">()</span>  <span class="c1"># ì¸í„°ëŸ½íŠ¸ë©´ ì˜ˆì™¸ ë°œìƒ
</span>    <span class="k">except</span> <span class="n">mm</span><span class="p">.</span><span class="n">InterruptProcessingException</span><span class="p">:</span>
        <span class="n">task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>  <span class="c1"># ë©”ì¸ ìš”ì²­ ì·¨ì†Œ
</span>
<span class="k">class</span> <span class="nc">MyAsyncNode</span><span class="p">:</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">example</span><span class="sh">"</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">prompt</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">})}}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">()</span>  <span class="c1"># í•„ìš” ì‹œ api_key, base_url, timeout ë“± ì„¤ì •
</span>
        <span class="c1"># 1) OpenAI ë¹„ë™ê¸° ìš”ì²­ì„ íƒœìŠ¤í¬ë¡œ ìƒì„±
</span>        <span class="n">req_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span>
            <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>          <span class="c1"># ì„ íƒ: ìš”ì²­ íƒ€ì„ì•„ì›ƒ
</span>                <span class="n">max_retries</span><span class="o">=</span><span class="mi">0</span>         <span class="c1"># ì„ íƒ: ì¬ì‹œë„ ë¹„í™œì„±í™”(ì·¨ì†Œ ì‘ë‹µì„ ë¹ ë¥´ê²Œ)
</span>            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># 2) ì¸í„°ëŸ½íŠ¸ ê°ì‹œ íƒœìŠ¤í¬ ì‹œì‘
</span>        <span class="n">watcher</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">_watch_interrupt_and_cancel</span><span class="p">(</span><span class="n">req_task</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 3) ê²°ê³¼ ëŒ€ê¸° â€” ì¸í„°ëŸ½íŠ¸ ì‹œ req_taskê°€ CancelledErrorë¡œ ê¹¨ì§
</span>            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">req_task</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span><span class="p">.</span><span class="n">content</span>
            <span class="nf">return </span><span class="p">(</span><span class="n">text</span><span class="p">,)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="c1"># 4) ComfyUIì— â€œì‚¬ìš©ì ì¸í„°ëŸ½íŠ¸â€ë¡œ ì•Œë¦¬ë ¤ë©´ ì´ ì˜ˆì™¸ë¡œ ìŠ¹ê²©
</span>            <span class="k">raise</span> <span class="n">mm</span><span class="p">.</span><span class="nc">InterruptProcessingException</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># 5) ì›Œì²˜ ì •ë¦¬
</span>            <span class="n">watcher</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">watcher</span>
</code></pre></div></div>

<h3 id="ì™œ-ì´ë ‡ê²Œ-í•˜ëŠëƒ">ì™œ ì´ë ‡ê²Œ í•˜ëŠëƒ?</h3>

<ul>
  <li>
    <p><strong>UI ë²„íŠ¼</strong> â†’ <code class="language-plaintext highlighter-rouge">/interrupt</code> â†’ ë‚´ë¶€ í”Œë˜ê·¸ on. <a href="https://docs.comfy.org/development/comfyui-server/comms_routes?utm_source=chatgpt.com">ComfyUI</a></p>
  </li>
  <li>
    <p>ê°ì‹œ ì½”ë£¨í‹´ì´ <code class="language-plaintext highlighter-rouge">throw_exception_if_processing_interrupted()</code> í˜¸ì¶œ ì¤‘ <strong>ì˜ˆì™¸ë¥¼ ë°›ìŒ</strong> â†’ <strong><code class="language-plaintext highlighter-rouge">req_task.cancel()</code></strong> â†’ <code class="language-plaintext highlighter-rouge">await</code>ê°€ ì¦‰ì‹œ <code class="language-plaintext highlighter-rouge">CancelledError</code> ë¡œ ê¹¨ì§ â†’ ì´ë¥¼ <strong><code class="language-plaintext highlighter-rouge">InterruptProcessingException</code> ìœ¼ë¡œ ë‹¤ì‹œ ë˜ì ¸</strong> ComfyUIê°€ <em>â€œProcessing interruptedâ€</em> ê²½ë¡œë¡œ ì¢…ë£Œ. <a href="https://docs.comfy.org/development/comfyui-server/comms_messages?utm_source=chatgpt.com">ComfyUI+1</a></p>
  </li>
</ul>

<hr />

<h2 id="3-ëŒ€ì•ˆ-asynciowaitë¡œ-ë ˆì´ìŠ¤-êµ¬ì„±">3) ëŒ€ì•ˆ: <code class="language-plaintext highlighter-rouge">asyncio.wait()</code>ë¡œ â€œë ˆì´ìŠ¤â€ êµ¬ì„±</h2>

<p>í´ë§ ì½”ë“œë¥¼ ì¤„ì´ê³  ì‹¶ë‹¤ë©´, â€œì¸í„°ëŸ½íŠ¸ ëŒ€ê¸° ì½”ë£¨í‹´â€ê³¼ ìš”ì²­ì„ <strong>ë ˆì´ìŠ¤</strong> ì‹œí‚¤ëŠ” ë°©ë²•ë„ ìˆì–´ìš”:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">_wait_for_interrupt</span><span class="p">():</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="n">mm</span><span class="p">.</span><span class="nf">throw_exception_if_processing_interrupted</span><span class="p">()</span>

<span class="c1"># ...
</span><span class="n">req_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(...))</span>
<span class="n">int_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">_wait_for_interrupt</span><span class="p">())</span>

<span class="n">done</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span>
    <span class="p">{</span><span class="n">req_task</span><span class="p">,</span> <span class="n">int_task</span><span class="p">},</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span>
<span class="p">)</span>

<span class="k">if</span> <span class="n">int_task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
    <span class="n">req_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
    <span class="k">raise</span> <span class="n">mm</span><span class="p">.</span><span class="nc">InterruptProcessingException</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">int_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
    <span class="nf">return </span><span class="p">(</span> <span class="p">(</span><span class="k">await</span> <span class="n">req_task</span><span class="p">).</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="4-ìì£¼-ê²ªëŠ”-í•¨ì •--íŒ">4) ìì£¼ ê²ªëŠ” í•¨ì • &amp; íŒ</h2>

<ul>
  <li>
    <p><strong>ë¸”ë¡œí‚¹ ì½”ë“œ</strong>(ë™ê¸° HTTP, ë¬´í•œ ë£¨í”„ ë“±)ê°€ ìˆìœ¼ë©´ ì¸í„°ëŸ½íŠ¸ê°€ â€œì¦‰ì‹œâ€ ì•ˆ ë¨¹í™ë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ëŠ” ë°˜ë“œì‹œ <strong>aiohttp/ë¹„ë™ê¸°</strong> ë¥¼ ì“°ê³ , ë£¨í”„ ì•ˆì—ëŠ” ê°„ê°„ì´ <code class="language-plaintext highlighter-rouge">mm.throw_exception_if_processing_interrupted()</code> ë¥¼ ë„£ìœ¼ì„¸ìš”. <a href="https://github.com/comfyanonymous/ComfyUI/issues/3131?utm_source=chatgpt.com">GitHub</a></p>
  </li>
  <li>
    <p><strong>OpenAI ë¹„ë™ê¸° í´ë¼ì´ì–¸íŠ¸</strong> ëŠ” <code class="language-plaintext highlighter-rouge">AsyncOpenAI</code> ë¥¼ ì“°ë©´ ë©ë‹ˆë‹¤(ìš”ì²­ ì˜µì…˜ì— <code class="language-plaintext highlighter-rouge">timeout</code> ë“± ì „ë‹¬ ê°€ëŠ¥).</p>
  </li>
  <li>
    <p><strong>ì·¨ì†Œ ì „íŒŒ</strong> : <code class="language-plaintext highlighter-rouge">asyncio.CancelledError</code> ë¥¼ <strong>ì¡ì•„ì„œ</strong> <code class="language-plaintext highlighter-rouge">mm.InterruptProcessingException</code> ìœ¼ë¡œ <strong>ë‹¤ì‹œ ë˜ì§€ëŠ” ê²ƒ</strong> ì´ í¬ì¸íŠ¸ì…ë‹ˆë‹¤ â€” ê·¸ë˜ì•¼ UIì— ì •ìƒì ì¸ â€œì¤‘ë‹¨â€ìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤</strong> ë„ ì¸í„°ëŸ½íŠ¸ë¥¼ ë³´ëƒ…ë‹ˆë‹¤(Ctrl+Alt+Enter). <a href="https://docs.comfy.org/interface/shortcuts?utm_source=chatgpt.com">ComfyUI</a></p>
  </li>
</ul>

<hr />

<h2 id="5-ë™ì‘-ì›ë¦¬-í•œëˆˆ-ìš”ì•½">5) ë™ì‘ ì›ë¦¬ í•œëˆˆ ìš”ì•½</h2>

<ol>
  <li>
    <p>ìœ ì €ê°€ Interrupt í´ë¦­ â†’ <strong><code class="language-plaintext highlighter-rouge">POST /interrupt</code></strong> í˜¸ì¶œ â†’ ë‚´ë¶€ í”Œë˜ê·¸ on. <a href="https://docs.comfy.org/development/comfyui-server/comms_routes?utm_source=chatgpt.com">ComfyUI</a></p>
  </li>
  <li>
    <p>ë‚´ ë…¸ë“œì˜ â€œì¸í„°ëŸ½íŠ¸ ì›Œì²˜â€ê°€ í”Œë˜ê·¸ ê°ì§€ â†’ <strong>ìš”ì²­ íƒœìŠ¤í¬ cancel()</strong>.</p>
  </li>
  <li>
    <p>ë‚´ ì½”ë“œê°€ <code class="language-plaintext highlighter-rouge">CancelledError</code> ë¥¼ ë°›ì•„ <strong><code class="language-plaintext highlighter-rouge">InterruptProcessingException</code> ì¬-ë°œìƒ</strong> â†’ ì‹¤í–‰ê¸°ì—ì„œ <strong><code class="language-plaintext highlighter-rouge">execution_interrupted</code></strong> ì´ë²¤íŠ¸ ì „ì†¡ &amp; ì¦‰ì‹œ ì¤‘ë‹¨. <a href="https://docs.comfy.org/development/comfyui-server/comms_messages?utm_source=chatgpt.com">ComfyUI</a></p>
  </li>
</ol>

<p>ì´ë ‡ê²Œ ë¶™ì´ë©´ â€œUIì—ì„œ ì •ì§€ â†’ ê³§ì¥ ë‹¹ì‹ ì˜ <code class="language-plaintext highlighter-rouge">await</code>ê°€ ëŠê¸°ëŠ”â€ ë™ì‘ì„ ì•ˆì •ì ìœ¼ë¡œ ë§Œë“¤ ìˆ˜ ìˆì–´ìš”.</p>

<p class="chat--user">

3ë²ˆì²˜ëŸ¼ êµ¬ì„±í–ˆì–´. ê·¸ëŸ°ë° ë„ˆê°€ ë§Œë“¤ì–´ì¤€ ë…¸ë“œë“¤ì´ ë‹¤ìˆ˜ì˜ ë…¸ë“œê°€ ë™ì‹œì— ì‹¤í–‰ë ìˆ˜ë„ ìˆëŠ”ë° ê·¸ëŸ¬ë©´ ê·¸ ì¤‘ì— í•˜ë‚˜ë§Œ ì·¨ì†Œë˜ëŠ”ê±° ê°™ê¸°ë„í•´. ì™œëƒë©´ throw_exception_if_processing_interrupted() í•¨ìˆ˜ê°€ interrupt_processingì„ Falseë¡œ ë§Œë“¤ê±°ë“ . ê·¸ëŸ¬ë©´ ë‘ ë²ˆì§¸ ë…¸ë“œëŠ” ì·¨ì†Œëœì§€ ëª¨ë¥´ì§€ ì•Šì„ê¹Œ

</p>

<p>ë§ì•„. ë„¤ê°€ ë³¸ ê·¸ëŒ€ë¡œì•¼. ComfyUIì˜ ì¸í„°ëŸ½íŠ¸ í”Œë˜ê·¸ëŠ” <strong>â€œí•œ ë²ˆë§Œ ì†Œë¹„ë˜ëŠ”(edge-triggered)â€</strong> ë™ì‘ì„ í•´.<br />
ì†ŒìŠ¤ ë³´ë©´:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">interrupt_current_processing(True)</code> â†’ ì „ì—­ í”Œë˜ê·¸ë¥¼ <strong>True</strong> ë¡œ ì…‹íŒ….</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">processing_interrupted()</code> â†’ <strong>í”Œë˜ê·¸ë¥¼ ì½ê¸°ë§Œ</strong> í•¨(ì•ˆ ì§€ì›€). <a href="https://huggingface.co/spideyrim/ComfyUI/blob/main/comfy/model_management.py">Hugging Face</a></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">throw_exception_if_processing_interrupted()</code> â†’ í”Œë˜ê·¸ê°€ <strong>Trueë©´ Falseë¡œ ì§€ìš°ê³ </strong> <code class="language-plaintext highlighter-rouge">InterruptProcessingException</code>ì„ ë˜ì§(ì¦‰, <em>ì†Œë¹„</em>). ê·¸ë˜ì„œ <strong>ë¨¼ì € í˜¸ì¶œí•œ ë…¸ë“œë§Œ</strong> í™•ì‹¤íˆ ì·¨ì†Œ ì‹ í˜¸ë¥¼ ë³´ê²Œ ë˜ê³ , ë’¤ëŠ¦ê²Œ ì²´í¬í•œ ë‹¤ë¥¸ ë…¸ë“œëŠ” â€œëª°ëë‹¤â€ê°€ ë  ìˆ˜ ìˆì–´. <a href="https://huggingface.co/spideyrim/ComfyUI/blob/main/comfy/model_management.py">Hugging Face</a></p>
  </li>
</ul>

<p>ê·¸ë˜ì„œ â€œì—¬ëŸ¬ ë…¸ë“œê°€ ë™ì‹œì— ëŒ ë•Œ í•˜ë‚˜ë§Œ ì·¨ì†Œë˜ëŠ” ê²ƒ ê°™ë‹¤â€ëŠ” ë„¤ ì¶”ì¸¡ì´ ì •í™•í•´.</p>

<hr />

<h1 id="ì´ë ‡ê²Œ-ë°”ê¿”ì„œ-í•´ê²°í•´">ì´ë ‡ê²Œ ë°”ê¿”ì„œ í•´ê²°í•´</h1>

<p>í•µì‹¬ì€ <strong>ë…¸ë“œ ë‚´ë¶€ì—ì„œ í”Œë˜ê·¸ë¥¼ â€˜ì½ê¸°ë§Œâ€™ í•˜ë˜ ì§€ìš°ì§€ ì•ŠëŠ” ê²ƒ</strong> ì´ì•¼.<br />
ì¦‰, ê°ì‹œ ì½”ë£¨í‹´ì€ <code class="language-plaintext highlighter-rouge">throw_exception_if_processing_interrupted()</code>(ì†Œë¹„) ëŒ€ì‹  <code class="language-plaintext highlighter-rouge">processing_interrupted()</code>(ë¹„ì†Œë¹„)ë¡œ ì²´í¬í•˜ê³ , <strong>ì§ì ‘<code class="language-plaintext highlighter-rouge">InterruptProcessingException</code>ì„ raise</strong> í•˜ì. ê·¸ëŸ¬ë©´ <strong>ëª¨ë“ </strong> ì‹¤í–‰ ì¤‘ ë…¸ë“œê°€ ê°™ì€ ì¸í„°ëŸ½íŠ¸ë¥¼ ê°ì§€í•˜ê³  ë™ì‹œì— ë©ˆì¶œ ìˆ˜ ìˆì–´.</p>

<h2 id="1-ë ˆì´ìŠ¤-íŒ¨í„´ìš”ì²­-vs-ì¸í„°ëŸ½íŠ¸-ìˆ˜ì •ë³¸">1) ë ˆì´ìŠ¤ íŒ¨í„´(ìš”ì²­ vs ì¸í„°ëŸ½íŠ¸) ìˆ˜ì •ë³¸</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>
<span class="kn">import</span> <span class="n">comfy.model_management</span> <span class="k">as</span> <span class="n">mm</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">_wait_for_interrupt_level_trigger</span><span class="p">():</span>
    <span class="c1"># í”Œë˜ê·¸ë¥¼ 'ì½ê¸°ë§Œ' í•˜ëŠ” ë£¨í”„: ì—¬ëŸ¬ ë…¸ë“œê°€ ë™ì‹œì— Trueë¥¼ ê°ì§€ ê°€ëŠ¥
</span>    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mm</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>           <span class="c1"># â† ì†Œë¹„ ì•ˆ í•¨
</span>            <span class="k">raise</span> <span class="n">mm</span><span class="p">.</span><span class="nc">InterruptProcessingException</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">MyAsyncNode</span><span class="p">:</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">example</span><span class="sh">"</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">prompt</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">})}}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">req_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span>
                <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
                    <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
                    <span class="n">max_retries</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">int_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">_wait_for_interrupt_level_trigger</span><span class="p">())</span>

            <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">({</span><span class="n">req_task</span><span class="p">,</span> <span class="n">int_task</span><span class="p">},</span>
                                        <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">int_task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="c1"># ì¸í„°ëŸ½íŠ¸ê°€ ë¨¼ì € ì˜´: ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ì¦‰ì‹œ ì·¨ì†Œ
</span>                <span class="n">req_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">req_task</span>
                <span class="c1"># ì—¬ê¸°ì„œ throw_exception_if_processing_interrupted()ë¥¼ ë¶€ë¥´ë©´
</span>                <span class="c1"># í”Œë˜ê·¸ë¥¼ 'ì§€ì›Œ' ë²„ë ¤ ë‹¤ë¥¸ ë…¸ë“œê°€ ëª» ë´„ â†’ ì“°ì§€ ë§ì.
</span>                <span class="k">raise</span> <span class="n">mm</span><span class="p">.</span><span class="nc">InterruptProcessingException</span><span class="p">()</span>

            <span class="c1"># ìš”ì²­ì´ ë¨¼ì € ëë‚¨
</span>            <span class="n">int_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">int_task</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">req_task</span>
            <span class="nf">return </span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span><span class="p">.</span><span class="n">content</span><span class="p">,)</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="c1"># ìƒìœ„ì—ì„œ íƒœìŠ¤í¬ ìì²´ë¥¼ ì·¨ì†Œí•œ ê²½ìš°
</span>            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre></div></div>

<blockquote>
  <p>í¬ì¸íŠ¸: <strong>ë…¸ë“œ ì½”ë“œì—ì„œëŠ”<code class="language-plaintext highlighter-rouge">throw_exception_if_processing_interrupted()</code>ë¥¼ í˜¸ì¶œí•˜ì§€ ì•ŠëŠ”ë‹¤.</strong><br />
 ëª¨ë“  ì‹¤í–‰ ì¤‘ ë…¸ë“œê°€ <code class="language-plaintext highlighter-rouge">processing_interrupted()</code>ë¡œ ë™ì‹œì— ê°ì§€ â†’ ê°ì ìì‹ ì˜ ì‘ì—…ì„ ì·¨ì†Œí•˜ê³  <strong>ì§ì ‘</strong> <code class="language-plaintext highlighter-rouge">InterruptProcessingException</code>ì„ ë˜ì§„ë‹¤.<br />
 ì´ë ‡ê²Œ í•´ì•¼ í”Œë˜ê·¸ê°€ í•œ ë…¸ë“œì— ì˜í•´ ë¨¼ì € â€˜ì†Œë¹„â€™ë˜ì–´ ì‚¬ë¼ì§€ëŠ” ì¼ì´ ì—†ë‹¤. (í•´ë‹¹ í•¨ìˆ˜ê°€ í”Œë˜ê·¸ë¥¼ Falseë¡œ ë§Œë“¤ê³  ì˜ˆì™¸ë¥¼ ë˜ì§€ëŠ” ë™ì‘ì€ ì†ŒìŠ¤ì— ëª…ì‹œë¼ ìˆìŒ) <a href="https://huggingface.co/spideyrim/ComfyUI/blob/main/comfy/model_management.py">Hugging Face</a></p>
</blockquote>

<h2 id="2-ìŠ¤íŠ¸ë¦¬ë°-ë£¨í”„ë„-ë™ì¼-ì›ë¦¬">2) ìŠ¤íŠ¸ë¦¬ë° ë£¨í”„ë„ ë™ì¼ ì›ë¦¬</h2>

<p>ì²­í¬ ì½ê¸°(<code class="language-plaintext highlighter-rouge">__anext__</code>)ì™€ ì¸í„°ëŸ½íŠ¸ ê°ì‹œë¥¼ ë ˆì´ìŠ¤ì‹œí‚¤ë˜, ê°ì‹œëŠ” <code class="language-plaintext highlighter-rouge">processing_interrupted()</code>ë§Œ ì‚¬ìš©:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">stream_chat_cancellable</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">stream</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">prompt</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
        <span class="n">aiter</span> <span class="o">=</span> <span class="n">stream</span><span class="p">.</span><span class="nf">aiter_text</span><span class="p">()</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">next_chunk</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">aiter</span><span class="p">.</span><span class="nf">__anext__</span><span class="p">())</span>
            <span class="n">int_task</span>   <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">_wait_for_interrupt_level_trigger</span><span class="p">())</span>

            <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">({</span><span class="n">next_chunk</span><span class="p">,</span> <span class="n">int_task</span><span class="p">},</span>
                                         <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">int_task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="n">next_chunk</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">next_chunk</span>
                <span class="k">await</span> <span class="n">stream</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">mm</span><span class="p">.</span><span class="nc">InterruptProcessingException</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">next_chunk</span><span class="p">.</span><span class="nf">result</span><span class="p">())</span>
            <span class="k">except</span> <span class="nb">StopAsyncIteration</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">int_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">int_task</span>

        <span class="k">return</span> <span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h1 id="ì™œ-ì´ê²Œ-ì•ˆì „í•œê°€-step-by-step">ì™œ ì´ê²Œ ì•ˆì „í•œê°€ (step-by-step)</h1>

<ol>
  <li>
    <p>ì‚¬ìš©ìê°€ UIì—ì„œ <strong>Interrupt ë²„íŠ¼</strong> â†’ ì„œë²„ê°€ <code class="language-plaintext highlighter-rouge">interrupt_current_processing(True)</code>ë¡œ ì „ì—­ í”Œë˜ê·¸ë¥¼ í‚´.</p>
  </li>
  <li>
    <p>ê° ë…¸ë“œì˜ ê°ì‹œ ì½”ë£¨í‹´ì´ <strong>ì§€ìš°ì§€ ì•ŠëŠ”</strong> <code class="language-plaintext highlighter-rouge">processing_interrupted()</code>ë¡œ Trueë¥¼ ê°ì§€. (ë™ì‹œì— ì—¬ëŸ¬ ë…¸ë“œ OK) <a href="https://huggingface.co/spideyrim/ComfyUI/blob/main/comfy/model_management.py">Hugging Face</a></p>
  </li>
  <li>
    <p>ê°ì§€í•œ ë…¸ë“œëŠ” <strong>ìê¸° ë„¤íŠ¸ì›Œí¬ íƒœìŠ¤í¬ë¥¼<code class="language-plaintext highlighter-rouge">cancel()</code></strong> í•˜ê³  <code class="language-plaintext highlighter-rouge">InterruptProcessingException</code>ì„ <strong>ì§ì ‘ raise</strong>.</p>
  </li>
  <li>
    <p>ì‹¤í–‰ê¸°ëŠ” ì´ ì˜ˆì™¸ë¥¼ ë°›ì•„ ì›Œí¬í”Œë¡œë¥¼ â€œProcessing interruptedâ€ë¡œ ì¢…ë£Œ.</p>
  </li>
  <li>
    <p>í”Œë˜ê·¸ ì´ˆê¸°í™”ëŠ” <strong>ì½”ì–´ ìª½</strong>(ë‹¤ìŒ ì‹¤í–‰ ì¤€ë¹„ íƒ€ì´ë°)ì— ì˜í•´ ì²˜ë¦¬ë˜ê±°ë‚˜, ì½”ì–´ê°€ ì ì ˆíˆ <code class="language-plaintext highlighter-rouge">throw_exception_if_processing_interrupted()</code>ë¥¼ í•œ ë²ˆë§Œ í˜¸ì¶œí•´ ì†Œë¹„í•¨. (ì´ í•¨ìˆ˜ê°€ í”Œë˜ê·¸ë¥¼ ì§€ìš°ëŠ” ë™ì‘ì€ ì†ŒìŠ¤ì— ëª…í™•) <a href="https://huggingface.co/spideyrim/ComfyUI/blob/main/comfy/model_management.py">Hugging Face</a></p>
  </li>
</ol>

<blockquote>
  <p>ìš”ì•½: <strong>ë…¸ë“œ ë‹¨ì—ì„œëŠ” â€˜ì½ê¸°(ë ˆë²¨ íŠ¸ë¦¬ê±°)â€™ë§Œ í•˜ê³ , ì§€ìš°ëŠ”(ì—£ì§€ ì†Œë¹„) ì¼ì€ ì½”ì–´ì—ê²Œ ë§¡ê²¨ë¼.</strong></p>
</blockquote>

<hr />

<h1 id="ì¶”ê°€-ì²´í¬ë¦¬ìŠ¤íŠ¸">ì¶”ê°€ ì²´í¬ë¦¬ìŠ¤íŠ¸</h1>

<ul>
  <li>
    <p>ì˜ˆì™¸ ì²˜ë¦¬ì—ì„œ <code class="language-plaintext highlighter-rouge">CancelledError</code>ëŠ” <strong>ì ˆëŒ€ ì‚¼í‚¤ì§€ ë§ê³  ì „íŒŒ</strong> í•˜ì„¸ìš”. (ì·¨ì†Œ ê°ë„ê°€ ë–¨ì–´ì§€ëŠ” ëŒ€í‘œ ì›ì¸)</p>
  </li>
  <li>
    <p>aiohttp/OpenAI ë¹„ë™ê¸°ëŠ” íƒœìŠ¤í¬ ì·¨ì†Œ ì‹œ ì†Œì¼“ì„ ë‹«ê³  <code class="language-plaintext highlighter-rouge">CancelledError</code>ë¥¼ ë˜ì§‘ë‹ˆë‹¤. ì·¨ì†Œ í›„ì—ëŠ” <code class="language-plaintext highlighter-rouge">with suppress(asyncio.CancelledError): await task</code>ë¡œ <strong>ì •ë¦¬ê¹Œì§€</strong> í•´ ì£¼ì„¸ìš”.</p>
  </li>
  <li>
    <p>ì¥ì‹œê°„ ë¸”ë¡œí‚¹/CPU ì‘ì—…ì´ ìˆìœ¼ë©´ <code class="language-plaintext highlighter-rouge">processing_interrupted()</code>ë¥¼ ë£¨í”„ì— ê°„ê°„íˆ ë„£ì–´ ì£¼ì„¸ìš”. (ë¸”ë¡œí‚¹ì´ë©´ ì¸í„°ëŸ½íŠ¸ê°€ ëŠ¦ê²Œ ë°˜ì˜)</p>
  </li>
</ul>

<p>ì´ëŒ€ë¡œ ë°”ê¾¸ë©´ â€œë™ì‹œì— ë„ëŠ” ì—¬ëŸ¬ ë…¸ë“œ ì¤‘ í•˜ë‚˜ë§Œ ë©ˆì¶”ëŠ”â€ í˜„ìƒ ì—†ì´, <strong>ëª¨ë‘ê°€ ì¦‰ì‹œ ë©ˆì¶”ëŠ”</strong> ë™ì‘ì´ ë©ë‹ˆë‹¤.</p>

<p class="chat--user">

Exceptionì„ ì—¬ëŸ¬ ë…¸ë“œì—ì„œ ë¿Œë ¤ë„ ë¼?

</p>

<p>ì§§ê²Œ ë‹µí•˜ë©´: <strong>ë„¤, ì—¬ëŸ¬ ë…¸ë“œì—ì„œ<code class="language-plaintext highlighter-rouge">InterruptProcessingException</code>ì„ ë™ì‹œì—(ë˜ëŠ” ê±°ì˜ ë™ì‹œì—) ë˜ì ¸ë„ ë©ë‹ˆë‹¤.</strong><br />
ComfyUI ì‹¤í–‰ê¸°ëŠ” ì´ ì˜ˆì™¸ë¥¼ â€œì·¨ì†Œ ì‹ í˜¸â€ë¡œ ì·¨ê¸‰í•˜ê³  ìƒìœ„ ì‹¤í–‰ ë£¨í”„ì—ì„œ ì¡ì•„ì„œ í”„ë¡¬í”„íŠ¸ ì‹¤í–‰ì„ ì¤‘ë‹¨í•˜ë„ë¡ ì„¤ê³„ë˜ì–´ ìˆì–´ìš”. í•œ ë…¸ë“œê°€ ë˜ì§€ë“ , ì—¬ëŸ¬ ë…¸ë“œê°€ ë˜ì§€ë“  ê²°ê³¼ëŠ” ê°™ê³ , ì¶”ê°€ë¡œ ë˜ì ¸ì§€ëŠ” ì˜ˆì™¸ë“¤ì€ ìƒìœ„ì—ì„œ ë™ì¼í•˜ê²Œ ì²˜ë¦¬(ë¡œê·¸ë§Œ ë‚¨ê¸°ê³  ë¬´ì‹œ)ë©ë‹ˆë‹¤. ê³µì‹ ë¬¸ì„œì—ë„ <em>â€œë…¸ë“œê°€ <code class="language-plaintext highlighter-rouge">InterruptProcessingException</code>ì„ ë˜ì§ˆ ë•Œ ì‹¤í–‰ì´ ì¤‘ë‹¨ëœë‹¤â€</em>ê³  ëª…ì‹œë¼ ìˆì–´ìš”. <a href="https://docs.comfy.org/development/comfyui-server/comms_messages">ComfyUI ê³µì‹ ë¬¸ì„œ</a></p>

<p>ì¡°ê¸ˆ ë” êµ¬ì²´ì ìœ¼ë¡œ, ë‹¨ê³„ë³„ë¡œ ìƒê°í•´ë³´ë©´:</p>

<ol>
  <li>
    <p><strong>UIì˜ Stop(ë˜ëŠ”<code class="language-plaintext highlighter-rouge">/interrupt</code>) â†’ ì‹¤í–‰ ì¤‘ë‹¨ í”Œë˜ê·¸ ì„¸íŠ¸</strong><br />
í”„ë¡ íŠ¸ì—”ë“œê°€ ì¤‘ë‹¨ì„ ë³´ë‚´ë©´ ì„œë²„ê°€ í˜„ì¬ ì›Œí¬í”Œë¡œ ì‹¤í–‰ì„ ë©ˆì¶”ëŠ” ë¼ìš°íŠ¸ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤. <a href="https://docs.comfy.org/development/comfyui-server/comms_routes?utm_source=chatgpt.com">ComfyUI ê³µì‹ ë¬¸ì„œ</a></p>
  </li>
  <li>
    <p><strong>ë…¸ë“œë‹¨ ì²´í¬ â†’ ì˜ˆì™¸ ë°œìƒ</strong><br />
ê° ë…¸ë“œ(í˜¹ì€ ì§„í–‰ë¥  í›…/ëŒ€ê¸° ì§€ì )ì—ì„œ <code class="language-plaintext highlighter-rouge">throw_exception_if_processing_interrupted()</code>ë¥¼ í˜¸ì¶œí•˜ë©´, í”Œë˜ê·¸ê°€ ì¼œì ¸ ìˆì„ ë•Œ <code class="language-plaintext highlighter-rouge">InterruptProcessingException</code>ì„ ë˜ì§‘ë‹ˆë‹¤. ì´ê±´ ì˜ë„ëœ íë¦„ì´ì—ìš”. ì‹¤í–‰ê¸°ëŠ” ì´ ì˜ˆì™¸ë¥¼ íŠ¹ë³„ì·¨ê¸‰í•˜ì—¬ â€œProcessing interruptedâ€ë¡œ ì²˜ë¦¬í•˜ê³  <code class="language-plaintext highlighter-rouge">execution_interrupted</code> ë©”ì‹œì§€ë¥¼ ë¸Œë¡œë“œìºìŠ¤íŠ¸í•©ë‹ˆë‹¤. <a href="https://docs.comfy.org/development/comfyui-server/comms_messages">ComfyUI ê³µì‹ ë¬¸ì„œ+1</a></p>
  </li>
  <li>
    <p><strong>ì—¬ëŸ¬ ë…¸ë“œê°€ ë™ì‹œì— ë˜ì ¸ë„ ë¬¸ì œ ì—†ìŒ</strong><br />
ì‹¤í–‰ê¸°ëŠ” ë…¸ë“œ ì‹¤í–‰ì„ ê°ì‹¸ëŠ” ìƒìœ„ try/exceptì—ì„œ <code class="language-plaintext highlighter-rouge">InterruptProcessingException</code>ì„ ì¡ì•„ â€œì¤‘ë‹¨â€ìœ¼ë¡œ ì •ë¦¬í•©ë‹ˆë‹¤. ë‹¤ë¥¸ ë…¸ë“œì—ì„œë„ ê°™ì€ ì˜ˆì™¸ê°€ ì—°ë‹¬ì•„ í„°ì ¸ë„ ë™ì¼í•˜ê²Œ ì¤‘ë‹¨ ì²˜ë¦¬ë¡œ í˜ëŸ¬ê°‘ë‹ˆë‹¤(ì¤‘ë³µ ë¡œê·¸ ì •ë„ë§Œ ìƒê¸¸ ìˆ˜ ìˆìŒ). <a href="https://github.com/comfyanonymous/ComfyUI/discussions/6766?utm_source=chatgpt.com">GitHub+1</a></p>
  </li>
</ol>

<p>ê·¸ë˜ì„œ ì‹¤ë¬´ íŒì€ ì´ë ‡ìŠµë‹ˆë‹¤:</p>

<ul>
  <li>
    <p><strong>ê° ë…¸ë“œì—ì„œ</strong> ì§„ì… ì‹œì ê³¼ <strong>ëª¨ë“ <code class="language-plaintext highlighter-rouge">await</code> ì§í›„</strong>ì—<br />
<code class="language-plaintext highlighter-rouge">throw_exception_if_processing_interrupted()</code>ë¥¼ í˜¸ì¶œí•˜ì„¸ìš”.</p>
  </li>
  <li>ì™¸ë¶€ ë¹„ë™ê¸° ìš”ì²­(ì˜ˆ: <code class="language-plaintext highlighter-rouge">AsyncOpenAI</code>/<code class="language-plaintext highlighter-rouge">aiohttp</code>)ì´ ìˆë‹¤ë©´ ì´ë ‡ê²Œ ê°ì‹¸ë©´ ì•ˆì „í•©ë‹ˆë‹¤:
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfy.model_management</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">InterruptProcessingException</span><span class="p">,</span>
    <span class="n">throw_exception_if_processing_interrupted</span><span class="p">,</span>
<span class="p">)</span>
    
<span class="k">async</span> <span class="k">def</span> <span class="nf">FUNCTION</span><span class="p">(...):</span>
    <span class="nf">throw_exception_if_processing_interrupted</span><span class="p">()</span>
    <span class="n">task</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># ì˜ˆ: ëŒ€ê¸° ì „ì— í•œ ë²ˆ ë” ì²´í¬
</span>        <span class="nf">throw_exception_if_processing_interrupted</span><span class="p">()</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(...))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">task</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">except</span> <span class="n">InterruptProcessingException</span><span class="p">:</span>
        <span class="c1"># ì™¸ë¶€ ìš”ì²­/íƒœìŠ¤í¬ ì •ë¦¬
</span>        <span class="k">if</span> <span class="n">task</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task</span><span class="p">.</span><span class="nf">done</span><span class="p">():</span>
            <span class="n">task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">task</span>
        <span class="k">raise</span>  <span class="c1"># ê¼­ ì¬ì „íŒŒ! (ì¤‘ë‹¨ìœ¼ë¡œ ì¸ì‹)
</span></code></pre></div>    </div>
  </li>
  <li>
    <p><strong>ì ˆëŒ€</strong> <code class="language-plaintext highlighter-rouge">InterruptProcessingException</code>ì„ ì¼ë°˜ <code class="language-plaintext highlighter-rouge">Exception</code>ìœ¼ë¡œ ì‚¼ì¼œì„œ ë¦¬í„´í•˜ì§€ ë§ˆì„¸ìš”. ê·¸ëŸ¬ë©´ â€œì¤‘ë‹¨â€ì´ ì•„ë‹Œ â€œì‹¤íŒ¨â€ë¡œ ê¸°ë¡ë©ë‹ˆë‹¤(ë¡œê·¸ì™€ UI ì´ë²¤íŠ¸ê°€ ë‹¬ë¼ì§). <code class="language-plaintext highlighter-rouge">execution_interrupted</code> ì´ë²¤íŠ¸ëŠ” ì´ ì˜ˆì™¸ê°€ ê·¸ëŒ€ë¡œ ì˜¬ë¼ê°ˆ ë•Œë§Œ ë°œìƒí•©ë‹ˆë‹¤. <a href="https://docs.comfy.org/development/comfyui-server/comms_messages">ComfyUI ê³µì‹ ë¬¸ì„œ</a></p>
  </li>
  <li>ì—¬ëŸ¬ ë…¸ë“œê°€ ë™ì‹œì— ì‹¤í–‰ë  ìˆ˜ ìˆëŠ” êµ¬ì¡°ë¼ë©´ <strong>ê° ë…¸ë“œê°€ ë…ë¦½ì ìœ¼ë¡œ ê°™ì€ ì˜ˆì™¸ë¥¼ ë˜ì§€ë„ë¡</strong> ë‘ëŠ” ê²Œ ë§ìŠµë‹ˆë‹¤. ì¤‘ë³µ ì˜ˆì™¸ëŠ” ìƒìœ„ ì‹¤í–‰ê¸°ì—ì„œ ì •ë¦¬ë˜ë©°, ì „ì²´ í”„ë¡¬í”„íŠ¸ëŠ” í•œ ë²ˆë§Œ â€œì¤‘ë‹¨â€ìœ¼ë¡œ ë§ˆê°ë©ë‹ˆë‹¤. <a href="https://github.com/comfyanonymous/ComfyUI/discussions/6766?utm_source=chatgpt.com">GitHub</a></li>
</ul>

<p>ë¤: ë¸Œë¼ìš°ì € íƒ­ì„ ë‹«ì•„ë„ ì¤‘ë‹¨ì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤ëŠ” ì´ìŠˆë“¤ì´ ìˆì–´ìš”(íƒ­ì„ ë‹«ìœ¼ë©´ ì„¸ì…˜ì´ ëŠê¸°ë©° ì¸í„°ëŸ½íŠ¸ê°€ íŠ¸ë¦¬ê±°). API/í—¤ë“œë¦¬ìŠ¤ë¡œ ëŒë¦´ ë•ŒëŠ” ì´ ì ì„ ìœ ì˜í•˜ì„¸ìš”. <a href="https://github.com/comfyanonymous/ComfyUI/issues/6713?utm_source=chatgpt.com">GitHub+1</a></p>

<p>ì •ë¦¬: <strong>ì—¬ëŸ¬ ë…¸ë“œì—ì„œ ë§ˆìŒ í¸íˆ<code class="language-plaintext highlighter-rouge">InterruptProcessingException</code>ì„ ë˜ì§€ì„¸ìš”.</strong> ì´ê²ƒì´ ComfyUIê°€ ì˜ë„í•œ â€œì¦‰ì‹œ ì¤‘ë‹¨â€ ë©”ì»¤ë‹ˆì¦˜ì´ê³ , ì˜ˆì™¸ê°€ ì—¬ëŸ¬ ê°œì—¬ë„ ìƒìœ„ ì‹¤í–‰ê¸°ì—ì„œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</p>

<p class="chat--user">

_wait_for_interrupt_level_trigger()ì—ì„œ raise ì•ˆí•˜ê³  ê·¸ëƒ¥ return í•˜ëŠ”ê±´ ì–´ë•Œ ì–´ì°¨í”¼ ë°–ì—ì„œ raise í•˜ì–ì•„

</p>

<p>ê°€ëŠ¥í•´. <strong><code class="language-plaintext highlighter-rouge">_wait_for_interrupt_level_trigger()</code>ì—ì„œ <code class="language-plaintext highlighter-rouge">raise</code> ëŒ€ì‹  <code class="language-plaintext highlighter-rouge">return</code></strong> í•´ë„ ì›í•˜ëŠ” â€œë ˆì´ìŠ¤(ìš”ì²­ vs ì¸í„°ëŸ½íŠ¸)â€ ë™ì‘ì€ ë˜‘ê°™ì´ ë§Œë“¤ì–´ì ¸. ì‹¤ë¬´ì ìœ¼ë¡œëŠ” <em>í—¬í¼ì—ì„œ ì˜ˆì™¸ ìŠ¤íƒì„ ë‚¨ê¸°ì§€ ì•Šìœ¼ë‹ˆ</em> ë¡œê·¸ê°€ ë” ê¹”ë”í•´ì§€ëŠ” ì¥ì ë„ ìˆì–´.</p>

<p>ì•„ë˜ì²˜ëŸ¼ ë°”ê¾¸ë©´ ë¼ â€” ë‹¨ê³„ë³„ë¡œ ì •ë¦¬í• ê²Œ.</p>

<hr />

<h1 id="í•µì‹¬-ì•„ì´ë””ì–´-step-by-step">í•µì‹¬ ì•„ì´ë””ì–´ (step-by-step)</h1>

<ol>
  <li>
    <p><strong>í—¬í¼ëŠ” â€œì¸í„°ëŸ½íŠ¸ë¥¼ ê°ì§€í•˜ë©´ ëë‚¬ë‹¤â€ëŠ” ì‹ í˜¸ë§Œ ë°˜í™˜</strong> í•œë‹¤.</p>
  </li>
  <li>
    <p><strong>ë°”ê¹¥(ì½œëŸ¬)</strong>ëŠ” <code class="language-plaintext highlighter-rouge">asyncio.wait(..., FIRST_COMPLETED)</code>ë¡œ <code class="language-plaintext highlighter-rouge">req_task</code>(ë„¤íŠ¸ì›Œí¬ ìš”ì²­)ì™€ <code class="language-plaintext highlighter-rouge">int_task</code>(ì¸í„°ëŸ½íŠ¸ ê°ì‹œ) ì¤‘ <strong>ë¨¼ì € ëë‚œ ìª½</strong> ì„ í™•ì¸í•œë‹¤.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">int_task</code>ê°€ ë¨¼ì € ëë‚¬ë‹¤ë©´ <strong>ìš”ì²­ íƒœìŠ¤í¬ë¥¼ cancel() í•˜ê³ </strong> , ì—¬ê¸°ì„œ <strong>í•œ ë²ˆë§Œ</strong> <code class="language-plaintext highlighter-rouge">InterruptProcessingException</code>ì„ ë˜ì§„ë‹¤.</p>
  </li>
</ol>

<hr />

<h1 id="í—¬í¼-return-ë²„ì „-ë ˆë²¨-íŠ¸ë¦¬ê±°-ì†Œë¹„-ì•ˆ-í•¨">í—¬í¼: return ë²„ì „ (ë ˆë²¨ íŠ¸ë¦¬ê±°, ì†Œë¹„ ì•ˆ í•¨)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">comfy.model_management</span> <span class="k">as</span> <span class="n">mm</span>

<span class="c1"># sentinel: ê²°ê³¼ë¥¼ ëª…í™•íˆ êµ¬ë¶„í•˜ê³  ì‹¶ë‹¤ë©´ ì”€
</span><span class="n">INTERRUPTED</span> <span class="o">=</span> <span class="nf">object</span><span class="p">()</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">_wait_for_interrupt_level_trigger</span><span class="p">(</span><span class="n">poll_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">ComfyUI ì¸í„°ëŸ½íŠ¸ í”Œë˜ê·¸ë¥¼ </span><span class="sh">'</span><span class="s">ì½ê¸°ë§Œ</span><span class="sh">'</span><span class="s"> í•˜ë‹¤ê°€ ê°ì§€ë˜ë©´ ë°˜í™˜.</span><span class="sh">"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sleep_s</span> <span class="o">=</span> <span class="n">poll_ms</span> <span class="o">/</span> <span class="mf">1000.0</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">sleep_s</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mm</span><span class="p">.</span><span class="nf">processing_interrupted</span><span class="p">():</span>   <span class="c1"># â† ì†Œë¹„í•˜ì§€ ì•ŠìŒ(ì—¬ëŸ¬ ë…¸ë“œ ë™ì‹œ ê°ì§€ ê°€ëŠ¥)
</span>                <span class="k">return</span> <span class="n">INTERRUPTED</span>            <span class="c1"># ë˜ëŠ” True ê°™ì€ ê°„ë‹¨í•œ ê°’
</span>    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
        <span class="c1"># ë°”ê¹¥ì—ì„œ int_taskë¥¼ ì·¨ì†Œí•˜ë©´ ì—¬ê¸°ë¡œ ì˜´. ì •ë¦¬ í›„ ì „íŒŒ.
</span>        <span class="k">raise</span>
</code></pre></div></div>

<hr />

<h1 id="ë¹„-ìŠ¤íŠ¸ë¦¬ë°-ìš”ì²­ì—-ì ìš©">ë¹„-ìŠ¤íŠ¸ë¦¬ë° ìš”ì²­ì— ì ìš©</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>
<span class="kn">import</span> <span class="n">comfy.model_management</span> <span class="k">as</span> <span class="n">mm</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_node</span><span class="p">(</span><span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">()</span>
    <span class="n">req_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span>
        <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
            <span class="n">max_retries</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">int_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">_wait_for_interrupt_level_trigger</span><span class="p">())</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">({</span><span class="n">req_task</span><span class="p">,</span> <span class="n">int_task</span><span class="p">},</span>
                                     <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">int_task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
            <span class="c1"># 1) ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ì¦‰ì‹œ ì·¨ì†Œ
</span>            <span class="n">req_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">req_task</span>

            <span class="c1"># 2) (ì„ íƒ) ê°ì‹œ ê²°ê³¼ë¥¼ í™•ì¸í•´ë„ ë¨
</span>            <span class="n">_</span> <span class="o">=</span> <span class="n">int_task</span><span class="p">.</span><span class="nf">result</span><span class="p">()</span>  <span class="c1"># INTERRUPTED ê°™ì€ ê°’
</span>
            <span class="c1"># 3) ì—¬ê¸°ì„œ ë‹¨ í•œ ë²ˆ raise
</span>            <span class="k">raise</span> <span class="n">mm</span><span class="p">.</span><span class="nc">InterruptProcessingException</span><span class="p">()</span>

        <span class="c1"># ìš”ì²­ì´ ë¨¼ì € ëë‚¨ â†’ ê°ì‹œ íƒœìŠ¤í¬ ì·¨ì†Œ/ì •ë¦¬
</span>        <span class="n">int_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">int_task</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">req_task</span>
        <span class="k">return</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span><span class="p">.</span><span class="n">content</span>

    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
        <span class="c1"># ìƒìœ„ì—ì„œ ì´ ë…¸ë“œ íƒœìŠ¤í¬ ìì²´ë¥¼ ì·¨ì†Œí–ˆì„ ë•Œ
</span>        <span class="k">raise</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="ìŠ¤íŠ¸ë¦¬ë°ì—ë„-ë™ì¼-íŒ¨í„´">ìŠ¤íŠ¸ë¦¬ë°ì—ë„ ë™ì¼ íŒ¨í„´</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">contextlib</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">stream_node</span><span class="p">(</span><span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">stream</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">prompt</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">aiter</span> <span class="o">=</span> <span class="n">stream</span><span class="p">.</span><span class="nf">aiter_text</span><span class="p">()</span>
            <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">next_chunk</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">aiter</span><span class="p">.</span><span class="nf">__anext__</span><span class="p">())</span>
                <span class="n">int_task</span>   <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">_wait_for_interrupt_level_trigger</span><span class="p">())</span>

                <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">({</span><span class="n">next_chunk</span><span class="p">,</span> <span class="n">int_task</span><span class="p">},</span>
                                             <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">int_task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                    <span class="c1"># ìŠ¤íŠ¸ë¦¼/ì²­í¬ ì½ê¸° ì·¨ì†Œ ë° ì •ë¦¬
</span>                    <span class="n">next_chunk</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                    <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                        <span class="k">await</span> <span class="n">next_chunk</span>
                    <span class="k">await</span> <span class="n">stream</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
                    <span class="c1"># ì—¬ê¸°ì„œ raise í•œ ë²ˆ
</span>                    <span class="k">raise</span> <span class="n">mm</span><span class="p">.</span><span class="nc">InterruptProcessingException</span><span class="p">()</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">next_chunk</span><span class="p">.</span><span class="nf">result</span><span class="p">())</span>
                <span class="k">except</span> <span class="nb">StopAsyncIteration</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">int_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                    <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                        <span class="k">await</span> <span class="n">int_task</span>

            <span class="k">return</span> <span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="return-ë°©ì‹ì˜-ì¥ë‹¨ì -ìš”ì•½">return ë°©ì‹ì˜ ì¥ë‹¨ì  ìš”ì•½</h1>

<ul>
  <li>
    <p>âœ… <strong>ì¥ì </strong></p>

    <ul>
      <li>
        <p>í—¬í¼ ë‚´ë¶€ì—ì„œ ì˜ˆì™¸ ìŠ¤íƒì´ ì•ˆ ìƒê²¨ <strong>ë¡œê·¸ê°€ ë‹¨ì •</strong> í•´ì§.</p>
      </li>
      <li>
        <p>â€œëˆ„ê°€ ì˜ˆì™¸ë¥¼ ë˜ì§€ë‚˜?â€ê°€ <strong>ì½œëŸ¬ í•œ ì§€ì </strong> ìœ¼ë¡œ ëª¨ì—¬ <strong>ì •ì±… ì¼ê´€ì„±</strong> í™•ë³´.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>âš ï¸ <strong>ì£¼ì˜</strong></p>

    <ul>
      <li>
        <p>ë‚˜ì¤‘ì— ì‹¤ìˆ˜ë¡œ <code class="language-plaintext highlighter-rouge">int_task.result()</code>ë¥¼ ë‹¤ë¥¸ ê³³ì—ì„œ ì¨ë²„ë¦¬ë©´ <code class="language-plaintext highlighter-rouge">None</code>ì„ ë°›ì•„ í—·ê°ˆë¦´ ìˆ˜ ìˆì–´.<br />
â†’ ìœ„ì²˜ëŸ¼ <strong><code class="language-plaintext highlighter-rouge">INTERRUPTED</code> ì„¼í‹°ë„</strong>ì„ ë°˜í™˜í•´ ëª…ì‹œì ìœ¼ë¡œ êµ¬ë¶„í•˜ëŠ” ê±¸ ì¶”ì²œ.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">req_task</code>ê°€ ë¨¼ì € ëë‚œ ì¼€ì´ìŠ¤ì—ì„œ <code class="language-plaintext highlighter-rouge">int_task</code>ë¥¼ <strong>ë°˜ë“œì‹œ cancel &amp; await</strong>(suppress)ë¡œ ì •ë¦¬í•´ì•¼ ê²½ê³ ê°€ ì•ˆ ë‚¨ì•„.</p>
      </li>
    </ul>
  </li>
</ul>

<hr />

<h1 id="ì—¬ëŸ¬-ë…¸ë“œ-ë™ì‹œ-ì‹¤í–‰ì¼-ë•Œì˜-ì˜ë¯¸">ì—¬ëŸ¬ ë…¸ë“œ ë™ì‹œ ì‹¤í–‰ì¼ ë•Œì˜ ì˜ë¯¸</h1>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">processing_interrupted()</code>ë¥¼ <strong>ì½ê¸°ë§Œ</strong> í•˜ëŠ” ì´ ë°©ì‹ì€ <strong>ëª¨ë“  ë…¸ë“œê°€ ê°™ì€ ì¸í„°ëŸ½íŠ¸ë¥¼ í•¨ê»˜ ê°ì§€</strong> í•  ìˆ˜ ìˆê²Œ í•´.</p>
  </li>
  <li>
    <p>ê° ë…¸ë“œëŠ” ìê¸° ìš”ì²­ì„ ëŠê³ , <strong>ì½œëŸ¬ í•œ êµ°ë°ì—ì„œë§Œ</strong> <code class="language-plaintext highlighter-rouge">InterruptProcessingException</code>ì„ ë˜ì§€ë©´ ë¨(í˜¹ì€ ê° ë…¸ë“œê°€ ìê¸° ì»¨í…ìŠ¤íŠ¸ì—ì„œ ë˜ì ¸ë„ ë¬´ë°©).</p>
  </li>
  <li>
    <p>í•µì‹¬ì€ <strong><code class="language-plaintext highlighter-rouge">throw_exception_if_processing_interrupted()</code>ë¥¼ ë…¸ë“œ ë‚´ë¶€ í—¬í¼ì—ì„œ í˜¸ì¶œí•˜ì§€ ì•ŠëŠ” ê²ƒ</strong>(ê·¸ í•¨ìˆ˜ëŠ” í”Œë˜ê·¸ë¥¼ ì§€ìš°ë¯€ë¡œ â€˜ì²« ë²ˆì§¸ ì†Œë¹„â€™ ë¬¸ì œê°€ ìƒê¹€).</p>
  </li>
</ul>

<hr />

<p>ì •ë¦¬: <strong>ì‘, í—¬í¼ì—ì„œ<code class="language-plaintext highlighter-rouge">raise</code> ëŒ€ì‹  <code class="language-plaintext highlighter-rouge">return</code> í•´ë„ ì™„ì „íˆ OK.</strong><br />
ì˜¤íˆë ¤ ê¹”ë”í•  ë•Œê°€ ë§ê³ , ìœ„ íŒ¨í„´ëŒ€ë¡œ ì„¼í‹°ë„ì„ ë°˜í™˜í•´ì£¼ë©´ ì‹¤ìˆ˜ë„ ì¤„ì¼ ìˆ˜ ìˆì–´.</p>]]></content><author><name>hvppyarchive</name></author><category term="comfyui" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">VS Code ê²½ê³  í•´ê²°ë²•</title><link href="https://hvppyarchive.github.io/python/vscode-python-runtime-path/" rel="alternate" type="text/html" title="VS Code ê²½ê³  í•´ê²°ë²•" /><published>2025-10-10T10:52:16+09:00</published><updated>2025-10-10T10:52:16+09:00</updated><id>https://hvppyarchive.github.io/python/vscode-python-runtime-path</id><content type="html" xml:base="https://hvppyarchive.github.io/python/vscode-python-runtime-path/"><![CDATA[<p class="chat--user">

VS Codeì—ì„œ íŒŒì´ì¬ ì½”ë”© ì¤‘ì¸ë°, ì–´ë–¤ Frameworkì˜ Extensionì„ ê°œë°œ ì¤‘ì´ì•¼. ê·¸ëŸ°ë° ì½”ë“œì—ì„œ Frameworkì˜ ì½”ë“œë¥¼ Reference í•˜ëŠ”ë° ì´ê²Œ ë™ì‘ ì¤‘ì—ëŠ” ì˜ ë™ì‘í•˜ì§€ë§Œ ê°œë°œ ì¤‘ì—ëŠ” Frameworkì˜ ì†ŒìŠ¤ì½”ë“œëŠ” ê°™ì´ ë¶ˆëŸ¬ì˜¤ì§€ ì•Šê³  ì½”ë”©í•´ì„œ ì—ëŸ¬ì²˜ëŸ¼ ê²½ê³ ê°€ ëœ¨ê³  Go to definition ê°™ì€ ê¸°ëŠ¥ë„ ì˜ ë™ì‘í•˜ì§€ ì•Šì•„. ì´ë¥¼ í•´ê²°í•˜ëŠ” ë°©ë²• ìˆì„ê¹Œ

</p>

<p>ì¢‹ì•„, ìƒí™© ì •ë¦¬í•˜ë©´ â€œì‹¤í–‰ ë•ŒëŠ” ì˜ ë˜ëŠ”ë°, VS Codeì—ì„œ ê°œë°œí•  ë•Œ í”„ë ˆì„ì›Œí¬ ëª¨ë“ˆì„ ëª» ì°¾ì•„ì„œ ê²½ê³ /Go to Definitionì´ ì•ˆ ëœë‹¤â€ëŠ” ê±°ì§€. ì´ê±´ <strong>ì—ë””í„°ê°€ ì“°ëŠ” íŒŒì´ì¬ ì¸í„°í”„ë¦¬í„°/ê²€ìƒ‰ ê²½ë¡œì™€ ëŸ°íƒ€ì„ì˜ ê·¸ê²ƒì´ ë‹¤ë¥´ê¸° ë•Œë¬¸</strong> ì´ì•¼. ì•„ë˜ ìˆœì„œëŒ€ë¡œ í•˜ë©´ ê±°ì˜ í•­ìƒ í•´ê²°ë¼.</p>

<h1 id="1-ì—ë””í„°ê°€-ì‚¬ìš©í•˜ëŠ”-ì¸í„°í”„ë¦¬í„°ì—-í”„ë ˆì„ì›Œí¬ë¥¼-ì„¤ì¹˜">1) ì—ë””í„°ê°€ ì‚¬ìš©í•˜ëŠ” ì¸í„°í”„ë¦¬í„°ì— í”„ë ˆì„ì›Œí¬ë¥¼ ì„¤ì¹˜</h1>

<ol>
  <li>
    <p>í”„ë¡œì íŠ¸ìš© ê°€ìƒí™˜ê²½ì„ í•˜ë‚˜ ì •í•˜ê³ (ë˜ëŠ” ìƒˆë¡œ ë§Œë“¤ê³ ) VS Codeì—ì„œ <strong>Python: Select Interpreter</strong> ë¡œ ê·¸ ì¸í„°í”„ë¦¬í„°ë¥¼ ì„ íƒ.</p>
  </li>
  <li>
    <p>ê·¸ <strong>ê°™ì€</strong> ì¸í„°í”„ë¦¬í„°(venv)ì— í”„ë ˆì„ì›Œí¬ë¥¼ ì„¤ì¹˜.</p>

    <ul>
      <li>pip:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python <span class="nt">-m</span> venv .venv
.venv/Scripts/activate  <span class="c"># (Windows)  |  source .venv/bin/activate  # (macOS/Linux)</span>
pip <span class="nb">install</span> &lt;framework&gt;  <span class="c"># í•„ìš”í•œ extrasê°€ ìˆìœ¼ë©´ &lt;framework&gt;[dev] ì²˜ëŸ¼</span>
</code></pre></div>        </div>
      </li>
      <li>Poetry:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>poetry add <span class="nt">-G</span> dev &lt;framework&gt;
poetry <span class="nb">env </span>use &lt;íŒŒì´ì¬ê²½ë¡œ&gt;
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p>ì´ë ‡ê²Œ í•˜ë©´ Pylance/íŒŒì´ì¬ í™•ì¥ë„ ê·¸ venvì˜ <strong>site-packages</strong> ë¥¼ ë³´ê²Œ ë˜ì–´ ê²½ê³ ê°€ ì‚¬ë¼ì§€ê³  â€œGo to Definitionâ€ë„ ë™ì‘í•´.</p>
  </li>
</ol>

<h1 id="2-í”„ë ˆì„ì›Œí¬-ì†ŒìŠ¤ë¡œ-ë§ì¶°-ê°œë°œí•´ì•¼-í•œë‹¤ë©´-editable-install--ë©€í‹°ë£¨íŠ¸">2) í”„ë ˆì„ì›Œí¬ â€œì†ŒìŠ¤â€ë¡œ ë§ì¶° ê°œë°œí•´ì•¼ í•œë‹¤ë©´ (editable install / ë©€í‹°ë£¨íŠ¸)</h1>

<p>ëŸ°íƒ€ì„ê³¼ ë™ì¼í•œ ë²„ì „ì˜ <strong>ì†ŒìŠ¤</strong> ë¥¼ ë³´ê³  ì‹¶ê±°ë‚˜, í”„ë ˆì„ì›Œí¬ë¥¼ ë¡œì»¬ì—ì„œ ê°™ì´ ìˆ˜ì • ì¤‘ì´ë©´:</p>

<ul>
  <li>í”„ë ˆì„ì›Œí¬ repoë¥¼ ì˜†ì— ì²´í¬ì•„ì›ƒí•´ ë‘ê³  <strong>editable install</strong> :
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install</span> <span class="nt">-e</span> ../framework-repo  <span class="c"># src ë ˆì´ì•„ì›ƒì´ë©´ -e ../framework-repo[src]</span>
</code></pre></div>    </div>
  </li>
  <li>í˜¹ì€ VS Code <strong>ë©€í‹° ë£¨íŠ¸ ì›Œí¬ìŠ¤í˜ì´ìŠ¤</strong> ë¡œ ë‘ í´ë”ë¥¼ í•¨ê»˜ ì—´ê³ , Pylanceê°€ ê²½ë¡œë¥¼ ì•Œë„ë¡ <code class="language-plaintext highlighter-rouge">extraPaths</code>ë¥¼ ì§€ì •:<br />
<strong>.vscode/settings.json</strong>
    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"python.defaultInterpreterPath"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${workspaceFolder}/.venv/bin/python"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"python.analysis.extraPaths"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"../framework-repo"</span><span class="p">,</span><span class="w">          </span><span class="err">//</span><span class="w"> </span><span class="err">íŒ¨í‚¤ì§€</span><span class="w"> </span><span class="err">ë£¨íŠ¸</span><span class="w">
    </span><span class="s2">"../framework-repo/src"</span><span class="w">       </span><span class="err">//</span><span class="w"> </span><span class="err">src</span><span class="w"> </span><span class="err">ë ˆì´ì•„ì›ƒì¼</span><span class="w"> </span><span class="err">ë•Œ</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"python.analysis.typeCheckingMode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"basic"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
</ul>

<h1 id="3-ëŸ°íƒ€ì„ì—ì„œë§Œ-syspathê°€-ë°”ë€ŒëŠ”-í”„ë ˆì„ì›Œí¬í”ŒëŸ¬ê·¸ì¸í™•ì¥-í¬ì¸íŠ¸ì¼-ë•Œ">3) ëŸ°íƒ€ì„ì—ì„œë§Œ sys.pathê°€ ë°”ë€ŒëŠ” í”„ë ˆì„ì›Œí¬(í”ŒëŸ¬ê·¸ì¸/í™•ì¥ í¬ì¸íŠ¸)ì¼ ë•Œ</h1>

<p>í”„ë ˆì„ì›Œí¬ê°€ ì‹¤í–‰ ì‹œì ì—ë§Œ ê²½ë¡œë¥¼ ì¶”ê°€í•œë‹¤ë©´ ì—ë””í„°ëŠ” ê·¸ê±¸ ëª°ë¼. ë‘ ê°€ì§€ ì¤‘ í•˜ë‚˜ë¡œ ë§ì¶°ì¤˜:</p>

<ul>
  <li>
    <p><strong>PYTHONPATH</strong> ì‚¬ìš© (VS Codeê°€ ë¡œë“œí•˜ë„ë¡ <code class="language-plaintext highlighter-rouge">.env</code> í™œìš©)</p>

    <ul>
      <li><strong>.vscode/settings.json</strong>
        <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"python.envFile"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${workspaceFolder}/.env"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>        </div>
      </li>
      <li><strong>.env</strong>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">PYTHONPATH</span><span class="o">=</span>../framework-runtime-path:../another/path
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p>í˜¹ì€ ìœ„ì˜ <strong><code class="language-plaintext highlighter-rouge">python.analysis.extraPaths</code></strong>ë¡œ ë˜‘ê°™ì€ ê²½ë¡œë¥¼ ë„£ì–´ì¤˜.</p>
  </li>
</ul>

<h1 id="4-íƒ€ì…ì •ì˜ë§Œ-í•„ìš”í• -ë•ŒëŒ€í˜•ë¹„ê³µê°œ-í”„ë ˆì„ì›Œí¬">4) íƒ€ì…/ì •ì˜ë§Œ í•„ìš”í•  ë•Œ(ëŒ€í˜•/ë¹„ê³µê°œ í”„ë ˆì„ì›Œí¬)</h1>

<p>ì‹¤í–‰ ê°€ëŠ¥í•œ ì „ì²´ ì„¤ì¹˜ê°€ ë¶€ë‹´ìŠ¤ëŸ¬ìš°ë©´ <strong>stub(.pyi)</strong> ë§Œ ë§Œë“¤ì–´ì„œ ì°¸ì¡°í•´ë„ â€œGo to Definition/íƒ€ì… ì¶”ë¡ â€ì´ ì¢‹ì•„ì ¸.</p>

<ul>
  <li>Pyrightë¡œ ìŠ¤í… ìƒì„±:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pyright <span class="nt">--createstub</span> &lt;framework_pkg_name&gt;
</code></pre></div>    </div>
  </li>
</ul>

<p>ìƒì„±ëœ ìŠ¤í… í´ë”ë¥¼ í”„ë¡œì íŠ¸ì˜ <code class="language-plaintext highlighter-rouge">typings/</code>ì— ë‘ê³ :
    <code class="language-plaintext highlighter-rouge">json
    {
      "python.analysis.stubPath": "typings"
    }
   </code></p>

<ul>
  <li>mypyì˜ <code class="language-plaintext highlighter-rouge">stubgen</code>ì„ ì¨ë„ ë¨:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python <span class="nt">-m</span> mypy.stubgen <span class="nt">-m</span> &lt;framework_pkg_name&gt; <span class="nt">-o</span> typings
</code></pre></div>    </div>
  </li>
</ul>

<h1 id="5-ë„ì»¤ì›ê²©-ëŸ°íƒ€ì„ì—ì„œë§Œ-ì„¤ì¹˜ë˜ì–´-ìˆì„-ë•Œ">5) ë„ì»¤/ì›ê²© ëŸ°íƒ€ì„ì—ì„œë§Œ ì„¤ì¹˜ë˜ì–´ ìˆì„ ë•Œ</h1>

<p>ëŸ°íƒ€ì„ì´ Docker/ì›ê²©(SSH)ë¼ë©´ <strong>Dev Containers</strong> ë˜ëŠ” <strong>Remote - SSH</strong> í™•ì¥ìœ¼ë¡œ â€œì½”ë”©ë„ ê·¸ í™˜ê²½ì—ì„œâ€ í•˜ê²Œ ë§Œë“œëŠ” ê²Œ ì œì¼ ê¹”ë”í•´. ê·¸ëŸ¬ë©´ ì—ë””í„°ê°€ ë³´ëŠ” ì¸í„°í”„ë¦¬í„° == ëŸ°íƒ€ì„ ì¸í„°í”„ë¦¬í„°ê°€ ë˜ì–´ ê²½ë¡œ ë¬¸ì œ ìì²´ê°€ ì‚¬ë¼ì§.</p>

<h1 id="6-ì¶”ê°€-íŒ-ìì˜í•˜ì§€ë§Œ-ìœ ìš©">6) ì¶”ê°€ íŒ (ìì˜í•˜ì§€ë§Œ ìœ ìš©)</h1>

<ul>
  <li>
    <p>ê²½ê³ ë§Œ ì ê¹ ìˆ¨ê¸°ë ¤ë©´(ì›ì¸ í•´ê²° ì „ ì„ì‹œ):</p>

    <ul>
      <li>íŒŒì¼ ìƒë‹¨ì— <code class="language-plaintext highlighter-rouge"># pyright: reportMissingImports=false</code> (í˜¹ì€ í•´ë‹¹ import ì¤„ì— <code class="language-plaintext highlighter-rouge"># type: ignore[import]</code>)<br />
â†’ ê·¼ë³¸ í•´ê²°ì€ ì•„ë‹˜.</li>
    </ul>
  </li>
  <li>
    <p>ë„¤ì„ìŠ¤í˜ì´ìŠ¤ íŒ¨í‚¤ì§€(PEP 420)ë‚˜ <code class="language-plaintext highlighter-rouge">src/</code> ë ˆì´ì•„ì›ƒì´ë©´ <strong>íŒ¨í‚¤ì§€ ë£¨íŠ¸</strong> ê°€ ë§ê²Œ ì¡í˜”ëŠ”ì§€ í™•ì¸.</p>
  </li>
  <li>
    <p>ë™ì  ì†ì„±/ì»´íŒŒì¼ë“œ ëª¨ë“ˆì´ë¼ ì •ì˜ ì í”„ê°€ ì–´ë ¤ìš°ë©´:</p>
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span>
<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">framework</span> <span class="kn">import</span> <span class="n">FancyAPI</span>  <span class="c1"># ì—ë””í„°ìš© íŒíŠ¸
</span></code></pre></div>    </div>
  </li>
</ul>

<hr />

<h2 id="ê°€ì¥-ë¹ ë¥¸-ì²´í¬ë¦¬ìŠ¤íŠ¸">ê°€ì¥ ë¹ ë¥¸ ì²´í¬ë¦¬ìŠ¤íŠ¸</h2>

<ol>
  <li>
    <p>VS Codeì—ì„œ <strong>Python Interpreter</strong> ê°€ ë‚´ê°€ ì“°ëŠ” venvë¡œ ë§ë‚˜?</p>
  </li>
  <li>
    <p>ê·¸ venvì— <strong>í”„ë ˆì„ì›Œí¬ê°€ ì„¤ì¹˜</strong> ë˜ì–´ ìˆë‚˜(ë˜ëŠ” <code class="language-plaintext highlighter-rouge">pip install -e</code>ë¡œ ì—°ê²°í–ˆë‚˜)?</p>
  </li>
  <li>
    <p>ì†ŒìŠ¤ íŠ¸ë¦¬ë¼ë©´ <strong><code class="language-plaintext highlighter-rouge">python.analysis.extraPaths</code>/<code class="language-plaintext highlighter-rouge">PYTHONPATH</code></strong>ê°€ í”„ë ˆì„ì›Œí¬ ë£¨íŠ¸ë¥¼ ê°€ë¦¬í‚¤ë‚˜?</p>
  </li>
  <li>
    <p>íŠ¹ë³„í•œ ê²½ìš°ì—” <strong>stub</strong> ìƒì„±í•´ì„œ <code class="language-plaintext highlighter-rouge">stubPath</code> ì„¤ì •.</p>
  </li>
</ol>

<p>ì›í•˜ì‹œë©´ í˜„ì¬ í”„ë¡œì íŠ¸ êµ¬ì¡°(í´ë” ë ˆì´ì•„ì›ƒ/ê°€ìƒí™˜ê²½/ì„¤ì¹˜ ë°©ì‹) ì•Œë ¤ì¤˜. ê±°ê¸°ì— ë§ì¶˜ <strong>settings.json / .env / ì„¤ì¹˜ ì»¤ë§¨ë“œ</strong> ë¥¼ ë”± ë§ê²Œ ì¨ì¤„ê²Œ.</p>]]></content><author><name>hvppyarchive</name></author><category term="python" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">Async request ì·¨ì†Œ ì²˜ë¦¬</title><link href="https://hvppyarchive.github.io/comfyui/async-request/" rel="alternate" type="text/html" title="Async request ì·¨ì†Œ ì²˜ë¦¬" /><published>2025-10-10T10:33:16+09:00</published><updated>2025-10-10T10:33:16+09:00</updated><id>https://hvppyarchive.github.io/comfyui/async-request-</id><content type="html" xml:base="https://hvppyarchive.github.io/comfyui/async-request/"><![CDATA[<p class="chat--user">

comfyuiì—ì„œ custom nodeì˜ ë©”ì¸ í•¨ìˆ˜ë¥¼ asyncë¡œ ë§Œë“¤ ìˆ˜ ìˆê²Œ ë˜ì—ˆì–´. ê·¸ë¦¬ê³ , openai python íŒ¨í‚¤ì§€ì—ì„œ AsyncOpenAIì™€ aiohttpë¥¼ ì´ìš©í•´ì„œ asyncí•˜ê²Œ requestë¥¼ ë³´ë‚¼ ìˆ˜ ìˆì–´. ê·¼ë° ë¬¸ì œëŠ” UIì—ì„œ stopì„ ë³´ë‚´ê³  interruptê°€ ì¦‰ì‹œ ë™ì‘í•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ”ê±°ì•¼. requestë¥¼ ë³´ë‚¸ í›„ await í•˜ëŠ” ë„ì¤‘ì— ì‘ì—…ì´ ì·¨ì†Œë˜ê²Œ í•˜ê³  ì‹¶ì–´

</p>

<p>ì¢‹ì•„, í•µì‹¬ì€ â€œë„¤íŠ¸ì›Œí¬ ìš”ì²­ await ì¤‘ì—ë„ ë°”ë¡œ ëŠê¸°ê²Œâ€ ë§Œë“œëŠ” ê±°ì•¼.<br />
asyncioì—ì„œëŠ” <strong>ì·¨ì†Œ ì‹ í˜¸ì™€ ì‹¤ì œ ì‘ì—…ì„ â€˜ê²½ìŸ(race)â€™</strong> ì‹œí‚¤ë©´ ë¼. ì¦‰, ìš”ì²­ì„ <code class="language-plaintext highlighter-rouge">Task</code>ë¡œ ë§Œë“¤ê³ , UIì—ì„œ ì˜¤ëŠ” stop ì‹ í˜¸(ì´í•˜ <code class="language-plaintext highlighter-rouge">stop_event</code>)ì˜ <code class="language-plaintext highlighter-rouge">wait()</code>ë„ <code class="language-plaintext highlighter-rouge">Task</code>ë¡œ ë§Œë“¤ì–´ì„œ <strong>ë‘˜ ì¤‘ ë¨¼ì € ëë‚˜ëŠ” ìª½</strong> ì„ ë³´ê³  í–‰ë™ì„ ë°”ê¾¸ë©´ ì¦‰ì‹œ ì¤‘ë‹¨ì´ ê°€ëŠ¥í•´.</p>

<p>ì•„ë˜ë¥¼ ê·¸ëŒ€ë¡œ ê°€ì ¸ë‹¤ ì“¸ ìˆ˜ ìˆê²Œ ë‹¨ê³„ë³„(ê·¸ë¦¬ê³  ì•ˆì „í•œ) íŒ¨í„´ìœ¼ë¡œ ì •ë¦¬í–ˆì–´.</p>

<hr />

<h1 id="1-ê³µí†µ-ìœ í‹¸-ì·¨ì†Œ-ê°€ëŠ¥í•œ-await-ë˜í¼">1) ê³µí†µ ìœ í‹¸: ì·¨ì†Œ ê°€ëŠ¥í•œ await ë˜í¼</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>

<span class="k">class</span> <span class="nc">StopByUser</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">UI stop/interruptë¡œ ì¤‘ë‹¨ë˜ì—ˆìŒì„ ë‚˜íƒ€ë‚´ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ ì˜ˆì™¸.</span><span class="sh">"""</span>
    <span class="k">pass</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">await_cancellable</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    coro(ì½”ë£¨í‹´)ì™€ stop_event.wait()ë¥¼ ê²½ìŸì‹œí‚¨ë‹¤.
    - stopì´ ë¨¼ì € ì˜¤ë©´ coro Taskë¥¼ cancelí•˜ê³  ì •ë¦¬í•œ ë’¤ StopByUserë¥¼ ì˜¬ë¦°ë‹¤.
    - ìš”ì²­ì´ ë¨¼ì € ëë‚˜ë©´ stop ëŒ€ê¸° Taskë¥¼ ì·¨ì†Œí•˜ê³  ê²°ê³¼ë¥¼ ë°˜í™˜í•œë‹¤.
    </span><span class="sh">"""</span>
    <span class="n">req_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">coro</span><span class="p">)</span>
    <span class="n">stop_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">stop_event</span><span class="p">.</span><span class="nf">wait</span><span class="p">())</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">done</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span>
            <span class="p">{</span><span class="n">req_task</span><span class="p">,</span> <span class="n">stop_task</span><span class="p">},</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">stop_task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
            <span class="c1"># UIê°€ stopì„ ëˆŒë €ë‹¤: ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì„ ì·¨ì†Œ
</span>            <span class="n">req_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
            <span class="c1"># ì·¨ì†Œ ì •ë¦¬ ëê¹Œì§€ ê¸°ë‹¤ë ¤ ê²½ê³ /ë¦¬ì†ŒìŠ¤ ëˆ„ìˆ˜ ë°©ì§€
</span>            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">req_task</span>
            <span class="k">raise</span> <span class="nc">StopByUser</span><span class="p">(</span><span class="sh">"</span><span class="s">Stopped by user</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># ìš”ì²­ì´ ë¨¼ì € ëë‚¨: stop ëŒ€ê¸°ëŠ” ì·¨ì†Œ
</span>        <span class="n">stop_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">stop_task</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">req_task</span>  <span class="c1"># ê²°ê³¼ ë¦¬í„´
</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
        <span class="c1"># ë°”ê¹¥ ì»¨í…ìŠ¤íŠ¸(ComfyUI ì‹¤í–‰ê¸°)ê°€ ì´ Task ìì²´ë¥¼ ì·¨ì†Œí•œ ê²½ìš°: ë°”ë¡œ ì „íŒŒ
</span>        <span class="k">raise</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># í˜¹ì‹œ ë‚¨ì•„ìˆìœ¼ë©´ í™•ì‹¤íˆ ì •ë¦¬
</span>        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="n">req_task</span><span class="p">,</span> <span class="n">stop_task</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">.</span><span class="nf">done</span><span class="p">():</span>
                <span class="n">t</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">t</span>
</code></pre></div></div>

<blockquote>
  <p>ì¤‘ìš”: ì½”ë“œ ì–´ë”˜ê°€ì— <code class="language-plaintext highlighter-rouge">except Exception:</code> ê°™ì€ ê´‘ë²”ìœ„í•œ ì˜ˆì™¸ ì²˜ë¦¬ê¸°ê°€ ìˆë‹¤ë©´, <strong>ë°˜ë“œì‹œ</strong><br />
 <code class="language-plaintext highlighter-rouge">except asyncio.CancelledError: raise</code> ë¥¼ <strong>ë§¨ ìœ„ì— ë”°ë¡œ</strong> ë‘ì–´ ì·¨ì†Œê°€ ì‚¼ì¼œì§€ì§€ ì•Šê²Œ í•˜ì„¸ìš”.<br />
 (íŒŒì´ì¬ ë²„ì „ì— ë”°ë¼ <code class="language-plaintext highlighter-rouge">CancelledError</code>ê°€ ì¼ë°˜ <code class="language-plaintext highlighter-rouge">Exception</code>ì— ì¡í ìˆ˜ ìˆìœ¼ë‹ˆ ëª…ì‹œì ìœ¼ë¡œ ë¶„ê¸°í•˜ëŠ” ê²Œ ì•ˆì „í•©ë‹ˆë‹¤.)</p>
</blockquote>

<hr />

<h1 id="2-comfyui-ì»¤ìŠ¤í…€-ë…¸ë“œmainasyncì—ì„œ-ì ìš©">2) ComfyUI ì»¤ìŠ¤í…€ ë…¸ë“œ(main=async)ì—ì„œ ì ìš©</h1>

<p>ComfyUIê°€ stopì„ ëˆ„ë¥´ë©´ ë‚´ë¶€ì ìœ¼ë¡œ â€œì¤‘ë‹¨ í”Œë˜ê·¸/ì´ë²¤íŠ¸â€ê°€ ì¼œì§ˆ í…ë°, ê·¸ê±¸ <code class="language-plaintext highlighter-rouge">stop_event</code>(asyncio.Event í˜¸í™˜)ë¡œ ë°›ëŠ”ë‹¤ê³  ê°€ì •í•´ ë³´ì.<br />
(ComfyUIì—ì„œ ì œê³µí•˜ëŠ” ì‹¤ì œ ì¸í„°ëŸ½íŠ¸ ì‹ í˜¸ë¥¼ ì–´ë–»ê²Œ ì–»ëŠ”ì§€ëŠ” í”„ë¡œì íŠ¸ë§ˆë‹¤ ë‹¤ë¥¼ ìˆ˜ ìˆì–´. ë…¸ë“œì— ì£¼ì… ë°›ê±°ë‚˜, ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸ì—ì„œ êº¼ë‚´ ì“°ëŠ” ì‹ìœ¼ë¡œ ì—°ê²°í•´ ì£¼ë©´ ëœë‹¤.)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>

<span class="k">class</span> <span class="nc">AsyncLLMNode</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">prompt</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">})}}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">main</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LLM</span><span class="sh">"</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">stop_event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c1"># stop_eventëŠ” ComfyUI ìª½ì—ì„œ ë„˜ê²¨ì£¼ë„ë¡ ì—°ê²°í•´ ë‘ëŠ” ê±¸ ê¶Œì¥
</span>        <span class="k">if</span> <span class="n">stop_event</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># ìµœì•…ì˜ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ë”ë¯¸ (ì¦‰ì‹œ ì™„ë£Œë˜ì§€ ì•ŠìŒ)
</span>            <span class="n">stop_event</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Event</span><span class="p">()</span>

        <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">()</span>  <span class="c1"># í•„ìš”ì‹œ api_key, base_url ë“± ì„¤ì •
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># â—‡ ë¹„-ìŠ¤íŠ¸ë¦¬ë° ìš”ì²­ ì˜ˆì‹œ
</span>            <span class="n">coro</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
                <span class="n">temperature</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">await_cancellable</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span><span class="p">.</span><span class="n">content</span>
            <span class="nf">return </span><span class="p">(</span><span class="n">text</span><span class="p">,)</span>

        <span class="k">except</span> <span class="n">StopByUser</span><span class="p">:</span>
            <span class="c1"># ComfyUIê°€ ì¦‰ì‹œ ë©ˆì·„ìŒì„ ìœ„ìª½ìœ¼ë¡œ ì•Œë¦¬ê±°ë‚˜, ë¹ˆ ê²°ê³¼/ìƒíƒœ ë©”ì‹œì§€ë¥¼ ë°˜í™˜
</span>            <span class="c1"># ComfyUI ìª½ ì •ì±…ì— ë§ì¶° raise/return ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒ
</span>            <span class="k">raise</span>  <span class="c1"># ë³´í†µì€ raiseë¡œ ì „íŒŒí•˜ëŠ” ê²Œ ì¸í„°ëŸ½íŠ¸ ì²´ì¸ì— ì¶©ì‹¤
</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="c1"># ë°”ê¹¥ì—ì„œ Task ìì²´ê°€ ì·¨ì†Œëœ ê²½ìš°
</span>            <span class="k">raise</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># http ì»¤ë„¥ì…˜ ì •ë¦¬
</span>            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="3-ìŠ¤íŠ¸ë¦¬ë°ë¶€ë¶„-ì‘ë‹µì¼-ë•Œë„-ì¦‰ì‹œ-ì¤‘ë‹¨">3) ìŠ¤íŠ¸ë¦¬ë°(ë¶€ë¶„ ì‘ë‹µ)ì¼ ë•Œë„ ì¦‰ì‹œ ì¤‘ë‹¨</h1>

<p>ìŠ¤íŠ¸ë¦¬ë°ì€ ë‚´ë¶€ì ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">async for</code>ë¡œ ì²­í¬ë¥¼ ì½ëŠ” ë™ì•ˆ <code class="language-plaintext highlighter-rouge">__anext__()</code>ì—ì„œ ë¸”ë¡ë¼ì„œ<br />
stopì„ ëˆŒëŸ¬ë„ ë°”ë¡œ ë°˜ì‘ì„ ëª»í•  ìˆ˜ ìˆì–´. ì´ë•Œë„ <strong>chunk ì½ê¸° vs stop</strong> ë¥¼ ê²½ìŸì‹œí‚¤ë©´ í•´ê²°ë¼.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">stream_chat_cancellable</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">):</span>
    <span class="c1"># ìƒˆë¡œìš´ Responses API ì˜ˆì‹œ (í•„ìš”ì— ë§ì¶° Chat Completionsë¡œ ë°”ê¿”ë„ ë™ì¼ íŒ¨í„´)
</span>    <span class="k">async</span> <span class="k">with</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">stream</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
        <span class="n">aiter</span> <span class="o">=</span> <span class="n">stream</span><span class="p">.</span><span class="nf">aiter_text</span><span class="p">()</span>  <span class="c1"># í…ìŠ¤íŠ¸ ì²­í¬ ì´í„°ë ˆì´í„°
</span>        <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">next_chunk</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">aiter</span><span class="p">.</span><span class="nf">__anext__</span><span class="p">())</span>
            <span class="n">stop_task</span>  <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">stop_event</span><span class="p">.</span><span class="nf">wait</span><span class="p">())</span>
            <span class="n">done</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span>
                <span class="p">{</span><span class="n">next_chunk</span><span class="p">,</span> <span class="n">stop_task</span><span class="p">},</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">stop_task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="c1"># ì½ê¸° ì¤‘ë‹¨ + ì—°ê²° ì •ë¦¬
</span>                <span class="n">next_chunk</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">next_chunk</span>
                <span class="k">await</span> <span class="n">stream</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>  <span class="c1"># ì„œë²„ ìª½ ìŠ¤íŠ¸ë¦¼ë„ ë‹«ê¸°
</span>                <span class="k">raise</span> <span class="nc">StopByUser</span><span class="p">(</span><span class="sh">"</span><span class="s">Stopped by user</span><span class="sh">"</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">next_chunk</span><span class="p">.</span><span class="nf">result</span><span class="p">())</span>
            <span class="k">except</span> <span class="nb">StopAsyncIteration</span><span class="p">:</span>
                <span class="c1"># ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ
</span>                <span class="k">break</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">stop_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">stop_task</span>

        <span class="k">return</span> <span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>
</code></pre></div></div>

<p>ComfyUI ë…¸ë“œì—ì„œ:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">stop_event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">stop_event</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">stop_event</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Event</span><span class="p">()</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">stream_chat_cancellable</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">text</span><span class="p">,)</span>
    <span class="k">except</span> <span class="n">StopByUser</span><span class="p">:</span>
        <span class="k">raise</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="4-aiohttp-ìˆœìˆ˜-ì‚¬ìš©-ì‹œ-ì˜ˆì‹œ">4) aiohttp ìˆœìˆ˜ ì‚¬ìš© ì‹œ ì˜ˆì‹œ</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">aiohttp</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">contextlib</span>
<span class="kn">from</span> <span class="n">yarl</span> <span class="kn">import</span> <span class="n">URL</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">fetch_json_cancellable</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="p">.</span><span class="nc">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="c1"># POST ì½”ë£¨í‹´ ìƒì„±
</span>        <span class="k">async</span> <span class="k">def</span> <span class="nf">do_post</span><span class="p">():</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
                <span class="n">resp</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">resp</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>

        <span class="k">return</span> <span class="k">await</span> <span class="nf">await_cancellable</span><span class="p">(</span><span class="nf">do_post</span><span class="p">(),</span> <span class="n">stop_event</span><span class="p">)</span>
</code></pre></div></div>

<blockquote>
  <p>ì°¸ê³ : <code class="language-plaintext highlighter-rouge">aiohttp</code>ëŠ” Task ì·¨ì†Œ ì‹œ ì†Œì¼“ì„ ë‹«ìœ¼ë©° <code class="language-plaintext highlighter-rouge">CancelledError</code>ê°€ ì „íŒŒë¼ìš”.<br />
 ìœ„ì˜ íŒ¨í„´ì²˜ëŸ¼ <em>í•­ìƒ</em> loser taskë¥¼ <code class="language-plaintext highlighter-rouge">cancel()</code>í•˜ê³  <code class="language-plaintext highlighter-rouge">await</code>í•´ì„œ ê²½ê³  ì—†ì´ ì •ë¦¬í•˜ì„¸ìš”.</p>
</blockquote>

<hr />

<h1 id="5-í”í•œ-ì¦‰ì‹œ-ì¤‘ë‹¨ì´-ì•ˆ-ë˜ëŠ”-ì›ì¸-ì²´í¬ë¦¬ìŠ¤íŠ¸">5) í”í•œ â€œì¦‰ì‹œ ì¤‘ë‹¨ì´ ì•ˆ ë˜ëŠ”â€ ì›ì¸ ì²´í¬ë¦¬ìŠ¤íŠ¸</h1>

<ol>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">CancelledError</code>ë¥¼ ì‚¼í‚¤ëŠ” ì˜ˆì™¸ ì²˜ë¦¬</strong></p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">except Exception:</code> ì´ ìˆë‹¤ë©´ ë°”ë¡œ ìœ„ì— <code class="language-plaintext highlighter-rouge">except asyncio.CancelledError: raise</code> ë¥¼ ì¶”ê°€.</li>
    </ul>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">await</code> ì—†ì´ ë™ê¸° ë¸”ë¡œí‚¹ ì½”ë“œ</strong></p>

    <ul>
      <li>CPU ë°”ìš´ë“œ ë£¨í”„/ë¸”ë¡œí‚¹ I/OëŠ” ì´ë²¤íŠ¸ ë£¨í”„ë¥¼ ë§‰ì•„ ì·¨ì†Œê°€ ëŠ¦ì–´ì§ â†’ <code class="language-plaintext highlighter-rouge">await</code> ê°€ëŠ¥í•œ APIë¡œ ë°”ê¾¸ê±°ë‚˜, <code class="language-plaintext highlighter-rouge">run_in_executor()</code>ë¡œ ë¶„ë¦¬.</li>
    </ul>
  </li>
  <li>
    <p><strong>ìŠ¤íŠ¸ë¦¬ë° ë£¨í”„ì—ì„œ stopì„ ì•ˆ ë³´ê³  ìˆìŒ</strong></p>

    <ul>
      <li>ìœ„ì˜ â€œìŠ¤íŠ¸ë¦¬ë° ê²½ìŸâ€ íŒ¨í„´ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">__anext__()</code>ì™€ <code class="language-plaintext highlighter-rouge">stop_event.wait()</code>ë¥¼ ê²½ìŸì‹œí‚¤ê¸°.</li>
    </ul>
  </li>
  <li>
    <p><strong>ì •ë¦¬(cleanup)ë¥¼ ì·¨ì†Œê°€ ë®ì–´ë²„ë¦¼</strong></p>

    <ul>
      <li>ì •ë¦¬ ê³¼ì •ì€ <code class="language-plaintext highlighter-rouge">asyncio.shield()</code>ë¡œ ê°ì‹¸ê±°ë‚˜ <code class="language-plaintext highlighter-rouge">with contextlib.suppress(asyncio.CancelledError)</code>ë¡œ ë§ˆë¬´ë¦¬.</li>
    </ul>
  </li>
  <li>
    <p><strong>ê¸´ ë„¤íŠ¸ì›Œí¬ íƒ€ì„ì•„ì›ƒ</strong></p>

    <ul>
      <li>ì·¨ì†Œ ìì²´ëŠ” íƒ€ì„ì•„ì›ƒê³¼ ë¬´ê´€í•˜ì§€ë§Œ, ë¼ì´ë¸ŒëŸ¬ë¦¬ ì •ë¦¬ê°€ ì§€ì—°ë  ìˆ˜ ìˆìŒ â†’ ì„¸ì…˜/ìŠ¤íŠ¸ë¦¼ì„ <code class="language-plaintext highlighter-rouge">close()</code> í•´ì£¼ê¸°.</li>
    </ul>
  </li>
</ol>

<hr />

<h1 id="6-comfyui-ìª½-stop_event-ì—°ê²°-íŒ">6) ComfyUI ìª½ â€˜stop_eventâ€™ ì—°ê²° íŒ</h1>

<ul>
  <li>
    <p>í”„ë¡œì íŠ¸ì— ë”°ë¼ ë‹¤ë¥´ì§€ë§Œ, ë³´í†µ <strong>ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸</strong> ë‚˜ <strong>ë…¸ë“œ ì¸ì ì£¼ì…</strong> ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">asyncio.Event</code>ë¥¼ ë°›ì„ ìˆ˜ ìˆê²Œ í•´ë‘ë©´ ê°€ì¥ ê¹”ë”í•´.</p>
  </li>
  <li>
    <p>ë§Œì•½ ì§€ê¸ˆì€ ê·¸ëŸ° í›…ì´ ì—†ë‹¤ë©´:</p>

    <ul>
      <li>
        <p>ìµœì†Œí•œ ì£¼ê¸°ì ìœ¼ë¡œ í™•ì¸í•˜ëŠ” pollingì„ ë„£ëŠ” ëŒ€ì‹ , <strong>ìœ„ì˜ ê²½ìŸ íŒ¨í„´</strong> ì„ ì‚¬ìš©í•˜ë©´ â€œawait ì¤‘ì—ë„â€ ë°”ë¡œ ë°˜ì‘í•œë‹¤.</p>
      </li>
      <li>
        <p>stopì„ ëˆ„ë¥¼ ë•Œ ë…¸ë“œ ì¸¡ì— <code class="language-plaintext highlighter-rouge">stop_event.set()</code>ì´ í˜¸ì¶œë˜ë„ë¡ ì—°ê²°(ì£¼ì…)ë§Œ í•´ì£¼ë©´ ëœë‹¤.</p>
      </li>
    </ul>
  </li>
</ul>

<hr />

<p>í•„ìš”í•˜ë©´ ë„ˆì˜ í˜„ì¬ ë…¸ë“œ ì½”ë“œ ì¼ë¶€ë¥¼ ë¶™ì—¬ì¤˜. ê±°ê¸°ì— ë§ì¶° <code class="language-plaintext highlighter-rouge">await_cancellable</code>ì„ ë”± ë“¤ì–´ë§ê²Œ ë¦¬íŒ©í„°ë§í•´ ì¤„ê²Œ.</p>

<p class="chat--user">

stop_eventë¥¼ ë„£ëŠ”ë‹¤ëŠ”ê²Œ ë­”ì§€ ëª¨ë¥´ê² ì–´. comfyui ë‚´ë¶€ì ìœ¼ë¡œ interrupt ë²„íŠ¼ì´ ìˆì–ì•„? ê·¸ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ì·¨ì†Œë˜ë©´ ì¢‹ê² ì–´

</p>

<p>ì¢‹ì•„, â€œUIì˜ Interrupt ë²„íŠ¼(ë˜ëŠ” /interrupt)ì´ ëˆŒë¦¬ë©´ ë‚´ async ì»¤ìŠ¤í…€ ë…¸ë“œê°€ ì§€ê¸ˆ <code class="language-plaintext highlighter-rouge">await</code> ì¤‘ì¸ OpenAI ìš”ì²­ì„ ì¦‰ì‹œ ëŠê³  ì‹¶ë‹¤â€ê°€ ëª©í‘œì§€ìš”. í•µì‹¬ì€ <strong>ComfyUIê°€ ì¸í„°ëŸ½íŠ¸ë¥¼ â€œí”Œë˜ê·¸â€ë¡œë§Œ ì•Œë¦¬ê³ , ì‹¤ì œë¡œëŠ” ë…¸ë“œê°€ í˜‘ì¡°ì ìœ¼ë¡œ ì·¨ì†Œë¥¼ ì²˜ë¦¬í•´ì•¼</strong> í•œë‹¤ëŠ” ì ì´ì—ìš”. ì•„ë˜ë¥¼ ê·¸ëŒ€ë¡œ ë„£ìœ¼ë©´ ë©ë‹ˆë‹¤ â€” ë‹¨ê³„ë³„ë¡œ ì„¤ëª…í• ê²Œìš”.</p>

<hr />

<h2 id="1-comfyuiê°€-ì¸í„°ëŸ½íŠ¸ë¥¼-ì–´ë–»ê²Œ-ì•Œë¦¬ëƒ">1) ComfyUIê°€ ì¸í„°ëŸ½íŠ¸ë¥¼ ì–´ë–»ê²Œ ì•Œë¦¬ëƒ</h2>

<ul>
  <li>
    <p>í”„ë¡ íŠ¸ì—”ë“œ Interrupt ë²„íŠ¼/ë‹¨ì¶•í‚¤ê°€ <strong><code class="language-plaintext highlighter-rouge">POST /interrupt</code></strong> ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. ì„œë²„ëŠ” ë‚´ë¶€ ì¸í„°ëŸ½íŠ¸ í”Œë˜ê·¸ë¥¼ ì„¸íŒ…í•´ìš”. <a href="https://docs.comfy.org/development/comfyui-server/comms_routes?utm_source=chatgpt.com">ComfyUI+2</a></p>
  </li>
  <li>
    <p>ì‹¤í–‰ê¸°ëŠ” ë‹¤ìŒ ë…¸ë“œ ê²½ê³„ í˜¹ì€ ë…¸ë“œ ë‚´ë¶€ì—ì„œ ì²´í¬ë  ë•Œ <strong><code class="language-plaintext highlighter-rouge">InterruptProcessingException</code></strong> ìœ¼ë¡œ ì¤‘ë‹¨ì„ ì „íŒŒí•˜ê³ , ì›¹ì†Œì¼“ ì´ë²¤íŠ¸ <strong><code class="language-plaintext highlighter-rouge">execution_interrupted</code></strong> ë¥¼ ë³´ëƒ…ë‹ˆë‹¤. <a href="https://docs.comfy.org/development/comfyui-server/comms_messages?utm_source=chatgpt.com">ComfyUI</a></p>
  </li>
  <li>
    <p>ë‹¨, <strong>ë…¸ë“œê°€ ë¸”ë¡œí‚¹ ìƒíƒœ(íƒ€ì´íŠ¸ ë£¨í”„/ë¸”ë¡œí‚¹ I/O)</strong> ë©´ ì¸í„°ëŸ½íŠ¸ê°€ ë°”ë¡œ ì²˜ë¦¬ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ ë…¸ë“œê°€ <strong>ì£¼ê¸°ì ìœ¼ë¡œ ì¸í„°ëŸ½íŠ¸ë¥¼ ì²´í¬</strong> í•˜ê±°ë‚˜ <strong><code class="language-plaintext highlighter-rouge">await</code> ë¥¼ ì·¨ì†Œ</strong>í•´ ì¤˜ì•¼ í•´ìš”. <a href="https://github.com/comfyanonymous/ComfyUI/issues/3131?utm_source=chatgpt.com">GitHub</a></p>
  </li>
</ul>

<hr />

<h2 id="2-ì»¤ìŠ¤í…€-ë…¸ë“œì—ì„œ-í˜‘ì¡°ì -ì·¨ì†Œë¥¼-ë¶™ì´ëŠ”-ê°€ì¥-ì‰¬ìš´-ë°©ë²•">2) ì»¤ìŠ¤í…€ ë…¸ë“œì—ì„œ â€œí˜‘ì¡°ì  ì·¨ì†Œâ€ë¥¼ ë¶™ì´ëŠ” ê°€ì¥ ì‰¬ìš´ ë°©ë²•</h2>

<p>ComfyUIëŠ” <code class="language-plaintext highlighter-rouge">comfy.model_management.throw_exception_if_processing_interrupted()</code> ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ì´ê±¸ ì£¼ê¸°ì ìœ¼ë¡œ í˜¸ì¶œí•˜ë©´ ì¸í„°ëŸ½íŠ¸ ì‹œ <code class="language-plaintext highlighter-rouge">InterruptProcessingException</code> ì„ ë˜ì ¸ìš”. (ê³µì‹ ì½”ë“œì™€ ì—¬ëŸ¬ ì˜ˆì‹œ ë…¸ë“œì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤.) <a href="https://gitee.com/bug531/comfy-ui/blob/master/main.py?skip_mobile=true&amp;utm_source=chatgpt.com">Gitee+2</a></p>

<p>ì•„ì´ë””ì–´: <strong>ìš”ì²­ íƒœìŠ¤í¬</strong> ì™€ <strong>ì¸í„°ëŸ½íŠ¸ ê°ì‹œ íƒœìŠ¤í¬</strong> ë¥¼ ë™ì‹œì— ëŒë¦¬ê³ , ê°ì§€ë˜ë©´ ìš”ì²­ íƒœìŠ¤í¬ë¥¼ <code class="language-plaintext highlighter-rouge">cancel()</code>ë¡œ ëŠìŠµë‹ˆë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ì»¤ìŠ¤í…€ ë…¸ë“œ íŒŒì¼ ì•ˆ
</span><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">aiohttp</span>
<span class="kn">import</span> <span class="n">comfy.model_management</span> <span class="k">as</span> <span class="n">mm</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">_watch_interrupt_and_cancel</span><span class="p">(</span><span class="n">task</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">ComfyUI ì¸í„°ëŸ½íŠ¸ê°€ ì˜¤ë©´ ì£¼ì–´ì§„ taskë¥¼ cancel()</span><span class="sh">"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">task</span><span class="p">.</span><span class="nf">done</span><span class="p">():</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>  <span class="c1"># í´ë§ ì£¼ê¸°
</span>            <span class="n">mm</span><span class="p">.</span><span class="nf">throw_exception_if_processing_interrupted</span><span class="p">()</span>  <span class="c1"># ì¸í„°ëŸ½íŠ¸ë©´ ì˜ˆì™¸ ë°œìƒ
</span>    <span class="k">except</span> <span class="n">mm</span><span class="p">.</span><span class="n">InterruptProcessingException</span><span class="p">:</span>
        <span class="n">task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>  <span class="c1"># ë©”ì¸ ìš”ì²­ ì·¨ì†Œ
</span>
<span class="k">class</span> <span class="nc">MyAsyncNode</span><span class="p">:</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">example</span><span class="sh">"</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">prompt</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">})}}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">run</span><span class="sh">"</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">()</span>  <span class="c1"># í•„ìš” ì‹œ api_key, base_url, timeout ë“± ì„¤ì •
</span>
        <span class="c1"># 1) OpenAI ë¹„ë™ê¸° ìš”ì²­ì„ íƒœìŠ¤í¬ë¡œ ìƒì„±
</span>        <span class="n">req_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span>
            <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>          <span class="c1"># ì„ íƒ: ìš”ì²­ íƒ€ì„ì•„ì›ƒ
</span>                <span class="n">max_retries</span><span class="o">=</span><span class="mi">0</span>         <span class="c1"># ì„ íƒ: ì¬ì‹œë„ ë¹„í™œì„±í™”(ì·¨ì†Œ ì‘ë‹µì„ ë¹ ë¥´ê²Œ)
</span>            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># 2) ì¸í„°ëŸ½íŠ¸ ê°ì‹œ íƒœìŠ¤í¬ ì‹œì‘
</span>        <span class="n">watcher</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">_watch_interrupt_and_cancel</span><span class="p">(</span><span class="n">req_task</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 3) ê²°ê³¼ ëŒ€ê¸° â€” ì¸í„°ëŸ½íŠ¸ ì‹œ req_taskê°€ CancelledErrorë¡œ ê¹¨ì§
</span>            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">req_task</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span><span class="p">.</span><span class="n">content</span>
            <span class="nf">return </span><span class="p">(</span><span class="n">text</span><span class="p">,)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="c1"># 4) ComfyUIì— â€œì‚¬ìš©ì ì¸í„°ëŸ½íŠ¸â€ë¡œ ì•Œë¦¬ë ¤ë©´ ì´ ì˜ˆì™¸ë¡œ ìŠ¹ê²©
</span>            <span class="k">raise</span> <span class="n">mm</span><span class="p">.</span><span class="nc">InterruptProcessingException</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># 5) ì›Œì²˜ ì •ë¦¬
</span>            <span class="n">watcher</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">suppress</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">watcher</span>
</code></pre></div></div>

<h3 id="ì™œ-ì´ë ‡ê²Œ-í•˜ëŠëƒ">ì™œ ì´ë ‡ê²Œ í•˜ëŠëƒ?</h3>

<ul>
  <li>
    <p><strong>UI ë²„íŠ¼</strong> â†’ <code class="language-plaintext highlighter-rouge">/interrupt</code> â†’ ë‚´ë¶€ í”Œë˜ê·¸ on. <a href="https://docs.comfy.org/development/comfyui-server/comms_routes?utm_source=chatgpt.com">ComfyUI</a></p>
  </li>
  <li>
    <p>ê°ì‹œ ì½”ë£¨í‹´ì´ <code class="language-plaintext highlighter-rouge">throw_exception_if_processing_interrupted()</code> í˜¸ì¶œ ì¤‘ <strong>ì˜ˆì™¸ë¥¼ ë°›ìŒ</strong> â†’ <strong><code class="language-plaintext highlighter-rouge">req_task.cancel()</code></strong> â†’ <code class="language-plaintext highlighter-rouge">await</code>ê°€ ì¦‰ì‹œ <code class="language-plaintext highlighter-rouge">CancelledError</code> ë¡œ ê¹¨ì§ â†’ ì´ë¥¼ <strong><code class="language-plaintext highlighter-rouge">InterruptProcessingException</code> ìœ¼ë¡œ ë‹¤ì‹œ ë˜ì ¸</strong> ComfyUIê°€ <em>â€œProcessing interruptedâ€</em> ê²½ë¡œë¡œ ì¢…ë£Œ. <a href="https://docs.comfy.org/development/comfyui-server/comms_messages?utm_source=chatgpt.com">ComfyUI+1</a></p>
  </li>
</ul>

<hr />

<h2 id="3-ëŒ€ì•ˆ-asynciowaitë¡œ-ë ˆì´ìŠ¤-êµ¬ì„±">3) ëŒ€ì•ˆ: <code class="language-plaintext highlighter-rouge">asyncio.wait()</code>ë¡œ â€œë ˆì´ìŠ¤â€ êµ¬ì„±</h2>

<p>í´ë§ ì½”ë“œë¥¼ ì¤„ì´ê³  ì‹¶ë‹¤ë©´, â€œì¸í„°ëŸ½íŠ¸ ëŒ€ê¸° ì½”ë£¨í‹´â€ê³¼ ìš”ì²­ì„ <strong>ë ˆì´ìŠ¤</strong> ì‹œí‚¤ëŠ” ë°©ë²•ë„ ìˆì–´ìš”:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">_wait_for_interrupt</span><span class="p">():</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="n">mm</span><span class="p">.</span><span class="nf">throw_exception_if_processing_interrupted</span><span class="p">()</span>

<span class="c1"># ...
</span><span class="n">req_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(...))</span>
<span class="n">int_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">_wait_for_interrupt</span><span class="p">())</span>

<span class="n">done</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span>
    <span class="p">{</span><span class="n">req_task</span><span class="p">,</span> <span class="n">int_task</span><span class="p">},</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span>
<span class="p">)</span>

<span class="k">if</span> <span class="n">int_task</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
    <span class="n">req_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
    <span class="k">raise</span> <span class="n">mm</span><span class="p">.</span><span class="nc">InterruptProcessingException</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">int_task</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
    <span class="nf">return </span><span class="p">(</span> <span class="p">(</span><span class="k">await</span> <span class="n">req_task</span><span class="p">).</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="4-ìì£¼-ê²ªëŠ”-í•¨ì •--íŒ">4) ìì£¼ ê²ªëŠ” í•¨ì • &amp; íŒ</h2>

<ul>
  <li>
    <p><strong>ë¸”ë¡œí‚¹ ì½”ë“œ</strong>(ë™ê¸° HTTP, ë¬´í•œ ë£¨í”„ ë“±)ê°€ ìˆìœ¼ë©´ ì¸í„°ëŸ½íŠ¸ê°€ â€œì¦‰ì‹œâ€ ì•ˆ ë¨¹í™ë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ëŠ” ë°˜ë“œì‹œ <strong>aiohttp/ë¹„ë™ê¸°</strong> ë¥¼ ì“°ê³ , ë£¨í”„ ì•ˆì—ëŠ” ê°„ê°„ì´ <code class="language-plaintext highlighter-rouge">mm.throw_exception_if_processing_interrupted()</code> ë¥¼ ë„£ìœ¼ì„¸ìš”. <a href="https://github.com/comfyanonymous/ComfyUI/issues/3131?utm_source=chatgpt.com">GitHub</a></p>
  </li>
  <li>
    <p><strong>OpenAI ë¹„ë™ê¸° í´ë¼ì´ì–¸íŠ¸</strong> ëŠ” <code class="language-plaintext highlighter-rouge">AsyncOpenAI</code> ë¥¼ ì“°ë©´ ë©ë‹ˆë‹¤(ìš”ì²­ ì˜µì…˜ì— <code class="language-plaintext highlighter-rouge">timeout</code> ë“± ì „ë‹¬ ê°€ëŠ¥).</p>
  </li>
  <li>
    <p><strong>ì·¨ì†Œ ì „íŒŒ</strong> : <code class="language-plaintext highlighter-rouge">asyncio.CancelledError</code> ë¥¼ <strong>ì¡ì•„ì„œ</strong> <code class="language-plaintext highlighter-rouge">mm.InterruptProcessingException</code> ìœ¼ë¡œ <strong>ë‹¤ì‹œ ë˜ì§€ëŠ” ê²ƒ</strong> ì´ í¬ì¸íŠ¸ì…ë‹ˆë‹¤ â€” ê·¸ë˜ì•¼ UIì— ì •ìƒì ì¸ â€œì¤‘ë‹¨â€ìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤</strong> ë„ ì¸í„°ëŸ½íŠ¸ë¥¼ ë³´ëƒ…ë‹ˆë‹¤(Ctrl+Alt+Enter). <a href="https://docs.comfy.org/interface/shortcuts?utm_source=chatgpt.com">ComfyUI</a></p>
  </li>
</ul>

<hr />

<h2 id="5-ë™ì‘-ì›ë¦¬-í•œëˆˆ-ìš”ì•½">5) ë™ì‘ ì›ë¦¬ í•œëˆˆ ìš”ì•½</h2>

<ol>
  <li>
    <p>ìœ ì €ê°€ Interrupt í´ë¦­ â†’ <strong><code class="language-plaintext highlighter-rouge">POST /interrupt</code></strong> í˜¸ì¶œ â†’ ë‚´ë¶€ í”Œë˜ê·¸ on. <a href="https://docs.comfy.org/development/comfyui-server/comms_routes?utm_source=chatgpt.com">ComfyUI</a></p>
  </li>
  <li>
    <p>ë‚´ ë…¸ë“œì˜ â€œì¸í„°ëŸ½íŠ¸ ì›Œì²˜â€ê°€ í”Œë˜ê·¸ ê°ì§€ â†’ <strong>ìš”ì²­ íƒœìŠ¤í¬ cancel()</strong>.</p>
  </li>
  <li>
    <p>ë‚´ ì½”ë“œê°€ <code class="language-plaintext highlighter-rouge">CancelledError</code> ë¥¼ ë°›ì•„ <strong><code class="language-plaintext highlighter-rouge">InterruptProcessingException</code> ì¬-ë°œìƒ</strong> â†’ ì‹¤í–‰ê¸°ì—ì„œ <strong><code class="language-plaintext highlighter-rouge">execution_interrupted</code></strong> ì´ë²¤íŠ¸ ì „ì†¡ &amp; ì¦‰ì‹œ ì¤‘ë‹¨. <a href="https://docs.comfy.org/development/comfyui-server/comms_messages?utm_source=chatgpt.com">ComfyUI</a></p>
  </li>
</ol>

<p>ì´ë ‡ê²Œ ë¶™ì´ë©´ â€œUIì—ì„œ ì •ì§€ â†’ ê³§ì¥ ë‹¹ì‹ ì˜ <code class="language-plaintext highlighter-rouge">await</code>ê°€ ëŠê¸°ëŠ”â€ ë™ì‘ì„ ì•ˆì •ì ìœ¼ë¡œ ë§Œë“¤ ìˆ˜ ìˆì–´ìš”.</p>]]></content><author><name>hvppyarchive</name></author><category term="comfyui" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">ComfyUI ì„¤ì • íŒŒì¼ ê°œë°œ</title><link href="https://hvppyarchive.github.io/comfyui/comfyui-custom-node-config/" rel="alternate" type="text/html" title="ComfyUI ì„¤ì • íŒŒì¼ ê°œë°œ" /><published>2025-10-02T13:39:43+09:00</published><updated>2025-10-02T13:39:43+09:00</updated><id>https://hvppyarchive.github.io/comfyui/comfyui-custom-node-config</id><content type="html" xml:base="https://hvppyarchive.github.io/comfyui/comfyui-custom-node-config/"><![CDATA[<p class="chat--user">

ComfyUI Custom Nodeì˜ Configë“¤ì„ ì €ì¥ íŒŒì¼ì„ ê°œë°œí•´ì¤˜. config íŒŒì¼ì„ ì‚¬ëŒì´ ìˆ˜ì •í•˜ê¸° ì‰¬ìš´ íŒŒì¼ í˜•ì‹ìœ¼ë¡œ ìˆ˜ì • í•´ì¤˜. íŒŒì¼ì„ ì €ì¥í•˜ì§€ ì•Šê³  ì„¤ì •ì„ ì½ê¸°ë§Œ í•˜ëŠ” readonly ëª¨ë“œë¡œ ë™ì‘í•˜ë©´ ë¼. ì—¬ëŸ¬ ì„¤ì •ì„ ì €ì¥í• ê±°ì§€ë§Œ ì£¼ ìš©ë„ëŠ” LLM ì—”ë“œí¬ì¸íŠ¸ ì •ë³´ë¥¼ ë‹´ì„ê±°ì•¼. ê° LLM Model ë³„ë¡œ (ë””ìŠ¤í”Œë ˆì´ìš© ëª¨ë¸ëª…, ì‹¤ì œ ëª¨ë¸ëª…(requestì‹œ), base url, api key)ë¥¼ ì €ì¥í•˜ë©´ ë¼. Config ì •ë³´ì— ê´€í•œ ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´(e.g. api ë‚ ë¦´ ë•Œ ë“±) í•´ë‹¹í•˜ëŠ” ê°’ì„ ë¦¬í„´í•˜ë©´ ë¼. ì´ ë•Œ config íŒŒì¼ì´ ì´ˆê¸° readí–ˆì„ ë•Œì™€ ë°”ë€Œì—ˆì„ ìˆ˜ë„ ìˆì–´. ì¡°ê¸ˆ ë°˜ì˜ì´ ëŠ¦ë”ë¼ë„ 1ë¶„ ì´ë‚´ì—ëŠ” ë³€ê²½ëœ ê°’ì„ ë¦¬í„´í•´ì•¼í•´. 

</p>

<p>ì¢‹ì•„ìš”! â€œì‚¬ëŒì´ ì§ì ‘ ìˆ˜ì •í•˜ê¸° ì‰¬ìš´ ì„¤ì • íŒŒì¼â€ + â€œì½ê¸° ì „ìš©(íŒŒì¼ ì €ì¥ X)â€ + â€œìµœëŒ€ 1ë¶„ ë‚´ ìµœì‹ ê°’ ë°˜ì˜â€ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ComfyUI ì»¤ìŠ¤í…€ ë…¸ë“œ íŒ¨í‚¤ì§€ë¥¼ ì„¤ê³„/êµ¬í˜„í•´ ë“œë¦´ê²Œìš”.<br />
ì•„ë˜ ê·¸ëŒ€ë¡œ ë³µì‚¬í•´ ë„£ìœ¼ë©´ ë°”ë¡œ ë™ì‘í•©ë‹ˆë‹¤.</p>

<hr />

<h1 id="1-íŒŒì¼-êµ¬ì¡°">1) íŒŒì¼ êµ¬ì¡°</h1>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ComfyUI/
â””â”€ custom_nodes/
   â””â”€ comfyui_llm_config_reader/
      â”œâ”€ __init__.py
      â”œâ”€ llm_config_reader.py     <span class="c"># ì»¤ìŠ¤í…€ ë…¸ë“œ + ì„¤ì • ë¡œë”</span>
      â””â”€ llm_config.toml          <span class="c"># ì‚¬ëŒì´ ì½ê³  ìˆ˜ì •í•˜ê¸° ì‰¬ìš´ TOML ì„¤ì • íŒŒì¼</span>
</code></pre></div></div>

<blockquote>
  <p>ê¸°ë³¸ ê²½ë¡œëŠ” <code class="language-plaintext highlighter-rouge">llm_config.toml</code> ì´ê³ , <code class="language-plaintext highlighter-rouge">LLM_CONFIG_PATH</code> í™˜ê²½ë³€ìˆ˜ë¡œ ë°”ê¿€ ìˆ˜ ìˆì–´ìš”.</p>
</blockquote>

<hr />

<h1 id="2-ì„¤ì •-íŒŒì¼-ì˜ˆì‹œ-toml">2) ì„¤ì • íŒŒì¼ ì˜ˆì‹œ (TOML)</h1>

<p>ì‚¬ëŒì´ ì†ìœ¼ë¡œ í¸ì§‘í•˜ê¸° ì‰½ê³ , ì£¼ì„ë„ ë„£ê¸° ì¢‹ì€ TOMLì„ ì‚¬ìš©í•©ë‹ˆë‹¤.<br />
(API KeyëŠ” ê¹ƒì— ì˜¬ë¦¬ì§€ ì•Šë„ë¡ í™˜ê²½ë³€ìˆ˜ ì¹˜í™˜ë„ ì§€ì›í•´ìš”.)</p>

<p><code class="language-plaintext highlighter-rouge">llm_config.toml</code></p>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ë²„ì „ ì •ë³´(ì„ íƒ)</span>
<span class="py">version</span> <span class="p">=</span> <span class="mi">1</span>

<span class="nn">[settings]</span>
<span class="c"># íŒŒì¼ ë³€ê²½ ë°˜ì˜ ì£¼ê¸°(ì´ˆ). 60ì´ˆ ì´ë‚´ ìµœì‹ ê°’ ìš”êµ¬ì´ë¯€ë¡œ ê¸°ë³¸ 30ì´ˆë¡œ ì—¬ìœ  ìˆê²Œ.</span>
<span class="py">refresh_interval_seconds</span> <span class="p">=</span> <span class="mi">30</span>

<span class="nn">[llm_models."gpt-4o-mini"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"GPT-4o mini"</span>
<span class="py">request_model</span> <span class="p">=</span> <span class="s">"gpt-4o-mini"</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${OPENAI_API_KEY}"</span>   <span class="c"># í™˜ê²½ë³€ìˆ˜ë¡œ ì•ˆì „í•˜ê²Œ ì£¼ì…</span>

<span class="nn">[llm_models."claude-3-5-sonnet"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"Claude 3.5 Sonnet"</span>
<span class="py">request_model</span> <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>

<span class="c"># ì›í•˜ëŠ” ë§Œí¼ ëª¨ë¸ì„ ê³„ì† ì¶”ê°€</span>
<span class="c"># [llm_models."ë¬¸ìì—´í‚¤"] ...</span>
</code></pre></div></div>

<ul>
  <li>
    <p>í‚¤ ì„ íƒ ê·œì¹™: <code class="language-plaintext highlighter-rouge">llm_models."&lt;í‚¤&gt;"</code> ì˜ <code class="language-plaintext highlighter-rouge">&lt;í‚¤&gt;</code> ëŠ” ììœ ë¡œìš´ ë¬¸ìì—´ì…ë‹ˆë‹¤.<br />
ì¡°íšŒ ì‹œ <code class="language-plaintext highlighter-rouge">&lt;í‚¤&gt;</code>, <code class="language-plaintext highlighter-rouge">display_name</code>, <code class="language-plaintext highlighter-rouge">request_model</code> ì…‹ ì¤‘ ì–´ëŠ ê±¸ë¡œ ì…ë ¥í•´ë„ ë§¤ì¹­ë˜ë„ë¡ í–ˆì–´ìš”.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">${ENV_NAME}</code> í˜•íƒœëŠ” í™˜ê²½ë³€ìˆ˜ë¡œ ì¹˜í™˜ë©ë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />

<h1 id="3-ì»¤ìŠ¤í…€-ë…¸ë“œë¡œë”-ì½”ë“œ">3) ì»¤ìŠ¤í…€ ë…¸ë“œ/ë¡œë” ì½”ë“œ</h1>

<p><code class="language-plaintext highlighter-rouge">comfyui_llm_config_reader/llm_config_reader.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="c1"># Python 3.11+ tomllib, 3.10 ì´í•˜ë©´ tomli ì‚¬ìš©
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="k">def</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">ë¬¸ìì—´ ë‚´ ${ENV} íŒ¨í„´ì„ í™˜ê²½ë³€ìˆ˜ë¡œ ì¹˜í™˜. ê·¸ ì™¸ íƒ€ì…ì€ ê·¸ëŒ€ë¡œ ë°˜í™˜.</span><span class="sh">"""</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">env_name</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">env_name</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">_normalize_key</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">ë§¤ì¹­ í¸ì˜ë¥¼ ìœ„í•œ ì •ê·œí™”(ì†Œë¬¸ì, ì•ë’¤ ê³µë°± ì œê±°).</span><span class="sh">"""</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">ReadOnlyConfig</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - TOML ì„¤ì •ì„ ì½ì–´ì„œ ë©”ëª¨ë¦¬ì— ìºì‹œ
    - íŒŒì¼ì´ ë°”ë€Œì—ˆê±°ë‚˜ refresh_intervalì´ ì§€ë‚¬ìœ¼ë©´ ì¬ë¡œë“œ
    - ì“°ê¸°ëŠ” ì ˆëŒ€ í•˜ì§€ ì•ŠìŒ (read-only)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span>
            <span class="sh">"</span><span class="s">LLM_CONFIG_PATH</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="sh">"</span><span class="s">llm_config.toml</span><span class="sh">"</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># ê¸°ë³¸ 30ì´ˆ(&lt;= 60ì´ˆ ìš”êµ¬ ì¶©ì¡±)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># ì •ê·œí™” í‚¤ -&gt; ëª¨ë¸ dict
</span>
    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">models</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">llm_models</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">model_key</span><span class="p">,</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">models</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="c1"># í™˜ê²½ë³€ìˆ˜ ì¹˜í™˜
</span>            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>

            <span class="c1"># í•„ìˆ˜ í•„ë“œ ì²´í¬
</span>            <span class="n">required</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">required</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()]</span>
            <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                <span class="c1"># ë¶ˆì™„ì „í•œ ì—”íŠ¸ë¦¬ëŠ” ìŠ¤í‚µ (ëª…í™•í•œ ë¡œê·¸ê°€ í•„ìš”í•˜ë©´ print ê°€ëŠ¥)
</span>                <span class="k">continue</span>

            <span class="c1"># ëª¨ë¸ ì ‘ê·¼ì„ ìœ„í•œ ë‹¤ì–‘í•œ í‚¤ë“¤ ì¸ë±ì‹±
</span>            <span class="n">candidates</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nf">str</span><span class="p">(</span><span class="n">model_key</span><span class="p">),</span>
                <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)),</span>
                <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)),</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">candidates</span><span class="p">):</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">[</span><span class="nf">_normalize_key</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]),</span>
                <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
        <span class="c1"># settings.refresh_interval_seconds ë°˜ì˜ (ìµœì†Œ 5ì´ˆ, ìµœëŒ€ 60ì´ˆë¡œ ê°€ë“œ)
</span>        <span class="n">refresh</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span>
            <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">refresh</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">refresh</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span>
            <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LLM_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">,</span> <span class="n">refresh</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">mtime</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">keyëŠ” ëª¨ë¸ í‚¤/í‘œì‹œëª…/ìš”ì²­ìš© ëª¨ë¸ëª… ì¤‘ ì•„ë¬´ê±°ë‚˜ ê°€ëŠ¥.</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">model key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_normalize_key</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="c1"># ìµœì‹  ë°˜ì˜ ì§€ì—° ê°€ëŠ¥ì„±ì„ ê³ ë ¤í•´ í•œ ë²ˆ ë” ê°•ì œ ë¦¬ë¡œë“œ í›„ ì¬ì‹œë„
</span>            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_normalize_key</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">model not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">list_models</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="sh">"""</span><span class="s">ë””ë²„ê·¸/ì¸ìŠ¤í™ì…˜ìš©: (í‘œì‹œëª…, ìš”ì²­ëª¨ë¸, base_urlë§Œ ë…¸ì¶œí•˜ëŠ” ì•ˆì „ ë¦¬ìŠ¤íŠ¸).</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># ì—­ìœ¼ë¡œ display_name ê¸°ì¤€ ì§‘ê³„
</span>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">out</span><span class="p">[</span><span class="n">dn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
                <span class="c1"># api_keyëŠ” ë³´ì•ˆìƒ ë¯¸ë…¸ì¶œ
</span>            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="c1"># ì „ì—­ ì‹±ê¸€í†¤ ë¡œë” (ComfyUI ë…¸ë“œë“¤ì´ ê³µìœ )
</span><span class="n">_CONFIG</span> <span class="o">=</span> <span class="nc">ReadOnlyConfig</span><span class="p">()</span>

<span class="c1"># ===== ComfyUI Custom Nodes =====
</span><span class="k">class</span> <span class="nc">LLMConfigLookup</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ì…ë ¥: model_key (ë¬¸ìì—´)  â€” ì˜ˆ: </span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="s"> ë˜ëŠ” </span><span class="sh">"</span><span class="s">GPT-4o mini</span><span class="sh">"</span><span class="s"> ë˜ëŠ” </span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="s">(request_model)
    ì¶œë ¥: display_name, request_model, base_url, api_key (ëª¨ë‘ STRING)
    </span><span class="sh">"""</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">model_key</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
            <span class="p">},</span>
        <span class="p">}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">lookup</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LLM/Config</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">_CONFIG</span><span class="p">.</span><span class="nf">get_model</span><span class="p">(</span><span class="n">model_key</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># ComfyUIì—ì„œ ì—ëŸ¬ê°€ ë³´ì´ë„ë¡ ì˜ˆì™¸ ì „ë‹¬
</span>            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[LLMConfigLookup] </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">LLMConfigListModels</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ë””ë²„ê·¸ìš©: ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ë“¤ì˜ (í‘œì‹œëª…, ìš”ì²­ëª¨ë¸, base_url) JSONì„ ë°˜í™˜.
    </span><span class="sh">"""</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">models_json</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">list_models</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LLM/Config</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">list_models</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="n">json</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">_CONFIG</span><span class="p">.</span><span class="nf">list_models</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),)</span>

<span class="c1"># ComfyUI ë“±ë¡ìš© ë§¤í•‘
</span><span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LLMConfigLookup</span><span class="sh">"</span><span class="p">:</span> <span class="n">LLMConfigLookup</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">LLMConfigListModels</span><span class="sh">"</span><span class="p">:</span> <span class="n">LLMConfigListModels</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LLMConfigLookup</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">LLM: Config Lookup (ReadOnly)</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">LLMConfigListModels</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">LLM: List Models (ReadOnly)</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">comfyui_llm_config_reader/__init__.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ë¹ˆ íŒŒì¼ì´ë©´ ì¶©ë¶„í•©ë‹ˆë‹¤. (íŒ¨í‚¤ì§€ ì¸ì‹ìš©)
</span></code></pre></div></div>

<hr />

<h1 id="4-ë™ì‘-ë³´ì¥ìš”êµ¬ì‚¬í•­-ë§¤í•‘">4) ë™ì‘ ë³´ì¥(ìš”êµ¬ì‚¬í•­ ë§¤í•‘)</h1>

<ol>
  <li>
    <p><strong>ì‚¬ëŒì´ ìˆ˜ì •í•˜ê¸° ì‰¬ìš´ í¬ë§·</strong> : TOML ì‚¬ìš© + ì£¼ì„ ê°€ëŠ¥ + ê°„ê²°í•œ í‚¤/ê°’ êµ¬ì¡°.</p>
  </li>
  <li>
    <p><strong>ì½ê¸° ì „ìš©</strong> : ì½”ë“œ ì–´ë””ì—ì„œë„ íŒŒì¼ì„ ì“°ì§€ ì•ŠìŒ. ì˜¤ì§ ì½ê¸°/íŒŒì‹±ë§Œ ìˆ˜í–‰.</p>
  </li>
  <li>
    <p><strong>ë‹¤ì¤‘ ì„¤ì •(íŠ¹íˆ LLM ì—”ë“œí¬ì¸íŠ¸)</strong> : <code class="language-plaintext highlighter-rouge">llm_models."&lt;í‚¤&gt;"</code>ë§ˆë‹¤</p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">display_name</code>, <code class="language-plaintext highlighter-rouge">request_model</code>, <code class="language-plaintext highlighter-rouge">base_url</code>, <code class="language-plaintext highlighter-rouge">api_key</code> ì €ì¥.</li>
    </ul>
  </li>
  <li>
    <p><strong>ìš”ì²­ ì‹œ í•´ë‹¹ ê°’ ë¦¬í„´</strong> : <code class="language-plaintext highlighter-rouge">LLMConfigLookup</code> ë…¸ë“œê°€ ì…ë ¥ <code class="language-plaintext highlighter-rouge">model_key</code>ë¡œ ê²€ìƒ‰í•˜ì—¬ 4ê°œ ê°’ì„ ì¶œë ¥.</p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">&lt;í‚¤&gt;</code> / <code class="language-plaintext highlighter-rouge">display_name</code> / <code class="language-plaintext highlighter-rouge">request_model</code> ì¤‘ ë¬´ì—‡ìœ¼ë¡œ ë„£ì–´ë„ ë§¤ì¹­ë¨.</li>
    </ul>
  </li>
  <li>
    <p><strong>ë³€ê²½ ë°˜ì˜(ìµœëŒ€ 1ë¶„)</strong> :</p>

    <ul>
      <li>
        <p>íŒŒì¼ <code class="language-plaintext highlighter-rouge">mtime</code> ë³€í™” ê°ì§€ + <code class="language-plaintext highlighter-rouge">refresh_interval_seconds</code>(ê¸°ë³¸ 30ì´ˆ) ë˜ëŠ” <code class="language-plaintext highlighter-rouge">LLM_CONFIG_REFRESH_SECONDS</code>(env) ê¸°ì¤€ TTL ìºì‹œ.</p>
      </li>
      <li>
        <p>í˜¸ì¶œ ì‹œë§ˆë‹¤ <strong>stale ë˜ëŠ” ë³€ê²½</strong> ì´ë©´ ì¦‰ì‹œ ì¬ë¡œë“œ â†’ <strong>ìµœëŒ€ 60ì´ˆ ì´ë‚´</strong> ìµœì‹ ê°’ ë³´ì¥.</p>
      </li>
      <li>
        <p>ì‹ ê·œ í•­ëª©ì´ ì¶”ê°€ëœ ì§í›„ì—ë„, ë‹¤ìŒ í˜¸ì¶œ ë•Œ ìµœëŒ€ TTL ë’¤ì—ëŠ” ë°˜ì˜.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ë³´ì•ˆ ê³ ë ¤</strong> :</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">${ENV}</code> ì¹˜í™˜ ì§€ì›ìœ¼ë¡œ API Keyë¥¼ í™˜ê²½ë³€ìˆ˜ì—ì„œ ì£¼ì… ê°€ëŠ¥.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">ListModels</code> ë…¸ë“œì—ì„œëŠ” API Key ë¯¸ë…¸ì¶œ.</p>
      </li>
    </ul>
  </li>
</ol>

<hr />

<h1 id="5-ì‚¬ìš©-ë°©ë²•-ê°„ë‹¨">5) ì‚¬ìš© ë°©ë²• (ê°„ë‹¨)</h1>

<ol>
  <li>
    <p>ìœ„ íŒŒì¼ êµ¬ì¡°ëŒ€ë¡œ ë³µì‚¬ â†’ ComfyUI ì¬ì‹¤í–‰.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">llm_config.toml</code> ì— ëª¨ë¸ë“¤ì„ ì¶”ê°€/ìˆ˜ì •.</p>
  </li>
  <li>
    <p>ì›Œí¬í”Œë¡œìš°ì—ì„œ <strong>LLM: Config Lookup (ReadOnly)</strong> ë…¸ë“œ ë°°ì¹˜ â†’ <code class="language-plaintext highlighter-rouge">model_key</code> ì…ë ¥(ì˜ˆ: <code class="language-plaintext highlighter-rouge">gpt-4o-mini</code>).</p>
  </li>
  <li>
    <p>ë…¸ë“œ ì¶œë ¥ 4ê°œ(í‘œì‹œëª…/ìš”ì²­ëª¨ë¸/base_url/api_key)ë¥¼ ì›í•˜ëŠ” LLM í˜¸ì¶œ ë…¸ë“œì— ì—°ê²°.</p>
  </li>
  <li>
    <p>ì„¤ì • íŒŒì¼ì„ ìˆ˜ì •í•˜ë©´, <strong>ìµœëŒ€ 30ì´ˆ(ê¸°ë³¸) ë‚´</strong> ìƒˆ ê°’ì´ ìë™ ë°˜ì˜ë©ë‹ˆë‹¤. (í™˜ê²½ë³€ìˆ˜ë¡œ 5~60ì´ˆ ì‚¬ì´ íŠœë‹ ê°€ëŠ¥)</p>
  </li>
</ol>

<hr />

<h1 id="6-ì»¤ìŠ¤í„°ë§ˆì´ì§•-íŒ">6) ì»¤ìŠ¤í„°ë§ˆì´ì§• íŒ</h1>

<ul>
  <li>
    <p><strong>YAML ì„ í˜¸ ì‹œ</strong> : <code class="language-plaintext highlighter-rouge">tomllib</code> ëŒ€ì‹  <code class="language-plaintext highlighter-rouge">yaml.safe_load</code>ë¡œ ë°”ê¾¸ê³  íŒŒì¼ í™•ì¥ìë§Œ <code class="language-plaintext highlighter-rouge">.yaml</code>ë¡œ ë°”ê¾¸ë©´ ë©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>ëª¨ë¸ í‚¤ ìë™ ë“œë¡­ë‹¤ìš´</strong> : ComfyUIì˜ ë™ì  ì…ë ¥ UIê°€ í•„ìš”í•˜ë©´, <code class="language-plaintext highlighter-rouge">INPUT_TYPES</code>ë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ ì¬êµ¬ì„±í•˜ëŠ” ì»¤ìŠ¤í…€ í”„ë¡ íŠ¸ì—”ë“œê°€ í•„ìš”í•©ë‹ˆë‹¤. ê¸°ë³¸ êµ¬í˜„ì€ ë¬¸ìì—´ ì…ë ¥ìœ¼ë¡œ ë‹¨ìˆœ/ê²¬ê³ í•˜ê²Œ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>í•„ë“œ í™•ì¥</strong> : per-model íƒ€ì„ì•„ì›ƒ, í—¤ë” ë“± ì¶”ê°€ í•„ë“œê°€ í•„ìš”í•˜ë©´ TOMLì— í‚¤ë¥¼ ëŠ˜ë¦¬ê³  <code class="language-plaintext highlighter-rouge">_build_index</code>ì—ì„œ ê·¸ëŒ€ë¡œ í†µê³¼ì‹œì¼œ ì¶œë ¥ì„ ëŠ˜ë¦¬ë©´ ë©ë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />

<p>ì›í•˜ì‹œë©´ YAML ë²„ì „ ë˜ëŠ” íŠ¹ì • LLM í˜¸ì¶œ ë…¸ë“œ(ì˜ˆ: OpenAI/Anthropic ì»¤ë„¥í„°)ê¹Œì§€ ë°”ë¡œ ì—°ê²°ë˜ëŠ” ë…¸ë“œë„ ì¶”ê°€ë¡œ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

ì¢‹ì€ë° LLM ë§ê³ ë„ ë‹¤ë¥¸ ì„¤ì •ë“¤ë„ ì €ì¥í•  ìˆ˜ ìˆëŠ” ë²”ìš©ì  config íŒŒì¼ì´ë¼ì„œ íŒŒì¼ëª…ì„ ë°”ê¿”ì£¼ë©´ ì¢‹ê² ì–´

</p>

<p>ì¢‹ì€ í¬ì¸íŠ¸ì˜ˆìš”! ë²”ìš© ì„¤ì • íŒŒì¼ë¡œ ì“°ê¸° ì¢‹ê²Œ <strong>íŒŒì¼ëª…ì„ <code class="language-plaintext highlighter-rouge">config.toml</code></strong>ë¡œ ë°”ê¾¸ê³ , ì½”ë“œ/í™˜ê²½ë³€ìˆ˜ë„ <strong>ì¼ë°˜í™”</strong> í–ˆìŠµë‹ˆë‹¤. (ì´ì „ <code class="language-plaintext highlighter-rouge">llm_config.toml</code>Â·<code class="language-plaintext highlighter-rouge">LLM_CONFIG_PATH</code>ë„ ìë™ í•˜ìœ„ í˜¸í™˜)</p>

<p>ì•„ë˜ ê·¸ëŒ€ë¡œ êµì²´/ì¶”ê°€í•˜ë©´ ë©ë‹ˆë‹¤.</p>

<hr />

<h1 id="ë³€ê²½-ìš”ì•½-step-by-step">ë³€ê²½ ìš”ì•½ (step-by-step)</h1>

<ol>
  <li>
    <p>ì„¤ì • íŒŒì¼ ê¸°ë³¸ëª…ì„ <code class="language-plaintext highlighter-rouge">config.toml</code>ë¡œ ë³€ê²½</p>
  </li>
  <li>
    <p>ê²½ë¡œ í™˜ê²½ë³€ìˆ˜ë„ ì¼ë°˜í™”: <strong><code class="language-plaintext highlighter-rouge">COMFY_CONFIG_PATH</code></strong> (êµ¬ <code class="language-plaintext highlighter-rouge">LLM_CONFIG_PATH</code>ë„ ì¸ì‹)</p>
  </li>
  <li>
    <p>ìƒˆë¡œê³ ì¹¨ ì£¼ê¸° í™˜ê²½ë³€ìˆ˜: <strong><code class="language-plaintext highlighter-rouge">COMFY_CONFIG_REFRESH_SECONDS</code></strong> (êµ¬ <code class="language-plaintext highlighter-rouge">LLM_CONFIG_REFRESH_SECONDS</code>ë„ ì¸ì‹)</p>
  </li>
  <li>
    <p>ì½”ë“œê°€ <code class="language-plaintext highlighter-rouge">config.toml</code>ì„ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ì¡´ <code class="language-plaintext highlighter-rouge">llm_config.toml</code> ìë™ í´ë°±</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">[llm_models]</code> ì™¸ì— ì„ì˜ ì„¹ì…˜(<code class="language-plaintext highlighter-rouge">[feature_flags]</code>, <code class="language-plaintext highlighter-rouge">[storage]</code> ë“±) ììœ  í™•ì¥ ê°€ëŠ¥</p>
  </li>
</ol>

<hr />

<h1 id="ë””ë ‰í† ë¦¬-êµ¬ì¡°">ë””ë ‰í† ë¦¬ êµ¬ì¡°</h1>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ComfyUI/
â””â”€ custom_nodes/
   â””â”€ comfyui_llm_config_reader/
      â”œâ”€ __init__.py
      â”œâ”€ llm_config_reader.py     <span class="c"># (êµì²´ë³¸) ë²”ìš© config ë¡œë” + LLM ì¡°íšŒ ë…¸ë“œ</span>
      â””â”€ config.toml              <span class="c"># â† ìƒˆ ê¸°ë³¸ ì„¤ì • íŒŒì¼ëª… (ë²”ìš©)</span>
      <span class="c"># â””â”€ llm_config.toml        # (ì„ íƒ) ê¸°ì¡´ íŒŒì¼ëª…ë„ ê³„ì† ë™ì‘(í´ë°±)</span>
</code></pre></div></div>

<hr />

<h1 id="ì˜ˆì‹œ-configtoml-ë²”ìš©">ì˜ˆì‹œ <code class="language-plaintext highlighter-rouge">config.toml</code> (ë²”ìš©)</h1>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">version</span> <span class="p">=</span> <span class="mi">1</span>

<span class="nn">[settings]</span>
<span class="c"># íŒŒì¼ ë³€ê²½ ë°˜ì˜ ì£¼ê¸°(ì´ˆ). 1ë¶„ ì´ë‚´ ìš”êµ¬ â†’ ê¸°ë³¸ 30ì´ˆ.</span>
<span class="py">refresh_interval_seconds</span> <span class="p">=</span> <span class="mi">30</span>

<span class="c"># â”€â”€ LLM ì—”ë“œí¬ì¸íŠ¸ë“¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nn">[llm_models."gpt-4o-mini"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"GPT-4o mini"</span>
<span class="py">request_model</span> <span class="p">=</span> <span class="s">"gpt-4o-mini"</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${OPENAI_API_KEY}"</span>

<span class="nn">[llm_models."claude-3-5-sonnet"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"Claude 3.5 Sonnet"</span>
<span class="py">request_model</span> <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>

<span class="c"># â”€â”€ (ì˜ˆ) ë‹¤ë¥¸ ë²”ìš© ì„¤ì • ì„¹ì…˜ë“¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nn">[feature_flags]</span>
<span class="py">use_cache</span> <span class="p">=</span> <span class="kc">true</span>
<span class="py">show_beta</span> <span class="p">=</span> <span class="kc">false</span>

<span class="nn">[storage.s3]</span>
<span class="py">bucket</span> <span class="p">=</span> <span class="s">"my-bucket"</span>
<span class="py">region</span> <span class="p">=</span> <span class="s">"ap-northeast-2"</span>
<span class="py">access_key</span> <span class="p">=</span> <span class="s">"${S3_ACCESS_KEY}"</span>
<span class="py">secret_key</span> <span class="p">=</span> <span class="s">"${S3_SECRET_KEY}"</span>
</code></pre></div></div>

<ul>
  <li>
    <p>ì„ì˜ ì„¹ì…˜ì€ <strong>ê·¸ëŒ€ë¡œ ì €ì¥</strong> ë˜ë©°, LLM ë…¸ë“œëŠ” <code class="language-plaintext highlighter-rouge">[llm_models]</code>ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">${ENV}</code> í‘œê¸°ê°’ì€ í™˜ê²½ë³€ìˆ˜ë¡œ ì¹˜í™˜ë©ë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />

<h1 id="êµì²´ë³¸-ì½”ë“œ-llm_config_readerpy">êµì²´ë³¸ ì½”ë“œ: <code class="language-plaintext highlighter-rouge">llm_config_reader.py</code></h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="c1"># Python 3.11+ tomllib, 3.10 ì´í•˜ë©´ tomli ì‚¬ìš©
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="k">def</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">ë¬¸ìì—´ ë‚´ ${ENV} íŒ¨í„´ì„ í™˜ê²½ë³€ìˆ˜ë¡œ ì¹˜í™˜. ê·¸ ì™¸ íƒ€ì…ì€ ê·¸ëŒ€ë¡œ.</span><span class="sh">"""</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">env_name</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">env_name</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">_normalize_key</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">ReadOnlyConfig</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - TOML ì„¤ì •ì„ ì½ì–´ ë©”ëª¨ë¦¬ ìºì‹œ
    - íŒŒì¼ mtime/TTL(ìµœì†Œ 5s, ìµœëŒ€ 60s) ê¸°ë°˜ ìë™ ì¬ë¡œë“œ
    - ì ˆëŒ€ ì“°ê¸° ì—†ìŒ (read-only)
    - íŒŒì¼ëª… ì¼ë°˜í™”:
        * ìš°ì„ ìˆœìœ„: COMFY_CONFIG_PATH &gt; LLM_CONFIG_PATH(í•˜ìœ„í˜¸í™˜) &gt;
                    ./config.toml &gt; ./llm_config.toml(í•˜ìœ„í˜¸í™˜)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="c1"># 1) ëª…ì‹œì  ì¸ì
</span>        <span class="n">explicit</span> <span class="o">=</span> <span class="n">path</span>

        <span class="c1"># 2) í™˜ê²½ë³€ìˆ˜ (ì¼ë°˜í™” + í•˜ìœ„í˜¸í™˜)
</span>        <span class="n">env_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_PATH</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LLM_CONFIG_PATH</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># 3) ê¸°ë³¸ ê²½ë¡œ íƒìƒ‰ (ìš°ì„  config.toml, ì—†ìœ¼ë©´ llm_config.toml)
</span>        <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
        <span class="n">default_primary</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">default_legacy</span>  <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">llm_config.toml</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">explicit</span><span class="p">:</span>
            <span class="n">chosen</span> <span class="o">=</span> <span class="n">explicit</span>
        <span class="k">elif</span> <span class="n">env_path</span><span class="p">:</span>
            <span class="n">chosen</span> <span class="o">=</span> <span class="n">env_path</span>
        <span class="k">elif</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">default_primary</span><span class="p">):</span>
            <span class="n">chosen</span> <span class="o">=</span> <span class="n">default_primary</span>
        <span class="k">elif</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">default_legacy</span><span class="p">):</span>
            <span class="n">chosen</span> <span class="o">=</span> <span class="n">default_legacy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># íŒŒì¼ì´ ì•„ì§ ì—†ì„ ìˆ˜ ìˆìœ¼ë‹ˆ ìƒˆ í‘œì¤€ëª…ìœ¼ë¡œ ê³ ì •
</span>            <span class="n">chosen</span> <span class="o">=</span> <span class="n">default_primary</span>

        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">chosen</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># ê¸°ë³¸ 30ì´ˆ (&lt;=60ì´ˆ ìš”êµ¬ ì¶©ì¡±)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># ì •ê·œí™” í‚¤ -&gt; LLM ëª¨ë¸ dict
</span>
    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_index_llm</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">[llm_models] ì„¹ì…˜ë§Œ ì¸ë±ì‹±. ë‹¤ë¥¸ ì„¹ì…˜ì€ ê·¸ëŒ€ë¡œ self._rawì— ë³´ì¡´.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">models</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">llm_models</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">model_key</span><span class="p">,</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">models</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># í™˜ê²½ë³€ìˆ˜ ì¹˜í™˜
</span>            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>

            <span class="c1"># í•„ìˆ˜ í•„ë“œ ì²´í¬
</span>            <span class="n">required</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">required</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()]</span>
            <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                <span class="c1"># ë¶ˆì™„ì „ í•­ëª©ì€ ìŠ¤í‚µ
</span>                <span class="k">continue</span>

            <span class="c1"># ì ‘ê·¼ í‚¤(ëª¨ë¸í‚¤/í‘œì‹œëª…/ìš”ì²­ëª¨ë¸) ì¸ë±ì‹±
</span>            <span class="n">candidates</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nf">str</span><span class="p">(</span><span class="n">model_key</span><span class="p">),</span>
                <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)),</span>
                <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)),</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">candidates</span><span class="p">):</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">[</span><span class="nf">_normalize_key</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]),</span>
                <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

        <span class="c1"># refresh_interval_seconds (ìµœì†Œ 5, ìµœëŒ€ 60) + env override(ì¼ë°˜/í•˜ìœ„í˜¸í™˜)
</span>        <span class="n">conf_val</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">conf_val</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">conf_val</span><span class="p">))</span>
        <span class="n">env_override</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">LLM_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">env_override</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">conf_val</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">env_override</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span> <span class="o">=</span> <span class="n">conf_val</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index_llm</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">mtime</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="c1"># â”€â”€ LLM ì „ìš© í—¬í¼ (ê¸°ì¡´ API ìœ ì§€) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
</span>    <span class="k">def</span> <span class="nf">get_llm_model</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">model key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_normalize_key</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="c1"># ê°±ì‹  ì§€ì—° ê°€ëŠ¥ì„± â†’ ê°•ì œ ë¦¬ë¡œë“œ 1íšŒ ì¬ì‹œë„
</span>            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_normalize_key</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">model not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">list_llm_models</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_index</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">out</span><span class="p">[</span><span class="n">dn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
                <span class="c1"># api_keyëŠ” ë³´ì•ˆìƒ ë¯¸ë…¸ì¶œ
</span>            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="c1"># â”€â”€ ë²”ìš© ì ‘ê·¼(ì˜µì…˜): ì›ë³¸ íŠ¸ë¦¬ì—ì„œ ì„ì˜ ì„¹ì…˜ ì½ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
</span>    <span class="k">def</span> <span class="nf">get_raw_config</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">ì „ì²´ ì„¤ì • íŠ¸ë¦¬ë¥¼ ê·¸ëŒ€ë¡œ(ENV í™•ì¥ í›„) ë°˜í™˜. ì½ê¸° ì „ìš©.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_raw</span>

<span class="c1"># ì „ì—­ ì‹±ê¸€í†¤
</span><span class="n">_CONFIG</span> <span class="o">=</span> <span class="nc">ReadOnlyConfig</span><span class="p">()</span>

<span class="c1"># ===== ComfyUI Custom Nodes =====
</span><span class="k">class</span> <span class="nc">LLMConfigLookup</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ì…ë ¥: model_key (ë¬¸ìì—´) â€” </span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="s"> / </span><span class="sh">"</span><span class="s">GPT-4o mini</span><span class="sh">"</span><span class="s"> / </span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="s">(request_model)
    ì¶œë ¥: display_name, request_model, base_url, api_key
    </span><span class="sh">"""</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">model_key</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">})}}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">lookup</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LLM/Config</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">_CONFIG</span><span class="p">.</span><span class="nf">get_llm_model</span><span class="p">(</span><span class="n">model_key</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[LLMConfigLookup] </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">LLMConfigListModels</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">ë””ë²„ê·¸ìš©: ì‚¬ìš© ê°€ëŠ¥í•œ LLM ëª¨ë¸ ëª©ë¡(JSON) ë°˜í™˜ (API Key ë¯¸í¬í•¨).</span><span class="sh">"""</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">models_json</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">list_models</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LLM/Config</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">list_models</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="n">json</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">_CONFIG</span><span class="p">.</span><span class="nf">list_llm_models</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),)</span>

<span class="c1"># (ì„ íƒ) ë²”ìš© ì¡°íšŒ ë…¸ë“œ: ì„ì˜ ê²½ë¡œë¥¼ JSONPath ìœ ì‚¬ í‚¤ë¡œ ì¡°íšŒí•˜ê³  STRING ë°˜í™˜
</span><span class="k">class</span> <span class="nc">ConfigGetRawJSON</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ì˜ˆ) path=</span><span class="sh">"</span><span class="s">feature_flags.use_cache</span><span class="sh">"</span><span class="s"> â†’ </span><span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="s">
        path=</span><span class="sh">"</span><span class="s">storage.s3.region</span><span class="sh">"</span><span class="s"> â†’ </span><span class="sh">"</span><span class="s">ap-northeast-2</span><span class="sh">"</span><span class="s">
    </span><span class="sh">"""</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">})}}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">get_raw</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">LLM/Config</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">get_raw</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="kn">import</span> <span class="n">json</span>
        <span class="k">def</span> <span class="nf">get_in</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">d</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">dotted</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                    <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">config path not found: </span><span class="si">{</span><span class="n">dotted</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cur</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">_CONFIG</span><span class="p">.</span><span class="nf">get_raw_config</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nf">get_in</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">path</span> <span class="k">else</span> <span class="n">raw</span>
            <span class="c1"># ìŠ¤ì¹¼ë¼ë©´ ë¬¸ìì—´í™”, ê·¸ ì™¸ì—” JSON ë¬¸ìì—´ë¡œ ë°˜í™˜
</span>            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">))</span> <span class="ow">or</span> <span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="nf">return </span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">val</span><span class="p">),)</span>
            <span class="nf">return </span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[ConfigGetRawJSON] </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LLMConfigLookup</span><span class="sh">"</span><span class="p">:</span> <span class="n">LLMConfigLookup</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">LLMConfigListModels</span><span class="sh">"</span><span class="p">:</span> <span class="n">LLMConfigListModels</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigGetRawJSON</span><span class="sh">"</span><span class="p">:</span> <span class="n">ConfigGetRawJSON</span><span class="p">,</span>  <span class="c1"># â† ë²”ìš© ì½ê¸° ë…¸ë“œ(ì„ íƒ)
</span><span class="p">}</span>

<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">LLMConfigLookup</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">LLM: Config Lookup (ReadOnly)</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">LLMConfigListModels</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">LLM: List Models (ReadOnly)</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigGetRawJSON</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Config: Get Raw JSON (ReadOnly)</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>ë…¸ë“œ/íŒ¨í‚¤ì§€ëª…ì€ ê·¸ëŒ€ë¡œ ë‘ê³ , <strong>íŒŒì¼ëª…/í™˜ê²½ë³€ìˆ˜/ë¡œë”</strong> ë§Œ ì¼ë°˜í™”í–ˆìŠµë‹ˆë‹¤. ì›í•˜ì‹œë©´ íŒ¨í‚¤ì§€/ë…¸ë“œ ì´ë¦„ë„ <code class="language-plaintext highlighter-rouge">comfyui_config_reader</code>ë¡œ ë¦¬ë„¤ì„í•´ ë“œë¦´ ìˆ˜ ìˆì–´ìš”.</p>
</blockquote>

<hr />

<h1 id="ì‚¬ìš©-ë°©ë²•-ìš”ì•½">ì‚¬ìš© ë°©ë²• (ìš”ì•½)</h1>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">config.toml</code>ë¡œ ì„¤ì • ì €ì¥(ë²”ìš© ì„¹ì…˜ ììœ  ì¶”ê°€ ê°€ëŠ¥).</p>
  </li>
  <li>
    <p>í•„ìš” ì‹œ ê²½ë¡œ ì˜¤ë²„ë¼ì´ë“œ: <code class="language-plaintext highlighter-rouge">COMFY_CONFIG_PATH=/abs/path/to/config.toml</code></p>
  </li>
  <li>
    <p>ìƒˆë¡œê³ ì¹¨ ì£¼ê¸° ì¡°ì •: <code class="language-plaintext highlighter-rouge">COMFY_CONFIG_REFRESH_SECONDS=10</code> (5~60 ìœ íš¨)</p>
  </li>
  <li>
    <p>ComfyUIì—ì„œ</p>

    <ul>
      <li>
        <p><strong>LLM: Config Lookup</strong> â†’ LLM ì—”ë“œí¬ì¸íŠ¸ 4ì¢… ê°’ ì¶œë ¥</p>
      </li>
      <li>
        <p><strong>Config: Get Raw JSON</strong> â†’ ì„ì˜ ì„¤ì • ê°’ ì½ê¸° (ì˜ˆ: <code class="language-plaintext highlighter-rouge">feature_flags.use_cache</code>)</p>
      </li>
    </ul>
  </li>
  <li>
    <p>íŒŒì¼ì„ ìˆ˜ì •í•˜ë©´ <strong>ìµœëŒ€ 1ë¶„ ë‚´</strong>(ê¸°ë³¸ 30ì´ˆ) ë°˜ì˜ë©ë‹ˆë‹¤.</p>
  </li>
</ol>

<p>í•„ìš”í•˜ë©´ í´ë”/ë…¸ë“œ ì´ë¦„ê¹Œì§€ â€œLLMâ€ì„ ë¹¼ê³  ì „ë©´ ë¦¬ë„¤ì´ë°í•œ ë²„ì „ë„ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

ì‘ ë‹¤ ë¹¼ì¤˜

</p>

<p>ì¢‹ì•„â€”ì´ì œ â€œLLMâ€ í”ì  ì „ë¶€ ëºì–´ìš”. íŒ¨í‚¤ì§€/ë…¸ë“œ/í™˜ê²½ë³€ìˆ˜/ì¹´í…Œê³ ë¦¬/í•„ë“œ ì´ë¦„ê¹Œì§€ ì „ë¶€ <strong>ë²”ìš©(config/endpoint)</strong>ìœ¼ë¡œ ë°”ê¾¼ ìµœì¢…ë³¸ì„ ë“œë¦½ë‹ˆë‹¤. ê·¸ëŒ€ë¡œ ë„£ìœ¼ë©´ ì‘ë™í•©ë‹ˆë‹¤.</p>

<hr />

<h1 id="0-í•œëˆˆì—-ë³´ê¸°-step-by-step">0) í•œëˆˆì— ë³´ê¸° (step-by-step)</h1>

<ol>
  <li>
    <p><strong>í´ë”ëª… ë³€ê²½</strong> : <code class="language-plaintext highlighter-rouge">comfyui_config_reader</code> (ì´ì „ í´ë” ì‚­ì œí•´ë„ ë¨)</p>
  </li>
  <li>
    <p><strong>ì„¤ì • íŒŒì¼ëª…</strong> : <code class="language-plaintext highlighter-rouge">config.toml</code></p>
  </li>
  <li>
    <p><strong>í™˜ê²½ë³€ìˆ˜</strong> :</p>

    <ul>
      <li>
        <p>ê²½ë¡œ: <code class="language-plaintext highlighter-rouge">COMFY_CONFIG_PATH</code></p>
      </li>
      <li>
        <p>ìƒˆë¡œê³ ì¹¨: <code class="language-plaintext highlighter-rouge">COMFY_CONFIG_REFRESH_SECONDS</code> (5~60ì´ˆ)</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ì„¹ì…˜ ì´ë¦„</strong> : <code class="language-plaintext highlighter-rouge">[endpoints."&lt;í‚¤&gt;"]</code> (í•„ë“œ: <code class="language-plaintext highlighter-rouge">display_name</code>, <code class="language-plaintext highlighter-rouge">request_name</code>, <code class="language-plaintext highlighter-rouge">base_url</code>, <code class="language-plaintext highlighter-rouge">api_key</code>)</p>
  </li>
  <li>
    <p><strong>ë…¸ë“œ ì´ë¦„</strong> :</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">ConfigEndpointLookup</code> (ì—”ë“œí¬ì¸íŠ¸ 4ì¢… ê°’ ë°˜í™˜)</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">ConfigListEndpoints</code> (ì—”ë“œí¬ì¸íŠ¸ ëª©ë¡ JSON)</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">ConfigGetValue</code> (ì„ì˜ ê²½ë¡œ ê°’ ê°€ì ¸ì˜¤ê¸°)</p>
      </li>
    </ul>
  </li>
</ol>

<hr />

<h1 id="1-ë””ë ‰í† ë¦¬-êµ¬ì¡°">1) ë””ë ‰í† ë¦¬ êµ¬ì¡°</h1>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ComfyUI/
â””â”€ custom_nodes/
   â””â”€ comfyui_config_reader/
      â”œâ”€ __init__.py
      â”œâ”€ config_reader.py       <span class="c"># ì»¤ìŠ¤í…€ ë…¸ë“œ + ì½ê¸° ì „ìš© ë¡œë”</span>
      â””â”€ config.toml            <span class="c"># ì‚¬ëŒì´ í¸ì§‘í•˜ê¸° ì‰¬ìš´ TOML</span>
</code></pre></div></div>

<hr />

<h1 id="2-ì˜ˆì‹œ-configtoml-ë²”ìš©">2) ì˜ˆì‹œ <code class="language-plaintext highlighter-rouge">config.toml</code> (ë²”ìš©)</h1>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">version</span> <span class="p">=</span> <span class="mi">1</span>

<span class="nn">[settings]</span>
<span class="c"># íŒŒì¼ ë³€ê²½ ë°˜ì˜ ì£¼ê¸°(ì´ˆ). "1ë¶„ ë‚´ ë°˜ì˜" ìš”ê±´ â†’ ê¸°ë³¸ 30ì´ˆ.</span>
<span class="py">refresh_interval_seconds</span> <span class="p">=</span> <span class="mi">30</span>

<span class="c"># â”€â”€ ì—”ë“œí¬ì¸íŠ¸(ì˜ˆ: í…ìŠ¤íŠ¸ ëª¨ë¸, ì„ë² ë”© ì„œë¹„ìŠ¤, ì‚¬ë‚´ API ë“±) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nn">[endpoints."text-model-a"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"Text Model A"</span>
<span class="py">request_name</span>  <span class="p">=</span> <span class="s">"gpt-4o-mini"</span>         <span class="c"># ì‹¤ì œ ìš”ì²­ì— ì“¸ ì‹ë³„ì/ëª¨ë¸ëª…/ë²„ì „ ë“±</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${OPENAI_API_KEY}"</span>   <span class="c"># í™˜ê²½ë³€ìˆ˜ ì¹˜í™˜ ì§€ì›</span>

<span class="nn">[endpoints."text-model-b"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"Text Model B"</span>
<span class="py">request_name</span>  <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>

<span class="c"># â”€â”€ ë‹¤ë¥¸ ë²”ìš© ì„¤ì •ë“¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nn">[feature_flags]</span>
<span class="py">use_cache</span> <span class="p">=</span> <span class="kc">true</span>
<span class="py">show_beta</span> <span class="p">=</span> <span class="kc">false</span>

<span class="nn">[storage.s3]</span>
<span class="py">bucket</span> <span class="p">=</span> <span class="s">"my-bucket"</span>
<span class="py">region</span> <span class="p">=</span> <span class="s">"ap-northeast-2"</span>
<span class="py">access_key</span> <span class="p">=</span> <span class="s">"${S3_ACCESS_KEY}"</span>
<span class="py">secret_key</span> <span class="p">=</span> <span class="s">"${S3_SECRET_KEY}"</span>
</code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">${ENV}</code> í‘œê¸°ëŠ” í™˜ê²½ë³€ìˆ˜ë¡œ ìë™ ì¹˜í™˜ë©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">endpoints."&lt;í‚¤&gt;"</code>ì˜ <code class="language-plaintext highlighter-rouge">&lt;í‚¤&gt;</code>ë¡œ, <code class="language-plaintext highlighter-rouge">display_name</code>Â·<code class="language-plaintext highlighter-rouge">request_name</code> ê¹Œì§€ <strong>ëª¨ë‘ ì¡°íšŒ í‚¤</strong> ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”.</p>
  </li>
</ul>

<hr />

<h1 id="3-ì½”ë“œ-config_readerpy">3) ì½”ë“œ: <code class="language-plaintext highlighter-rouge">config_reader.py</code></h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="c1"># Python 3.11+ tomllib / 3.10-: tomli
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="k">def</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">ë¬¸ìì—´ ë‚´ ${ENV} íŒ¨í„´ì„ í™˜ê²½ë³€ìˆ˜ë¡œ ì¹˜í™˜. ê·¸ ì™¸ íƒ€ì…ì€ ê·¸ëŒ€ë¡œ.</span><span class="sh">"""</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">env_name</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">env_name</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">_norm</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">ReadOnlyConfig</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - TOMLì„ ì½ì–´ ë©”ëª¨ë¦¬ì— ìºì‹œ
    - mtime/TTL(ìµœì†Œ 5s, ìµœëŒ€ 60s)ë¡œ ìë™ ì¬ë¡œë“œ
    - íŒŒì¼ ì“°ê¸° ì—†ìŒ(read-only)
    - íŒŒì¼ ê²°ì • ìš°ì„ ìˆœìœ„:  (1) ì¸ì path &gt; (2) COMFY_CONFIG_PATH &gt; (3) ./config.toml
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
        <span class="n">chosen</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">path</span>
            <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_PATH</span><span class="sh">"</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">chosen</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># ê¸°ë³¸ 30ì´ˆ(&lt;=60s ìš”ê±´ ì¶©ì¡±)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># ì •ê·œí™” í‚¤ -&gt; endpoint dict
</span>
    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_index_endpoints</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">endpoints</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">ep_key</span><span class="p">,</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">eps</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>

            <span class="c1"># í•„ìˆ˜ í•„ë“œ
</span>            <span class="n">required</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">required</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()]</span>
            <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                <span class="c1"># ë¶ˆì™„ì „ í•­ëª©ì€ ìŠ¤í‚µ
</span>                <span class="k">continue</span>

            <span class="c1"># ì ‘ê·¼ í‚¤: ì •ì˜ í‚¤ / display_name / request_name
</span>            <span class="n">candidates</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nf">str</span><span class="p">(</span><span class="n">ep_key</span><span class="p">),</span>
                <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)),</span>
                <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)),</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">candidates</span><span class="p">):</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">[</span><span class="nf">_norm</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]),</span>
                <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

        <span class="c1"># refresh_interval_seconds (5~60) + env override
</span>        <span class="n">conf_val</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">conf_val</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">conf_val</span><span class="p">))</span>
        <span class="n">env_override</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_override</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">conf_val</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">env_override</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span> <span class="o">=</span> <span class="n">conf_val</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index_endpoints</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">mtime</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="c1"># â”€â”€ Endpoints ì „ìš© API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
</span>    <span class="k">def</span> <span class="nf">get_endpoint</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">endpoint key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="c1"># ê°±ì‹  ì§€ì—° ê°€ëŠ¥ì„± â†’ ê°•ì œ ë¦¬ë¡œë“œ 1íšŒ ì¬ì‹œë„
</span>            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">endpoint not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">list_endpoints</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">out</span><span class="p">[</span><span class="n">dn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
                <span class="c1"># api_keyëŠ” ë³´ì•ˆìƒ ë¯¸ë…¸ì¶œ
</span>            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="c1"># â”€â”€ ë²”ìš© ì½ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
</span>    <span class="k">def</span> <span class="nf">get_raw</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_raw</span>

<span class="c1"># ì „ì—­ ì‹±ê¸€í†¤
</span><span class="n">_CONFIG</span> <span class="o">=</span> <span class="nc">ReadOnlyConfig</span><span class="p">()</span>

<span class="c1"># ===== ComfyUI Custom Nodes =====
</span><span class="k">class</span> <span class="nc">ConfigEndpointLookup</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ì…ë ¥: key â€” </span><span class="sh">"</span><span class="s">text-model-a</span><span class="sh">"</span><span class="s"> / </span><span class="sh">"</span><span class="s">Text Model A</span><span class="sh">"</span><span class="s"> / </span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="s">(request_name)
    ì¶œë ¥: display_name, request_name, base_url, api_key (ëª¨ë‘ STRING)
    </span><span class="sh">"""</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">})}}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">lookup</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Config/Endpoints (ReadOnly)</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ep</span> <span class="o">=</span> <span class="n">_CONFIG</span><span class="p">.</span><span class="nf">get_endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[ConfigEndpointLookup] </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span> <span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">],</span> <span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span> <span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">ConfigListEndpoints</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">ë””ë²„ê·¸/ì¸ìŠ¤í™ì…˜ìš©: ì—”ë“œí¬ì¸íŠ¸ ëª©ë¡(JSON, api_key ë¯¸í¬í•¨).</span><span class="sh">"""</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">endpoints_json</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">list_endpoints</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Config/Endpoints (ReadOnly)</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">list_endpoints</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="n">json</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">_CONFIG</span><span class="p">.</span><span class="nf">list_endpoints</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),)</span>

<span class="k">class</span> <span class="nc">ConfigGetValue</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ì„ì˜ ê²½ë¡œ ê°’ ì½ê¸° (</span><span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="s"> êµ¬ë¶„)
    ì˜ˆ) path=</span><span class="sh">"</span><span class="s">feature_flags.use_cache</span><span class="sh">"</span><span class="s">  â†’ </span><span class="sh">"</span><span class="s">true</span><span class="sh">"</span><span class="s">
        path=</span><span class="sh">"</span><span class="s">storage.s3.region</span><span class="sh">"</span><span class="s">        â†’ </span><span class="sh">"</span><span class="s">ap-northeast-2</span><span class="sh">"</span><span class="s">
        path=</span><span class="sh">"</span><span class="s">endpoints.text-model-a</span><span class="sh">"</span><span class="s">   â†’ í•´ë‹¹ ì—”ë“œí¬ì¸íŠ¸ JSON
    </span><span class="sh">"""</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">})}}</span>

    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">get_value</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Config/General (ReadOnly)</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="kn">import</span> <span class="n">json</span>
        <span class="k">def</span> <span class="nf">get_in</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">d</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">dotted</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                    <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">config path not found: </span><span class="si">{</span><span class="n">dotted</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cur</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">_CONFIG</span><span class="p">.</span><span class="nf">get_raw</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nf">get_in</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">path</span> <span class="k">else</span> <span class="n">raw</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">))</span> <span class="ow">or</span> <span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="nf">return </span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">val</span><span class="p">),)</span>
            <span class="nf">return </span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[ConfigGetValue] </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">ConfigEndpointLookup</span><span class="sh">"</span><span class="p">:</span> <span class="n">ConfigEndpointLookup</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigListEndpoints</span><span class="sh">"</span><span class="p">:</span>  <span class="n">ConfigListEndpoints</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigGetValue</span><span class="sh">"</span><span class="p">:</span>       <span class="n">ConfigGetValue</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">ConfigEndpointLookup</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Config: Endpoint Lookup</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigListEndpoints</span><span class="sh">"</span><span class="p">:</span>  <span class="sh">"</span><span class="s">Config: List Endpoints</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigGetValue</span><span class="sh">"</span><span class="p">:</span>       <span class="sh">"</span><span class="s">Config: Get Value</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">__init__.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># íŒ¨í‚¤ì§€ ì¸ì‹ìš© (ë¹„ì›Œë‘ë©´ ë©ë‹ˆë‹¤)
</span></code></pre></div></div>

<hr />

<h1 id="4-ìš”êµ¬ì‚¬í•­-ëŒ€ì‘-ì²´í¬">4) ìš”êµ¬ì‚¬í•­ ëŒ€ì‘ ì²´í¬</h1>

<ul>
  <li>
    <p>ì‚¬ëŒì´ í¸ì§‘í•˜ê¸° ì‰¬ì›€: <strong>TOML + ì£¼ì„ ê°€ëŠ¥</strong></p>
  </li>
  <li>
    <p>ì½ê¸° ì „ìš©: <strong>íŒŒì¼ ì“°ê¸° ì—†ìŒ</strong></p>
  </li>
  <li>
    <p>ì£¼ìš” ìš©ë„(ëª¨ë¸/ì„œë¹„ìŠ¤ ì—”ë“œí¬ì¸íŠ¸): <strong><code class="language-plaintext highlighter-rouge">endpoints</code> ì„¹ì…˜ í‘œì¤€í™”</strong></p>
  </li>
  <li>
    <p>í•„ìš”í•œ ê°’ ë°˜í™˜: <code class="language-plaintext highlighter-rouge">ConfigEndpointLookup</code>ê°€ <strong>display_name, request_name, base_url, api_key</strong> ì¶œë ¥</p>
  </li>
  <li>
    <p>ë³€ê²½ ë°˜ì˜: <strong>mtime + TTL(ê¸°ë³¸ 30ì´ˆ, 5~60ì´ˆ ì¡°ì •)</strong> â†’ <strong>ìµœëŒ€ 1ë¶„ ë‚´ ë°˜ì˜</strong> ë³´ì¥</p>
  </li>
  <li>
    <p>ë³´ì•ˆ: <strong>í™˜ê²½ë³€ìˆ˜ ì¹˜í™˜</strong> , ëª©ë¡ ë…¸ë“œì—ì„œ <strong>api_key ë¯¸ë…¸ì¶œ</strong></p>
  </li>
</ul>

<hr />

<h1 id="5-ë§ˆì´ê·¸ë ˆì´ì…˜-ê°€ì´ë“œ">5) ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ</h1>

<ul>
  <li>
    <p>ì˜ˆì „ íŒŒì¼/ì´ë¦„ì„ ì“°ì…¨ë‹¤ë©´:</p>

    <ul>
      <li>
        <p>í´ë”: <code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_llm_config_reader</code> â†’ <strong>ì‚­ì œ</strong> ë˜ëŠ” ë³´ê´€</p>
      </li>
      <li>
        <p>ì„¤ì •: <code class="language-plaintext highlighter-rouge">[llm_models]</code> â†’ <strong><code class="language-plaintext highlighter-rouge">[endpoints]</code> ë¡œ ë°”ê¾¸ê³  <code class="language-plaintext highlighter-rouge">request_model</code> â†’ <code class="language-plaintext highlighter-rouge">request_name</code></strong></p>
      </li>
      <li>
        <p>ë…¸ë“œ: ê¸°ì¡´ ì›Œí¬í”Œë¡œìš°ì—ì„  ìƒˆ ë…¸ë“œë¡œ êµì²´</p>

        <ul>
          <li>
            <p><code class="language-plaintext highlighter-rouge">LLMConfigLookup</code> â†’ <strong><code class="language-plaintext highlighter-rouge">ConfigEndpointLookup</code></strong></p>
          </li>
          <li>
            <p><code class="language-plaintext highlighter-rouge">LLMConfigListModels</code> â†’ <strong><code class="language-plaintext highlighter-rouge">ConfigListEndpoints</code></strong></p>
          </li>
          <li>
            <p><code class="language-plaintext highlighter-rouge">ConfigGetRawJSON</code> â†’ <strong><code class="language-plaintext highlighter-rouge">ConfigGetValue</code></strong></p>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<hr />

<p>í•„ìš”í•˜ë©´, ê¸°ì¡´ ì›Œí¬í”Œë¡œìš° ìë™ ë³€í™˜ ìŠ¤í¬ë¦½íŠ¸(YAML/JSON ê²½ë¡œ êµì²´)ë„ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

ë‹¤ë¥¸ ë…¸ë“œ â€œíŒŒì¼ë“¤â€ì—ì„œ ì„¤ì •ì„ ì½ì–´ì•¼í•˜ëŠ”ë° ì´ê±´ ì–´ë–»ê²Œ í•´? ì‹±ê¸€í†¤ ì¸í„°í˜ì´ìŠ¤ê°€ ì¢€ ì–´ìƒ‰í•´ë³´ì—¬

</p>

<p>ì¢‹ì€ í”¼ë“œë°±! â€œì—¬ëŸ¬ ë…¸ë“œ/íŒŒì¼ì—ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ì½ëŠ”â€ íŒ¨í„´ìœ¼ë¡œ ë°”ê¿”ì¤„ê²Œìš”.<br />
ì‹±ê¸€í†¤ ëŒ€ì‹  <strong>ê²½ë¡œë³„ Multiton ë ˆì§€ìŠ¤íŠ¸ë¦¬ + ì–‡ì€ í•¨ìˆ˜í˜• API</strong> ë¥¼ ì œê³µí•©ë‹ˆë‹¤.<br />
ì¦‰, ì–´ë””ì„œë“  <code class="language-plaintext highlighter-rouge">from comfyui_config_reader.config import endpoint, get</code>ë§Œ ì„í¬íŠ¸í•´ ì“°ë©´ ë©ë‹ˆë‹¤.</p>

<p>ì•„ë˜ ì„¸ íŒŒì¼ë§Œ ì¶”ê°€/êµì²´í•˜ë©´ ë!</p>

<hr />

<h1 id="1-êµ¬ì¡°">1) êµ¬ì¡°</h1>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ComfyUI/
â””â”€ custom_nodes/
   â””â”€ comfyui_config_reader/
      â”œâ”€ __init__.py
      â”œâ”€ config_core.py     <span class="c"># í•µì‹¬: ReadOnlyStore (ê²½ë¡œë³„ ìºì‹œ/ìë™ ë¦¬ë¡œë“œ)</span>
      â”œâ”€ config.py          <span class="c"># ê³µìš© API: endpoint()/get()/get_store()</span>
      â””â”€ config_nodes.py    <span class="c"># (ì˜µì…˜) ë°ëª¨ ë…¸ë“œë“¤: Lookup/List/Get</span>
</code></pre></div></div>

<hr />

<h1 id="2-í•µì‹¬-ìŠ¤í† ì–´-ê²½ë¡œë³„-multiton-ì•„ë‹˜--ì¸ìŠ¤í„´ìŠ¤í˜•-thread-safe">2) í•µì‹¬ ìŠ¤í† ì–´ (ê²½ë¡œë³„ Multiton ì•„ë‹˜ â€” â€œì¸ìŠ¤í„´ìŠ¤í˜•â€, thread-safe)</h1>

<p><code class="language-plaintext highlighter-rouge">config_core.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="c1"># Python 3.11+: tomllib / ì´í•˜: tomli
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="k">def</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">env_name</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">env_name</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">_norm</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">ReadOnlyStore</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - TOML ì½ê¸° ì „ìš© ìŠ¤í† ì–´
    - mtime/TTL(5~60s) ê¸°ë°˜ ìë™ ì¬ë¡œë“œ â†’ </span><span class="sh">'</span><span class="s">1ë¶„ ë‚´ ë°˜ì˜</span><span class="sh">'</span><span class="s"> ë³´ì¥
    - ì—”ë“œí¬ì¸íŠ¸ ì¸ë±ì‹± + ì„ì˜ ê²½ë¡œ ì ‘ê·¼
    - íŒŒì¼ ì“°ê¸° ì—†ìŒ
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># ê¸°ë³¸ 30s
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># ë¦¬ë¡œë“œë§ˆë‹¤ ì¦ê°€
</span>
    <span class="c1"># ---------- ë‚´ë¶€ ë¡œë”© ----------
</span>    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_index_endpoints</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">endpoints</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">ep_key</span><span class="p">,</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">eps</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
            <span class="n">required</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">required</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">ep_key</span><span class="p">),</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)),</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))}:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">[</span><span class="nf">_norm</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]),</span>
                        <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">]),</span>
                        <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]),</span>
                        <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
        <span class="c1"># refresh_interval_seconds (5~60) + env override
</span>        <span class="n">conf_val</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">conf_val</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">conf_val</span><span class="p">))</span>
        <span class="n">env_override</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_override</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">conf_val</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">env_override</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span> <span class="o">=</span> <span class="n">conf_val</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env_vars</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index_endpoints</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_version</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">mtime</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh_interval</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="c1"># ---------- í¼ë¸”ë¦­ API ----------
</span>    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_version</span>

    <span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">ENV ì¹˜í™˜ í›„ ì „ì²´ íŠ¸ë¦¬ì˜ </span><span class="sh">'</span><span class="s">ì¼ê´€ëœ ìŠ¤ëƒ…ìƒ·</span><span class="sh">'</span><span class="s">ì„ ë°˜í™˜(ì–•ì€ ë³µì‚¬).</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dotted_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_raw</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">dotted_path</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">config path not found: </span><span class="si">{</span><span class="n">dotted_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cur</span>

    <span class="k">def</span> <span class="nf">get_endpoint</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">endpoint key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="c1"># ê°±ì‹  ì§€ì—° ê°€ëŠ¥ì„± â†’ ê°•ì œ ë¦¬ë¡œë“œ 1íšŒ ì¬ì‹œë„
</span>            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">endpoint not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">list_endpoints</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_endpoint_index</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">out</span><span class="p">[</span><span class="n">dn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
                <span class="c1"># api_keyëŠ” ë¯¸ë…¸ì¶œ
</span>            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>
</code></pre></div></div>

<hr />

<h1 id="3-ê³µìš©-api-ì–´ë””ì„œë“ -ì„í¬íŠ¸í•´-ì“°ëŠ”-í•¨ìˆ˜í˜•-ì¸í„°í˜ì´ìŠ¤">3) ê³µìš© API (ì–´ë””ì„œë“  ì„í¬íŠ¸í•´ ì“°ëŠ” â€œí•¨ìˆ˜í˜•â€ ì¸í„°í˜ì´ìŠ¤)</h1>

<p><code class="language-plaintext highlighter-rouge">config.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="n">.config_core</span> <span class="kn">import</span> <span class="n">ReadOnlyStore</span>

<span class="c1"># ê²½ë¡œë³„ Multiton ë ˆì§€ìŠ¤íŠ¸ë¦¬
</span><span class="n">_REGISTRY</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ReadOnlyStore</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span> <span class="nf">_default_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_PATH</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">get_store</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReadOnlyStore</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - ê²½ë¡œë³„ë¡œ ReadOnlyStore ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¬ì‚¬ìš©(ë©€í‹°í†¤)
    - ëª…ì‹œ path ì—†ìœ¼ë©´ COMFY_CONFIG_PATH ë˜ëŠ” íŒ¨í‚¤ì§€ ê¸°ë³¸ config.toml
    </span><span class="sh">"""</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span> <span class="ow">or</span> <span class="nf">_default_path</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_REGISTRY</span><span class="p">:</span>
        <span class="n">_REGISTRY</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="nc">ReadOnlyStore</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_REGISTRY</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>

<span class="c1"># ---- ì–‡ì€ í•¨ìˆ˜í˜• í—¬í¼ë“¤ (ê¶Œì¥) ----
</span><span class="k">def</span> <span class="nf">endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">ì—”ë“œí¬ì¸íŠ¸ dict ë°˜í™˜: display_name, request_name, base_url, api_key</span><span class="sh">"""</span>
    <span class="k">return</span> <span class="nf">get_store</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">get_endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">endpoints</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
    <span class="sh">"""</span><span class="s">ì—”ë“œí¬ì¸íŠ¸ ëª©ë¡(JSONìš©)</span><span class="sh">"""</span>
    <span class="k">return</span> <span class="nf">get_store</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">list_endpoints</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">dotted_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">ì„ì˜ ì„¤ì •ê°’ ë°˜í™˜: </span><span class="sh">'</span><span class="s">section.sub.key</span><span class="sh">'"""</span>
    <span class="k">return</span> <span class="nf">get_store</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">get_value</span><span class="p">(</span><span class="n">dotted_path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">ì „ì²´ íŠ¸ë¦¬ ìŠ¤ëƒ…ìƒ·</span><span class="sh">"""</span>
    <span class="k">return</span> <span class="nf">get_store</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">snapshot</span><span class="p">()</span>
</code></pre></div></div>

<blockquote>
  <p>í¬ì¸íŠ¸: <strong>ë‹¤ë¥¸ ë…¸ë“œ íŒŒì¼</strong> ì—ì„œëŠ” <code class="language-plaintext highlighter-rouge">config.endpoint()</code>, <code class="language-plaintext highlighter-rouge">config.get()</code> ê°™ì€ <strong>í•¨ìˆ˜í˜• APIë§Œ</strong> ì“°ë©´ ë©ë‹ˆë‹¤.<br />
 ë‚´ë¶€ì ìœ¼ë¡œëŠ” ê²½ë¡œë³„ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¬ì‚¬ìš©í•˜ì§€ë§Œ, ë…¸ë“œ ì½”ë“œì—ì„œëŠ” ì‹±ê¸€í†¤ì— ì˜ì¡´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
</blockquote>

<hr />

<h1 id="4-ì˜µì…˜-ë°ëª¨-ë…¸ë“œ--ê¸°ì¡´-ë…¸ë“œë¥¼-ì´-apië¡œ-ì–‡ê²Œ-ë˜í•‘">4) (ì˜µì…˜) ë°ëª¨ ë…¸ë“œ â€” ê¸°ì¡´ ë…¸ë“œë¥¼ ì´ APIë¡œ ì–‡ê²Œ ë˜í•‘</h1>

<p><code class="language-plaintext highlighter-rouge">config_nodes.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">.config</span> <span class="kn">import</span> <span class="n">endpoint</span> <span class="k">as</span> <span class="n">_endpoint</span><span class="p">,</span> <span class="n">endpoints</span> <span class="k">as</span> <span class="n">_endpoints</span><span class="p">,</span> <span class="n">get</span> <span class="k">as</span> <span class="n">_get</span>
<span class="kn">import</span> <span class="n">json</span>

<span class="k">class</span> <span class="nc">ConfigEndpointLookup</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
                             <span class="sh">"</span><span class="s">config_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">})}}</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">lookup</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Config/Endpoints (ReadOnly)</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">config_path</span> <span class="ow">or</span> <span class="bp">None</span>
        <span class="n">ep</span> <span class="o">=</span> <span class="nf">_endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span> <span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">],</span> <span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span> <span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">ConfigListEndpoints</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">config_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">})}}</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">endpoints_json</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">list_endpoints</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Config/Endpoints (ReadOnly)</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">list_endpoints</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">config_path</span> <span class="ow">or</span> <span class="bp">None</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_endpoints</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),)</span>

<span class="k">class</span> <span class="nc">ConfigGetValue</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
                             <span class="sh">"</span><span class="s">config_path</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">})}}</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">value</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">get_value</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Config/General (ReadOnly)</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">config_path</span> <span class="ow">or</span> <span class="bp">None</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nf">_get</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">))</span> <span class="ow">or</span> <span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="nf">return </span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">val</span><span class="p">),)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),)</span>

<span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">ConfigEndpointLookup</span><span class="sh">"</span><span class="p">:</span> <span class="n">ConfigEndpointLookup</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigListEndpoints</span><span class="sh">"</span><span class="p">:</span>  <span class="n">ConfigListEndpoints</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigGetValue</span><span class="sh">"</span><span class="p">:</span>       <span class="n">ConfigGetValue</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">ConfigEndpointLookup</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Config: Endpoint Lookup</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigListEndpoints</span><span class="sh">"</span><span class="p">:</span>  <span class="sh">"</span><span class="s">Config: List Endpoints</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigGetValue</span><span class="sh">"</span><span class="p">:</span>       <span class="sh">"</span><span class="s">Config: Get Value</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h1 id="5-ë‹¤ë¥¸-ë…¸ë“œ-íŒŒì¼ë“¤ì—ì„œ-ì“°ëŠ”-ë²•-ê°€ì¥-ê¹”ë”í•œ-íŒ¨í„´">5) ë‹¤ë¥¸ ë…¸ë“œ â€œíŒŒì¼ë“¤â€ì—ì„œ ì“°ëŠ” ë²• (ê°€ì¥ ê¹”ë”í•œ íŒ¨í„´)</h1>

<p>ë‹¤ë¥¸ í”ŒëŸ¬ê·¸ì¸/ë…¸ë“œ íŒŒì¼ ì–´ë””ì—ì„œë“ :</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ì˜ˆ: OpenAI í˜¸ì¶œ ë…¸ë“œ íŒŒì¼ ë‚´ë¶€
</span><span class="kn">from</span> <span class="n">comfyui_config_reader.config</span> <span class="kn">import</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">get</span>

<span class="k">def</span> <span class="nf">_prepare_client</span><span class="p">():</span>
    <span class="n">ep</span> <span class="o">=</span> <span class="nf">endpoint</span><span class="p">(</span><span class="sh">"</span><span class="s">text-model-a</span><span class="sh">"</span><span class="p">)</span>   <span class="c1"># ë˜ëŠ” display_name / request_nameë¡œ ì¡°íšŒ
</span>    <span class="n">api_key</span> <span class="o">=</span> <span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">base_url</span> <span class="o">=</span> <span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]</span>
    <span class="c1"># ... í´ë¼ì´ì–¸íŠ¸ ìƒì„±
</span>    <span class="k">return</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">base_url</span>

<span class="k">def</span> <span class="nf">_s3_settings</span><span class="p">():</span>
    <span class="n">region</span> <span class="o">=</span> <span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">storage.s3.region</span><span class="sh">"</span><span class="p">)</span>    <span class="c1"># ë²”ìš© ì„¤ì • ì ‘ê·¼
</span>    <span class="n">bucket</span> <span class="o">=</span> <span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">storage.s3.bucket</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">region</span><span class="p">,</span> <span class="n">bucket</span>
</code></pre></div></div>

<ul>
  <li>
    <p>ê¸°ë³¸ ê²½ë¡œëŠ” <code class="language-plaintext highlighter-rouge">COMFY_CONFIG_PATH</code> ë˜ëŠ” <code class="language-plaintext highlighter-rouge">comfyui_config_reader/config.toml</code>.</p>
  </li>
  <li>
    <p>íŠ¹ì • íŒŒì¼ì„ ì“°ê³  ì‹¶ìœ¼ë©´ <code class="language-plaintext highlighter-rouge">endpoint("text-model-a", path="/abs/path/to/config.toml")</code>ì²˜ëŸ¼ <strong>í•¨ìˆ˜ ì¸ì</strong> ë¡œ ì£¼ë©´ ë©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë‚´ë¶€ëŠ” <strong>ê²½ë¡œë³„ ë ˆì§€ìŠ¤íŠ¸ë¦¬(Multiton)</strong>ë¼ ê°™ì€ ê²½ë¡œëŠ” ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê³µìœ (ì„±ëŠ¥â†‘)í•˜ì§€ë§Œ, í˜¸ì¶œë¶€ëŠ” <strong>í•¨ìˆ˜í˜•</strong> ì´ë¼ ì‹±ê¸€í†¤ì— ì¢…ì†ë˜ì§€ ì•Šì•„ìš”.</p>
  </li>
</ul>

<hr />

<h1 id="6-ìš”ê±´-ì²´í¬">6) ìš”ê±´ ì²´í¬</h1>

<ul>
  <li>
    <p>ì—¬ëŸ¬ ë…¸ë“œ/íŒŒì¼ì—ì„œ ê³µí†µ ì‚¬ìš©: <strong>í•¨ìˆ˜í˜• API</strong> ë¡œ ê°„ë‹¨ ì„í¬íŠ¸</p>
  </li>
  <li>
    <p>ì‹±ê¸€í†¤ ì–´ìƒ‰í•¨ ì œê±°: <strong>ê²½ë¡œë³„ Multiton + helper í•¨ìˆ˜</strong> â†’ ëª…ì‹œì  DIë„ ê°€ëŠ¥(<code class="language-plaintext highlighter-rouge">get_store(path)</code>)</p>
  </li>
  <li>
    <p>ì½ê¸° ì „ìš© + 1ë¶„ ë‚´ ë°˜ì˜: <strong>mtime + 5~60s TTL(ê¸°ë³¸ 30s)</strong></p>
  </li>
  <li>
    <p>ì‚¬ëŒì´ í¸ì§‘ ì‰¬ì›€: <strong>TOML + ENV ì¹˜í™˜</strong></p>
  </li>
  <li>
    <p>ì—”ë“œí¬ì¸íŠ¸ 4í•„ë“œ: <code class="language-plaintext highlighter-rouge">display_name, request_name, base_url, api_key</code></p>
  </li>
</ul>

<hr />

<p>í•„ìš”í•˜ë©´ <code class="language-plaintext highlighter-rouge">get_store(path)</code>ë¡œ <strong>ëª…ì‹œì  ì˜ì¡´ì„± ì£¼ì…(DI)</strong>ë„ ê°€ëŠ¥í•´ìš”. ì˜ˆì»¨ëŒ€ í”„ë ˆì„ì›Œí¬ ì´ˆê¸°í™” ì‹œ:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader.config</span> <span class="kn">import</span> <span class="n">get_store</span>
<span class="n">STORE</span> <span class="o">=</span> <span class="nf">get_store</span><span class="p">(</span><span class="sh">"</span><span class="s">/path/to/config.toml</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ì´í›„ ì–´ë””ì„œë“ :
</span><span class="n">ep</span> <span class="o">=</span> <span class="n">STORE</span><span class="p">.</span><span class="nf">get_endpoint</span><span class="p">(</span><span class="sh">"</span><span class="s">text-model-a</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>ì´ë ‡ê²Œ í•˜ë©´ ì•„ì˜ˆ ì „ì—­ í•¨ìˆ˜ë„ ì•ˆ ì“°ê³ , â€œë‚´ê°€ ì£¼ì…í•œ ìŠ¤í† ì–´â€ë§Œ ì°¸ì¡°í•˜ëŠ” í˜•íƒœë¡œ ì™„ì „íˆ ë¶„ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p class="chat--user">

ì•„ë‹ˆ ì‹±ê¸€í†¤ì€ ê´œì°®ì€ë° ì™¸ë¶€ì—ì„œ ì ‘ê·¼ì´ ì‰½ì§€ ì•Šì•„ë³´ì—¬ì„œ. ì‹±ê¸€í†¤ì´ ë‚«ì§€ ì•Šì•„?

</p>

<p>ì¢‹ì•„, <strong>ì‹±ê¸€í†¤ìœ¼ë¡œ ë‹¨ìˆœÂ·ì§ê´€ ì ‘ê·¼</strong> ê°€ëŠ¥í•˜ê²Œ ì •ë¦¬í•´ì¤„ê²Œ.<br />
ì™¸ë¶€ ë…¸ë“œ â€œíŒŒì¼ë“¤â€ ì–´ë””ì„œë“  í•œ ì¤„ ì„í¬íŠ¸ë¡œ ë°”ë¡œ ì“°ëŠ” í˜•íƒœì•¼:</p>

<ul>
  <li>
    <p>í•¨ìˆ˜í˜•: <code class="language-plaintext highlighter-rouge">from comfyui_config_reader import endpoint, get</code></p>
  </li>
  <li>
    <p>ê°ì²´í˜•: <code class="language-plaintext highlighter-rouge">from comfyui_config_reader import CONFIG</code></p>
  </li>
</ul>

<p>ë‘˜ ë‹¤ ê°™ì€ ì‹±ê¸€í†¤ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë’¤ì—ì„œ ì‚¬ìš©í•´. (thread-safe, read-only, 1ë¶„ ë‚´ ë°˜ì˜)</p>

<hr />

<h1 id="1-íŒŒì¼-êµ¬ì¡°-ì‹¬í”Œ">1) íŒŒì¼ êµ¬ì¡° (ì‹¬í”Œ)</h1>
<div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ComfyUI/
â””â”€ custom_nodes/
   â””â”€ comfyui_config_reader/
      â”œâ”€ __init__.py
      â”œâ”€ config_singleton.py   # ì‹±ê¸€í†¤ ë³¸ì²´
      â””â”€ config.toml
</code></pre></div></div>

<hr />

<h1 id="2-configtoml-ì˜ˆì‹œ-ë²”ìš©">2) <code class="language-plaintext highlighter-rouge">config.toml</code> ì˜ˆì‹œ (ë²”ìš©)</h1>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">version</span> <span class="p">=</span> <span class="mi">1</span>

<span class="nn">[settings]</span>
<span class="py">refresh_interval_seconds</span> <span class="p">=</span> <span class="mi">30</span>  <span class="c"># 5~60 ì‚¬ì´ ê¶Œì¥</span>

<span class="nn">[endpoints."text-model-a"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"Text Model A"</span>
<span class="py">request_name</span>  <span class="p">=</span> <span class="s">"gpt-4o-mini"</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${OPENAI_API_KEY}"</span>

<span class="nn">[feature_flags]</span>
<span class="py">use_cache</span> <span class="p">=</span> <span class="kc">true</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">${ENV}</code> ëŠ” í™˜ê²½ë³€ìˆ˜ ì¹˜í™˜ë¨.</li>
</ul>

<hr />

<h1 id="3-ì‹±ê¸€í†¤-êµ¬í˜„-config_singletonpy">3) ì‹±ê¸€í†¤ êµ¬í˜„: <code class="language-plaintext highlighter-rouge">config_singleton.py</code></h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="c1"># Python 3.11+: tomllib / ì´í•˜: tomli
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="k">def</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="sh">""</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">v</span>

<span class="k">def</span> <span class="nf">_norm</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - TOML íŒŒì¼ ì½ê¸° ì „ìš©
    - mtime ë³€ê²½ + TTL(5~60s, ê¸°ë³¸ 30s) ìë™ ì¬ë¡œë“œ
    - endpoints 4í•„ë“œ ì¸ë±ì‹±(display_name, request_name, base_url, api_key)
    - ì„ì˜ ê²½ë¡œ ì ‘ê·¼ ê°€ëŠ¥ (</span><span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="s"> êµ¬ë¶„)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ep_index</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># -------- ë‚´ë¶€ ë¡œë”© --------
</span>    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ep_index</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">endpoints</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">return</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">eps</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
            <span class="n">req</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">req</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)),</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))}:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_ep_index</span><span class="p">[</span><span class="nf">_norm</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]),</span>
                        <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">]),</span>
                        <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]),</span>
                        <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]),</span>
                    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
        <span class="c1"># refresh_interval_seconds (5~60) + env override
</span>        <span class="n">r</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
        <span class="n">env_r</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_r</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">env_r</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span> <span class="k">pass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="n">r</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="c1"># -------- í¼ë¸”ë¦­ API --------
</span>    <span class="k">def</span> <span class="nf">endpoint</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">endpoint key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ep_index</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="c1"># ì¦‰ì‹œ ì¬ì‹œë„(ê°±ì‹  ì§€ì—° ë³´ì •)
</span>            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ep_index</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">endpoint not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">endpoints</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_ep_index</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">out</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>  <span class="c1"># api_key ë¯¸ë…¸ì¶œ
</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_raw</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">dotted</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">config path not found: </span><span class="si">{</span><span class="n">dotted</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cur</span>

    <span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>

<span class="c1"># ===== ëª¨ë“ˆ ì „ì—­ ì‹±ê¸€í†¤ =====
</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
<span class="n">_instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ReadOnlyConfig</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">_default_path</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># configure()ë¡œ ì§€ì • ê°€ëŠ¥
</span>
<span class="k">def</span> <span class="nf">_resolve_default_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_default_path</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_PATH</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_get_instance</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span>
    <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">_instance</span>

<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">refresh_seconds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ì‹±ê¸€í†¤ ì„¤ì •(ì„ íƒ): ê²½ë¡œ/TTL ì˜¤ë²„ë¼ì´ë“œ.
    - ê°€ëŠ¥í•œ í•œ </span><span class="sh">'</span><span class="s">ì´ˆê¸°í™” ì‹œ 1íšŒ</span><span class="sh">'</span><span class="s">ë§Œ í˜¸ì¶œ ì¶”ì²œ.
    - ì´í›„ì—ë„ í˜¸ì¶œ ê°€ëŠ¥í•˜ë©°, ìƒˆ ì¸ìŠ¤í„´ìŠ¤ë¡œ êµì²´ë¨( thread-safe ).
    </span><span class="sh">"""</span>
    <span class="k">global</span> <span class="n">_instance</span><span class="p">,</span> <span class="n">_default_path</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">_default_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">refresh_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">refresh_seconds</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
        <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>

<span class="c1"># ---- ì™¸ë¶€ì— ë…¸ì¶œí•  ì–‡ì€ API (ê°€ì¥ ì‰¬ìš´ ì ‘ê·¼) ----
</span><span class="k">def</span> <span class="nf">endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">endpoints</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
    <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">endpoints</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">snapshot</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">snapshot</span><span class="p">()</span>

<span class="c1"># ---- ê°ì²´í˜• ì ‘ê·¼ì„ ìœ„í•œ í”„ë¡ì‹œ(CONFIG) ----
</span><span class="k">class</span> <span class="nc">_ConfigProxy</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># CONFIG.endpoint(...), CONFIG.get(...) í˜•íƒœ ì§€ì›
</span>        <span class="k">return</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">_get_instance</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>

<span class="n">CONFIG</span> <span class="o">=</span> <span class="nf">_ConfigProxy</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="4-__init__py-í•œ-ì¤„-ì„í¬íŠ¸-ì§€ì›">4) <code class="language-plaintext highlighter-rouge">__init__.py</code> (í•œ ì¤„ ì„í¬íŠ¸ ì§€ì›)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ì™¸ë¶€ì—ì„œ ì•„ì£¼ ê°„ë‹¨íˆ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ re-export
</span><span class="kn">from</span> <span class="n">.config_singleton</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CONFIG</span><span class="p">,</span>        <span class="c1"># ê°ì²´í˜•: CONFIG.endpoint(...), CONFIG.get(...)
</span>    <span class="n">configure</span><span class="p">,</span>     <span class="c1"># ì„ íƒ: ì´ˆê¸°í™” ì‹œ ê²½ë¡œ/TTL ì§€ì •
</span>    <span class="n">endpoint</span><span class="p">,</span>      <span class="c1"># í•¨ìˆ˜í˜•: endpoint("text-model-a")
</span>    <span class="n">endpoints</span><span class="p">,</span>
    <span class="n">get</span><span class="p">,</span>
    <span class="n">snapshot</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<hr />

<h1 id="5-ì™¸ë¶€-ë…¸ë“œ-íŒŒì¼ë“¤ì—ì„œ-ì“°ëŠ”-ë²•">5) ì™¸ë¶€ ë…¸ë“œ â€œíŒŒì¼ë“¤â€ì—ì„œ ì“°ëŠ” ë²•</h1>

<h2 id="ê°€ì¥-ê°„ë‹¨-í•¨ìˆ˜í˜•">ê°€ì¥ ê°„ë‹¨ (í•¨ìˆ˜í˜•)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">get</span>

<span class="k">def</span> <span class="nf">build_client</span><span class="p">():</span>
    <span class="n">ep</span> <span class="o">=</span> <span class="nf">endpoint</span><span class="p">(</span><span class="sh">"</span><span class="s">text-model-a</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># í‚¤ / display_name / request_name ì¤‘ ì•„ë¬´ê±°ë‚˜ OK
</span>    <span class="n">base_url</span> <span class="o">=</span> <span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">api_key</span>  <span class="o">=</span> <span class="n">ep</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
    <span class="c1"># ... í´ë¼ì´ì–¸íŠ¸ ìƒì„±
</span></code></pre></div></div>

<h2 id="ê°ì²´í˜•ì´-ìµìˆ™í•˜ë‹¤ë©´">ê°ì²´í˜•ì´ ìµìˆ™í•˜ë‹¤ë©´</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="n">CONFIG</span>

<span class="k">def</span> <span class="nf">build_client</span><span class="p">():</span>
    <span class="n">ep</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="p">.</span><span class="nf">endpoint</span><span class="p">(</span><span class="sh">"</span><span class="s">text-model-a</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># CONFIG.get("storage.s3.region") ë“±ë„ ë™ì¼
</span></code></pre></div></div>

<h2 id="ì‹œì‘-ì‹œ-ê²½ë¡œttl-ì§€ì •ì„ íƒ">ì‹œì‘ ì‹œ ê²½ë¡œ/TTL ì§€ì •(ì„ íƒ)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ì˜ˆ: __init__ í˜¹ì€ ComfyUI ë¶€íŒ… ì´ˆê¸°ì— í•œ ë²ˆ
</span><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="n">configure</span>
<span class="nf">configure</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="sh">"</span><span class="s">/abs/path/to/config.toml</span><span class="sh">"</span><span class="p">,</span> <span class="n">refresh_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>  <span class="c1"># 5~60 ì‚¬ì´
</span></code></pre></div></div>

<ul>
  <li>ì´í›„ ëª¨ë“  ëª¨ë“ˆì—ì„œ ê°™ì€ ì‹±ê¸€í†¤ì„ ì‚¬ìš©í•˜ê³ , íŒŒì¼ ë³€ê²½ì€ <strong>ìµœëŒ€ 1ë¶„ ë‚´</strong> ë°˜ì˜ë¼ìš”(ê¸°ë³¸ 30ì´ˆ, env/ì„¤ì •ìœ¼ë¡œ ì¡°ì ˆ).</li>
</ul>

<hr />

<h1 id="6-ìš”ê±´-ì¬í™•ì¸">6) ìš”ê±´ ì¬í™•ì¸</h1>

<ul>
  <li>
    <p>âœ… ì™¸ë¶€ ì ‘ê·¼ ì‰¬ì›€: <code class="language-plaintext highlighter-rouge">from comfyui_config_reader import endpoint</code> ë˜ëŠ” <code class="language-plaintext highlighter-rouge">CONFIG.endpoint</code></p>
  </li>
  <li>
    <p>âœ… ì‹±ê¸€í†¤: ëª¨ë“ˆ ì „ì—­ í•œ ê°œ ì¸ìŠ¤í„´ìŠ¤, thread-safe lazy init</p>
  </li>
  <li>
    <p>âœ… ì½ê¸° ì „ìš©: ì“°ê¸° ì—†ìŒ</p>
  </li>
  <li>
    <p>âœ… 1ë¶„ ë‚´ ë°˜ì˜: mtime + TTL(ê¸°ë³¸ 30s, 5~60s)</p>
  </li>
  <li>
    <p>âœ… ì‚¬ëŒì´ í¸ì§‘ ì‰¬ì›€: TOML + <code class="language-plaintext highlighter-rouge">${ENV}</code> ì¹˜í™˜</p>
  </li>
  <li>
    <p>âœ… ì—”ë“œí¬ì¸íŠ¸ 4í•„ë“œ: <code class="language-plaintext highlighter-rouge">display_name</code>, <code class="language-plaintext highlighter-rouge">request_name</code>, <code class="language-plaintext highlighter-rouge">base_url</code>, <code class="language-plaintext highlighter-rouge">api_key</code></p>
  </li>
</ul>

<p>í•„ìš”í•˜ë©´, ì§€ê¸ˆ êµ¬ì¡° ìœ„ì— â€œì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œìš© ë…¸ë“œâ€ë„ ë°”ë¡œ ì–¹ì–´ì¤„ê²Œ.</p>

<p class="chat--user">

endpoint ë§ê³  ì¢€ ë” ì¢‹ì€ ìš©ì–´ ì„ ì •í•´ì¤˜. ê·¸ë¦¬ê³  model configuration (parameter ë“±ë„ ì„¤ì •ì— ê°™ì´ í¬í•¨ì‹œí‚¤ë©´ ì¢‹ê² ì–´)

</p>

<p>ì¢‹ì•„! â€œendpointâ€ ëŒ€ì‹  ë” ìì—°ìŠ¤ëŸ¬ìš´ ìš©ì–´ë¡œ <strong>profile(í”„ë¡œí•„)</strong> ì„ ì“°ê³ , ì—¬ê¸°ì— <strong>model configuration(íŒŒë¼ë¯¸í„° ë“±)</strong> ê¹Œì§€ í•¨ê»˜ ë‹´ëŠ” ë°©í–¥ìœ¼ë¡œ ì •ë¦¬í–ˆì–´.<br />
ì™¸ë¶€ ë…¸ë“œ/íŒŒì¼ì—ì„œëŠ” <strong>ì‹±ê¸€í†¤</strong> ì„ ì•„ì£¼ ê°„ë‹¨íˆ ì“°ë©´ ë˜ê³ , ê¸°ì¡´ endpoint ëª…ì¹­ì€ <strong>í•˜ìœ„ í˜¸í™˜ ë³„ì¹­</strong> ë„ ì œê³µí•´ë‘˜ê²Œ.</p>

<hr />

<h1 id="1-ìš©ì–´-ì„ ì •-step-by-step">1) ìš©ì–´ ì„ ì • (step-by-step)</h1>

<ol>
  <li>
    <p><strong>profile (í”„ë¡œí•„)</strong> â€” ì‚¬ëŒì´ ì´í•´í•˜ê¸° ì‰¬ì›€. â€œì—°ê²° ì •ë³´ + í˜¸ì¶œ ê·œì¹™ + ëª¨ë¸ íŒŒë¼ë¯¸í„° ë¬¶ìŒâ€ì„ í•œ ì„¸íŠ¸ë¡œ ë³´ê¸°ì— ì í•©.</p>
  </li>
  <li>
    <p>ëŒ€ì•ˆ(ì°¸ê³ ): provider, backend, connector, target.</p>

    <ul>
      <li>ê¸°ìˆ ì ìœ¼ë¡œëŠ” <em>backend</em> ë„ ê´œì°®ì§€ë§Œ, â€œì„¤ì • ë¬¶ìŒâ€ ë‰˜ì•™ìŠ¤ëŠ” <em>profile</em> ì´ ê°€ì¥ ì§ê´€ì .</li>
    </ul>
  </li>
  <li>
    <p>ê²°ë¡ : <strong>profiles</strong> ì„¹ì…˜ìœ¼ë¡œ í‘œì¤€í™”í•˜ê³ , <strong>endpoints</strong> ëŠ” ìë™ ì¸ì‹(í•˜ìœ„ í˜¸í™˜) ìœ ì§€.</p>
  </li>
</ol>

<hr />

<h1 id="2-configtoml-ìŠ¤í‚¤ë§ˆ-ëª¨ë¸-íŒŒë¼ë¯¸í„°-í¬í•¨">2) config.toml ìŠ¤í‚¤ë§ˆ (ëª¨ë¸ íŒŒë¼ë¯¸í„° í¬í•¨)</h1>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">version</span> <span class="p">=</span> <span class="mi">1</span>

<span class="nn">[settings]</span>
<span class="c"># íŒŒì¼ ë³€ê²½ ê°ì§€ ì£¼ê¸°(ì´ˆ). 5~60 ê¶Œì¥. "1ë¶„ ë‚´ ë°˜ì˜" ìš”ê±´ ë§Œì¡±.</span>
<span class="py">refresh_interval_seconds</span> <span class="p">=</span> <span class="mi">30</span>

<span class="c"># ëª¨ë“  í”„ë¡œí•„ì— ê³µí†µ ì ìš©ë  ê¸°ë³¸ê°’(ì„ íƒ)</span>
<span class="nn">[defaults.params]</span>
<span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.3</span>
<span class="py">max_tokens</span>  <span class="p">=</span> <span class="mi">2048</span>

<span class="nn">[defaults.http]</span>
<span class="py">timeout_seconds</span> <span class="p">=</span> <span class="mi">30</span>
<span class="nn">[defaults.http.headers]</span>
<span class="py">User-Agent</span> <span class="p">=</span> <span class="s">"ComfyUI-ConfigReader/1.0"</span>
<span class="nn">[defaults.http.query]</span>
<span class="c"># ê³µí†µ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•˜ë©´ ì—¬ê¸°ì—</span>

<span class="c"># â”€â”€ í”„ë¡œí•„ë“¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nn">[profiles."text-model-a"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"Text Model A"</span>
<span class="py">request_name</span>  <span class="p">=</span> <span class="s">"gpt-4o-mini"</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${OPENAI_API_KEY}"</span>

<span class="c"># ì´ í”„ë¡œí•„ì˜ ëª¨ë¸ íŒŒë¼ë¯¸í„°(ê¸°ë³¸ê°’ ìœ„ì— ë®ì–´ì“°ê¸°)</span>
<span class="nn">[profiles."text-model-a".params]</span>
<span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.2</span>
<span class="py">top_p</span>       <span class="p">=</span> <span class="mf">0.9</span>
<span class="py">stop</span>        <span class="p">=</span> <span class="p">[</span><span class="s">"</span><span class="se">\n\n</span><span class="s">Human:"</span><span class="p">,</span> <span class="s">"</span><span class="se">\n\n</span><span class="s">Assistant:"</span><span class="p">]</span>

<span class="c"># HTTP ê´€ë ¨(ì„ íƒ): í—¤ë”, íƒ€ì„ì•„ì›ƒ, ì¿¼ë¦¬ ë“±</span>
<span class="nn">[profiles."text-model-a".http]</span>
<span class="py">timeout_seconds</span> <span class="p">=</span> <span class="mi">20</span>
<span class="nn">[profiles."text-model-a".http.headers]</span>
<span class="py">X-Org-Id</span> <span class="p">=</span> <span class="s">"${ORG_ID}"</span>
<span class="nn">[profiles."text-model-a".http.query]</span>
<span class="py">apiVersion</span> <span class="p">=</span> <span class="s">"2024-06-01"</span>

<span class="nn">[profiles."text-model-b"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"Text Model B"</span>
<span class="py">request_name</span>  <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>
<span class="c"># params/http ì„¹ì…˜ì´ ì—†ìœ¼ë©´ defaultsë§Œ ì ìš©</span>
</code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">${ENV}</code> ëŠ” í™˜ê²½ë³€ìˆ˜ ì¹˜í™˜ë¨.</p>
  </li>
  <li>
    <p><strong>params</strong> : temperature/top_p/max_tokens/stop/seed ë“± ì›í•˜ëŠ” íŒŒë¼ë¯¸í„° ììœ  í™•ì¥.</p>
  </li>
  <li>
    <p><strong>http</strong> : timeout_seconds / headers / query ë“± ìš”ì²­ ê´€ë ¨ ì˜µì…˜.</p>
  </li>
  <li>
    <p>ìƒë‹¨ì˜ <strong>[defaults]</strong> ëŠ” ëª¨ë“  í”„ë¡œí•„ì— <strong>ë³‘í•©(merge)</strong> ë˜ì–´ ê¸°ë³¸ê°’ ì—­í• .</p>
  </li>
</ul>

<hr />

<h1 id="3-ì‹±ê¸€í†¤-api-drop-in-profile--params--http">3) ì‹±ê¸€í†¤ API (drop-in): profile + params + http</h1>

<p>ì™¸ë¶€ ì–´ë””ì„œë“  í•œ ì¤„ë¡œ ì ‘ê·¼:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="n">profile</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">http</span><span class="p">,</span> <span class="n">get</span>
<span class="c1"># ë˜ëŠ” ê°ì²´í˜•:
</span><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="n">CONFIG</span>
</code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">profile(key)</code> â†’ ì—°ê²°ì •ë³´ + ëª¨ë¸íŒŒë¼ë¯¸í„° + http ì„¤ì •ê¹Œì§€ <strong>í•œ ë²ˆì—</strong></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">params(key)</code> â†’ í•´ë‹¹ í”„ë¡œí•„ì˜ <strong>ëª¨ë¸ íŒŒë¼ë¯¸í„° dict</strong></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">http(key)</code> â†’ í•´ë‹¹ í”„ë¡œí•„ì˜ <strong>HTTP ì˜µì…˜ dict</strong></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">get("storage.s3.region")</code> ì²˜ëŸ¼ ë²”ìš© í‚¤ ì ‘ê·¼ë„ ìœ ì§€</p>
  </li>
  <li>
    <p>í•˜ìœ„ í˜¸í™˜: <code class="language-plaintext highlighter-rouge">endpoint</code>, <code class="language-plaintext highlighter-rouge">endpoints</code> ë³„ì¹­ë„ ë‚¨ê²¨ë‘ (ê¸°ì¡´ ì½”ë“œ ì•ˆê¹¨ì§)</p>
  </li>
</ul>

<hr />

<h1 id="4-êµì²´ë³¸-ì½”ë“œ-config_singletonpy">4) êµì²´ë³¸ ì½”ë“œ (<code class="language-plaintext highlighter-rouge">config_singleton.py</code>)</h1>

<p>ì•„ë˜ íŒŒì¼ í•˜ë‚˜ë¡œ ê¸°ì¡´ ì‹±ê¸€í†¤ êµ¬í˜„ì„ ëŒ€ì²´í•˜ë©´ ë¼. (ê¸°ëŠ¥: profiles + defaults ë³‘í•© + params/http ì§€ì› + legacy <code class="language-plaintext highlighter-rouge">endpoints</code> ì¸ì‹)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="c1"># Python 3.11+: tomllib / ì´í•˜: tomli
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>  <span class="c1"># type: ignore
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="k">def</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="sh">""</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">v</span>

<span class="k">def</span> <span class="nf">_norm</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">base</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">over</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">ì–•ì€ dict updateê°€ ì•„ë‹Œ, ì¤‘ì²© dictê¹Œì§€ ë³‘í•©.</span><span class="sh">"""</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">over</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - ì½ê¸° ì „ìš© TOML
    - mtime + TTL(5~60s, ê¸°ë³¸ 30s) ìë™ ì¬ë¡œë“œ â†’ 1ë¶„ ë‚´ ë³€ê²½ ë°˜ì˜
    - </span><span class="sh">'</span><span class="s">profiles</span><span class="sh">'</span><span class="s"> í‘œì¤€ + </span><span class="sh">'</span><span class="s">endpoints</span><span class="sh">'</span><span class="s"> ë ˆê±°ì‹œë„ ìë™ ì¸ì‹
    - ê° profileì—:
        * display_name, request_name, base_url, api_key (í•„ìˆ˜)
        * params(dict)  : ëª¨ë¸ íŒŒë¼ë¯¸í„°
        * http(dict)    : timeout_seconds, headers{}, query{}
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># ì •ê·œí™” í‚¤ -&gt; profile dict
</span>
    <span class="c1"># -------- ë‚´ë¶€ ë¡œë”© --------
</span>    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_extract_profiles_table</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># í‘œì¤€ 'profiles' ìš°ì„ , ì—†ìœ¼ë©´ 'endpoints'(í•˜ìœ„ í˜¸í™˜)
</span>        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">profiles</span><span class="sh">"</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">profiles</span><span class="sh">"</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">endpoints</span><span class="sh">"</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">endpoints</span><span class="sh">"</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

        <span class="c1"># defaults (ENV í™•ì¥ í¬í•¨)
</span>        <span class="n">defaults</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">defaults</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">defaults_params</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">defaults_http</span>   <span class="o">=</span> <span class="n">defaults</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">)</span>   <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">defaults_http</span><span class="p">:</span> <span class="n">defaults_http</span><span class="p">[</span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">query</span><span class="sh">"</span>   <span class="ow">not</span> <span class="ow">in</span> <span class="n">defaults_http</span><span class="p">:</span> <span class="n">defaults_http</span><span class="p">[</span><span class="sh">"</span><span class="s">query</span><span class="sh">"</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{}</span>

        <span class="n">profiles_tbl</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_extract_profiles_table</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">profiles_tbl</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">raw_cfg</span> <span class="ow">in</span> <span class="n">profiles_tbl</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw_cfg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">raw_cfg</span><span class="p">)</span>  <span class="c1"># ENV ì¹˜í™˜
</span>            <span class="c1"># í•„ìˆ˜ í•„ë“œ
</span>            <span class="n">req</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">req</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># params/http ë³‘í•© (defaults â†’ profile override)
</span>            <span class="n">p_params</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">p_http</span>   <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">)</span>   <span class="ow">or</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p_http</span><span class="p">:</span> <span class="n">p_http</span><span class="p">[</span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="sh">"</span><span class="s">query</span><span class="sh">"</span>   <span class="ow">not</span> <span class="ow">in</span> <span class="n">p_http</span><span class="p">:</span> <span class="n">p_http</span><span class="p">[</span><span class="sh">"</span><span class="s">query</span><span class="sh">"</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{}</span>

            <span class="n">merged_params</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">defaults_params</span><span class="p">,</span> <span class="o">**</span><span class="n">p_params</span><span class="p">}</span>
            <span class="n">merged_http</span>   <span class="o">=</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">defaults_http</span><span class="p">,</span> <span class="n">p_http</span><span class="p">)</span>

            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]),</span>
                <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">]),</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]),</span>
                <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span>      <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]),</span>
                <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:</span>       <span class="n">merged_params</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">:</span>         <span class="n">merged_http</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># ì ‘ê·¼ í‚¤: ì •ì˜ í‚¤ / display_name / request_name
</span>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)),</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))}:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">[</span><span class="nf">_norm</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">entry</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

        <span class="c1"># refresh_interval_seconds (5~60) + env override
</span>        <span class="n">r</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
        <span class="n">env_r</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_r</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">env_r</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span> <span class="k">pass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="n">r</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="c1"># -------- í¼ë¸”ë¦­ API --------
</span>    <span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">profile key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="c1"># ì¦‰ì‹œ ì¬ì‹œë„(ê°±ì‹  ì§€ì—° ë³´ì •)
</span>            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">profile not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">profiles</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sh">"""</span><span class="s">api_keyëŠ” ìˆ¨ê¸°ê³ , ë‚˜ë¨¸ì§€ ë©”íƒ€/params/httpëŠ” ë…¸ì¶œ.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dn</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>  <span class="c1"># display_name ì¤‘ë³µ í‚¤ ë°©ì§€
</span>                <span class="k">continue</span>
            <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">dn</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="n">dn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:</span>       <span class="n">v</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span>
                <span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">:</span>         <span class="n">v</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">profile</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="k">def</span> <span class="nf">http</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">profile</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_raw</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">dotted</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">config path not found: </span><span class="si">{</span><span class="n">dotted</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cur</span>

    <span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>

<span class="c1"># ===== ëª¨ë“ˆ ì „ì—­ ì‹±ê¸€í†¤ =====
</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
<span class="n">_instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ReadOnlyConfig</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">_default_path</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># configure()ë¡œ ì§€ì • ê°€ëŠ¥
</span>
<span class="k">def</span> <span class="nf">_resolve_default_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_default_path</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_PATH</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_get_instance</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span>
    <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">_instance</span>

<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">refresh_seconds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">ì„ íƒ: ê²½ë¡œ/TTL ì˜¤ë²„ë¼ì´ë“œ(ì´ˆê¸°í™” ì‹œ 1íšŒ ê¶Œì¥).</span><span class="sh">"""</span>
    <span class="k">global</span> <span class="n">_instance</span><span class="p">,</span> <span class="n">_default_path</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">_default_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">refresh_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">refresh_seconds</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
        <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>

<span class="c1"># ---- ì™¸ë¶€ì— ë…¸ì¶œí•  ê°„ë‹¨ API ----
</span><span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">profile</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">profiles</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">profiles</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">params</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">http</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">http</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">snapshot</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">snapshot</span><span class="p">()</span>

<span class="c1"># ---- í•˜ìœ„ í˜¸í™˜ ë³„ì¹­ (endpoint*) ----
</span><span class="k">def</span> <span class="nf">endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nf">profile</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">endpoints</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="k">return</span> <span class="nf">profiles</span><span class="p">()</span>

<span class="c1"># ---- ê°ì²´í˜• ì ‘ê·¼ í”„ë¡ì‹œ(CONFIG) ----
</span><span class="k">class</span> <span class="nc">_ConfigProxy</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">_get_instance</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>

<span class="n">CONFIG</span> <span class="o">=</span> <span class="nf">_ConfigProxy</span><span class="p">()</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">__init__.py</code> (re-export)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">.config_singleton</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CONFIG</span><span class="p">,</span>
    <span class="n">configure</span><span class="p">,</span>
    <span class="n">profile</span><span class="p">,</span> <span class="n">profiles</span><span class="p">,</span>
    <span class="n">params</span><span class="p">,</span> <span class="n">http</span><span class="p">,</span>
    <span class="n">get</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">,</span>
    <span class="c1"># legacy alias
</span>    <span class="n">endpoint</span><span class="p">,</span> <span class="n">endpoints</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<hr />

<h1 id="5-ì™¸ë¶€ì—ì„œ-ì“°ëŠ”-ë²•-ì˜ˆì‹œ">5) ì™¸ë¶€ì—ì„œ ì“°ëŠ” ë²• (ì˜ˆì‹œ)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="n">profile</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">http</span>

<span class="c1"># (1) í•œ ë²ˆì— ì „ë¶€ ë°›ê¸°
</span><span class="n">cfg</span> <span class="o">=</span> <span class="nf">profile</span><span class="p">(</span><span class="sh">"</span><span class="s">Text Model A</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># ë˜ëŠ” "text-model-a" / "gpt-4o-mini"
</span><span class="n">api_key</span>   <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
<span class="n">base_url</span>  <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]</span>
<span class="n">req_name</span>  <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">]</span>
<span class="n">p</span>         <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">]</span>      <span class="c1"># dict (temperature/top_p/...)
</span><span class="n">h</span>         <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">]</span>        <span class="c1"># dict (timeout_seconds/headers/query)
</span>
<span class="c1"># (2) í•„ìš”ë§Œ ë”°ë¡œ
</span><span class="n">p</span> <span class="o">=</span> <span class="nf">params</span><span class="p">(</span><span class="sh">"</span><span class="s">text-model-a</span><span class="sh">"</span><span class="p">)</span>
<span class="n">h</span> <span class="o">=</span> <span class="nf">http</span><span class="p">(</span><span class="sh">"</span><span class="s">text-model-a</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h1 id="6-í¬ì¸íŠ¸-ì •ë¦¬">6) í¬ì¸íŠ¸ ì •ë¦¬</h1>

<ul>
  <li>
    <p>â€œendpointâ€ â†’ <strong>â€œprofileâ€</strong> ë¡œ ëª…í™•í™” (ì„¤ì • ë¬¶ìŒ)</p>
  </li>
  <li>
    <p><strong>model configuration(params)</strong> ì„ í”„ë¡œí•„ ë‚´ë¶€ì— í¬í•¨, <strong>defaults</strong> ë¡œ ê³µí†µê°’ ì§€ì›</p>
  </li>
  <li>
    <p>ì‹±ê¸€í†¤ ê·¸ëŒ€ë¡œ ìœ ì§€ + <strong>ì™¸ë¶€ ì ‘ê·¼ ê°„ë‹¨í™”</strong>(í•¨ìˆ˜/ê°ì²´í˜• ëª¨ë‘)</p>
  </li>
  <li>
    <p>í•˜ìœ„ í˜¸í™˜: <code class="language-plaintext highlighter-rouge">endpoint(s)</code> ë³„ì¹­ ì œê³µ</p>
  </li>
  <li>
    <p>íŒŒì¼ ë³€ê²½ì€ <strong>ìµœëŒ€ 1ë¶„ ë‚´ ë°˜ì˜</strong>(mtime + TTL 5~60s, ê¸°ë³¸ 30s)</p>
  </li>
</ul>

<p>ì›í•˜ë©´, ComfyUI ë…¸ë“œ(ì‹œê°ì )ë„ <code class="language-plaintext highlighter-rouge">params/http</code>ë¥¼ JSONìœ¼ë¡œ ê°™ì´ ë‚´ë³´ë‚´ëŠ” <code class="language-plaintext highlighter-rouge">ConfigProfileLookup</code> ë…¸ë“œ ë²„ì „ë„ ë°”ë¡œ ë§Œë“¤ì–´ ì¤„ê²Œ!</p>

<p class="chat--user">

profileì€ ì¢€ ë„ˆë¬´ ë²”ìš©ì ì¸ë°

</p>

<p>ì¢‹ì•„, â€œprofileâ€ì´ ë„ˆë¬´ ë²”ìš©ì ìœ¼ë¡œ ëŠê»´ì§„ë‹¤ë©´ ë” ëª©ì ì— ë”± ë§ëŠ” <strong>preset(í”„ë¦¬ì…‹)</strong> ìœ¼ë¡œ ìš©ì–´ë¥¼ ì¢íˆìê³  ì œì•ˆí• ê²Œ. â€œí”„ë¦¬ì…‹â€ì€ <em>ëª¨ë¸ ì—°ê²° ì •ë³´ + ìš”ì²­ ì‹ë³„ì + ëª¨ë¸ íŒŒë¼ë¯¸í„° + HTTP ì˜µì…˜</em> ì„ í•œ ì„¸íŠ¸ë¡œ ë‹´ëŠ” ì˜ë¯¸ê°€ ë¶„ëª…í•˜ê³ , UI/ì›Œí¬í”Œë¡œìš°ì—ì„œë„ í”íˆ ì“°ì´ëŠ” í‘œí˜„ì´ë¼ ì§ê´€ì ì´ì•¼.<br />
ì•„ë˜ëŠ” <strong>ìš©ì–´/ìŠ¤í‚¤ë§ˆ/ì½”ë“œ ì „ë¶€ â€˜presetâ€™ìœ¼ë¡œ ì •ë¦¬í•œ ìµœì¢…ë³¸</strong> ì´ì•¼. (ê¸°ì¡´ <code class="language-plaintext highlighter-rouge">profile(s)</code>/<code class="language-plaintext highlighter-rouge">endpoint(s)</code>ëŠ” í•˜ìœ„ í˜¸í™˜ ë³„ì¹­ ìœ ì§€)</p>

<hr />

<h1 id="1-ì´ë¦„--ìŠ¤í‚¤ë§ˆ-ê²°ì •-step-by-step">1) ì´ë¦„ Â· ìŠ¤í‚¤ë§ˆ ê²°ì • (step-by-step)</h1>

<ul>
  <li>
    <p>ì„¹ì…˜ëª…: <strong><code class="language-plaintext highlighter-rouge">[presets."í‚¤"]</code></strong></p>
  </li>
  <li>
    <p>í•„ìˆ˜ í•„ë“œ: <code class="language-plaintext highlighter-rouge">display_name</code>, <code class="language-plaintext highlighter-rouge">request_name</code>, <code class="language-plaintext highlighter-rouge">base_url</code>, <code class="language-plaintext highlighter-rouge">api_key</code></p>
  </li>
  <li>
    <p>ì„ íƒ í•„ë“œ: <code class="language-plaintext highlighter-rouge">params</code>(ëª¨ë¸ íŒŒë¼ë¯¸í„°), <code class="language-plaintext highlighter-rouge">http</code>(timeout/headers/query ë“±)</p>
  </li>
  <li>
    <p>ê³µí†µ ê¸°ë³¸ê°’ ë³‘í•©: <code class="language-plaintext highlighter-rouge">defaults.params</code>, <code class="language-plaintext highlighter-rouge">defaults.http</code>ë¥¼ ê° í”„ë¦¬ì…‹ì— <strong>ë¨¸ì§€</strong></p>
  </li>
</ul>

<p>ì˜ˆì‹œ <code class="language-plaintext highlighter-rouge">config.toml</code></p>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">version</span> <span class="p">=</span> <span class="mi">1</span>

<span class="nn">[settings]</span>
<span class="py">refresh_interval_seconds</span> <span class="p">=</span> <span class="mi">30</span>  <span class="c"># (5~60) 1ë¶„ ë‚´ ë°˜ì˜ ìš”ê±´ ì¶©ì¡±</span>

<span class="c"># ëª¨ë“  í”„ë¦¬ì…‹ ê³µí†µ ê¸°ë³¸ê°’(ì„ íƒ)</span>
<span class="nn">[defaults.params]</span>
<span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.3</span>
<span class="py">max_tokens</span>  <span class="p">=</span> <span class="mi">2048</span>

<span class="nn">[defaults.http]</span>
<span class="py">timeout_seconds</span> <span class="p">=</span> <span class="mi">30</span>
<span class="nn">[defaults.http.headers]</span>
<span class="py">User-Agent</span> <span class="p">=</span> <span class="s">"ComfyUI-ConfigReader/1.0"</span>

<span class="c"># â”€â”€ í”„ë¦¬ì…‹ë“¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nn">[presets."text-model-a"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"Text Model A"</span>
<span class="py">request_name</span>  <span class="p">=</span> <span class="s">"gpt-4o-mini"</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${OPENAI_API_KEY}"</span>

<span class="nn">[presets."text-model-a".params]</span>
<span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.2</span>
<span class="py">top_p</span>       <span class="p">=</span> <span class="mf">0.9</span>

<span class="nn">[presets."text-model-a".http]</span>
<span class="py">timeout_seconds</span> <span class="p">=</span> <span class="mi">20</span>
<span class="nn">[presets."text-model-a".http.headers]</span>
<span class="py">X-Org-Id</span> <span class="p">=</span> <span class="s">"${ORG_ID}"</span>

<span class="nn">[presets."text-model-b"]</span>
<span class="py">display_name</span>  <span class="p">=</span> <span class="s">"Text Model B"</span>
<span class="py">request_name</span>  <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>      <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>       <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>

<span class="c"># â”€â”€ ë‹¤ë¥¸ ì¼ë°˜ ì„¤ì • ì„¹ì…˜ë“¤ë„ ììœ ë¡­ê²Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nn">[feature_flags]</span>
<span class="py">use_cache</span> <span class="p">=</span> <span class="kc">true</span>
</code></pre></div></div>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">${ENV}</code> í‘œê¸°ëŠ” í™˜ê²½ë³€ìˆ˜ë¡œ ì¹˜í™˜ë¼.<br />
 <strong>í•˜ìœ„ í˜¸í™˜</strong> : <code class="language-plaintext highlighter-rouge">[profiles]</code>ë‚˜ <code class="language-plaintext highlighter-rouge">[endpoints]</code>ë¥¼ ì¨ë„ ìë™ ì¸ì‹(ë‚´ë¶€ì—ì„œ <code class="language-plaintext highlighter-rouge">presets</code>ë¡œ ì·¨ê¸‰).</p>
</blockquote>

<hr />

<h1 id="2-ì™¸ë¶€-ì ‘ê·¼-api-ì‹±ê¸€í†¤-í•œ-ì¤„ë¡œ-ë">2) ì™¸ë¶€ ì ‘ê·¼ API (ì‹±ê¸€í†¤, í•œ ì¤„ë¡œ ë)</h1>

<ul>
  <li>
    <p>í•¨ìˆ˜í˜•:<br />
<code class="language-plaintext highlighter-rouge">from comfyui_config_reader import preset, presets, params, http, get</code></p>
  </li>
  <li>
    <p>ê°ì²´í˜•(ì›í•˜ë©´):<br />
<code class="language-plaintext highlighter-rouge">from comfyui_config_reader import CONFIG</code> â†’ <code class="language-plaintext highlighter-rouge">CONFIG.preset("...")</code></p>
  </li>
</ul>

<h3 id="ì‚¬ìš©-ì˜ˆ">ì‚¬ìš© ì˜ˆ</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="n">preset</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">http</span><span class="p">,</span> <span class="n">get</span>

<span class="n">cfg</span> <span class="o">=</span> <span class="nf">preset</span><span class="p">(</span><span class="sh">"</span><span class="s">text-model-a</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># "í‚¤" / "display_name" / "request_name" ì•„ë¬´ê±°ë‚˜ OK
</span><span class="n">api_key</span>   <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
<span class="n">base_url</span>  <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]</span>
<span class="n">req_name</span>  <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">]</span>
<span class="n">p</span>         <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">]</span>   <span class="c1"># ëª¨ë¸ íŒŒë¼ë¯¸í„° dict
</span><span class="n">h</span>         <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">]</span>     <span class="c1"># HTTP ì˜µì…˜ dict
</span>
<span class="n">temperature</span> <span class="o">=</span> <span class="nf">params</span><span class="p">(</span><span class="sh">"</span><span class="s">text-model-a</span><span class="sh">"</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>
<span class="n">timeout</span>     <span class="o">=</span> <span class="nf">http</span><span class="p">(</span><span class="sh">"</span><span class="s">text-model-a</span><span class="sh">"</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">timeout_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>

<span class="n">region</span> <span class="o">=</span> <span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">feature_flags.use_cache</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># ë²”ìš© í‚¤ ì ‘ê·¼
</span></code></pre></div></div>

<hr />

<h1 id="3-ë“œë¡­ì¸-êµì²´-ì½”ë“œ">3) ë“œë¡­ì¸ êµì²´ ì½”ë“œ</h1>

<p>ì•„ë˜ ë‘ íŒŒì¼ë§Œ êµì²´í•˜ë©´ ëì´ì•¼.</p>

<h2 id="custom_nodescomfyui_config_reader__init__py"><code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/__init__.py</code></h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">.config_singleton</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CONFIG</span><span class="p">,</span>
    <span class="n">configure</span><span class="p">,</span>
    <span class="n">preset</span><span class="p">,</span> <span class="n">presets</span><span class="p">,</span>
    <span class="n">params</span><span class="p">,</span> <span class="n">http</span><span class="p">,</span>
    <span class="n">get</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">,</span>
    <span class="c1"># legacy alias (í•˜ìœ„ í˜¸í™˜)
</span>    <span class="n">profile</span> <span class="k">as</span> <span class="n">profile</span><span class="p">,</span> <span class="n">profiles</span> <span class="k">as</span> <span class="n">profiles</span><span class="p">,</span>
    <span class="n">endpoint</span> <span class="k">as</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">endpoints</span> <span class="k">as</span> <span class="n">endpoints</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<h2 id="custom_nodescomfyui_config_readerconfig_singletonpy"><code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/config_singleton.py</code></h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># py3.11+
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>     <span class="c1"># py3.10-
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="k">def</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="sh">""</span><span class="p">);</span> <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>  <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">v</span>

<span class="k">def</span> <span class="nf">_norm</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">b</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">b</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - ì½ê¸° ì „ìš© TOML (íŒŒì¼ ì“°ê¸° ì—†ìŒ)
    - mtime + TTL(5~60s, ê¸°ë³¸ 30s) ìë™ ì¬ë¡œë“œ â†’ 1ë¶„ ë‚´ ë³€ê²½ ë°˜ì˜
    - í‘œì¤€: [presets]; ë ˆê±°ì‹œ: [profiles], [endpoints] ìë™ ì¸ì‹
    - preset í•„ìˆ˜ í•„ë“œ: display_name, request_name, base_url, api_key
      + params(dict), http(dict: timeout_seconds, headers{}, query{})
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># --- ë‚´ë¶€ ë¡œë”© ---
</span>    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_extract_presets_table</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">presets</span><span class="sh">"</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>   <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">presets</span><span class="sh">"</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">profiles</span><span class="sh">"</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>  <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">profiles</span><span class="sh">"</span><span class="p">]</span>   <span class="c1"># legacy
</span>        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">endpoints</span><span class="sh">"</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">endpoints</span><span class="sh">"</span><span class="p">]</span>  <span class="c1"># legacy
</span>        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="c1"># defaults
</span>        <span class="n">defaults</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">defaults</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">d_params</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">d_http</span>   <span class="o">=</span> <span class="n">defaults</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">)</span>   <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d_http</span><span class="p">:</span> <span class="n">d_http</span><span class="p">[</span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">query</span><span class="sh">"</span>   <span class="ow">not</span> <span class="ow">in</span> <span class="n">d_http</span><span class="p">:</span> <span class="n">d_http</span><span class="p">[</span><span class="sh">"</span><span class="s">query</span><span class="sh">"</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{}</span>

        <span class="n">tbl</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_extract_presets_table</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">return</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
            <span class="n">req</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">req</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">p_params</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">p_http</span>   <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">)</span>   <span class="ow">or</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p_http</span><span class="p">:</span> <span class="n">p_http</span><span class="p">[</span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="sh">"</span><span class="s">query</span><span class="sh">"</span>   <span class="ow">not</span> <span class="ow">in</span> <span class="n">p_http</span><span class="p">:</span> <span class="n">p_http</span><span class="p">[</span><span class="sh">"</span><span class="s">query</span><span class="sh">"</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{}</span>

            <span class="n">merged_params</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">d_params</span><span class="p">,</span> <span class="o">**</span><span class="n">p_params</span><span class="p">}</span>
            <span class="n">merged_http</span>   <span class="o">=</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">d_http</span><span class="p">,</span> <span class="n">p_http</span><span class="p">)</span>

            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]),</span>
                <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">]),</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]),</span>
                <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span>      <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]),</span>
                <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:</span>       <span class="n">merged_params</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">:</span>         <span class="n">merged_http</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">)),</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">""</span><span class="p">))}:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">[</span><span class="nf">_norm</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">entry</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
        <span class="n">env_r</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_r</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">env_r</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span> <span class="k">pass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="n">r</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="c1"># --- í¼ë¸”ë¦­ API ---
</span>    <span class="k">def</span> <span class="nf">preset</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">preset key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">preset not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">presets</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dn</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">dn</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="n">dn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:</span>       <span class="n">v</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span>
                <span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">:</span>         <span class="n">v</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">preset</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="k">def</span> <span class="nf">http</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">preset</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_raw</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">dotted</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">config path not found: </span><span class="si">{</span><span class="n">dotted</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cur</span>

    <span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>

<span class="c1"># ----- ì‹±ê¸€í†¤ -----
</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
<span class="n">_instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ReadOnlyConfig</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">_default_path</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">_resolve_default_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_default_path</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_PATH</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_get_instance</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span>
    <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">_instance</span>

<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">refresh_seconds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span><span class="p">,</span> <span class="n">_default_path</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">_default_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">refresh_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">refresh_seconds</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
        <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>

<span class="c1"># ---- ì™¸ë¶€ API ----
</span><span class="k">def</span> <span class="nf">preset</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>     <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">preset</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">presets</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span> <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">presets</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>     <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">params</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">http</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>       <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">http</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>                <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">snapshot</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>           <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">snapshot</span><span class="p">()</span>

<span class="c1"># ---- í•˜ìœ„ í˜¸í™˜ ë³„ì¹­ ----
</span><span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>    <span class="k">return</span> <span class="nf">preset</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">profiles</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span><span class="k">return</span> <span class="nf">presets</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>   <span class="k">return</span> <span class="nf">preset</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">endpoints</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span> <span class="k">return</span> <span class="nf">presets</span><span class="p">()</span>

<span class="c1"># ---- ê°ì²´í˜• í”„ë¡ì‹œ ----
</span><span class="k">class</span> <span class="nc">_ConfigProxy</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">_get_instance</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>
<span class="n">CONFIG</span> <span class="o">=</span> <span class="nf">_ConfigProxy</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="4-ì›í•˜ë©´-comfyui-ë…¸ë“œë„-ìš©ì–´-ë§ì¶°-ë³€ê²½">4) (ì›í•˜ë©´) ComfyUI ë…¸ë“œë„ ìš©ì–´ ë§ì¶° ë³€ê²½</h1>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">ConfigPresetLookup</code> : <code class="language-plaintext highlighter-rouge">display_name</code>, <code class="language-plaintext highlighter-rouge">request_name</code>, <code class="language-plaintext highlighter-rouge">base_url</code>, <code class="language-plaintext highlighter-rouge">api_key</code>, <code class="language-plaintext highlighter-rouge">params(json)</code>, <code class="language-plaintext highlighter-rouge">http(json)</code> ì¶œë ¥</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">ConfigListPresets</code> : ëª¨ë“  í”„ë¦¬ì…‹ JSON</p>
  </li>
</ul>

<p>ì›í•˜ì‹œë©´ ë°”ë¡œ ìƒì„±í•´ ì¤„ê²Œ.</p>

<hr />

<h1 id="5-ë§ˆì´ê·¸ë ˆì´ì…˜-ì •ë¦¬">5) ë§ˆì´ê·¸ë ˆì´ì…˜ ì •ë¦¬</h1>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">profile(s)</code> / <code class="language-plaintext highlighter-rouge">endpoint(s)</code> í˜¸ì¶œ ì½”ë“œëŠ” ê·¸ëŒ€ë¡œ ë™ì‘(ë³„ì¹­ ì œê³µ).</p>
  </li>
  <li>
    <p>ì„¤ì • íŒŒì¼ì—ì„œ <code class="language-plaintext highlighter-rouge">[profiles]</code>/<code class="language-plaintext highlighter-rouge">[endpoints]</code> ìœ ì§€í•´ë„ ì¸ì‹í•˜ì§€ë§Œ, ì•ìœ¼ë¡œëŠ” <strong><code class="language-plaintext highlighter-rouge">[presets]</code> ê¶Œì¥</strong>.</p>
  </li>
  <li>
    <p>ëª¨ë¸ íŒŒë¼ë¯¸í„°/HTTP ì˜µì…˜ì€ í”„ë¦¬ì…‹ ë‚´ë¶€(<code class="language-plaintext highlighter-rouge">params</code>/<code class="language-plaintext highlighter-rouge">http</code>)ì— ë„£ìœ¼ë©´ ë˜ê³ , ê³µí†µê°’ì€ <code class="language-plaintext highlighter-rouge">defaults</code>ì— ë‘ë©´ ìë™ ë³‘í•©ë¼.</p>
  </li>
</ul>

<hr />

<p>í•„ìš”í•˜ë©´ â€œpresetâ€ ëŒ€ì‹  <strong><code class="language-plaintext highlighter-rouge">deployment</code></strong> , <strong><code class="language-plaintext highlighter-rouge">model_preset</code></strong> ê°™ì€ ë” êµ¬ì²´ì ì¸ ëŒ€ì•ˆë„ ì¤„ ìˆ˜ ìˆì–´. í•˜ì§€ë§Œ <em>ëª¨ë¸ í˜¸ì¶œìš© ì„¸íŒ… ë¬¶ìŒ</em> ì´ë¼ëŠ” ê´€ì ì—ì„œ ì‚¬ìš©ì/ì˜¤í¼ë ˆì´í„° ëª¨ë‘ì—ê²Œ ê°€ì¥ ìµìˆ™í•˜ê³  ì§§ì€ ìš©ì–´ëŠ” â€œpresetâ€ì´ë¼ ì´ê±¸ ê¸°ë³¸ ê¶Œì¥ìœ¼ë¡œ ë’€ì–´.</p>

<p class="chat--user">

ì•„ë‹ˆ llm endpoint ë¼ëŠ” ëŠë‚Œì´ ì „í˜€ ì•ˆë“¤ì–´ì„œ

</p>

<p>ì˜¤ì¼€ì´â€”â€œLLM ì—”ë“œí¬ì¸íŠ¸â€ ëŠë‚Œì„ í™•ì‹¤íˆ ì£¼ë„ë¡ <strong>ìš©ì–´ë¥¼ <code class="language-plaintext highlighter-rouge">llm_endpoints</code></strong>ë¡œ í‘œì¤€í™”í–ˆì–´ìš”.<br />
(ì´ì „ <code class="language-plaintext highlighter-rouge">presets</code>/<code class="language-plaintext highlighter-rouge">profiles</code>/<code class="language-plaintext highlighter-rouge">endpoints</code>ëŠ” <strong>ìë™ í•˜ìœ„ í˜¸í™˜</strong> ìœ¼ë¡œ ê³„ì† ì½ìŠµë‹ˆë‹¤.)</p>

<p>ì•„ë˜ ë‘ íŒŒì¼ë§Œ êµì²´í•˜ë©´ ë! ì™¸ë¶€ì—ì„œëŠ” <code class="language-plaintext highlighter-rouge">llm_endpoint(...)</code>, <code class="language-plaintext highlighter-rouge">llm_params(...)</code> ê°™ì€ ì´ë¦„ìœ¼ë¡œ ë°”ë¡œ ì”ë‹ˆë‹¤.</p>

<hr />

<h1 id="1-ìŠ¤í‚¤ë§ˆ-configtoml">1) ìŠ¤í‚¤ë§ˆ (config.toml)</h1>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">version</span> <span class="p">=</span> <span class="mi">1</span>

<span class="nn">[settings]</span>
<span class="c"># íŒŒì¼ ë³€ê²½ ê°ì§€ ì£¼ê¸°(ì´ˆ) â€” 5~60 ê¶Œì¥. "1ë¶„ ì´ë‚´ ë°˜ì˜" ìš”ê±´ ì¶©ì¡±.</span>
<span class="py">refresh_interval_seconds</span> <span class="p">=</span> <span class="mi">30</span>

<span class="c"># ê³µí†µ ê¸°ë³¸ê°’(ì„ íƒ): ëª¨ë“  LLM ì—”ë“œí¬ì¸íŠ¸ì— ë³‘í•©ë¨</span>
<span class="nn">[defaults.params]</span>
<span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.3</span>
<span class="py">max_tokens</span>  <span class="p">=</span> <span class="mi">2048</span>

<span class="nn">[defaults.http]</span>
<span class="py">timeout_seconds</span> <span class="p">=</span> <span class="mi">30</span>
<span class="nn">[defaults.http.headers]</span>
<span class="py">User-Agent</span> <span class="p">=</span> <span class="s">"ComfyUI-ConfigReader/1.0"</span>

<span class="c"># â”€â”€ LLM ì—”ë“œí¬ì¸íŠ¸ë“¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nn">[llm_endpoints."gpt-4o-mini-a"]</span>
<span class="py">display_name</span> <span class="p">=</span> <span class="s">"OpenAI GPT-4o mini A"</span>
<span class="py">model</span>        <span class="p">=</span> <span class="s">"gpt-4o-mini"</span>             <span class="c"># (= request_name ë³„ì¹­)</span>
<span class="py">base_url</span>     <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key</span>      <span class="p">=</span> <span class="s">"${OPENAI_API_KEY}"</span>

<span class="nn">[llm_endpoints."gpt-4o-mini-a".params]</span>
<span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.2</span>
<span class="py">top_p</span>       <span class="p">=</span> <span class="mf">0.9</span>

<span class="nn">[llm_endpoints."gpt-4o-mini-a".http]</span>
<span class="py">timeout_seconds</span> <span class="p">=</span> <span class="mi">20</span>
<span class="nn">[llm_endpoints."gpt-4o-mini-a".http.headers]</span>
<span class="py">X-Org-Id</span> <span class="p">=</span> <span class="s">"${ORG_ID}"</span>

<span class="nn">[llm_endpoints."claude-sonnet"]</span>
<span class="py">display_name</span> <span class="p">=</span> <span class="s">"Anthropic Claude 3.5 Sonnet"</span>
<span class="py">model</span>        <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>     <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>      <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>

<span class="c"># â”€â”€ ë‹¤ë¥¸ ì¼ë°˜ ì„¤ì •ë„ ììœ ë¡­ê²Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nn">[feature_flags]</span>
<span class="py">use_cache</span> <span class="p">=</span> <span class="kc">true</span>
</code></pre></div></div>

<ul>
  <li>
    <p>í•„ìˆ˜: <code class="language-plaintext highlighter-rouge">display_name</code>, <code class="language-plaintext highlighter-rouge">model(=request_name)</code>, <code class="language-plaintext highlighter-rouge">base_url</code>, <code class="language-plaintext highlighter-rouge">api_key</code></p>
  </li>
  <li>
    <p>ì„ íƒ: <code class="language-plaintext highlighter-rouge">params</code>(ëª¨ë¸ íŒŒë¼ë¯¸í„°), <code class="language-plaintext highlighter-rouge">http</code>(timeout/headers/query ë“±)</p>
  </li>
  <li>
    <p><strong>ë³‘í•© ê·œì¹™</strong> : <code class="language-plaintext highlighter-rouge">defaults.params</code>/<code class="language-plaintext highlighter-rouge">defaults.http</code> â†’ ê° ì—”ë“œí¬ì¸íŠ¸ì˜ <code class="language-plaintext highlighter-rouge">params</code>/<code class="language-plaintext highlighter-rouge">http</code>ì— <strong>ë®ì–´ì“°ê¸° ë³‘í•©</strong></p>
  </li>
</ul>

<blockquote>
  <p>í•˜ìœ„ í˜¸í™˜: <code class="language-plaintext highlighter-rouge">[presets]</code>, <code class="language-plaintext highlighter-rouge">[profiles]</code>, <code class="language-plaintext highlighter-rouge">[endpoints]</code>ë„ ìë™ ì¸ì‹í•©ë‹ˆë‹¤.<br />
 í•„ë“œë„ <code class="language-plaintext highlighter-rouge">request_name</code>/<code class="language-plaintext highlighter-rouge">request_model</code>/<code class="language-plaintext highlighter-rouge">model</code> ì¤‘ ì•„ë¬´ê±°ë‚˜ ì¨ë„ OK(ë‚´ë¶€ì—ì„œ <code class="language-plaintext highlighter-rouge">model</code>ë¡œ í†µì¼).</p>
</blockquote>

<hr />

<h1 id="2-ì™¸ë¶€-ì ‘ê·¼-api-ì‹±ê¸€í†¤-ì§ê´€ì ">2) ì™¸ë¶€ ì ‘ê·¼ API (ì‹±ê¸€í†¤, ì§ê´€ì )</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">llm_endpoint</span><span class="p">,</span> <span class="n">llm_endpoints</span><span class="p">,</span>   <span class="c1"># ë©”íƒ€ + ì—°ê²° ì •ë³´
</span>    <span class="n">llm_params</span><span class="p">,</span> <span class="n">llm_http</span><span class="p">,</span>          <span class="c1"># ëª¨ë¸ íŒŒë¼ë¯¸í„° / HTTP ì˜µì…˜ë§Œ
</span>    <span class="n">get</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span>                   <span class="c1"># ë²”ìš© í‚¤ ì ‘ê·¼ / ê°ì²´í˜• ì ‘ê·¼
</span><span class="p">)</span>
</code></pre></div></div>

<p>ì‚¬ìš© ì˜ˆ:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cfg</span> <span class="o">=</span> <span class="nf">llm_endpoint</span><span class="p">(</span><span class="sh">"</span><span class="s">gpt-4o-mini-a</span><span class="sh">"</span><span class="p">)</span>     <span class="c1"># í‚¤ / display_name / model ì•„ë¬´ê±°ë‚˜
</span><span class="n">api_key</span>  <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
<span class="n">base_url</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]</span>
<span class="n">model</span>    <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">]</span>
<span class="n">params</span>   <span class="o">=</span> <span class="nf">llm_params</span><span class="p">(</span><span class="sh">"</span><span class="s">gpt-4o-mini-a</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># {"temperature": 0.2, "top_p": 0.9, ...}
</span><span class="n">http</span>     <span class="o">=</span> <span class="nf">llm_http</span><span class="p">(</span><span class="sh">"</span><span class="s">gpt-4o-mini-a</span><span class="sh">"</span><span class="p">)</span>    <span class="c1"># {"timeout_seconds": ..., "headers": {...}, ...}
</span>
<span class="c1"># ë²”ìš© ì„¤ì •
</span><span class="n">use_cache</span> <span class="o">=</span> <span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">feature_flags.use_cache</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h1 id="3-ë“œë¡­ì¸-êµì²´-ì½”ë“œ-1">3) ë“œë¡­ì¸ êµì²´ ì½”ë“œ</h1>

<h2 id="custom_nodescomfyui_config_reader__init__py-1"><code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/__init__.py</code></h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">.config_singleton</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CONFIG</span><span class="p">,</span>
    <span class="n">configure</span><span class="p">,</span>
    <span class="n">llm_endpoint</span><span class="p">,</span> <span class="n">llm_endpoints</span><span class="p">,</span>
    <span class="n">llm_params</span><span class="p">,</span> <span class="n">llm_http</span><span class="p">,</span>
    <span class="n">get</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">,</span>
    <span class="c1"># legacy alias (í•˜ìœ„ í˜¸í™˜)
</span>    <span class="n">preset</span> <span class="k">as</span> <span class="n">preset</span><span class="p">,</span> <span class="n">presets</span> <span class="k">as</span> <span class="n">presets</span><span class="p">,</span>
    <span class="n">profile</span> <span class="k">as</span> <span class="n">profile</span><span class="p">,</span> <span class="n">profiles</span> <span class="k">as</span> <span class="n">profiles</span><span class="p">,</span>
    <span class="n">endpoint</span> <span class="k">as</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">endpoints</span> <span class="k">as</span> <span class="n">endpoints</span><span class="p">,</span>
    <span class="n">params</span> <span class="k">as</span> <span class="n">params</span><span class="p">,</span> <span class="n">http</span> <span class="k">as</span> <span class="n">http</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<h2 id="custom_nodescomfyui_config_readerconfig_singletonpy-1"><code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/config_singleton.py</code></h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># py3.11+
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>     <span class="c1"># py3.10-
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="k">def</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="sh">""</span><span class="p">);</span> <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>  <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">v</span>

<span class="k">def</span> <span class="nf">_norm</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">b</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">b</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="c1"># --- í•„ë“œ ë³„ì¹­ ì •ê·œí™” (model / request_name / request_model) ---
</span><span class="k">def</span> <span class="nf">_normalize_model_field</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">and</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="sh">""</span>

<span class="k">class</span> <span class="nc">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - ì½ê¸° ì „ìš© TOML
    - mtime + TTL(5~60s, ê¸°ë³¸ 30s) ìë™ ì¬ë¡œë“œ â†’ 1ë¶„ ë‚´ ë³€ê²½ ë°˜ì˜
    - í‘œì¤€ ì„¹ì…˜: [llm_endpoints]
      (í•˜ìœ„ í˜¸í™˜: [presets], [profiles], [endpoints] ë„ ìë™ ì¸ì‹)
    - ê° ì—”ë“œí¬ì¸íŠ¸:
        * display_name, model(=request_name/â€¦ ë³„ì¹­), base_url, api_key
        * params(dict), http(dict: timeout_seconds, headers{}, query{})
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># --- ë‚´ë¶€ ë¡œë”© ---
</span>    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_extract_llm_table</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># 1ìˆœìœ„ í‘œì¤€
</span>        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">llm_endpoints</span><span class="sh">"</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">llm_endpoints</span><span class="sh">"</span><span class="p">]</span>
        <span class="c1"># í•˜ìœ„ í˜¸í™˜
</span>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">presets</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">profiles</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">endpoints</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

        <span class="c1"># defaults
</span>        <span class="n">defaults</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">defaults</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">d_params</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">d_http</span>   <span class="o">=</span> <span class="n">defaults</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">)</span>   <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d_http</span><span class="p">:</span> <span class="n">d_http</span><span class="p">[</span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">query</span><span class="sh">"</span>   <span class="ow">not</span> <span class="ow">in</span> <span class="n">d_http</span><span class="p">:</span> <span class="n">d_http</span><span class="p">[</span><span class="sh">"</span><span class="s">query</span><span class="sh">"</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{}</span>

        <span class="n">tbl</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_extract_llm_table</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">return</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>

            <span class="n">display</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="n">model</span>   <span class="o">=</span> <span class="nf">_normalize_model_field</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
            <span class="n">base</span>    <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="n">api</span>     <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">display</span> <span class="ow">and</span> <span class="n">model</span> <span class="ow">and</span> <span class="n">base</span> <span class="ow">and</span> <span class="n">api</span><span class="p">):</span>
                <span class="k">continue</span>  <span class="c1"># í•„ìˆ˜ ëˆ„ë½ì€ ìŠ¤í‚µ
</span>
            <span class="n">p_params</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">p_http</span>   <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">)</span>   <span class="ow">or</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p_http</span><span class="p">:</span> <span class="n">p_http</span><span class="p">[</span><span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="sh">"</span><span class="s">query</span><span class="sh">"</span>   <span class="ow">not</span> <span class="ow">in</span> <span class="n">p_http</span><span class="p">:</span> <span class="n">p_http</span><span class="p">[</span><span class="sh">"</span><span class="s">query</span><span class="sh">"</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{}</span>

            <span class="n">merged_params</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">d_params</span><span class="p">,</span> <span class="o">**</span><span class="n">p_params</span><span class="p">}</span>
            <span class="n">merged_http</span>   <span class="o">=</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">d_http</span><span class="p">,</span> <span class="n">p_http</span><span class="p">)</span>

            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">display</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span>        <span class="n">model</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="n">base</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span>      <span class="n">api</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:</span>       <span class="n">merged_params</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">:</span>         <span class="n">merged_http</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="c1"># ì ‘ê·¼ í‚¤: ì •ì˜ í‚¤ / display_name / model
</span>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">display</span><span class="p">,</span> <span class="n">model</span><span class="p">}:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">[</span><span class="nf">_norm</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">entry</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
        <span class="n">env_r</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_r</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">env_r</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span> <span class="k">pass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="n">r</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="c1"># --- í¼ë¸”ë¦­ API ---
</span>    <span class="k">def</span> <span class="nf">llm_endpoint</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">llm_endpoint key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">llm_endpoint not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">llm_endpoints</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dn</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">dn</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="n">dn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span>        <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">:</span>       <span class="n">v</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span>
                <span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">:</span>         <span class="n">v</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">llm_params</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">llm_endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="k">def</span> <span class="nf">llm_http</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">llm_endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">http</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_raw</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">dotted</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">config path not found: </span><span class="si">{</span><span class="n">dotted</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cur</span>

    <span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>

<span class="c1"># ----- ì‹±ê¸€í†¤ -----
</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
<span class="n">_instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ReadOnlyConfig</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">_default_path</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">_resolve_default_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_default_path</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_PATH</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_get_instance</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span>
    <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">_instance</span>

<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">refresh_seconds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span><span class="p">,</span> <span class="n">_default_path</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">_default_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">refresh_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">refresh_seconds</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
        <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>

<span class="c1"># ---- ì™¸ë¶€ API ----
</span><span class="k">def</span> <span class="nf">llm_endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>     <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">llm_endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">llm_endpoints</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span> <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">llm_endpoints</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">llm_params</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>       <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">llm_params</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">llm_http</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>         <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">llm_http</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>                      <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">snapshot</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>                 <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">snapshot</span><span class="p">()</span>

<span class="c1"># ---- í•˜ìœ„ í˜¸í™˜ ë³„ì¹­ (í•„ìš” ì‹œ ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ ë™ì‘) ----
</span><span class="k">def</span> <span class="nf">preset</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span>   <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>         <span class="k">return</span> <span class="nf">llm_endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">presets</span><span class="p">()</span>          <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span> <span class="k">return</span> <span class="nf">llm_endpoints</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span>  <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>         <span class="k">return</span> <span class="nf">llm_endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">profiles</span><span class="p">()</span>         <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span> <span class="k">return</span> <span class="nf">llm_endpoints</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>         <span class="k">return</span> <span class="nf">llm_endpoint</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">endpoints</span><span class="p">()</span>        <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span> <span class="k">return</span> <span class="nf">llm_endpoints</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span>   <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>         <span class="k">return</span> <span class="nf">llm_params</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">http</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span>     <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>         <span class="k">return</span> <span class="nf">llm_http</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="c1"># ---- ê°ì²´í˜• í”„ë¡ì‹œ ----
</span><span class="k">class</span> <span class="nc">_ConfigProxy</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">_get_instance</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>
<span class="n">CONFIG</span> <span class="o">=</span> <span class="nf">_ConfigProxy</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="4-ì™œ-ì´ê²Œ-ì¢‹ì€ê°€-ì§§ê²Œ">4) ì™œ ì´ê²Œ ì¢‹ì€ê°€ (ì§§ê²Œ)</h1>

<ul>
  <li>
    <p>ì´ë¦„ë¶€í„° <strong>LLM ì—”ë“œí¬ì¸íŠ¸</strong> ì„ì´ ë¶„ëª… (<code class="language-plaintext highlighter-rouge">llm_endpoints</code>)</p>
  </li>
  <li>
    <p>ëª¨ë¸ íŒŒë¼ë¯¸í„°/HTTP ì˜µì…˜ì„ <strong>ê°™ì€ ë¬¶ìŒ</strong> ì—ì„œ ê´€ë¦¬ (<code class="language-plaintext highlighter-rouge">params</code>, <code class="language-plaintext highlighter-rouge">http</code>)</p>
  </li>
  <li>
    <p>ê¸°ì¡´ ì„¤ì •/ì½”ë“œ <strong>ì•ˆ ê¹¨ì§</strong>(ìë™ í˜¸í™˜)</p>
  </li>
  <li>
    <p>ì½ê¸° ì „ìš© + mtime/TTL(5~60s)ë¡œ <strong>ìµœëŒ€ 1ë¶„ ë‚´ ë³€ê²½ ë°˜ì˜</strong></p>
  </li>
  <li>
    <p>ì™¸ë¶€ ì‚¬ìš©ì€ <strong>í•œ ì¤„ ì„í¬íŠ¸</strong> ë¡œ ë: <code class="language-plaintext highlighter-rouge">llm_endpoint("...")</code></p>
  </li>
</ul>

<p>ì›í•˜ë©´ ComfyUI ë…¸ë“œ ì´ë¦„ë„ <code class="language-plaintext highlighter-rouge">Config: LLM Endpoint Lookup</code>, <code class="language-plaintext highlighter-rouge">Config: List LLM Endpoints</code>ë¡œ ë§ì¶°ì„œ ì¶œë ¥(íŒŒë¼ë¯¸í„°/HTTP JSON í¬í•¨) ë²„ì „ê¹Œì§€ ë°”ë¡œ ë§Œë“¤ì–´ì¤„ê²Œ!</p>

<p class="chat--user">

api_providers display_name, model_id, base_url, api_key ì´ê±¸ë¡œ í•´ì¤˜.

</p>

<p>ì¢‹ì•„! <strong>ì´ë¦„ì€<code class="language-plaintext highlighter-rouge">api_providers</code></strong>, í•„ë“œëŠ” <strong><code class="language-plaintext highlighter-rouge">display_name</code>, <code class="language-plaintext highlighter-rouge">model_id</code>, <code class="language-plaintext highlighter-rouge">base_url</code>, <code class="language-plaintext highlighter-rouge">api_key</code></strong>ë¡œ ë”± ë§ì¶°ì„œ ì •ë¦¬í–ˆì–´.<br />
(ì½ê¸° ì „ìš© Â· ìµœëŒ€ 1ë¶„ ë‚´ ë³€ê²½ ë°˜ì˜ Â· ë‹¤ë¥¸ ë…¸ë“œ/íŒŒì¼ì—ì„œ í•œ ì¤„ë¡œ ì ‘ê·¼)</p>

<p>ì•„ë˜ ì½”ë“œ/ì˜ˆì‹œ ê·¸ëŒ€ë¡œ êµì²´í•˜ë©´ ë™ì‘í•´.</p>

<hr />

<h1 id="1-configtoml-ìŠ¤í‚¤ë§ˆ">1) <code class="language-plaintext highlighter-rouge">config.toml</code> ìŠ¤í‚¤ë§ˆ</h1>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">version</span> <span class="p">=</span> <span class="mi">1</span>

<span class="nn">[settings]</span>
<span class="c"># íŒŒì¼ ë³€ê²½ ê°ì§€ ì£¼ê¸°(ì´ˆ) â€” 5~60 ê¶Œì¥. "1ë¶„ ì´ë‚´ ë°˜ì˜" ìš”ê±´ ì¶©ì¡±.</span>
<span class="py">refresh_interval_seconds</span> <span class="p">=</span> <span class="mi">30</span>

<span class="c"># â”€â”€ API Providers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nn">[api_providers."openai-mini"]</span>
<span class="py">display_name</span> <span class="p">=</span> <span class="s">"OpenAI GPT-4o mini"</span>
<span class="py">model_id</span>     <span class="p">=</span> <span class="s">"gpt-4o-mini"</span>
<span class="py">base_url</span>     <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key</span>      <span class="p">=</span> <span class="s">"${OPENAI_API_KEY}"</span>

<span class="nn">[api_providers."anthropic-sonnet"]</span>
<span class="py">display_name</span> <span class="p">=</span> <span class="s">"Anthropic Claude 3.5 Sonnet"</span>
<span class="py">model_id</span>     <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>     <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>      <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>

<span class="c"># â”€â”€ ë‹¤ë¥¸ ë²”ìš© ì„¤ì •ë„ ììœ ë¡­ê²Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nn">[feature_flags]</span>
<span class="py">use_cache</span> <span class="p">=</span> <span class="kc">true</span>
</code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">${ENV}</code> í‘œê¸°ëŠ” í™˜ê²½ë³€ìˆ˜ë¡œ ì¹˜í™˜.</p>
  </li>
  <li>
    <p>ì¡°íšŒ í‚¤ëŠ” <strong>ì •ì˜ í‚¤ /<code class="language-plaintext highlighter-rouge">display_name</code> / <code class="language-plaintext highlighter-rouge">model_id</code></strong> ì¤‘ ì•„ë¬´ê±°ë‚˜ ì‚¬ìš© ê°€ëŠ¥.</p>
  </li>
</ul>

<hr />

<h1 id="2-ì™¸ë¶€ì—ì„œ-ì“°ëŠ”-ë²•-ì‹±ê¸€í†¤-í•œ-ì¤„">2) ì™¸ë¶€ì—ì„œ ì“°ëŠ” ë²• (ì‹±ê¸€í†¤, í•œ ì¤„)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="n">api_provider</span><span class="p">,</span> <span class="n">api_providers</span><span class="p">,</span> <span class="n">get</span>

<span class="n">cfg</span> <span class="o">=</span> <span class="nf">api_provider</span><span class="p">(</span><span class="sh">"</span><span class="s">openai-mini</span><span class="sh">"</span><span class="p">)</span>   <span class="c1"># ë˜ëŠ” "OpenAI GPT-4o mini" / "gpt-4o-mini"
</span><span class="n">api_key</span>  <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">]</span>
<span class="n">base_url</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">]</span>
<span class="n">model_id</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">]</span>

<span class="n">listing</span> <span class="o">=</span> <span class="nf">api_providers</span><span class="p">()</span>           <span class="c1"># {display_name: {display_name, model_id, base_url}}
</span><span class="n">use_cache</span> <span class="o">=</span> <span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">feature_flags.use_cache</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>ì„ íƒ(ì´ˆê¸°í™” ì‹œ í•œ ë²ˆ):</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="n">configure</span>
<span class="nf">configure</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="sh">"</span><span class="s">/abs/path/to/config.toml</span><span class="sh">"</span><span class="p">,</span> <span class="n">refresh_seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>  <span class="c1"># 5~60
</span></code></pre></div></div>

<hr />

<h1 id="3-ë“œë¡­ì¸-ì½”ë“œ">3) ë“œë¡­ì¸ ì½”ë“œ</h1>

<h2 id="custom_nodescomfyui_config_reader__init__py-2"><code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/__init__.py</code></h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">.config_singleton</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CONFIG</span><span class="p">,</span>
    <span class="n">configure</span><span class="p">,</span>
    <span class="n">api_provider</span><span class="p">,</span> <span class="n">api_providers</span><span class="p">,</span>
    <span class="n">get</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<h2 id="custom_nodescomfyui_config_readerconfig_singletonpy-2"><code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/config_singleton.py</code></h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># py3.11+
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>     <span class="c1"># py3.10-
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="k">def</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="sh">""</span><span class="p">);</span> <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>  <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">v</span>

<span class="k">def</span> <span class="nf">_norm</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="c1"># ë ˆê±°ì‹œ í•„ë“œ í˜¸í™˜: model_id ëŒ€ì‹  model/request_name/request_model ì´ ë“¤ì–´ì™€ë„ ì¸ì‹
</span><span class="k">def</span> <span class="nf">_normalize_model_id</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">and</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="sh">""</span>

<span class="k">class</span> <span class="nc">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - ì½ê¸° ì „ìš© TOML ë¡œë” (íŒŒì¼ ì“°ê¸° ì—†ìŒ)
    - mtime + TTL(5~60s, ê¸°ë³¸ 30s) ìë™ ì¬ë¡œë“œ â†’ 1ë¶„ ë‚´ ë³€ê²½ ë°˜ì˜
    - í‘œì¤€ ì„¹ì…˜: [api_providers]
      (ì°¸ê³ : ì›í•˜ë©´ í•˜ìœ„ í˜¸í™˜ ì„¹ì…˜ì„ ì¶”ê°€ë¡œ ì¸ì‹í•˜ë„ë¡ í™•ì¥ ê°€ëŠ¥)
    - ê° provider í•„ìˆ˜ í•„ë“œ: display_name, model_id, base_url, api_key
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># --- ë‚´ë¶€ ë¡œë”© ---
</span>    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_providers_table</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_providers</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tbl</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_providers_table</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">return</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>

            <span class="n">display</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="n">model</span>   <span class="o">=</span> <span class="nf">_normalize_model_id</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
            <span class="n">base</span>    <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="n">api</span>     <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">display</span> <span class="ow">and</span> <span class="n">model</span> <span class="ow">and</span> <span class="n">base</span> <span class="ow">and</span> <span class="n">api</span><span class="p">):</span>
                <span class="k">continue</span>  <span class="c1"># í•„ìˆ˜ ëˆ„ë½ì€ ìŠ¤í‚µ
</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">display</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">:</span>     <span class="n">model</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="n">base</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span>      <span class="n">api</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># ì ‘ê·¼ í‚¤: ì •ì˜ í‚¤ / display_name / model_id
</span>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">display</span><span class="p">,</span> <span class="n">model</span><span class="p">}:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">[</span><span class="nf">_norm</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">entry</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
        <span class="n">env_r</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_r</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">env_r</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span> <span class="k">pass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="n">r</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="c1"># --- í¼ë¸”ë¦­ API ---
</span>    <span class="k">def</span> <span class="nf">api_provider</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">api_provider key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">api_provider not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">api_providers</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="sh">"""</span><span class="s">API KeyëŠ” ëª©ë¡ì—ì„  ìˆ¨ê¹€.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dn</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">dn</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="n">dn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">:</span>     <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_raw</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">dotted</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">config path not found: </span><span class="si">{</span><span class="n">dotted</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cur</span>

    <span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>

<span class="c1"># ----- ì‹±ê¸€í†¤ -----
</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
<span class="n">_instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ReadOnlyConfig</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">_default_path</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">_resolve_default_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_default_path</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_PATH</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_get_instance</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span>
    <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">_instance</span>

<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">refresh_seconds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span><span class="p">,</span> <span class="n">_default_path</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">_default_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">refresh_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">refresh_seconds</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
        <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>

<span class="c1"># ---- ì™¸ë¶€ API ----
</span><span class="k">def</span> <span class="nf">api_provider</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>         <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">api_provider</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">api_providers</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>     <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">api_providers</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>                          <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">snapshot</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>                     <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">snapshot</span><span class="p">()</span>

<span class="c1"># ---- ê°ì²´í˜• í”„ë¡ì‹œ ----
</span><span class="k">class</span> <span class="nc">_ConfigProxy</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">_get_instance</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>
<span class="n">CONFIG</span> <span class="o">=</span> <span class="nf">_ConfigProxy</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="4-ì„ íƒ-comfyui-ë…¸ë“œë„-ìš©ì–´-ë§ì¶°-ì œê³µ">4) (ì„ íƒ) ComfyUI ë…¸ë“œë„ ìš©ì–´ ë§ì¶° ì œê³µ</h1>

<p>ì›í•œë‹¤ë©´ <code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/config_nodes.py</code>ì— ì•„ë˜ì²˜ëŸ¼:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">.config_singleton</span> <span class="kn">import</span> <span class="n">api_provider</span><span class="p">,</span> <span class="n">api_providers</span>
<span class="kn">import</span> <span class="n">json</span>

<span class="k">class</span> <span class="nc">ConfigAPIProviderLookup</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">multiline</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">})}}</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">lookup</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Config/API Providers (ReadOnly)</span><span class="sh">"</span>
    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nf">api_provider</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">ConfigListAPIProviders</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">INPUT_TYPES</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">{}}</span>
    <span class="n">RETURN_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">STRING</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">RETURN_NAMES</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">providers_json</span><span class="sh">"</span><span class="p">,)</span>
    <span class="n">FUNCTION</span> <span class="o">=</span> <span class="sh">"</span><span class="s">list_providers</span><span class="sh">"</span>
    <span class="n">CATEGORY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Config/API Providers (ReadOnly)</span><span class="sh">"</span>
    <span class="k">def</span> <span class="nf">list_providers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="nf">api_providers</span><span class="p">(),</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),)</span>

<span class="n">NODE_CLASS_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">ConfigAPIProviderLookup</span><span class="sh">"</span><span class="p">:</span> <span class="n">ConfigAPIProviderLookup</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigListAPIProviders</span><span class="sh">"</span><span class="p">:</span>  <span class="n">ConfigListAPIProviders</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">NODE_DISPLAY_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">ConfigAPIProviderLookup</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Config: API Provider Lookup</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">ConfigListAPIProviders</span><span class="sh">"</span><span class="p">:</span>  <span class="sh">"</span><span class="s">Config: List API Providers</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h1 id="5-ì²´í¬ë¦¬ìŠ¤íŠ¸">5) ì²´í¬ë¦¬ìŠ¤íŠ¸</h1>

<ul>
  <li>
    <p>âœ… ì„¹ì…˜/í•„ë“œëª…: <strong><code class="language-plaintext highlighter-rouge">api_providers</code> / (display_name, model_id, base_url, api_key)</strong></p>
  </li>
  <li>
    <p>âœ… ì½ê¸° ì „ìš© + íŒŒì¼ ë³€ê²½ <strong>ìµœëŒ€ 1ë¶„ ë‚´ ë°˜ì˜</strong> (mtime + TTL 5~60, ê¸°ë³¸ 30)</p>
  </li>
  <li>
    <p>âœ… ì–´ë””ì„œë“  ê°„ë‹¨ ì ‘ê·¼: <code class="language-plaintext highlighter-rouge">api_provider("í‚¤|í‘œì‹œëª…|model_id")</code></p>
  </li>
  <li>
    <p>âœ… ì‚¬ëŒì´ í¸ì§‘ ì‰¬ìš´ TOML + <code class="language-plaintext highlighter-rouge">${ENV}</code> ì¹˜í™˜</p>
  </li>
  <li>
    <p>âœ… ëª©ë¡ ë…¸ë“œëŠ” <strong>api_key ë¹„ë…¸ì¶œ</strong></p>
  </li>
</ul>

<p>í•„ìš”í•˜ë©´, ê¸°ì¡´ ì›Œí¬í”Œë¡œìš°(ë…¸ë“œ ê·¸ë˜í”„)ì—ì„œ ìë™ìœ¼ë¡œ ì´ ì´ë¦„ë“¤ë¡œ ë°”ê¿”ì£¼ëŠ” ìŠ¤í¬ë¦½íŠ¸ë„ ë§Œë“¤ì–´ì¤„ê²Œ.</p>

<p class="chat--user">

ì•„ paramsë„ í¬í•¨í•´ì¤˜. ê·¸ëŸ°ë° [api_providers."anthropic-sonnet"] ì´ ì•ˆì— parametersë¥¼ dictionaryë¡œ ë„£ì„ ìˆ˜ ì—†ë‚˜? ë”°ë¡œ í•­ëª©ì„ ë¹¼ë‹ˆê¹Œ ë³´ê¸°ê°€ ë¶ˆí¸í•œë° ì´ëŸ°ê±´ yamlì—ì„œë§Œ ê°€ëŠ¥?

</p>

<p>ì¢‹ì•„, <strong>TOMLì—ì„œë„ ë”•ì…”ë„ˆë¦¬(ë§µ)ë¥¼ í•œ ì„¹ì…˜ ì•ˆì—</strong> ë„£ì„ ìˆ˜ ìˆì–´.<br />
YAMLë§Œ ë˜ëŠ” ê²Œ ì•„ë‹ˆê³ , TOMLì€ ë‘ ê°€ì§€ ë°©ë²•ì„ ì§€ì›í•´:</p>

<ol>
  <li>
    <p><strong>ì¸ë¼ì¸ í…Œì´ë¸”</strong> : í•œ ì¤„ <code class="language-plaintext highlighter-rouge">{ ... }</code> ë¡œ ë”•ì…”ë„ˆë¦¬ ê°’ì„ ë„£ê¸°</p>
  </li>
  <li>
    <p><strong>ì  í‘œê¸°(dotted keys)</strong> : <code class="language-plaintext highlighter-rouge">parameters.temperature = 0.7</code> ì²˜ëŸ¼ ê°™ì€ ì„¹ì…˜ ì•ˆì—ì„œ í‚¤ë¥¼ ì ìœ¼ë¡œ ì´ì–´ ì“°ê¸°</p>
  </li>
</ol>

<p>ì•„ë˜ì— ë‘˜ ë‹¤ ì˜ˆì‹œ + ì½”ë“œë¥¼ ì‹±ê¸€í†¤ APIì— ë°˜ì˜í•´ì¤„ê²Œ. <code class="language-plaintext highlighter-rouge">api_providers</code> í•­ëª© ì•ˆì— <code class="language-plaintext highlighter-rouge">parameters</code>ë¥¼ ê·¸ëŒ€ë¡œ ë„£ê³ , ê¸°ë³¸ê°’ ë³‘í•©ë„ ì§€ì›í•´.</p>

<hr />

<h1 id="1-toml-ì‘ì„±ë²•-step-by-step">1) TOML ì‘ì„±ë²• (step-by-step)</h1>

<h2 id="a-ì¸ë¼ì¸-í…Œì´ë¸”ê¹”ë”-í•œ-ì¤„">A. ì¸ë¼ì¸ í…Œì´ë¸”(ê¹”ë”, í•œ ì¤„)</h2>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[api_providers."anthropic-sonnet"]</span>
<span class="py">display_name</span> <span class="p">=</span> <span class="s">"Anthropic Claude 3.5 Sonnet"</span>
<span class="py">model_id</span>     <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>     <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>      <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>
<span class="py">parameters</span>   <span class="o">=</span> <span class="p">{</span> <span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="py">top_p</span> <span class="p">=</span> <span class="mf">0.9</span><span class="p">,</span> <span class="py">stop</span> <span class="p">=</span> <span class="p">[</span><span class="s">"</span><span class="se">\n\n</span><span class="s">Human:"</span><span class="p">,</span> <span class="s">"</span><span class="se">\n\n</span><span class="s">Assistant:"</span><span class="p">]</span> <span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>ì¥ì : í•œëˆˆì— ë³´ê¸° ì¢‹ìŒ.</p>
  </li>
  <li>
    <p>ìœ ì˜: <strong>TOML 1.0 ìŠ¤í™ìƒ ì¸ë¼ì¸ í…Œì´ë¸”ì€ í•œ ì¤„</strong> ì´ì–´ì•¼ í•´. (ì¤„ë°”ê¿ˆ/ì£¼ì„ ë„£ê¸° ì–´ë ¤ì›€)</p>
  </li>
</ul>

<h2 id="b-ì -í‘œê¸°dotted-keys-ê°™ì€-ì„¹ì…˜-ë‚´ë¶€-ë‹¤ì¤„">B. ì  í‘œê¸°(dotted keys, ê°™ì€ ì„¹ì…˜ ë‚´ë¶€ ë‹¤ì¤„)</h2>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[api_providers."anthropic-sonnet"]</span>
<span class="py">display_name</span> <span class="p">=</span> <span class="s">"Anthropic Claude 3.5 Sonnet"</span>
<span class="py">model_id</span>     <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>     <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>      <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>
<span class="py">parameters.temperature</span> <span class="p">=</span> <span class="mf">0.2</span>
<span class="py">parameters.top_p</span>       <span class="p">=</span> <span class="mf">0.9</span>
<span class="py">parameters.stop</span>        <span class="p">=</span> <span class="p">[</span><span class="s">"</span><span class="se">\n\n</span><span class="s">Human:"</span><span class="p">,</span> <span class="s">"</span><span class="se">\n\n</span><span class="s">Assistant:"</span><span class="p">]</span>  <span class="c"># â† ì£¼ì„ OK</span>
</code></pre></div></div>

<ul>
  <li>
    <p>ì¥ì : ì—¬ëŸ¬ ì¤„ë¡œ ì½ê¸° í¸í•˜ê³  <strong>ì£¼ì„ ê°€ëŠ¥</strong>.</p>
  </li>
  <li>
    <p>ë‚´ë¶€ì ìœ¼ë¡œëŠ” ë”•ì…”ë„ˆë¦¬ë¡œ íŒŒì‹±ë¨. (YAML í•„ìš” ì—†ìŒ)</p>
  </li>
</ul>

<h2 id="ì„ íƒ-ê³µí†µ-ê¸°ë³¸ê°’-ë³‘í•©">(ì„ íƒ) ê³µí†µ ê¸°ë³¸ê°’ ë³‘í•©</h2>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[defaults.parameters]</span>
<span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.3</span>
<span class="py">max_tokens</span>  <span class="p">=</span> <span class="mi">2048</span>
</code></pre></div></div>

<ul>
  <li>ê° providerì˜ <code class="language-plaintext highlighter-rouge">parameters</code> ìœ„ì— <strong>ë®ì–´ì“°ê¸° ë³‘í•©</strong> ë¼ì„œ ìµœì¢…ê°’ì´ ë§Œë“¤ì–´ì ¸.</li>
</ul>

<hr />

<h1 id="2-ì „ì²´-ì˜ˆì‹œ-configtoml">2) ì „ì²´ ì˜ˆì‹œ <code class="language-plaintext highlighter-rouge">config.toml</code></h1>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">version</span> <span class="p">=</span> <span class="mi">1</span>

<span class="nn">[settings]</span>
<span class="py">refresh_interval_seconds</span> <span class="p">=</span> <span class="mi">30</span>  <span class="c"># 5~60(ìš”êµ¬: 1ë¶„ ë‚´ ë°˜ì˜)</span>

<span class="nn">[defaults.parameters]</span>
<span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.3</span>
<span class="py">max_tokens</span>  <span class="p">=</span> <span class="mi">2048</span>

<span class="c"># â”€â”€ OpenAI (ì¸ë¼ì¸ í…Œì´ë¸”) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nn">[api_providers."openai-mini"]</span>
<span class="py">display_name</span> <span class="p">=</span> <span class="s">"OpenAI GPT-4o mini"</span>
<span class="py">model_id</span>     <span class="p">=</span> <span class="s">"gpt-4o-mini"</span>
<span class="py">base_url</span>     <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key</span>      <span class="p">=</span> <span class="s">"${OPENAI_API_KEY}"</span>
<span class="py">parameters</span>   <span class="o">=</span> <span class="p">{</span> <span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.25</span><span class="p">,</span> <span class="py">top_p</span> <span class="p">=</span> <span class="mf">0.95</span> <span class="p">}</span>

<span class="c"># â”€â”€ Anthropic (ì  í‘œê¸°) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="nn">[api_providers."anthropic-sonnet"]</span>
<span class="py">display_name</span> <span class="p">=</span> <span class="s">"Anthropic Claude 3.5 Sonnet"</span>
<span class="py">model_id</span>     <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>     <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>      <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>
<span class="py">parameters.temperature</span> <span class="p">=</span> <span class="mf">0.2</span>
<span class="py">parameters.top_p</span>       <span class="p">=</span> <span class="mf">0.9</span>
<span class="py">parameters.stop</span>        <span class="p">=</span> <span class="p">[</span><span class="s">"</span><span class="se">\n\n</span><span class="s">Human:"</span><span class="p">,</span> <span class="s">"</span><span class="se">\n\n</span><span class="s">Assistant:"</span><span class="p">]</span>
</code></pre></div></div>

<hr />

<h1 id="3-ì™¸ë¶€-ì‚¬ìš©-ë°©ë²•-ê·¸ëŒ€ë¡œ--parameters-ì§€ì›">3) ì™¸ë¶€ ì‚¬ìš© ë°©ë²• (ê·¸ëŒ€ë¡œ, + <code class="language-plaintext highlighter-rouge">parameters</code> ì§€ì›)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="n">api_provider</span><span class="p">,</span> <span class="n">api_providers</span><span class="p">,</span> <span class="n">api_parameters</span><span class="p">,</span> <span class="n">get</span>

<span class="n">cfg</span> <span class="o">=</span> <span class="nf">api_provider</span><span class="p">(</span><span class="sh">"</span><span class="s">anthropic-sonnet</span><span class="sh">"</span><span class="p">)</span>   <span class="c1"># í‚¤ / display_name / model_id ì•„ë¬´ê±°ë‚˜
</span><span class="nf">print</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">],</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">])</span>
<span class="nf">print</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">])</span>                  <span class="c1"># â† ìµœì¢… ë³‘í•©ëœ dict
</span>
<span class="c1"># íŒŒë¼ë¯¸í„°ë§Œ ë°”ë¡œ
</span><span class="n">params</span> <span class="o">=</span> <span class="nf">api_parameters</span><span class="p">(</span><span class="sh">"</span><span class="s">openai-mini</span><span class="sh">"</span><span class="p">)</span>    <span class="c1"># {"temperature": 0.25, "top_p": 0.95, "max_tokens": 2048}
</span><span class="n">use_cache</span> <span class="o">=</span> <span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">feature_flags.use_cache</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h1 id="4-ë“œë¡­ì¸-êµì²´-ì½”ë“œ">4) ë“œë¡­ì¸ êµì²´ ì½”ë“œ</h1>

<h2 id="custom_nodescomfyui_config_reader__init__py-3"><code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/__init__.py</code></h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">.config_singleton</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CONFIG</span><span class="p">,</span>
    <span class="n">configure</span><span class="p">,</span>
    <span class="n">api_provider</span><span class="p">,</span> <span class="n">api_providers</span><span class="p">,</span>
    <span class="n">api_parameters</span><span class="p">,</span>                  <span class="c1"># â† ì¶”ê°€
</span>    <span class="n">get</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<h2 id="custom_nodescomfyui_config_readerconfig_singletonpy-3"><code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/config_singleton.py</code></h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># py3.11+
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>     <span class="c1"># py3.10-
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="k">def</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="sh">""</span><span class="p">);</span> <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>  <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">v</span>

<span class="k">def</span> <span class="nf">_norm</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_normalize_model_id</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">and</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">b</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">b</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - ì½ê¸° ì „ìš© TOML
    - mtime + TTL(5~60s, ê¸°ë³¸ 30s) ìë™ ì¬ë¡œë“œ â†’ 1ë¶„ ë‚´ ë³€ê²½ ë°˜ì˜
    - í‘œì¤€ ì„¹ì…˜: [api_providers]
    - ê° provider í•„ìˆ˜: display_name, model_id, base_url, api_key
      + ì„ íƒ: parameters(dict)  # ì¸ë¼ì¸ í…Œì´ë¸” ë˜ëŠ” dotted keys ëª¨ë‘ ì§€ì›
    - [defaults.parameters] ë³‘í•© ì§€ì›(ê°œë³„ provider.parametersê°€ ìš°ì„ )
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># --- ë‚´ë¶€ ë¡œë”© ---
</span>    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_providers_table</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_providers</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tbl</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

        <span class="c1"># defaults.parameters (alias: defaults.paramsë„ ì§€ì›)
</span>        <span class="n">defaults</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">defaults</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">d_params</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">defaults</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="n">tbl</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_providers_table</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">return</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>

            <span class="n">display</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="n">model</span>   <span class="o">=</span> <span class="nf">_normalize_model_id</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
            <span class="n">base</span>    <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="n">api</span>     <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">display</span> <span class="ow">and</span> <span class="n">model</span> <span class="ow">and</span> <span class="n">base</span> <span class="ow">and</span> <span class="n">api</span><span class="p">):</span>
                <span class="k">continue</span>  <span class="c1"># í•„ìˆ˜ ëˆ„ë½ ìŠ¤í‚µ
</span>
            <span class="c1"># provider.parameters (alias: params) ì¶”ì¶œ + defaults ë³‘í•©
</span>            <span class="n">p_params</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p_params</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">p_params</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># ê³¼ê±° ëª…ì¹­ í˜¸í™˜
</span>            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">p_params</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">merged_params</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">d_params</span><span class="p">,</span> <span class="o">**</span><span class="n">p_params</span><span class="p">}</span>

            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">display</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">:</span>     <span class="n">model</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="n">base</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span>      <span class="n">api</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span>   <span class="n">merged_params</span><span class="p">,</span>  <span class="c1"># â† í¬í•¨
</span>            <span class="p">}</span>

            <span class="c1"># ì ‘ê·¼ í‚¤: ì •ì˜ í‚¤ / display_name / model_id
</span>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">display</span><span class="p">,</span> <span class="n">model</span><span class="p">}:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">[</span><span class="nf">_norm</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">entry</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
        <span class="n">env_r</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_r</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">env_r</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span> <span class="k">pass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="n">r</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="c1"># --- í¼ë¸”ë¦­ API ---
</span>    <span class="k">def</span> <span class="nf">api_provider</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">api_provider key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">api_provider not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">api_providers</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sh">"""</span><span class="s">ëª©ë¡ì—ì„œëŠ” api_key ìˆ¨ê¹€, parametersëŠ” ë…¸ì¶œ.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dn</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">dn</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="n">dn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">:</span>     <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span>   <span class="n">v</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">api_parameters</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">api_provider</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_raw</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">dotted</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">config path not found: </span><span class="si">{</span><span class="n">dotted</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cur</span>

    <span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>

<span class="c1"># ----- ì‹±ê¸€í†¤ -----
</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
<span class="n">_instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ReadOnlyConfig</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">_default_path</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">_resolve_default_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_default_path</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_PATH</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_get_instance</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span>
    <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">_instance</span>

<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">refresh_seconds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span><span class="p">,</span> <span class="n">_default_path</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">_default_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">refresh_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">refresh_seconds</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
        <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>

<span class="c1"># ---- ì™¸ë¶€ API ----
</span><span class="k">def</span> <span class="nf">api_provider</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>         <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">api_provider</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">api_providers</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>     <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">api_providers</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">api_parameters</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>       <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">api_parameters</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>                          <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">snapshot</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>                     <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">snapshot</span><span class="p">()</span>

<span class="c1"># ---- ê°ì²´í˜• í”„ë¡ì‹œ ----
</span><span class="k">class</span> <span class="nc">_ConfigProxy</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">_get_instance</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>
<span class="n">CONFIG</span> <span class="o">=</span> <span class="nf">_ConfigProxy</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="5-ì •ë¦¬">5) ì •ë¦¬</h1>

<ul>
  <li>
    <p>âœ… <strong>TOMLì—ì„œë„ ë”•ì…”ë„ˆë¦¬ ê°€ëŠ¥</strong> : ì¸ë¼ì¸ í…Œì´ë¸” <code class="language-plaintext highlighter-rouge">{...}</code> ë˜ëŠ” ì  í‘œê¸° <code class="language-plaintext highlighter-rouge">parameters.foo =</code></p>
  </li>
  <li>
    <p>âœ… <code class="language-plaintext highlighter-rouge">api_providers</code> ê° í•­ëª©ì— <strong><code class="language-plaintext highlighter-rouge">parameters</code> í¬í•¨</strong> ì§€ì› (ì¸ë¼ì¸/ì í‘œê¸° ëª¨ë‘ OK)</p>
  </li>
  <li>
    <p>âœ… <code class="language-plaintext highlighter-rouge">defaults.parameters</code>ë¡œ ê³µí†µê°’ ë³‘í•©</p>
  </li>
  <li>
    <p>âœ… ì™¸ë¶€ ì ‘ê·¼: <code class="language-plaintext highlighter-rouge">api_provider("í‚¤")["parameters"]</code> ë˜ëŠ” <code class="language-plaintext highlighter-rouge">api_parameters("í‚¤")</code></p>
  </li>
  <li>
    <p>âœ… ì½ê¸° ì „ìš© + íŒŒì¼ ë³€ê²½ <strong>ìµœëŒ€ 1ë¶„ ë‚´ ë°˜ì˜</strong></p>
  </li>
</ul>

<p>ì›í•˜ë©´ <code class="language-plaintext highlighter-rouge">parameters</code> ì™¸ì— <code class="language-plaintext highlighter-rouge">http</code> ê°™ì€ ì„¹ì…˜ë„ ê°™ì€ ë°©ì‹ìœ¼ë¡œ ë¶™ì—¬ì„œ ë³‘í•© ì§€ì›í•´ì¤„ ìˆ˜ ìˆì–´!</p>

<p class="chat--user">

Pydantic ì´ìš©í•´ì„œ api provider í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ê³  ì´ê±¸ ë¦¬ìŠ¤íŠ¸ë¡œ ë¦¬í„´í•˜ëŠ” í•¨ìˆ˜ê°€ ìˆìœ¼ë©´ ì¢‹ê² ì–´. ë¦¬ìŠ¤íŠ¸ëŠ” api_provider_id ë¥¼ ì‚¬ìš©í•´ì„œ ì •ë ¬ëœ ìƒíƒœë¡œ ë¦¬í„´í•˜ê³  ì‹¶ì–´. ì˜ˆì‹œì—ì„œ "anthropic-sonnet" ì´ê±¸ idë¡œ í• ê±°ì•¼.

</p>

<p>ì¢‹ë‹¤â€”<strong>Pydantic ëª¨ë¸</strong> ë¡œ <code class="language-plaintext highlighter-rouge">ApiProvider</code> í´ë˜ìŠ¤ë¥¼ ì •ì˜í•˜ê³ , ì´ë¥¼ <strong><code class="language-plaintext highlighter-rouge">api_provider_id</code>(ì˜ˆ: <code class="language-plaintext highlighter-rouge">"anthropic-sonnet"</code>)ë¡œ ì •ë ¬</strong>í•´ì„œ ë¦¬í„´í•˜ëŠ” í•¨ìˆ˜ê¹Œì§€ ê¹”ë”í•˜ê²Œ ë¶™ì˜€ì–´.<br />
ê¸°ì¡´ ì‹±ê¸€í†¤/<code class="language-plaintext highlighter-rouge">api_providers</code> ìŠ¤í‚¤ë§ˆì™€ 100% í˜¸í™˜ë˜ë©°, <code class="language-plaintext highlighter-rouge">parameters</code>(dict)ë„ ë™ì¼í•˜ê²Œ ì§€ì›/ë³‘í•©ë¼.</p>

<p>ì•„ë˜ 3ê°œë§Œ ë„£ìœ¼ë©´ ë:</p>

<hr />

<h1 id="1-configtoml-ì˜ˆì‹œ">1) <code class="language-plaintext highlighter-rouge">config.toml</code> (ì˜ˆì‹œ)</h1>
<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">version</span> <span class="p">=</span> <span class="mi">1</span>

<span class="nn">[settings]</span>
<span class="py">refresh_interval_seconds</span> <span class="p">=</span> <span class="mi">30</span>

<span class="nn">[defaults.parameters]</span>
<span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.3</span>
<span class="py">max_tokens</span>  <span class="p">=</span> <span class="mi">2048</span>

<span class="nn">[api_providers."openai-mini"]</span>
<span class="py">display_name</span> <span class="p">=</span> <span class="s">"OpenAI GPT-4o mini"</span>
<span class="py">model_id</span>     <span class="p">=</span> <span class="s">"gpt-4o-mini"</span>
<span class="py">base_url</span>     <span class="p">=</span> <span class="s">"https://api.openai.com/v1"</span>
<span class="py">api_key</span>      <span class="p">=</span> <span class="s">"${OPENAI_API_KEY}"</span>
<span class="py">parameters</span>   <span class="o">=</span> <span class="p">{</span> <span class="py">temperature</span> <span class="p">=</span> <span class="mf">0.25</span><span class="p">,</span> <span class="py">top_p</span> <span class="p">=</span> <span class="mf">0.95</span> <span class="p">}</span>

<span class="nn">[api_providers."anthropic-sonnet"]</span>
<span class="py">display_name</span> <span class="p">=</span> <span class="s">"Anthropic Claude 3.5 Sonnet"</span>
<span class="py">model_id</span>     <span class="p">=</span> <span class="s">"claude-3-5-sonnet"</span>
<span class="py">base_url</span>     <span class="p">=</span> <span class="s">"https://api.anthropic.com"</span>
<span class="py">api_key</span>      <span class="p">=</span> <span class="s">"${ANTHROPIC_API_KEY}"</span>
<span class="c"># TOML dotted-keysë¡œ dict ì±„ìš°ê¸°</span>
<span class="py">parameters.temperature</span> <span class="p">=</span> <span class="mf">0.2</span>
<span class="py">parameters.top_p</span>       <span class="p">=</span> <span class="mf">0.9</span>
<span class="py">parameters.stop</span>        <span class="p">=</span> <span class="p">[</span><span class="s">"</span><span class="se">\n\n</span><span class="s">Human:"</span><span class="p">,</span> <span class="s">"</span><span class="se">\n\n</span><span class="s">Assistant:"</span><span class="p">]</span>
</code></pre></div></div>

<hr />

<h1 id="2-custom_nodescomfyui_config_readermodelspy">2) <code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/models.py</code></h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="k">class</span> <span class="nc">ApiProvider</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    ë‹¨ì¼ API Provider ì—”íŠ¸ë¦¬ (ì •ë ¬ í‚¤: api_provider_id)
    </span><span class="sh">"""</span>
    <span class="n">api_provider_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">'</span><span class="s">ì˜ˆ: </span><span class="sh">"</span><span class="s">anthropic-sonnet</span><span class="sh">"'</span><span class="p">)</span>
    <span class="n">display_name</span><span class="p">:</span>   <span class="nb">str</span>
    <span class="n">model_id</span><span class="p">:</span>       <span class="nb">str</span>
    <span class="n">base_url</span><span class="p">:</span>       <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span>        <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span>     <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h1 id="3-custom_nodescomfyui_config_readerconfig_singletonpy-ë“œë¡­ì¸-êµì²´ë³¸">3) <code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/config_singleton.py</code> (ë“œë¡­ì¸ êµì²´ë³¸)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomllib</span>  <span class="c1"># py3.11+
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomllib</span><span class="p">.</span><span class="n">loads</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">tomli</span>     <span class="c1"># py3.10-
</span>    <span class="n">_TOML_LOADS</span> <span class="o">=</span> <span class="n">tomli</span><span class="p">.</span><span class="n">loads</span>

<span class="kn">from</span> <span class="n">.models</span> <span class="kn">import</span> <span class="n">ApiProvider</span>  <span class="c1"># â† Pydantic ëª¨ë¸
</span>
<span class="k">def</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="sh">""</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">${</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="sh">""</span><span class="p">);</span> <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>  <span class="k">return</span> <span class="p">[</span><span class="nf">_expand_env</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">v</span>

<span class="k">def</span> <span class="nf">_norm</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">strip</span><span class="p">().</span><span class="nf">lower</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_normalize_model_id</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">request_model</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="ow">and</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]).</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">b</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">b</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nf">_deep_merge</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    - ì½ê¸° ì „ìš© TOML
    - mtime + TTL(5~60s, ê¸°ë³¸ 30s) ìë™ ì¬ë¡œë“œ â†’ 1ë¶„ ë‚´ ë³€ê²½ ë°˜ì˜
    - í‘œì¤€ ì„¹ì…˜: [api_providers]
    - ê° provider í•„ìˆ˜: display_name, model_id, base_url, api_key
      + ì„ íƒ: parameters(dict)  â€” ì¸ë¼ì¸ í…Œì´ë¸”/ì  í‘œê¸° ëª¨ë‘ ì§€ì›
    - [defaults.parameters] ë³‘í•© ì§€ì› (provider.parametersê°€ ìš°ì„ )
    - Pydantic ëª¨ë¸(ApiProvider) ë³€í™˜/ì •ë ¬ ì§€ì›
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># í‚¤(ì¡°íšŒ ì‹ë³„ì: id/display_name/model_id) â†’ provider entry
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># ê³ ìœ  id â†’ provider entry (ì¤‘ë³µ ì œê±°/ì •ë ¬ ìš©)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_by_id</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># --- ë‚´ë¶€ ë¡œë”© ---
</span>    <span class="k">def</span> <span class="nf">_read_text</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_providers_table</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_providers</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tbl</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_by_id</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

        <span class="c1"># defaults.parameters (alias: defaults.params)
</span>        <span class="n">defaults</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">defaults</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">d_params</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">defaults</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="n">tbl</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_providers_table</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">return</span>

        <span class="k">for</span> <span class="n">provider_id</span><span class="p">,</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>

            <span class="n">display</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="n">model</span>   <span class="o">=</span> <span class="nf">_normalize_model_id</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
            <span class="n">base</span>    <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="n">api</span>     <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">display</span> <span class="ow">and</span> <span class="n">model</span> <span class="ow">and</span> <span class="n">base</span> <span class="ow">and</span> <span class="n">api</span><span class="p">):</span>
                <span class="k">continue</span>  <span class="c1"># í•„ìˆ˜ ëˆ„ë½ ìŠ¤í‚µ
</span>
            <span class="c1"># provider.parameters (alias: params) + defaults ë³‘í•©
</span>            <span class="n">p_params</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p_params</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">p_params</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">params</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">p_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">p_params</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">merged_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">d_params</span><span class="p">,</span> <span class="o">**</span><span class="n">p_params</span><span class="p">}</span>

            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">api_provider_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">provider_id</span><span class="p">),</span>   <span class="c1"># â† ì›ë³¸ TOML í‚¤
</span>                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span>    <span class="n">display</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">:</span>        <span class="n">model</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>        <span class="n">base</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">:</span>         <span class="n">api</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span>      <span class="n">merged_parameters</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># ê³ ìœ  id ì‚¬ì „
</span>            <span class="n">self</span><span class="p">.</span><span class="n">_by_id</span><span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="n">provider_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">entry</span>
            <span class="c1"># ì¡°íšŒ ì¸ë±ìŠ¤(ì—¬ëŸ¬ í‚¤ë¡œ ì ‘ê·¼ ê°€ëŠ¥: id / display_name / model_id)
</span>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">provider_id</span><span class="p">),</span> <span class="n">display</span><span class="p">,</span> <span class="n">model</span><span class="p">}:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">[</span><span class="nf">_norm</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">entry</span>

    <span class="k">def</span> <span class="nf">_reload_locked</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_read_text</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">_TOML_LOADS</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">settings</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">refresh_interval_seconds</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
        <span class="n">env_r</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_r</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">r</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">env_r</span><span class="p">)))</span>
            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span> <span class="k">pass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span> <span class="o">=</span> <span class="n">r</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="nf">_expand_env</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_index</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">_stale_or_changed</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getmtime</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_last_mtime</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">_refresh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_loaded</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_loaded_at</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="nf">_stale_or_changed</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>

    <span class="c1"># --- í¼ë¸”ë¦­ í‚¤-ê°’ API ---
</span>    <span class="k">def</span> <span class="nf">api_provider</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nf">str</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sh">"</span><span class="s">api_provider key is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">_reload_locked</span><span class="p">()</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">api_provider not found: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hit</span>

    <span class="k">def</span> <span class="nf">api_providers</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sh">"""</span><span class="s">ëª©ë¡(ìš”ì•½): api_keyëŠ” ìˆ¨ê¸°ê³  parametersëŠ” ë…¸ì¶œ.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_by_id</span><span class="p">.</span><span class="nf">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">kv</span><span class="p">:</span> <span class="n">kv</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">out</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">display_name</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">:</span>     <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">model_id</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">:</span>     <span class="n">v</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span>
                <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span>   <span class="n">v</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="c1"># --- Pydantic ëª¨ë¸ API ---
</span>    <span class="k">def</span> <span class="nf">api_provider_models</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ApiProvider</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">ApiProvider ë¦¬ìŠ¤íŠ¸(ì •ë ¬: api_provider_id). api_key í¬í•¨ â€” ë¡œê¹… ìœ ì˜!</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">models</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ApiProvider</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nc">ApiProvider</span><span class="p">(</span><span class="o">**</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_by_id</span><span class="p">.</span><span class="nf">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">kv</span><span class="p">:</span> <span class="n">kv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">models</span>

    <span class="k">def</span> <span class="nf">api_provider_model</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">api_provider_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ApiProvider</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_by_id</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">api_provider_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">:</span>
            <span class="c1"># ë‹¤ë¥¸ í‚¤ë¡œ ë“¤ì–´ì™”ì„ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ì¸ë±ìŠ¤ë„ ì¡°íšŒ
</span>            <span class="n">entry</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_idx</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nf">_norm</span><span class="p">(</span><span class="n">api_provider_id</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">api_provider not found: </span><span class="si">{</span><span class="n">api_provider_id</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="nc">ApiProvider</span><span class="p">(</span><span class="o">**</span><span class="n">entry</span><span class="p">)</span>

    <span class="c1"># --- ë²”ìš© ---
</span>    <span class="k">def</span> <span class="nf">api_parameters</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">api_provider</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_raw</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">dotted</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">config path not found: </span><span class="si">{</span><span class="n">dotted</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cur</span>

    <span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_loaded</span><span class="p">()</span>
        <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw</span><span class="p">)</span>

<span class="c1"># ----- ì‹±ê¸€í†¤ -----
</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
<span class="n">_instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ReadOnlyConfig</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">_default_path</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">_resolve_default_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_default_path</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">COMFY_CONFIG_PATH</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">here</span><span class="p">,</span> <span class="sh">"</span><span class="s">config.toml</span><span class="sh">"</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_get_instance</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">_ReadOnlyConfig</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span>
    <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">_instance</span>

<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">refresh_seconds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_instance</span><span class="p">,</span> <span class="n">_default_path</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">_default_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">refresh_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">COMFY_CONFIG_REFRESH_SECONDS</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">refresh_seconds</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
        <span class="n">_instance</span> <span class="o">=</span> <span class="nf">_ReadOnlyConfig</span><span class="p">(</span><span class="nf">_resolve_default_path</span><span class="p">())</span>

<span class="c1"># ---- ì™¸ë¶€ API (í•¨ìˆ˜í˜•) ----
</span><span class="k">def</span> <span class="nf">api_provider</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>             <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">api_provider</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">api_providers</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>         <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">api_providers</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">api_parameters</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>           <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">api_parameters</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">api_provider_models</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ApiProvider</span><span class="p">]:</span>           <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">api_provider_models</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">api_provider_model</span><span class="p">(</span><span class="n">api_provider_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ApiProvider</span><span class="p">:</span> <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">api_provider_model</span><span class="p">(</span><span class="n">api_provider_id</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>                              <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="n">dotted</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">snapshot</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>                         <span class="k">return</span> <span class="nf">_get_instance</span><span class="p">().</span><span class="nf">snapshot</span><span class="p">()</span>

<span class="c1"># ---- ê°ì²´í˜• í”„ë¡ì‹œ ----
</span><span class="k">class</span> <span class="nc">_ConfigProxy</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">getattr</span><span class="p">(</span><span class="nf">_get_instance</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>
<span class="n">CONFIG</span> <span class="o">=</span> <span class="nf">_ConfigProxy</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="4-custom_nodescomfyui_config_reader__init__py-re-export">4) <code class="language-plaintext highlighter-rouge">custom_nodes/comfyui_config_reader/__init__.py</code> (re-export)</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">.config_singleton</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CONFIG</span><span class="p">,</span>
    <span class="n">configure</span><span class="p">,</span>
    <span class="n">api_provider</span><span class="p">,</span> <span class="n">api_providers</span><span class="p">,</span> <span class="n">api_parameters</span><span class="p">,</span>
    <span class="n">api_provider_model</span><span class="p">,</span> <span class="n">api_provider_models</span><span class="p">,</span>
    <span class="n">get</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="ì‚¬ìš©-ì˜ˆ-ê°„ë‹¨">ì‚¬ìš© ì˜ˆ (ê°„ë‹¨)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">comfyui_config_reader</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">api_provider_models</span><span class="p">,</span> <span class="n">api_provider_model</span><span class="p">,</span>
    <span class="n">api_provider</span><span class="p">,</span> <span class="n">api_parameters</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># ì „ì²´ Pydantic ë¦¬ìŠ¤íŠ¸ (ì •ë ¬: api_provider_id)
</span><span class="n">providers</span> <span class="o">=</span> <span class="nf">api_provider_models</span><span class="p">()</span>
<span class="c1"># ex) ["anthropic-sonnet", "openai-mini", ...] ìˆœì„œ
</span><span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">providers</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">api_provider_id</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">model_id</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">))</span>

<span class="c1"># ë‹¨ê±´ ì¡°íšŒ(Pydantic)
</span><span class="n">sonnet</span> <span class="o">=</span> <span class="nf">api_provider_model</span><span class="p">(</span><span class="sh">"</span><span class="s">anthropic-sonnet</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">sonnet</span><span class="p">.</span><span class="nf">model_dump</span><span class="p">())</span>  <span class="c1"># pydantic v2 / v1ì€ .dict()
</span>
<span class="c1"># í‚¤/í‘œì‹œëª…/ëª¨ë¸ID ì•„ë¬´ê±°ë‚˜ë¡œ ì ‘ê·¼(ë”•ì…”ë„ˆë¦¬)
</span><span class="n">cfg</span> <span class="o">=</span> <span class="nf">api_provider</span><span class="p">(</span><span class="sh">"</span><span class="s">OpenAI GPT-4o mini</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">base_url</span><span class="sh">"</span><span class="p">],</span> <span class="n">cfg</span><span class="p">[</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">])</span>

<span class="c1"># íŒŒë¼ë¯¸í„°ë§Œ
</span><span class="n">params</span> <span class="o">=</span> <span class="nf">api_parameters</span><span class="p">(</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h3 id="ë¹„ê³ ">ë¹„ê³ </h3>

<ul>
  <li>
    <p><strong>ë³´ì•ˆ ì£¼ì˜</strong> : <code class="language-plaintext highlighter-rouge">api_provider_models()</code>ëŠ” ê°ì²´ì— <code class="language-plaintext highlighter-rouge">api_key</code>ê°€ í¬í•¨ë¼ìš”. ë¡œê¹…/ë””ë²„ê¹… ì‹œ ë§ˆìŠ¤í‚¹í•˜ì„¸ìš”.</p>
  </li>
  <li>
    <p><strong>TOML íŒŒë¼ë¯¸í„° ì…ë ¥</strong> : ì¸ë¼ì¸ í…Œì´ë¸”(<code class="language-plaintext highlighter-rouge">{...}</code>) ë˜ëŠ” ì  í‘œê¸°(<code class="language-plaintext highlighter-rouge">parameters.x = ...</code>) ë‘˜ ë‹¤ OK.</p>
  </li>
  <li>
    <p><strong>ì •ë ¬ ë³´ì¥</strong> : ë¦¬ìŠ¤íŠ¸ëŠ” <strong>í•­ìƒ<code class="language-plaintext highlighter-rouge">api_provider_id</code>(TOML í‚¤)</strong> ê¸°ì¤€ ì˜¤ë¦„ì°¨ìˆœ.</p>
  </li>
  <li>
    <p><strong>ì„±ëŠ¥/ì¼ê´€ì„±</strong> : mtime + TTL(ê¸°ë³¸ 30s) ìºì‹œ â†’ â€œìµœëŒ€ 1ë¶„ ë‚´ ë³€ê²½ ë°˜ì˜â€ ìš”ê±´ ì¶©ì¡±.</p>
  </li>
</ul>

<p>í•„ìš”í•˜ë©´ ê°™ì€ ë°©ì‹ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">http</code> ì„¹ì…˜(í—¤ë”/ì¿¼ë¦¬/íƒ€ì„ì•„ì›ƒ)ë„ ë³‘í•©í•´ì„œ ëª¨ë¸ì— ë„£ì„ ìˆ˜ ìˆê²Œ í™•ì¥í•´ì¤„ê²Œ!</p>]]></content><author><name>hvppyarchive</name></author><category term="comfyui" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">openai api Raw ë°ì´í„° í™•ì¸ ë°©ë²•</title><link href="https://hvppyarchive.github.io/python/openai-package-data-hook/" rel="alternate" type="text/html" title="openai api Raw ë°ì´í„° í™•ì¸ ë°©ë²•" /><published>2025-10-01T18:38:56+09:00</published><updated>2025-10-01T18:38:56+09:00</updated><id>https://hvppyarchive.github.io/python/openai-package-data-hook</id><content type="html" xml:base="https://hvppyarchive.github.io/python/openai-package-data-hook/"><![CDATA[<p class="chat--user">

openai python packageì—ì„œ ë‚´ê°€ ë³´ë‚´ëŠ” íŒ¨í‚·ì„ ê°€ëŠ¥í•œ raw ë°ì´í„° í˜•íƒœë¡œ ë³´ê³  ì‹¶ì–´

</p>

<p>ì¢‹ì•„ìš”. â€œopenaiâ€ Python íŒ¨í‚¤ì§€ë¡œ APIë¥¼ í˜¸ì¶œí•  ë•Œ, ë‚´ê°€ ë³´ë‚¸ <strong>HTTP ìš”ì²­(=íŒ¨í‚·)ì— ìµœëŒ€í•œ ê°€ê¹Œìš´ raw ë°ì´í„°</strong> ë¥¼ ë³´ëŠ” ëŒ€í‘œì ì¸ ë°©ë²•ì„ ë‹¨ê³„ë³„ë¡œ ì •ë¦¬í–ˆì–´ìš”. ìƒí™©/ë³´ì•ˆ ìš”êµ¬ì— ë”°ë¼ ê³¨ë¼ ì“°ì‹œë©´ ë©ë‹ˆë‹¤.</p>

<hr />

<h1 id="1-ê°€ì¥-ê°„ë‹¨í•œ-ë°©ë²•-sdk-ë””ë²„ê·¸-ë¡œê·¸-ì¼œê¸°">1) ê°€ì¥ ê°„ë‹¨í•œ ë°©ë²•: SDK ë””ë²„ê·¸ ë¡œê·¸ ì¼œê¸°</h1>

<p>OpenAI Python SDKëŠ” í™˜ê²½ë³€ìˆ˜ í•œ ì¤„ë¡œ ìƒì„¸ ë¡œê·¸ë¥¼ ë¿Œë¦´ ìˆ˜ ìˆì–´ìš”.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">OPENAI_LOG</span><span class="o">=</span>debug
python your_script.py
</code></pre></div></div>

<ul>
  <li>ì´ëŸ¬ë©´ SDK ë‚´ë¶€ì™€ í•¨ê»˜ <strong>httpx</strong>(OpenAI SDKì˜ HTTP í´ë¼ì´ì–¸íŠ¸) ë””ë²„ê·¸ ë¡œê·¸ë„ í™œì„±í™”ë¼ì„œ ìš”ì²­/ì‘ë‹µ íë¦„ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. <a href="https://stackoverflow.com/questions/76256249/logging-in-the-open-ai-python-library?utm_source=chatgpt.com">Stack Overflow</a></li>
</ul>

<blockquote>
  <p>ì¥ì : ì½”ë“œ ìˆ˜ì • ì—†ìŒ<br />
 ë‹¨ì : ë°”ë”” ì „ë¬¸ì„ í•­ìƒ ë³´ì—¬ì£¼ì§„ ì•ŠìŒ(ë¯¼ê°ì •ë³´ ë³´í˜¸ ì°¨ì›ì—ì„œ ë§ˆìŠ¤í‚¹/ìƒëµë  ìˆ˜ ìˆìŒ)</p>
</blockquote>

<hr />

<h1 id="2-í‘œì¤€-ë¡œê¹…ìœ¼ë¡œ-httpx-ë””ë²„ê¹…ìš”ì²­ì‘ë‹µ-ë¼ì¸í—¤ë”">2) í‘œì¤€ ë¡œê¹…ìœ¼ë¡œ httpx ë””ë²„ê¹…(ìš”ì²­/ì‘ë‹µ ë¼ì¸Â·í—¤ë”)</h1>

<p><code class="language-plaintext highlighter-rouge">logging</code>ìœ¼ë¡œ httpx ë¡œê±°ë¥¼ DEBUGë¡œ ì¼œë©´, ì—°ê²°/ìš”ì²­/ì‘ë‹µì˜ ë‚´ë¶€ ë™ì‘ì„ ìì„¸íˆ ë³¼ ìˆ˜ ìˆì–´ìš”.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">logging</span>

<span class="n">logging</span><span class="p">.</span><span class="nf">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="p">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="n">logging</span><span class="p">.</span><span class="nf">getLogger</span><span class="p">(</span><span class="sh">"</span><span class="s">httpx</span><span class="sh">"</span><span class="p">).</span><span class="nf">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="p">.</span><span class="n">DEBUG</span><span class="p">)</span>

<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>
<span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">()</span>

<span class="c1"># í‰ì†Œì²˜ëŸ¼ í˜¸ì¶œ
</span><span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ping</span><span class="sh">"</span><span class="p">}],</span>
<span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
</code></pre></div></div>

<ul>
  <li>ìœ„ì²˜ëŸ¼ í•˜ë©´ httpxê°€ ì¶œë ¥í•˜ëŠ” <strong>ìš”ì²­ ë©”ì„œë“œ/URL, ì‘ë‹µ ìƒíƒœ, ì¼ë¶€ í—¤ë” ë“±</strong> ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•„ìš”í•œ ê²½ìš° í¬ë§·ì„ ë” ê¾¸ë°€ ìˆ˜ ìˆì–´ìš”. <a href="https://www.python-httpx.org/logging/?utm_source=chatgpt.com">python-httpx.org</a></li>
</ul>

<blockquote>
  <p>ì¥ì : í‘œì¤€ íŒŒì´ì¬ ë¡œê¹…ìœ¼ë¡œ ì†ì‰½ê²Œ ì œì–´<br />
 ë‹¨ì : ë°”ë”” ì „ë¬¸ì€ ê¸°ë³¸ ë¡œê·¸ì— ì•ˆ ë‚˜ì˜´</p>
</blockquote>

<hr />

<h1 id="3-ì§„ì§œ-rawì—-ê°€ê¹ê²Œ--ì»¤ìŠ¤í…€-httpx-client--ì´ë²¤íŠ¸-í›…">3) â€œì§„ì§œ rawì— ê°€ê¹ê²Œâ€ â€” ì»¤ìŠ¤í…€ httpx Client + ì´ë²¤íŠ¸ í›…</h1>

<p>ê°€ì¥ íˆ¬ëª…í•œ ë°©ë²•ì€ SDKì— <strong>ì»¤ìŠ¤í…€ httpx.Client</strong> ë¥¼ ì£¼ì…í•˜ê³ , <strong>event_hooks</strong> ë¡œ ìš”ì²­Â·ì‘ë‹µ ì‹œì ì— <strong>ë°”ë””ê¹Œì§€ í¬í•¨</strong> í•´ì„œ ì°ëŠ” ê²ë‹ˆë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="k">def</span> <span class="nf">log_request</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Request</span><span class="p">):</span>
    <span class="c1"># ì£¼ì˜: ì—¬ê¸°ì„œ bodyë¥¼ ì¶œë ¥í•˜ë©´ í”„ë¡¬í”„íŠ¸/í‚¤ ë“± ë¯¼ê°ì •ë³´ê°€ ë…¸ì¶œë  ìˆ˜ ìˆìŒ
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== HTTP REQUEST ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">request</span><span class="p">.</span><span class="n">url</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># request.contentëŠ” bytesì¼ ìˆ˜ ìˆìŒ
</span>    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">-- body (utf-8) --</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">))</span>
        <span class="k">except</span> <span class="nb">UnicodeDecodeError</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">-- body (bytes) --</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">log_response</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Response</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== HTTP RESPONSE ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">HTTP/</span><span class="si">{</span><span class="n">response</span><span class="p">.</span><span class="n">http_version</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># ì£¼ì˜: ì‘ë‹µ ë°”ë””ì—ëŠ” í† í°/í…ìŠ¤íŠ¸ ë“± ë¯¼ê°ì •ë³´ í¬í•¨ ê°€ëŠ¥
</span>    <span class="n">body</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">content</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">-- body (utf-8 pretty) --</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">(),</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">-- body (raw) --</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">body</span><span class="p">[:</span><span class="mi">2000</span><span class="p">])</span>  <span class="c1"># ë„ˆë¬´ ê¸¸ë©´ ìƒ˜í”Œë§Œ
</span>
<span class="n">hooks</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">log_request</span><span class="p">],</span>
    <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">log_response</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">http_client</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">Client</span><span class="p">(</span><span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">)</span>

<span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">http_client</span><span class="o">=</span><span class="n">http_client</span><span class="p">)</span>

<span class="c1"># í…ŒìŠ¤íŠ¸ í˜¸ì¶œ
</span><span class="n">_</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Hello</span><span class="sh">"</span><span class="p">}],</span>
<span class="p">)</span>
</code></pre></div></div>

<ul>
  <li>í•µì‹¬ì€ <code class="language-plaintext highlighter-rouge">OpenAI(http_client=...)</code> ë¡œ <strong>ë‚´ httpx í´ë¼ì´ì–¸íŠ¸ë¥¼ ì£¼ì…</strong> í•˜ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤. ì´ëŸ° ì‹ìœ¼ë¡œ ìš”ì²­/ì‘ë‹µ <strong>í—¤ë” + ë°”ë””</strong> ë¥¼ ì›í•˜ëŠ” í˜•ì‹ìœ¼ë¡œ ë¤í”„í•  ìˆ˜ ìˆì–´ìš”. <a href="https://til.simonwillison.net/httpx/openai-log-requests-responses?utm_source=chatgpt.com">TIL+2</a></li>
</ul>

<blockquote>
  <p>ì¥ì : ê°€ì¥ â€œrawâ€ì— ê°€ê¹Œì›€(ë‚´ìš©Â·í—¤ë”Â·ìƒíƒœ ì „ë¶€ ë‚´ê°€ í†µì œ)<br />
 ë‹¨ì : ì§ì ‘ ë§ˆìŠ¤í‚¹ ì²˜ë¦¬ë¥¼ í•´ì•¼ ì•ˆì „</p>
</blockquote>

<hr />

<h1 id="4-ì™¸ë¶€-í”„ë¡ì‹œíŒ¨í‚·-ìº¡ì²˜ë¡œ-ì™€ì´ì–´-ê·¸ëŒ€ë¡œ-ë³´ê¸°">4) ì™¸ë¶€ í”„ë¡ì‹œ(íŒ¨í‚· ìº¡ì²˜)ë¡œ â€œì™€ì´ì–´ ê·¸ëŒ€ë¡œâ€ ë³´ê¸°</h1>

<p>ì½”ë“œë¥¼ ê±´ë“œë¦¬ê³  ì‹¶ì§€ ì•Šê±°ë‚˜, <strong>ì§„ì§œ ì „ì†¡ë˜ëŠ” TLS íŠ¸ë˜í”½</strong> ê¹Œì§€ ê´€ì°°í•˜ê³  ì‹¶ë‹¤ë©´ <strong>í”„ë¡ì‹œ/íŒ¨í‚· ë„êµ¬</strong> ë¥¼ ì“°ì„¸ìš”.</p>

<ul>
  <li>
    <p>ì˜ˆ: <strong>Proxyman</strong> , <strong>mitmproxy</strong> , <strong>Charles</strong> , <strong>Fiddler</strong> ë“±</p>
  </li>
  <li>
    <p>ë°©ë²•: ë„êµ¬ì—ì„œ ë£¨íŠ¸ ì¸ì¦ì„œë¥¼ ì‹ ë¢°í•˜ë„ë¡ ì„¤ì • â†’ Pythonì´ í•´ë‹¹ í”„ë¡ì‹œë¥¼ ì“°ê²Œ <code class="language-plaintext highlighter-rouge">HTTPS_PROXY</code>/<code class="language-plaintext highlighter-rouge">HTTP_PROXY</code> í™˜ê²½ë³€ìˆ˜ ì„¤ì • â†’ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ â†’ ë„êµ¬ì—ì„œ <strong>ìš”ì²­ ë¼ì¸/í—¤ë”/ì••ì¶• ì „/í›„ ë°”ë””</strong> ê¹Œì§€ ì—´ëŒ</p>
  </li>
  <li>
    <p>httpx/requests ê¸°ë°˜ íŒŒì´ì¬ ì½”ë“œì—ì„œ ì´ëŸ° í”„ë¡ì‹œë¡œ <strong>HTTPS íŠ¸ë˜í”½ ìº¡ì²˜</strong> ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤. <a href="https://proxyman.com/posts/2025-01-29-How-To-Capture-HTTPS-Traffic-From-Python-Requests-httpx?utm_source=chatgpt.com">Proxyman</a></p>
  </li>
</ul>

<blockquote>
  <p>ì¥ì : SDK/ì½”ë“œ ìˆ˜ì • ìµœì†Œí™”, ì‹¤ì œ ì „ì†¡ í˜•íƒœë¥¼ GUIë¡œ ì§ê´€ì ìœ¼ë¡œ í™•ì¸<br />
 ë‹¨ì : ì‚¬ë‚´ ì •ì±…/ë£¨íŠ¸ ì¸ì¦ì„œ ì„¤ì¹˜ ì´ìŠˆ ê°€ëŠ¥</p>
</blockquote>

<hr />

<h1 id="5-ë¹„êµ-ê¸°ì¤€-ì •ë¦¬-ì–¸ì œ-ë¬´ì—‡ì„-ì“¸ê¹Œ">5) ë¹„êµ ê¸°ì¤€ ì •ë¦¬ (ì–¸ì œ ë¬´ì—‡ì„ ì“¸ê¹Œ?)</h1>

<ul>
  <li>
    <p><strong>ë¹ ë¥¸ í™•ì¸</strong> : <code class="language-plaintext highlighter-rouge">OPENAI_LOG=debug</code> (1ë¶„ ì»·). <a href="https://stackoverflow.com/questions/76256249/logging-in-the-open-ai-python-library?utm_source=chatgpt.com">Stack Overflow</a></p>
  </li>
  <li>
    <p><strong>íŒŒì´ì¬ ë¡œê·¸ì— ì¼ì›í™”</strong> : httpx ë¡œê±° DEBUG (Step 2). <a href="https://www.python-httpx.org/logging/?utm_source=chatgpt.com">python-httpx.org</a></p>
  </li>
  <li>
    <p><strong>ìš”ì²­/ì‘ë‹µ ë°”ë””ê¹Œì§€ 100% í†µì œ</strong> : ì»¤ìŠ¤í…€ httpx Client + event_hooks (Step 3). <a href="https://til.simonwillison.net/httpx/openai-log-requests-responses?utm_source=chatgpt.com">TIL+1</a></p>
  </li>
  <li>
    <p><strong>ì§„ì§œ íŒ¨í‚· ê´€ì (í”„ë¡ì‹œ)</strong> : Proxyman/mitmproxy (Step 4). <a href="https://proxyman.com/posts/2025-01-29-How-To-Capture-HTTPS-Traffic-From-Python-Requests-httpx?utm_source=chatgpt.com">Proxyman</a></p>
  </li>
</ul>

<hr />

<h1 id="6-ë³´ì•ˆì»´í”Œë¼ì´ì–¸ìŠ¤-ì£¼ì˜ì¤‘ìš”">6) ë³´ì•ˆ/ì»´í”Œë¼ì´ì–¸ìŠ¤ ì£¼ì˜(ì¤‘ìš”)</h1>

<ul>
  <li>
    <p><strong>API í‚¤</strong> ì™€ <strong>í”„ë¡¬í”„íŠ¸/ì‘ë‹µ ë‚´ìš©</strong> ì´ ë¡œê·¸ì— ë‚¨ì„ ìˆ˜ ìˆì–´ìš”.</p>

    <ul>
      <li>
        <p>ë¡œì»¬ë§Œ, ì ‘ê·¼ ì œí•œëœ í™˜ê²½ì—ì„œë§Œ ì¶œë ¥í•˜ì„¸ìš”.</p>
      </li>
      <li>
        <p>ì €ì¥ ì‹œì—” <strong>ë§ˆìŠ¤í‚¹/ì•”í˜¸í™”</strong> ë˜ëŠ” <strong>ì„ì‹œ íŒŒì¼</strong> ì‚¬ìš©ì„ ê¶Œì¥.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>íšŒì‚¬/ì¡°ì§ ì •ì±…ìƒ <strong>ì¤‘ê°„ì í”„ë¡ì‹œ íˆ´</strong> ì‚¬ìš©ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤(íŠ¹íˆ í´ë¼ìš°ë“œ/ìƒì‚°í™˜ê²½). ì‚¬ì „ ìŠ¹ì¸ í•„ìš”.</p>
  </li>
</ul>

<hr />

<h1 id="7-ì°¸ê³ -ë¬¸ì„œ">7) ì°¸ê³  ë¬¸ì„œ</h1>

<ul>
  <li>
    <p>OpenAI SDK ë””ë²„ê¹… ê°œìš”/ë ˆí¼ëŸ°ìŠ¤: <a href="https://platform.openai.com/docs/api-reference/debugging-requests?utm_source=chatgpt.com">OpenAI í”Œë«í¼+1</a></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">OPENAI_LOG=debug</code> ì•ˆë‚´(Q&amp;A): <a href="https://stackoverflow.com/questions/76256249/logging-in-the-open-ai-python-library?utm_source=chatgpt.com">Stack Overflow</a></p>
  </li>
  <li>
    <p>httpx ë¡œê¹…/íŠ¸ëœìŠ¤í¬íŠ¸ ì‹¬í™”: <a href="https://www.python-httpx.org/logging/?utm_source=chatgpt.com">python-httpx.org+1</a></p>
  </li>
  <li>
    <p>ì™¸ë¶€ í”„ë¡ì‹œë¡œ httpx íŠ¸ë˜í”½ ìº¡ì²˜: <a href="https://proxyman.com/posts/2025-01-29-How-To-Capture-HTTPS-Traffic-From-Python-Requests-httpx?utm_source=chatgpt.com">Proxyman</a></p>
  </li>
</ul>

<hr />

<p>ì›í•˜ì‹œë©´, ìœ„ â‘¢ ì»¤ìŠ¤í…€ í´ë¼ì´ì–¸íŠ¸ ì½”ë“œë¥¼ <strong>ë°”ë”” ë§ˆìŠ¤í‚¹(ì˜ˆ: í† í°/ì´ë©”ì¼ ì œê±°)</strong> í¬í•¨ ë²„ì „ìœ¼ë¡œ ë°”ë¡œ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

stringì— ë°ì´í„°ê°€ ë‹´ê¸°ê²Œ í•˜ê³  ì‹¶ì–´ ìš”ì²­ì„ ë³´ë‚¼ë•Œ / ë°›ì„ë•Œ ê°ê°

</p>

<p>ì¢‹ìŠµë‹ˆë‹¤ â€” <strong>ìš”ì²­ ë³´ë‚¼ ë•Œ(request)ì™€ ë°›ì„ ë•Œ(response)</strong> ê°ê°ì˜ ë°”ë””ë¥¼ <strong>ë¬¸ìì—´(string)</strong>ìœ¼ë¡œ ì €ì¥í•˜ëŠ” ì‹¤ì „ ì½”ë“œ(ë™ê¸° + ë¹„ë™ê¸°)ë¥¼ ë°”ë¡œ ë“œë¦´ê²Œìš”. ë¯¼ê°ì •ë³´(Authorization/API Key ë“±) ë§ˆìŠ¤í‚¹ë„ í¬í•¨ë˜ì–´ ìˆìœ¼ë‹ˆ ì•ˆì „í•˜ê²Œ ì“°ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¨ê³„ë³„ë¡œ ì„¤ëª…ë„ ë§ë¶™ì˜€ì–´ìš” â€” ìš”ì²­í•˜ì‹  ëŒ€ë¡œ <strong>step-by-step</strong> ë°©ì‹ìœ¼ë¡œìš”.</p>

<hr />

<h1 id="1-í•µì‹¬-ì•„ì´ë””ì–´-ê°„ë‹¨-ìš”ì•½">1) í•µì‹¬ ì•„ì´ë””ì–´ (ê°„ë‹¨ ìš”ì•½)</h1>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">httpx.Client</code>(ë˜ëŠ” <code class="language-plaintext highlighter-rouge">httpx.AsyncClient</code>)ë¥¼ ë§Œë“¤ì–´ <code class="language-plaintext highlighter-rouge">event_hooks</code>ì— ìš”ì²­/ì‘ë‹µ í›…ì„ ë¶™ì…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>í›…ì—ì„œ <code class="language-plaintext highlighter-rouge">request.content</code> / <code class="language-plaintext highlighter-rouge">response.content</code>ë¥¼ ì½ì–´ <code class="language-plaintext highlighter-rouge">str</code>ë¡œ ë³€í™˜í•´ì„œ ì „ì—­ ë³€ìˆ˜ë‚˜ ìº¡ì²˜ìš© ë³€ìˆ˜ì— ì €ì¥í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë¡œê·¸ë¡œ ì¶œë ¥í•˜ê¸° ì „ ë¯¼ê° í•„ë“œ(í—¤ë”ì˜ Authorization ë“±)ì™€ ë°”ë”” ë‚´ë¶€ í‚¤(ì˜ˆ: <code class="language-plaintext highlighter-rouge">"api_key"</code>, <code class="language-plaintext highlighter-rouge">"key"</code>)ë¥¼ ë§ˆìŠ¤í‚¹í•©ë‹ˆë‹¤.</p>
  </li>
</ol>

<hr />

<h1 id="2-ë™ê¸°synchronous-ì˜ˆì œ--ë°”ë¡œ-ë³µì‚¬í•´ì„œ-ì“°ì„¸ìš”">2) ë™ê¸°(synchronous) ì˜ˆì œ â€” ë°”ë¡œ ë³µì‚¬í•´ì„œ ì“°ì„¸ìš”</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>    <span class="c1"># ì„¤ì¹˜ëœ ìµœì‹  openai íŒ¨í‚¤ì§€ ì‚¬ìš©
</span>
<span class="c1"># ì €ì¥í•  ë¬¸ìì—´ ë³€ìˆ˜(ìš”ì²­/ì‘ë‹µ)
</span><span class="n">captured_request_body</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">captured_response_body</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">redacted</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="o">==</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">api-key</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">k</span><span class="p">.</span><span class="nf">lower</span><span class="p">():</span>
            <span class="n">redacted</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">REDACTED</span><span class="sh">"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">redacted</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">redacted</span>

<span class="k">def</span> <span class="nf">redact_json_text</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="c1"># ì‹œë„: JSONì´ë©´ íŒŒì‹±í•´ì„œ íŠ¹ì • í‚¤ ë§ˆìŠ¤í‚¹
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">sensitive</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">apiKey</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">sensitive</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="n">obj</span><span class="p">[</span><span class="n">sensitive</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">REDACTED</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="c1"># JSONì´ ì•„ë‹ˆë©´ ê°„ë‹¨ ì¹˜í™˜(í—¤ë”ì²˜ëŸ¼)
</span>        <span class="c1"># ì˜ˆ: URL-encoded form/bodyì—ì„œ key=ê°’ í˜•íƒœë¥¼ ê°€ë³ê²Œ ë§ˆìŠ¤í‚¹
</span>        <span class="k">for</span> <span class="n">sensitive</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">apiKey</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">sensitive</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span><span class="p">,</span> <span class="n">sensitive</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=REDACTED</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span>

<span class="k">def</span> <span class="nf">request_hook</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Request</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">captured_request_body</span>
    <span class="c1"># í—¤ë” ë§ˆìŠ¤í‚¹
</span>    <span class="n">safe_headers</span> <span class="o">=</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">))</span>
    <span class="c1"># ë°”ë”” ì½ê¸° (bytes -&gt; str)
</span>    <span class="n">body_str</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># request.contentëŠ” bytes ë˜ëŠ” None
</span>    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">body_str</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">body_str</span> <span class="o">=</span> <span class="nf">repr</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># ì¤€ë¹„ë˜ì§€ ì•Šì€ ìŠ¤íŠ¸ë¦¼(rare)ì¸ ê²½ìš°
</span>        <span class="n">body_str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">&lt;no request.content available or streaming body&gt;</span><span class="sh">"</span>
    <span class="c1"># ë¯¼ê°ì •ë³´ ë§ˆìŠ¤í‚¹
</span>    <span class="n">body_str</span> <span class="o">=</span> <span class="nf">redact_json_text</span><span class="p">(</span><span class="n">body_str</span><span class="p">)</span>
    <span class="n">captured_request_body</span> <span class="o">=</span> <span class="n">body_str</span>

    <span class="c1"># (ì„ íƒ) ì½˜ì†” ì¶œë ¥
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">---- REQUEST ----</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">request</span><span class="p">.</span><span class="n">url</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">safe_headers</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">-- body --</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">body_str</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">-----------------</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">response_hook</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Response</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">captured_response_body</span>
    <span class="c1"># í—¤ë” ë§ˆìŠ¤í‚¹
</span>    <span class="n">safe_headers</span> <span class="o">=</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">))</span>
    <span class="c1"># ì‘ë‹µ ë°”ë”” ì½ìŒ (bytes -&gt; str)
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># response.contentëŠ” ì „ì²´ ë°”ë””(ì´ë¯¸ ìˆ˜ì‹ ëœ ìƒíƒœì˜ hookì—ì„œëŠ” ì•ˆì „)
</span>        <span class="n">body_str</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
        <span class="c1"># ì‹œë„í•´ì„œ JSON ì˜ˆì˜ê²Œ
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">parsed</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">body_str</span><span class="p">)</span>
            <span class="n">body_str</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">parsed</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">body_str</span> <span class="o">=</span> <span class="nf">repr</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>
    <span class="n">body_str</span> <span class="o">=</span> <span class="nf">redact_json_text</span><span class="p">(</span><span class="n">body_str</span><span class="p">)</span>
    <span class="n">captured_response_body</span> <span class="o">=</span> <span class="n">body_str</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">---- RESPONSE ----</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">HTTP/</span><span class="si">{</span><span class="n">response</span><span class="p">.</span><span class="n">http_version</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">safe_headers</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">-- body --</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">body_str</span><span class="p">[:</span><span class="mi">4000</span><span class="p">])</span>  <span class="c1"># ë„ˆë¬´ ê¸¸ë©´ ì˜ë¼ì„œ ë³´ì´ê²Œ
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">------------------</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ì´ë²¤íŠ¸ í›… ë“±ë¡
</span><span class="n">hooks</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">request_hook</span><span class="p">],</span>
    <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">response_hook</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">http_client</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">Client</span><span class="p">(</span><span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">60.0</span><span class="p">)</span>

<span class="c1"># OpenAI í´ë¼ì´ì–¸íŠ¸ì— ì£¼ì…
</span><span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">http_client</span><span class="o">=</span><span class="n">http_client</span><span class="p">)</span>

<span class="c1"># ì‹¤ì œ ìš”ì²­ (ì˜ˆì‹œ)
</span><span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì•ˆë…•</span><span class="sh">"</span><span class="p">}],</span>
<span class="p">)</span>

<span class="c1"># í•¨ìˆ˜ ì™¸ë¶€ì—ì„œ ë¬¸ìì—´ ì ‘ê·¼ ê°€ëŠ¥
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">Captured request body (string):</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">captured_request_body</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">Captured response body (string):</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">captured_response_body</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h1 id="3-ë¹„ë™ê¸°async-ì˜ˆì œ--asyncawait-í™˜ê²½ì—ì„œ">3) ë¹„ë™ê¸°(async) ì˜ˆì œ â€” async/await í™˜ê²½ì—ì„œ</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="n">captured_request_body</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">captured_response_body</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">redacted</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="o">==</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">api-key</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">k</span><span class="p">.</span><span class="nf">lower</span><span class="p">():</span>
            <span class="n">redacted</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">REDACTED</span><span class="sh">"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">redacted</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">redacted</span>

<span class="k">def</span> <span class="nf">redact_json_text</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">sensitive</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">apiKey</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">sensitive</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="n">obj</span><span class="p">[</span><span class="n">sensitive</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">REDACTED</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">sensitive</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">apiKey</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">sensitive</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span><span class="p">,</span> <span class="n">sensitive</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=REDACTED</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">request_hook</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Request</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">captured_request_body</span>
    <span class="n">safe_headers</span> <span class="o">=</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">))</span>
    <span class="n">body_str</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">body_str</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">body_str</span> <span class="o">=</span> <span class="nf">repr</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">body_str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">&lt;no request.content available or streaming body&gt;</span><span class="sh">"</span>
    <span class="n">body_str</span> <span class="o">=</span> <span class="nf">redact_json_text</span><span class="p">(</span><span class="n">body_str</span><span class="p">)</span>
    <span class="n">captured_request_body</span> <span class="o">=</span> <span class="n">body_str</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">REQ</span><span class="sh">"</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">url</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">body_str</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">response_hook</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Response</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">captured_response_body</span>
    <span class="n">safe_headers</span> <span class="o">=</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">body_str</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="n">body_str</span> <span class="o">=</span> <span class="nf">repr</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>
    <span class="n">body_str</span> <span class="o">=</span> <span class="nf">redact_json_text</span><span class="p">(</span><span class="n">body_str</span><span class="p">)</span>
    <span class="n">captured_response_body</span> <span class="o">=</span> <span class="n">body_str</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">RES</span><span class="sh">"</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">body_str</span><span class="p">[:</span><span class="mi">2000</span><span class="p">])</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">hooks</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">request_hook</span><span class="p">],</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">response_hook</span><span class="p">]}</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">AsyncClient</span><span class="p">(</span><span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">60.0</span><span class="p">)</span> <span class="k">as</span> <span class="n">async_http</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">http_client</span><span class="o">=</span><span class="n">async_http</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì•ˆë…•</span><span class="sh">"</span><span class="p">}],</span>
        <span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Done</span><span class="sh">"</span><span class="p">)</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h1 id="4-ì£¼ì˜ì‚¬í•­--íŒ-ì¤‘ìš”">4) ì£¼ì˜ì‚¬í•­ &amp; íŒ (ì¤‘ìš”)</h1>

<ul>
  <li>
    <p>ëŒ€ë¶€ë¶„ ê²½ìš° <code class="language-plaintext highlighter-rouge">request.content</code> / <code class="language-plaintext highlighter-rouge">response.content</code>ëŠ” í›…ì—ì„œ ì½ì„ ìˆ˜ ìˆê³  ë¬¸ìì—´ë¡œ ë³€í™˜ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë‹¤ë§Œ <strong>íŒŒì¼ ì—…ë¡œë“œ(ë©€í‹°íŒŒíŠ¸)</strong> í˜¹ì€ <strong>ìŠ¤íŠ¸ë¦¬ë° ë°”ë””</strong> ë¼ë©´ ì²˜ë¦¬ ë°©ì‹ì´ ë‹¬ë¼ì§‘ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ìŠ¤íŠ¸ë¦¬ë°(ì˜ˆ: chunked transfer / SSE)ìœ¼ë¡œ ë™ì‘í•˜ëŠ” ê²½ìš°: í›…ì—ì„œ ì „ì²´ ë°”ë””ê°€ ì•„ì§ ì™„ì„±ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŸ° ìƒí™©ì´ë©´ SDKì˜ ìŠ¤íŠ¸ë¦¬ë° API(ë˜ëŠ” httpxì˜ <code class="language-plaintext highlighter-rouge">stream()</code> ì‚¬ìš©)ë¥¼ ì§ì ‘ ê°ì‹¸ì„œ ê° ì²­í¬ë¥¼ ìº¡ì²˜í•˜ëŠ” ë¡œì§ì„ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤. ì›í•˜ì‹œë©´ ìŠ¤íŠ¸ë¦¬ë° ìº¡ì²˜ ì˜ˆì œë„ ë“œë¦´ê²Œìš”.</p>
  </li>
  <li>
    <p><strong>ë¯¼ê°ì •ë³´ ë³´í˜¸</strong> : ì½˜ì†”/íŒŒì¼ì— ì§ì ‘ ë‚¨ê¸°ë©´ ì•ˆ ë©ë‹ˆë‹¤. ë¡œì»¬ ì „ìš©, ì ‘ê·¼ ì œì–´ëœ í™˜ê²½ì—ì„œë§Œ ë³´ê´€í•˜ì„¸ìš”. ì €ì¥í•´ì•¼ í•œë‹¤ë©´ ë§ˆìŠ¤í‚¹ ë˜ëŠ” ì•”í˜¸í™” ê¶Œì¥.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">event_hooks</code>ì—ì„œ ë°”ë””ë¥¼ ì½ëŠ” ê±´ ì¼ë°˜ì ìœ¼ë¡œ ì•ˆì „í•˜ì§€ë§Œ, ì¼ë¶€ ê²½ìš°(íŠ¹íˆ requestê°€ generator/streamë¡œ ë§Œë“¤ì–´ì¡Œë‹¤ë©´) ì½ìœ¼ë©´ ì›ë˜ ì „ì†¡ì„ ë§ì¹  ìˆ˜ ìˆìœ¼ë‹ˆ ì£¼ì˜í•˜ì„¸ìš”. ìœ„ ì˜ˆì œëŠ” ì¼ë°˜ JSON/í¼/ë©€í‹°íŒŒíŠ¸ ì „ì†¡ì— ì í•©í•©ë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />

<h1 id="5-ì¶”ê°€-ìš”ì²­-ê°€ëŠ¥í•œ-ê²ƒë“¤-ì›í•˜ì‹œë©´-ë°”ë¡œ-ë§Œë“­ë‹ˆë‹¤">5) ì¶”ê°€ ìš”ì²­ ê°€ëŠ¥í•œ ê²ƒë“¤ (ì›í•˜ì‹œë©´ ë°”ë¡œ ë§Œë“­ë‹ˆë‹¤)</h1>

<ul>
  <li>
    <p>ìš”ì²­/ì‘ë‹µì„ <strong>íŒŒì¼ ëŒ€ì‹  ë¬¸ìì—´ ë³€ìˆ˜</strong> ì— ì•ˆì „í•˜ê²Œ ëˆ„ì (rolling buffer)í•˜ëŠ” ë²„ì „</p>
  </li>
  <li>
    <p><strong>ìŠ¤íŠ¸ë¦¬ë°(ì„œë²„-ì „ì†¡ ì´ë²¤íŠ¸)</strong> ì‘ë‹µì„ ì²­í¬ ë‹¨ìœ„ë¡œ ìº¡ì²˜í•´ì„œ ë‹¨ì¼ ë¬¸ìì—´ë¡œ í•©ì¹˜ëŠ” ì˜ˆì œ</p>
  </li>
  <li>
    <p>ë°”ë””ì—ì„œ <strong>íŠ¹ì • í‚¤ë§Œ</strong>(ì˜ˆ: <code class="language-plaintext highlighter-rouge">messages</code> or <code class="language-plaintext highlighter-rouge">prompt</code>)ë§Œ ìº¡ì²˜í•´ì„œ ì €ì¥í•˜ê³  ë‚˜ë¨¸ì§€ëŠ” ë§ˆìŠ¤í‚¹í•˜ëŠ” ì˜ˆì œ</p>
  </li>
  <li>
    <p>ë©€í‹°íŒŒíŠ¸(íŒŒì¼ ì—…ë¡œë“œ) ìš”ì²­ì˜ ê° íŒŒíŠ¸(íŒŒì¼ ë©”íƒ€/ì½˜í…ì¸ )ë¥¼ ìº¡ì²˜í•´ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ëŠ” ì˜ˆì œ</p>
  </li>
</ul>

<p>ì›í•˜ì‹œëŠ” ê±¸ ì•Œë ¤ì£¼ì‹œë©´(ì˜ˆ: ìŠ¤íŠ¸ë¦¬ë° ìº¡ì²˜, ë©€í‹°íŒŒíŠ¸ ì²˜ë¦¬, í˜¹ì€ ë°”ë¡œ ì ìš© ê°€ëŠ¥í•œ <strong>ë§ˆìŠ¤í‚¹ ê·œì¹™</strong>) ì§€ê¸ˆ ë°”ë¡œ ì½”ë“œë¡œ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”. ì–´ë–¤ ê±¸ ë¨¼ì € ë“œë¦´ê¹Œìš”?</p>

<p class="chat--user">

ì „ì—­ ë³€ìˆ˜ ë§ê³  main ì•ˆì—ì„œ ìŠ¤íŠ¸ë§ ì €ì¥í•˜ëŠ” ë°©ë°¥

</p>

<p>ì¢‹ì•„ìš” â€” <strong>ì „ì—­ ë³€ìˆ˜ ì—†ì´<code class="language-plaintext highlighter-rouge">main()</code> ì•ˆì—ì„œ ìš”ì²­/ì‘ë‹µ ë°”ë””ë¥¼ ë¬¸ìì—´ë¡œ ì €ì¥í•˜ëŠ” ë°©ë²•</strong>ì„ ë°”ë¡œ ë“œë¦´ê²Œìš”. í•µì‹¬ì€ <strong>í´ë¡œì €(or ë¡œì»¬ ê°€ë³€ ì»¨í…Œì´ë„ˆ)</strong> ë¥¼ ì‚¬ìš©í•´ í›…ì´ <code class="language-plaintext highlighter-rouge">main</code> ì•ˆì˜ ë³€ìˆ˜ì— ì ‘ê·¼í•˜ê²Œ í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ìŠ¤íŠ¸ë¦¬ë° ì˜ˆì™¸ëŠ” ë§ˆì§€ë§‰ì— ì§§ê²Œ ì–¸ê¸‰í•©ë‹ˆë‹¤.</p>

<p>ì•„ë˜ ì½”ë“œëŠ” (1) ë™ê¸°(synchronous)ì™€ (2) ë¹„ë™ê¸°(async) ë‘ ë²„ì „ ëª¨ë‘ ì œê³µí•˜ê³ , ë¯¼ê°ì •ë³´(Authorization í—¤ë”, ëª‡ëª‡ ë°”ë”” í‚¤)ë¥¼ <strong>ë§ˆìŠ¤í‚¹</strong> í•©ë‹ˆë‹¤. ê·¸ëŒ€ë¡œ ë³µì‚¬í•´ì„œ ì“°ì‹œë©´ ë©ë‹ˆë‹¤.</p>

<h1 id="1-ì›ë¦¬ìš”ì•½-step-by-step">1) ì›ë¦¬(ìš”ì•½, step-by-step)</h1>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">main()</code> ì•ˆì— <code class="language-plaintext highlighter-rouge">captured = {"request": None, "response": None}</code> ê°™ì€ <strong>ê°€ë³€ dict</strong> ë¥¼ ë§Œë“ ë‹¤.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">request_hook</code> / <code class="language-plaintext highlighter-rouge">response_hook</code> í•¨ìˆ˜ëŠ” í´ë¡œì €ë¡œì„œ ê·¸ <code class="language-plaintext highlighter-rouge">captured</code>ë¥¼ ìˆ˜ì •í•œë‹¤. (<code class="language-plaintext highlighter-rouge">nonlocal</code> ë¶ˆí•„ìš” â€” dictëŠ” ê°€ë³€ì´ë¯€ë¡œ)</p>
  </li>
  <li>
    <p>í›…ì—ì„œ <code class="language-plaintext highlighter-rouge">request.content</code> / <code class="language-plaintext highlighter-rouge">response.content</code>ë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜ â†’ ë¯¼ê°ì •ë³´ ë§ˆìŠ¤í‚¹ â†’ <code class="language-plaintext highlighter-rouge">captured[...] = body_str</code> ì €ì¥.</p>
  </li>
  <li>
    <p>ìš”ì²­ì´ ëë‚œ ë’¤ <code class="language-plaintext highlighter-rouge">main()</code>ì—ì„œ <code class="language-plaintext highlighter-rouge">captured</code> ê°’ì„ ì‚¬ìš©(ë˜ëŠ” ë°˜í™˜)í•œë‹¤.</p>
  </li>
</ol>

<hr />

<h1 id="2-ë™ê¸°sync-ì˜ˆì œ">2) ë™ê¸°(sync) ì˜ˆì œ</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="k">def</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="o">==</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">api-key</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">k</span><span class="p">.</span><span class="nf">lower</span><span class="p">():</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">REDACTED</span><span class="sh">"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">redact_json_text</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">sensitive</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">apiKey</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">sensitive</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="n">obj</span><span class="p">[</span><span class="n">sensitive</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">REDACTED</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">sensitive</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">apiKey</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">sensitive</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span><span class="p">,</span> <span class="n">sensitive</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=REDACTED</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1) ë¡œì»¬ ìº¡ì²˜ ì»¨í…Œì´ë„ˆ (ì „ì—­ ì•„ë‹˜)
</span>    <span class="n">captured</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>

    <span class="c1"># 2) í›…ë“¤ (í´ë¡œì €ë¡œ capturedì— ì ‘ê·¼)
</span>    <span class="k">def</span> <span class="nf">request_hook</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Request</span><span class="p">):</span>
        <span class="c1"># headers ë§ˆìŠ¤í‚¹(ì—¬ê¸°ì„œëŠ” ì €ì¥ìš©; ì‹¤ì œ ì¶œë ¥ì€ ì•ˆì „í•˜ê²Œ)
</span>        <span class="n">safe_headers</span> <span class="o">=</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">))</span>
        <span class="c1"># bodyë¥¼ ë¬¸ìì—´ë¡œ ì½ê¸°
</span>        <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">body_str</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">body_str</span> <span class="o">=</span> <span class="nf">repr</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">body_str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">&lt;no request.content available or streaming body&gt;</span><span class="sh">"</span>
        <span class="n">body_str</span> <span class="o">=</span> <span class="nf">redact_json_text</span><span class="p">(</span><span class="n">body_str</span><span class="p">)</span>
        <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">method</span><span class="sh">"</span><span class="p">:</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">url</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="n">safe_headers</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">:</span> <span class="n">body_str</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">response_hook</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Response</span><span class="p">):</span>
        <span class="n">safe_headers</span> <span class="o">=</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">body_str</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
            <span class="c1"># ì˜ˆì˜ê²Œ í¬ë§·(JSONì´ë©´)
</span>            <span class="k">try</span><span class="p">:</span>
                <span class="n">parsed</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">body_str</span><span class="p">)</span>
                <span class="n">body_str</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">parsed</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">body_str</span> <span class="o">=</span> <span class="nf">repr</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>
        <span class="n">body_str</span> <span class="o">=</span> <span class="nf">redact_json_text</span><span class="p">(</span><span class="n">body_str</span><span class="p">)</span>
        <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">status_code</span><span class="sh">"</span><span class="p">:</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="n">safe_headers</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">:</span> <span class="n">body_str</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">hooks</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">request_hook</span><span class="p">],</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">response_hook</span><span class="p">]}</span>
    <span class="n">http_client</span> <span class="o">=</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">Client</span><span class="p">(</span><span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">60.0</span><span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">http_client</span><span class="o">=</span><span class="n">http_client</span><span class="p">)</span>

    <span class="c1"># 3) ì‹¤ì œ í˜¸ì¶œ (ë™ê¸°)
</span>    <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì•ˆë…•í•˜ì„¸ìš”</span><span class="sh">"</span><span class="p">}],</span>
    <span class="p">)</span>

    <span class="c1"># 4) main ë‚´ë¶€ì—ì„œ ë¬¸ìì—´ë¡œ í™œìš© / ì¶œë ¥ / ë°˜í™˜ ê°€ëŠ¥
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Captured request body (string):</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">]</span> <span class="k">else</span> <span class="sh">"</span><span class="s">&lt;none&gt;</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">Captured response body (string):</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">]</span> <span class="k">else</span> <span class="sh">"</span><span class="s">&lt;none&gt;</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">captured</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">captured</span> <span class="o">=</span> <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h1 id="3-ë¹„ë™ê¸°async-ì˜ˆì œ">3) ë¹„ë™ê¸°(async) ì˜ˆì œ</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="k">def</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="o">==</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">api-key</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">k</span><span class="p">.</span><span class="nf">lower</span><span class="p">():</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">REDACTED</span><span class="sh">"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">redact_json_text</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">sensitive</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">apiKey</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">sensitive</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="n">obj</span><span class="p">[</span><span class="n">sensitive</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">REDACTED</span><span class="sh">"</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">sensitive</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">apiKey</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">sensitive</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span><span class="p">,</span> <span class="n">sensitive</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=REDACTED</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">captured</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">request_hook</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Request</span><span class="p">):</span>
        <span class="n">safe_headers</span> <span class="o">=</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">body_str</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">body_str</span> <span class="o">=</span> <span class="nf">repr</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">body_str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">&lt;no request.content available or streaming body&gt;</span><span class="sh">"</span>
        <span class="n">body_str</span> <span class="o">=</span> <span class="nf">redact_json_text</span><span class="p">(</span><span class="n">body_str</span><span class="p">)</span>
        <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">method</span><span class="sh">"</span><span class="p">:</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">url</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="n">safe_headers</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">:</span> <span class="n">body_str</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">response_hook</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Response</span><span class="p">):</span>
        <span class="n">safe_headers</span> <span class="o">=</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">body_str</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">parsed</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">body_str</span><span class="p">)</span>
                <span class="n">body_str</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">parsed</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">body_str</span> <span class="o">=</span> <span class="nf">repr</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>
        <span class="n">body_str</span> <span class="o">=</span> <span class="nf">redact_json_text</span><span class="p">(</span><span class="n">body_str</span><span class="p">)</span>
        <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">status_code</span><span class="sh">"</span><span class="p">:</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="n">safe_headers</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">:</span> <span class="n">body_str</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">hooks</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">request_hook</span><span class="p">],</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">response_hook</span><span class="p">]}</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">AsyncClient</span><span class="p">(</span><span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">60.0</span><span class="p">)</span> <span class="k">as</span> <span class="n">async_http</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">http_client</span><span class="o">=</span><span class="n">async_http</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì•ˆë…•í•˜ì„¸ìš” (async)</span><span class="sh">"</span><span class="p">}],</span>
        <span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Captured request (local):</span><span class="sh">"</span><span class="p">,</span> <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">]</span> <span class="k">else</span> <span class="sh">"</span><span class="s">&lt;none&gt;</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Captured response (local):</span><span class="sh">"</span><span class="p">,</span> <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">]</span> <span class="k">if</span> <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">]</span> <span class="k">else</span> <span class="sh">"</span><span class="s">&lt;none&gt;</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">captured</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h1 id="4-ì£¼ì˜ì‚¬í•­ì¤‘ìš”">4) ì£¼ì˜ì‚¬í•­(ì¤‘ìš”)</h1>

<ul>
  <li>
    <p><strong>ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ</strong>(SSE/ì²­í¬) ë˜ëŠ” <strong>íŒŒì¼ ì—…ë¡œë“œ(ë©€í‹°íŒŒíŠ¸)</strong> ì˜ ê²½ìš° <code class="language-plaintext highlighter-rouge">request.content</code> / <code class="language-plaintext highlighter-rouge">response.content</code>ê°€ í›…ì—ì„œ ë°”ë¡œ ì „ì²´ë¡œ ì½íˆì§€ ì•Šê±°ë‚˜, ì½ìœ¼ë©´ ìŠ¤íŠ¸ë¦¼ì´ ì†Œëª¨ë˜ì–´ ì „ì†¡ì— ì˜í–¥ì´ ìƒê¸¸ ìˆ˜ ìˆìŒ. ê·¸ëŸ° ê²½ìš°ëŠ” <strong>ë³„ë„ ìŠ¤íŠ¸ë¦¬ë° í›…</strong>(ì²­í¬ë§ˆë‹¤ append)ì´ë‚˜ httpxì˜ <code class="language-plaintext highlighter-rouge">stream()</code> ì‚¬ìš© ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤. í•„ìš”í•˜ì‹œë©´ ìŠ¤íŠ¸ë¦¬ë° ë²„ì „ë„ ë°”ë¡œ ì œê³µí• ê²Œìš”.</p>
  </li>
  <li>
    <p>í›…ì—ì„œ ë°”ë””ë¥¼ ì½ëŠ” í–‰ìœ„ê°€ ì¼ë¶€ ì „ì†¡ íŒŒì´í”„ë¼ì¸ì„ ë°”ê¿€ ìˆ˜ ìˆìœ¼ë‹ˆ(íŠ¹íˆ generator/íŒŒì¼ ìŠ¤íŠ¸ë¦¼ ì „ì†¡) ì•ˆì „í•œ í™˜ê²½ì—ì„œ ë¨¼ì € í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”.</p>
  </li>
  <li>
    <p>ë¡œê·¸/íŒŒì¼ì— ì €ì¥í•˜ë©´ API í‚¤ë‚˜ ë¯¼ê°í•œ ì‚¬ìš©ì ì…ë ¥ì´ ìœ ì¶œë  ìˆ˜ ìˆìœ¼ë‹ˆ <strong>ë¡œì»¬ ì „ìš© ë˜ëŠ” ì ‘ê·¼ ì œí•œ í™˜ê²½</strong> ì—ì„œë§Œ ì €ì¥í•˜ì„¸ìš”.</p>
  </li>
</ul>

<hr />

<p>ì›í•˜ì‹œë©´:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">messages</code> í•„ë“œ(í”„ë¡¬í”„íŠ¸)ë§Œ ìº¡ì²˜í•˜ê³  ë‚˜ë¨¸ì§€ëŠ” ì™„ì „ ë§ˆìŠ¤í‚¹í•˜ëŠ” ë²„ì „</p>
  </li>
  <li>
    <p><strong>ì²­í¬ ìŠ¤íŠ¸ë¦¬ë°</strong>(streaming response)ì„ ë¡œì»¬ ë¬¸ìì—´ë¡œ í•©ì¹˜ëŠ” ì˜ˆì œ</p>
  </li>
  <li>
    <p>ë©€í‹°íŒŒíŠ¸(íŒŒì¼ ì—…ë¡œë“œ)ì—ì„œ ê° íŒŒíŠ¸ ë³„ë¡œ ë¬¸ìì—´ë¡œ ì €ì¥í•˜ëŠ” ì˜ˆì œ</p>
  </li>
</ul>

<p>ì´ ì¤‘ ì–´ë–¤ ê±¸ ë¨¼ì € ë“œë¦´ê¹Œìš”?</p>

<p class="chat--user">

response.aread()ë¥¼ í•´ì•¼ ì½ì„ ìˆ˜ ìˆëŠ”ê±° ì•„ë‹ˆì•¼?

</p>

<p>ì¢‹ì€ ì§€ì ì…ë‹ˆë‹¤ â€” ìƒí™©ì— ë”°ë¼ <strong><code class="language-plaintext highlighter-rouge">response.aread()</code>ë¥¼ <code class="language-plaintext highlighter-rouge">await</code>í•´ì•¼ë§Œ ë°”ë””ë¥¼ ì½ì„ ìˆ˜ ìˆëŠ” ê²½ìš°</strong>ê°€ ë§ìŠµë‹ˆë‹¤. ìš”ì ë§Œ ë¨¼ì € ì •ë¦¬í•˜ê³ , ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” ì½”ë“œ ì˜ˆì œ(ë¹„ë™ê¸° í›…ì—ì„œ <code class="language-plaintext highlighter-rouge">await response.aread()</code> ì‚¬ìš©)ë¥¼ ë³´ì—¬ë“œë¦´ê²Œìš”.</p>

<h1 id="í•µì‹¬-ìš”ì•½">í•µì‹¬ ìš”ì•½</h1>

<ol>
  <li>
    <p><strong>ë™ê¸°(httpx.Client)</strong> : í›…ì—ì„œ <code class="language-plaintext highlighter-rouge">response.content</code>ë¥¼ ì½ìœ¼ë©´ ë‚´ë¶€ì—ì„œ ë‚´ìš©ì„ ê°€ì ¸ì™€ ìºì‹œí•˜ë¯€ë¡œ ë°”ë¡œ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>ë¹„ë™ê¸°(httpx.AsyncClient)</strong> : í›…ì´ <code class="language-plaintext highlighter-rouge">async def</code>ì´ë©´ <code class="language-plaintext highlighter-rouge">await response.aread()</code>ë¡œ ë°”ë””(ë°”ì´íŠ¸)ë¥¼ ê°€ì ¸ì™€ì•¼ ì•ˆì „í•©ë‹ˆë‹¤. (<code class="language-plaintext highlighter-rouge">response.content</code>ëŠ” ë™ê¸° ì†ì„±ì´ë¼ async ì»¨í…ìŠ¤íŠ¸ì—ì„  ê¶Œì¥ë˜ì§€ ì•ŠìŒ.)</p>
  </li>
  <li>
    <p><strong>ì£¼ì˜ â€” ìŠ¤íŠ¸ë¦¬ë°(SSE / chunked / streaming API)</strong> : <code class="language-plaintext highlighter-rouge">aread()</code>ëŠ” <strong>ì „ì²´ ë°”ë””ë¥¼ í•œ ë²ˆì—</strong> ì½ìŠµë‹ˆë‹¤. ë§Œì•½ ì‘ë‹µì´ ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°(ì˜ˆ: ì„œë²„-ì „ì†¡-ì´ë²¤íŠ¸)ì´ë¼ë©´ <code class="language-plaintext highlighter-rouge">aread()</code>ë¡œ ì „ì²´ë¥¼ ì½ì–´ë²„ë¦¬ë©´ ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬ë¥¼ ë§ì¹  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìŠ¤íŠ¸ë¦¬ë°ì€ <code class="language-plaintext highlighter-rouge">response.aiter_bytes()</code> / <code class="language-plaintext highlighter-rouge">response.aiter_text()</code>ë¡œ ì²­í¬ ë‹¨ìœ„ë¡œ ì²˜ë¦¬í•˜ì„¸ìš”.</p>
  </li>
  <li>
    <p>httpxëŠ” í•œ ë²ˆ ì½ì€ ë°”ë””ë¥¼ ìºì‹œí•˜ë¯€ë¡œ <code class="language-plaintext highlighter-rouge">aread()</code>ë¡œ ì½ì€ ë’¤ì—ë„ <code class="language-plaintext highlighter-rouge">response.content</code>/<code class="language-plaintext highlighter-rouge">response.text</code>ë¡œ ì ‘ê·¼í•´ë„ ë©ë‹ˆë‹¤(ëŒ€ë¶€ë¶„ì˜ ê²½ìš°).</p>
  </li>
</ol>

<hr />

<h1 id="ë°”ë¡œ-ì“¸-ìˆ˜-ìˆëŠ”-ë¹„ë™ê¸°-í›…-ì˜ˆì œ-await-responsearead-ì‚¬ìš©">ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” ë¹„ë™ê¸° í›… ì˜ˆì œ (<code class="language-plaintext highlighter-rouge">await response.aread()</code> ì‚¬ìš©)</h1>

<p>ì•„ë˜ëŠ” ì´ì „ ì˜ˆì œì˜ <code class="language-plaintext highlighter-rouge">response_hook</code>ë¥¼ <code class="language-plaintext highlighter-rouge">await response.aread()</code> ë¡œ ì•ˆì „í•˜ê²Œ ë°”ê¾¼ ì½”ë“œì…ë‹ˆë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="k">def</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="o">==</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">api-key</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">k</span><span class="p">.</span><span class="nf">lower</span><span class="p">():</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">REDACTED</span><span class="sh">"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">redact_text</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="c1"># ê°„ë‹¨ ë§ˆìŠ¤í‚¹ ì˜ˆì‹œ
</span>    <span class="k">for</span> <span class="n">sensitive</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">apiKey</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">sensitive</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=</span><span class="sh">"</span><span class="p">,</span> <span class="n">sensitive</span> <span class="o">+</span> <span class="sh">"</span><span class="s">=REDACTED</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">apiKey</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="n">obj</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">REDACTED</span><span class="sh">"</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">text</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">captured</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">request_hook</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Request</span><span class="p">):</span>
        <span class="c1"># request.contentëŠ” ì´ë¯¸ bytesì¼ ê°€ëŠ¥ì„± ë†’ìŒ
</span>        <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">body_str</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">body_str</span> <span class="o">=</span> <span class="nf">repr</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">body_str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">&lt;no request.content available or streaming body&gt;</span><span class="sh">"</span>
        <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">method</span><span class="sh">"</span><span class="p">:</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">url</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">)),</span>
            <span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">:</span> <span class="nf">redact_text</span><span class="p">(</span><span class="n">body_str</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">response_hook</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Response</span><span class="p">):</span>
        <span class="c1"># ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µì¸ì§€ ê°„ë‹¨ ì²´í¬ (Content-Type ë˜ëŠ” Transfer-Encoding ì°¸ê³ )
</span>        <span class="n">ct</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">te</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">transfer-encoding</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">is_streaming</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">text/event-stream</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">ct</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="sh">"</span><span class="s">chunked</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">te</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_streaming</span><span class="p">:</span>
            <span class="c1"># ìŠ¤íŠ¸ë¦¬ë°ì€ ì „ì²´ aread() í•˜ì§€ ì•Šê³  ì²­í¬ ë‹¨ìœ„ë¡œ ì²˜ë¦¬í•´ì•¼ í•¨
</span>            <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">response</span><span class="p">.</span><span class="nf">aiter_bytes</span><span class="p">():</span>
                <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="n">body_bytes</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ì¼ë°˜ì ì¸ ë¹„ë™ê¸° ì‘ë‹µ: ì „ì²´ ë°”ë””ë¥¼ ì•ˆì „í•˜ê²Œ ì½ìŒ
</span>            <span class="n">body_bytes</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="p">.</span><span class="nf">aread</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">body_str</span> <span class="o">=</span> <span class="n">body_bytes</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">body_str</span> <span class="o">=</span> <span class="nf">repr</span><span class="p">(</span><span class="n">body_bytes</span><span class="p">)</span>

        <span class="c1"># ì˜ˆì˜ê²Œ JSON í¬ë§· ì‹œë„
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">parsed</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">body_str</span><span class="p">)</span>
            <span class="n">body_str</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">parsed</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">status_code</span><span class="sh">"</span><span class="p">:</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">)),</span>
            <span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">:</span> <span class="nf">redact_text</span><span class="p">(</span><span class="n">body_str</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="n">hooks</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">request_hook</span><span class="p">],</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">response_hook</span><span class="p">]}</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">AsyncClient</span><span class="p">(</span><span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">60.0</span><span class="p">)</span> <span class="k">as</span> <span class="n">async_http</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">http_client</span><span class="o">=</span><span class="n">async_http</span><span class="p">)</span>
        <span class="c1"># OpenAI í˜¸ì¶œ(ë¹„ë™ê¸°)
</span>        <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì•ˆë…•í•˜ì„¸ìš” (async aread ì˜ˆì œ)</span><span class="sh">"</span><span class="p">}],</span>
        <span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Captured request:</span><span class="sh">"</span><span class="p">,</span> <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">])</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Captured response:</span><span class="sh">"</span><span class="p">,</span> <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">][:</span><span class="mi">2000</span><span class="p">]</span> <span class="k">if</span> <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">]</span> <span class="k">else</span> <span class="sh">"</span><span class="s">&lt;none&gt;</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h1 id="ì¶”ê°€-íŒ--ì£¼ì˜">ì¶”ê°€ íŒ / ì£¼ì˜</h1>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">await response.aread()</code>ëŠ” <strong>ì‘ë‹µì´ ì´ë¯¸ ì–´ëŠ ì •ë„ ì½í˜€ìˆì§€ ì•Šë‹¤ë©´ ì „ì²´ ë°”ë””ë¥¼ í•œ ë²ˆì—</strong> ì½ì–´ ìºì‹œí•©ë‹ˆë‹¤. ëŒ€ë¶€ë¶„ì˜ REST í˜¸ì¶œ(ì „ì²´ ë°”ë””ê°€ ì‘ìŒ)ì—ëŠ” ì´ ë°©ë²•ì´ í¸í•˜ê³  ì•ˆì „í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>ìŠ¤íŠ¸ë¦¬ë° API</strong>(SSE, OpenAIì˜ ì¼ë¶€ ìŠ¤íŠ¸ë¦¬ë° ì¸í„°í˜ì´ìŠ¤ ë“±)ëŠ” <code class="language-plaintext highlighter-rouge">aread()</code>ë¡œ ì½ì–´ë²„ë¦¬ë©´ ìŠ¤íŠ¸ë¦¼ ì†Œë¹„ë¡œ ì¸í•´ ì›ë˜ ì˜ë„í•œ ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬(ì‹¤ì‹œê°„ ì²­í¬ ìˆ˜ì‹ )ê°€ ë¶ˆê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤. ê·¸ëŸ´ ë• <code class="language-plaintext highlighter-rouge">aiter_bytes()</code>/<code class="language-plaintext highlighter-rouge">aiter_text()</code>ë¡œ ì²­í¬ë¥¼ ìˆœíšŒí•˜ê±°ë‚˜ SDKê°€ ì œê³µí•˜ëŠ” ìŠ¤íŠ¸ë¦¬ë° ì½œë°±ì„ ì‚¬ìš©í•˜ì„¸ìš”.</p>
  </li>
  <li>
    <p>httpxëŠ” ë°”ë””ë¥¼ ì½ì–´ ìºì‹œì— ë³´ê´€í•˜ë‹ˆ, í›…ì—ì„œ <code class="language-plaintext highlighter-rouge">aread()</code>ë¡œ ì½ì–´ë„ ì´í›„ì— <code class="language-plaintext highlighter-rouge">response.text</code>/<code class="language-plaintext highlighter-rouge">response.json()</code>ë¡œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê¸´ í•©ë‹ˆë‹¤(ì¼ë°˜ì  ë™ì‘).</p>
  </li>
</ul>

<hr />

<p>ì›í•˜ì‹œë©´ ì§€ê¸ˆ ë°”ë¡œ:</p>

<ul>
  <li>
    <p><strong>ìŠ¤íŠ¸ë¦¬ë°(ì„œë²„-ì „ì†¡-ì´ë²¤íŠ¸)</strong> ë¥¼ ì²­í¬ ë‹¨ìœ„ë¡œ ì•ˆì „í•˜ê²Œ ìº¡ì²˜í•´ <code class="language-plaintext highlighter-rouge">main()</code> ì•ˆì˜ ë¬¸ìì—´ë¡œ í•©ì¹˜ëŠ” ì˜ˆì œ,</p>
  </li>
  <li>
    <p>í˜¹ì€ <strong>OpenAI SDKì˜ ìŠ¤íŠ¸ë¦¬ë°(ì˜ˆ:<code class="language-plaintext highlighter-rouge">stream=True</code>)</strong> ì— íŠ¹í™”ëœ ìº¡ì²˜ ì½”ë“œ(ì²­í¬ë§ˆë‹¤ ì²˜ë¦¬í•´ì„œ ë‹¨ì¼ ë¬¸ìì—´ë¡œ ê²°í•©)ë„ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”. ì–´ë–¤ ê±¸ ì›í•˜ì‹œë‚˜ìš”?</p>
  </li>
</ul>

<p class="chat--user">

1. requestìª½ í•œê¸€ì´ ê¹¨ì ¸ë³´ì—¬. ê·¸ë¦¬ê³  ì—¬ê¸°ë„ areadë¡œ ë°”ê¿”ì¤˜. 2. bodyìª½ ë‚´ìš©ì´ ëª¨ë‘ í•˜ë‚˜ì˜ stringìœ¼ë¡œë§Œ ë‚˜ì™€ì„œ ì½ê¸°ê°€ í˜ë“¤ì–´. ê·¸ëƒ¥ nested jsonìœ¼ë¡œ ë³´ì´ëŠ”ê²Œ ì½ê¸° í¸í•  ê²ƒ ê°™ì•„.

</p>

<p>ì¢‹ì€ í¬ì¸íŠ¸ ë‘ ê°€ì§€ ì •ë¦¬í•´ì„œ ë°”ë¡œ ë°˜ì˜í–ˆì–´ìš”.</p>

<ul>
  <li>
    <p><strong>(1) ìš”ì²­(request) ìª½ í•œê¸€ ê¹¨ì§</strong> â†’ <code class="language-plaintext highlighter-rouge">Content-Type</code>ì˜ <code class="language-plaintext highlighter-rouge">charset</code>ì„ í™•ì¸í•´ <strong>ì •í™•í•œ ì¸ì½”ë”©</strong> ìœ¼ë¡œ ë””ì½”ë”©í•˜ê³ , ê¸°ë³¸ê°’ì€ <code class="language-plaintext highlighter-rouge">utf-8</code>ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤. (OpenAI SDKëŠ” JSON ë°”ë””ë¥¼ ê¸°ë³¸ì ìœ¼ë¡œ UTF-8ë¡œ ë³´ëƒ…ë‹ˆë‹¤.)</p>
  </li>
  <li>
    <p><strong>(2) bodyë¥¼ â€œí•œ ì¤„ì§œë¦¬ ë¬¸ìì—´â€ì´ ì•„ë‹ˆë¼ â€œì¤‘ì²© JSON(íŒŒì´ì¬ dict)â€</strong> ìœ¼ë¡œ ì €ì¥ â†’ íŒŒì‹±ì´ ë˜ë©´ <code class="language-plaintext highlighter-rouge">dict/list</code>ë¡œ ì €ì¥í•˜ê³ , ì•ˆ ë˜ë©´ í…ìŠ¤íŠ¸ ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤.</p>
  </li>
</ul>

<p>ë˜, <strong>ì‘ë‹µ(response)</strong> ì€ ë¹„ë™ê¸° í™˜ê²½ì—ì„œ í™•ì‹¤íˆ <code class="language-plaintext highlighter-rouge">await response.aread()</code>ë¡œ ì½ë„ë¡ ë°”ê¿¨ìŠµë‹ˆë‹¤.<br />
<strong>ìš”ì²­(request)</strong> ê°ì²´ëŠ” httpxì—ì„œ <code class="language-plaintext highlighter-rouge">aread()</code>ê°€ ì—†ì–´ì„œ(ì‘ë‹µì—ë§Œ ìˆìŒ) ëŒ€ì‹  <strong>ë°”ì´íŠ¸ ë°”ë””ë¥¼ ì •í™•í•œ ì¸ì½”ë”©ìœ¼ë¡œ ë””ì½”ë”©</strong> í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤. (OpenAI SDKì²˜ëŸ¼ ì¼ë°˜ JSON ìš”ì²­ì´ë©´ <code class="language-plaintext highlighter-rouge">request.content</code>ì—ì„œ ì•ˆì „í•˜ê²Œ ì½í™ë‹ˆë‹¤. ì§„ì§œ â€œìŠ¤íŠ¸ë¦¬ë° ì—…ë¡œë“œâ€ë¥¼ í•˜ì‹ ë‹¤ë©´ ë³„ë„ tee ë˜í¼ê°€ í•„ìš”í•©ë‹ˆë‹¤â€”ì•„ë˜ì— ê°„ë‹¨ ì£¼ì„ ìˆìŠµë‹ˆë‹¤.)</p>

<hr />

<h3 id="ì—…ë°ì´íŠ¸ëœ-ë¹„ë™ê¸°-ì˜ˆì œ-ì „ì—­-ë³€ìˆ˜-ì—†ì´-main-ë‚´ë¶€-ë³´ê´€-request-í•œê¸€ì¸ì½”ë”©-ê°œì„ -responseëŠ”-aread-ì‚¬ìš©-bodyëŠ”-nested-jsonìœ¼ë¡œ-ì €ì¥">ì—…ë°ì´íŠ¸ëœ ë¹„ë™ê¸° ì˜ˆì œ (ì „ì—­ ë³€ìˆ˜ ì—†ì´ <code class="language-plaintext highlighter-rouge">main()</code> ë‚´ë¶€ ë³´ê´€, request í•œê¸€/ì¸ì½”ë”© ê°œì„ , responseëŠ” <code class="language-plaintext highlighter-rouge">aread()</code> ì‚¬ìš©, bodyëŠ” nested JSONìœ¼ë¡œ ì €ì¥)</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="k">def</span> <span class="nf">pick_charset</span><span class="p">(</span><span class="n">content_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="c1"># e.g. "application/json; charset=utf-8"
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">content_type</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">content_type</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">;</span><span class="sh">"</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">charset=</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">p</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nf">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="n">default</span>
    <span class="k">return</span> <span class="n">default</span>

<span class="k">def</span> <span class="nf">try_parse_json</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="o">==</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">api-key</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">k</span><span class="p">.</span><span class="nf">lower</span><span class="p">():</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">REDACTED</span><span class="sh">"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">redact_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="c1"># dict/listë¥¼ ì¬ê·€ì ìœ¼ë¡œ ëŒë©° ë¯¼ê° í‚¤ ë§ˆìŠ¤í‚¹
</span>    <span class="n">SENSITIVE_KEYS</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">apiKey</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">REDACTED</span><span class="sh">"</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">SENSITIVE_KEYS</span> <span class="k">else</span> <span class="nf">redact_obj</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nf">redact_obj</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">obj</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">captured</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">request_hook</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Request</span><span class="p">):</span>
        <span class="c1"># 1) charset ê²°ì •
</span>        <span class="n">req_ct</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">req_charset</span> <span class="o">=</span> <span class="nf">pick_charset</span><span class="p">(</span><span class="n">req_ct</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># 2) ë°”ë”” ë°”ì´íŠ¸ â†’ í…ìŠ¤íŠ¸
</span>        <span class="c1">#    (OpenAI SDKì˜ JSON í˜¸ì¶œì´ë¼ë©´ request.contentê°€ bytesë¡œ ì±„ì›Œì ¸ ìˆìŠµë‹ˆë‹¤)
</span>        <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">body_text</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">req_charset</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="c1"># í˜¹ì‹œ ëª¨ë¥¼ ì¸ì½”ë”© ì´ìŠˆ ëŒ€ë¹„: ë§ˆì§€ë§‰ fallback
</span>                <span class="n">body_text</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ìŠ¤íŠ¸ë¦¬ë° ì—…ë¡œë“œ(ì œë„ˆë ˆì´í„°/íŒŒì¼ ìŠ¤íŠ¸ë¦¼ ë“±)ì¸ ê²½ìš° ì—¬ê¸°ì— Noneì´ ë“¤ì–´ì˜µë‹ˆë‹¤.
</span>            <span class="c1"># ê·¸ëŸ° ê²½ìš°, ë³„ë„ "tee stream" ë˜í¼ë¡œ `request.stream`ì„ ê°ì‹¸ì„œ ì „ì†¡ë˜ë©° ìº¡ì²˜í•´ì•¼ í•©ë‹ˆë‹¤.
</span>            <span class="n">body_text</span> <span class="o">=</span> <span class="sh">"</span><span class="s">&lt;streaming or no request.content&gt;</span><span class="sh">"</span>

        <span class="c1"># 3) nested JSONìœ¼ë¡œ ì €ì¥(ê°€ëŠ¥í•˜ë©´)
</span>        <span class="n">body_obj</span> <span class="o">=</span> <span class="nf">try_parse_json</span><span class="p">(</span><span class="n">body_text</span><span class="p">)</span>
        <span class="n">body_saved</span> <span class="o">=</span> <span class="nf">redact_obj</span><span class="p">(</span><span class="n">body_obj</span><span class="p">)</span> <span class="k">if</span> <span class="n">body_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">body_text</span>  <span class="c1"># dict/listë©´ ë§ˆìŠ¤í‚¹, ì•„ë‹ˆë©´ ì›ë¬¸
</span>
        <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">method</span><span class="sh">"</span><span class="p">:</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">url</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">)),</span>
            <span class="c1"># ë¬¸ìì—´ì´ ì•„ë‹ˆë¼, ê°€ëŠ¥í•˜ë©´ dict/listë¡œ ì €ì¥ë©ë‹ˆë‹¤.
</span>            <span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">:</span> <span class="n">body_saved</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">response_hook</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Response</span><span class="p">):</span>
        <span class="c1"># 1) ì „ì²´ ë°”ë””ë¥¼ ë¹„ë™ê¸°ë¡œ ì•ˆì „í•˜ê²Œ ì½ìŒ
</span>        <span class="n">body_bytes</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="p">.</span><span class="nf">aread</span><span class="p">()</span>

        <span class="c1"># 2) charset ê²°ì •
</span>        <span class="n">res_ct</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">res_charset</span> <span class="o">=</span> <span class="nf">pick_charset</span><span class="p">(</span><span class="n">res_ct</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># 3) ë°”ë”” ë°”ì´íŠ¸ â†’ í…ìŠ¤íŠ¸
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">body_text</span> <span class="o">=</span> <span class="n">body_bytes</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">res_charset</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">body_text</span> <span class="o">=</span> <span class="n">body_bytes</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># 4) nested JSONìœ¼ë¡œ ì €ì¥(ê°€ëŠ¥í•˜ë©´)
</span>        <span class="n">body_obj</span> <span class="o">=</span> <span class="nf">try_parse_json</span><span class="p">(</span><span class="n">body_text</span><span class="p">)</span>
        <span class="n">body_saved</span> <span class="o">=</span> <span class="nf">redact_obj</span><span class="p">(</span><span class="n">body_obj</span><span class="p">)</span> <span class="k">if</span> <span class="n">body_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">body_text</span>

        <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">status_code</span><span class="sh">"</span><span class="p">:</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">)),</span>
            <span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">:</span> <span class="n">body_saved</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">hooks</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">request_hook</span><span class="p">],</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">response_hook</span><span class="p">]}</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">AsyncClient</span><span class="p">(</span><span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">60.0</span><span class="p">)</span> <span class="k">as</span> <span class="n">async_http</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">http_client</span><span class="o">=</span><span class="n">async_http</span><span class="p">)</span>

        <span class="c1"># ì‹¤ì œ í˜¸ì¶œ(ì˜ˆ: chat.completions)
</span>        <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">í•œê¸€ì´ ì œëŒ€ë¡œ ë³´ì´ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤ ğŸ˜Š</span><span class="sh">"</span><span class="p">}],</span>
        <span class="p">)</span>

    <span class="c1"># ì—¬ê¸°ì„œ captured["request"]["body"], captured["response"]["body"]ëŠ”
</span>    <span class="c1"># ê°€ëŠ¥í•œ ê²½ìš° "ì¤‘ì²© JSON(dict/list)"ë¡œ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
</span>    <span class="c1"># (JSONì´ ì•„ë‹ˆë©´ ë””ì½”ë”©ëœ í…ìŠ¤íŠ¸ ë¬¸ìì—´)
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">REQUEST (nested JSON or text):</span><span class="sh">"</span><span class="p">,</span> <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">])</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">RESPONSE (nested JSON or text):</span><span class="sh">"</span><span class="p">,</span> <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">captured</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<hr />

<h3 id="ìŠ¤íŠ¸ë¦¬ë°-ì—…ë¡œë“œë‹¤ìš´ë¡œë“œë¥¼-ì“°ëŠ”-íŠ¹ìˆ˜-ì¼€ì´ìŠ¤">ìŠ¤íŠ¸ë¦¬ë° ì—…ë¡œë“œ/ë‹¤ìš´ë¡œë“œë¥¼ ì“°ëŠ” íŠ¹ìˆ˜ ì¼€ì´ìŠ¤</h3>

<ul>
  <li>
    <p><strong>ìš”ì²­ì´ ìŠ¤íŠ¸ë¦¬ë° ì—…ë¡œë“œ</strong>(íŒŒì¼ ì œë„ˆë ˆì´í„° ë“±)ë©´ <code class="language-plaintext highlighter-rouge">request.content</code>ê°€ <code class="language-plaintext highlighter-rouge">None</code>ì¼ ìˆ˜ ìˆì–´ìš”. ì´ë•ŒëŠ” <code class="language-plaintext highlighter-rouge">request.stream</code>(ë¹„ê³µê°œ êµ¬í˜„ì¼ ìˆ˜ ìˆìŒ)ì„ <strong>tee ë˜í¼</strong> ë¡œ ê°ì‹¸ì„œ ì „ì†¡ë˜ëŠ” ë°”ì´íŠ¸ë¥¼ ì˜†ì—ì„œ ëª¨ì•„ì•¼ í•©ë‹ˆë‹¤. í•„ìš”í•˜ì‹œë©´ tee ë˜í¼(ë¹„ë™ê¸° ì œë„ˆë ˆì´í„°ë¡œ ê°ì‹¸ì„œ bytesë¥¼ <code class="language-plaintext highlighter-rouge">yield</code>í•˜ë©´ì„œ ë‚´ë¶€ ë²„í¼ì—ë„ <code class="language-plaintext highlighter-rouge">append</code>) ì½”ë“œë¥¼ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”.</p>
  </li>
  <li>
    <p><strong>ì‘ë‹µì´ ìŠ¤íŠ¸ë¦¬ë°(SSE/ì²­í¬)</strong> ì´ë©´ <code class="language-plaintext highlighter-rouge">await response.aread()</code>ë¡œ í•œ ë²ˆì— ì½ì§€ ë§ê³ , <code class="language-plaintext highlighter-rouge">async for chunk in response.aiter_bytes():</code> ì‹ìœ¼ë¡œ <strong>ì²­í¬ë¥¼ ëˆ„ì </strong> í•´ nested JSONìœ¼ë¡œ ë³µì›(ê°€ëŠ¥ì‹œ)í•˜ê±°ë‚˜, ì²­í¬ ë¦¬ìŠ¤íŠ¸ë¥¼ í•©ì³ì„œ ë‚˜ì¤‘ì— <code class="language-plaintext highlighter-rouge">json.loads()</code>ë¥¼ ì‹œë„í•˜ì„¸ìš”. ì´ê²ƒë„ ì›í•˜ì‹œë©´ ë°”ë¡œ ì˜ˆì œ ë“œë¦´ê²Œìš”.</p>
  </li>
</ul>

<hr />

<p>í•„ìš”í•˜ì‹  ê²½ìš°:</p>

<ul>
  <li>
    <p><strong>ìš”ì²­/ì‘ë‹µ ëª¨ë‘ â€œë°˜ë“œì‹œ dictë¡œë§Œ ë³´ê´€â€</strong>í•˜ë„ë¡ ê°•ì œí•˜ëŠ” ë²„ì „</p>
  </li>
  <li>
    <p><strong>íŠ¹ì • í‚¤ë§Œ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ ë§ˆìŠ¤í‚¹</strong>(ì˜ˆ: <code class="language-plaintext highlighter-rouge">messages</code>ë§Œ ìœ ì§€)</p>
  </li>
  <li>
    <p><strong>ìŠ¤íŠ¸ë¦¬ë° ì—…/ë‹¤ìš´ë¡œë“œ tee ë˜í¼</strong></p>
  </li>
</ul>

<p>ì–´ë–¤ ê±¸ ë” ì›í•˜ì„¸ìš”?</p>

<p class="chat--user">

ì°¸ê³ ë¡œ body_strì„ json.loadí•˜ê³  dump í•˜ë‹ˆ í•œê¸€ì´ ì œëŒ€ë¡œ ë³´ì˜€ì—ˆì–´.

</p>

<p>ë§ì•„ìš” â€” <strong><code class="language-plaintext highlighter-rouge">json.loads()</code> â†’ <code class="language-plaintext highlighter-rouge">json.dumps()</code></strong> ë¥¼ ê±°ì¹˜ë©´ í•œê¸€ì´ â€œì •ìƒ ê¸€ìâ€ë¡œ ë³´ì´ëŠ” ì´ìœ ê°€ ìˆìŠµë‹ˆë‹¤. í•µì‹¬ë§Œ ì •ë¦¬í•˜ê³ , ë°”ë¡œ ì ìš© ê°€ëŠ¥í•œ íŒ¨ì¹˜ë„ ë“œë¦´ê²Œìš”.</p>

<h1 id="ì™œ-load--dump-í•˜ë©´-í•œê¸€ì´-ì œëŒ€ë¡œ-ë³´ì¼ê¹Œ">ì™œ load â†’ dump í•˜ë©´ í•œê¸€ì´ ì œëŒ€ë¡œ ë³´ì¼ê¹Œ?</h1>

<ol>
  <li>
    <p><strong>ìš”ì²­/ì‘ë‹µ ë°”ì´íŠ¸ë¥¼ ì˜¬ë°”ë¥¸ ë¬¸ìì…‹(ëŒ€ê°œ UTF-8)</strong> ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">str</code>ë¡œ ë””ì½”ë”©í•´ì•¼ í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">json.loads()</code>ë¡œ íŒŒì‹±í•˜ë©´ <strong>íŒŒì´ì¬ ë‚´ë¶€ ê°ì²´(dict/list)</strong> ê°€ ë©ë‹ˆë‹¤. ì´ ìƒíƒœì—ì„œëŠ” í•œê¸€ì´ ì´ë¯¸ ìœ ë‹ˆì½”ë“œë¡œ ì˜¬ë°”ë¥´ê²Œ ë³´ì¡´ë¼ ìˆì–´ìš”.</p>
  </li>
  <li>
    <p>ê·¸ëŸ°ë° <code class="language-plaintext highlighter-rouge">json.dumps()</code>ì˜ ê¸°ë³¸ê°’ì€ <code class="language-plaintext highlighter-rouge">ensure_ascii=True</code>ë¼ì„œ, <strong>ë¹„ ASCII ë¬¸ìë¥¼<code class="language-plaintext highlighter-rouge">\uXXXX</code>ë¡œ ì´ìŠ¤ì¼€ì´í”„</strong>í•©ë‹ˆë‹¤.<br />
â†’ ì´ëŸ¬ë©´ ë‹¤ì‹œ â€œê¹¨ì ¸ ë³´ì´ê±°ë‚˜â€ <code class="language-plaintext highlighter-rouge">\uac00</code> ê°™ì€ ì½”ë“œê°’ìœ¼ë¡œ ë³´ì¼ ìˆ˜ ìˆì£ .</p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">ensure_ascii=False</code>ë¡œ <code class="language-plaintext highlighter-rouge">json.dumps(..., ensure_ascii=False, indent=2)</code></strong> ë¥¼ ì“°ë©´ í•œê¸€ì´ ê·¸ëŒ€ë¡œ ì¶œë ¥ë©ë‹ˆë‹¤(ì´ìŠ¤ì¼€ì´í”„ ì—†ì´).</p>
  </li>
</ol>

<blockquote>
  <p>ì¦‰, â€œë””ì½”ë”© â†’ íŒŒì‹± â†’ <code class="language-plaintext highlighter-rouge">ensure_ascii=False</code>ë¡œ ì§ë ¬í™”â€ ìˆœì„œê°€ ì¤‘ìš”í•©ë‹ˆë‹¤.</p>
</blockquote>

<hr />

<h1 id="ë°”ë¡œ-ì ìš©-1-nested-json-ì €ì¥--2-ë³´ê¸°-ì¢‹ê²Œ-ì¶œë ¥ensure_asciifalse">ë°”ë¡œ ì ìš©: (1) nested JSON ì €ì¥ + (2) ë³´ê¸° ì¢‹ê²Œ ì¶œë ¥(ensure_ascii=False)</h1>

<p>ì•„ë˜ëŠ” ì•ì„œ ë“œë¦° ë¹„ë™ê¸° í›… ì˜ˆì œì—ì„œ, <strong>nested JSONìœ¼ë¡œ ì €ì¥</strong> í•˜ê³  <strong>ë³¼ ë•ŒëŠ”<code class="language-plaintext highlighter-rouge">ensure_ascii=False</code>ë¡œ ë¤í”„</strong>í•˜ë„ë¡ ì‚´ì§ ì† ë³¸ ë²„ì „ì…ë‹ˆë‹¤. (ì‘ë‹µì€ <code class="language-plaintext highlighter-rouge">await response.aread()</code> ìœ ì§€)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">httpx</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>
<span class="kn">import</span> <span class="n">sys</span>

<span class="k">def</span> <span class="nf">pick_charset</span><span class="p">(</span><span class="n">content_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">content_type</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">content_type</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">;</span><span class="sh">"</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">charset=</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">p</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nf">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="n">default</span>
    <span class="k">return</span> <span class="n">default</span>

<span class="k">def</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span> <span class="o">==</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">api-key</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">k</span><span class="p">.</span><span class="nf">lower</span><span class="p">():</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">REDACTED</span><span class="sh">"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">redact_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="n">SENSITIVE</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">api_key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">apiKey</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">key</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">authorization</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">REDACTED</span><span class="sh">"</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">SENSITIVE</span> <span class="k">else</span> <span class="nf">redact_obj</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nf">redact_obj</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">obj</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># (ì„ íƒ) í„°ë¯¸ë„ì´ UTF-8ì´ ì•„ë‹ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë³´ì •
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">reconfigure</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">captured</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">request_hook</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Request</span><span class="p">):</span>
        <span class="n">req_ct</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">charset</span> <span class="o">=</span> <span class="nf">pick_charset</span><span class="p">(</span><span class="n">req_ct</span><span class="p">,</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">body_text</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">charset</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">body_text</span> <span class="o">=</span> <span class="sh">"</span><span class="s">&lt;streaming or no request.content&gt;</span><span class="sh">"</span>

        <span class="c1"># ê°€ëŠ¥í•˜ë©´ nested JSON(dict/list)ë¡œ ì €ì¥
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">body_obj</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">body_text</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">body_obj</span> <span class="o">=</span> <span class="n">body_text</span>  <span class="c1"># JSONì´ ì•„ë‹ˆë©´ ì›ë¬¸ ë¬¸ìì—´
</span>
        <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">method</span><span class="sh">"</span><span class="p">:</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">url</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">url</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">)),</span>
            <span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">:</span> <span class="nf">redact_obj</span><span class="p">(</span><span class="n">body_obj</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">response_hook</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">httpx</span><span class="p">.</span><span class="n">Response</span><span class="p">):</span>
        <span class="n">body_bytes</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="p">.</span><span class="nf">aread</span><span class="p">()</span>
        <span class="n">res_ct</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">charset</span> <span class="o">=</span> <span class="nf">pick_charset</span><span class="p">(</span><span class="n">res_ct</span><span class="p">,</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span>

        <span class="n">body_text</span> <span class="o">=</span> <span class="n">body_bytes</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">charset</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">body_obj</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">body_text</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">body_obj</span> <span class="o">=</span> <span class="n">body_text</span>

        <span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">status_code</span><span class="sh">"</span><span class="p">:</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">headers</span><span class="sh">"</span><span class="p">:</span> <span class="nf">redact_headers</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">)),</span>
            <span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">:</span> <span class="nf">redact_obj</span><span class="p">(</span><span class="n">body_obj</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="n">hooks</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">request_hook</span><span class="p">],</span> <span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">response_hook</span><span class="p">]}</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="p">.</span><span class="nc">AsyncClient</span><span class="p">(</span><span class="n">event_hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">60.0</span><span class="p">)</span> <span class="k">as</span> <span class="n">async_http</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">(</span><span class="n">http_client</span><span class="o">=</span><span class="n">async_http</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">í•œê¸€ì´ ì˜ ë³´ì´ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤. ğŸ˜„</span><span class="sh">"</span><span class="p">}],</span>
        <span class="p">)</span>

    <span class="c1"># === ë³´ê¸° ì¢‹ê²Œ ì¶œë ¥: ensure_ascii=False + indent ===
</span>    <span class="k">def</span> <span class="nf">pretty</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=== REQUEST ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="nf">pretty</span><span class="p">(</span><span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">request</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">]))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== RESPONSE ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="nf">pretty</span><span class="p">(</span><span class="n">captured</span><span class="p">[</span><span class="sh">"</span><span class="s">response</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">body</span><span class="sh">"</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">captured</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<h3 id="í¬ì¸íŠ¸">í¬ì¸íŠ¸</h3>

<ul>
  <li>
    <p><strong>ì €ì¥ ë‹¨ê³„</strong> : ê°€ëŠ¥í•˜ë©´ <code class="language-plaintext highlighter-rouge">dict/list</code> í˜•íƒœë¡œ <strong>ê·¸ëŒ€ë¡œ ì €ì¥</strong> í•©ë‹ˆë‹¤(â€œí•œ ì¤„ ë¬¸ìì—´â€ ëŒ€ì‹  ì¤‘ì²© êµ¬ì¡°).</p>
  </li>
  <li>
    <p><strong>ì¶œë ¥/í™•ì¸ ë‹¨ê³„</strong> : <code class="language-plaintext highlighter-rouge">json.dumps(..., ensure_ascii=False, indent=2)</code> ë¡œ ë¤í”„í•˜ë©´ <strong>í•œê¸€ì´ ê·¸ëŒ€ë¡œ</strong> ë‚˜ì˜¤ê³  <strong>ê°€ë…ì„±</strong> ë„ ì¢‹ì•„ì§‘ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>ì½˜ì†” ì¸ì½”ë”©</strong> : Windows ë“±ì—ì„œ ì½˜ì†” ì¸ì½”ë”© ë¬¸ì œë¡œ ê¹¨ì§ˆ ìˆ˜ ìˆìœ¼ë‹ˆ <code class="language-plaintext highlighter-rouge">sys.stdout.reconfigure(encoding="utf-8")</code> ì‹œë„(ì‹¤íŒ¨í•´ë„ ë¬´ì‹œ).</p>
  </li>
</ul>

<hr />

<h1 id="ë¹ ë¥¸-ì²´í¬ë¦¬ìŠ¤íŠ¸-step-by-step">ë¹ ë¥¸ ì²´í¬ë¦¬ìŠ¤íŠ¸ (step-by-step)</h1>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Content-Type</code>ì—ì„œ <strong>charset í™•ì¸</strong> (ì—†ìœ¼ë©´ UTF-8 ê°€ì •).</p>
  </li>
  <li>
    <p>ë°”ì´íŠ¸ â†’ ë¬¸ìì—´ <strong>ë””ì½”ë”©</strong>.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">json.loads()</code>ë¡œ <strong>ê°ì²´í™”</strong>(ë˜ë©´ dict/listë¡œ ì €ì¥).</p>
  </li>
  <li>
    <p>ì¶œë ¥í•  ë•Œ <code class="language-plaintext highlighter-rouge">json.dumps(..., ensure_ascii=False, indent=2)</code> ì‚¬ìš©.</p>
  </li>
  <li>
    <p>ì½˜ì†” ì¸ì½”ë”©ì´ UTF-8ì¸ì§€ í™•ì¸(í•„ìš” ì‹œ <code class="language-plaintext highlighter-rouge">PYTHONIOENCODING=UTF-8</code> í™˜ê²½ë³€ìˆ˜ ë˜ëŠ” ìœ„ ì½”ë“œ).</p>
  </li>
</ol>

<p>ì›í•˜ì‹œë©´ <strong>ìš”ì²­/ì‘ë‹µì—ì„œ íŠ¹ì • í‚¤ë§Œ ê³¨ë¼ì„œ pretty-print</strong> í•˜ë„ë¡ í•„í„°ë§ê¹Œì§€ ë„£ì–´ë“œë¦´ê²Œìš”. ì–´ë–¤ í‚¤ë“¤ë§Œ ë³´ì´ë©´ ì¢‹ì„ê¹Œìš”?</p>]]></content><author><name>hvppyarchive</name></author><category term="python" /><summary type="html"><![CDATA[]]></summary></entry></feed>