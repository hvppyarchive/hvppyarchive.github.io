<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.4.1">Jekyll</generator><link href="https://hvppyarchive.github.io/feed.xml" rel="self" type="application/atom+xml" /><link href="https://hvppyarchive.github.io/" rel="alternate" type="text/html" /><updated>2025-11-12T17:53:43+09:00</updated><id>https://hvppyarchive.github.io/feed.xml</id><title type="html">ARCHIVE</title><subtitle>An amazing archive.</subtitle><author><name>hvppyarchive</name></author><entry><title type="html"></title><link href="https://hvppyarchive.github.io/2025-08-19-python-repr-vs-str/" rel="alternate" type="text/html" title="" /><published>2025-11-12T17:53:43+09:00</published><updated>2025-11-12T17:53:43+09:00</updated><id>https://hvppyarchive.github.io/2025-08-19-python-repr-vs-str</id><content type="html" xml:base="https://hvppyarchive.github.io/2025-08-19-python-repr-vs-str/"><![CDATA[<p class="chat--user">

Pythonì—ì„œ <code class="language-plaintext highlighter-rouge">__repr__</code> í•¨ìˆ˜ì™€ <code class="language-plaintext highlighter-rouge">__str__</code> í•¨ìˆ˜ì˜ ì°¨ì´ì 

</p>

<p>Pythonì—ì„œ <code class="language-plaintext highlighter-rouge">__repr__</code> ê³¼ <code class="language-plaintext highlighter-rouge">__str__</code> ì˜ ì°¨ì´ì ì€ <strong>ê°ì²´ë¥¼ ë¬¸ìì—´ë¡œ í‘œí˜„í•˜ëŠ” ëª©ì </strong> ì—ì„œ ë‹¬ë¼ì§‘ë‹ˆë‹¤. ì°¨ì´ë¥¼ ë‹¨ê³„ì ìœ¼ë¡œ ì •ë¦¬í•´ë“œë¦´ê²Œìš”.</p>

<hr />

<h2 id="1-__repr__-ì˜-ëª©ì ">1. <code class="language-plaintext highlighter-rouge">__repr__</code> ì˜ ëª©ì </h2>

<ul>
  <li>
    <p><strong>ê°œë°œì ì¤‘ì‹¬</strong> : ê°ì²´ë¥¼ "ê°œë°œì"ê°€ ë³´ê³  ì´í•´í•  ìˆ˜ ìˆë„ë¡ í‘œí˜„í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>ì¬í˜„ ê°€ëŠ¥(reproducible)</strong> : ê°€ëŠ¥í•œ í•œ ê°ì²´ë¥¼ ë‹¤ì‹œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ì½”ë“œ í˜•íƒœë¡œ ë³´ì—¬ì£¼ëŠ” ê²ƒì´ ëª©í‘œì…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë³´í†µ <code class="language-plaintext highlighter-rouge">eval(repr(obj)) == obj</code> ê°€ ì„±ë¦½í•˜ëŠ” í˜•íƒœë¥¼ ì§€í–¥í•©ë‹ˆë‹¤ (ê¼­ í•­ìƒ ê·¸ëŸ° ê±´ ì•„ë‹ˆì§€ë§Œ ê¶Œì¥).</p>
  </li>
  <li>
    <p>ë””ë²„ê¹…í•  ë•Œ ì£¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.</p>
  </li>
</ul>

<p>ì˜ˆì‹œ:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
    
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Person(name=</span><span class="sh">'</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="sh">'</span><span class="s">, age=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">age</span><span class="si">}</span><span class="s">)</span><span class="sh">"</span>

<span class="n">p</span> <span class="o">=</span> <span class="nc">Person</span><span class="p">(</span><span class="sh">"</span><span class="s">Alice</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">repr</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>  <span class="c1"># Person(name='Alice', age=30)
</span></code></pre></div></div>

<hr />

<h2 id="2-__str__-ì˜-ëª©ì ">2. <code class="language-plaintext highlighter-rouge">__str__</code> ì˜ ëª©ì </h2>

<ul>
  <li>
    <p><strong>ì‚¬ìš©ì ì¤‘ì‹¬</strong> : ê°ì²´ë¥¼ "ì‚¬ìš©ì"ê°€ ë³´ê¸° ì¢‹ì€ ë¬¸ìì—´ë¡œ í‘œí˜„í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì½ê¸° ì‰½ê³  ê¹”ë”í•˜ê²Œ ì¶œë ¥í•˜ëŠ” ë° ì´ˆì ì„ ë‘¡ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">print(obj)</code> ë¥¼ í˜¸ì¶œí–ˆì„ ë•Œ ë³´ì—¬ì§€ëŠ” ê°’ì´ <code class="language-plaintext highlighter-rouge">__str__</code> ì…ë‹ˆë‹¤.</p>
  </li>
</ul>

<p>ì˜ˆì‹œ:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
    
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">age</span><span class="si">}</span><span class="s"> years old)</span><span class="sh">"</span>

<span class="n">p</span> <span class="o">=</span> <span class="nc">Person</span><span class="p">(</span><span class="sh">"</span><span class="s">Alice</span><span class="sh">"</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>  <span class="c1"># Alice (30 years old)
</span></code></pre></div></div>

<hr />

<h2 id="3-__repr__-vs-__str__-ë¹„êµ">3. <code class="language-plaintext highlighter-rouge">__repr__</code> vs <code class="language-plaintext highlighter-rouge">__str__</code> ë¹„êµ</h2>

<table>
  <thead>
    <tr>
      <th>íŠ¹ì§•</th>
      <th><code class="language-plaintext highlighter-rouge">__repr__</code></th>
      <th><code class="language-plaintext highlighter-rouge">__str__</code></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ëª©ì </td>
      <td>ê°œë°œììš©, ë””ë²„ê¹…</td>
      <td>ì‚¬ìš©ììš©, ê°€ë…ì„±</td>
    </tr>
    <tr>
      <td>ì¶œë ¥ ëŒ€ìƒ</td>
      <td><code class="language-plaintext highlighter-rouge">repr(obj)</code>, ëŒ€í™”í˜• ì‰˜ì—ì„œ ê¸°ë³¸</td>
      <td><code class="language-plaintext highlighter-rouge">str(obj)</code>, <code class="language-plaintext highlighter-rouge">print(obj)</code></td>
    </tr>
    <tr>
      <td>í˜•ì‹</td>
      <td>ê°ì²´ ì¬í˜„ ê°€ëŠ¥í•˜ê±°ë‚˜ ìƒì„¸</td>
      <td>ì½ê¸° ì‰¬ìš´ ì„¤ëª… ìœ„ì£¼</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="4-êµ¬í˜„-ì‹œ-ì£¼ì˜ì‚¬í•­">4. êµ¬í˜„ ì‹œ ì£¼ì˜ì‚¬í•­</h2>

<ul>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">__str__</code> ê°€ ì—†ìœ¼ë©´ <code class="language-plaintext highlighter-rouge">__repr__</code> ê°€ ëŒ€ì‹  ì‚¬ìš©</strong>ë©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë”°ë¼ì„œ ìµœì†Œí•œ <code class="language-plaintext highlighter-rouge">__repr__</code> ì€ ì •ì˜í•´ ë‘ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />

<p>ğŸ‘‰ ì •ë¦¬í•˜ë©´,</p>

<ul>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">__repr__</code></strong> : â€œê°œë°œìê°€ ë””ë²„ê¹…í•  ë•Œâ€ ê°ì²´ì˜ ì •í™•í•œ í‘œí˜„.</p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">__str__</code></strong> : â€œì‚¬ìš©ìê°€ ì¶œë ¥ë¬¼ì„ ë³¼ ë•Œâ€ ë³´ê¸° ì¢‹ê²Œ í‘œí˜„.</p>
  </li>
</ul>

<hr />

<p>ì›í•˜ì‹œë©´ <code class="language-plaintext highlighter-rouge">__repr__</code> ì™€ <code class="language-plaintext highlighter-rouge">__str__</code> ë¥¼ ë™ì‹œì— êµ¬í˜„í–ˆì„ ë•Œ <code class="language-plaintext highlighter-rouge">print(obj)</code> ì™€ <code class="language-plaintext highlighter-rouge">obj</code> (ì‰˜ ì¶œë ¥) ì˜ ì°¨ì´ë¥¼ ì§ì ‘ ì‹¤í–‰í•´ ë³´ì—¬ë“œë¦´ ìˆ˜ë„ ìˆëŠ”ë°, ì˜ˆì œ ì½”ë“œ ì‹œì—°ì„ ì›í•˜ì‹œë‚˜ìš”?</p>]]></content><author><name>hvppyarchive</name></author></entry><entry><title type="html">CFileDialog êµ¬í˜„ ë°©ë²•</title><link href="https://hvppyarchive.github.io/python/custom-pyside-filedialog/" rel="alternate" type="text/html" title="CFileDialog êµ¬í˜„ ë°©ë²•" /><published>2025-11-12T17:53:38+09:00</published><updated>2025-11-12T17:53:38+09:00</updated><id>https://hvppyarchive.github.io/python/custom-pyside-filedialog</id><content type="html" xml:base="https://hvppyarchive.github.io/python/custom-pyside-filedialog/"><![CDATA[<p class="chat--user">

PySide6(PyQt6)ë¥¼ ì´ìš©í•´ì„œ ë‚˜ë§Œì˜ QFileDialogë¥¼ ë§Œë“¤ê³  ì‹¶ì–´. ì´ë¦„ì€ CFileDialogë¼ê³  í•˜ì. ê·¸ëƒ¥ Qtì˜ ë‚´ì¥ ë‹¤ì´ì–¼ë¡œê·¸ì™€ ë¹„ìŠ·í•˜ë©´ ë¼ ## UI ì„¤ëª… ê°€ì¥ ìœ„ì—ëŠ” í˜„ì¬ ê²½ë¡œê°€ ì½¤ë³´ ë°•ìŠ¤ë¡œ ìˆê³ , ì½¤ë³´ë°•ìŠ¤ë¥¼ ëˆ„ë¥´ë©´ í•˜ìœ„ ê²½ë¡œë“¤ì„ ì„ íƒí•  ìˆ˜ ìˆê²Œ ëœë‹¤ ì˜ˆë¥¼ ë“¤ì–´ ì§€ê¸ˆ /a/b/c/d ì—ì„œ ì‹œì‘í–ˆìœ¼ë©´ /a/b/c/d /a/b/c /a/b /a / ì´ëŸ° ì‹ìœ¼ë¡œ ë‚˜ì™€ì•¼í•˜ê³ , ê²½ë¡œ í´ë¦­ ì‹œ ê·¸ ê²½ë¡œë¡œ ë‹¤ì´ì–¼ë¡œê·¸ ì´ë™í•  ê²ƒ. ê·¸ ì˜†ì—ëŠ” Back, Forward, Parent Directory, Create New Folder ë²„íŠ¼ì´ ìˆë‹¤. ê°€ìš´ë° ë¦¬ìŠ¤íŠ¸ë·°ì—ëŠ” í˜„ì¬ í´ë”ì˜ í•˜ìœ„ í´ë”, íŒŒì¼ë“¤ì´ ë³´ì¸ë‹¤. (ëª¨ë“œì— ë”°ë¼ ë³´ì´ëŠ”ê²Œ ë‹¤ë¦„, í´ë” ì„ íƒ ëª¨ë“œëƒ íŒŒì¼ ì„ íƒ ëª¨ë“œëƒ) ì•„ë˜ì—ëŠ” ê²½ë¡œë¥¼ ì…ë ¥ì„ í•  ìˆ˜ ìˆëŠ” LineEditì´ ìˆê³  ê²½ë¡œ ì…ë ¥ ì‹œì— ìë™ì™„ì„± ë ë§Œí•œê²Œ QCompleterë¡œ ë‚˜íƒ€ë‚œë‹¤. ì´ ë•Œ ë„¤íŠ¸ì›Œí¬ ë“œë¼ì´ë¸Œë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ QCompleterê°€ ë§¤ìš° ëŠë¦´ ìˆ˜ ìˆëŠ”ë°, QCompleterì˜ ì—­í• ì„ ì“°ë ˆë“œë¡œ ë¹¼ë©´ ì¢‹ì„ ê²ƒ ê°™ìŒ. í˜„ì¬ ê²½ë¡œì—ì„œ ê°€ì¥ ì¼ì¹˜í•˜ëŠ” ìƒìœ„ 10ê°œ ì •ë„ ê²½ë¡œë§Œ Completerë¡œ ì‚¬ìš©í•˜ê³  ê²½ë¡œê°€ ì™„ì„±ë˜ë©´ ë‹¤ì‹œ ë¦¬í”„ë ˆì‹œ í•´ì„œ ìƒìœ„ 10ê°œë¥¼ ì°¾ëŠ” ì‹ìœ¼ë¡œ í•˜ë©´ ì¢‹ì„ ê²ƒ ê°™ìŒ. (ì¤‘ìš”) ê·¸ ì•„ë˜ì—ëŠ” Type ì„ íƒ ì½¤ë³´ë°•ìŠ¤ê°€ ìˆë‹¤. ê·¸ ì™¸ ì‚¬ìš©ë²•ì€ QFileDialogì™€ ê±°ì˜ ë™ì¼í•˜ê²Œ í•˜ë©´ ì¢‹ê² ìŒ. íŒŒì¼/í´ë” ì–»ì„ ì§€ Saveìš©ì¸ì§€ Loadìš©ì¸ì§€

</p>

<p>ì¢‹ì•„ìš”. ì´ê±´ ê½¤ ë³¸ê²©ì ì¸ ì»¤ìŠ¤í…€ ë‹¤ì´ì–¼ë¡œê·¸ ì„¤ê³„ì˜ˆìš”.<br />
PySide6(PyQt6 ë™ì¼ êµ¬ì¡°)ì—ì„œ Qtì˜ ê¸°ë³¸ <code class="language-plaintext highlighter-rouge">QFileDialog</code>ë¥¼ ì¬í˜„í•˜ë©´ì„œ ë” ìœ ì—°í•˜ê²Œ ë§Œë“¤ê¸° ìœ„í•´ì„  <strong>QDialog ê¸°ë°˜ì˜ í´ë˜ìŠ¤</strong> ë¡œ ì§ì ‘ êµ¬í˜„í•˜ëŠ” ê²Œ ê°€ì¥ ê¹”ë”í•©ë‹ˆë‹¤.<br />
ì•„ë˜ëŠ” ì „ì²´ì ì¸ êµ¬ì¡°ì™€ ì£¼ìš” í¬ì¸íŠ¸ë¥¼ ë‹¨ê³„ë³„ë¡œ ì„¤ëª…í• ê²Œìš”.</p>

<hr />

<h2 id="í•µì‹¬-êµ¬ì¡°-ê°œìš”">í•µì‹¬ êµ¬ì¡° ê°œìš”</h2>

<p><code class="language-plaintext highlighter-rouge">CFileDialog</code>ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">QDialog</code>ë¥¼ ìƒì†ë°›ìŠµë‹ˆë‹¤.<br />
ë‚´ë¶€ êµ¬ì„±ìš”ì†ŒëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

<ul>
  <li>
    <p><strong>ìƒë‹¨ ì˜ì—­</strong> :</p>

    <ul>
      <li>
        <p>ê²½ë¡œ ì½¤ë³´ë°•ìŠ¤ (<code class="language-plaintext highlighter-rouge">QComboBox</code>)</p>
      </li>
      <li>
        <p>Back / Forward / Up / New Folder ë²„íŠ¼ (<code class="language-plaintext highlighter-rouge">QToolButton</code>)</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>ì¤‘ì•™ ì˜ì—­</strong> :</p>

    <ul>
      <li>
        <p>íŒŒì¼/í´ë” ëª©ë¡ (<code class="language-plaintext highlighter-rouge">QListView</code> or <code class="language-plaintext highlighter-rouge">QTreeView</code>)</p>
      </li>
      <li>
        <p>ëª¨ë¸ì€ <code class="language-plaintext highlighter-rouge">QFileSystemModel</code> ì‚¬ìš©</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>í•˜ë‹¨ ì˜ì—­</strong> :</p>

    <ul>
      <li>
        <p>ê²½ë¡œ ì…ë ¥ì°½ (<code class="language-plaintext highlighter-rouge">QLineEdit</code>) + ìë™ì™„ì„± (<code class="language-plaintext highlighter-rouge">QCompleter</code>)</p>
      </li>
      <li>
        <p>Type ì„ íƒ ì½¤ë³´ë°•ìŠ¤ (<code class="language-plaintext highlighter-rouge">QComboBox</code>)</p>
      </li>
      <li>
        <p>í™•ì¸/ì·¨ì†Œ ë²„íŠ¼ (<code class="language-plaintext highlighter-rouge">QDialogButtonBox</code>)</p>
      </li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="ì£¼ìš”-ë™ì‘-ì„¤ê³„">ì£¼ìš” ë™ì‘ ì„¤ê³„</h2>

<h3 id="1-ê²½ë¡œ-ì½¤ë³´ë°•ìŠ¤">1. ê²½ë¡œ ì½¤ë³´ë°•ìŠ¤</h3>

<p>í˜„ì¬ ê²½ë¡œë¥¼ <code class="language-plaintext highlighter-rouge">/a/b/c/d</code> í˜•íƒœë¡œ í‘œì‹œí•˜ê³ , í´ë¦­ ì‹œ ì•„ë˜ì²˜ëŸ¼ ë³´ì—¬ì•¼ í•¨:</p>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">/</span><span class="nt">a</span><span class="o">/</span><span class="nt">b</span><span class="o">/</span><span class="nt">c</span><span class="o">/</span><span class="nt">d</span>
<span class="o">/</span><span class="nt">a</span><span class="o">/</span><span class="nt">b</span><span class="o">/</span><span class="nt">c</span>
<span class="o">/</span><span class="nt">a</span><span class="o">/</span><span class="nt">b</span>
<span class="o">/</span><span class="nt">a</span>
<span class="o">/</span>
</code></pre></div></div>

<p>ì´ê±´ <code class="language-plaintext highlighter-rouge">QComboBox</code>ë¥¼ ë§¤ë²ˆ ê²½ë¡œ ë³€ê²½ ì‹œ ê°±ì‹ í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬í˜„ ê°€ëŠ¥.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">update_path_combo</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="n">parts</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">subpath</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="o">*</span><span class="n">parts</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">addItem</span><span class="p">(</span><span class="n">subpath</span><span class="p">)</span>
</code></pre></div></div>

<p>ì½¤ë³´ë°•ìŠ¤ì—ì„œ í•­ëª© ì„ íƒ ì‹œ <code class="language-plaintext highlighter-rouge">QFileSystemModel</code>ì˜ rootë¥¼ í•´ë‹¹ ê²½ë¡œë¡œ ë³€ê²½.</p>

<hr />

<h3 id="2-íƒìƒ‰-ë²„íŠ¼ë“¤">2. íƒìƒ‰ ë²„íŠ¼ë“¤</h3>

<ul>
  <li>
    <p><strong>Back / Forward</strong> : ê°„ë‹¨íˆ <code class="language-plaintext highlighter-rouge">deque</code>ë¥¼ ì´ìš©í•œ íˆìŠ¤í† ë¦¬ ê´€ë¦¬.</p>
  </li>
  <li>
    <p><strong>Up (Parent)</strong> : <code class="language-plaintext highlighter-rouge">os.path.dirname(current_path)</code>ë¡œ ì´ë™.</p>
  </li>
  <li>
    <p><strong>New Folder</strong> : <code class="language-plaintext highlighter-rouge">QInputDialog.getText()</code>ë¡œ í´ë”ëª… ë°›ì•„ <code class="language-plaintext highlighter-rouge">os.makedirs()</code>.</p>
  </li>
</ul>

<hr />

<h3 id="3-íŒŒì¼í´ë”-ë¦¬ìŠ¤íŠ¸">3. íŒŒì¼/í´ë” ë¦¬ìŠ¤íŠ¸</h3>

<p><code class="language-plaintext highlighter-rouge">QFileSystemModel</code> + <code class="language-plaintext highlighter-rouge">QListView</code> ë˜ëŠ” <code class="language-plaintext highlighter-rouge">QTreeView</code> ì‚¬ìš©.<br />
ì„ íƒ ëª¨ë“œì— ë”°ë¼ í‘œì‹œë˜ëŠ” í•­ëª© ì œí•œ ê°€ëŠ¥:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">folder</span><span class="sh">'</span><span class="p">:</span>
    <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setFilter</span><span class="p">(</span><span class="n">QDir</span><span class="p">.</span><span class="n">AllDirs</span> <span class="o">|</span> <span class="n">QDir</span><span class="p">.</span><span class="n">NoDotAndDotDot</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setFilter</span><span class="p">(</span><span class="n">QDir</span><span class="p">.</span><span class="n">AllEntries</span> <span class="o">|</span> <span class="n">QDir</span><span class="p">.</span><span class="n">NoDotAndDotDot</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">QListView.clicked</code> ì‹œ <code class="language-plaintext highlighter-rouge">LineEdit</code> ì—…ë°ì´íŠ¸.</p>

<hr />

<h3 id="4-ê²½ë¡œ-ì…ë ¥--ìë™ì™„ì„±">4. ê²½ë¡œ ì…ë ¥ + ìë™ì™„ì„±</h3>

<p>í•µì‹¬ í¬ì¸íŠ¸ëŠ” <strong>QCompleterë¥¼ ë³„ë„ ì“°ë ˆë“œë¡œ ê´€ë¦¬</strong> í•˜ëŠ” ë¶€ë¶„ì´ì—ìš”.<br />
ëŒ€ìš©ëŸ‰ ë„¤íŠ¸ì›Œí¬ ë“œë¼ì´ë¸Œì—ì„œ ë””ë ‰í† ë¦¬ ìë™ì™„ì„±ì€ ëŠë¦¬ë¯€ë¡œ,<br />
ë‹¤ìŒê³¼ ê°™ì€ ë¹„ë™ê¸° êµ¬ì¡°ë¥¼ ì”ë‹ˆë‹¤.</p>

<h4 id="worker-thread">Worker Thread</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PathCompleterWorker</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
    <span class="n">paths_ready</span> <span class="o">=</span> <span class="nc">Signal</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">base_path</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_path</span> <span class="o">=</span> <span class="n">base_path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="nf">walk</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">base_path</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">d</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">):</span>
                    <span class="n">matches</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">self</span><span class="p">.</span><span class="n">paths_ready</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">CFileDialog</code>ì—ì„œ ì…ë ¥ì°½ ë‚´ìš©ì´ ë°”ë€” ë•Œë§ˆë‹¤ ì´ ì“°ë ˆë“œ ì‹¤í–‰ â†’ <code class="language-plaintext highlighter-rouge">QCompleter</code> ê°±ì‹ .</p>

<hr />

<h3 id="5-type-ì„ íƒ-ì½¤ë³´ë°•ìŠ¤">5. Type ì„ íƒ ì½¤ë³´ë°•ìŠ¤</h3>

<p>ì¼ë°˜ íŒŒì¼ ë‹¤ì´ì–¼ë¡œê·¸ì²˜ëŸ¼ <code class="language-plaintext highlighter-rouge">*.txt</code>, <code class="language-plaintext highlighter-rouge">*.png</code> ë“±ì˜ í•„í„°ë¥¼ í‘œì‹œ:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">.</span><span class="nf">addItems</span><span class="p">([</span><span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Text Files (*.txt)</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Images (*.png *.jpg)</span><span class="sh">"</span><span class="p">])</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">currentTextChanged</code> ì‹œ ëª¨ë¸ í•„í„° ê°±ì‹ .</p>

<hr />

<h3 id="6-qfiledialogì²˜ëŸ¼-ë™ì‘í•˜ê²Œ-ë§Œë“¤ê¸°">6. QFileDialogì²˜ëŸ¼ ë™ì‘í•˜ê²Œ ë§Œë“¤ê¸°</h3>

<p>ì™¸ë¶€ ì¸í„°í˜ì´ìŠ¤ëŠ” ê¸°ì¡´ QFileDialogì™€ ìœ ì‚¬í•˜ê²Œ:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dlg</span> <span class="o">=</span> <span class="nc">CFileDialog</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">,</span> <span class="n">select_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">)</span>
<span class="k">if</span> <span class="n">dlg</span><span class="p">.</span><span class="nf">exec</span><span class="p">():</span>
    <span class="n">selected_path</span> <span class="o">=</span> <span class="n">dlg</span><span class="p">.</span><span class="nf">selected_path</span><span class="p">()</span>
</code></pre></div></div>

<p>ì˜µì…˜:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">mode</code>: <code class="language-plaintext highlighter-rouge">"open"</code> / <code class="language-plaintext highlighter-rouge">"save"</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">select_mode</code>: <code class="language-plaintext highlighter-rouge">"file"</code> / <code class="language-plaintext highlighter-rouge">"folder"</code></p>
  </li>
</ul>

<hr />

<h2 id="ì „ì²´-êµ¬ì¡°-ì½”ë“œ-ì˜ˆì‹œ-ìš”ì•½-ë²„ì „">ì „ì²´ êµ¬ì¡° ì½”ë“œ ì˜ˆì‹œ (ìš”ì•½ ë²„ì „)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">PySide6.QtWidgets</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">PySide6.QtGui</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">deque</span>

<span class="k">class</span> <span class="nc">CFileDialog</span><span class="p">(</span><span class="n">QDialog</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">start_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">,</span> <span class="n">select_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">=</span> <span class="n">select_mode</span>
        <span class="n">self</span><span class="p">.</span><span class="n">history</span> <span class="o">=</span> <span class="nf">deque</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">forward_stack</span> <span class="o">=</span> <span class="nf">deque</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_path</span> <span class="o">=</span> <span class="n">start_path</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_build_ui</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_connect_signals</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_ui</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">setWindowTitle</span><span class="p">(</span><span class="sh">"</span><span class="s">CFileDialog</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># ìƒë‹¨
</span>        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span> <span class="o">=</span> <span class="nc">QComboBox</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">back_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sh">"</span><span class="s">â†</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">forward_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sh">"</span><span class="s">â†’</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">up_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sh">"</span><span class="s">â†‘</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">new_folder_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">top_layout</span> <span class="o">=</span> <span class="nc">QHBoxLayout</span><span class="p">()</span>
        <span class="n">top_layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">back_btn</span><span class="p">)</span>
        <span class="n">top_layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">forward_btn</span><span class="p">)</span>
        <span class="n">top_layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">up_btn</span><span class="p">)</span>
        <span class="n">top_layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">new_folder_btn</span><span class="p">)</span>
        <span class="n">top_layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">)</span>

        <span class="c1"># ì¤‘ì•™
</span>        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="nc">QFileSystemModel</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setRootPath</span><span class="p">(</span><span class="sh">""</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span> <span class="o">=</span> <span class="nc">QListView</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setModel</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">)</span>

        <span class="c1"># í•˜ë‹¨
</span>        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span> <span class="o">=</span> <span class="nc">QLineEdit</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span> <span class="o">=</span> <span class="nc">QComboBox</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">.</span><span class="nf">addItems</span><span class="p">([</span><span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">button_box</span> <span class="o">=</span> <span class="nc">QDialogButtonBox</span><span class="p">(</span><span class="n">QDialogButtonBox</span><span class="p">.</span><span class="n">Ok</span> <span class="o">|</span> <span class="n">QDialogButtonBox</span><span class="p">.</span><span class="n">Cancel</span><span class="p">)</span>

        <span class="n">bottom_layout</span> <span class="o">=</span> <span class="nc">QHBoxLayout</span><span class="p">()</span>
        <span class="n">bottom_layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">)</span>
        <span class="n">bottom_layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">)</span>

        <span class="n">layout</span> <span class="o">=</span> <span class="nc">QVBoxLayout</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addLayout</span><span class="p">(</span><span class="n">top_layout</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addLayout</span><span class="p">(</span><span class="n">bottom_layout</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_connect_signals</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="n">currentTextChanged</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_load_path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">up_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_go_up</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">back_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_go_back</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">forward_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_go_forward</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">new_folder_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_create_folder</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_item_clicked</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">.</span><span class="n">accepted</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">accept</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">.</span><span class="n">rejected</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">reject</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_path</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="k">return</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setRootIndex</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">update_path_combo</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_path_combo</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">blockSignals</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="n">parts</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">addItem</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="o">*</span><span class="n">parts</span><span class="p">[:</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">blockSignals</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_item_clicked</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">filePath</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">selected_path</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">()</span>

    <span class="c1"># ê¸°íƒ€ ë²„íŠ¼ í•¨ìˆ˜ ìƒëµ (Back, Forward, Up, etc.)
</span></code></pre></div></div>

<hr />

<p>ì´ ì„¤ê³„ëŒ€ë¡œë¼ë©´ Qt ë‚´ì¥ <code class="language-plaintext highlighter-rouge">QFileDialog</code>ì™€ ê±°ì˜ ë™ì¼í•œ ì¸í„°í˜ì´ìŠ¤ë¥¼ ê°€ì§€ë˜,<br />
í™•ì¥ì„±ê³¼ ì‚¬ìš©ì ì§€ì •ì„±ì´ í›¨ì”¬ ë†’ìŠµë‹ˆë‹¤.</p>

<p>ë‹¤ìŒ ë‹¨ê³„ë¡œëŠ” <strong>Completerë¥¼ ì“°ë ˆë“œë¡œ ì‹¤ì œ ì—°ê²°í•˜ëŠ” ë¶€ë¶„</strong> ì„ êµ¬í˜„í•´ë³´ë©´ ì™„ì„±í˜•ì— ê°€ê¹Œì›Œì§‘ë‹ˆë‹¤.<br />
ì›í•œë‹¤ë©´ ê·¸ ë¶€ë¶„ë§Œ ì´ì–´ì„œ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•´ë“œë¦´ê²Œìš” â€” ì“°ë ˆë“œ ê´€ë¦¬(<code class="language-plaintext highlighter-rouge">QThreadPool</code> + <code class="language-plaintext highlighter-rouge">QRunnable</code>) ë°©ì‹ìœ¼ë¡œ.</p>

<p class="chat--user">

ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•´ì¤˜.

</p>

<p>ì¢‹ì•„, ë°”ë¡œ â€œìë™ì™„ì„± + ìŠ¤ë ˆë“œâ€ ë‹¨ê³„ê¹Œì§€ ë¶™ì—¬ì„œ ë™ì‘í•˜ëŠ” ì „ì²´ ì˜ˆì œë¥¼ ë§Œë“¤ì–´ì¤„ê²Œ.<br />
ì•„ë˜ ì½”ë“œëŠ” PySide6 ê¸°ì¤€ì´ë©°, <code class="language-plaintext highlighter-rouge">QThreadPool + QRunnable</code>ë¡œ ì™„ì„± í›„ë³´ 10ê°œë¥¼ ë¹„ë™ê¸°ë¡œ ì°¾ê³ , ì…ë ¥ì´ ë°”ë€” ë•Œë§ˆë‹¤ ìµœì‹  ê²€ìƒ‰ë§Œ ë°˜ì˜ë˜ë„ë¡ <code class="language-plaintext highlighter-rouge">task_id</code>ë¡œ ë ˆì´ìŠ¤ ì»¨ë””ì…˜ì„ ë§‰ì•˜ì–´. ê²½ë¡œ ì½¤ë³´/ë’¤ë¡œÂ·ì•ìœ¼ë¡œÂ·ìƒìœ„Â·ìƒˆí´ë”, íŒŒì¼/í´ë” ëª¨ë“œ, Open/Save, Type í•„í„°, íˆìŠ¤í† ë¦¬, ë””ë°”ìš´ìŠ¤ê¹Œì§€ ë“¤ì–´ìˆì–´.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">fnmatch</span>
<span class="kn">import</span> <span class="n">traceback</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">deque</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Qt</span><span class="p">,</span> <span class="n">QObject</span><span class="p">,</span> <span class="n">Signal</span><span class="p">,</span> <span class="n">Slot</span><span class="p">,</span> <span class="n">QModelIndex</span><span class="p">,</span>
                                 <span class="n">QTimer</span><span class="p">,</span> <span class="n">QRunnable</span><span class="p">,</span> <span class="n">QThreadPool</span><span class="p">,</span> <span class="n">QMetaObject</span><span class="p">,</span> <span class="n">Q_ARG</span><span class="p">)</span>
    <span class="kn">from</span> <span class="n">PySide6.QtGui</span> <span class="kn">import</span> <span class="n">QIcon</span>
    <span class="kn">from</span> <span class="n">PySide6.QtWidgets</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">QApplication</span><span class="p">,</span> <span class="n">QDialog</span><span class="p">,</span> <span class="n">QVBoxLayout</span><span class="p">,</span> <span class="n">QHBoxLayout</span><span class="p">,</span> <span class="n">QToolButton</span><span class="p">,</span> <span class="n">QComboBox</span><span class="p">,</span>
        <span class="n">QListView</span><span class="p">,</span> <span class="n">QTreeView</span><span class="p">,</span> <span class="n">QFileSystemModel</span><span class="p">,</span> <span class="n">QLineEdit</span><span class="p">,</span> <span class="n">QCompleter</span><span class="p">,</span>
        <span class="n">QDialogButtonBox</span><span class="p">,</span> <span class="n">QInputDialog</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="p">,</span> <span class="n">QLabel</span><span class="p">,</span> <span class="n">QWidget</span><span class="p">,</span> <span class="n">QSizePolicy</span>
    <span class="p">)</span>
<span class="k">except</span> <span class="nb">ImportError</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">PySide6ê°€ í•„ìš”í•©ë‹ˆë‹¤. pip install PySide6</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># --------------------------
# ë¹„ë™ê¸° ì»´í”Œë¦¬í„° ì‘ì—…ì
# --------------------------
</span>
<span class="k">class</span> <span class="nc">_CompleterResultEmitter</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
    <span class="n">resultsReady</span> <span class="o">=</span> <span class="nc">Signal</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>  <span class="c1"># task_id, results ë¦¬ìŠ¤íŠ¸(str)
</span>
<span class="k">class</span> <span class="nc">PathSearchTask</span><span class="p">(</span><span class="n">QRunnable</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    ì…ë ¥ ë¬¸ìì—´ì„ ê¸°ë°˜ìœ¼ë¡œ base_dir ì•„ë˜ì—ì„œ ì´ë¦„ì´ prefixë¡œ ì‹œì‘í•˜ëŠ” ê²½ë¡œ(íŒŒì¼/í´ë”)ë¥¼
    ìµœëŒ€ top_kê°œê¹Œì§€ ì°¾ì•„ì„œ ë‚´ë³´ë‚´ëŠ” ì‘ì—…. (ê°€ë²¼ìš´ BFS, ì–•ì€ íƒìƒ‰)
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">want_files</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">want_dirs</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">depth_limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">emitter</span><span class="p">:</span> <span class="n">_CompleterResultEmitter</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">task_id</span> <span class="o">=</span> <span class="n">task_id</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">base_dir</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span>
        <span class="n">self</span><span class="p">.</span><span class="n">want_files</span> <span class="o">=</span> <span class="n">want_files</span>
        <span class="n">self</span><span class="p">.</span><span class="n">want_dirs</span> <span class="o">=</span> <span class="n">want_dirs</span>
        <span class="n">self</span><span class="p">.</span><span class="n">top_k</span> <span class="o">=</span> <span class="n">top_k</span>
        <span class="n">self</span><span class="p">.</span><span class="n">depth_limit</span> <span class="o">=</span> <span class="n">depth_limit</span>
        <span class="n">self</span><span class="p">.</span><span class="n">emitter</span> <span class="o">=</span> <span class="n">emitter</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">base_dir</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
                <span class="c1"># ë² ì´ìŠ¤ ë””ë ‰í„°ë¦¬ê°€ ì—†ìœ¼ë©´ ìƒìœ„ë“¤ì„ íƒ€ê³  ì˜¬ë¼ê°€ë©° ì¡´ì¬í•˜ëŠ” ê³³ë¶€í„°
</span>                <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="nc">Path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">base_dir</span><span class="p">).</span><span class="nf">resolve</span><span class="p">().</span><span class="n">parents</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">parent</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
                        <span class="n">base</span> <span class="o">=</span> <span class="n">parent</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                    <span class="k">return</span>

            <span class="c1"># ìš°ì„  1ìˆœìœ„: base_dirì˜ ì§ì ‘ í•˜ìœ„
</span>            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span>
                        <span class="c1"># ì‹œì‘ ì ‘ë‘ì‚¬ ë§¤ì¹­ (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ìŒ)
</span>                        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">want_dirs</span><span class="p">:</span>
                                <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">want_files</span><span class="p">:</span>
                                <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
                        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span>
                            <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                            <span class="k">return</span>
            <span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># 2ìˆœìœ„: ì–•ì€ ê¹Šì´ íƒìƒ‰ (depth_limit)
</span>            <span class="c1"># BFS í: (Path, depth)
</span>            <span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">deque</span> <span class="k">as</span> <span class="n">cdeque</span>
            <span class="n">q</span> <span class="o">=</span> <span class="nf">cdeque</span><span class="p">()</span>
            <span class="n">q</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">base</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">seen</span> <span class="o">=</span> <span class="nf">set</span><span class="p">([</span><span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">)])</span>

            <span class="k">while</span> <span class="n">q</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span>
                <span class="n">cur</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="nf">popleft</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">depth_limit</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">full</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                                    <span class="c1"># ë””ë ‰í„°ë¦¬ ìì²´ê°€ ë§¤ì¹­ë˜ë©´ ê²°ê³¼ì—
</span>                                    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">want_dirs</span> <span class="ow">and</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                                        <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">))</span>
                                        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span>
                                            <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                                            <span class="k">return</span>
                                    <span class="c1"># í•˜ìœ„ë¡œ ì§„í–‰
</span>                                    <span class="n">s</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                                        <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                                        <span class="n">q</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">full</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">want_files</span> <span class="ow">and</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                                        <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">))</span>
                                        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span>
                                            <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                                            <span class="k">return</span>
                            <span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
                                <span class="k">continue</span>
                <span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
                    <span class="k">continue</span>

        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># ì—ëŸ¬ëŠ” ë¬´ì‹œí•˜ê³  ë¹ˆ ê²°ê³¼
</span>            <span class="n">traceback</span><span class="p">.</span><span class="nf">print_exc</span><span class="p">()</span>

        <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_emit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
        <span class="c1"># UI ìŠ¤ë ˆë“œë¡œ ì•ˆì „í•˜ê²Œ ì‹ í˜¸
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">QMetaObject</span><span class="p">.</span><span class="nf">invokeMethod</span><span class="p">(</span>
                <span class="n">self</span><span class="p">.</span><span class="n">emitter</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">resultsReady</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">Qt</span><span class="p">.</span><span class="n">QueuedConnection</span><span class="p">,</span>
                <span class="nc">Q_ARG</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="p">),</span>
                <span class="nc">Q_ARG</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">results</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

<span class="c1"># --------------------------
# CFileDialog ë³¸ì²´
# --------------------------
</span>
<span class="k">class</span> <span class="nc">CFileDialog</span><span class="p">(</span><span class="n">QDialog</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    ëª¨ë“œ:
      mode: </span><span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="s"> | </span><span class="sh">"</span><span class="s">save</span><span class="sh">"</span><span class="s">
      select_mode: </span><span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="s"> | </span><span class="sh">"</span><span class="s">folder</span><span class="sh">"</span><span class="s">
    QFileDialogì™€ ìœ ì‚¬í•œ ì‚¬ìš©ë²•:
        dlg = CFileDialog(mode=</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="s">, select_mode=</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="s">, filters=[</span><span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">Images (*.png *.jpg)</span><span class="sh">"</span><span class="s">])
        if dlg.exec():
            print(dlg.selected_path())
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">start_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">,</span> <span class="n">select_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">,</span>
                 <span class="n">filters</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">setWindowTitle</span><span class="p">(</span><span class="sh">"</span><span class="s">CFileDialog</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">resize</span><span class="p">(</span><span class="mi">900</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>  <span class="c1"># open/save
</span>        <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">=</span> <span class="n">select_mode</span>  <span class="c1"># file/folder
</span>        <span class="n">self</span><span class="p">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">filters</span> <span class="ow">or</span> <span class="p">[</span><span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="p">]</span>

        <span class="n">self</span><span class="p">.</span><span class="n">history_back</span> <span class="o">=</span> <span class="nf">deque</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">history_fwd</span> <span class="o">=</span> <span class="nf">deque</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">start_path</span><span class="p">).</span><span class="nf">resolve</span><span class="p">())</span> <span class="k">if</span> <span class="n">start_path</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">()</span>

        <span class="c1"># completer state
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_completer_task_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_latest_task_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_completer_emitter</span> <span class="o">=</span> <span class="nf">_CompleterResultEmitter</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_completer_emitter</span><span class="p">.</span><span class="n">resultsReady</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_on_completer_results</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_thread_pool</span> <span class="o">=</span> <span class="n">QThreadPool</span><span class="p">.</span><span class="nf">globalInstance</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span> <span class="o">=</span> <span class="nc">QTimer</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span><span class="p">.</span><span class="nf">setInterval</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span><span class="p">.</span><span class="nf">setSingleShot</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span><span class="p">.</span><span class="n">timeout</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_spawn_completer_task</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="nf">_build_ui</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_connect_signals</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_configure_modes</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">,</span> <span class="n">push_history</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># ---------- UI êµ¬ì„± ----------
</span>    <span class="k">def</span> <span class="nf">_build_ui</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># ìƒë‹¨ íˆ´ë°”
</span>        <span class="n">self</span><span class="p">.</span><span class="n">back_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">back_btn</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="sh">"</span><span class="s">Back</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">forward_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">forward_btn</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="sh">"</span><span class="s">Forward</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">up_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">up_btn</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="sh">"</span><span class="s">Parent</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">new_folder_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">new_folder_btn</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="sh">"</span><span class="s">New Folder</span><span class="sh">"</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span> <span class="o">=</span> <span class="nc">QComboBox</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="p">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="p">.</span><span class="n">Fixed</span><span class="p">)</span>

        <span class="n">top</span> <span class="o">=</span> <span class="nc">QHBoxLayout</span><span class="p">()</span>
        <span class="n">top</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">back_btn</span><span class="p">)</span>
        <span class="n">top</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">forward_btn</span><span class="p">)</span>
        <span class="n">top</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">up_btn</span><span class="p">)</span>
        <span class="n">top</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">new_folder_btn</span><span class="p">)</span>
        <span class="n">top</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">)</span>

        <span class="c1"># ì¤‘ì•™ íŒŒì¼ ë·°
</span>        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="nc">QFileSystemModel</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setRootPath</span><span class="p">(</span><span class="sh">""</span><span class="p">)</span>  <span class="c1"># ì „ì²´ íŒŒì¼ ì‹œìŠ¤í…œ
</span>        <span class="c1"># í•„í„°ëŠ” ëª¨ë“œì— ë”°ë¼ ì•„ë˜ì—ì„œ ì„¤ì •
</span>        <span class="n">self</span><span class="p">.</span><span class="n">view</span> <span class="o">=</span> <span class="nc">QTreeView</span><span class="p">()</span>  <span class="c1"># íŠ¸ë¦¬ë¡œ ì“°ë˜, ë£¨íŠ¸ ì¸ë±ìŠ¤ë¥¼ í˜„ì¬ ê²½ë¡œë¡œ ì‹¬ì–´ 1ê³„ì¸µì²˜ëŸ¼ ì‚¬ìš©
</span>        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setModel</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setRootIsDecorated</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setSortingEnabled</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">sortByColumn</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Qt</span><span class="p">.</span><span class="n">AscendingOrder</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setSelectionBehavior</span><span class="p">(</span><span class="n">QTreeView</span><span class="p">.</span><span class="n">SelectRows</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setUniformRowHeights</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1"># ë³´ì¡° ì»¬ëŸ¼ ì •ë¦¬
</span>        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setColumnWidth</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>

        <span class="c1"># í•˜ë‹¨: ê²½ë¡œ ì…ë ¥ + Type + ë²„íŠ¼
</span>        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span> <span class="o">=</span> <span class="nc">QLineEdit</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setPlaceholderText</span><span class="p">(</span><span class="sh">"</span><span class="s">ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”â€¦</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer_model</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># ìœ ì§€ìš© (ë””ë²„ê·¸)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">completer</span> <span class="o">=</span> <span class="nc">QCompleter</span><span class="p">([],</span> <span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setCaseSensitivity</span><span class="p">(</span><span class="n">Qt</span><span class="p">.</span><span class="n">CaseInsensitive</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setFilterMode</span><span class="p">(</span><span class="n">Qt</span><span class="p">.</span><span class="n">MatchContains</span><span class="p">)</span>  <span class="c1"># prefix ê¸°ë°˜ì´ì§€ë§Œ substringë„ ë³´ì—¬ì£¼ë©´ í¸í•¨
</span>        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setCompletionMode</span><span class="p">(</span><span class="n">QCompleter</span><span class="p">.</span><span class="n">PopupCompletion</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setCompleter</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span> <span class="o">=</span> <span class="nc">QComboBox</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">.</span><span class="nf">addItems</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">filters</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">button_box</span> <span class="o">=</span> <span class="nc">QDialogButtonBox</span><span class="p">(</span><span class="n">QDialogButtonBox</span><span class="p">.</span><span class="n">Ok</span> <span class="o">|</span> <span class="n">QDialogButtonBox</span><span class="p">.</span><span class="n">Cancel</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">self</span><span class="p">)</span>

        <span class="n">bottom_row1</span> <span class="o">=</span> <span class="nc">QHBoxLayout</span><span class="p">()</span>
        <span class="n">bottom_row1</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="nc">QLabel</span><span class="p">(</span><span class="sh">"</span><span class="s">ê²½ë¡œ:</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">bottom_row1</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">)</span>
        <span class="n">bottom_row1</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="nc">QLabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Type:</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">bottom_row1</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">)</span>

        <span class="n">layout</span> <span class="o">=</span> <span class="nc">QVBoxLayout</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addLayout</span><span class="p">(</span><span class="n">top</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addLayout</span><span class="p">(</span><span class="n">bottom_row1</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">)</span>

    <span class="c1"># ---------- ì‹œê·¸ë„ ì—°ê²° ----------
</span>    <span class="k">def</span> <span class="nf">_connect_signals</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">back_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_go_back</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">forward_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_go_forward</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">up_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_go_up</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">new_folder_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_create_folder</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="n">activated</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_combo_jump</span><span class="p">)</span>  <span class="c1"># ì¸ë±ìŠ¤ ì„ íƒ ì‹œ ì´ë™
</span>        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">doubleClicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_item_double_clicked</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_item_clicked</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="n">textEdited</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_on_path_edited</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">.</span><span class="n">currentTextChanged</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_on_filter_changed</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">.</span><span class="n">accepted</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_accept_if_valid</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">.</span><span class="n">rejected</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">reject</span><span class="p">)</span>

    <span class="c1"># ---------- ëª¨ë“œ/í•„í„° ----------
</span>    <span class="k">def</span> <span class="nf">_configure_modes</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">folder</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1"># í´ë”ë§Œ
</span>            <span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="n">QDir</span>
            <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setFilter</span><span class="p">(</span><span class="n">QDir</span><span class="p">.</span><span class="n">AllDirs</span> <span class="o">|</span> <span class="n">QDir</span><span class="p">.</span><span class="n">NoDotAndDotDot</span> <span class="o">|</span> <span class="n">QDir</span><span class="p">.</span><span class="n">Drives</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="n">QDir</span>
            <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setFilter</span><span class="p">(</span><span class="n">QDir</span><span class="p">.</span><span class="n">AllEntries</span> <span class="o">|</span> <span class="n">QDir</span><span class="p">.</span><span class="n">NoDotAndDotDot</span> <span class="o">|</span> <span class="n">QDir</span><span class="p">.</span><span class="n">Drives</span><span class="p">)</span>

        <span class="c1"># ì´ë¦„ í•„í„°(íŒ¨í„´) ì ìš©
</span>        <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setNameFilterDisables</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_apply_name_filters_from_combo</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_apply_name_filters_from_combo</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># "Images (*.png *.jpg)" -&gt; ["*.png", "*.jpg"]
</span>        <span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">.</span><span class="nf">currentText</span><span class="p">()</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">(</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="sh">"</span><span class="s">)</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">inside</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">text</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">(</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">text</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">)</span><span class="sh">"</span><span class="p">)]</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">inside</span><span class="p">.</span><span class="nf">split</span><span class="p">()</span> <span class="k">if</span> <span class="sh">"</span><span class="s">*</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">p</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">?</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">p</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">patterns</span><span class="p">:</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setNameFilters</span><span class="p">(</span><span class="n">patterns</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_filter_changed</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_apply_name_filters_from_combo</span><span class="p">()</span>

    <span class="c1"># ---------- ê²½ë¡œ ë¡œë”© ----------
</span>    <span class="k">def</span> <span class="nf">_load_path</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">push_history</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">resolve</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">push_history</span><span class="p">:</span>
            <span class="c1"># íˆìŠ¤í† ë¦¬ í‘¸ì‹œ
</span>            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">current_path</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">current_path</span> <span class="o">!=</span> <span class="n">path</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">history_back</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="n">history_fwd</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

        <span class="n">self</span><span class="p">.</span><span class="n">current_path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_update_path_combo</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setRootIndex</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

        <span class="c1"># OK ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ê°±ì‹ 
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">_update_ok_enabled</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_combo_jump</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">itemText</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_path_combo</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">blockSignals</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">resolve</span><span class="p">()</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">parts</span>
        <span class="c1"># ì˜ˆ: /, /a, /a/b, /a/b/c ... í˜¹ì€ Windows: C:\, C:\Users, ...
</span>        <span class="n">acc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)):</span>
            <span class="n">acc</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">joined</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="o">*</span><span class="n">acc</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">addItem</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">joined</span><span class="p">))</span>
        <span class="c1"># í˜„ì¬ ê²½ë¡œê°€ ê°€ì¥ ì•„ë˜ìª½ì— ì˜¤ë„ë¡ ì„ íƒ
</span>        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">setCurrentIndex</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">blockSignals</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># ---------- íƒìƒ‰ ë²„íŠ¼ ----------
</span>    <span class="k">def</span> <span class="nf">_go_back</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">history_back</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">history_back</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">history_fwd</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">push_history</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_go_forward</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">history_fwd</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">history_fwd</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">history_back</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">push_history</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_go_up</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">).</span><span class="n">parent</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="ow">and</span> <span class="n">parent</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_folder</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">ok</span> <span class="o">=</span> <span class="n">QInputDialog</span><span class="p">.</span><span class="nf">getText</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">ìƒˆ í´ë”</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">í´ë”ëª…:</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">name</span><span class="p">.</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="n">target</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">,</span> <span class="n">name</span><span class="p">.</span><span class="nf">strip</span><span class="p">())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">target</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="c1"># ìƒˆ í´ë”ë¡œ í¬ì»¤ìŠ¤ ì´ë™
</span>            <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
        <span class="k">except</span> <span class="nb">FileExistsError</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">ê²½ê³ </span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ë™ì¼í•œ ì´ë¦„ì˜ í´ë”ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="p">.</span><span class="nf">critical</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">ì˜¤ë¥˜</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">í´ë”ë¥¼ ë§Œë“¤ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="p">.</span><span class="nf">critical</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">ì˜¤ë¥˜</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">í´ë” ìƒì„± ì‹¤íŒ¨: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># ---------- ë·° í´ë¦­/ë”ë¸”í´ë¦­ ----------
</span>    <span class="k">def</span> <span class="nf">_item_clicked</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">QModelIndex</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">filePath</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="c1"># ë¯¸ë¦¬ë³´ë“¯ ê²½ë¡œì°½ì— ë°˜ì˜
</span>        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_update_ok_enabled</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_item_double_clicked</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">QModelIndex</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">filePath</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># íŒŒì¼ì´ë©´ ê²½ë¡œì°½ì— ë„£ê³  OK
</span>            <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_update_ok_enabled</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">open</span><span class="sh">'</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">accept</span><span class="p">()</span>

    <span class="c1"># ---------- OK ìœ íš¨ì„± ----------
</span>    <span class="k">def</span> <span class="nf">_is_selection_valid</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">folder</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1"># í´ë” ì„ íƒ ëª¨ë“œ
</span>            <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="c1"># Save ëª¨ë“œì—ì„œëŠ” ìƒˆ í´ë”ëª…ë„ í—ˆìš©í• ì§€? ì—¬ê¸°ì„  í´ë” ì¡´ì¬ë§Œ í—ˆìš©
</span>            <span class="k">return</span> <span class="bp">False</span>

        <span class="c1"># íŒŒì¼ ì„ íƒ ëª¨ë“œ
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1"># ì¡´ì¬í•˜ê³ , íŒŒì¼ì´ì–´ì•¼ í•¨
</span>            <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
                <span class="c1"># í•„í„°ë„ í†µê³¼í•´ì•¼ í•¨
</span>                <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">_match_type_filters</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">target</span><span class="p">).</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># save ëª¨ë“œ: ì¡´ì¬ ì—¬ë¶€ ë¬´ê´€, ìƒìœ„ í´ë”ê°€ ìˆì–´ì•¼ í•¨
</span>            <span class="n">parent</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">target</span><span class="p">).</span><span class="n">parent</span>
            <span class="k">if</span> <span class="n">parent</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">parent</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
                <span class="c1"># íŒŒì¼ëª… í•„í„°ë„ í†µê³¼í•˜ëŠ”ì§€(ì„ íƒí•œ í•„í„°ì™€ ë§ì§€ ì•Šì•„ë„ ì €ì¥ í—ˆìš©í• ì§€ ì •ì±… ê²°ì •)
</span>                <span class="c1"># ì—¬ê¸°ì„œëŠ” í—ˆìš©(ì‚¬ìš©ìê°€ í•„í„° ë°”ê¾¸ì§€ ì•Šê³  í™•ì¥ì ì§ì ‘ ì…ë ¥ ê°€ëŠ¥)
</span>                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_match_type_filters</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">.</span><span class="nf">currentText</span><span class="p">()</span>
        <span class="c1"># ê´„í˜¸ ì•ˆ íŒ¨í„´ë“¤ ì¶”ì¶œ
</span>        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">(</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="sh">"</span><span class="s">)</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">inside</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">text</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">(</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">text</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">)</span><span class="sh">"</span><span class="p">)]</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">inside</span><span class="p">.</span><span class="nf">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">patterns</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fnmatch</span><span class="p">.</span><span class="nf">fnmatch</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">pat</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_update_ok_enabled</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">ok_btn</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">.</span><span class="nf">button</span><span class="p">(</span><span class="n">QDialogButtonBox</span><span class="p">.</span><span class="n">Ok</span><span class="p">)</span>
        <span class="n">ok_btn</span><span class="p">.</span><span class="nf">setEnabled</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_is_selection_valid</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_accept_if_valid</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_is_selection_valid</span><span class="p">():</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">accept</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">ì„ íƒ í™•ì¸</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ì„ íƒì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># ---------- ê²½ë¡œ ì…ë ¥ + ë¹„ë™ê¸° ìë™ì™„ì„± ----------
</span>    <span class="k">def</span> <span class="nf">_on_path_edited</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
        <span class="c1"># ë””ë°”ìš´ìŠ¤ í›„ ê²€ìƒ‰ íƒœìŠ¤í¬ ì‹¤í–‰
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="c1"># ì…ë ¥ ì¤‘ì—ë„ OK ë²„íŠ¼ ìƒíƒœ ì ì ˆíˆ ì¡°ì •
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">_update_ok_enabled</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_spawn_completer_task</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">model</span><span class="p">().</span><span class="nf">setStringList</span><span class="p">([])</span> <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">model</span><span class="p">()</span> <span class="k">else</span> <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setModel</span><span class="p">(</span><span class="nc">QCompleter</span><span class="p">([],</span> <span class="n">self</span><span class="p">).</span><span class="nf">model</span><span class="p">())</span>
            <span class="k">return</span>

        <span class="c1"># base_dirì™€ prefix ë¶„ë¦¬
</span>        <span class="c1"># ì˜ˆ: "/a/b/pa" -&gt; base="/a/b", prefix="pa"
</span>        <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">text</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">):</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="n">text</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="k">if</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="o">!=</span> <span class="sh">""</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span>

        <span class="n">want_files</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">want_dirs</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c1"># í•­ìƒ ë””ë ‰í„°ë¦¬ë„ ì œì•ˆ: ê²½ë¡œ ì™„ì„±ì— ì¤‘ìš”
</span>        <span class="n">top_k</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">depth_limit</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># ë„ˆë¬´ ê¹Šì´ ë“¤ì–´ê°€ë©´ ëŠë ¤ì§
</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_completer_task_id</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_latest_task_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_completer_task_id</span>
        <span class="n">task</span> <span class="o">=</span> <span class="nc">PathSearchTask</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_completer_task_id</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span>
                              <span class="n">want_files</span><span class="p">,</span> <span class="n">want_dirs</span><span class="p">,</span> <span class="n">top_k</span><span class="p">,</span> <span class="n">depth_limit</span><span class="p">,</span>
                              <span class="n">self</span><span class="p">.</span><span class="n">_completer_emitter</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_thread_pool</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

    <span class="nd">@Slot</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_on_completer_results</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="c1"># ìµœì‹  ìš”ì²­ë§Œ ë°˜ì˜
</span>        <span class="k">if</span> <span class="n">task_id</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_latest_task_id</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># ê²°ê³¼ë¥¼ ê°€ê¹Œìš´ ê²½ë¡œë¶€í„° ì •ë ¬(ë¬¸ìì—´ ê¸¸ì´/ì‚¬ì „ì‹)
</span>        <span class="n">results_sorted</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span><span class="p">.</span><span class="nf">lower</span><span class="p">()))</span>
        <span class="c1"># QCompleter ê°±ì‹ 
</span>        <span class="n">model</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">model</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">and</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="sh">'</span><span class="s">setStringList</span><span class="sh">'</span><span class="p">):</span>
            <span class="n">model</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">(</span><span class="n">results_sorted</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">string_list_model</span> <span class="o">=</span> <span class="nc">QCompleter</span><span class="p">(</span><span class="n">results_sorted</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">model</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setModel</span><span class="p">(</span><span class="n">string_list_model</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">complete</span><span class="p">()</span>  <span class="c1"># íŒì—… ì—´ê¸° ì‹œë„
</span>
    <span class="c1"># ---------- ì™¸ë¶€ API ----------
</span>    <span class="k">def</span> <span class="nf">selected_path</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>

<span class="c1"># --------------------------
# ì‹¤í–‰ ì˜ˆì‹œ
# --------------------------
</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">app</span> <span class="o">=</span> <span class="nc">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span>

    <span class="c1"># ì‚¬ìš© ì˜ˆì‹œ 1: íŒŒì¼ Open
</span>    <span class="n">dlg1</span> <span class="o">=</span> <span class="nc">CFileDialog</span><span class="p">(</span>
        <span class="n">start_path</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">(),</span>
        <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">select_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">filters</span><span class="o">=</span><span class="p">[</span>
            <span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">Text Files (*.txt *.md)</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">Images (*.png *.jpg *.jpeg *.bmp *.gif)</span><span class="sh">"</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">dlg1</span><span class="p">.</span><span class="nf">exec</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">OPEN FILE:</span><span class="sh">"</span><span class="p">,</span> <span class="n">dlg1</span><span class="p">.</span><span class="nf">selected_path</span><span class="p">())</span>

    <span class="c1"># ì‚¬ìš© ì˜ˆì‹œ 2: í´ë” ì„ íƒ
</span>    <span class="n">dlg2</span> <span class="o">=</span> <span class="nc">CFileDialog</span><span class="p">(</span>
        <span class="n">start_path</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">(),</span>
        <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">select_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">folder</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">dlg2</span><span class="p">.</span><span class="nf">exec</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">SELECT FOLDER:</span><span class="sh">"</span><span class="p">,</span> <span class="n">dlg2</span><span class="p">.</span><span class="nf">selected_path</span><span class="p">())</span>

    <span class="c1"># ì‚¬ìš© ì˜ˆì‹œ 3: íŒŒì¼ Save
</span>    <span class="n">dlg3</span> <span class="o">=</span> <span class="nc">CFileDialog</span><span class="p">(</span>
        <span class="n">start_path</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">(),</span>
        <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">save</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">select_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Python (*.py)</span><span class="sh">"</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">dlg3</span><span class="p">.</span><span class="nf">exec</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">SAVE FILE:</span><span class="sh">"</span><span class="p">,</span> <span class="n">dlg3</span><span class="p">.</span><span class="nf">selected_path</span><span class="p">())</span>

    <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>ì„¤ëª… í¬ì¸íŠ¸ ì •ë¦¬</p>

<ul>
  <li>
    <p>ìë™ì™„ì„± ë¹„ë™ê¸°í™”<br />
ì…ë ¥ì´ ë°”ë€Œë©´ 200ms ë””ë°”ìš´ìŠ¤ í›„ <code class="language-plaintext highlighter-rouge">QThreadPool</code>ì— <code class="language-plaintext highlighter-rouge">PathSearchTask</code>ë¥¼ ë˜ì ¸ì„œ, í˜„ì¬ ì…ë ¥ ê¸°ì¤€ <code class="language-plaintext highlighter-rouge">base_dir</code> ì•„ë˜ì—ì„œ ì´ë¦„ì´ ì ‘ë‘ì‚¬ë¡œ ë§ëŠ” ê²½ë¡œë“¤ì„ ìµœëŒ€ 10ê°œ ì°¾ëŠ”ë‹¤. ê²°ê³¼ëŠ” <code class="language-plaintext highlighter-rouge">task_id</code>ë¡œ ìµœì‹ ì„± í™•ì¸ í›„ì—ë§Œ <code class="language-plaintext highlighter-rouge">QCompleter</code> ëª¨ë¸ì„ ê°±ì‹ í•œë‹¤. ë„¤íŠ¸ì›Œí¬ ë“œë¼ì´ë¸Œì²˜ëŸ¼ ëŠë¦° í™˜ê²½ì—ì„œë„ ë©”ì¸ ìŠ¤ë ˆë“œë¥¼ ë§‰ì§€ ì•Šìœ¼ë©´ì„œ ì ì§„ì ìœ¼ë¡œ í›„ë³´ë¥¼ ë³´ì—¬ì¤€ë‹¤.</p>
  </li>
  <li>
    <p>í›„ë³´ í’ˆì§ˆ<br />
1ìˆœìœ„ë¡œ í˜„ì¬ í´ë”ì˜ ì§ì† í•­ëª©ì„ ì‚´í”¼ê³ , ë¶€ì¡±í•˜ë©´ ì–•ì€ ê¹Šì´(ê¸°ë³¸ 2)ë§Œ BFSë¡œ í™•ì¥í•´ ê·¼ì²˜ ê²½ë¡œë¥¼ ì œì•ˆí•œë‹¤. ì •ë ¬ì€ ê¸¸ì´â†’ì‚¬ì „ì‹ìœ¼ë¡œ í•´ì„œ ë” â€œê°€ê¹Œìš´â€ ê²½ë¡œê°€ ë¨¼ì € ì˜¨ë‹¤.</p>
  </li>
  <li>
    <p>í•„í„°<br />
<code class="language-plaintext highlighter-rouge">Type</code> ì½¤ë³´ë°•ìŠ¤ì˜ íŒ¨í„´ì„ <code class="language-plaintext highlighter-rouge">QFileSystemModel.setNameFilters</code>ë¡œ ì ìš©í–ˆë‹¤. Open íŒŒì¼ ëª¨ë“œì—ì„œëŠ” OK ì§ì „ì—ë„ íŒŒì¼ëª…ì´ íŒ¨í„´ê³¼ ë§ëŠ”ì§€ ë¹ ë¥´ê²Œ í™•ì¸í•œë‹¤.</p>
  </li>
  <li>
    <p>ë™ì‘ ì •ì±…<br />
Open+File: ì¡´ì¬í•˜ëŠ” íŒŒì¼ë§Œ OK.<br />
Open+Folder: ì¡´ì¬í•˜ëŠ” í´ë”ë§Œ OK.<br />
Save+File: ìƒìœ„ í´ë”ë§Œ ì¡´ì¬í•˜ë©´ OK(íŒŒì¼ì€ ì—†ì–´ë„ ë¨).<br />
Save+Folder ì •ì±…ì€ ì˜ˆì œì—ì„  ë§‰ì•„ë‘ì—ˆëŠ”ë°, ì›í•˜ë©´ ì˜µì…˜ìœ¼ë¡œ í—ˆìš© ë¡œì§ì„ ì¶”ê°€í•  ìˆ˜ ìˆë‹¤.</p>
  </li>
  <li>
    <p>ê²½ë¡œ ì½¤ë³´<br />
í˜„ì¬ ê²½ë¡œì˜ ë£¨íŠ¸ë¶€í„° ë‹¨ê³„ì ìœ¼ë¡œ ìŒ“ì•„ì„œ í‘œì‹œí•œë‹¤. í•­ëª© ì„ íƒ ì‹œ í•´ë‹¹ ê²½ë¡œë¡œ ì í”„í•œë‹¤. íˆìŠ¤í† ë¦¬ Back/Forward, ìƒìœ„ ì´ë™, ìƒˆ í´ë”ë„ ì§€ì›í•œë‹¤.</p>
  </li>
</ul>

<p>ë‹¤ìŒ í™•ì¥ ì•„ì´ë””ì–´</p>

<ul>
  <li>
    <p>ë„¤íŠ¸ì›Œí¬ ë“œë¼ì´ë¸Œì—ì„œ <code class="language-plaintext highlighter-rouge">depth_limit</code>ë¥¼ ë™ì ìœ¼ë¡œ ì¡°ì ˆ(ì§€ì—° ê¸¸ì´ì— ë”°ë¼ 1â†”3).</p>
  </li>
  <li>
    <p>ìˆ¨ê¹€ íŒŒì¼ í† ê¸€, ìµœê·¼ ìœ„ì¹˜/ì¦ê²¨ì°¾ê¸° ì‚¬ì´ë“œë°” ì¶”ê°€.</p>
  </li>
  <li>
    <p>ë©€í‹° ì„ íƒ ì§€ì›(íŒŒì¼ ë‹¤ì¤‘ ì„ íƒ ëª¨ë“œ).</p>
  </li>
  <li>
    <p>Windows ë“œë¼ì´ë¸Œ ë£¨íŠ¸(â€œC:\â€, â€œD:\â€) ëª©ë¡ì„ ì½¤ë³´ì— ìë™ ì‚½ì….</p>
  </li>
</ul>

<p>ì¶”ê°€ë¡œ ì›í•˜ëŠ” ë™ì‘ ì •ì±…ì´ë‚˜ ì„¸ë¶€ UXê°€ ìˆìœ¼ë©´ ë§í•´ì¤˜. ë°”ë¡œ ì½”ë“œì— ë…¹ì—¬ì„œ ì™„ì„±ë„ë¥¼ ë” ëŒì–´ì˜¬ë ¤ë³¼ê²Œ.</p>

<p class="chat--user">

í˜¹ì‹œ ë” ì¢‹ì€ ê°œë°œ ë°©í–¥ ìˆì–´?

</p>

<p>ì¢‹ì§€! ì§€ê¸ˆë„ ê½¤ ì“¸ë§Œí•˜ì§€ë§Œ, â€œë” ê²¬ê³ í•˜ê³  ë¹ ë¥´ê³  í™•ì¥ ê°€ëŠ¥í•œâ€ ë°©í–¥ìœ¼ë¡œ ë‹¤ë“¬ì„ ìˆ˜ ìˆëŠ” í¬ì¸íŠ¸ë“¤ì„ ì œì•ˆí• ê²Œ. ë‹¹ì¥ ì ìš©í•  ìˆ˜ ìˆëŠ” ê²ƒë¶€í„° ì¤‘ì¥ê¸°ì ì¸ ë¦¬íŒ©í„°ë§ ì•„ì´ë””ì–´ê¹Œì§€, ì‹¤ì „ì ì¸ ìˆœì„œë¡œ ì •ë¦¬í–ˆì–´.</p>

<h1 id="ì„±ëŠ¥ì•ˆì •ì„±">ì„±ëŠ¥Â·ì•ˆì •ì„±</h1>

<ol>
  <li>ìºì‹±ê³¼ ì·¨ì†Œ í† í°</li>
</ol>

<ul>
  <li>
    <p>ìë™ì™„ì„± í›„ë³´ íƒìƒ‰ ê²°ê³¼ë¥¼ ë””ë ‰í„°ë¦¬ ë‹¨ìœ„ë¡œ ìºì‹œí•˜ê³ , mtime(ë””ë ‰í„°ë¦¬ ìˆ˜ì • ì‹œê°„) + ì‚¬ì´ì¦ˆë¡œ ì‹ ì„ ë„ ì²´í¬.</p>
  </li>
  <li>
    <p>í˜„ì¬ task_id ë°©ì‹ì€ ìµœì‹ ì„± ë³´ì¥ì€ ë˜ì§€ë§Œ, ì“°ë ˆë“œê°€ ë¶ˆí•„ìš”í•˜ê²Œ ê³„ì† ëˆë‹¤ëŠ” ë‹¨ì ì´ ìˆì–´. <code class="language-plaintext highlighter-rouge">PathSearchTask</code>ì— <code class="language-plaintext highlighter-rouge">cancelled</code> í”Œë˜ê·¸(ì“°ë ˆë“œ ì•ˆì „) ë„£ì–´ì„œ ì˜¤ë˜ ê±¸ë¦¬ëŠ” ë„¤íŠ¸ì›Œí¬ ë””ë ‰í„°ë¦¬ íƒìƒ‰ì„ ì¤‘ê°„ ì·¨ì†Œ ê°€ëŠ¥í•˜ê²Œ ë§Œë“¤ë©´ ëŒ€ê¸°ì‹œê°„ì„ í¬ê²Œ ì¤„ì¼ ìˆ˜ ìˆì–´.</p>
  </li>
</ul>

<ol>
  <li>ì ì§„ì  ìë™ì™„ì„±(Incremental feed)</li>
</ol>

<ul>
  <li>í•œ ë²ˆì— 10ê°œë¥¼ ì°¾ì„ ë•Œê¹Œì§€ ë„ëŠ” ëŒ€ì‹ , 3ê°œ ë‹¨ìœ„ë¡œ ë¨¼ì € emit â†’ UI ê°±ì‹  â†’ ë‚¨ì€ í›„ë³´ ê³„ì† íƒìƒ‰. ì‚¬ìš©ìëŠ” ì¦‰ì‹œ ë°˜ì‘ì„ ë³´ê²Œ ë˜ê³ , ë‚˜ë¨¸ì§€ëŠ” ë’¤ëŠ¦ê²Œ ì±„ì›Œì§„ë‹¤.</li>
</ul>

<ol>
  <li>QFileSystemWatcher ì—°ë™</li>
</ol>

<ul>
  <li>ë£¨íŠ¸ ì¸ë±ìŠ¤ ê¸°ì¤€ìœ¼ë¡œ í•˜ìœ„ ë””ë ‰í„°ë¦¬ì— ë³€í™”ê°€ ìƒê¸°ë©´ ìºì‹œë¥¼ ë¬´íš¨í™”í•˜ê³  ë¦¬ìŠ¤íŠ¸ë·°ë¥¼ ë¶€ë“œëŸ½ê²Œ ê°±ì‹ . ë„¤íŠ¸ì›Œí¬ í™˜ê²½ì—ì„œë„ ë³€í™”ë¥¼ ì¦‰ì‹œ ë°˜ì˜í•  ìˆ˜ ìˆë‹¤.</li>
</ul>

<ol>
  <li>ì•„ì´ì½˜Â·ë©”íƒ€ë°ì´í„° ì§€ì—° ë¡œë”©</li>
</ol>

<ul>
  <li><code class="language-plaintext highlighter-rouge">QFileSystemModel</code>ì˜ ì•„ì´ì½˜ ë¡œë”©ì€ ëŠë¦´ ìˆ˜ ìˆë‹¤. <code class="language-plaintext highlighter-rouge">QFileIconProvider</code>ë¥¼ ìƒì†í•´ ì¸ë„¤ì¼Â·ì•„ì´ì½˜ì„ ë³„ë„ ìŠ¤ë ˆë“œì—ì„œ ì§€ì—° ë¡œë”©í•˜ê³ , ì„ì‹œ ê¸°ë³¸ ì•„ì´ì½˜ì„ ë¨¼ì € ë³´ì—¬ì£¼ë©´ ìŠ¤í¬ë¡¤ ì§€ì—°ì´ ì¤„ì–´ë“ ë‹¤.</li>
</ul>

<ol>
  <li>ëŒ€ìš©ëŸ‰ í´ë” ê°€ìƒí™”</li>
</ol>

<ul>
  <li>ìˆ˜ë§Œ ê°œ í•­ëª©ì´ ìˆëŠ” ë””ë ‰í„°ë¦¬ì—ì„œëŠ” ëª¨ë“  í•­ëª©ì„ ëª¨ë¸ì— ì˜¬ë¦¬ëŠ” ê²ƒë§Œìœ¼ë¡œë„ ëŠë ¤ì§„ë‹¤. <code class="language-plaintext highlighter-rouge">QSortFilterProxyModel</code>ë¡œ ê°€ë³ê²Œ í•„í„°ë§í•˜ê³ , ìŠ¤í¬ë¡¤ ìœ„ì¹˜ì— ë”°ë¼ ë³´ì´ëŠ” êµ¬ê°„ë§Œ í”„ë¦¬í˜ì¹˜í•˜ëŠ” â€œí˜ì´ì§•/ìœˆë„ìš°ë§â€ ê¸°ë²•ì„ ì ìš©í•˜ë©´ ì²´ê° ì„±ëŠ¥ì´ í¬ê²Œ ì¢‹ì•„ì§„ë‹¤.</li>
</ul>

<h1 id="ì•„í‚¤í…ì²˜ìœ ì§€ë³´ìˆ˜">ì•„í‚¤í…ì²˜Â·ìœ ì§€ë³´ìˆ˜</h1>

<ol>
  <li>ëª¨ë¸/ë·° ë¶„ë¦¬ ê°•í™”</li>
</ol>

<ul>
  <li>í˜„ì¬ëŠ” <code class="language-plaintext highlighter-rouge">QFileSystemModel</code> í•˜ë‚˜ë¡œ ëŒ€ë¶€ë¶„ í•´ê²° ì¤‘. ì—¬ê¸°ì— â€œì„ íƒ ì •ì±…â€, â€œí•„í„° ì •ì±…â€, â€œíˆìŠ¤í† ë¦¬/ë„¤ë¹„ê²Œì´ì…˜ ì •ì±…â€ì„ ì–¹ì€ ì„œë¹„ìŠ¤ ê³„ì¸µ(ì‘ì€ í´ë˜ìŠ¤ë¡œ) ë¶„ë¦¬í•˜ë©´ í…ŒìŠ¤íŠ¸ ìš©ì´ì„±â†‘.<br />
ì˜ˆ) <code class="language-plaintext highlighter-rouge">NavigationHistory</code>, <code class="language-plaintext highlighter-rouge">FilterPolicy</code>, <code class="language-plaintext highlighter-rouge">SelectionValidator</code>, <code class="language-plaintext highlighter-rouge">CompleterProvider</code>.</li>
</ul>

<ol>
  <li>ì¸í„°í˜ì´ìŠ¤ í˜¸í™˜ì„± ë ˆì´ì–´</li>
</ol>

<ul>
  <li><code class="language-plaintext highlighter-rouge">QFileDialog.getOpenFileName()</code> ê°™ì€ ì •ì  APIì™€ í˜¸í™˜ë˜ëŠ” ë˜í¼ ì œê³µ.<br />
ì˜ˆ) <code class="language-plaintext highlighter-rouge">CFileDialog.getOpenFileName(parent, caption, dir, filter)</code> í˜•íƒœë¡œ ë°˜í™˜ íƒ€ì…ë„ ë™ì¼í•˜ê²Œ ë§ì¶°ì£¼ë©´ ê¸°ì¡´ ì½”ë“œ ì¹˜í™˜ì´ ì‰½ë‹¤.</li>
</ul>

<ol>
  <li>ìœ ì—°í•œ í”ŒëŸ¬ê·¸ì¸ í•„í„°</li>
</ol>

<ul>
  <li>ë‹¨ìˆœ íŒ¨í„´ í•„í„°(â€œ*.pngâ€) ì™¸ì— ì‚¬ìš©ì ì •ì˜ í•„í„° ì½œë°±ì„ ì§€ì›.<br />
ì˜ˆ) â€œìµœê·¼ 24ì‹œê°„ ìˆ˜ì •â€ â€œí¬ê¸° 100MB ì´ìƒâ€ ê°™ì€ ì¡°ê±´ì„ ì¶”ê°€ í•„í„°ë¡œ ë¼ì›Œ ë„£ê¸°.</li>
</ul>

<ol>
  <li>í…ŒìŠ¤íŠ¸ ì „ëµ</li>
</ol>

<ul>
  <li>ë¡œì»¬/ë„¤íŠ¸ì›Œí¬ íŒŒì¼ì‹œìŠ¤í…œì„ í‰ë‚´ë‚´ëŠ” ê°€ì§œ íŒŒì¼ì‹œìŠ¤í…œ(fsys) ì–´ëŒ‘í„° ë„ì…. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ fs ì–´ëŒ‘í„° ì¸í„°í˜ì´ìŠ¤ì— ì˜ì¡´í•˜ê²Œ í•˜ê³ , í…ŒìŠ¤íŠ¸ì—ì„œëŠ” ë©”ëª¨ë¦¬ìƒ ê°€ì§œ íŠ¸ë¦¬ë¡œ ê²€ì¦.</li>
</ul>

<h1 id="uxíƒìƒ‰ì„±">UXÂ·íƒìƒ‰ì„±</h1>

<ol>
  <li>ë¸Œë ˆë“œí¬ëŸ¼(breadcrumbs) ìœ„ì ¯</li>
</ol>

<ul>
  <li>í˜„ì¬ ê²½ë¡œ ì½¤ë³´ëŠ” ì¢‹ì§€ë§Œ, í´ë¦­ ê°€ëŠ¥í•œ ì¡°ê°(í´ë” ë‹¨ì¶”ë“¤)ë¡œ í‘œì‹œí•˜ë©´ ìƒìœ„ë¡œ ì í”„ê°€ ë” ì§ê´€ì . ë“œë˜ê·¸ë¡œ í•˜ìœ„ í¼ì¹˜ê¸°ê¹Œì§€ ì§€ì›í•˜ë©´ ê¸ˆìƒì²¨í™”.</li>
</ul>

<ol>
  <li>Places/ì‚¬ì´ë“œë°”</li>
</ol>

<ul>
  <li>í™ˆ, ë°ìŠ¤í¬í†±, ë‹¤ìš´ë¡œë“œ, ë“œë¼ì´ë¸Œ ë£¨íŠ¸, ì¦ê²¨ì°¾ê¸°(í•€), ìµœê·¼ ìœ„ì¹˜ ì„¹ì…˜ ì¶”ê°€. Qtì˜ <code class="language-plaintext highlighter-rouge">QFileDialog</code>ê°€ ì£¼ëŠ” ê²½í—˜ì„ ì¬í˜„í•˜ë©´ì„œë„ ì»¤ìŠ¤í…€í™” ê°€ëŠ¥.</li>
</ul>

<ol>
  <li>í‚¤ë³´ë“œ ë‚´ë¹„ê²Œì´ì…˜</li>
</ol>

<ul>
  <li>F2: ì´ë¦„ ë°”ê¾¸ê¸°, Del: ì‚­ì œ(ì˜µì…˜), Alt+â†‘: ìƒìœ„, Alt+â†/â†’: ë’¤/ì•, Ctrl+L: ê²½ë¡œ í¬ì»¤ìŠ¤ ê°™ì€ ë‹¨ì¶•í‚¤. í…ìŠ¤íŠ¸ ì‚¬ìš©ìê°€ íŠ¹íˆ ë¹¨ë¼ì§„ë‹¤.</li>
</ul>

<ol>
  <li>ë©€í‹°ì„ íƒ</li>
</ol>

<ul>
  <li>íŒŒì¼ ëª¨ë“œì—ì„œ ë‹¤ì¤‘ ì„ íƒì„ ì˜µì…˜ìœ¼ë¡œ ì§€ì›í•˜ê³ , í•˜ë‹¨ì— ì„ íƒ ê°œìˆ˜/í•©ê³„ í¬ê¸° í‘œì‹œ. ì €ì¥ ëª¨ë“œì—ì„œë„ â€œì—¬ëŸ¬ ê°œë¥¼ í•œ ë²ˆì—â€ëŠ” ë³´í†µ í—ˆìš©í•˜ì§€ ì•Šì§€ë§Œ ì˜µì…˜ìœ¼ë¡œ ë…¸ì¶œ ê°€ëŠ¥.</li>
</ul>

<ol>
  <li>ìë™ì™„ì„± UX ë””í…Œì¼</li>
</ol>

<ul>
  <li>íƒ­(Tab)ìœ¼ë¡œ ì²« í›„ë³´ ìë™ì™„ì„±, ì˜¤ë¥¸ìª½ í™”ì‚´í‘œë¡œ ê²½ë¡œ êµ¬ë¶„ì ìë™ ì‚½ì…, ëì— êµ¬ë¶„ì ì…ë ¥ ì‹œ ì¦‰ì‹œ ìƒìœ„ 10ê°œ í•˜ìœ„ ë””ë ‰í„°ë¦¬ ì¬ê²€ìƒ‰ ë“± íƒ€ì íë¦„ ìµœì í™”.</li>
</ul>

<h1 id="ë„¤íŠ¸ì›Œí¬í”Œë«í¬ì˜´-ê³ ë ¤">ë„¤íŠ¸ì›Œí¬Â·í”Œë«í¬ì˜´ ê³ ë ¤</h1>

<ol>
  <li>UNC/SMBÂ·ë¦¬ëˆ…ìŠ¤ ë§ˆìš´íŠ¸Â·ë§¥ ë³¼ë¥¨</li>
</ol>

<ul>
  <li>Windows UNC ê²½ë¡œ(\server\share) íŒŒì‹±ê³¼ ìë™ì™„ì„±, Linuxì˜ /mnt, macOSì˜ /Volumes ê°ì§€. ë„¤íŠ¸ì›Œí¬ ë“œë¼ì´ë¸ŒëŠ” depth_limitì„ ê¸°ë³¸ 1ë¡œ, ì§€ì—° ì‹œê°„ ì¸¡ì • í›„ ë™ì  í™•ì¥.</li>
</ul>

<ol>
  <li>ì‹¬ë³¼ë¦­ ë§í¬Â·ìˆœí™˜ ë°©ì§€</li>
</ol>

<ul>
  <li>BFSì—ì„œ symlinkëŠ” ë³„ë„ ì„¸íŠ¸ë¡œ ì¶”ì , ê°™ì€ inode/ê²½ë¡œ í•´ì‹œ ì¬ë°©ë¬¸ ë°©ì§€. ë„¤íŠ¸ì›Œí¬ì—ì„œ ë§í¬ ë£¨í”„ê°€ ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ í•„ìˆ˜.</li>
</ul>

<ol>
  <li>ê¸´ ê²½ë¡œ ì§€ì›(Windows)</li>
</ol>

<ul>
  <li>260ì ì œí•œ ìš°íšŒ(\?\ prefix) ì²˜ë¦¬ ì˜µì…˜.</li>
</ul>

<ol>
  <li>ê¶Œí•œÂ·ë½ ëŒ€ì‘</li>
</ol>

<ul>
  <li>PermissionErrorëŠ” ì´ë¯¸ ì²˜ë¦¬í–ˆì§€ë§Œ, ì €ì¥ ëª¨ë“œì—ì„œ íŒŒì¼ ë®ì–´ì“°ê¸° ê²½ê³ , ì½ê¸°ì „ìš© í´ë” ì•Œë¦¼, ë„¤íŠ¸ì›Œí¬ íƒ€ì„ì•„ì›ƒ í›„ ì¬ì‹œë„ ë²„íŠ¼ ê°™ì€ UXë¥¼ ì¶”ê°€.</li>
</ul>

<h1 id="ì ‘ê·¼ì„±í˜„ì§€í™”ë¸Œëœë”©">ì ‘ê·¼ì„±Â·í˜„ì§€í™”Â·ë¸Œëœë”©</h1>

<ol>
  <li>ì ‘ê·¼ì„±</li>
</ol>

<ul>
  <li>ê° ë²„íŠ¼ì— <code class="language-plaintext highlighter-rouge">accessibleName/Description</code> ì„¤ì •, í¬ì»¤ìŠ¤ ì¸ë””ì¼€ì´í„° ê°€ì‹œì„± ê°•í™”, ìŠ¤í¬ë¦°ë¦¬ë” ë¼ë²¨ë§.</li>
</ul>

<ol>
  <li>í˜„ì§€í™”(i18n)</li>
</ol>

<ul>
  <li>ë¬¸ìì—´ ë¶„ë¦¬ì™€ <code class="language-plaintext highlighter-rouge">QTranslator</code> ì ìš© í¬ì¸íŠ¸ ë§ˆë ¨.</li>
</ul>

<ol>
  <li>í…Œë§ˆ/ë‹¤í¬ëª¨ë“œ</li>
</ol>

<ul>
  <li>ì•„ì´ì½˜ ëŒ€ë¹„, ì„ íƒ í•˜ì´ë¼ì´íŠ¸, ê³ í•´ìƒë„ ìŠ¤ì¼€ì¼ë§(HiDPI) ë³´ì •.</li>
</ul>

<h1 id="ë””í…Œì¼-ì½”ë“œ-ì•„ì´ë””ì–´">ë””í…Œì¼ ì½”ë“œ ì•„ì´ë””ì–´</h1>

<ol>
  <li>ì·¨ì†Œ ê°€ëŠ¥í•œ íƒìƒ‰ íƒœìŠ¤í¬ ìŠ¤í…</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PathSearchTask</span><span class="p">(</span><span class="n">QRunnable</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="p">...,</span> <span class="n">cancel_flag</span><span class="p">):</span>
        <span class="bp">...</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span> <span class="o">=</span> <span class="n">cancel_flag</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nf">slow_scan</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span><span class="p">.</span><span class="nf">is_set</span><span class="p">():</span>
                <span class="k">return</span>
            <span class="bp">...</span>
</code></pre></div></div>

<ul>
  <li>ìƒˆ ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ ì´ì „ íƒœìŠ¤í¬ì˜ <code class="language-plaintext highlighter-rouge">cancel_flag.set()</code> í˜¸ì¶œ.</li>
</ul>

<ol>
  <li>ìºì‹œ í‚¤ì™€ ë¬´íš¨í™”</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cache_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">want_files</span><span class="p">,</span> <span class="n">want_dirs</span><span class="p">)</span>
<span class="n">entries</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">entries</span> <span class="ow">or</span> <span class="n">meta</span> <span class="o">!=</span> <span class="p">(</span><span class="nf">mtime</span><span class="p">(</span><span class="n">base_dir</span><span class="p">),</span> <span class="nf">dir_size_estimate</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)):</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="nf">list_dir_fast</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
    <span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="p">(</span><span class="nf">mtime</span><span class="p">(...),</span> <span class="nf">dir_size_estimate</span><span class="p">(...)))</span>
</code></pre></div></div>

<ol>
  <li>ì‚¬ìš©ì ì •ì˜ í•„í„° ì½œë°±</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">set_custom_filters</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">predicates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">QFileInfo</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]]):</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_predicates</span> <span class="o">=</span> <span class="n">predicates</span>
<span class="c1"># proxy modelì˜ filterAcceptsRowì—ì„œ ëª¨ë“  predicate AND ë§¤ì¹­
</span></code></pre></div></div>

<ol>
  <li>ë¸Œë ˆë“œí¬ëŸ¼</li>
</ol>

<ul>
  <li><code class="language-plaintext highlighter-rouge">QToolButton</code>ë“¤ì„ ë™ì ìœ¼ë¡œ ìƒì„±í•˜ê³ , ëˆŒë €ì„ ë•Œ ê·¸ ì¡°ê°ê¹Œì§€ì˜ ê²½ë¡œë¡œ ì´ë™. ë²„íŠ¼ì— ë©”ë‰´(í•˜ìœ„ ë””ë ‰í„°ë¦¬ ë¯¸ë¦¬ë³´ê¸°) ì—°ê²°í•˜ë©´ ë¹ ë¥¸ ì í”„ ê°€ëŠ¥.</li>
</ul>

<h1 id="ë‹¨ê³„ë³„-ì ìš©-ì¶”ì²œ">ë‹¨ê³„ë³„ ì ìš© ì¶”ì²œ</h1>

<ul>
  <li>
    <p>1ë‹¨ê³„: ìë™ì™„ì„± ì·¨ì†ŒÂ·ìºì‹œÂ·ì ì§„ì  ê°±ì‹ </p>
  </li>
  <li>
    <p>2ë‹¨ê³„: ë¸Œë ˆë“œí¬ëŸ¼ + Places ì‚¬ì´ë“œë°” + ë‹¨ì¶•í‚¤</p>
  </li>
  <li>
    <p>3ë‹¨ê³„: ì•„ì´ì½˜ ì§€ì—° ë¡œë”© + ëŒ€ìš©ëŸ‰ í´ë” ê°€ìƒí™”</p>
  </li>
  <li>
    <p>4ë‹¨ê³„: í”ŒëŸ¬ê·¸ì¸ í•„í„°Â·í…ŒìŠ¤íŠ¸ ì¸í”„ë¼Â·i18n</p>
  </li>
</ul>

<p>ì›í•˜ë©´ 1ë‹¨ê³„(ì·¨ì†Œ ê°€ëŠ¥í•œ ìë™ì™„ì„± + ìºì‹œ + ì ì§„ emit) ì½”ë“œë¥¼ ë„¤ ê°€ì§€ ë©”ì†Œë“œë§Œ ë°”ê¿”ì„œ ë°”ë¡œ íŒ¨ì¹˜ ê°€ëŠ¥í•œ í˜•íƒœë¡œ ì œê³µí• ê²Œ.</p>

<p class="chat--user">

Q_ARGì—ì„œ ì—ëŸ¬ë‚˜

</p>

<p>ë¬¸ì œ í¬ì¸íŠ¸ëŠ” ì—¬ê¸°ì˜ˆìš”:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">QMetaObject</span><span class="p">.</span><span class="nf">invokeMethod</span><span class="p">(</span>
    <span class="n">self</span><span class="p">.</span><span class="n">emitter</span><span class="p">,</span> <span class="sh">"</span><span class="s">resultsReady</span><span class="sh">"</span><span class="p">,</span> <span class="n">Qt</span><span class="p">.</span><span class="n">QueuedConnection</span><span class="p">,</span>
    <span class="nc">Q_ARG</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="p">),</span>
    <span class="nc">Q_ARG</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">results</span><span class="p">),</span>
<span class="p">)</span>
</code></pre></div></div>

<p>PySide6ì—ì„œ <code class="language-plaintext highlighter-rouge">Q_ARG(list, â€¦)</code>ëŠ” ìì£¼ ì‹¤íŒ¨í•©ë‹ˆë‹¤. Qt ë©”íƒ€ì‹œìŠ¤í…œì´ Pythonì˜ <code class="language-plaintext highlighter-rouge">list</code> íƒ€ì…ì„ ëª°ë¼ì„œì˜ˆìš”. ë˜í•œ ì´ ê²½ìš° êµ³ì´ <code class="language-plaintext highlighter-rouge">QMetaObject.invokeMethod</code>ë¥¼ ì“¸ í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤. ìŠ¤ë ˆë“œ ê°„ <code class="language-plaintext highlighter-rouge">Signal.emit()</code> ìì²´ê°€ ì•ˆì „í•˜ê²Œ íë“œ(queued)ë¡œ ë™ì‘í•©ë‹ˆë‹¤.</p>

<p>ê°€ì¥ ê°„ë‹¨í•˜ê³  ê²¬ê³ í•œ ìˆ˜ì •ì€ ë‹¤ìŒ ë‘ ê°€ì§€ ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤.</p>

<h1 id="í•´ê²°-a-ê·¸ëƒ¥-ì‹œê·¸ë„-emitìœ¼ë¡œ-ë°”ê¾¸ê¸°ê¶Œì¥">í•´ê²° A: ê·¸ëƒ¥ ì‹œê·¸ë„ emitìœ¼ë¡œ ë°”ê¾¸ê¸°(ê¶Œì¥)</h1>

<p><code class="language-plaintext highlighter-rouge">PathSearchTask._emit()</code>ì„ ì´ë ‡ê²Œ ë°”ê¾¸ì„¸ìš”:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_emit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
    <span class="c1"># ì›Œì»¤(ì“°ë ˆë“œ)ì—ì„œ emití•˜ë©´ ìë™ìœ¼ë¡œ QueuedConnectionìœ¼ë¡œ ì „ë‹¬ë¨
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">emitter</span><span class="p">.</span><span class="n">resultsReady</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></div>

<p>ê·¸ë¦¬ê³  <code class="language-plaintext highlighter-rouge">from PySide6.QtCore import QMetaObject, Q_ARG</code> ì„í¬íŠ¸ëŠ” ì œê±°í•´ë„ ë©ë‹ˆë‹¤.</p>

<p>ì´ê²Œ ê°€ì¥ ê¹”ë”í•˜ê³  PySide6ì—ì„œ ê¶Œì¥ë˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.</p>

<h1 id="í•´ê²°-b-invokemethodë¥¼-ê¼­-ì“°ê³ -ì‹¶ë‹¤ë©´">í•´ê²° B: invokeMethodë¥¼ ê¼­ ì“°ê³  ì‹¶ë‹¤ë©´</h1>

<p><code class="language-plaintext highlighter-rouge">list</code> ê°™ì€ íŒŒì´ì¬ ì»¨í…Œì´ë„ˆëŠ” ë©”íƒ€ì‹œìŠ¤í…œì— ë“±ë¡ë˜ì–´ ìˆì§€ ì•Šì•„ì„œ íƒ€ì… ìë¦¬ì— <code class="language-plaintext highlighter-rouge">object</code>ë¥¼ ì¨ì•¼ í•©ë‹ˆë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="n">QMetaObject</span><span class="p">,</span> <span class="n">Q_ARG</span>

<span class="k">def</span> <span class="nf">_emit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">QMetaObject</span><span class="p">.</span><span class="nf">invokeMethod</span><span class="p">(</span>
            <span class="n">self</span><span class="p">.</span><span class="n">emitter</span><span class="p">,</span> <span class="sh">"</span><span class="s">resultsReady</span><span class="sh">"</span><span class="p">,</span> <span class="n">Qt</span><span class="p">.</span><span class="n">QueuedConnection</span><span class="p">,</span>
            <span class="nc">Q_ARG</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="p">),</span>
            <span class="nc">Q_ARG</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">results</span><span class="p">),</span>   <span class="c1"># í•µì‹¬: list ëŒ€ì‹  object
</span>        <span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></div>

<p>ì´ ë°©ì‹ë„ ë™ì‘í•˜ê¸´ í•˜ì§€ë§Œ, Aì•ˆì²˜ëŸ¼ ê·¸ëƒ¥ <code class="language-plaintext highlighter-rouge">emit()</code>ì„ ì“°ëŠ” í¸ì´ ëœ ë²ˆê±°ë¡­ê³  ì‹¤ì „ì—ì„œ ì˜¤ë¥˜ê°€ ì ìŠµë‹ˆë‹¤.</p>

<h1 id="ì¶”ê°€ë¡œ-í•¨ê»˜-ê³ ì¹˜ë©´-ì¢‹ì€-ë¶€ë¶„">ì¶”ê°€ë¡œ í•¨ê»˜ ê³ ì¹˜ë©´ ì¢‹ì€ ë¶€ë¶„</h1>

<p><code class="language-plaintext highlighter-rouge">QCompleter</code>ì— ë¬¸ìì—´ ëª©ë¡ì„ ë„£ì„ ë•ŒëŠ” <code class="language-plaintext highlighter-rouge">QStringListModel</code> í•˜ë‚˜ë¥¼ ì¬ì‚¬ìš©í•˜ëŠ” ê²Œ ì¢‹ì•„ìš”.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="n">QStringListModel</span>

<span class="c1"># __init__ì—ì„œ
</span><span class="n">self</span><span class="p">.</span><span class="n">_slm</span> <span class="o">=</span> <span class="nc">QStringListModel</span><span class="p">([],</span> <span class="n">self</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">completer</span> <span class="o">=</span> <span class="nc">QCompleter</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setCaseSensitivity</span><span class="p">(</span><span class="n">Qt</span><span class="p">.</span><span class="n">CaseInsensitive</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setFilterMode</span><span class="p">(</span><span class="n">Qt</span><span class="p">.</span><span class="n">MatchContains</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setCompletionMode</span><span class="p">(</span><span class="n">QCompleter</span><span class="p">.</span><span class="n">PopupCompletion</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setCompleter</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">)</span>

<span class="c1"># ê²°ê³¼ ìˆ˜ì‹  ìŠ¬ë¡¯ì—ì„œ
</span><span class="nd">@Slot</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_on_completer_results</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">task_id</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_latest_task_id</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">results_sorted</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span><span class="p">.</span><span class="nf">lower</span><span class="p">()))</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">(</span><span class="n">results_sorted</span><span class="p">)</span>
    <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">complete</span><span class="p">()</span>
</code></pre></div></div>

<p>ì´ë ‡ê²Œ í•˜ë©´ ëª¨ë¸ ì¬ìƒì„±ì— ë”°ë¥¸ ê¹œë¹¡ì„Â·ì˜¤ë²„í—¤ë“œë„ ì¤„ê³ , íƒ€ì… ë¬¸ì œë„ ì‚¬ë¼ì§‘ë‹ˆë‹¤.</p>

<p>ì›ì¸ ìš”ì•½: <code class="language-plaintext highlighter-rouge">Q_ARG(list, â€¦)</code> ë•Œë¬¸ì— ìƒê¸´ íƒ€ì… ë¯¸ìŠ¤ë§¤ì¹˜ì…ë‹ˆë‹¤. ìŠ¤ë ˆë“œ-ì„¸ì´í”„ ì‹ í˜¸ë¥¼ ì§ì ‘ <code class="language-plaintext highlighter-rouge">emit()</code>í•˜ê±°ë‚˜, <code class="language-plaintext highlighter-rouge">Q_ARG(object, â€¦)</code>ë¡œ ë°”ê¾¸ë©´ í•´ê²°ë©ë‹ˆë‹¤. ë‹¤ìŒì— ëŠê¸°ëŠ” ê³³ì´ ìˆìœ¼ë©´ ì—ëŸ¬ ë©”ì‹œì§€ ì „ë¬¸ì„ ì•Œë ¤ì¤˜ìš”. traceback ê¸°ì¤€ìœ¼ë¡œ ë§ëŠ” íŒ¨ì¹˜ë¥¼ ë°”ë¡œ ì°ì–´ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

ì•„ë‹ˆ ì™œ íˆ´ì´ ë©ˆì¶”ëŠ”ê±°ì§€ ìê¾¸ /user/ ë§Œ ì¹˜ë©´ ë©ˆì¶°

</p>

<p>ë©ˆì¶¤ ì¦ìƒì€ ë³´í†µ ì„¸ ê°€ì§€ ì›ì¸ì—ì„œ í„°ì§‘ë‹ˆë‹¤.</p>

<ol>
  <li>
    <p>ë¹„ì¡´ì¬/ë„¤íŠ¸ì›Œí¬ ê²½ë¡œì—ì„œì˜ ê³¼ë„í•œ ìŠ¤ìº”</p>
  </li>
  <li>
    <p>ê²°ê³¼ ì ìš© ì‹œ ë©”ì¸ ìŠ¤ë ˆë“œ ìª½ ì¬ì§„ì…(Completer íŒì—…/ëª¨ë¸ ê°±ì‹ )</p>
  </li>
  <li>
    <p>ì´ì „ íƒœìŠ¤í¬ê°€ ê³„ì† ëŒì•„ê°€ëŠ” ìƒíƒœì—ì„œ ìƒˆ íƒœìŠ¤í¬ê°€ ëˆ„ì (ì·¨ì†Œ ë¶ˆê°€)</p>
  </li>
</ol>

<p>ì•„ë˜ íŒ¨ì¹˜ë¡œ í•œ ë²ˆì— ì¡ì„ ìˆ˜ ìˆì–´ìš”. í•µì‹¬ì€ ì·¨ì†Œ í† í°, ì•ˆì „í•œ ëª¨ë¸ ê°±ì‹ , ë£¨íŠ¸(/)Â·ë¹ˆ ì ‘ë‘ì‚¬ì—ì„œì˜ ìŠ¤ìº” ì–µì œì…ë‹ˆë‹¤.</p>

<h1 id="1-ì·¨ì†Œ-ê°€ëŠ¥í•œ-íƒœìŠ¤í¬--qstringlistmodel-ì¬ì‚¬ìš©">1) ì·¨ì†Œ ê°€ëŠ¥í•œ íƒœìŠ¤í¬ + QStringListModel ì¬ì‚¬ìš©</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># __init__ ì— ì¶”ê°€
</span><span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="n">QStringListModel</span>
<span class="kn">import</span> <span class="n">threading</span>

<span class="n">self</span><span class="p">.</span><span class="n">_slm</span> <span class="o">=</span> <span class="nc">QStringListModel</span><span class="p">([],</span> <span class="n">self</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">completer</span> <span class="o">=</span> <span class="nc">QCompleter</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setCaseSensitivity</span><span class="p">(</span><span class="n">Qt</span><span class="p">.</span><span class="n">CaseInsensitive</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setFilterMode</span><span class="p">(</span><span class="n">Qt</span><span class="p">.</span><span class="n">MatchContains</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setCompletionMode</span><span class="p">(</span><span class="n">QCompleter</span><span class="p">.</span><span class="n">PopupCompletion</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setCompleter</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">)</span>

<span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># íƒœìŠ¤í¬ ì·¨ì†Œ í† í°
</span></code></pre></div></div>

<h1 id="2-ë¹ˆ-ì ‘ë‘ì‚¬ë£¨íŠ¸-ê²½ë¡œì—ì„œì˜-ìŠ¤ìº”-ì œí•œ">2) ë¹ˆ ì ‘ë‘ì‚¬/ë£¨íŠ¸ ê²½ë¡œì—ì„œì˜ ìŠ¤ìº” ì œí•œ</h1>

<p>ì ‘ë‘ì‚¬ê°€ ë¹„ê±°ë‚˜ 1ê¸€ìì¼ ë•Œ, ê·¸ë¦¬ê³  ë² ì´ìŠ¤ê°€ ë£¨íŠ¸ì¼ ë•ŒëŠ” â€œì§ì ‘ í•˜ìœ„ë§Œâ€ ë³´ê±°ë‚˜ ì•„ì˜ˆ ìŠ¤ìº”ì„ ê±´ë„ˆëœë‹ˆë‹¤. íŠ¹íˆ â€œ/user/â€ ê°™ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ë¡œë¥¼ ì…ë ¥í•˜ë©´ ë² ì´ìŠ¤ê°€ â€œ/â€ë¡œ í´ë°±ë˜ëŠ”ë°, ì´ë•Œ ì „ì²´ BFSê°€ ê¸‰ë°œì§„í•  ìˆ˜ ìˆì–´ì„œ ë§‰ì•„ì•¼ í•´ìš”.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PathSearchTask</span><span class="p">(</span><span class="n">QRunnable</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">want_files</span><span class="p">,</span> <span class="n">want_dirs</span><span class="p">,</span>
                 <span class="n">top_k</span><span class="p">,</span> <span class="n">depth_limit</span><span class="p">,</span> <span class="n">emitter</span><span class="p">,</span> <span class="n">cancel_flag</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">task_id</span> <span class="o">=</span> <span class="n">task_id</span>
        <span class="n">self</span><span class="p">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">base_dir</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span>
        <span class="n">self</span><span class="p">.</span><span class="n">want_files</span> <span class="o">=</span> <span class="n">want_files</span>
        <span class="n">self</span><span class="p">.</span><span class="n">want_dirs</span> <span class="o">=</span> <span class="n">want_dirs</span>
        <span class="n">self</span><span class="p">.</span><span class="n">top_k</span> <span class="o">=</span> <span class="n">top_k</span>
        <span class="n">self</span><span class="p">.</span><span class="n">depth_limit</span> <span class="o">=</span> <span class="n">depth_limit</span>
        <span class="n">self</span><span class="p">.</span><span class="n">emitter</span> <span class="o">=</span> <span class="n">emitter</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cancel_flag</span> <span class="o">=</span> <span class="n">cancel_flag</span>

    <span class="k">def</span> <span class="nf">_cancelled</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">cancel_flag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">cancel_flag</span><span class="p">.</span><span class="nf">is_set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">base_dir</span><span class="p">)</span>
            <span class="c1"># resolve()ëŠ” ë„¤íŠ¸ì›Œí¬/ë¹„ì¡´ì¬ ê²½ë¡œì—ì„œ ë©ˆì¶œ ìˆ˜ ìˆì–´ ìƒëµí•˜ê³  exists()ë§Œ ì‚¬ìš©
</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
                <span class="c1"># ì¡´ì¬í•˜ëŠ” ê°€ì¥ ê°€ê¹Œìš´ ìƒìœ„ë¡œ í´ë°±
</span>                <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="p">[</span><span class="o">*</span><span class="n">base</span><span class="p">.</span><span class="n">parents</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">parent</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
                        <span class="n">base</span> <span class="o">=</span> <span class="n">parent</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">);</span> <span class="k">return</span>

            <span class="c1"># ì•ˆì „ì¥ì¹˜: ë£¨íŠ¸ì—ì„œ ì ‘ë‘ì‚¬ ê¸¸ì´ &lt; 2 ì¸ ê²½ìš°ëŠ” íƒìƒ‰í•˜ì§€ ì•ŠìŒ
</span>            <span class="n">is_root</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,</span> <span class="sh">"</span><span class="s">C:</span><span class="se">\\</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">D:</span><span class="se">\\</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># ìœˆë„ëŠ” í•„ìš” ì‹œ í™•ì¥
</span>            <span class="n">shallow_only</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">prefix</span> <span class="o">==</span> <span class="sh">""</span> <span class="ow">or</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">is_root</span>

            <span class="c1"># 1) ì§ì† í•­ëª©ë§Œ ë¨¼ì €
</span>            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_cancelled</span><span class="p">():</span> <span class="k">return</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span>
                        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">prefix</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">want_dirs</span><span class="p">:</span>
                                <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">want_files</span><span class="p">:</span>
                                <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
                        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span>
                            <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">);</span> <span class="k">return</span>
            <span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># 2) ì ‘ë‘ì‚¬ê°€ ì¶©ë¶„íˆ ê¸¸ê³  ë£¨íŠ¸ê°€ ì•„ë‹ˆë©´ ì–•ì€ BFS
</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">shallow_only</span><span class="p">:</span>
                <span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">deque</span> <span class="k">as</span> <span class="n">cdeque</span>
                <span class="n">q</span> <span class="o">=</span> <span class="nf">cdeque</span><span class="p">()</span>
                <span class="n">q</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">base</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">seen</span> <span class="o">=</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">)}</span>
                <span class="k">while</span> <span class="n">q</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_cancelled</span><span class="p">():</span> <span class="k">return</span>
                    <span class="n">cur</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="nf">popleft</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">depth_limit</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_cancelled</span><span class="p">():</span> <span class="k">return</span>
                                <span class="n">full</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                                    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">want_dirs</span> <span class="ow">and</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                                        <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">))</span>
                                        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span>
                                            <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">);</span> <span class="k">return</span>
                                    <span class="n">s</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                                        <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="n">q</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">full</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">want_files</span> <span class="ow">and</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                                        <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">))</span>
                                        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span>
                                            <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">);</span> <span class="k">return</span>
                    <span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
                        <span class="k">continue</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_emit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
        <span class="c1"># ìŠ¤ë ˆë“œì—ì„œ emití•˜ë©´ ìë™ìœ¼ë¡œ QueuedConnection
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">emitter</span><span class="p">.</span><span class="n">resultsReady</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
</code></pre></div></div>

<h1 id="3-ìƒˆ-ì…ë ¥ì´-ì˜¤ë©´-ì´ì „-íƒœìŠ¤í¬-ì¦‰ì‹œ-ì·¨ì†Œ">3) ìƒˆ ì…ë ¥ì´ ì˜¤ë©´ ì´ì „ íƒœìŠ¤í¬ ì¦‰ì‹œ ì·¨ì†Œ</h1>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_spawn_completer_task</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">([])</span>
        <span class="k">return</span>

    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">text</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">):</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="n">text</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="k">if</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span>

    <span class="n">want_files</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">want_dirs</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">top_k</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">depth_limit</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="c1"># ì´ì „ íƒœìŠ¤í¬ ì·¨ì†Œ
</span>    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span><span class="p">.</span><span class="nf">set</span><span class="p">()</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Event</span><span class="p">()</span>

    <span class="n">self</span><span class="p">.</span><span class="n">_completer_task_id</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_latest_task_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_completer_task_id</span>
    <span class="n">task</span> <span class="o">=</span> <span class="nc">PathSearchTask</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_completer_task_id</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span>
                          <span class="n">want_files</span><span class="p">,</span> <span class="n">want_dirs</span><span class="p">,</span> <span class="n">top_k</span><span class="p">,</span> <span class="n">depth_limit</span><span class="p">,</span>
                          <span class="n">self</span><span class="p">.</span><span class="n">_completer_emitter</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span><span class="p">)</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_thread_pool</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</code></pre></div></div>

<h1 id="4-ê²°ê³¼-ì ìš©ì€-ê°€ë³ê²Œ-íŒì—…-ì—´ê¸°ëŠ”-ì¡°ê±´ë¶€">4) ê²°ê³¼ ì ìš©ì€ ê°€ë³ê²Œ, íŒì—… ì—´ê¸°ëŠ” ì¡°ê±´ë¶€</h1>

<p>íŒì—…ì„ ë¬´ì¡°ê±´ ì—´ë©´ ì…ë ¥ ì¤‘ í¬ì»¤ìŠ¤/ì„ íƒê³¼ ì¶©ëŒí•  ìˆ˜ ìˆì–´ìš”. ê²°ê³¼ê°€ ìˆì„ ë•Œ, ì—ë””íŠ¸ê°€ í¬ì»¤ìŠ¤ë¥¼ ê°€ì§€ê³  ìˆì„ ë•Œë§Œ íŒì—…ì„ ì—´ë„ë¡ í•©ë‹ˆë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slot</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_on_completer_results</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">task_id</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_latest_task_id</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">results_sorted</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span><span class="p">.</span><span class="nf">lower</span><span class="p">()))</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">(</span><span class="n">results_sorted</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">results_sorted</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">hasFocus</span><span class="p">():</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">complete</span><span class="p">()</span>
</code></pre></div></div>

<h1 id="5-ë””ë°”ìš´ìŠ¤-ìƒí–¥--user-ê°™ì€-ì˜¤íƒ€-ë³´í˜¸">5) ë””ë°”ìš´ìŠ¤ ìƒí–¥ + â€œ/user/â€ ê°™ì€ ì˜¤íƒ€ ë³´í˜¸</h1>

<p>ì…ë ¥ì´ ë£¨íŠ¸ë¡œ í´ë°±ë  ìƒí™©ì—ì„œ ìì£¼ ìŠ¤ìº”í•˜ì§€ ì•Šë„ë¡ ë””ë°”ìš´ìŠ¤ë¥¼ 300~400msë¡œ ì˜¬ë¦¬ê³ , ì˜ ì•Œë ¤ì§„ ë£¨íŠ¸ í›„ë³´ê°€ ì•„ë‹Œ ê²½ìš° ë¹ˆ ê²°ê³¼ë¥¼ ì¤ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ macOSëŠ” â€œ/Usersâ€, LinuxëŠ” â€œ/usrâ€, WindowsëŠ” â€œ\server\shareâ€ íŒ¨í„´ë§Œ í—ˆìš©.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># __init__
</span><span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span><span class="p">.</span><span class="nf">setInterval</span><span class="p">(</span><span class="mi">350</span><span class="p">)</span>

<span class="c1"># _spawn_completer_task ì‹œì‘ë¶€
</span><span class="k">if</span> <span class="n">text</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,</span> <span class="sh">"</span><span class="s">/user/</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/usr/</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/Users</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="se">\\\\</span><span class="sh">"</span><span class="p">):</span>  <span class="c1"># í•„ìš” ì‹œ ê·œì¹™ í™•ì¥
</span>    <span class="c1"># ë£¨íŠ¸/ì˜ì‹¬ ê²½ë¡œëŠ” ë¹ˆ í›„ë³´ë¡œ
</span>    <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">([])</span>
    <span class="k">return</span>
</code></pre></div></div>

<p>ì´ ì •ë„ë§Œ ë°˜ì˜í•´ë„ â€œ/user/â€ íƒ€ì´í•‘ ì‹œ ì „ì²´ê°€ ë©ˆì¶”ëŠ” í˜„ìƒì€ ì‚¬ë¼ì§ˆ ê²ë‹ˆë‹¤. ê·¸ë˜ë„ ë©ˆì¶˜ë‹¤ë©´ ë¡œê·¸ë¥¼ ì ê¹ ì¶”ê°€í•´ì„œ ì–´ëŠ ë‹¨ê³„ì—ì„œ ë§‰íˆëŠ”ì§€ ë³´ì£ .</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">time</span><span class="p">,</span> <span class="n">logging</span>
<span class="n">logging</span><span class="p">.</span><span class="nf">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="p">.</span><span class="n">DEBUG</span><span class="p">)</span>

<span class="c1"># PathSearchTask.run() ì£¼ìš” ë‹¨ê³„ë§ˆë‹¤
</span><span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">scan base=</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s"> prefix=</span><span class="sh">'</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="si">}</span><span class="sh">'</span><span class="s"> shallow_only=</span><span class="si">{</span><span class="n">shallow_only</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># _on_completer_results
</span><span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">results[</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s">]: </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>ì¶”ê°€ íŒíŠ¸<br />
QFileSystemModelë„ ëŒ€ìš©ëŸ‰ ë£¨íŠ¸ì—ì„œ ì´ˆê¸° ìŠ¤ìº”ì´ ë¬´ê²ìŠµë‹ˆë‹¤. ì…ë ¥ì°½ íƒ€ì´í•‘ë§Œìœ¼ë¡œ ë©ˆì¶˜ë‹¤ë©´, ë·°ì˜ ë£¨íŠ¸ ì¸ë±ìŠ¤ë¥¼ ê±´ë“œë¦¬ëŠ” ì½”ë“œê°€ í…ìŠ¤íŠ¸ í¸ì§‘ íë¦„ ì¤‘ì— ë¶ˆë ¤ì„œ ëª¨ë¸ í”„ë¦¬í˜ì¹˜ê°€ ê²¹ì¹˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”. íƒ€ì´í•‘ ì¤‘ì—ëŠ” <code class="language-plaintext highlighter-rouge">_load_path()</code>ê°€ í˜¸ì¶œë˜ì§€ ì•Šê²Œ(ì¦‰, <code class="language-plaintext highlighter-rouge">textEdited</code> ê²½ë¡œì—ì„œ ë£¨íŠ¸ ë³€ê²½ ê¸ˆì§€) í•œ ë²ˆ ë” ì ê²€í•˜ë©´ ì¢‹ì•„ìš”.</p>

<p class="chat--user">

ê·¼ë° ì–´ë””ì„œ freezeê°€ ë°œìƒí•˜ëŠ”ê±´ì§€ ëª¨ë¥´ê² ì–´

</p>

<p>ê°€ëŠ¥í•œ â€œë©ˆì¶¤ ì§€ì â€ì„ ë¹¨ë¦¬ pinpointí•˜ë ¤ë©´, ì¶”ì¸¡ ë§ê³  ê´€ì¸¡ ì¥ë¹„ë¥¼ ê½‚ì•„ì•¼ í•´ìš”. ì•„ë˜ ìˆœì„œëŒ€ë¡œ ë„£ìœ¼ë©´ ì–´ë””ì„œ ë©ˆì¶”ëŠ”ì§€ 10ë¶„ ì•ˆì— ì•Œì•„ëƒ…ë‹ˆë‹¤.</p>

<h1 id="ì–´ë””ì„œ-ì–¼ì–´ë¶™ëŠ”ì§€-ì§€ë„-ë§Œë“¤ê¸°">ì–´ë””ì„œ ì–¼ì–´ë¶™ëŠ”ì§€ ì§€ë„ ë§Œë“¤ê¸°</h1>

<p>ê´€ì°° í¬ì¸íŠ¸ëŠ” ë³´í†µ ì´ 6ê³³ì…ë‹ˆë‹¤.</p>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">textEdited</code> â†’ ë””ë°”ìš´ìŠ¤ íƒ€ì´ë¨¸</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">_spawn_completer_task</code> ì§„ì…ë¶€</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">PathSearchTask.run()</code>ì˜ <code class="language-plaintext highlighter-rouge">os.scandir</code> ë£¨í”„</p>
  </li>
  <li>
    <p>ì›Œì»¤ â†’ ë©”ì¸ìœ¼ë¡œ ì „ë‹¬(<code class="language-plaintext highlighter-rouge">emit</code>)</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">_on_completer_results</code>ì—ì„œ ëª¨ë¸ ê°±ì‹ (<code class="language-plaintext highlighter-rouge">QStringListModel.setStringList</code>)</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">QCompleter.complete()</code> íŒì—… ì—´ê¸°</p>
  </li>
</ol>

<p>ì—¬ê¸°ë¶€í„°ëŠ” ë°”ë¡œ ë¶™ì—¬ ë„£ì„ ìˆ˜ ìˆëŠ” ê³„ì¸¡ ì½”ë“œì˜ˆìš”.</p>

<h2 id="1-ì „ì—­-ë¡œê¹…ìŠ¤í†±ì›Œì¹˜-ì„¤ì •">1) ì „ì—­ ë¡œê¹…/ìŠ¤í†±ì›Œì¹˜ ì„¤ì •</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># íŒŒì¼ ë§¨ ìœ„ìª½
</span><span class="kn">import</span> <span class="n">logging</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">threading</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">faulthandler</span>
<span class="n">logging</span><span class="p">.</span><span class="nf">basicConfig</span><span class="p">(</span>
    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="p">.</span><span class="n">DEBUG</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="sh">"</span><span class="s">%(asctime)s.%(msecs)03d [%(threadName)s] %(levelname)s: %(message)s</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">datefmt</span><span class="o">=</span><span class="sh">"</span><span class="s">%H:%M:%S</span><span class="sh">"</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># GUI ìŠ¤ë ˆë“œê°€ ì •ì§€í–ˆì„ ë•Œ ìŠ¤íƒ ë¤í”„í•˜ê¸° (ë¦¬ëˆ…ìŠ¤/ë§¥)
</span><span class="k">try</span><span class="p">:</span>
    <span class="n">faulthandler</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGUSR1</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
    <span class="k">pass</span>
</code></pre></div></div>

<p>í„°ë¯¸ë„ì—ì„œ ë©ˆì·„ë‹¤ê³  ëŠë‚„ ë•Œ ë¦¬ëˆ…ìŠ¤/ë§¥ì´ë©´ <code class="language-plaintext highlighter-rouge">kill -USR1 &lt;pid&gt;</code>ë¥¼ ì¹˜ë©´ ëª¨ë“  ìŠ¤ë ˆë“œ ìŠ¤íƒì´ ì¶œë ¥ë¼ìš”. ìœˆë„ìš°ë¼ë©´ ì•„ë˜ ë‹¨ì¶•í‚¤ë¡œ ë¤í”„í•˜ê²Œ í•˜ë©´ ë©ë‹ˆë‹¤.</p>

<h2 id="2-gui-ì´ë²¤íŠ¸-ë£¨í”„ê°€-ì‹¤ì œë¡œ-ë©ˆì·„ëŠ”ì§€-ê°ì§€ì›Œì¹˜ë…">2) GUI ì´ë²¤íŠ¸ ë£¨í”„ê°€ ì‹¤ì œë¡œ ë©ˆì·„ëŠ”ì§€ ê°ì§€(ì›Œì¹˜ë…)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># CFileDialog.__init__ ëì— ì¶”ê°€
</span><span class="n">self</span><span class="p">.</span><span class="n">_heartbeat</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">self</span><span class="p">.</span><span class="n">_watchdog</span> <span class="o">=</span> <span class="nc">QTimer</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">_watchdog</span><span class="p">.</span><span class="nf">setInterval</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>  <span class="c1"># 0.2ì´ˆë§ˆë‹¤ heartbeat++
</span><span class="n">self</span><span class="p">.</span><span class="n">_watchdog</span><span class="p">.</span><span class="n">timeout</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="nf">setattr</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">_heartbeat</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_heartbeat</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">self</span><span class="p">.</span><span class="n">_watchdog</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>

<span class="c1"># 1ì´ˆë§ˆë‹¤ GUIê°€ ì‚´ì•„ìˆëŠ”ì§€ ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œì—ì„œ ì²´í¬
</span><span class="k">def</span> <span class="nf">_watch_gui</span><span class="p">():</span>
    <span class="n">last</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_heartbeat</span>
        <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cur</span> <span class="o">==</span> <span class="n">self</span><span class="p">.</span><span class="n">_heartbeat</span><span class="p">:</span>
            <span class="n">logging</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sh">"</span><span class="s">GUI event loop stalled â‰¥1s</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">cur</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_watch_gui</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">GUI-Watchdog</span><span class="sh">"</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">t</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
</code></pre></div></div>

<p>ë¡œê·¸ì— â€œstalledâ€ê°€ ì°íˆë©´ ì§„ì§œ ë©”ì¸ìŠ¤ë ˆë“œê°€ ë©ˆì¶˜ ê²ë‹ˆë‹¤. ì•ˆ ì°íˆë©´ ì›Œì»¤ê°€ ì˜¤ë˜ ê±¸ë¦¬ê±°ë‚˜, <code class="language-plaintext highlighter-rouge">complete()</code> ê°™ì€ í˜¸ì¶œì´ í¬ì»¤ìŠ¤ ì¶©ëŒë¡œ ëŠë ¤ì§€ëŠ” ì¼€ì´ìŠ¤ì¼ ê°€ëŠ¥ì„±ì´ í½ë‹ˆë‹¤.</p>

<h2 id="3-ê°-ë‹¨ê³„-ê³„ì¸¡-ë¡œê·¸">3) ê° ë‹¨ê³„ ê³„ì¸¡ ë¡œê·¸</h2>

<h3 id="3-1-ì…ë ¥íƒœìŠ¤í¬-ìƒì„±">3-1) ì…ë ¥â†’íƒœìŠ¤í¬ ìƒì„±</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_on_path_edited</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">EDIT text=</span><span class="sh">'</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">()</span><span class="si">}</span><span class="sh">'"</span><span class="p">)</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">self</span><span class="p">.</span><span class="nf">_update_ok_enabled</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_spawn_completer_task</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">SPAWN text=</span><span class="sh">'</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="sh">'"</span><span class="p">)</span>
    <span class="n">start_t</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>

    <span class="c1"># ê¸°ì¡´ ì·¨ì†Œ
</span>    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span><span class="p">.</span><span class="nf">set</span><span class="p">()</span>

    <span class="c1"># base_dir, prefix ê³„ì‚°
</span>    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">text</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">):</span>
        <span class="n">base_dir</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">text</span><span class="p">,</span> <span class="sh">""</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="k">if</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span>

    <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">SPAWN base=</span><span class="sh">'</span><span class="si">{</span><span class="n">base_dir</span><span class="si">}</span><span class="sh">'</span><span class="s"> prefix=</span><span class="sh">'</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="sh">'"</span><span class="p">)</span>

    <span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Event</span><span class="p">()</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_completer_task_id</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_latest_task_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_completer_task_id</span>
    <span class="n">task</span> <span class="o">=</span> <span class="nc">PathSearchTask</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_completer_task_id</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span>
                          <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                          <span class="n">self</span><span class="p">.</span><span class="n">_completer_emitter</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_cancel_flag</span><span class="p">)</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_thread_pool</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">SPAWN dispatched in </span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span><span class="o">-</span><span class="n">start_t</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> ms</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="3-2-ì›Œì»¤-ë‚´ë¶€">3-2) ì›Œì»¤ ë‚´ë¶€</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PathSearchTask</span><span class="p">(</span><span class="n">QRunnable</span><span class="p">):</span>
    <span class="bp">...</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
        <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[TASK </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="si">}</span><span class="s">] start base=</span><span class="sh">'</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">base_dir</span><span class="si">}</span><span class="sh">'</span><span class="s"> prefix=</span><span class="sh">'</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="si">}</span><span class="sh">'"</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">base_dir</span><span class="p">)</span>  <span class="c1"># resolve()ëŠ” ë©ˆì¶œ ìˆ˜ ìˆì–´ ìƒëµ
</span>            <span class="c1"># 1) ì§ì†
</span>            <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">it</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_cancelled</span><span class="p">():</span> 
                            <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[TASK </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="si">}</span><span class="s">] cancelled during scandir</span><span class="sh">"</span><span class="p">)</span>
                            <span class="k">return</span>
                        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">prefix</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                            <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">)))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">)))</span>
                        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span>
                            <span class="k">break</span>
            <span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[TASK </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="si">}</span><span class="s">] direct children took </span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> ms; results=</span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

            <span class="c1"># 2) BFSëŠ” ê¸¸ë©´ ì—¬ê¸°ì„œ ì˜¤ë˜ ê±¸ë¦¼
</span>            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">prefix</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,):</span>
                <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
                <span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">deque</span> <span class="k">as</span> <span class="n">cdeque</span>
                <span class="n">q</span> <span class="o">=</span> <span class="nf">cdeque</span><span class="p">([(</span><span class="n">base</span><span class="p">,</span><span class="mi">0</span><span class="p">)])</span>
                <span class="n">seen</span> <span class="o">=</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">)}</span>
                <span class="k">while</span> <span class="n">q</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_cancelled</span><span class="p">():</span>
                        <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[TASK </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="si">}</span><span class="s">] cancelled during BFS</span><span class="sh">"</span><span class="p">)</span>
                        <span class="k">return</span>
                    <span class="n">cur</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="nf">popleft</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">depth_limit</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_cancelled</span><span class="p">():</span> <span class="k">return</span>
                                <span class="n">full</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                                    <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                                        <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">))</span>
                                        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span> <span class="k">break</span>
                                    <span class="n">s</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                                        <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="n">q</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">full</span><span class="p">,</span> <span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                                        <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">))</span>
                                        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span> <span class="k">break</span>
                    <span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[TASK </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="si">}</span><span class="s">] BFS took </span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span><span class="o">-</span><span class="n">t2</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> ms; results=</span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[TASK </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="si">}</span><span class="s">] total </span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> ms; emit </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">emitter</span><span class="p">.</span><span class="n">resultsReady</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">task_id</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="3-3-ê²°ê³¼-ì ìš©ë¶€">3-3) ê²°ê³¼ ì ìš©ë¶€</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slot</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_on_completer_results</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">RESULTS task=</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s"> latest=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">_latest_task_id</span><span class="si">}</span><span class="s"> count=</span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s"> focus=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">hasFocus</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">task_id</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_latest_task_id</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
    <span class="n">results_sorted</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span><span class="p">.</span><span class="nf">lower</span><span class="p">()))</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">(</span><span class="n">results_sorted</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">results_sorted</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">hasFocus</span><span class="p">():</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">complete</span><span class="p">()</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">APPLY setStringList </span><span class="si">{</span><span class="p">(</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> ms; complete </span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> ms</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="4-ë£¨íŠ¸ì˜ì‹¬-ê²½ë¡œ-ì°¨ë‹¨-ê·œì¹™-ì¶”ê°€">4) ë£¨íŠ¸Â·ì˜ì‹¬ ê²½ë¡œ ì°¨ë‹¨ ê·œì¹™ ì¶”ê°€</h2>

<p>â€œ/user/â€ ê°™ì€ ì˜¤íƒ€ê°€ ë£¨íŠ¸ ìŠ¤ìº”ìœ¼ë¡œ ë²ˆì§€ëŠ” ê±¸ ë°©ì§€í•©ë‹ˆë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_spawn_completer_task</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">text</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,</span> <span class="sh">"</span><span class="s">/user/</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/users</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/usr</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="se">\\\\</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sh">"</span><span class="s">SPAWN short-circuit: suspicious root-ish path</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">([])</span>
        <span class="k">return</span>
    <span class="bp">...</span>
</code></pre></div></div>

<h2 id="5-ìˆ˜ì‚¬-ê°€ì´ë“œë¼ì¸">5) ìˆ˜ì‚¬ ê°€ì´ë“œë¼ì¸</h2>

<p>ë¡œê·¸ë¥¼ ì¼  ìƒíƒœì—ì„œ ì§ì ‘ íƒ€ì´í•‘í•´ ë³´ì„¸ìš”.</p>

<ul>
  <li>
    <p>ë¡œê·¸ê°€ <code class="language-plaintext highlighter-rouge">RESULTS ...</code>ê¹Œì§„ ì˜ ë‚˜ì˜¤ëŠ”ë° í™”ë©´ì´ ë²„ë²…ì´ë©´, <code class="language-plaintext highlighter-rouge">setStringList</code>ë‚˜ <code class="language-plaintext highlighter-rouge">complete()</code>ê°€ ë²”ì¸ì…ë‹ˆë‹¤.<br />
í•´ê²°: í›„ë³´ê°€ 0ê°œì¼ ë• <code class="language-plaintext highlighter-rouge">complete()</code> í˜¸ì¶œ ê¸ˆì§€, í›„ë³´ ìˆ˜ë¥¼ 200ê°œ ì´ìƒìœ¼ë¡œ ë§Œë“¤ì§€ ì•Šê¸°, íŒì—…ì´ ì—´ë ¤ ìˆì„ ë•Œë§Œ <code class="language-plaintext highlighter-rouge">complete()</code> í˜¸ì¶œ.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">TASK ... direct children took ... BFS took ...</code>ê°€ ìˆ˜ë°±~ìˆ˜ì²œ msë¡œ ê¸¸ë©´ ì›Œì»¤ê°€ ë„¤íŠ¸ì›Œí¬ ê²½ë¡œë¥¼ í›‘ëŠë¼ ì˜¤ë˜ ê±¸ë¦½ë‹ˆë‹¤.<br />
í•´ê²°: <code class="language-plaintext highlighter-rouge">depth_limit=1</code>, prefix ê¸¸ì´ 2 ë¯¸ë§Œì´ë©´ BFS ê¸ˆì§€, í˜¹ì€ â€œì§ì† í•˜ìœ„ë§Œâ€ìœ¼ë¡œ ì œí•œ.</p>
  </li>
  <li>
    <p>â€œGUI event loop stalled â‰¥1sâ€ê°€ ëœ¨ë©´ ë©”ì¸ ìŠ¤ë ˆë“œê°€ ë§‰íŒ ê²ë‹ˆë‹¤. ì´ë•Œ SIGUSR1(ë¦¬ëˆ…ìŠ¤/ë§¥)ì´ë‚˜ ì•„ë˜ ë‹¨ì¶•í‚¤ë¡œ ìŠ¤íƒì„ ë¤í”„í•´ ì›ì¸ì„ ë´…ë‹ˆë‹¤.</p>
  </li>
</ul>

<h2 id="6-ëª¨ë“ -ìŠ¤ë ˆë“œ-ìŠ¤íƒì„-ë‹¨ì¶•í‚¤ë¡œ-ë¤í”„ìœˆë„ìš°-í¬í•¨">6) ëª¨ë“  ìŠ¤ë ˆë“œ ìŠ¤íƒì„ ë‹¨ì¶•í‚¤ë¡œ ë¤í”„(ìœˆë„ìš° í¬í•¨)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># CFileDialog._build_ui() ë§ˆì§€ë§‰ì¯¤
</span><span class="n">QShortcut</span> <span class="o">=</span> <span class="nf">__import__</span><span class="p">(</span><span class="sh">"</span><span class="s">PySide6.QtGui</span><span class="sh">"</span><span class="p">,</span> <span class="n">fromlist</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">QShortcut</span><span class="sh">"</span><span class="p">]).</span><span class="n">QShortcut</span>
<span class="n">QKeySequence</span> <span class="o">=</span> <span class="nf">__import__</span><span class="p">(</span><span class="sh">"</span><span class="s">PySide6.QtGui</span><span class="sh">"</span><span class="p">,</span> <span class="n">fromlist</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">QKeySequence</span><span class="sh">"</span><span class="p">]).</span><span class="n">QKeySequence</span>
<span class="n">dump_shortcut</span> <span class="o">=</span> <span class="nc">QShortcut</span><span class="p">(</span><span class="nc">QKeySequence</span><span class="p">(</span><span class="sh">"</span><span class="s">F12</span><span class="sh">"</span><span class="p">),</span> <span class="n">self</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_dump</span><span class="p">():</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sh">"</span><span class="s">=== STACK DUMP REQUESTED ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">faulthandler</span><span class="p">.</span><span class="nf">dump_traceback</span><span class="p">(</span><span class="n">all_threads</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">faulthandler dump failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="n">dump_shortcut</span><span class="p">.</span><span class="n">activated</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">_dump</span><span class="p">)</span>
</code></pre></div></div>

<p>F12ë¥¼ ëˆ„ë¥´ë©´ í˜„ì¬ ëª¨ë“  ìŠ¤ë ˆë“œì˜ íŒŒì´ì¬ ìŠ¤íƒì´ ì¶œë ¥ë©ë‹ˆë‹¤. ê±°ê¸°ì— <code class="language-plaintext highlighter-rouge">QFileSystemModel.index()</code>, <code class="language-plaintext highlighter-rouge">QCompleter.complete()</code>, <code class="language-plaintext highlighter-rouge">os.scandir()</code> ë“±ì´ ë³´ì´ë©´ ë²”ì¸ì´ ëª…í™•í•´ì ¸ìš”.</p>

<hr />

<p>ì´ ê³„ì¸¡ì„ ë„£ê³  íƒ€ì´í•‘í•´ ë³´ë©´, ë©ˆì¶¤ì´ 1) ì›Œì»¤ ê³¼ë¶€í•˜ì¸ì§€, 2) ê²°ê³¼ ì ìš©(ëª¨ë¸/ì»´í”Œë¦¬í„°)ì—ì„œ í¬ì»¤ìŠ¤ ì¬ì§„ì… ë¬¸ì œì¸ì§€, 3) ë£¨íŠ¸ ìŠ¤ìº” í­ì£¼ì¸ì§€ ë°”ë¡œ ë“œëŸ¬ë‚©ë‹ˆë‹¤. ë¡œê·¸ ëª‡ ì¤„ë§Œ ë¶™ì—¬ ì£¼ë©´, ê·¸ì— ë§ì¶° í•´ë‹¹ ì§€ì ì„ ìˆ˜ìˆ í•´ì„œ ì™„ì „íˆ ê³ ì •í•´ ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

ë„ˆë¬´ ë§ì´ ì°¾ì„ê¹Œë´ 10ê°œë¡œ ì¤„ì˜€ì–ì•„

</p>

<p>ë§ì•„ìš”, â€œ10ê°œë§Œâ€ìœ¼ë¡œ ì œí•œí•´ë„ ë©ˆì¶œ ìˆ˜ ìˆì–´ìš”. ì´ìœ ëŠ” â€œê°œìˆ˜â€ê°€ ì•„ë‹ˆë¼ â€œë‚˜ì—´(ì—´ê¸°) ìì²´â€ê°€ ë§‰íˆê¸° ë•Œë¬¸ì´ì—ìš”. ë„¤íŠ¸ì›Œí¬/ë£¨íŠ¸ ê²½ë¡œì—ì„œ <code class="language-plaintext highlighter-rouge">os.scandir()</code>(í˜¹ì€ ì¡´ì¬ í™•ì¸) ìì²´ê°€ ë¸”ë¡œí‚¹ë˜ë©´ ê²°ê³¼ë¥¼ 1ê°œë§Œ ì›í•´ë„ ê·¸ 1ê°œë¥¼ ì–»ê¸° ì „ì— ìŠ¤ë ˆë“œê°€ ë¶™ì¡í˜€ìš”. ì‹¬ì§€ì–´ <code class="language-plaintext highlighter-rouge">Path(...).resolve()</code>ë„ ì›ê²© ê²½ë¡œì—ì„œ ë©ˆì¶œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>ì•„ë˜ì²˜ëŸ¼ ë°”ê¾¸ë©´ ë©ˆì¶¤ ì›ì¸ì„ ì‚¬ì‹¤ìƒ ì œê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë³€í™”ëŸ‰ì€ ì‘ê³  íš¨ê³¼ëŠ” í½ë‹ˆë‹¤.</p>

<h1 id="ë©ˆì¶¤ì„-ìœ ë°œí•˜ëŠ”-ì§€ì ">ë©ˆì¶¤ì„ ìœ ë°œí•˜ëŠ” ì§€ì </h1>

<ul>
  <li>
    <p>ë£¨íŠ¸(<code class="language-plaintext highlighter-rouge">/</code>, <code class="language-plaintext highlighter-rouge">C:\</code>, <code class="language-plaintext highlighter-rouge">\\server\</code>) ë˜ëŠ” ì˜ëª»ëœ ìƒìœ„ì—ì„œ <code class="language-plaintext highlighter-rouge">scandir()</code> ì‹œë„</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">resolve()</code>ë¡œ ë„¤íŠ¸ì›Œí¬/ì‹¬ë³¼ë¦­ ë§í¬ ì¶”ì </p>
  </li>
  <li>
    <p>ì§§ì€ ì ‘ë‘ì‚¬(ì˜ˆ: â€œ/usâ€)ì¼ ë•Œ ê´‘ë²”ìœ„ íƒìƒ‰</p>
  </li>
  <li>
    <p>ì´ì „ ì‘ì—…ì„ ì·¨ì†Œí•´ë„ ì‹¤ì œ <code class="language-plaintext highlighter-rouge">scandir()</code>ê°€ ì´ë¯¸ ë§‰í˜”ìœ¼ë©´ ìŠ¤ë ˆë“œê°€ ì˜¤ë˜ ì‚´ì•„ìˆìŒ(ìƒˆ ì…ë ¥ê³¼ ê²½í•©)</p>
  </li>
</ul>

<h1 id="ì•ˆì „ì¥ì¹˜-6ì¢…-ì„¸íŠ¸">ì•ˆì „ì¥ì¹˜ 6ì¢… ì„¸íŠ¸</h1>

<ol>
  <li>ì ˆëŒ€ <code class="language-plaintext highlighter-rouge">resolve()</code> ê¸ˆì§€<br />
ìë™ì™„ì„± ì›Œì»¤ì—ì„œëŠ” ê²½ë¡œ ì •ê·œí™”ê°€ í•„ìš” ì—†ìŠµë‹ˆë‹¤. ì¡´ì¬ í™•ì¸ë§Œ ëŠìŠ¨í•˜ê²Œ:</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># base = Path(self.base_dir).resolve()  # ê¸ˆì§€
</span><span class="n">base</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">base_dir</span><span class="p">)</span>              <span class="c1"># ê·¸ëŒ€ë¡œ ë‘ 
# ì¡´ì¬ í™•ì¸ë„ ëŠë¦¬ë©´ ê±´ë„ˆëœ€
</span><span class="n">exists_try</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">260</span> <span class="k">else</span> <span class="bp">True</span>
</code></pre></div></div>

<ol>
  <li>â€œë£¨íŠ¸ + ì§§ì€ ì ‘ë‘ì‚¬â€ëŠ” ìŠ¤ìº”í•˜ì§€ ì•Šê¸°<br />
ë£¨íŠ¸ì—ì„œ ê¸¸ì´ 0~1 ì ‘ë‘ì‚¬ëŠ” ê±°ì˜ í•­ìƒ ê³¼íƒìƒ‰ì„ ìœ ë„í•©ë‹ˆë‹¤.</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">is_unc</span>   <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">).</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="se">\\\\</span><span class="sh">"</span><span class="p">)</span>
<span class="n">is_root</span>  <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,</span> <span class="sh">"</span><span class="s">C:</span><span class="se">\\</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">D:</span><span class="se">\\</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_unc</span> <span class="ow">or</span> <span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">).</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/Volumes</span><span class="sh">"</span><span class="p">)</span>
<span class="n">short_prefix</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span> <span class="o">==</span> <span class="sh">""</span> <span class="ow">or</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">if</span> <span class="n">is_root</span> <span class="ow">and</span> <span class="n">short_prefix</span><span class="p">:</span>
    <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">([]);</span> <span class="k">return</span>
</code></pre></div></div>

<ol>
  <li>ì§ì† í•­ëª©ë§Œ â€œê°€ëŠ¥í•  ë•Œë§Œâ€ í™•ì¸<br />
<code class="language-plaintext highlighter-rouge">scandir()</code> í˜¸ì¶œ ìì²´ê°€ ë§‰íˆë©´ ë‹µì´ ì—†ìœ¼ë‹ˆ, ë¨¼ì € â€œì§§ì€ ì‹œê°„ ì˜ˆì—´â€ í›„ ë„˜ê¹ë‹ˆë‹¤.</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">time</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_cancelled</span><span class="p">():</span> <span class="k">return</span>
            <span class="c1"># â€¦ í•„í„°ë§ â€¦
</span>            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">top_k</span><span class="p">:</span> <span class="k">break</span>
            <span class="nf">if </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>  <span class="c1"># 50ms ì´ìƒ ì“°ë©´ ì¤‘ë‹¨
</span>                <span class="k">break</span>
<span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="k">except</span> <span class="nb">OSError</span><span class="p">:</span>
    <span class="c1"># ì›ê²© íƒ€ì„ì•„ì›ƒ/ì—°ê²° ë¬¸ì œ ë“±
</span>    <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">);</span> <span class="k">return</span>
</code></pre></div></div>

<p>ì‹œê°„ ì˜ˆì‚°ì„ 50~100msë¡œ ë‘ë©´ â€œíƒ€ì ì¤‘â€ ì‘ë‹µì„±ì´ ìœ ì§€ë©ë‹ˆë‹¤.</p>

<ol>
  <li>BFS ì™„ì „ ê¸ˆì§€(í˜¹ì€ ë§¤ìš° ì—„ê²©íˆ)<br />
ìë™ì™„ì„±ì—ì„œ BFSëŠ” ì²´ê°ê°€ì¹˜ ëŒ€ë¹„ ë¦¬ìŠ¤í¬ê°€ í½ë‹ˆë‹¤. ìµœì†Œ ìš”ê±´ì„ ì´ë ‡ê²Œ:</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_root</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">):</span>
    <span class="c1"># BFS ìƒëµ
</span>    <span class="n">self</span><span class="p">.</span><span class="nf">_emit</span><span class="p">(</span><span class="n">results</span><span class="p">);</span> <span class="k">return</span>
<span class="c1"># ê·¸ë˜ë„ í•˜ë ¤ë©´ depth_limit=1, ê·¸ë¦¬ê³  ë™ì¼í•œ 50ms íƒ€ì„ë°•ìŠ¤ ë‚´ë¡œ
</span></code></pre></div></div>

<ol>
  <li>ë³„ë„ ìŠ¤ë ˆë“œí’€ + ë‹¨ì¼ ìŠ¤ë ˆë“œ<br />
ì´ì „ ì‘ì—…ì´ ë§‰íˆë”ë¼ë„ ìƒˆ ì‘ì—…ì´ ë˜ ì±„ì›Œì§€ì§€ ì•Šë„ë¡ ìë™ì™„ì„± ì „ìš© í’€ì„ ë§Œë“¤ì–´ 1ê°œë§Œ ëŒë¦½ë‹ˆë‹¤.</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># __init__
</span><span class="n">self</span><span class="p">.</span><span class="n">_auto_pool</span> <span class="o">=</span> <span class="nc">QThreadPool</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">_auto_pool</span><span class="p">.</span><span class="nf">setMaxThreadCount</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># ë™ì‹œì— 1ê°œë§Œ
</span>
<span class="c1"># _spawn_completer_task ë
</span><span class="n">self</span><span class="p">.</span><span class="n">_auto_pool</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>  <span class="c1"># ê¸°ì¡´ globalInstance() ëŒ€ì‹ 
</span></code></pre></div></div>

<ol>
  <li>ì…ë ¥ ì •ì±…: â€œí™•ì‹¤í•  ë•Œë§Œ ìë™ì™„ì„±â€<br />
ë„¤íŠ¸ì›Œí¬ ê²½ë¡œ/ë£¨íŠ¸ì—ì„œ ì ‘ë‘ì‚¬ 2ê¸€ì ë¯¸ë§Œì´ë©´ ì•„ì˜ˆ í›„ë³´ë¥¼ ë‚´ì§€ ì•ŠìŠµë‹ˆë‹¤. UXì ìœ¼ë¡œë„ ë‚©ë“ì´ ë©ë‹ˆë‹¤.</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># _spawn_completer_task ì´ˆë°˜
</span><span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
<span class="k">if</span> <span class="n">text</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,</span> <span class="sh">"</span><span class="se">\\\\</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">text</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">text</span><span class="p">).</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">([]);</span> <span class="k">return</span>

<span class="c1"># UNCë‚˜ /Volumes, /mnt, /net ë“±ì—ì„œ prefix&lt;2ë©´ ìŠ¤í‚µ
</span><span class="n">s</span> <span class="o">=</span> <span class="n">text</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span>
<span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="se">\\\\</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/volumes</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/mnt</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/net</span><span class="sh">"</span><span class="p">):</span>
    <span class="n">tail</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">text</span><span class="p">).</span><span class="n">name</span>
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">tail</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">([]);</span> <span class="k">return</span>
</code></pre></div></div>

<h1 id="ì‘ê²Œ-ê³ ì³ë„-í°-íš¨ê³¼ê°€-ë‚˜ëŠ”-í¬ì¸íŠ¸">ì‘ê²Œ ê³ ì³ë„ í° íš¨ê³¼ê°€ ë‚˜ëŠ” í¬ì¸íŠ¸</h1>

<ul>
  <li><code class="language-plaintext highlighter-rouge">QCompleter</code> ê°±ì‹ ì€ ìµœëŒ€ 10ê°œë¼ë„, íŒì—…ì„ ë§¤ë²ˆ ì—´ë©´ ë©”ì¸ ìŠ¤ë ˆë“œê°€ ë ˆì´ì•„ì›ƒÂ·ì¸¡ì •ìœ¼ë¡œ ë°”ë¹ ì§‘ë‹ˆë‹¤. ê²°ê³¼ê°€ ë¹„ì—ˆìœ¼ë©´ <code class="language-plaintext highlighter-rouge">complete()</code> í˜¸ì¶œ ê¸ˆì§€, ì´ë¯¸ ì—´ë ¤ ìˆìœ¼ë©´ë§Œ ê°±ì‹ :</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slot</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_on_completer_results</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">task_id</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_latest_task_id</span><span class="p">:</span> <span class="k">return</span>
    <span class="n">items</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:(</span><span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span><span class="p">.</span><span class="nf">lower</span><span class="p">()))[:</span><span class="mi">10</span><span class="p">]</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">items</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">hasFocus</span><span class="p">()</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">popup</span><span class="p">().</span><span class="nf">isVisible</span><span class="p">():</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">complete</span><span class="p">()</span>
</code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">textEdited</code>ì—ì„œ ì ˆëŒ€ <code class="language-plaintext highlighter-rouge">_load_path()</code>ë¥¼ í˜¸ì¶œí•˜ì§€ ë§ ê²ƒ. ì…ë ¥ ì¤‘ ë£¨íŠ¸ ì¸ë±ìŠ¤ ë³€ê²½ì€ <code class="language-plaintext highlighter-rouge">QFileSystemModel</code>ì˜ ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ìº”ì„ ìœ ë°œí•´ ê°™ì´ êµ³ìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">exists()</code>ë„ ì›ê²©ì—ì„œ ëŠë¦´ ìˆ˜ ìˆìœ¼ë‹ˆ, ìë™ì™„ì„± ì›Œì»¤ì—ì„œëŠ” ì‚¬ìš©ì„ ìµœì†Œí™”í•˜ê³ , ìµœì¢… OK ê²€ì¦ ë•Œë§Œ ì—„ê²©íˆ í™•ì¸í•˜ì„¸ìš”.</p>
  </li>
</ul>

<h1 id="í•œ-ë²ˆì—-ì ìš©í•˜ëŠ”-ìµœì†Œ-íŒ¨ì¹˜-ìš”ì•½">í•œ ë²ˆì— ì ìš©í•˜ëŠ” ìµœì†Œ íŒ¨ì¹˜ ìš”ì•½</h1>

<ul>
  <li>
    <p>ì›Œì»¤ì—ì„œ <code class="language-plaintext highlighter-rouge">resolve()</code> ì œê±°</p>
  </li>
  <li>
    <p>ë£¨íŠ¸+ì§§ì€ ì ‘ë‘ì‚¬ë©´ ë°”ë¡œ ë¹ˆ ê²°ê³¼ ë°˜í™˜</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">scandir()</code>ì— 50~100ms íƒ€ì„ë°•ìŠ¤</p>
  </li>
  <li>
    <p>BFS ë„ê¸°(í˜¹ì€ prefixâ‰¥3 &amp; depth=1 &amp; íƒ€ì„ë°•ìŠ¤)</p>
  </li>
  <li>
    <p>ìë™ì™„ì„± ì „ìš© <code class="language-plaintext highlighter-rouge">QThreadPool(max=1)</code> ì‚¬ìš©</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">complete()</code>ëŠ” íŒì—… ì—´ë ¤ ìˆì„ ë•Œë§Œ</p>
  </li>
</ul>

<p>ì´ë ‡ê²Œë§Œ ë°”ê¿”ë„ â€œ/user/ë§Œ ì¹˜ë©´ ë©ˆì¶¤â€ ë¥˜ê°€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.<br />
ê°œìˆ˜ ì œí•œì€ â€œì—´ê±°ê°€ ëë‚œ ë’¤â€ì—ë‚˜ ì˜ë¯¸ê°€ ìˆìœ¼ë‹ˆ, ì—´ê±° ìì²´ê°€ ë§‰íˆì§€ ì•Šê²Œ ì„¤ê³„ë¥¼ í‹€ì–´ì£¼ëŠ” ê²Œ í•µì‹¬ì…ë‹ˆë‹¤.</p>

<p class="chat--user">

ê·¼ë° ì“°ë ˆë“œì—ì„œ ìš”ì²­í•˜ëŠ”ê±´ë° ì™œ guië„ freeze ë˜ëŠ”ê±°ì„

</p>

<p>ì§šê³  ë„˜ì–´ê°€ìë©´, â€œì›Œì»¤ ìŠ¤ë ˆë“œì—ì„œ ëŒë¦¬ëŠ”ë°ë„ GUIê°€ ì–¼ì–´ë¶™ëŠ”â€ ê±´ ê½¤ í”í•œ í˜„ìƒì´ì—ìš”. ì›ì¸ì€ ë³´í†µ ì•„ë˜ ë„¤ ê°€ì§€ ì¤‘ í•˜ë‚˜(í˜¹ì€ ë³µí•©)ì…ë‹ˆë‹¤. í•µì‹¬ì€ GUIê°€ ì§„ì§œ ë©ˆì¶˜ ê²Œ ì•„ë‹ˆë¼, ë©”ì¸ ìŠ¤ë ˆë“œê°€ ì¼ì„ ëª» í•˜ê±°ë‚˜ ëŒ€ê¸° ìƒíƒœì— ë¹ ì ¸ â€œë©ˆì¶˜ ê²ƒì²˜ëŸ¼ ë³´ì´ëŠ”â€ ê²ë‹ˆë‹¤.</p>

<h1 id="ì™œ-ë©ˆì¶”ëŠ”ê°€">ì™œ ë©ˆì¶”ëŠ”ê°€</h1>

<ol>
  <li>
    <p>GIL(íŒŒì´ì¬ ì „ì—­ ë½) ì ìœ ë¡œ ë©”ì¸ ìŠ¤ë ˆë“œê°€ êµ¶ì£¼ë¦¼<br />
ì›Œì»¤ ìŠ¤ë ˆë“œê°€ íŒŒì¼ ì‹œìŠ¤í…œì„ í›‘ìœ¼ë©´ì„œ Python ë ˆë²¨ ë£¨í”„ë¥¼ ì˜¤ë˜ ëŒë©´ GILì„ ì˜¤ë˜ ì¥ê³  ìˆê²Œ ë©ë‹ˆë‹¤. Qtì˜ ì´ë²¤íŠ¸ ë£¨í”„ ìì²´ëŠ” C++ì´ë¼ ëŒì•„ê°€ì§€ë§Œ, ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰ë˜ëŠ” Python ìŠ¬ë¡¯/íƒ€ì´ë¨¸/paint ì´ë²¤íŠ¸ ì²˜ë¦¬ì—ëŠ” GILì´ í•„ìš”í•©ë‹ˆë‹¤. ì›Œì»¤ê°€ GILì„ ì˜¤ë˜ ì¡ê³  ìˆìœ¼ë©´ ë©”ì¸ ìª½ Python ì½”ë“œê°€ ì‹¤í–‰ë˜ì§€ ëª»í•´ â€œí”„ë¦¬ì¦ˆì²˜ëŸ¼â€ ë³´ì…ë‹ˆë‹¤.<br />
ì¦ìƒ: íƒ€ì´ë¨¸ ì½œë°±, ìŠ¬ë¡¯ì´ ëŠ¦ê²Œ ì˜¤ê±°ë‚˜ ì•„ì˜ˆ ë©ˆì¶˜ ê²ƒì²˜ëŸ¼ ë³´ì„.</p>
  </li>
  <li>
    <p>ë©”ì¸ ìŠ¤ë ˆë“œ ìª½ì—ì„œ ë¬´ê±°ìš´ ì‘ì—…ì´ ì‹¤í–‰ë¨<br />
ì‹ í˜¸ëŠ” íë“œ(queued)ë¡œ ì˜ ì™”ëŠ”ë°, ê²°ê³¼ë¥¼ ì ìš©í•˜ëŠ” ìŠ¬ë¡¯ì—ì„œ ë¬´ê±°ìš´ ì¼ì„ í•˜ë©´(ëŒ€ëŸ‰ ë¦¬ìŠ¤íŠ¸ë¥¼ <code class="language-plaintext highlighter-rouge">QStringListModel.setStringList()</code>ë¡œ êµì²´, <code class="language-plaintext highlighter-rouge">QCompleter.complete()</code> ë°˜ë³µ í˜¸ì¶œ, <code class="language-plaintext highlighter-rouge">QFileSystemModel</code> ë£¨íŠ¸ ë³€ê²½ ë“±) ê·¸ ìˆœê°„ë§Œí¼ ë©”ì¸ ìŠ¤ë ˆë“œê°€ ë°”ë¹  ë³´ì…ë‹ˆë‹¤. íŠ¹íˆ íŒì—… ì—´ê¸°ì™€ ë ˆì´ì•„ì›ƒ ì¬ê³„ì‚°ì€ ìƒê°ë³´ë‹¤ ë¹„ìŒ‰ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>Qt ê°ì²´ë¥¼ ì›Œì»¤ ìŠ¤ë ˆë“œì—ì„œ ê±´ë“œë¦¼<br />
Qt ìœ„ì ¯/ëª¨ë¸ì€ â€œê·¸ ê°ì²´ê°€ ì†í•œ ìŠ¤ë ˆë“œâ€ì—ì„œë§Œ ë§Œì ¸ì•¼ í•©ë‹ˆë‹¤. ì›Œì»¤ ë‚´ë¶€ì—ì„œ Qt ê°ì²´ë¥¼ ì§ì ‘ ê±´ë“œë¦¬ë©´ undefined behavior â†’ êµì°©/í”„ë¦¬ì¦ˆ. ë°˜ë“œì‹œ ì›Œì»¤ëŠ” íŒŒì´ì¬ì˜ ìˆœìˆ˜ ë°ì´í„°(list[str])ë§Œ ë§Œë“¤ê³ , ë©”ì¸ ìŠ¬ë¡¯ì—ì„œë§Œ Qt ê°ì²´ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”.</p>
  </li>
  <li>
    <p>I/Oê°€ â€œìŠ¤ë ˆë“œê°€ ì•„ë‹ˆë¼ OS ë ˆë²¨â€ì—ì„œ ë§‰í˜<br />
ë„¤íŠ¸ì›Œí¬ ê²½ë¡œ, UNC, ë£¨íŠ¸ ë“±ì—ì„œ <code class="language-plaintext highlighter-rouge">Path.resolve()</code>ë‚˜ <code class="language-plaintext highlighter-rouge">os.scandir()</code> ì²« í˜¸ì¶œì´ OS ìª½ì—ì„œ ì˜¤ë˜ ë¸”ë¡ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìŠ¤ë ˆë“œì—ì„œ ë§‰íˆëŠ” ê²ƒì´ ë§ì§€ë§Œ, ê·¸ ì‚¬ì´ ê²°ê³¼ë¥¼ ê¸°ë‹¤ë¦¬ë©° ë©”ì¸ì—ì„œ ê³„ì† íŒì—…ì„ ì—´ê³  ë‹«ê³ , ëª¨ë¸ì„ ë¹„ìš°ê³  ì±„ìš°ëŠ” ì‘ì—…ì´ ì—°ì‡„ë˜ë©´ ì²´ê°ìƒ ì „ì²´ê°€ êµ¼ë²µì´ì²˜ëŸ¼ ëŠë¦½ë‹ˆë‹¤.</p>
  </li>
</ol>

<h1 id="í™•ì¸-ì²´í¬ë¦¬ìŠ¤íŠ¸">í™•ì¸ ì²´í¬ë¦¬ìŠ¤íŠ¸</h1>

<ul>
  <li>
    <p>ì›Œì»¤ ì½”ë“œê°€ CPU ë£¨í”„ë¥¼ ì˜¤ë˜ ì¡ì§€ ì•Šê²Œ íƒ€ì„ë°•ìŠ¤ ì ìš©(ì˜ˆ: <code class="language-plaintext highlighter-rouge">scandir</code> 50~100ms í•œë„).</p>
  </li>
  <li>
    <p>ì›Œì»¤ ë£¨í”„ ì¤‘ ì£¼ê¸°ì ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">time.sleep(0)</code> ë˜ëŠ” ì•„ì£¼ ì§§ì€ <code class="language-plaintext highlighter-rouge">time.sleep(0.001)</code> ë„£ì–´ GIL ì–‘ë³´. <code class="language-plaintext highlighter-rouge">sleep()</code>ì€ GILì„ ë†“ìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì›Œì»¤ì—ì„œëŠ” ì ˆëŒ€ Qt ê°ì²´ ì ‘ê·¼ ê¸ˆì§€. ì‹ í˜¸ë¡œ ìˆœìˆ˜ íŒŒì´ì¬ ìë£Œë§Œ ì „ë‹¬.</p>
  </li>
  <li>
    <p>ë©”ì¸ ìŠ¬ë¡¯ì—ì„œì˜ ì‘ì—…ì„ O(å€™è£œìˆ˜)ë¡œ ìœ ì§€. <code class="language-plaintext highlighter-rouge">setStringList</code> í›„ ì¦‰ì‹œ <code class="language-plaintext highlighter-rouge">complete()</code>ë¥¼ ë§¤ë²ˆ í˜¸ì¶œí•˜ì§€ ë§ê³ , íŒì—…ì´ ì´ë¯¸ ì—´ë ¤ ìˆì„ ë•Œë§Œ, ê²°ê³¼ê°€ ë³€í–ˆì„ ë•Œë§Œ ê°±ì‹ .</p>
  </li>
  <li>
    <p>ì…ë ¥ ì¤‘ì—ëŠ” <code class="language-plaintext highlighter-rouge">QFileSystemModel</code> ë£¨íŠ¸ ë³€ê²½ ê¸ˆì§€. ë£¨íŠ¸ ë³€ê²½ì€ ë³„ë„ ì•¡ì…˜(ì—”í„°, ë²„íŠ¼, ë”ë¸”í´ë¦­)ì—ì„œë§Œ.</p>
  </li>
</ul>

<h1 id="ë°”ë¡œ-ì ìš©-ê°€ëŠ¥í•œ-ìˆ˜ìŠµ-íŒ">ë°”ë¡œ ì ìš© ê°€ëŠ¥í•œ ìˆ˜ìŠµ íŒ</h1>

<ul>
  <li>ì›Œì»¤ ë£¨í”„ íƒ€ì„ë°•ìŠ¤ì™€ GIL ì–‘ë³´:</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">time</span>

<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>
<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>  <span class="c1"># scandir ë£¨í”„
</span>    <span class="c1"># ... í•„í„°ë§/ìˆ˜ì§‘ ...
</span>    <span class="nf">if </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>  <span class="c1"># 50ms ì˜ˆì‚°
</span>        <span class="k">break</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">50</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># GIL ì–‘ë³´
</span></code></pre></div></div>

<ul>
  <li>
    <p>ê²°ê³¼ ì ìš© ìµœì†Œí™”:</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">QStringListModel</code> ì¬ì‚¬ìš©(ì´ë¯¸ í•˜ì…¨ë‹¤ë©´ ìœ ì§€).</p>
      </li>
      <li>
        <p>ì´ì „ ê²°ê³¼ì™€ ìƒˆ ê²°ê³¼ê°€ ê°™ìœ¼ë©´ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•Šê¸°.</p>
      </li>
      <li>
        <p>íŒì—…ì´ ì—´ë ¤ ìˆì„ ë•Œë§Œ <code class="language-plaintext highlighter-rouge">complete()</code> í˜¸ì¶œ.</p>
      </li>
      <li>
        <p>í›„ë³´ê°€ 0ê°œë©´ <code class="language-plaintext highlighter-rouge">complete()</code> í˜¸ì¶œ ê¸ˆì§€.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>ë£¨íŠ¸Â·ì§§ì€ ì ‘ë‘ì‚¬ ìŠ¤í‚µ: ë£¨íŠ¸(â€˜/â€™, â€˜\â€™)ì—ì„œ prefix ê¸¸ì´ &lt; 2ë©´ ì•„ì˜ˆ íƒìƒ‰í•˜ì§€ ì•Šê³  ë¹ˆ í›„ë³´ ë°˜í™˜.</p>
  </li>
  <li>
    <p>ìë™ì™„ì„± ì „ìš© <code class="language-plaintext highlighter-rouge">QThreadPool</code>ì„ 1ìŠ¤ë ˆë“œë¡œ ì œí•œí•´ì„œ íƒœìŠ¤í¬ ì ì²´ ë°©ì§€:</p>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">self</span><span class="p">.</span><span class="n">_auto_pool</span> <span class="o">=</span> <span class="nc">QThreadPool</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">_auto_pool</span><span class="p">.</span><span class="nf">setMaxThreadCount</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># self._auto_pool.start(task)
</span></code></pre></div></div>

<h1 id="ì™œì˜-í•µì‹¬-ìš”ì•½">â€œì™œâ€ì˜ í•µì‹¬ ìš”ì•½</h1>

<ul>
  <li>
    <p>ìŠ¤ë ˆë“œë¼ì„œ GUIê°€ ì ˆëŒ€ ì•ˆ ë©ˆì¶”ëŠ” ê²Œ ì•„ë‹™ë‹ˆë‹¤.<br />
íŒŒì´ì¬ì€ GIL ë•Œë¬¸ì— ì›Œì»¤ê°€ ì˜¤ë˜ ì ìœ í•˜ë©´ ë©”ì¸ì˜ Python ì½”ë“œê°€ ë©ˆì¶˜ ë“¯ ë³´ì…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì‹ í˜¸ê°€ ë©”ì¸ì— ë„ì°©í•´ë„, ê·¸ê±¸ ì²˜ë¦¬í•˜ëŠ” ìŠ¬ë¡¯ì´ ë¬´ê²ê±°ë‚˜ ìì£¼ ë¶ˆë¦¬ë©´ ë©”ì¸ì´ ë°”ë¹ ì ¸ì„œ ì—­ì‹œ â€œë©ˆì¶˜ ëŠë‚Œâ€ì´ ë‚©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>Qt ê°ì²´ëŠ” ë©”ì¸ì—ì„œë§Œ ë§Œì§€ì„¸ìš”. ì›Œì»¤ëŠ” ë°ì´í„°ë§Œ ë§Œë“¤ê³ , ì§§ê²Œ, íƒ€ì„ë°•ìŠ¤ ì•ˆì—ì„œ, GILì„ ì£¼ê¸°ì ìœ¼ë¡œ ë†“ìœ¼ë©´ì„œ ëŒë¦¬ë©´ ì²´ê° í”„ë¦¬ì¦ˆê°€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.</p>
  </li>
</ul>

<p>ì›í•˜ë©´ ë‹¹ì‹  ì½”ë“œì˜ ì›Œì»¤ ë¶€ë¶„ê³¼ ê²°ê³¼ ì ìš© ìŠ¬ë¡¯ ë¶€ë¶„ì„ ë”± 10ì¤„ ë‚´ë¡œ íŒ¨ì¹˜í•œ ë²„ì „ì„ ë§Œë“¤ì–´ì„œ ë¶™ì—¬ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

ê·¸ëŸ¬ë©´ ì“°ë ˆë“œ ë§ê³  ë©€í‹° í”„ë¡œì„¸ì‹±ìœ¼ë¡œ ê°€ì

</p>

<p>ì¢‹ì•„, ìë™ì™„ì„±ë§Œ â€œë©€í‹°í”„ë¡œì„¸ì‹±â€ìœ¼ë¡œ ë¹¼ì„œ GIL ì˜í–¥ì„ ì›ì²œ ì°¨ë‹¨í•˜ëŠ” ìª½ìœ¼ë¡œ ì •ë¦¬í•˜ì. í•µì‹¬ì€ ë‹¤ìŒ ì…‹ì—…ì´ì•¼.</p>

<ol>
  <li>
    <p>ì›Œì»¤ëŠ” í”„ë¡œì„¸ìŠ¤. ì…ë ¥ ë¬¸ìì—´ì„ ë°›ì•„ì„œ ê²½ë¡œ í›„ë³´ 10ê°œë§Œ ê³„ì‚°í•´ ìˆœìˆ˜ íŒŒì´ì¬ ë¦¬ìŠ¤íŠ¸ë¡œ ë°˜í™˜.</p>
  </li>
  <li>
    <p>GUIëŠ” ì—¬ì „íˆ ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œë§Œ Qt ê°ì²´ë¥¼ ë§Œì§. ê²°ê³¼ëŠ” ì‹œê·¸ë„ë¡œë§Œ ë°˜ì˜.</p>
  </li>
  <li>
    <p>ìœ„í—˜ êµ¬ê°„(ë£¨íŠ¸Â·ì§§ì€ ì ‘ë‘ì‚¬Â·ë„¤íŠ¸ì›Œí¬ ë£¨íŠ¸)ì˜ íƒìƒ‰ì„ íƒ€ì„ë°•ìŠ¤(ì˜ˆ: 50~100ms)ë¡œ ì œí•œ.</p>
  </li>
</ol>

<p>ì•„ë˜ëŠ” ë„ˆì˜ ê¸°ì¡´ ì½”ë“œì—ì„œ â€œì»´í”Œë¦¬í„° ìŠ¤ë ˆë“œâ€ ë¶€ë¶„ë§Œ êµì²´í•˜ë©´ ë˜ëŠ” ë“œë¡­ì¸ íŒ¨ì¹˜ì•¼. PySide6 ê·¸ëŒ€ë¡œ, <code class="language-plaintext highlighter-rouge">ProcessPoolExecutor(max_workers=1)</code>ë¥¼ ì‚¬ìš©í•´ ìš”ì²­ì„ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬í•˜ê³ , ì´ì „ ìš”ì²­ì€ task_idë¡œ ë¬´ì‹œí•œë‹¤.</p>

<h2 id="0-ì£¼ì˜ì‚¬í•­">0) ì£¼ì˜ì‚¬í•­</h2>

<ul>
  <li>
    <p>Windows/macOSì—ì„œ í”„ë¡œì„¸ìŠ¤ëŠ” spawnì´ ê¸°ë³¸ì´ë¼, ì›Œì»¤ í•¨ìˆ˜ëŠ” ë°˜ë“œì‹œ ëª¨ë“ˆ ìµœìƒìœ„ì— ìˆì–´ì•¼ í•˜ê³ (í”¼í´ë§), <code class="language-plaintext highlighter-rouge">if __name__ == "__main__":</code> ê°€ë“œ ì•ˆì—ì„œ ì•± ì‹¤í–‰í•´ì•¼ í•´. ì•„ë˜ ì˜ˆì œëŠ” ê·¸ ê·œì¹™ì„ ì§€í‚¨ í˜•íƒœì•¼.</p>
  </li>
  <li>
    <p>Qt ê°ì²´ëŠ” ì ˆëŒ€ ì›Œì»¤ì—ì„œ ì ‘ê·¼í•˜ì§€ ë§ ê²ƒ. ê²½ë¡œ ë¬¸ìì—´ë§Œ ì£¼ê³  ë¬¸ìì—´ ë¦¬ìŠ¤íŠ¸ë§Œ ë°›ëŠ”ë‹¤.</p>
  </li>
  <li>
    <p>í”„ë¡œì„¸ìŠ¤ ìª½ì—ì„œ <code class="language-plaintext highlighter-rouge">resolve()</code>ëŠ” ê¸ˆì§€. ë„¤íŠ¸ì›Œí¬ì—ì„œ ë§‰í ìˆ˜ ìˆë‹¤.</p>
  </li>
</ul>

<h2 id="1-ëª¨ë“ˆ-ìµœìƒìœ„-ì›Œì»¤-í•¨ìˆ˜-ì¶”ê°€">1) ëª¨ë“ˆ ìµœìƒìœ„: ì›Œì»¤ í•¨ìˆ˜ ì¶”ê°€</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># --- ëª¨ë“ˆ ìµœìƒìœ„ì— ì¶”ê°€ ---
</span><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="k">def</span> <span class="nf">_collect_completions</span><span class="p">(</span><span class="n">base_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">want_files</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">want_dirs</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                         <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">depth_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                         <span class="n">time_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">80</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    ë©€í‹°í”„ë¡œì„¸ìŠ¤ ì›Œì»¤. ìˆœìˆ˜ í•¨ìˆ˜.
    - ë£¨íŠ¸ + ì§§ì€ ì ‘ë‘ì‚¬ë©´ ë°”ë¡œ ë¹ˆ ë¦¬ìŠ¤íŠ¸.
    - ì§ì† í•­ëª©ë§Œ ìš°ì„ , í•„ìš”ì‹œ ì–•ì€ BFS(depth&lt;=1)ë¡œ ë³´ê°•.
    - scandir ë£¨í”„ëŠ” íƒ€ì„ë°•ìŠ¤(ê¸°ë³¸ 80ms) ë‚´ì—ì„œë§Œ ì‹¤í–‰.
    </span><span class="sh">"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
        <span class="n">sbase</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
        <span class="n">is_unc</span> <span class="o">=</span> <span class="n">sbase</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="se">\\\\</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">is_root</span> <span class="o">=</span> <span class="n">sbase</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,</span> <span class="sh">"</span><span class="s">C:</span><span class="se">\\</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">D:</span><span class="se">\\</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">E:</span><span class="se">\\</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_unc</span> <span class="ow">or</span> <span class="n">sbase</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/Volumes</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">short_prefix</span> <span class="o">=</span> <span class="p">(</span><span class="n">prefix</span> <span class="o">==</span> <span class="sh">""</span> <span class="ow">or</span> <span class="nf">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_root</span> <span class="ow">and</span> <span class="n">short_prefix</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># ì¡´ì¬ í™•ì¸ì€ ëŠë¦´ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë¬´ì¡°ê±´ ê°•í–‰í•˜ì§€ ë§ê³  ê°€ë³ê²Œ ì‹œë„
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">exists</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">exists</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">:</span>
            <span class="c1"># ê°€ê¹Œìš´ ìƒìœ„ë¡œ í´ë°±
</span>            <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">base</span><span class="p">.</span><span class="n">parents</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">parent</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
                        <span class="n">base</span> <span class="o">=</span> <span class="n">parent</span>
                        <span class="k">break</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">budget</span> <span class="o">=</span> <span class="n">time_budget_ms</span> <span class="o">/</span> <span class="mf">1000.0</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>

        <span class="c1"># 1) ì§ì†
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span>
                    <span class="k">if</span> <span class="n">prefix</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                        <span class="nf">if </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">budget</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">want_dirs</span><span class="p">:</span>
                            <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">want_files</span><span class="p">:</span>
                            <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">top_k</span> <span class="ow">or</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">budget</span><span class="p">:</span>
                        <span class="k">break</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># 2) ë³´ê°• BFS(ì•„ì£¼ ì–•ê²Œ, ì¡°ê±´ë¶€)
</span>        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">top_k</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_root</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">budget</span><span class="p">:</span>
            <span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">deque</span> <span class="k">as</span> <span class="n">cdeque</span>
            <span class="n">q</span> <span class="o">=</span> <span class="nf">cdeque</span><span class="p">([(</span><span class="n">base</span><span class="p">,</span> <span class="mi">0</span><span class="p">)])</span>
            <span class="n">seen</span> <span class="o">=</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">)}</span>
            <span class="k">while</span> <span class="n">q</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">top_k</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">budget</span><span class="p">:</span>
                <span class="n">cur</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="nf">popleft</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;=</span> <span class="n">depth_limit</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                            <span class="n">full</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">())</span> <span class="ow">and</span> <span class="n">want_dirs</span><span class="p">:</span>
                                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">))</span>
                                    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">top_k</span> <span class="ow">or</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">budget</span><span class="p">:</span>
                                        <span class="k">break</span>
                                <span class="n">s</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                                    <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="n">q</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">full</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">())</span> <span class="ow">and</span> <span class="n">want_files</span><span class="p">:</span>
                                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">))</span>
                                    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">top_k</span> <span class="ow">or</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">budget</span><span class="p">:</span>
                                        <span class="k">break</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>

        <span class="c1"># ì •ë ¬ì€ ì§§ì€ ê²½ë¡œ ìš°ì„ 
</span>        <span class="n">results</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span><span class="p">.</span><span class="nf">lower</span><span class="p">()))[:</span><span class="n">top_k</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">results</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
</code></pre></div></div>

<h2 id="2-ë‹¤ì´ì–¼ë¡œê·¸-í”„ë¡œì„¸ìŠ¤-í’€ê³¼-ì‹œê·¸ë„-ì¤€ë¹„">2) ë‹¤ì´ì–¼ë¡œê·¸: í”„ë¡œì„¸ìŠ¤ í’€ê³¼ ì‹œê·¸ë„ ì¤€ë¹„</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># __init__ ì•ˆì— (ê¸°ì¡´ ìŠ¤ë ˆë“œí’€Â·ì›Œì»¤ ê´€ë ¨ ì½”ë“œ ì œê±°í•˜ê³ ) ì¶”ê°€
</span><span class="kn">from</span> <span class="n">concurrent.futures</span> <span class="kn">import</span> <span class="n">ProcessPoolExecutor</span>
<span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="n">QObject</span><span class="p">,</span> <span class="n">Signal</span><span class="p">,</span> <span class="n">Slot</span><span class="p">,</span> <span class="n">QTimer</span><span class="p">,</span> <span class="n">QStringListModel</span>

<span class="n">self</span><span class="p">.</span><span class="n">_slm</span> <span class="o">=</span> <span class="nc">QStringListModel</span><span class="p">([],</span> <span class="n">self</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setModel</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">)</span>

<span class="n">self</span><span class="p">.</span><span class="n">_proc_pool</span> <span class="o">=</span> <span class="nc">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># ìë™ì™„ì„± ì „ìš© 1í”„ë¡œì„¸ìŠ¤
</span><span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">self</span><span class="p">.</span><span class="n">_task_seq</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># ê²°ê³¼ë¥¼ Qtë¡œ ë„˜ê¸¸ emitter
</span><span class="k">class</span> <span class="nc">_ProcEmitter</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
    <span class="n">resultsReady</span> <span class="o">=</span> <span class="nc">Signal</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">_proc_emitter</span> <span class="o">=</span> <span class="nf">_ProcEmitter</span><span class="p">()</span>
<span class="n">self</span><span class="p">.</span><span class="n">_proc_emitter</span><span class="p">.</span><span class="n">resultsReady</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_on_proc_results</span><span class="p">)</span>
</code></pre></div></div>

<p>ë‹¤ì´ì–¼ë¡œê·¸ê°€ ë‹«í ë•Œ í’€ì„ ì •ë¦¬í•´ ì¤˜ì•¼ í•´.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">closeEvent</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_proc_pool</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">cancel_futures</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="nf">super</span><span class="p">().</span><span class="nf">closeEvent</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="3-ì‘ì—…-íˆ¬ì…-ë¡œì§-êµì²´">3) ì‘ì—… íˆ¬ì… ë¡œì§ êµì²´</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_spawn_completer_task</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">([])</span>
        <span class="k">return</span>

    <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">text</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">):</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="n">text</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="k">if</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span>

    <span class="c1"># ë£¨íŠ¸Â·ì˜ì‹¬ ê²½ë¡œ ë‹¨ì¶• ë¦¬í„´
</span>    <span class="n">sbase</span> <span class="o">=</span> <span class="n">base_dir</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">base_dir</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,</span> <span class="sh">"</span><span class="se">\\\\</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sbase</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/volumes</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sbase</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/mnt</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sbase</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/net</span><span class="sh">"</span><span class="p">):</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">([])</span>
            <span class="k">return</span>

    <span class="n">want_files</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">want_dirs</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c1"># ì´ì „ ìš”ì²­ ë¬´ì‹œ(ì·¨ì†Œ ì‹œë„)
</span>    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span><span class="p">.</span><span class="nf">done</span><span class="p">():</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>  <span class="c1"># ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë©´ ì·¨ì†Œê°€ ë³´ì¥ë˜ì§„ ì•Šì§€ë§Œ ê²°ê³¼ëŠ” ë¬´ì‹œí•  ê±°ë¼ OK
</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_task_seq</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">seq</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_task_seq</span>

    <span class="c1"># ì œì¶œ
</span>    <span class="n">fut</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_proc_pool</span><span class="p">.</span><span class="nf">submit</span><span class="p">(</span><span class="n">_collect_completions</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">want_files</span><span class="p">,</span> <span class="n">want_dirs</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span> <span class="o">=</span> <span class="n">fut</span>

    <span class="c1"># ì™„ë£Œ ì½œë°±: ì›Œì»¤ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰â†’Qt ì‹œê·¸ë„ë¡œ ë©”ì¸ì— ì „ë‹¬
</span>    <span class="k">def</span> <span class="nf">_on_done</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="p">.</span><span class="nf">done</span><span class="p">()</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_proc_emitter</span><span class="p">.</span><span class="n">resultsReady</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
    <span class="n">fut</span><span class="p">.</span><span class="nf">add_done_callback</span><span class="p">(</span><span class="n">_on_done</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="4-ê²°ê³¼-ì ìš©-ìŠ¬ë¡¯">4) ê²°ê³¼ ì ìš© ìŠ¬ë¡¯</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slot</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_on_proc_results</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">seq</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">seq</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_task_seq</span><span class="p">:</span>
        <span class="k">return</span>  <span class="c1"># ìµœì‹  ìš”ì²­ë§Œ ë°˜ì˜
</span>    <span class="c1"># ê²½ëŸ‰ ê°±ì‹ 
</span>    <span class="n">items</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
    <span class="c1"># ì´ì „ê³¼ ë™ì¼í•˜ë©´ ê°±ì‹  ìƒëµ
</span>    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">stringList</span><span class="p">()</span> <span class="o">==</span> <span class="n">items</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
    <span class="c1"># íŒì—…ì€ í•„ìš”í•  ë•Œë§Œ
</span>    <span class="k">if</span> <span class="n">items</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">hasFocus</span><span class="p">()</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">popup</span><span class="p">().</span><span class="nf">isVisible</span><span class="p">():</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">complete</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="5-ì—”íŠ¸ë¦¬-í¬ì¸íŠ¸-ê°€ë“œ">5) ì—”íŠ¸ë¦¬ í¬ì¸íŠ¸ ê°€ë“œ</h2>

<p>ë©€í‹°í”„ë¡œì„¸ì‹±ì„ ì“°ë©´ ë©”ì¸ ì§„ì…ì„ ê°€ë“œí•´ì•¼ í•´.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">app</span> <span class="o">=</span> <span class="nc">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span>
    <span class="c1"># ... ë‹¤ì´ì–¼ë¡œê·¸ ì‹¤í–‰ ...
</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="c1"># í•„ìš”ì‹œ: from multiprocessing import set_start_method; set_start_method("spawn", force=True)
</span>    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="6-ì™œ-ì´-êµ¬ì„±ì´-ì•ˆì „í•œê°€">6) ì™œ ì´ êµ¬ì„±ì´ ì•ˆì „í•œê°€</h2>

<ul>
  <li>
    <p>GIL: í›„ë³´ ìˆ˜ì§‘ì€ ë³„ë„ í”„ë¡œì„¸ìŠ¤ì—ì„œ ëŒì•„ì„œ ë©”ì¸ì˜ íŒŒì´ì¬ ìŠ¬ë¡¯Â·íƒ€ì´ë¨¸ê°€ êµ¶ì§€ ì•ŠëŠ”ë‹¤.</p>
  </li>
  <li>
    <p>Qt ìŠ¤ë ˆë“œ ê·œì¹™: ì›Œì»¤ëŠ” ìˆœìˆ˜ ë°ì´í„°ë§Œ ë°˜í™˜í•˜ê³ , Qt ê°ì²´ ê°±ì‹ ì€ ì‹œê·¸ë„ ìŠ¬ë¡¯ì—ì„œë§Œ ì²˜ë¦¬.</p>
  </li>
  <li>
    <p>ë¸”ë¡œí‚¹ I/O: ë„¤íŠ¸ì›Œí¬ì—ì„œ <code class="language-plaintext highlighter-rouge">scandir()</code>ê°€ ì ì‹œ ë©ˆì¶°ë„ GUIëŠ” ë…ë¦½ì . íƒ€ì„ë°•ìŠ¤ë¡œ ì¥ê¸° ë¸”ë¡œí‚¹ì„ ë” ì¤„ì˜€ë‹¤.</p>
  </li>
  <li>
    <p>í­ì£¼ ë°©ì§€: <code class="language-plaintext highlighter-rouge">max_workers=1</code>ë¡œ í ëˆ„ì ì„ ì œí•œí•˜ê³ , task_seqë¡œ ì˜¤ë˜ëœ ê²°ê³¼ë¥¼ ë¬´ì‹œí•œë‹¤.</p>
  </li>
</ul>

<h2 id="í™•ì¥-íŒ">í™•ì¥ íŒ</h2>

<ul>
  <li>
    <p>ë„¤íŠ¸ì›Œí¬ ë“œë¼ì´ë¸Œì—ì„œ ë” ì—¬ìœ ê°€ í•„ìš”í•˜ë©´ <code class="language-plaintext highlighter-rouge">time_budget_ms</code>ë¥¼ 120~150ìœ¼ë¡œ, ëŒ€ì‹  <code class="language-plaintext highlighter-rouge">depth_limit=0</code>ìœ¼ë¡œ ìœ ì§€(ì§ì†ë§Œ).</p>
  </li>
  <li>
    <p>macOS ì•± ë²ˆë“¤ë¡œ ë°°í¬í•  ë•ŒëŠ” ì›Œì»¤ í•¨ìˆ˜ë¥¼ ë³„ë„ <code class="language-plaintext highlighter-rouge">.py</code> ëª¨ë“ˆë¡œ ë¶„ë¦¬í•˜ë©´ ìŠ¤í° ì•ˆì •ì„±ì´ ì˜¬ë¼ê°„ë‹¤.</p>
  </li>
  <li>
    <p>í›„ë³´ ìºì‹±ì„ ì¶”ê°€í•˜ë©´ ê°™ì€ <code class="language-plaintext highlighter-rouge">base_dir</code>ì—ì„œ ì ‘ë‘ì‚¬ê°€ ê¸¸ì–´ì§ˆìˆ˜ë¡ ì¬ì‚¬ìš© ê°€ëŠ¥(í”„ë¡œì„¸ìŠ¤ ë©”ëª¨ë¦¬ì—ë„ ìºì‹œë¥¼ ë‘˜ì§€, ë©”ì¸ì—ì„œ ìµœê·¼ ê²°ê³¼ë¥¼ ì¬í™œìš©í• ì§€ ì„ íƒ).</p>
  </li>
</ul>

<p>ì´ëŒ€ë¡œ ë¶™ì—¬ì„œ ëŒë ¤ë³´ê³ , ì—¬ì „íˆ íŠ¹ì • ê²½ë¡œì—ì„œ ì²´ê° ì§€ì—°ì´ ìˆìœ¼ë©´ ë¡œê·¸ í•œë‘ ì¤„ë§Œ ê³µìœ í•´ì¤˜. íƒ€ì„ë°•ìŠ¤Â·ê¹Šì´Â·ë£¨íŠ¸ ê·œì¹™ì„ ê²½ë¡œë³„ë¡œ ë¯¸ì„¸ ì¡°ì •í•´ ë” ë¯¼ì²©í•˜ê²Œ ë§Œë“¤ ìˆ˜ ìˆì–´.</p>

<p class="chat--user">

ì „ì²´ ì½”ë“œ ì¢€

</p>

<p>ì¢‹ì•„. ì•„ë˜ëŠ” ë©€í‹°í”„ë¡œì„¸ì‹± ê¸°ë°˜ ìë™ì™„ì„±(ì»´í”Œë¦¬í„°)ì„ í¬í•¨í•œ ì „ì²´ ë™ì‘ ì˜ˆì œì•¼.<br />
PySide6 ê¸°ì¤€ì´ê³ , <code class="language-plaintext highlighter-rouge">ProcessPoolExecutor(max_workers=1)</code>ë¡œ ìë™ì™„ì„±ë§Œ ë³„ë„ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì²˜ë¦¬í•´ì„œ GILÂ·ë¸”ë¡œí‚¹ ì˜í–¥ì„ ì°¨ë‹¨í•´. ê²½ë¡œ ì½¤ë³´/BackÂ·ForwardÂ·ParentÂ·New Folder, íŒŒì¼Â·í´ë” ëª¨ë“œ, Open/Save, Type í•„í„°, íˆìŠ¤í† ë¦¬, ë””ë°”ìš´ìŠ¤, ê·¸ë¦¬ê³  ì•ˆì „ì¥ì¹˜(ë£¨íŠ¸+ì§§ì€ ì ‘ë‘ì‚¬ ì°¨ë‹¨, <code class="language-plaintext highlighter-rouge">scandir()</code> íƒ€ì„ë°•ìŠ¤)ê¹Œì§€ í¬í•¨í–ˆì–´.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># -*- coding: utf-8 -*-
</span><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">fnmatch</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">concurrent.futures</span> <span class="kn">import</span> <span class="n">ProcessPoolExecutor</span>

<span class="c1"># ==========================================
# ë©€í‹°í”„ë¡œì„¸ìŠ¤ ì›Œì»¤ í•¨ìˆ˜ (ëª¨ë“ˆ ìµœìƒìœ„ì— ìˆì–´ì•¼ í•¨)
# ==========================================
</span><span class="k">def</span> <span class="nf">_collect_completions</span><span class="p">(</span><span class="n">base_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">want_files</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">want_dirs</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                         <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">depth_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                         <span class="n">time_budget_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">80</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    ìë™ì™„ì„± í›„ë³´ë¥¼ ìˆ˜ì§‘í•˜ëŠ” ìˆœìˆ˜ í•¨ìˆ˜(ë³„ë„ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì‹¤í–‰).
    - ë£¨íŠ¸ + ì§§ì€ ì ‘ë‘ì‚¬ë©´ ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜
    - ì§ì† í•­ëª© ìš°ì„ , í•„ìš” ì‹œ ë§¤ìš° ì–•ì€ BFS(depth&lt;=1)ë¡œ ë³´ê°•
    - os.scandir ë£¨í”„ëŠ” íƒ€ì„ë°•ìŠ¤ ë‚´ì—ì„œë§Œ ë™ì‘
    - Qt ê°ì²´ ì ‘ê·¼ ì ˆëŒ€ ê¸ˆì§€ (ë¬¸ìì—´ ë¦¬ìŠ¤íŠ¸ë§Œ ë°˜í™˜)
    </span><span class="sh">"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
        <span class="n">sbase</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>

        <span class="c1"># í”Œë«í¼ë³„ ë£¨íŠ¸ íŒë‹¨
</span>        <span class="n">is_unc</span> <span class="o">=</span> <span class="n">sbase</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="se">\\\\</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">is_root_like</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">sbase</span> <span class="o">==</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span> <span class="ow">or</span>
            <span class="n">sbase</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">C:</span><span class="se">\\</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">D:</span><span class="se">\\</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">E:</span><span class="se">\\</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">F:</span><span class="se">\\</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">is_unc</span> <span class="ow">or</span>
            <span class="n">sbase</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/Volumes</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">sbase</span> <span class="o">==</span> <span class="sh">"</span><span class="s">/</span><span class="sh">"</span>
        <span class="p">)</span>

        <span class="n">short_prefix</span> <span class="o">=</span> <span class="p">(</span><span class="n">prefix</span> <span class="o">==</span> <span class="sh">""</span> <span class="ow">or</span> <span class="nf">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_root_like</span> <span class="ow">and</span> <span class="n">short_prefix</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># ì¡´ì¬ í™•ì¸ì€ ë„¤íŠ¸ì›Œí¬ì—ì„œ ëŠë¦´ ìˆ˜ ìˆìœ¼ë‹ˆ ì¡°ì‹¬ìŠ¤ëŸ½ê²Œ
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">exists</span> <span class="o">=</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">exists</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">:</span>
            <span class="c1"># ê°€ê¹Œìš´ ìƒìœ„ë¡œ í´ë°±
</span>            <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">base</span><span class="p">.</span><span class="n">parents</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">parent</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
                        <span class="n">base</span> <span class="o">=</span> <span class="n">parent</span>
                        <span class="k">break</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">budget</span> <span class="o">=</span> <span class="n">time_budget_ms</span> <span class="o">/</span> <span class="mf">1000.0</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span>

        <span class="c1"># 1) ì§ì† í•­ëª© ìŠ¤ìº” (íƒ€ì„ë°•ìŠ¤)
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span>
                    <span class="k">if</span> <span class="n">prefix</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">()):</span>
                        <span class="nf">if </span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">budget</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">want_dirs</span><span class="p">:</span>
                            <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">want_files</span><span class="p">:</span>
                            <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">top_k</span> <span class="ow">or</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">budget</span><span class="p">:</span>
                        <span class="k">break</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="c1"># PermissionError, OSError ë“±ì€ ë¬´ì‹œ
</span>            <span class="k">pass</span>

        <span class="c1"># 2) ë³´ê°• BFS (ì¡°ê±´ë¶€, ë§¤ìš° ì–•ê²Œ, íƒ€ì„ë°•ìŠ¤)
</span>        <span class="nf">if </span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">top_k</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_root_like</span>
            <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span>
            <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">budget</span>
            <span class="ow">and</span> <span class="n">depth_limit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="kn">from</span> <span class="n">collections</span> <span class="kn">import</span> <span class="n">deque</span> <span class="k">as</span> <span class="n">cdeque</span>
            <span class="n">q</span> <span class="o">=</span> <span class="nf">cdeque</span><span class="p">([(</span><span class="n">base</span><span class="p">,</span> <span class="mi">0</span><span class="p">)])</span>
            <span class="n">seen</span> <span class="o">=</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">base</span><span class="p">)}</span>
            <span class="k">while</span> <span class="n">q</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">top_k</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">budget</span><span class="p">:</span>
                <span class="n">cur</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="nf">popleft</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;=</span> <span class="n">depth_limit</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">os</span><span class="p">.</span><span class="nf">scandir</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="k">as</span> <span class="n">it</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                            <span class="n">full</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
                            <span class="c1"># ë§¤ì¹­ í™•ì¸
</span>                            <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">(</span><span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">())</span> <span class="ow">and</span> <span class="n">want_dirs</span><span class="p">:</span>
                                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">))</span>
                                    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">top_k</span> <span class="ow">or</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">budget</span><span class="p">:</span>
                                        <span class="k">break</span>
                                <span class="n">s</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                                    <span class="n">seen</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                                    <span class="n">q</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">full</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">.</span><span class="nf">lower</span><span class="p">())</span> <span class="ow">and</span> <span class="n">want_files</span><span class="p">:</span>
                                    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">full</span><span class="p">))</span>
                                    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">top_k</span> <span class="ow">or</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">budget</span><span class="p">:</span>
                                        <span class="k">break</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>

        <span class="n">results</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span><span class="p">.</span><span class="nf">lower</span><span class="p">()))[:</span><span class="n">top_k</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">results</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="c1"># ==========================================
# Qt ì„í¬íŠ¸
# ==========================================
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="n">Qt</span><span class="p">,</span> <span class="n">QObject</span><span class="p">,</span> <span class="n">Signal</span><span class="p">,</span> <span class="n">Slot</span><span class="p">,</span> <span class="n">QModelIndex</span><span class="p">,</span> <span class="n">QTimer</span><span class="p">,</span> <span class="n">QStringListModel</span>
    <span class="kn">from</span> <span class="n">PySide6.QtWidgets</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">QApplication</span><span class="p">,</span> <span class="n">QDialog</span><span class="p">,</span> <span class="n">QVBoxLayout</span><span class="p">,</span> <span class="n">QHBoxLayout</span><span class="p">,</span> <span class="n">QToolButton</span><span class="p">,</span> <span class="n">QComboBox</span><span class="p">,</span>
        <span class="n">QTreeView</span><span class="p">,</span> <span class="n">QFileSystemModel</span><span class="p">,</span> <span class="n">QLineEdit</span><span class="p">,</span> <span class="n">QCompleter</span><span class="p">,</span> <span class="n">QDialogButtonBox</span><span class="p">,</span>
        <span class="n">QInputDialog</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="p">,</span> <span class="n">QLabel</span><span class="p">,</span> <span class="n">QSizePolicy</span>
    <span class="p">)</span>
<span class="k">except</span> <span class="nb">ImportError</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">PySide6ê°€ í•„ìš”í•©ë‹ˆë‹¤. pip install PySide6</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># ==========================================
# CFileDialog ë³¸ì²´
# ==========================================
</span><span class="k">class</span> <span class="nc">CFileDialog</span><span class="p">(</span><span class="n">QDialog</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    mode: </span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="s"> | </span><span class="sh">'</span><span class="s">save</span><span class="sh">'</span><span class="s">
    select_mode: </span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="s"> | </span><span class="sh">'</span><span class="s">folder</span><span class="sh">'</span><span class="s">

    ì‚¬ìš© ì˜ˆ:
        dlg = CFileDialog(mode=</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="s">, select_mode=</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="s">,
                          filters=[</span><span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">Images (*.png *.jpg)</span><span class="sh">"</span><span class="s">])
        if dlg.exec():
            print(dlg.selected_path())
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">start_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">,</span> <span class="n">select_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">,</span>
                 <span class="n">filters</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">setWindowTitle</span><span class="p">(</span><span class="sh">"</span><span class="s">CFileDialog (Multiprocessing Completer)</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">resize</span><span class="p">(</span><span class="mi">960</span><span class="p">,</span> <span class="mi">640</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">=</span> <span class="n">select_mode</span>
        <span class="n">self</span><span class="p">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">filters</span> <span class="ow">or</span> <span class="p">[</span><span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="p">]</span>

        <span class="n">self</span><span class="p">.</span><span class="n">history_back</span> <span class="o">=</span> <span class="nf">deque</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">history_fwd</span> <span class="o">=</span> <span class="nf">deque</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">current_path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">start_path</span><span class="p">).</span><span class="nf">resolve</span><span class="p">())</span> <span class="k">if</span> <span class="n">start_path</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">()</span>

        <span class="c1"># ìë™ì™„ì„± ìƒíƒœ
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span> <span class="o">=</span> <span class="nc">QTimer</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span><span class="p">.</span><span class="nf">setInterval</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>  <span class="c1"># ì…ë ¥ ë””ë°”ìš´ìŠ¤
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span><span class="p">.</span><span class="nf">setSingleShot</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span><span class="p">.</span><span class="n">timeout</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_spawn_completer_task</span><span class="p">)</span>

        <span class="c1"># í”„ë¡œì„¸ìŠ¤ í’€: ìë™ì™„ì„± ì „ìš©, ë™ì‹œ 1ê°œ
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_proc_pool</span> <span class="o">=</span> <span class="nc">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_task_seq</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># í”„ë¡œì„¸ìŠ¤ ê²°ê³¼ë¥¼ Qtë¡œ ì „ë‹¬í•˜ëŠ” emitter
</span>        <span class="k">class</span> <span class="nc">_ProcEmitter</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
            <span class="n">resultsReady</span> <span class="o">=</span> <span class="nc">Signal</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_proc_emitter</span> <span class="o">=</span> <span class="nf">_ProcEmitter</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_proc_emitter</span><span class="p">.</span><span class="n">resultsReady</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_on_proc_results</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="nf">_build_ui</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_connect_signals</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_configure_modes</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">,</span> <span class="n">push_history</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># ---------- UI êµ¬ì„± ----------
</span>    <span class="k">def</span> <span class="nf">_build_ui</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># ìƒë‹¨ íˆ´ë°”
</span>        <span class="n">self</span><span class="p">.</span><span class="n">back_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sh">"</span><span class="s">Back</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">forward_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sh">"</span><span class="s">Forward</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">up_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sh">"</span><span class="s">Parent</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">new_folder_btn</span> <span class="o">=</span> <span class="nc">QToolButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sh">"</span><span class="s">New Folder</span><span class="sh">"</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span> <span class="o">=</span> <span class="nc">QComboBox</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="p">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="p">.</span><span class="n">Fixed</span><span class="p">)</span>

        <span class="n">top</span> <span class="o">=</span> <span class="nc">QHBoxLayout</span><span class="p">()</span>
        <span class="n">top</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">back_btn</span><span class="p">)</span>
        <span class="n">top</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">forward_btn</span><span class="p">)</span>
        <span class="n">top</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">up_btn</span><span class="p">)</span>
        <span class="n">top</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">new_folder_btn</span><span class="p">)</span>
        <span class="n">top</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">)</span>

        <span class="c1"># ì¤‘ì•™ ë·°
</span>        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="nc">QFileSystemModel</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setRootPath</span><span class="p">(</span><span class="sh">""</span><span class="p">)</span>  <span class="c1"># ì „ì²´ FS
</span>        <span class="n">self</span><span class="p">.</span><span class="n">view</span> <span class="o">=</span> <span class="nc">QTreeView</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setModel</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setRootIsDecorated</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setSortingEnabled</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">sortByColumn</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Qt</span><span class="p">.</span><span class="n">AscendingOrder</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setSelectionBehavior</span><span class="p">(</span><span class="n">QTreeView</span><span class="p">.</span><span class="n">SelectRows</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setUniformRowHeights</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setColumnWidth</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>

        <span class="c1"># í•˜ë‹¨: ê²½ë¡œ ì…ë ¥ + Type + ë²„íŠ¼ë“¤
</span>        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span> <span class="o">=</span> <span class="nc">QLineEdit</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setPlaceholderText</span><span class="p">(</span><span class="sh">"</span><span class="s">ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”â€¦</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># QCompleter + QStringListModel ì¬ì‚¬ìš©
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_slm</span> <span class="o">=</span> <span class="nc">QStringListModel</span><span class="p">([],</span> <span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span> <span class="o">=</span> <span class="nc">QCompleter</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setCaseSensitivity</span><span class="p">(</span><span class="n">Qt</span><span class="p">.</span><span class="n">CaseInsensitive</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setFilterMode</span><span class="p">(</span><span class="n">Qt</span><span class="p">.</span><span class="n">MatchContains</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">setCompletionMode</span><span class="p">(</span><span class="n">QCompleter</span><span class="p">.</span><span class="n">PopupCompletion</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setCompleter</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span> <span class="o">=</span> <span class="nc">QComboBox</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">.</span><span class="nf">addItems</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">filters</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">button_box</span> <span class="o">=</span> <span class="nc">QDialogButtonBox</span><span class="p">(</span><span class="n">QDialogButtonBox</span><span class="p">.</span><span class="n">Ok</span> <span class="o">|</span> <span class="n">QDialogButtonBox</span><span class="p">.</span><span class="n">Cancel</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">self</span><span class="p">)</span>

        <span class="n">bottom</span> <span class="o">=</span> <span class="nc">QHBoxLayout</span><span class="p">()</span>
        <span class="n">bottom</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="nc">QLabel</span><span class="p">(</span><span class="sh">"</span><span class="s">ê²½ë¡œ:</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">bottom</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">)</span>
        <span class="n">bottom</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="nc">QLabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Type:</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">bottom</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">)</span>

        <span class="n">layout</span> <span class="o">=</span> <span class="nc">QVBoxLayout</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addLayout</span><span class="p">(</span><span class="n">top</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addLayout</span><span class="p">(</span><span class="n">bottom</span><span class="p">)</span>
        <span class="n">layout</span><span class="p">.</span><span class="nf">addWidget</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">)</span>

    <span class="c1"># ---------- ì‹œê·¸ë„ ----------
</span>    <span class="k">def</span> <span class="nf">_connect_signals</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">back_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_go_back</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">forward_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_go_forward</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">up_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_go_up</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">new_folder_btn</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_create_folder</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="n">activated</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_combo_jump</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">doubleClicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_item_double_clicked</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">clicked</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_item_clicked</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="n">textEdited</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_on_path_edited</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">.</span><span class="n">currentTextChanged</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_on_filter_changed</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">.</span><span class="n">accepted</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_accept_if_valid</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">.</span><span class="n">rejected</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">reject</span><span class="p">)</span>

    <span class="c1"># ---------- ëª¨ë“œ/í•„í„° ----------
</span>    <span class="k">def</span> <span class="nf">_configure_modes</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="n">PySide6.QtCore</span> <span class="kn">import</span> <span class="n">QDir</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">folder</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setFilter</span><span class="p">(</span><span class="n">QDir</span><span class="p">.</span><span class="n">AllDirs</span> <span class="o">|</span> <span class="n">QDir</span><span class="p">.</span><span class="n">NoDotAndDotDot</span> <span class="o">|</span> <span class="n">QDir</span><span class="p">.</span><span class="n">Drives</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setFilter</span><span class="p">(</span><span class="n">QDir</span><span class="p">.</span><span class="n">AllEntries</span> <span class="o">|</span> <span class="n">QDir</span><span class="p">.</span><span class="n">NoDotAndDotDot</span> <span class="o">|</span> <span class="n">QDir</span><span class="p">.</span><span class="n">Drives</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setNameFilterDisables</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_apply_name_filters_from_combo</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_apply_name_filters_from_combo</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">.</span><span class="nf">currentText</span><span class="p">()</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">(</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="sh">"</span><span class="s">)</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">inside</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">text</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">(</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">text</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">)</span><span class="sh">"</span><span class="p">)]</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">inside</span><span class="p">.</span><span class="nf">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">patterns</span><span class="p">:</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">setNameFilters</span><span class="p">(</span><span class="n">patterns</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_filter_changed</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_apply_name_filters_from_combo</span><span class="p">()</span>

    <span class="c1"># ---------- ê²½ë¡œ ë¡œë”© ----------
</span>    <span class="k">def</span> <span class="nf">_load_path</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">push_history</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="c1"># resolve()ëŠ” ë©”ì¸ì—ì„œë§Œ ì‚¬ìš© (UI ë°˜ì‘ ëŠë ¤ì§€ë©´ ìƒëµí•´ë„ ë¨)
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">resolve</span><span class="p">())</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">push_history</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">current_path</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">current_path</span> <span class="o">!=</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">history_back</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">history_fwd</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

        <span class="n">self</span><span class="p">.</span><span class="n">current_path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_update_path_combo</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="nf">setRootIndex</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_update_ok_enabled</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_combo_jump</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">itemText</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_path_combo</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">blockSignals</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">parts</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)):</span>
            <span class="n">acc</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">addItem</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="o">*</span><span class="n">acc</span><span class="p">)))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">setCurrentIndex</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_combo</span><span class="p">.</span><span class="nf">blockSignals</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># ---------- íƒìƒ‰ ----------
</span>    <span class="k">def</span> <span class="nf">_go_back</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">history_back</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">history_back</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">history_fwd</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">push_history</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_go_forward</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">history_fwd</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">history_fwd</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">history_back</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">push_history</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_go_up</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">).</span><span class="n">parent</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="ow">and</span> <span class="n">parent</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_folder</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">ok</span> <span class="o">=</span> <span class="n">QInputDialog</span><span class="p">.</span><span class="nf">getText</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">ìƒˆ í´ë”</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">í´ë”ëª…:</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">name</span><span class="p">.</span><span class="nf">strip</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="n">target</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_path</span><span class="p">,</span> <span class="n">name</span><span class="p">.</span><span class="nf">strip</span><span class="p">())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">target</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
        <span class="k">except</span> <span class="nb">FileExistsError</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">ê²½ê³ </span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ë™ì¼í•œ ì´ë¦„ì˜ í´ë”ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="p">.</span><span class="nf">critical</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">ì˜¤ë¥˜</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">í´ë”ë¥¼ ë§Œë“¤ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="p">.</span><span class="nf">critical</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">ì˜¤ë¥˜</span><span class="sh">"</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">í´ë” ìƒì„± ì‹¤íŒ¨: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># ---------- ë·° ìƒí˜¸ì‘ìš© ----------
</span>    <span class="k">def</span> <span class="nf">_item_clicked</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">QModelIndex</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">filePath</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_update_ok_enabled</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_item_double_clicked</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">QModelIndex</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">filePath</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_load_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">setText</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_update_ok_enabled</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">open</span><span class="sh">'</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">accept</span><span class="p">()</span>

    <span class="c1"># ---------- ì„ íƒ ìœ íš¨ì„± ----------
</span>    <span class="k">def</span> <span class="nf">_is_selection_valid</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">folder</span><span class="sh">'</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">_match_type_filters</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">target</span><span class="p">).</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">target</span><span class="p">).</span><span class="n">parent</span>
            <span class="k">return</span> <span class="n">parent</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">parent</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_match_type_filters</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">type_combo</span><span class="p">.</span><span class="nf">currentText</span><span class="p">()</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">(</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="sh">"</span><span class="s">)</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">inside</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">text</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">(</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">text</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">)</span><span class="sh">"</span><span class="p">)]</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">inside</span><span class="p">.</span><span class="nf">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">strip</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">patterns</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fnmatch</span><span class="p">.</span><span class="nf">fnmatch</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">pat</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_update_ok_enabled</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">ok_btn</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">button_box</span><span class="p">.</span><span class="nf">button</span><span class="p">(</span><span class="n">QDialogButtonBox</span><span class="p">.</span><span class="n">Ok</span><span class="p">)</span>
        <span class="n">ok_btn</span><span class="p">.</span><span class="nf">setEnabled</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_is_selection_valid</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_accept_if_valid</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_is_selection_valid</span><span class="p">():</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">accept</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">"</span><span class="s">ì„ íƒ í™•ì¸</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ì„ íƒì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># ---------- ê²½ë¡œ ì…ë ¥/ìë™ì™„ì„±(ë©€í‹°í”„ë¡œì„¸ì‹±) ----------
</span>    <span class="k">def</span> <span class="nf">_on_path_edited</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
        <span class="c1"># ì…ë ¥ ì¤‘ì—ëŠ” ë£¨íŠ¸ ë³€ê²½ ê¸ˆì§€. ìë™ì™„ì„±ë§Œ íŠ¸ë¦¬ê±°.
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_debounce_timer</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_update_ok_enabled</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_spawn_completer_task</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">([])</span>
            <span class="k">return</span>

        <span class="n">p</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">text</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">):</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="n">text</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="k">if</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span>

        <span class="c1"># ë£¨íŠ¸/ì˜ì‹¬ ê²½ë¡œì—ì„œ ì§§ì€ ì ‘ë‘ì‚¬ë©´ ë¯¸ë¦¬ ì°¨ë‹¨
</span>        <span class="n">sbase</span> <span class="o">=</span> <span class="n">base_dir</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">base_dir</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,</span> <span class="sh">"</span><span class="se">\\\\</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sbase</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/volumes</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sbase</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/mnt</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sbase</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">/net</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">([])</span>
                <span class="k">return</span>

        <span class="n">want_files</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">select_mode</span> <span class="o">==</span> <span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">want_dirs</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c1"># ì´ì „ ìš”ì²­ ì·¨ì†Œ ì‹œë„ (spawnëœ í”„ë¡œì„¸ìŠ¤ ì‘ì—…ì€ ì¦‰ì‹œ ì•ˆ êº¼ì§ˆ ìˆ˜ ìˆìœ¼ë‚˜, ìš°ë¦¬ëŠ” ê²°ê³¼ë¥¼ ë¬´ì‹œ)
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span><span class="p">.</span><span class="nf">done</span><span class="p">():</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_task_seq</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_task_seq</span>

        <span class="c1"># ì œì¶œ
</span>        <span class="n">fut</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_proc_pool</span><span class="p">.</span><span class="nf">submit</span><span class="p">(</span><span class="n">_collect_completions</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">want_files</span><span class="p">,</span> <span class="n">want_dirs</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span> <span class="o">=</span> <span class="n">fut</span>

        <span class="c1"># ì™„ë£Œ ì½œë°±: ì›Œì»¤ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰ë˜ë¯€ë¡œ Qtë¡œ ì‹ í˜¸ ì „ë‹¬
</span>        <span class="k">def</span> <span class="nf">_on_done</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">result</span><span class="p">()</span> <span class="k">if</span> <span class="n">f</span><span class="p">.</span><span class="nf">done</span><span class="p">()</span> <span class="k">else</span> <span class="p">[]</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_proc_emitter</span><span class="p">.</span><span class="n">resultsReady</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
        <span class="n">fut</span><span class="p">.</span><span class="nf">add_done_callback</span><span class="p">(</span><span class="n">_on_done</span><span class="p">)</span>

    <span class="nd">@Slot</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_on_proc_results</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">seq</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">seq</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">_task_seq</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># ìµœì‹  ìš”ì²­ë§Œ ë°˜ì˜
</span>        <span class="n">items</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
        <span class="c1"># ì´ì „ê³¼ ë™ì¼í•˜ë©´ ê°±ì‹  ìƒëµ
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">stringList</span><span class="p">()</span> <span class="o">==</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_slm</span><span class="p">.</span><span class="nf">setStringList</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="c1"># íŒì—…ì€ ì¡°ê±´ë¶€ë¡œë§Œ í˜¸ì¶œ
</span>        <span class="k">if</span> <span class="n">items</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">hasFocus</span><span class="p">()</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">popup</span><span class="p">().</span><span class="nf">isVisible</span><span class="p">():</span>
            <span class="n">self</span><span class="p">.</span><span class="n">completer</span><span class="p">.</span><span class="nf">complete</span><span class="p">()</span>

    <span class="c1"># ---------- ì¢…ë£Œ ì²˜ë¦¬ ----------
</span>    <span class="k">def</span> <span class="nf">closeEvent</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_pending_future</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_proc_pool</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">cancel_futures</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">closeEvent</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="c1"># ---------- ì™¸ë¶€ API ----------
</span>    <span class="k">def</span> <span class="nf">selected_path</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">path_edit</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>

<span class="c1"># ==========================================
# ì‹¤í–‰ ì˜ˆì‹œ
# ==========================================
</span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">app</span> <span class="o">=</span> <span class="nc">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span>

    <span class="c1"># ì˜ˆì‹œ 1: íŒŒì¼ Open
</span>    <span class="n">dlg1</span> <span class="o">=</span> <span class="nc">CFileDialog</span><span class="p">(</span>
        <span class="n">start_path</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">(),</span>
        <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">select_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">filters</span><span class="o">=</span><span class="p">[</span>
            <span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">Text Files (*.txt *.md)</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">Images (*.png *.jpg *.jpeg *.bmp *.gif)</span><span class="sh">"</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">dlg1</span><span class="p">.</span><span class="nf">exec</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">OPEN FILE:</span><span class="sh">"</span><span class="p">,</span> <span class="n">dlg1</span><span class="p">.</span><span class="nf">selected_path</span><span class="p">())</span>

    <span class="c1"># ì˜ˆì‹œ 2: í´ë” ì„ íƒ
</span>    <span class="n">dlg2</span> <span class="o">=</span> <span class="nc">CFileDialog</span><span class="p">(</span>
        <span class="n">start_path</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">(),</span>
        <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">select_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">folder</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">dlg2</span><span class="p">.</span><span class="nf">exec</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">SELECT FOLDER:</span><span class="sh">"</span><span class="p">,</span> <span class="n">dlg2</span><span class="p">.</span><span class="nf">selected_path</span><span class="p">())</span>

    <span class="c1"># ì˜ˆì‹œ 3: íŒŒì¼ Save
</span>    <span class="n">dlg3</span> <span class="o">=</span> <span class="nc">CFileDialog</span><span class="p">(</span>
        <span class="n">start_path</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">(),</span>
        <span class="n">mode</span><span class="o">=</span><span class="sh">'</span><span class="s">save</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">select_mode</span><span class="o">=</span><span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">All Files (*)</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Python (*.py)</span><span class="sh">"</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">dlg3</span><span class="p">.</span><span class="nf">exec</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">SAVE FILE:</span><span class="sh">"</span><span class="p">,</span> <span class="n">dlg3</span><span class="p">.</span><span class="nf">selected_path</span><span class="p">())</span>

    <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="c1"># ë©€í‹°í”„ë¡œì„¸ì‹± ìŠ¤í° ëª¨ë“œ ì‚¬ìš© ì‹œ í•„ìš”í•˜ë‹¤ë©´ ì£¼ì„ í•´ì œ
</span>    <span class="c1"># from multiprocessing import set_start_method
</span>    <span class="c1"># set_start_method("spawn", force=True)
</span>    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>ë©”ëª¨</p>

<ul>
  <li>
    <p>ìë™ì™„ì„±ì€ ë³„ë„ í”„ë¡œì„¸ìŠ¤ì—ì„œ ëŒê³ , GUIëŠ” ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œë§Œ Qt ê°ì²´ë¥¼ ê±´ë“œë ¤ì„œ ì•ˆì „í•´.</p>
  </li>
  <li>
    <p>ë£¨íŠ¸ ê²½ë¡œì—ì„œ ì ‘ë‘ì‚¬ê°€ ì§§ì„ ë•ŒëŠ” íƒìƒ‰ì„ ìƒëµí•´ í­ì£¼ë¥¼ ë§‰ì•˜ê³ , <code class="language-plaintext highlighter-rouge">scandir()</code>ì— 80ms íƒ€ì„ë°•ìŠ¤ë¥¼ ê±¸ì–´ íƒ€ì ì¤‘ ì§€ì—°ì„ ì–µì œí–ˆì–´.</p>
  </li>
  <li>
    <p>ì´ì „ ìš”ì²­ì€ <code class="language-plaintext highlighter-rouge">cancel()</code>í•˜ê³  <code class="language-plaintext highlighter-rouge">seq</code>ë¡œ ìµœì‹ ì„±ë§Œ ë³´ì¥í•´ ê²°ê³¼ ë ˆì´ìŠ¤ë¥¼ ì œê±°í–ˆì–´.</p>
  </li>
  <li>
    <p>í•„ìš”í•˜ë©´ <code class="language-plaintext highlighter-rouge">time_budget_ms</code>ë‚˜ <code class="language-plaintext highlighter-rouge">depth_limit</code>ì„ ì¡°ì ˆí•´ì„œ ë„¤íŠ¸ì›Œí¬ ë“œë¼ì´ë¸Œì—ì„œ ë” ë³´ìˆ˜ì ìœ¼ë¡œ ë™ì‘í•˜ê²Œ ë§Œë“¤ ìˆ˜ ìˆì–´.</p>
  </li>
</ul>

<p>íŠ¹ì • OSë‚˜ ë„¤íŠ¸ì›Œí¬ ê³µìœ ì—ì„œ íŠœë‹ì´ ë” í•„ìš”í•˜ë©´, ë¬¸ì œ ì¬í˜„ ê²½ë¡œì™€ í•¨ê»˜ ì•Œë ¤ì¤˜. íƒ€ì„ë°•ìŠ¤Â·ê¹Šì´Â·ë£¨íŠ¸ ê·œì¹™ì„ ë¯¸ì„¸ì¡°ì •í•œ íŒ¨ì¹˜ë¥¼ ë°”ë¡œ ë§Œë“¤ì–´ì¤„ê²Œ.</p>]]></content><author><name>hvppyarchive</name></author><category term="python" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">ì›¹ í•œê¸€ í‚¤ë³´ë“œ ì¶”ê°€</title><link href="https://hvppyarchive.github.io/misc/web-korean-keyboard/" rel="alternate" type="text/html" title="ì›¹ í•œê¸€ í‚¤ë³´ë“œ ì¶”ê°€" /><published>2025-11-07T20:48:31+09:00</published><updated>2025-11-07T20:48:31+09:00</updated><id>https://hvppyarchive.github.io/misc/web-korean-keyboard</id><content type="html" xml:base="https://hvppyarchive.github.io/misc/web-korean-keyboard/"><![CDATA[<p class="chat--user">

&lt;!DOCTYPE HTML&gt; &lt;html&gt; &lt;head&gt; <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <meta http-equiv="X-UA-Compatible" content="IE=edge" /> <link href="kbd.css" rel="stylesheet" type="text/css" /> <script src="kbd.js"></script> <script> var controller, visible = true; function onPageLoaded() { var input = document.getElementById('t1'); controller = new i18n.input.keyboard.Keyboard(); controller.loadLayout('vi_telex'); controller.loadLayout('vi_vni'); controller.loadLayout('deva_phone'); controller.loadLayout('gu_phone'); controller.loadLayout('ar'); controller.loadLayout('he'); controller.loadLayout('ps'); controller.loadLayout('ur'); controller.loadLayout('fa'); controller.loadLayout('ko'); controller.loadLayout('bg_phone'); controller.loadLayout('yi'); controller.loadLayout('fr'); controller.loadLayout('ml_phone'); controller.loadLayout('kn_phone'); controller.loadLayout('sa_phone'); controller.loadLayout('ca'); controller.loadLayout('th_pattajoti'); controller.loadLayout('th_tis'); controller.loadLayout('ta_typewriter'); controller.loadLayout('ta_itrans'); controller.loadLayout('ne_inscript'); controller.loadLayout('ne_phone'); controller.loadLayout('us_intl'); controller.loadLayout('ethi'); controller.loadLayout('nv'); controller.reposition(input, 5, 4, [5, 0, 0, 0]); controller.activateLayout('ne_inscript'); controller.register(input); controller.addEventListener( 'kc', function() { visible = false; }); input.focus(); } function onLayoutSelected(layoutCode) { controller.activateLayout(layoutCode); document.getElementById('t1').focus(); } function toggle() { if (controller) { controller.setVisible(visible = !visible); } } </script> &lt;/head&gt; &lt;body onload='onPageLoaded()'&gt; <select onchange="onLayoutSelected(this.value)"> <option value="vi_vni">vi_vni</option> <option value="ml_phone">ml_phone</option> <option value="vi_telex">vi_telex</option> <option value="deva_phone">deva_phone</option> <option value="gu_phone">gu_phone</option> <option value="ar">ar</option> <option value="he">he</option> <option value="ps">ps</option> <option value="ur">ur</option> <option value="fa">fa</option> <option value="ko">ko</option> <option value="yi">yi</option> <option value="bg_phone">bg_phone</option> <option value="fr">fr</option> <option value="kn_phone">kn_phone</option> <option value="sa_phone">sa_phone</option> <option value="ca">ca</option> <option value="th_pattajoti">th_pattajoti</option> <option value="th_tis">th_tis</option> <option value="ta_typewriter">ta_typewriter</option> <option value="ta_itrans">ta_itrans</option> <option value="ne_inscript" selected="">ne_inscript</option> <option value="ne_phone">ne_phone</option> <option value="us_intl">us_intl</option> <option value="ethi">ethi</option> <option value="nv">nv</option> </select> <input type="input" id="t1" style="width: 400px" /> <input type="button" value="Toggle show/hide" onclick="javascript:toggle()" /> <br /> &lt;/body&gt; &lt;/html&gt; ì´ ì½”ë“œ í•´ì„ ì¢€

</p>

<p>ì•„ë˜ HTML/JSëŠ” â€œê°€ìƒ í‚¤ë³´ë“œ ìœ„ì ¯â€ì„ íŠ¹ì • ì…ë ¥ì°½ì— ë¶™ì—¬ì„œ ì—¬ëŸ¬ ì–¸ì–´ ë ˆì´ì•„ì›ƒ ê°„ ì „í™˜ì„ ì§€ì›í•˜ëŠ” ì˜ˆì œì˜ˆìš”. í•µì‹¬ì€ kbd.jsì— ë“¤ì–´ìˆëŠ” i18n.input.keyboard.Keyboard í´ë˜ìŠ¤ë¥¼ ì¨ì„œ í‚¤ë³´ë“œ íŒì—…ì„ ë„ìš°ê³ , <select>ë¡œ ë ˆì´ì•„ì›ƒì„ ë°”ê¾¸ëŠ” êµ¬ì¡°ì…ë‹ˆë‹¤.</select></p>

<h1 id="í•œ-ì¤„-ìš”ì•½">í•œ ì¤„ ìš”ì•½</h1>

<p>í˜ì´ì§€ê°€ ë¡œë“œë˜ë©´ ê°€ìƒ í‚¤ë³´ë“œë¥¼ ë§Œë“¤ê³  ë‹¤ì–‘í•œ ì–¸ì–´ ë ˆì´ì•„ì›ƒì„ ë¯¸ë¦¬ ë¡œë“œí•œ ë’¤, ì…ë ¥ì°½(#t1)ì— ë¶™ì…ë‹ˆë‹¤. ë“œë¡­ë‹¤ìš´ìœ¼ë¡œ ë ˆì´ì•„ì›ƒì„ ë°”ê¾¸ê³ , ë²„íŠ¼ìœ¼ë¡œ í‚¤ë³´ë“œ í‘œì‹œ/ìˆ¨ê¹€ì„ ì „í™˜í•©ë‹ˆë‹¤.</p>

<h1 id="êµ¬ì„±-ìš”ì†Œë³„-í•´ì„¤">êµ¬ì„± ìš”ì†Œë³„ í•´ì„¤</h1>

<h2 id="1-head-ì„¤ì •">1) <code class="language-plaintext highlighter-rouge">&lt;head&gt;</code> ì„¤ì •</h2>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">meta</code> íƒœê·¸: UTF-8 ì¸ì½”ë”©, IEì—ì„œ ìµœì‹  ë Œë”ë§ ëª¨ë“œ ì‚¬ìš©.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">link href="kbd.css"</code>: ê°€ìƒ í‚¤ë³´ë“œ UI ìŠ¤íƒ€ì¼.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">script src='kbd.js'</code>: í‚¤ë³´ë“œ ì—”ì§„ì´ ë“¤ì–´ìˆëŠ” ìŠ¤í¬ë¦½íŠ¸. ì—¬ê¸°ì„œ <code class="language-plaintext highlighter-rouge">i18n.input.keyboard.Keyboard</code> í´ë˜ìŠ¤ì™€ ë ˆì´ì•„ì›ƒ ì½”ë“œë“¤ì´ ì œê³µë©ë‹ˆë‹¤.</p>
  </li>
</ul>

<h2 id="2-ì „ì—­-ë³€ìˆ˜">2) ì „ì—­ ë³€ìˆ˜</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

var controller, visible = true;
</code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">controller</code>: í‚¤ë³´ë“œ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë‹´ì„ ë³€ìˆ˜.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">visible</code>: í‚¤ë³´ë“œ í‘œì‹œ ìƒíƒœ. í† ê¸€ ë²„íŠ¼ê³¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì—ì„œ ì“¸ í”Œë˜ê·¸.</p>
  </li>
</ul>

<h2 id="3-onpageloaded-í˜ì´ì§€-ë¡œë“œ-ì‹œ-ì´ˆê¸°í™”">3) <code class="language-plaintext highlighter-rouge">onPageLoaded()</code>: í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”</h2>

<p>íë¦„ì„ ë‹¨ê³„ë³„ë¡œ ë³´ë©´ ì´ë ‡ìŠµë‹ˆë‹¤.</p>

<ol>
  <li>ëŒ€ìƒ ì…ë ¥ì°½ ì°¾ê¸°</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

var input = document.getElementById('t1');
</code></pre></div></div>

<ol>
  <li>í‚¤ë³´ë“œ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

controller = new i18n.input.keyboard.Keyboard();
</code></pre></div></div>

<ol>
  <li>ì‚¬ìš©í•  ë ˆì´ì•„ì›ƒë“¤ ë¯¸ë¦¬ ë¡œë“œ</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

controller.loadLayout('vi_telex');
// ... ì—¬ëŸ¬ ë²ˆ í˜¸ì¶œ ...
controller.loadLayout('nv');
</code></pre></div></div>

<p>ì—¬ê¸°ì„œ â€˜vi_telexâ€™, â€˜koâ€™, â€˜arâ€™ ê°™ì€ ë¬¸ìì—´ì€ ê° ì–¸ì–´/ìíŒ ì´ë¦„ì…ë‹ˆë‹¤. í•„ìš”í•œ ë ˆì´ì•„ì›ƒë§Œ ê³¨ë¼ì„œ ë¡œë“œí•´ë„ ë©ë‹ˆë‹¤.</p>

<ol>
  <li>í‚¤ë³´ë“œ ìœ„ì¹˜ ì§€ì •</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

controller.reposition(input, 5, 4, [5, 0, 0, 0]);
</code></pre></div></div>

<ul>
  <li>ëŒ€ìƒ <code class="language-plaintext highlighter-rouge">input</code> ì£¼ë³€ì— ê°€ìƒ í‚¤ë³´ë“œê°€ ì–´ë””ì— ëœ°ì§€ ì •í•©ë‹ˆë‹¤. ì¸ìˆ˜ ì˜ë¯¸ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ êµ¬í˜„ì— ë”°ë¼ ë‹¤ë¥´ì§€ë§Œ, ë³´í†µ ê¸°ì¤€ ìš”ì†Œ, ì˜¤í”„ì…‹, ì—¬ë°± ê°™ì€ ì¢Œí‘œ íŒŒë¼ë¯¸í„°ì…ë‹ˆë‹¤.</li>
</ul>

<ol>
  <li>ê¸°ë³¸ í™œì„± ë ˆì´ì•„ì›ƒ ì„¤ì •</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

controller.activateLayout('ne_inscript');
</code></pre></div></div>

<ul>
  <li>ì´ˆê¸°ê°’ìœ¼ë¡œ ë„¤íŒ”ì–´ ì¸ìŠ¤í¬ë¦½íŠ¸ ìíŒì„ ì„ íƒ.</li>
</ul>

<ol>
  <li>ì…ë ¥ì°½ì— í‚¤ë³´ë“œ ì—°ê²°</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

controller.register(input);
</code></pre></div></div>

<ul>
  <li>ì´ ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤ê°€ ì˜¤ë©´ í‚¤ë³´ë“œë¥¼ ë¶™ì—¬ì„œ ì…ë ¥ ì´ë²¤íŠ¸ë¥¼ ê°€ë¡œì±„ê³ , ê°€ìƒ í‚¤ ì…ë ¥ì„ ë„£ì–´ì¤ë‹ˆë‹¤.</li>
</ul>

<ol>
  <li>íŠ¹ì • ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

controller.addEventListener('kc', function() { visible = false; });
</code></pre></div></div>

<ul>
  <li>â€˜kcâ€™ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ìª½ ì´ë²¤íŠ¸(ì•„ë§ˆ key commit/keypress ì™„ë£Œ ê°™ì€ ì˜ë¯¸)ë¡œ ë³´ì…ë‹ˆë‹¤. ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ <code class="language-plaintext highlighter-rouge">visible</code>ì„ falseë¡œ ë°”ê¿”ìš”. ë‹¨, ì‹¤ì œë¡œ í™”ë©´ì„ ìˆ¨ê¸°ì§€ëŠ” ì•Šê³  í”Œë˜ê·¸ë§Œ ë°”ê¿‰ë‹ˆë‹¤. ìˆ¨ê¹€ ì²˜ë¦¬ëŠ” <code class="language-plaintext highlighter-rouge">toggle()</code>ì—ì„œ <code class="language-plaintext highlighter-rouge">controller.setVisible(visible)</code>ì„ í˜¸ì¶œí•  ë•Œ ë°˜ì˜ë©ë‹ˆë‹¤.</li>
</ul>

<ol>
  <li>ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

input.focus();
</code></pre></div></div>

<h2 id="4-onlayoutselectedlayoutcode-ë“œë¡­ë‹¤ìš´ìœ¼ë¡œ-ë ˆì´ì•„ì›ƒ-ë³€ê²½">4) <code class="language-plaintext highlighter-rouge">onLayoutSelected(layoutCode)</code>: ë“œë¡­ë‹¤ìš´ìœ¼ë¡œ ë ˆì´ì•„ì›ƒ ë³€ê²½</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

controller.activateLayout(layoutCode);
document.getElementById('t1').focus();
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">&lt;select&gt;</code>ì—ì„œ ì„ íƒëœ ê°’(ë ˆì´ì•„ì›ƒ ì½”ë“œ)ì„ ë°›ì•„ì„œ ì¦‰ì‹œ ì „í™˜í•˜ê³ , ë‹¤ì‹œ ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤ë¥¼ ì¤ë‹ˆë‹¤.</li>
</ul>

<h2 id="5-toggle-í‘œì‹œìˆ¨ê¹€-ì „í™˜">5) <code class="language-plaintext highlighter-rouge">toggle()</code>: í‘œì‹œ/ìˆ¨ê¹€ ì „í™˜</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

if (controller) {
  controller.setVisible(visible = !visible);
}
</code></pre></div></div>

<ul>
  <li>ì „ì—­ í”Œë˜ê·¸ë¥¼ ë’¤ì§‘ê³ , ì‹¤ì œ í‚¤ë³´ë“œ UIë¥¼ ë³´ì—¬ì£¼ê±°ë‚˜ ê°ì¶¥ë‹ˆë‹¤.</li>
</ul>

<h2 id="6-body-ui-ìš”ì†Œë“¤">6) <code class="language-plaintext highlighter-rouge">&lt;body&gt;</code>: UI ìš”ì†Œë“¤</h2>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">onload='onPageLoaded()'</code>: í˜ì´ì§€ ë¡œë“œ í›„ ì´ˆê¸°í™” ì‹¤í–‰.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">&lt;select onchange='onLayoutSelected(this.value)'&gt;</code>: ë ˆì´ì•„ì›ƒ ëª©ë¡. ì˜µì…˜ valueê°€ ê³§ ë ˆì´ì•„ì›ƒ ì½”ë“œì…ë‹ˆë‹¤. ê¸°ë³¸ ì„ íƒì€ <code class="language-plaintext highlighter-rouge">ne_inscript</code>.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">&lt;input id='t1'&gt;</code>: ì‹¤ì œë¡œ íƒ€ì´í•‘í•  ì…ë ¥ì°½.</p>
  </li>
  <li>
    <p>â€œToggle show/hideâ€ ë²„íŠ¼: ê°€ìƒ í‚¤ë³´ë“œ í‘œì‹œ/ìˆ¨ê¹€ ì „í™˜.</p>
  </li>
</ul>

<h1 id="ëˆˆì—-ë„ëŠ”-í¬ì¸íŠ¸ì™€-ê°œì„ -íŒ">ëˆˆì— ë„ëŠ” í¬ì¸íŠ¸ì™€ ê°œì„  íŒ</h1>

<ol>
  <li><code class="language-plaintext highlighter-rouge">input</code>ì˜ type ì†ì„±<br />
í˜„ì¬ <code class="language-plaintext highlighter-rouge">type='input'</code>ì¸ë°, í‘œì¤€ ê°’ì€ <code class="language-plaintext highlighter-rouge">type='text'</code>ê°€ ë§ìŠµë‹ˆë‹¤.</li>
</ol>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">id=</span><span class="s">"t1"</span> <span class="na">style=</span><span class="s">"width: 400px"</span><span class="nt">&gt;</span>
</code></pre></div></div>

<ol>
  <li>ë¶ˆí•„ìš”í•˜ê±°ë‚˜ ë¶ˆëª…í™•í•œ ì´ë²¤íŠ¸ ì²˜ë¦¬<br />
<code class="language-plaintext highlighter-rouge">'kc'</code> ì´ë²¤íŠ¸ì—ì„œ <code class="language-plaintext highlighter-rouge">visible = false;</code>ë§Œ í•˜ê³  ì‹¤ì œ ìˆ¨ê¹€ì€ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í‚¤ ì…ë ¥ í›„ ìë™ìœ¼ë¡œ í‚¤ë³´ë“œë¥¼ ìˆ¨ê¸°ê³  ì‹¶ë‹¤ë©´ <code class="language-plaintext highlighter-rouge">setVisible(false)</code>ê¹Œì§€ í˜¸ì¶œí•´ì•¼ ì˜ë„ê°€ í™•ì‹¤í•´ì§‘ë‹ˆë‹¤.</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

controller.addEventListener('kc', function() {
  visible = false;
  controller.setVisible(false);
});
</code></pre></div></div>

<p>ë°˜ëŒ€ë¡œ ìˆ¨ê¸°ê³  ì‹¶ì§€ ì•Šë‹¤ë©´ ì´ ë¦¬ìŠ¤ë„ˆë¥¼ ì œê±°í•˜ì„¸ìš”.</p>

<ol>
  <li>ì´ˆê¸° í‘œì‹œ ìƒíƒœ ì¼ê´€ì„±<br />
ì´ˆê¸° <code class="language-plaintext highlighter-rouge">visible = true</code>ì§€ë§Œ ì‹¤ì œë¡œ í‚¤ë³´ë“œë¥¼ ë³´ì—¬ì£¼ëŠ” ì½”ë“œë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ë”°ë¼ <code class="language-plaintext highlighter-rouge">register()</code>ë§Œìœ¼ë¡œ ê¸°ë³¸ í‘œì‹œê°€ ë  ìˆ˜ë„, í¬ì»¤ìŠ¤ ë•Œë§Œ ëœ° ìˆ˜ë„ ìˆì–´ìš”. í•­ìƒ ë³´ì´ê²Œ í•˜ë ¤ë©´ ì´ˆê¸°í™” ëì— ì•„ë˜ë¥¼ í˜¸ì¶œí•´ ì¼ê´€ì„±ì„ ë³´ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

controller.setVisible(true);
</code></pre></div></div>

<ol>
  <li>ë ˆì´ì•„ì›ƒ ë¡œë”© ìµœì í™”<br />
ì§€ê¸ˆì€ ìƒë‹¹íˆ ë§ì€ ë ˆì´ì•„ì›ƒì„ ëª¨ë‘ ë¡œë“œí•©ë‹ˆë‹¤. ì‹¤ì œë¡œ í•„ìš”í•œ ê²ƒë§Œ <code class="language-plaintext highlighter-rouge">loadLayout</code> í•˜ê±°ë‚˜, ì„ íƒ ì‹œì ì— ì§€ì—° ë¡œë“œí•˜ë„ë¡ ë°”ê¾¸ë©´ ì´ˆê¸° ë¡œë”©ì´ ê°€ë²¼ì›Œì§‘ë‹ˆë‹¤. ì˜ˆ:</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

function onLayoutSelected(code) {
  if (!controller.isLayoutLoaded(code)) controller.loadLayout(code);
  controller.activateLayout(code);
  t1.focus();
}
</code></pre></div></div>

<p>(ë¼ì´ë¸ŒëŸ¬ë¦¬ì— <code class="language-plaintext highlighter-rouge">isLayoutLoaded</code> ê°™ì€ í—¬í¼ê°€ ì—†ë‹¤ë©´ ë‚´ë¶€ ìƒíƒœë¥¼ ì§ì ‘ ê´€ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.)</p>

<ol>
  <li>ì ‘ê·¼ì„± ë° i18n ë°°ë ¤</li>
</ol>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">&lt;label for="t1"&gt;</code>ë¥¼ ì¶”ê°€í•˜ê³ , ë“œë¡­ë‹¤ìš´ì—ë„ ë¼ë²¨ì„ ë¶™ì´ë©´ ìŠ¤í¬ë¦° ë¦¬ë” í˜¸í™˜ì„±ì´ ì¢‹ì•„ì§‘ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë ˆì´ì•„ì›ƒ ì½”ë“œ ëŒ€ì‹  ì‚¬ëŒ ì¹œí™”ì ì¸ ì´ë¦„(ì˜ˆ: â€œí•œêµ­ì–´(ë‘ë²Œì‹)â€)ì„ <code class="language-plaintext highlighter-rouge">&lt;option&gt;</code> í…ìŠ¤íŠ¸ì— ì‚¬ìš©í•˜ì„¸ìš”.</p>
  </li>
</ul>

<ol>
  <li>ìŠ¤íƒ€ì¼ ì¡°ì •<br />
ê°€ìƒ í‚¤ë³´ë“œê°€ í™”ë©´ì„ ê°€ë¦¬ë©´ <code class="language-plaintext highlighter-rouge">reposition(...)</code> ì¸ìë¥¼ ì¡°ì •í•˜ê±°ë‚˜, <code class="language-plaintext highlighter-rouge">kbd.css</code>ì—ì„œ z-index/positionì„ ì†ë´ ë°°ì¹˜ í’ˆì§ˆì„ ì˜¬ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ol>

<h1 id="ë™ì‘-ìˆœì„œ-ì •ë¦¬">ë™ì‘ ìˆœì„œ ì •ë¦¬</h1>

<ol>
  <li>
    <p>í˜ì´ì§€ ë¡œë“œ â†’ <code class="language-plaintext highlighter-rouge">onPageLoaded()</code> ì‹¤í–‰.</p>
  </li>
  <li>
    <p>í‚¤ë³´ë“œ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± â†’ ì—¬ëŸ¬ ë ˆì´ì•„ì›ƒ ë¡œë“œ â†’ ì…ë ¥ì°½ì— ë¶€ì°© â†’ ê¸°ë³¸ ë ˆì´ì•„ì›ƒ í™œì„±.</p>
  </li>
  <li>
    <p>ë“œë¡­ë‹¤ìš´ ì„ íƒ ì‹œ <code class="language-plaintext highlighter-rouge">onLayoutSelected()</code>ë¡œ ë ˆì´ì•„ì›ƒ ì „í™˜.</p>
  </li>
  <li>
    <p>â€œToggle show/hideâ€ ë²„íŠ¼ìœ¼ë¡œ í‚¤ë³´ë“œ í‘œì‹œ/ìˆ¨ê¹€ ì „í™˜.</p>
  </li>
</ol>

<p>í•„ìš”í•˜ë©´ ì´ ì½”ë“œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê¸°ë³¸ ë ˆì´ì•„ì›ƒì„ í•œêµ­ì–´(<code class="language-plaintext highlighter-rouge">'ko'</code>)ë¡œ ë°”ê¾¸ê±°ë‚˜, ì²˜ìŒë¶€í„° ìˆ¨ê¹€ìœ¼ë¡œ ì‹œì‘í•˜ë„ë¡ ì„¸íŒ…í•˜ëŠ” ë³€í˜• ì˜ˆì‹œë„ ë°”ë¡œ ë§Œë“¤ì–´ ë“œë¦´ ìˆ˜ ìˆì–´ìš”.</p>

<p class="chat--user">

ê°€ìƒ í‚¤ë³´ë“œ ì—†ì´ ì…ë ¥ì„ í–ˆì„ë•Œ í•œê¸€ë¡œ ì…ë ¥ë˜ê²Œ í•  ìˆœ ì—†ë‚˜

</p>

<p>ì§§ê²Œ ê²°ë¡ ë¶€í„° ë§í•˜ë©´, ë¸Œë¼ìš°ì €ë§Œìœ¼ë¡œ ì‚¬ìš©ìì˜ <strong>ì…ë ¥ê¸°(IME)</strong>ë¥¼ í•œê¸€ë¡œ ì „í™˜ì‹œí‚¬ ìˆ˜ëŠ” ì—†ì–´ìš”. <code class="language-plaintext highlighter-rouge">lang="ko"</code>ë‚˜ <code class="language-plaintext highlighter-rouge">inputmode</code> ê°™ì€ HTML ì†ì„±ë„ IMEë¥¼ ë°”ê¾¸ì§€ ì•ŠìŠµë‹ˆë‹¤. ì¦‰, ê°€ìƒ í‚¤ë³´ë“œ ì—†ì´ ê³§ì¥ í•œê¸€ì´ ì°íˆê²Œ í•˜ë ¤ë©´ ì„ íƒì§€ëŠ” ì„¸ ê°€ì§€ì˜ˆìš”.</p>

<h2 id="ê°€ëŠ¥í•œ-ë°©ë²•">ê°€ëŠ¥í•œ ë°©ë²•</h2>

<ol>
  <li>
    <p>ìš´ì˜ì²´ì œ/ë¸Œë¼ìš°ì € IME ì‚¬ìš©<br />
ì‚¬ìš©ìê°€ OSì—ì„œ í•œê¸€ ì…ë ¥ê¸°ë¥¼ ì¼œë„ë¡ ì•ˆë‚´í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤. ê°€ì¥ ì•ˆì •ì ì´ê³  í‘œì¤€ì ì´ì§€ë§Œ, ì½”ë“œë§Œìœ¼ë¡œ ê°•ì œí•  ìˆ˜ëŠ” ì—†ìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>â€œë³´ì´ì§€ ì•ŠëŠ”â€ JS ì…ë ¥ê¸°(ìë™ ë³€í™˜)<br />
ê°€ìƒ í‚¤ë³´ë“œ UIëŠ” ì—†ì§€ë§Œ, ìë°”ìŠ¤í¬ë¦½íŠ¸ê°€ í‚¤ ì…ë ¥ì„ ê°€ë¡œì±„ì„œ ì˜ë¬¸ í‚¤ë¥¼ <strong>í•œê¸€ ìëª¨ë¡œ ë§¤í•‘</strong> í•˜ê³ , <strong>ìë™ í•©ì„±(ì´ˆ/ì¤‘/ì¢…ì„± ì¡°í•©)</strong> í•´ì„œ ì¸í’‹ì— ë„£ëŠ” ë°©ì‹ì…ë‹ˆë‹¤. ì‚¬ìš©ìëŠ” í‰ì†Œì²˜ëŸ¼ íƒ€ì´í•‘í•˜ì§€ë§Œ ê²°ê³¼ëŠ” í•œê¸€ë¡œ ë“¤ì–´ê°‘ë‹ˆë‹¤.<br />
í•µì‹¬ì€ ë‘ ë‹¨ê³„:</p>
  </li>
</ol>

<ul>
  <li>
    <p>í‚¤ ë§¤í•‘: ì˜ˆ) 2ë²Œì‹ ê¸°ì¤€ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">r â†’ ã„±</code>, <code class="language-plaintext highlighter-rouge">k â†’ ã…</code>, <code class="language-plaintext highlighter-rouge">s â†’ ã„´</code> â€¦</p>
  </li>
  <li>
    <p>í•©ì„±: ë“¤ì–´ì˜¨ ìëª¨ë“¤ì„ ì´ˆì„±/ì¤‘ì„±/ì¢…ì„± ê·œì¹™ì— ë§ì¶° ìœ ë‹ˆì½”ë“œ í•œê¸€ ìŒì ˆë¡œ ì¡°í•©</p>
  </li>
</ul>

<p>ì™„ì „í•œ í•©ì„± ë¡œì§ì„ ì§ì ‘ êµ¬í˜„í•˜ë ¤ë©´ ê½¤ ê¸¸ì–´ì§‘ë‹ˆë‹¤. ë³´í†µì€ <strong>Hangul ì¡°í•© ë¼ì´ë¸ŒëŸ¬ë¦¬</strong>(ì˜ˆ: <code class="language-plaintext highlighter-rouge">Hangul.assemble()</code> ê°™ì€ API ì œê³µ)ë¥¼ ì¨ì„œ ìëª¨ ë°°ì—´ì„ ìŒì ˆë¡œ í•©ì¹©ë‹ˆë‹¤.</p>

<p>ì•„ë˜ëŠ” â€œUI ì—†ëŠ” í•œê¸€ ì…ë ¥ê¸°â€ì˜ ìµœì†Œ ì˜ˆì‹œ íë¦„ì…ë‹ˆë‹¤. ì‹¤ì œ ì„œë¹„ìŠ¤ìš©ì´ë¼ë©´ ìëª¨/í•©ì„± ê·œì¹™ì„ ëª¨ë‘ ë³´ê°•í•´ì•¼ í•©ë‹ˆë‹¤.</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"t1"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">style=</span><span class="s">"width:400px"</span><span class="nt">&gt;</span>

<span class="nt">&lt;script&gt;</span>
  <span class="c1">// 2ë²Œì‹ í‚¤â†’ìëª¨(ë°ëª¨ìš©: ì¼ë¶€ë§Œ ìˆ˜ë¡)</span>
  <span class="kd">const</span> <span class="nx">keyToJamo</span> <span class="o">=</span> <span class="p">{</span>
    <span class="dl">'</span><span class="s1">r</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ã„±</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">s</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ã„´</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">e</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ã„·</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">f</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ã„¹</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">a</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ã…</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">q</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ã…‚</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">t</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ã……</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">d</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ã…‡</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">w</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ã…ˆ</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">c</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ã…Š</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">z</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ã…‹</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">x</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ã…Œ</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">v</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ã…</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">g</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ã…</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">k</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ã…</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">o</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ã…</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">i</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ã…‘</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">j</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ã…“</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">p</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ã…”</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">u</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ã…•</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">h</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ã…—</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">y</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ã…›</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">n</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ã…œ</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">b</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ã… </span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">m</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ã…¡</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">l</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">ã…£</span><span class="dl">'</span>
  <span class="p">};</span>

  <span class="c1">// ê°„ë‹¨ í•©ì„±ê¸°: ìëª¨ê°€ ëŠ˜ì–´ë‚  ë•Œë§ˆë‹¤ ìŒì ˆë¡œ ì¡°ë¦½</span>
  <span class="c1">// ì‹¤ì „ìš©ì€ ì´ˆ/ì¤‘/ì¢…ì„± ìƒíƒœë¨¸ì‹ ê³¼ ë³µí•©ëª¨ìŒ/ê²¹ë°›ì¹¨ ì²˜ë¦¬ í•„ìš”</span>
  <span class="kd">function</span> <span class="nf">assembleHangul</span><span class="p">(</span><span class="nx">jamoArray</span><span class="p">){</span>
    <span class="c1">// ì˜ˆì‹œ: Hangul.js ê°™ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ìˆìœ¼ë©´ Hangul.assemble(jamoArray) ì‚¬ìš©</span>
    <span class="c1">// ì—¬ê¸°ì„œëŠ” ì´ˆê°„ë‹¨(ë¶ˆì™„ì „) í•©ì„±ê¸°ë¡œ ëŒ€ì²´: ìëª¨ë¥¼ ê·¸ëƒ¥ ì´ì–´ ë¶™ì„</span>
    <span class="c1">// â†’ ì‹¤ì œ í”„ë¡œì íŠ¸ì—ì„œëŠ” ë°˜ë“œì‹œ ì •ì‹ í•©ì„± ë¡œì§/ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì“°ì„¸ìš”!</span>
    <span class="k">return</span> <span class="nx">jamoArray</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="dl">''</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">input</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">t1</span><span class="dl">'</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="p">[];</span>    <span class="c1">// ìëª¨ ë²„í¼</span>
  <span class="kd">let</span> <span class="nx">composing</span> <span class="o">=</span> <span class="dl">''</span><span class="p">;</span> <span class="c1">// í˜„ì¬ í•©ì„± ê²°ê³¼</span>

  <span class="nx">input</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">keydown</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ì¡°í•© ì¤‘ì— ì¼ë°˜ ë™ì‘ ë§‰ê³  ìš°ë¦¬ê°€ ë„£ëŠ”ë‹¤</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">ctrlKey</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">metaKey</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">altKey</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span> <span class="c1">// ë‹¨ì¶•í‚¤ëŠ” í†µê³¼</span>
    <span class="kd">const</span> <span class="nx">k</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">key</span><span class="p">;</span>
    <span class="c1">// ë°±ìŠ¤í˜ì´ìŠ¤ ì²˜ë¦¬(ë²„í¼ì—ì„œ ìëª¨ í•˜ë‚˜ ì œê±°)</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">k</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">Backspace</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if </span><span class="p">(</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">e</span><span class="p">.</span><span class="nf">preventDefault</span><span class="p">();</span>
        <span class="nx">buffer</span><span class="p">.</span><span class="nf">pop</span><span class="p">();</span>
        <span class="nx">composing</span> <span class="o">=</span> <span class="nf">assembleHangul</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
        <span class="nf">replaceTail</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">composing</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// ì—”í„°/íƒ­/ë°©í–¥í‚¤ ë“±ì€ í†µê³¼</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">k</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="kd">const</span> <span class="nx">jamo</span> <span class="o">=</span> <span class="nx">keyToJamo</span><span class="p">[</span><span class="nx">k</span><span class="p">];</span>
    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">jamo</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span> <span class="c1">// ë§¤í•‘ ì—†ëŠ” í‚¤ëŠ” í†µê³¼(ì˜ë¬¸ ê·¸ëŒ€ë¡œ ì¹˜ê³  ì‹¶ë‹¤ë©´ ì—¬ê¸°ì„œ return í•˜ì§€ ë§ê³  í—ˆìš©)</span>

    <span class="nx">e</span><span class="p">.</span><span class="nf">preventDefault</span><span class="p">();</span>
    <span class="nx">buffer</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">jamo</span><span class="p">);</span>
    <span class="nx">composing</span> <span class="o">=</span> <span class="nf">assembleHangul</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
    <span class="nf">replaceTail</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">composing</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="c1">// ì»¤ì„œ ìœ„ì¹˜ì˜ â€œìµœê·¼ ì¡°í•© ë¬¸ìì—´â€ì„ ì¹˜í™˜(ë°ëª¨: ì…ë ¥ ì „ì²´ë¥¼ ë®ì–´ì“°ê¸°)</span>
  <span class="kd">function</span> <span class="nf">replaceTail</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">text</span><span class="p">){</span>
    <span class="c1">// ê°„ë‹¨í™”ë¥¼ ìœ„í•´ ì…ë ¥ ì „ì²´ë¥¼ ì¡°í•© ê²°ê³¼ë¡œ ì¹˜í™˜(ì‹¤ì „: selectionStart/Endë¡œ ë¶€ë¶„ ì¹˜í™˜)</span>
    <span class="nx">el</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">text</span><span class="p">;</span>
  <span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<p>ì£¼ì˜ì‚¬í•­</p>

<ul>
  <li>
    <p>ìœ„ ì½”ë“œëŠ” <strong>í•©ì„± ë¡œì§ì„ ê±°ì˜ ìƒëµ</strong> í•œ ë°ëª¨ë¼ì„œ â€œê°ì‚¬â€ ê°™ì€ ìŒì ˆ ì¡°í•©ì´ ì œëŒ€ë¡œ ì•ˆ ë©ë‹ˆë‹¤. ë°˜ë“œì‹œ <strong>ì •ì‹ í•©ì„±ê¸°</strong> ë¥¼ ë¶™ì´ì„¸ìš”. (ìœ ë‹ˆì½”ë“œ í•œê¸€ì€ <code class="language-plaintext highlighter-rouge">AC00</code>ë¶€í„° ì´ˆÂ·ì¤‘Â·ì¢…ì„±ì„ ìˆ˜ì‹ìœ¼ë¡œ ì¡°í•©í•©ë‹ˆë‹¤.)</p>
  </li>
  <li>
    <p>ì˜ë¬¸ì„ ê·¸ëŒ€ë¡œë„ ì…ë ¥í•´ì•¼ í•œë‹¤ë©´, ë§¤í•‘ë˜ì§€ ì•Šì€ í‚¤ëŠ” <code class="language-plaintext highlighter-rouge">preventDefault</code> í•˜ì§€ ì•Šê³  ì›ë˜ëŒ€ë¡œ í†µê³¼ì‹œí‚¤ë©´ ë©ë‹ˆë‹¤. ë°˜ëŒ€ë¡œ â€œë¬´ì¡°ê±´ í•œê¸€ë§Œâ€ì´ë©´ ëª¨ë“  ì•ŒíŒŒë²³ì„ ê°€ë¡œì±„ì„¸ìš”.</p>
  </li>
  <li>
    <p>ëª¨ë°”ì¼ì—ì„œëŠ” ì†Œí”„íŠ¸ í‚¤ë³´ë“œ/ìë™ êµì •ê³¼ ì¶©ëŒí•  ìˆ˜ ìˆì–´ <code class="language-plaintext highlighter-rouge">inputmode</code>ì™€ ì´ë²¤íŠ¸ ì²˜ë¦¬ë¥¼ ê¼¼ê¼¼íˆ í…ŒìŠ¤íŠ¸í•´ì•¼ í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>contenteditable ì˜ì—­ì—ì„œë„ <code class="language-plaintext highlighter-rouge">beforeinput</code>/<code class="language-plaintext highlighter-rouge">input</code> ì´ë²¤íŠ¸ë¥¼ ì“°ë©´ ë¹„ìŠ·í•œ ë°©ì‹ìœ¼ë¡œ êµ¬í˜„ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
  </li>
</ul>

<ol>
  <li>ì‚¬í›„ ë³€í™˜(ì‚¬ìš©ìëŠ” ì˜ë¬¸ ë¡œë§ˆì ì…ë ¥ â†’ ì œì¶œ ì‹œ ì„œë²„/í´ë¼ì´ì–¸íŠ¸ì—ì„œ í•œê¸€ë¡œ ë³€í™˜)<br />
ì‹¤ì‹œê°„ ì¡°í•©ì´ ë¶€ë‹´ìŠ¤ëŸ¬ìš°ë©´ ì´ ë°©ì‹ì´ ë‹¨ìˆœí•©ë‹ˆë‹¤. ì œì¶œ ì§ì „ì— ì˜ë¬¸ì„ í•œê¸€ë¡œ ë°”ê¾¸ëŠ” ë²„íŠ¼/ì˜µì…˜ì„ ë‘ëŠ” ì‹ì´ì£ .</li>
</ol>

<h2 id="ì •ë¦¬">ì •ë¦¬</h2>

<ul>
  <li>
    <p>ë¸Œë¼ìš°ì €ê°€ IMEë¥¼ ë°”ê¿”ì£¼ì§€ëŠ” ëª»í•œë‹¤.</p>
  </li>
  <li>
    <p>UI ì—†ëŠ” <strong>JS ì…ë ¥ê¸°(ìëª¨ ë§¤í•‘ + í•©ì„±)</strong> ë¡œ â€œê°€ìƒ í‚¤ë³´ë“œ ì—†ì´ë„ í•œê¸€ì²˜ëŸ¼â€ ì…ë ¥ë˜ê²Œ ë§Œë“œëŠ” ê±´ ê°€ëŠ¥í•˜ë‹¤.</p>
  </li>
  <li>
    <p>ì‹¤ì œë¡œ ì“°ë ¤ë©´ í‘œì¤€ 2ë²Œì‹ ì „ì²´ ë§¤í•‘, ê²¹ëª¨ìŒ/ê²¹ë°›ì¹¨, ë˜ëŒë¦¬ê¸°(Backspace) ì²˜ë¦¬, ì»¤ì„œ ìœ„ì¹˜ ì¹˜í™˜ ë“±ì„ ê°–ì¶˜ <strong>ì™„ì„±ëœ í•©ì„±ê¸°</strong> ê°€ í•„ìš”í•˜ë‹¤.</p>
  </li>
</ul>

<p>ì›í•˜ì‹œë©´ ìœ„ ë°ëª¨ë¥¼ ê¸°ë°˜ìœ¼ë¡œ 2ë²Œì‹ ì „ì²´ ë§¤í•‘ê³¼ ì •ì‹ í•©ì„± ë¡œì§ê¹Œì§€ íƒ‘ì¬í•œ ë²„ì „ì„ ë°”ë¡œ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

ë‚´ê°€ ì¤€ ì†ŒìŠ¤ëŠ” ê·¸ëŸ° ê¸°ëŠ¥ì€ ì•„ë‹ˆì•¼?

</p>

<p>ê°€ëŠ¥í•´ìš”. ë„¤ê°€ ì¤€ ì½”ë“œëŠ” â€œê°€ìƒ í‚¤ë³´ë“œ UIâ€ë¥¼ ë„ìš°ëŠ” ê²Œ ê¸°ë³¸ì´ì§€ë§Œ, ì‹¤ì œë¡œëŠ” <strong>í‚¤ ì…ë ¥ì„ ê°€ë¡œì±„ì„œ ì„ íƒí•œ ë ˆì´ì•„ì›ƒ(ì˜ˆ: â€˜koâ€™)ëŒ€ë¡œ ë¬¸ìë¥¼ ë„£ëŠ” ì—”ì§„</strong> ì´ í•µì‹¬ì´ë¼ì„œ, UIë¥¼ <strong>ìˆ¨ê¸´ ì±„ë¡œ</strong> í•œê¸€ì´ ì…ë ¥ë˜ê²Œ ë§Œë“¤ ìˆ˜ ìˆì–´ìš”. ì¦‰, í˜ì´ì§€ ì•ˆì—ì„œë§Œ ë™ì‘í•˜ëŠ” â€œê°„ì´ IMEâ€ì²˜ëŸ¼ ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>ì •ë¦¬í•˜ìë©´</p>

<ul>
  <li>
    <p>OSì˜ í•œê¸€ IMEë¥¼ ì¼œì£¼ëŠ” ê±´ ì•„ë‹ˆì§€ë§Œ,</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">controller</code>ê°€ í™œì„±í™”ëœ ì…ë ¥ì°½ì—ì„œëŠ” ë¬¼ë¦¬ í‚¤ë³´ë“œ ì…ë ¥ì„ <strong>2ë²Œì‹ í•œê¸€ ì¡°í•©</strong> ìœ¼ë¡œ ë³€í™˜í•´ì„œ ë„£ì–´ì¤„ ìˆ˜ ìˆê³ ,</p>
  </li>
  <li>
    <p>ê°€ìƒ í‚¤ë³´ë“œ íŒ¨ë„ì€ <code class="language-plaintext highlighter-rouge">setVisible(false)</code>ë¡œ ê°ì¶°ë„ ë™ì‘í•©ë‹ˆë‹¤.</p>
  </li>
</ul>

<p>ì•„ë˜ì²˜ëŸ¼ ìµœì†Œ ìˆ˜ì •í•˜ë©´ ë©ë‹ˆë‹¤.</p>

<h3 id="í•µì‹¬-ìˆ˜ì •-í¬ì¸íŠ¸">í•µì‹¬ ìˆ˜ì • í¬ì¸íŠ¸</h3>

<ol>
  <li>
    <p>ê¸°ë³¸ ë ˆì´ì•„ì›ƒì„ í•œêµ­ì–´ë¡œ ë°”ê¾¸ê¸°</p>
  </li>
  <li>
    <p>ê°€ìƒ í‚¤ë³´ë“œ íŒ¨ë„ì„ ì‹œì‘ë¶€í„° ìˆ¨ê¸°ê¸°</p>
  </li>
  <li>
    <p>ë“œë¡­ë‹¤ìš´/í† ê¸€ì´ í•„ìš” ì—†ìœ¼ë©´ ì œê±°(ì„ íƒ ì‚¬í•­)</p>
  </li>
</ol>

<h3 id="ì˜ˆì‹œ-ìˆ˜ì •-ì½”ë“œ">ì˜ˆì‹œ ìˆ˜ì • ì½”ë“œ</h3>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE HTML&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"kbd.css"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">type=</span><span class="s">"text/css"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"kbd.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;script&gt;</span>
    <span class="kd">var</span> <span class="nx">controller</span><span class="p">;</span>

    <span class="kd">function</span> <span class="nf">onPageLoaded</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">input</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">t1</span><span class="dl">'</span><span class="p">);</span>

      <span class="nx">controller</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">i18n</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">keyboard</span><span class="p">.</span><span class="nc">Keyboard</span><span class="p">();</span>

      <span class="c1">// í•„ìš”í•œ ë ˆì´ì•„ì›ƒë§Œ ë‚¨ê²¨ë„ ë©ë‹ˆë‹¤.</span>
      <span class="nx">controller</span><span class="p">.</span><span class="nf">loadLayout</span><span class="p">(</span><span class="dl">'</span><span class="s1">ko</span><span class="dl">'</span><span class="p">);</span>          <span class="c1">// í•œêµ­ì–´</span>
      <span class="nx">controller</span><span class="p">.</span><span class="nf">loadLayout</span><span class="p">(</span><span class="dl">'</span><span class="s1">us_intl</span><span class="dl">'</span><span class="p">);</span>     <span class="c1">// í•„ìš” ì‹œ ì˜ë¬¸ êµ­ì œ ë°°ì—´ ë“±</span>

      <span class="nx">controller</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nx">input</span><span class="p">);</span>           <span class="c1">// ì…ë ¥ì°½ì— ì—°ê²°</span>
      <span class="nx">controller</span><span class="p">.</span><span class="nf">activateLayout</span><span class="p">(</span><span class="dl">'</span><span class="s1">ko</span><span class="dl">'</span><span class="p">);</span>      <span class="c1">// â˜… ê¸°ë³¸ í•œê¸€ ë ˆì´ì•„ì›ƒ ì„ íƒ</span>
      <span class="nx">controller</span><span class="p">.</span><span class="nf">reposition</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]);</span>

      <span class="nx">controller</span><span class="p">.</span><span class="nf">setVisible</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>         <span class="c1">// â˜… íŒ¨ë„ì€ ìˆ¨ê¸°ê³  ì—”ì§„ë§Œ ë™ì‘</span>
      <span class="c1">// ë¶ˆí•„ìš”: ì•„ë˜ ë¦¬ìŠ¤ë„ˆëŠ” íŒ¨ë„ í‘œì‹œ ìƒíƒœë§Œ ê±´ë“œë¦½ë‹ˆë‹¤.</span>
      <span class="c1">// controller.addEventListener('kc', function(){ ... });</span>

      <span class="nx">input</span><span class="p">.</span><span class="nf">focus</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// ë“œë¡­ë‹¤ìš´ìœ¼ë¡œ ë°”ê¾¸ê³  ì‹¶ë‹¤ë©´ ìœ ì§€</span>
    <span class="kd">function</span> <span class="nf">onLayoutSelected</span><span class="p">(</span><span class="nx">layoutCode</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">controller</span><span class="p">.</span><span class="nf">activateLayout</span><span class="p">(</span><span class="nx">layoutCode</span><span class="p">);</span>
      <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">t1</span><span class="dl">'</span><span class="p">).</span><span class="nf">focus</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body</span> <span class="na">onload=</span><span class="s">"onPageLoaded()"</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- ë“œë¡­ë‹¤ìš´ì„ ìœ ì§€í•˜ê³  ì‹¶ë‹¤ë©´ 'ko'ë¥¼ ê¸°ë³¸ ì„ íƒìœ¼ë¡œ --&gt;</span>
  <span class="nt">&lt;select</span> <span class="na">onchange=</span><span class="s">"onLayoutSelected(this.value)"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">"ko"</span> <span class="na">selected</span><span class="nt">&gt;</span>ko<span class="nt">&lt;/option&gt;</span>
    <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">"us_intl"</span><span class="nt">&gt;</span>us_intl<span class="nt">&lt;/option&gt;</span>
  <span class="nt">&lt;/select&gt;</span>

  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">id=</span><span class="s">"t1"</span> <span class="na">style=</span><span class="s">"width:400px"</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- íŒ¨ë„ í† ê¸€ ë²„íŠ¼ì€ ë¶ˆí•„ìš”í•˜ë©´ ì œê±° --&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>ì‚¬ìš© íŒ</p>

<ul>
  <li>
    <p>ì´ ë°©ì‹ì€ <strong>í•´ë‹¹ ì…ë ¥ì°½ì—ì„œë§Œ</strong> ì˜â†’í•œ ë³€í™˜ì´ ì ìš©ë©ë‹ˆë‹¤. ë‹¤ë¥¸ í•„ë“œë‚˜ OS ì „ì²´ ì…ë ¥ê¸°ì—” ì˜í–¥ì´ ì—†ì–´ìš”.</p>
  </li>
  <li>
    <p>ë¬¼ë¦¬ í‚¤ë³´ë“œê°€ US ë°°ì—´ì´ë¼ê³  ê°€ì •í•˜ëŠ” ë§¤í•‘ì´ ë§ìŠµë‹ˆë‹¤. í‚¤ë³´ë“œ ë°°ì—´ì´ ë‹¤ë¥´ë©´ ì¼ë¶€ í‚¤ ìœ„ì¹˜ê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆì–´ìš”.</p>
  </li>
  <li>
    <p>í•œê¸€ ì¡°í•©ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì²˜ë¦¬í•©ë‹ˆë‹¤. ì»¤ì„œ ì´ë™/ë°±ìŠ¤í˜ì´ìŠ¤ ë“± ì¼ë°˜ í¸ì§‘ ë™ì‘ë„ ë¼ì´ë¸ŒëŸ¬ë¦¬ ìª½ ë¡œì§ì„ ë”°ë¦…ë‹ˆë‹¤.</p>
  </li>
</ul>

<p>ì›í•˜ë©´ ë“œë¡­ë‹¤ìš´ë„ ì—†ì• ê³  <strong>í•­ìƒ í•œê¸€ë§Œ</strong> ë“¤ì–´ê°€ë„ë¡ ê¹”ë”í•˜ê²Œ ì •ë¦¬í•œ ë²„ì „ìœ¼ë¡œë„ ë°”ë¡œ ë°”ê¿”ë“œë¦´ê²Œìš”.</p>

<p class="chat--user">

&lt;!DOCTYPE html&gt; &lt;html lang="en"&gt; &lt;head&gt; <meta charset="UTF-8" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <title>Korean Keyboard</title> <!-- é˜²ç¼“å­˜METAæ ‡ç­¾ --> <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" /> <meta http-equiv="Pragma" content="no-cache" /> <meta http-equiv="Expires" content="0" /> <!-- å¸¦ç‰ˆæœ¬æˆ³çš„æ ·å¼è¡¨ --> <link rel="stylesheet" href="style.css?v=20250802" /> &lt;/head&gt; &lt;body&gt; <!-- è¯­è¨€åˆ‡æ¢å™¨ --> &lt;div class="language-selector"&gt; &lt;div class="language-buttons" id="languageButtons"&gt;&lt;/div&gt; &lt;/div&gt; &lt;div class="container"&gt; &lt;h1&gt;Korean Input Test&lt;/h1&gt; <!-- è¯´æ˜æ–‡å­—ç§»åŠ¨åˆ°è¿™é‡Œ --> &lt;div class="info"&gt; &lt;p&gt;Type with English keyboard and it will automatically convert to Korean.</p>
<p>Hold Shift to input more Korean characters.</p>
<p>&lt;/div&gt; &lt;div class="input-section"&gt; <textarea id="koreanInput" placeholder="Type in English and it will convert to Korean..."></textarea> &lt;/div&gt; &lt;div class="button-section"&gt; <button id="copyBtn">Copy</button> <button id="clearBtn">Clear</button> <button id="saveBtn">Save Text</button> <button id="fontSmallerBtn" title="Smaller Text">-</button> <button id="fontLargerBtn" title="Larger Text">+</button> &lt;/div&gt; <!-- è™šæ‹Ÿé”®ç›˜åŒºåŸŸ - ç§»é™¤æ ‡é¢˜å’Œæ§åˆ¶ --> &lt;div class="virtual-keyboard-section"&gt; &lt;div class="virtual-keyboard" id="virtualKeyboard"&gt; <!-- é”®ç›˜å¸ƒå±€å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ --> &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; <!-- å¸¦ç‰ˆæœ¬æˆ³çš„JavaScriptæ–‡ä»¶ --> <script src="i18n.js?v=20250802"></script> <script src="virtual-keyboard.js?v=20250802"></script> <script src="korean-input.js?v=20250802"></script> &lt;footer class="site-footer"&gt; <a href="https://github.com/nonsensejoke/korean-keyboard" target="_blank" rel="noopener noreferrer"> <svg class="github-logo" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"> <path d="M12 0C5.373 0 0 5.373 0 12C0 17.523 3.438 22.093 8.205 23.5C8.795 23.6 9.025 23.225 9.025 22.9C9.025 22.6 9.015 21.685 9.01 20.705C5.672 21.415 4.965 19.165 4.965 19.165C4.445 17.815 3.65 17.415 3.65 17.415C2.61 16.685 3.73 16.705 3.73 16.705C4.855 16.785 5.425 17.815 5.425 17.815C6.425 19.565 8.125 19.065 8.75 18.785C8.85 18.115 9.125 17.665 9.425 17.415C6.885 17.135 4.225 16.125 4.225 11.755C4.225 10.455 4.675 9.395 5.425 8.575C5.315 8.295 4.925 7.155 5.525 5.605C5.525 5.605 6.485 5.295 8.985 6.845C9.915 6.585 10.925 6.455 11.975 6.455C13.025 6.455 14.035 6.585 14.965 6.845C17.465 5.295 18.425 5.605 18.425 5.605C19.025 7.155 18.635 8.295 18.525 8.575C19.275 9.395 19.725 10.455 19.725 11.755C19.725 16.135 17.065 17.135 14.515 17.415C14.895 17.735 15.225 18.335 15.225 19.205C15.225 20.555 15.215 21.625 15.215 21.9C15.215 22.225 15.445 22.605 16.045 22.5C20.825 21.085 24 16.515 24 11C24 4.373 18.627 0 12 0Z"></path> </svg> <span>nonsensejoke/korean-keyboard</span> </a> &lt;/footer&gt; &lt;/body&gt; &lt;/html&gt; ì´ ì‚¬ì´íŠ¸ ë”°ë¼ ë§Œë“¤ê³  ì‹¶ì–´ ê·¼ë° íŠ¹ì • í‚¤ê°€ ëˆŒë ·ì„ë•Œ í•œì˜ ëª¨ë“œ ì „í™˜ë˜ê²Œ</p>

<p>&lt;/p&gt;</p>

<p>ì¢‹ì•„, â€œìë™ í•œê¸€ ë³€í™˜â€ íë¦„ì€ ê·¸ëŒ€ë¡œ ë‘ê³ , íŠ¹ì • í‚¤ë¥¼ ëˆŒë €ì„ ë•Œ í•œ/ì˜ ì…ë ¥ ëª¨ë“œë¥¼ ì „í™˜í•˜ë„ë¡ ì„¤ê³„í•´ë³´ì. í•µì‹¬ì€ í•œê¸€ ì¡°í•© íŒŒì´í”„ë¼ì¸ ì•ë‹¨ì— â€œí˜„ì¬ IME ëª¨ë“œâ€ ìƒíƒœê°’ì„ ë‘ê³ , ë‹¨ì¶•í‚¤ë¥¼ ì¡ì•„ í† ê¸€í•˜ëŠ” ê±°ì•¼. ëª¨ë“œê°€ koë©´ ê¸°ì¡´ ì¡°í•©ê¸°ë¡œ ì²˜ë¦¬, enì´ë©´ ì›ë˜ ë¸Œë¼ìš°ì € ì…ë ¥ì— ë§¡ê¸°ë©´ ëœë‹¤.</p>

<p>ì•„ë˜ëŠ” ë°”ë¡œ ì ìš© ê°€ëŠ¥í•œ ì„¤ê³„ì™€ ì½”ë“œ ì˜ˆì‹œì•¼. íŒŒì¼ ì´ë¦„ì€ ë„¤ê°€ ì˜¬ë ¤ë‘” êµ¬ì¡°ì— ë§ì¶° ë„£ì—ˆì–´.</p>

<h2 id="1-htmlì—-ëª¨ë“œ-í‘œì‹œ-ì¶”ê°€ì„ íƒ">1) HTMLì— ëª¨ë“œ í‘œì‹œ ì¶”ê°€(ì„ íƒ)</h2>

<p>ì‚¬ìš©ìì—ê²Œ ì§€ê¸ˆ ëª¨ë“œê°€ ë­”ì§€ ë³´ì—¬ì£¼ëŠ” ì‘ì€ ì¹©ì„ ì¶”ê°€í•˜ë©´ ì¢‹ì•„.</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"input-section"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"ime-status"</span> <span class="na">aria-live=</span><span class="s">"polite"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">id=</span><span class="s">"imeMode"</span><span class="nt">&gt;</span>KO<span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;textarea</span> <span class="na">id=</span><span class="s">"koreanInput"</span> <span class="na">placeholder=</span><span class="s">"Type in English and it will convert to Korean..."</span><span class="nt">&gt;&lt;/textarea&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>ê°„ë‹¨í•œ ìŠ¤íƒ€ì¼ì€ style.cssì— ë„£ì.</p>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">.ime-status</span> <span class="p">{</span>
  <span class="nl">display</span><span class="p">:</span> <span class="nb">inline-block</span><span class="p">;</span>
  <span class="nl">margin-bottom</span><span class="p">:</span> <span class="m">6px</span><span class="p">;</span>
  <span class="nl">font-size</span><span class="p">:</span> <span class="m">12px</span><span class="p">;</span>
  <span class="nl">opacity</span><span class="p">:</span> <span class="m">.8</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.ime-status</span> <span class="nf">#imeMode</span> <span class="p">{</span>
  <span class="nl">padding</span><span class="p">:</span> <span class="m">2px</span> <span class="m">6px</span><span class="p">;</span>
  <span class="nl">border-radius</span><span class="p">:</span> <span class="m">6px</span><span class="p">;</span>
  <span class="nl">border</span><span class="p">:</span> <span class="m">1px</span> <span class="nb">solid</span> <span class="n">currentColor</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.ime-status</span> <span class="nf">#imeMode</span><span class="o">[</span><span class="nt">data-mode</span><span class="o">=</span><span class="s1">"ko"</span><span class="o">]</span> <span class="p">{</span> <span class="nl">content</span><span class="p">:</span> <span class="s1">"KO"</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.ime-status</span> <span class="nf">#imeMode</span><span class="o">[</span><span class="nt">data-mode</span><span class="o">=</span><span class="s1">"en"</span><span class="o">]</span> <span class="p">{</span> <span class="nl">content</span><span class="p">:</span> <span class="s1">"EN"</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div></div>

<h2 id="2-korean-inputjsì—-í•œì˜-ëª¨ë“œ-ìƒíƒœì™€-í† ê¸€-ë‹¨ì¶•í‚¤-ì¶”ê°€">2) korean-input.jsì— í•œ/ì˜ ëª¨ë“œ ìƒíƒœì™€ í† ê¸€ ë‹¨ì¶•í‚¤ ì¶”ê°€</h2>

<p>í¬ì¸íŠ¸ëŠ” ì„¸ ê°€ì§€ë‹¤.</p>

<ul>
  <li>
    <p>ì „ì—­ ëª¨ë“œ ìƒíƒœê°’(ko/en)</p>
  </li>
  <li>
    <p>ë‹¨ì¶•í‚¤ë¡œ ëª¨ë“œ í† ê¸€</p>
  </li>
  <li>
    <p>ëª¨ë“œê°€ enì¼ ë•ŒëŠ” ê°€ë¡œì±„ì§€ ì•Šê³  ê¸°ë³¸ ì…ë ¥ íë¦„ ìœ ì§€</p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// korean-input.js

// 1) ëª¨ë“œ ìƒíƒœ
const MODE = { KO: 'ko', EN: 'en' };
let imeMode = (localStorage.getItem('imeMode') === MODE.EN) ? MODE.EN : MODE.KO;

const textarea = document.getElementById('koreanInput');
const modeChip = document.getElementById('imeMode');

function renderMode() {
  if (!modeChip) return;
  modeChip.textContent = (imeMode === MODE.KO) ? 'KO' : 'EN';
  modeChip.setAttribute('data-mode', imeMode);
}
renderMode();

// 2) ë‹¨ì¶•í‚¤ ì •ì˜: Ctrl+Space ë˜ëŠ” F2 ì¤‘ í•˜ë‚˜ ëˆŒëŸ¬ë„ ì „í™˜
function isToggleHotkey(e) {
  // OS ë‹¨ì¶•í‚¤ ì¶©ëŒì´ ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ëŒ€ì•ˆ í‚¤ë„ ë‘”ë‹¤
  // Ctrl+Space ë˜ëŠ” F2
  return (e.ctrlKey &amp;&amp; !e.shiftKey &amp;&amp; !e.altKey &amp;&amp; e.code === 'Space') || (e.code === 'F2');
}

function toggleImeMode() {
  imeMode = (imeMode === MODE.KO) ? MODE.EN : MODE.KO;
  localStorage.setItem('imeMode', imeMode);
  renderMode();
  // ì‚¬ìš©ì í”¼ë“œë°±(ì„ íƒ): ì ê¹ í•˜ì´ë¼ì´íŠ¸ ì£¼ê¸°
  if (modeChip) {
    modeChip.style.transition = 'background .2s';
    modeChip.style.background = 'rgba(0,0,0,.08)';
    setTimeout(() =&gt; modeChip.style.background = 'transparent', 150);
  }
}

// 3) í•œê¸€ ì¡°í•©ê¸°(ë„¤ê°€ ì´ë¯¸ ê°–ê³  ìˆëŠ” ë¡œì§/ê°ì²´ë¥¼ ì‚¬ìš©)
// ì˜ˆ: composer.feedKey(e), composer.backspace(), composer.commit(), getComposedText() ê°™ì€ APIë¥¼ ê°€ì •
// ì—†ë‹¤ë©´ ê¸°ì¡´ ë„¤ ì¡°í•© í•¨ìˆ˜ë¥¼ ì—¬ê¸°ì„œ í˜¸ì¶œí•˜ë„ë¡ ì—°ê²°
importComposerIfNeeded(); // ì‹¤ì œë¡œëŠ” ë„¤ ê¸°ì¡´ ëª¨ë“ˆì„ ê°€ì ¸ì™€ ì‚¬ìš©

// ì»¤ì„œ/ì„ íƒ ì¹˜í™˜ ìœ í‹¸
function replaceSelectionWith(textarea, text) {
  const { selectionStart, selectionEnd, value } = textarea;
  const before = value.slice(0, selectionStart);
  const after  = value.slice(selectionEnd);
  const newPos = before.length + text.length;
  textarea.value = before + text + after;
  textarea.setSelectionRange(newPos, newPos);
}

// í˜„ì¬ ì¡°í•© ê²°ê³¼ë¥¼ ë°˜ì˜
function applyComposition(text) {
  // ë‹¨ìˆœíˆ í˜„ì¬ ì»¤ì„œ ìœ„ì¹˜ì— í•©ì„± ì¤‘ ë¬¸ìì—´ì„ ë°˜ì˜í•˜ë„ë¡ êµ¬í˜„
  // ë„¤ê°€ ì´ë¯¸ êµ¬í˜„í•œ ë°©ì‹ì´ ìˆë‹¤ë©´ ê·¸ ë°©ë²•ìœ¼ë¡œ ëŒ€ì²´
  replaceSelectionWith(textarea, text);
}

// 4) í‚¤ ì´ë²¤íŠ¸ í›…
textarea.addEventListener('keydown', (e) =&gt; {
  // 4-1) ëª¨ë“œ í† ê¸€
  if (isToggleHotkey(e)) {
    e.preventDefault();
    toggleImeMode();
    return;
  }

  // 4-2) EN ëª¨ë“œì¼ ë• ê°€ë¡œì±„ì§€ ì•ŠìŒ
  if (imeMode === MODE.EN) return;

  // 4-3) KO ëª¨ë“œ: ì¡°í•©ê¸°ê°€ ì²˜ë¦¬í•  í‚¤ë§Œ ê°€ë¡œì±„ê¸°
  // ì¡°í•©ê¸°ì—ì„œ ì²˜ë¦¬í•˜ëŠ” í‚¤ì˜ ë²”ìœ„ëŠ” ë„ˆì˜ êµ¬í˜„ì— ë§ì¶° ì¡°ì •
  // ì˜ˆ: ì˜ë¬¸ì/ìˆ«ì/ë°±ìŠ¤í˜ì´ìŠ¤/ìŠ¤í˜ì´ìŠ¤ ì •ë„ëŠ” preventDefaultí•˜ê³  composerë¡œ ë„˜ê¸°ê¸°
  const k = e.key;
  const isChar = k.length === 1; // í•œ ê¸€ì í‚¤
  const isBackspace = (k === 'Backspace');
  const isSpace = (k === ' ');
  const isEnter = (k === 'Enter');

  // ë°©í–¥í‚¤/í™ˆ/ì—”ë“œ ë“±ì€ í†µê³¼ì‹œì¼œì•¼ í¸ì§‘ì´ ê°€ëŠ¥
  if (!isChar &amp;&amp; !isBackspace &amp;&amp; !isSpace &amp;&amp; !isEnter) return;

  // ì—¬ê¸°ì„œë¶€í„°ëŠ” ì¡°í•©ê¸°ì—ê²Œ ìœ„ì„
  e.preventDefault();

  if (isBackspace) {
    composer.backspace();
    applyComposition(composer.text()); // composer.text(): í˜„ì¬ í•©ì„± ë¬¸ìì—´
    return;
  }
  if (isEnter) {
    // ì¤„ë°”ê¿ˆì€ ì¡°í•©ì„ ì»¤ë°‹í•˜ê³  ê°œí–‰ ì¶”ê°€
    const committed = composer.commit();
    replaceSelectionWith(textarea, committed + '\n');
    return;
  }
  if (isSpace) {
    // ìŠ¤í˜ì´ìŠ¤ëŠ” ì¡°í•© ì»¤ë°‹ í›„ ê³µë°±
    const committed = composer.commit();
    replaceSelectionWith(textarea, committed + ' ');
    return;
  }

  // ì¼ë°˜ ë¬¸ì: ì¡°í•©ê¸°ì— ë¨¹ì´ê³  ë°˜ì˜
  composer.feedKey(e);              // ë‚´ë¶€ì—ì„œ 2ë²Œì‹/ê²¹ëª¨ìŒ/ê²¹ë°›ì¹¨ ì²˜ë¦¬
  applyComposition(composer.text()); // í•©ì„±ì¤‘ ë¬¸ìì—´ ë°˜ì˜
});

// 5) í¬ì»¤ìŠ¤ ì•„ì›ƒ ì‹œ ì¡°í•© ì»¤ë°‹(ì„ íƒ)
textarea.addEventListener('blur', () =&gt; {
  if (imeMode === MODE.KO) {
    const committed = composer.commit();
    if (committed) replaceSelectionWith(textarea, committed);
  }
});

// 6) ê°€ìƒ í‚¤ë³´ë“œì™€ë„ ëª¨ë“œ ë™ê¸°í™”(ì„ íƒ)
// ë§Œì•½ virtual-keyboard.jsì—ì„œ 'í•œ/ì˜' í‚¤ë¥¼ ë Œë”ë§í•œë‹¤ë©´:
document.addEventListener('vk:toggle-ime', () =&gt; {
  toggleImeMode();
});
</code></pre></div></div>

<h3 id="ì£¼ì˜í• -ì ">ì£¼ì˜í•  ì </h3>

<ul>
  <li>
    <p>OS ë‹¨ì¶•í‚¤ ì¶©ëŒ: Ctrl+SpaceëŠ” macOS/Windows ëª¨ë‘ì—ì„œ IME ì „í™˜ìœ¼ë¡œ ì“°ì¼ ë•Œê°€ ìˆë‹¤. ë¸Œë¼ìš°ì €ì— í‚¤ê°€ ë„ë‹¬í•˜ë©´ ìœ„ ì½”ë“œê°€ ì¡ì§€ë§Œ, OS ë‹¨ê³„ì—ì„œ ë¨¹íˆë©´ ì´ë²¤íŠ¸ê°€ ì•„ì˜ˆ ì•ˆ ì˜¨ë‹¤. ê·¸ë˜ì„œ F2 ê°™ì€ ëŒ€ì²´ í‚¤ë¥¼ í•¨ê»˜ ë‘ì—ˆë‹¤.</p>
  </li>
  <li>
    <p>ëª¨ë°”ì¼: ì†Œí”„íŠ¸ í‚¤ë³´ë“œì—ì„œëŠ” ë¬¼ë¦¬í‚¤ ì´ë²¤íŠ¸ê°€ ì œí•œì ì´ë‹¤. ëª¨ë°”ì¼ ì§€ì›ì„ ì›í•˜ë©´ í™”ë©´ì— â€œí•œ/ì˜â€ í† ê¸€ ë²„íŠ¼ì„ í•˜ë‚˜ ë°°ì¹˜í•´ <code class="language-plaintext highlighter-rouge">toggleImeMode()</code>ë¥¼ ëˆŒëŸ¬ì£¼ê²Œ í•˜ì.</p>
  </li>
  <li>
    <p>Undo/Redo: <code class="language-plaintext highlighter-rouge">preventDefault</code>ë¡œ ì§ì ‘ ê°’ì„ ë°”ê¾¸ë©´ ê¸°ë³¸ Undo ìŠ¤íƒê³¼ ì—®ì´ëŠ” ë°©ì‹ì´ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆë‹¤. í° ë‹¨ìœ„(ì»¤ë°‹ ì‹œì )ë¡œë§Œ valueë¥¼ ë°”ê¾¸ê±°ë‚˜, <code class="language-plaintext highlighter-rouge">beforeinput</code> ì´ë²¤íŠ¸ë¥¼ ì‚¬ìš©í•´ ë¸Œë¼ìš°ì € í¸ì§‘ íŒíŠ¸ë¥¼ ë§ì¶°ì£¼ë©´ í’ˆì§ˆì´ ì˜¤ë¥¸ë‹¤.</p>
  </li>
  <li>
    <p>ì„ íƒ ì˜ì—­ í¸ì§‘: ìœ„ ì˜ˆì‹œëŠ” ì»¤ì„œ ê¸°ì¤€ ì¹˜í™˜ìœ¼ë¡œ ë‹¨ìˆœí™”í–ˆë‹¤. ë“œë˜ê·¸ ì„ íƒ í›„ ì…ë ¥Â·ë°±ìŠ¤í˜ì´ìŠ¤ ë“±ë„ ì •í™•íˆ ì‘ë™í•˜ê²Œ í•˜ë ¤ë©´ selectionStart/End ê¸°ì¤€ìœ¼ë¡œ ì¡°í•© ì¤‘ ë¬¸ìì—´ ë²”ìœ„ë¥¼ ì¶”ì í•˜ê±°ë‚˜, ì»¤ë°‹ ì‹œì ë§ˆë‹¤ ì•µì»¤ë¥¼ ê°±ì‹ í•˜ì.</p>
  </li>
  <li>
    <p>ì¡°í•©ê¸° API: ìœ„ì— ì“´ <code class="language-plaintext highlighter-rouge">composer.feedKey/backspace/commit/text</code>ëŠ” ë„¤ê°€ ê°€ì§„ í•œê¸€ ì¡°í•© ë¡œì§ì— ë§ì¶° ì´ë¦„ë§Œ ë°”ê¿” ë¶™ì´ë©´ ëœë‹¤.</p>
  </li>
</ul>

<h2 id="3-virtual-keyboardjsì—ì„œ-í•œì˜-í‚¤-ëˆŒë €ì„-ë•Œ-í† ê¸€ì„ íƒ">3) virtual-keyboard.jsì—ì„œ â€˜í•œ/ì˜â€™ í‚¤ ëˆŒë €ì„ ë•Œ í† ê¸€(ì„ íƒ)</h2>

<p>í™”ë©´ í‚¤ë³´ë“œì—ë„ í•œ/ì˜ í‚¤ë¥¼ ë‹¬ê³  ì‹¶ë‹¤ë©´, í´ë¦­ ì‹œ ì»¤ìŠ¤í…€ ì´ë²¤íŠ¸ë¥¼ ì˜ì.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// virtual-keyboard.js ë‚´ë¶€
function emitToggleIme() {
  const ev = new CustomEvent('vk:toggle-ime', { bubbles: true });
  document.dispatchEvent(ev);
}

// í‚¤ ë Œë”ë§ ì‹œ
// &lt;button data-key="HANENG"&gt;í•œ/ì˜&lt;/button&gt;
keyboardRoot.addEventListener('click', (e) =&gt; {
  const key = e.target.closest('[data-key]');
  if (!key) return;
  const code = key.getAttribute('data-key');
  if (code === 'HANENG') {
    emitToggleIme();
    return;
  }
  // ... ê¸°ì¡´ í‚¤ ì²˜ë¦¬ ...
});
</code></pre></div></div>

<h2 id="4-í‚¤-ë§¤í•‘-ìš°ì„ ìˆœìœ„">4) í‚¤ ë§¤í•‘ ìš°ì„ ìˆœìœ„</h2>

<ul>
  <li>
    <p>ko ëª¨ë“œì¼ ë•Œë§Œ <code class="language-plaintext highlighter-rouge">preventDefault</code>ë¡œ ì¡ì•„ í•œê¸€ ì¡°í•© íë¦„ìœ¼ë¡œ ë³´ë‚¸ë‹¤.</p>
  </li>
  <li>
    <p>en ëª¨ë“œì¼ ë•ŒëŠ” ìµœëŒ€í•œ ë¸Œë¼ìš°ì € ê¸°ë³¸ ë™ì‘ì„ ì‚´ë ¤ë‘¬ì•¼ í…ìŠ¤íŠ¸ í¸ì§‘ ê²½í—˜ì´ ìì—°ìŠ¤ëŸ½ë‹¤.</p>
  </li>
  <li>
    <p>í•„ìš”í•œ ê²½ìš° ìˆ«ì/ê¸°í˜¸ë„ ì¡°í•©ê¸°ì—ì„œ ì²˜ë¦¬í• ì§€ ì—¬ë¶€ë¥¼ ì˜µì…˜í™”í•´ë¼.</p>
  </li>
</ul>

<h2 id="5-ë¹ ë¥¸-ì²´í¬ë¦¬ìŠ¤íŠ¸">5) ë¹ ë¥¸ ì²´í¬ë¦¬ìŠ¤íŠ¸</h2>

<ul>
  <li>
    <p>ë‹¨ì¶•í‚¤: Ctrl+Space, F2 ë‘ ê°€ì§€ ë‹¤ ì œê³µ</p>
  </li>
  <li>
    <p>ëª¨ë“œ í‘œì‹œ: ì‘ì€ ì¹©ìœ¼ë¡œ KO/EN í‘œê¸°</p>
  </li>
  <li>
    <p>ë¡œì»¬ ì €ì¥: ë§ˆì§€ë§‰ ëª¨ë“œ ê¸°ì–µ(localStorage)</p>
  </li>
  <li>
    <p>í¬ì»¤ìŠ¤ ì•„ì›ƒ: ë¯¸ì»¤ë°‹ ë¬¸ì ì»¤ë°‹</p>
  </li>
  <li>
    <p>ëª¨ë°”ì¼: í™”ë©´ í† ê¸€ ë²„íŠ¼ ì¶”ê°€</p>
  </li>
</ul>

<p>ì´ëŒ€ë¡œ ë„£ìœ¼ë©´ â€œíŠ¹ì • í‚¤ë¥¼ ëˆŒëŸ¬ í•œ/ì˜ ì „í™˜â€ì´ ê¹”ë”í•˜ê²Œ ë¶™ëŠ”ë‹¤. ë„¤ ì¡°í•©ê¸° í•¨ìˆ˜ ì´ë¦„ì´ ë‹¤ë¥´ë©´ ê·¸ ë¶€ë¶„ë§Œ ë°”ê¿”ì„œ ì—°ê²°í•˜ë©´ ë˜ê³ , ì›í•˜ë©´ CapsLock ì „í™˜, ì˜¤ë¥¸ìª½ Alt ë“± ë‹¤ë¥¸ í‚¤ ì¡°í•©ë„ ì¶”ê°€í•´ì¤„ ìˆ˜ ìˆì–´.</p>

<p class="chat--user">

ë‚´ê°€ ì¤€ ì†ŒìŠ¤ë³¸ê±° ë§ì•„?

</p>

<p>ì§šê³  ê°ˆê²Œ.</p>

<p>ë„¤ê°€ <strong>ì´ë²ˆì— ì˜¬ë¦° HTML ì†ŒìŠ¤</strong> ëŠ” ë‹¤ìŒ JS íŒŒì¼ë“¤ì„ ë¶ˆëŸ¬ì˜¤ê³  ìˆì„ ë¿,<br />
ê·¸ ì•ˆì˜ ë‚´ìš©(íŠ¹íˆ korean-input.js / i18n.js / virtual-keyboard.js)ì€ <strong>ì—¬ê¸° ì±—ì— ê³µìœ ë˜ì§€ ì•Šì•˜ì–´.</strong></p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"i18n.js?v=20250802"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"virtual-keyboard.js?v=20250802"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"korean-input.js?v=20250802"</span><span class="nt">&gt;&lt;/script&gt;</span>
</code></pre></div></div>

<p>ì¦‰,</p>

<p><strong>ë„¤ê°€ ì¤€ ê±´ â€˜HTML êµ¬ì¡°â€™ì´ê³ , ì‹¤ì œ í•œê¸€ ìë™ ë³€í™˜ ê¸°ëŠ¥ì€ ì € JS íŒŒì¼ ì•ˆì— ìˆë‹¤.</strong><br />
ê·¸ë¦¬ê³  ë‚´ê°€ ìœ„ì—ì„œ ì‘ì„±í•´ì¤€ "í•œ/ì˜ ëª¨ë“œ ì „í™˜" ì½”ë“œëŠ” ê·¸ JS ë‚´ë¶€ì— ì¶”ê°€í•´ì•¼ í•˜ëŠ” ê¸°ëŠ¥ ì½”ë“œì˜€ì–´.</p>

<hr />

<h3 id="ì •ë‹µ">ì •ë‹µ</h3>

<p>ë„ˆê°€ ê³µìœ í•œ HTML ì½”ë“œë§Œìœ¼ë¡œëŠ” <strong>"íŠ¹ì • í‚¤ ëˆŒëŸ¬ í•œ/ì˜ ì „í™˜" ê¸°ëŠ¥ì´ ì—†ë‹¤.</strong></p>

<p>ê·¸ë¦¬ê³  "ë”°ë¼ ë§Œë“¤ê³  ì‹¶ë‹¤"ëŠ” ì‚¬ì´íŠ¸ ì†ŒìŠ¤ì¸ì§€ í™•ì¸í•˜ëŠ” ì§ˆë¬¸ì´ë¼ë©´:</p>

<blockquote>
  <p><strong>ì§€ê¸ˆê¹Œì§€ ë„¤ê°€ ì±—ì— ì˜¬ë¦° ì†ŒìŠ¤ëŠ” ê·¸ ì‚¬ì´íŠ¸ ì „ì²´ ì†ŒìŠ¤ê°€ ì•„ë‹ˆë‹¤.<br />
 í•µì‹¬ ê¸°ëŠ¥(JS ë¶€ë¶„)ì€ ì•„ì§ ì±—ì—ì„œ ë³´ì§€ ëª»í–ˆë‹¤.</strong></p>
</blockquote>

<hr />

<h3 id="ì™œëƒ">ì™œëƒ?</h3>

<ul>
  <li>
    <p>HTMLì—ëŠ” <strong>í…ìŠ¤íŠ¸ ë°•ìŠ¤, ë²„íŠ¼, UI êµ¬ì¡°</strong> ë§Œ ìˆìŒ</p>
  </li>
  <li>
    <p>ì§„ì§œ í•œê¸€ ìë™ ë³€í™˜ / ìíŒ ì¡°í•© ì•Œê³ ë¦¬ì¦˜ì€ <code class="language-plaintext highlighter-rouge">korean-input.js</code>ì— ìˆìŒ</p>
  </li>
  <li>
    <p>ê°€ìƒ í‚¤ë³´ë“œ UIëŠ” <code class="language-plaintext highlighter-rouge">virtual-keyboard.js</code>ì— ìˆìŒ</p>
  </li>
  <li>
    <p>ì–¸ì–´ ë°°ì—´ ë° ë ˆì´ì•„ì›ƒ ì •ì˜ëŠ” <code class="language-plaintext highlighter-rouge">i18n.js</code>ì— ìˆìŒ</p>
  </li>
</ul>

<p>ì¦‰, ë„¤ê°€ ì¤€ HTMLì€ â€œì´ ì‚¬ì´íŠ¸ë¥¼ ë”°ë¼ ë§Œë“¤ê¸° ìœ„í•œ ê»ë°ê¸°â€ê³ ,<br />
ê¸°ëŠ¥ì€ ì „ë¶€ JSê°€ ë‹´ë‹¹í•˜ê³  ìˆì–´.</p>

<hr />

<h3 id="ê·¸ë˜ì„œ-í•´ì•¼-í• -ê²ƒ">ê·¸ë˜ì„œ í•´ì•¼ í•  ê²ƒ</h3>

<ol>
  <li>
    <p>ë„¤ê°€ ì“°ê³  ìˆëŠ” <code class="language-plaintext highlighter-rouge">korean-input.js</code> ë¥¼ ë³´ì—¬ì¤˜<br />
ê·¸ë˜ì•¼ <strong>ê±°ê¸°ì— í•œ/ì˜ ì „í™˜ í•«í‚¤ ì½”ë“œë¥¼ ì •í™•íˆ ì‚½ì…í•´ì¤„ ìˆ˜ ìˆì–´.</strong></p>
  </li>
  <li>
    <p>ë˜ëŠ” ì‚¬ìš© ì¤‘ì¸ GitHub ì €ì¥ì†Œ ë§í¬(URL)ë¥¼ ì•Œë ¤ì¤˜ë„ ë¨<br />
ê·¸ëŸ¬ë©´ êµ¬ì¡°ë¥¼ ë³´ê³  ì–´ë””ì— ì½”ë“œë¥¼ ë„£ëŠ”ì§€ ë”± ì§‘ì–´ì£¼ê² ë‹¤.</p>
  </li>
</ol>

<hr />

<h3 id="ë‹¤ìŒ-ë©”ì‹œì§€ì—-ì´ë ‡ê²Œ-ë³´ë‚´ì¤˜">ë‹¤ìŒ ë©”ì‹œì§€ì— ì´ë ‡ê²Œ ë³´ë‚´ì¤˜</h3>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">korean-input</span><span class="nc">.js</span> <span class="nt">ì†ŒìŠ¤</span> <span class="nt">ì „ì²´</span>
</code></pre></div></div>

<p>ë˜ëŠ”</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">virtual</span><span class="o">-</span><span class="n">keyboard</span><span class="p">.</span><span class="n">js</span> <span class="err">ì†ŒìŠ¤</span> <span class="err">ì „ì²´</span>
</code></pre></div></div>

<p><strong>ê·¸ íŒŒì¼ì„ ë³´ë©´ ë„¤ê°€ ì›í•˜ëŠ” â€˜íŠ¹ì • í‚¤ë¡œ í•œ/ì˜ ì „í™˜â€™ ê¸°ëŠ¥ì„ ì‹¤ì œ ì½”ë“œì— ì •í™•íˆ ë„£ì–´ì¤„ê²Œ.</strong></p>

<p>ì§€ê¸ˆì€ HTMLë§Œ ìˆì–´ì„œ â€œë§ëŠ”ì§€?â€ ë¼ê³  ë¬¼ìœ¼ë©´ ë‹µì€ <strong>ì•„ì§ ì•„ë‹ˆì•¼. í•µì‹¬ ì†ŒìŠ¤ë¥¼ ì•ˆ ë³¸ ìƒíƒœê±°ë“ .</strong><br />
ê³„ì† ê°€ë³´ì.</p>

<p class="chat--user">

class KoreanInput { constructor() { // å­—ä½“å¤§å°ç®¡ç† this.fontSize = 18; // é»˜è®¤å­—ä½“å¤§å° // æ™®é€šçŠ¶æ€çš„é”®ç›˜æ˜ å°„ this.normalMap = { // è¾…éŸ³ (ì´ˆì„±/ì¢…ì„±) 'q': 'ã…‚', 'w': 'ã…ˆ', 'e': 'ã„·', 'r': 'ã„±', 't': 'ã……', 'a': 'ã…', 's': 'ã„´', 'd': 'ã…‡', 'f': 'ã„¹', 'g': 'ã…', 'z': 'ã…‹', 'x': 'ã…Œ', 'c': 'ã…Š', 'v': 'ã…', // å…ƒéŸ³ (ì¤‘ì„±) 'y': 'ã…›', 'u': 'ã…•', 'l': 'ã…£', 'o': 'ã…', 'p': 'ã…”', 'h': 'ã…—', 'j': 'ã…“', 'k': 'ã…', 'i': 'ã…‘', 'b': 'ã… ', 'n': 'ã…œ', 'm': 'ã…¡' }; // ShiftçŠ¶æ€çš„é”®ç›˜æ˜ å°„ this.shiftMap = { // åŒè¾…éŸ³ 'Q': 'ã…ƒ', 'W': 'ã…‰', 'E': 'ã„¸', 'R': 'ã„²', 'T': 'ã…†', // å¤åˆå…ƒéŸ³ 'O': 'ã…’', 'P': 'ã…–', // å…¶ä»–æŒ‰é”®ä¿æŒåŸæ˜ å°„ï¼ˆå°å†™è½¬å¤§å†™ï¼‰ 'q': 'ã…ƒ', 'w': 'ã…‰', 'e': 'ã„¸', 'r': 'ã„²', 't': 'ã…†', 'o': 'ã…’', 'p': 'ã…–' }; // éŸ©æ–‡å­—ç¬¦èŒƒå›´å¸¸é‡ this.HANGUL_BASE = 0xAC00; this.CHOSUNG_BASE = 0x1100; this.JUNGSUNG_BASE = 0x1161; this.JONGSUNG_BASE = 0x11A7; // åˆå£° (19ä¸ª) this.chosungList = ['ã„±', 'ã„²', 'ã„´', 'ã„·', 'ã„¸', 'ã„¹', 'ã…', 'ã…‚', 'ã…ƒ', 'ã……', 'ã…†', 'ã…‡', 'ã…ˆ', 'ã…‰', 'ã…Š', 'ã…‹', 'ã…Œ', 'ã…', 'ã…']; // ä¸­å£° (21ä¸ª) this.jungsungList = ['ã…', 'ã…', 'ã…‘', 'ã…’', 'ã…“', 'ã…”', 'ã…•', 'ã…–', 'ã…—', 'ã…˜', 'ã…™', 'ã…š', 'ã…›', 'ã…œ', 'ã…', 'ã…', 'ã…Ÿ', 'ã… ', 'ã…¡', 'ã…¢', 'ã…£']; // ç»ˆå£° (28ä¸ªï¼ŒåŒ…å«ç©ºå­—ç¬¦) this.jongsungList = ['', 'ã„±', 'ã„²', 'ã„³', 'ã„´', 'ã„µ', 'ã„¶', 'ã„·', 'ã„¹', 'ã„º', 'ã„»', 'ã„¼', 'ã„½', 'ã„¾', 'ã„¿', 'ã…€', 'ã…', 'ã…‚', 'ã…„', 'ã……', 'ã…†', 'ã…‡', 'ã…ˆ', 'ã…Š', 'ã…‹', 'ã…Œ', 'ã…', 'ã…']; // å®Œæ•´çš„éŸ©æ–‡ç»„åˆå¼•æ“æ•°æ®ç»“æ„ï¼ˆä»å‚è€ƒé¡¹ç›®ç§»æ¤ï¼‰ this.initial = [12593, 12594, 12596, 12599, 12600, 12601, 12609, 12610, 12611, 12613, 12614, 12615, 12616, 12617, 12618, 12619, 12620, 12621, 12622]; this.finale = [0, 12593, 12594, 12595, 12596, 12597, 12598, 12599, 12601, 12602, 12603, 12604, 12605, 12606, 12607, 12608, 12609, 12610, 12612, 12613, 12614, 12615, 12616, 12618, 12619, 12620, 12621, 12622]; this.dMedial = [0, 0, 0, 0, 0, 0, 0, 0, 0, 800, 801, 820, 0, 0, 1304, 1305, 1320, 0, 0, 1820]; this.dFinale = [0, 0, 0, 119, 0, 422, 427, 0, 0, 801, 816, 817, 819, 825, 826, 827, 0, 0, 1719, 0, 1919]; // Unicodeå¸¸é‡ this.SBase = 44032; this.LBase = 4352; this.VBase = 12623; this.TBase = 4519; this.LCount = 19; this.VCount = 21; this.TCount = 28; this.NCount = 588; this.SCount = 11172; // å½“å‰æ­£åœ¨ç»„åˆçš„å­—ç¬¦çŠ¶æ€ this.currentChosung = ''; this.currentJungsung = ''; this.currentJongsung = ''; this.buffer = ''; } // æŸ¥æ‰¾æ•°ç»„ä¸­å…ƒç´ çš„ç´¢å¼•ï¼ˆå·¥å…·å‡½æ•°ï¼‰ indexOf(array, value) { for (let i = 0; i &lt; array.length; i++) { if (array[i] === value) { return i; } } return -1; } // è·å–å­—ç¬¦æ˜ å°„ getCharacter(key, isShift) { if (isShift &amp;&amp; this.shiftMap[key]) { return this.shiftMap[key]; } return this.normalMap[key.toLowerCase()] || null; } // åˆ¤æ–­æ˜¯å¦ä¸ºè¾…éŸ³ isConsonant(char) { return this.chosungList.includes(char) || this.jongsungList.includes(char); } // åˆ¤æ–­æ˜¯å¦ä¸ºå…ƒéŸ³ isVowel(char) { return this.jungsungList.includes(char); } // å®Œæ•´çš„éŸ©æ–‡ç»„åˆç®—æ³•ï¼ˆä»å‚è€ƒé¡¹ç›®ç§»æ¤å¹¶ä¼˜åŒ–ï¼‰ composeHangul(inputString) { const length = inputString.length; if (length === 0) { return ""; } let currentCharCode = inputString.charCodeAt(0); let result = String.fromCharCode(currentCharCode); for (let i = 1; i &lt; length; i++) { const nextCharCode = inputString.charCodeAt(i); const initialIndex = this.indexOf(this.initial, currentCharCode); // åˆå£° + ä¸­å£° â†’ éŸ³èŠ‚ if (initialIndex !== -1) { const vowelOffset = nextCharCode - this.VBase; if (0 &lt;= vowelOffset &amp;&amp; vowelOffset &lt; this.VCount) { currentCharCode = this.SBase + (initialIndex * this.VCount + vowelOffset) * this.TCount; result = result.slice(0, result.length - 1) + String.fromCharCode(currentCharCode); continue; } } // å…ƒéŸ³ + å…ƒéŸ³ â†’ å¤åˆå…ƒéŸ³ const currentVowelOffset = currentCharCode - this.VBase; const nextVowelOffset = nextCharCode - this.VBase; if (0 &lt;= currentVowelOffset &amp;&amp; currentVowelOffset &lt; this.VCount &amp;&amp; 0 &lt;= nextVowelOffset &amp;&amp; nextVowelOffset &lt; this.VCount) { const dMedialIndex = this.indexOf(this.dMedial, (currentVowelOffset * 100) + nextVowelOffset); if (dMedialIndex &gt; 0) { currentCharCode = this.VBase + dMedialIndex; result = result.slice(0, result.length - 1) + String.fromCharCode(currentCharCode); continue; } } const syllableOffset = currentCharCode - this.SBase; // éŸ³èŠ‚ + ç»ˆå£° â†’ å®Œæ•´éŸ³èŠ‚ if (0 &lt;= syllableOffset &amp;&amp; syllableOffset &lt; 11145 &amp;&amp; (syllableOffset % this.TCount) === 0) { const finaleIndex = this.indexOf(this.finale, nextCharCode); if (finaleIndex !== -1) { currentCharCode += finaleIndex; result = result.slice(0, result.length - 1) + String.fromCharCode(currentCharCode); continue; } // å¤„ç†å¤åˆä¸­å£° const vowelIndex = Math.floor((syllableOffset % this.NCount) / this.TCount); const dMedialIndex = this.indexOf(this.dMedial, (vowelIndex * 100) + (nextCharCode - this.VBase)); if (dMedialIndex &gt; 0) { currentCharCode += (dMedialIndex - vowelIndex) * this.TCount; result = result.slice(0, result.length - 1) + String.fromCharCode(currentCharCode); continue; } } // å®Œæ•´éŸ³èŠ‚ + å…ƒéŸ³ â†’ ç»ˆå£°åˆ†ç¦» + æ–°éŸ³èŠ‚ (å…³é”®ä¿®å¤!) if (0 &lt;= syllableOffset &amp;&amp; syllableOffset &lt; 11172 &amp;&amp; (syllableOffset % this.TCount) !== 0) { const finaleIndex = syllableOffset % this.TCount; const vowelOffset = nextCharCode - this.VBase; if (0 &lt;= vowelOffset &amp;&amp; vowelOffset &lt; this.VCount) { const newInitialIndex = this.indexOf(this.initial, this.finale[finaleIndex]); if (0 &lt;= newInitialIndex &amp;&amp; newInitialIndex &lt; this.LCount) { // ç§»é™¤ç»ˆå£°ï¼Œåˆ›å»ºæ–°éŸ³èŠ‚ result = result.slice(0, result.length - 1) + String.fromCharCode(currentCharCode - finaleIndex); currentCharCode = this.SBase + (newInitialIndex * this.VCount + vowelOffset) * this.TCount; result = result + String.fromCharCode(currentCharCode); continue; } // å¤„ç†å¤åˆç»ˆå£°åˆ†è§£ if (finaleIndex &lt; this.dFinale.length &amp;&amp; this.dFinale[finaleIndex] !== 0) { result = result.slice(0, result.length - 1) + String.fromCharCode(currentCharCode - finaleIndex + Math.floor(this.dFinale[finaleIndex] / 100)); currentCharCode = this.SBase + (this.indexOf(this.initial, this.finale[(this.dFinale[finaleIndex] % 100)]) * this.VCount + vowelOffset) * this.TCount; result = result + String.fromCharCode(currentCharCode); continue; } } // å¤„ç†å¤åˆç»ˆå£° const dFinaleIndex = this.indexOf(this.dFinale, (finaleIndex * 100) + this.indexOf(this.finale, nextCharCode)); if (dFinaleIndex &gt; 0) { currentCharCode = currentCharCode + dFinaleIndex - finaleIndex; result = result.slice(0, result.length - 1) + String.fromCharCode(currentCharCode); continue; } } // æ— æ³•ç»„åˆï¼Œæ·»åŠ æ–°å­—ç¬¦ currentCharCode = nextCharCode; result = result + String.fromCharCode(nextCharCode); } return result; } // åˆ†è§£éŸ©æ–‡å­—ç¬¦ï¼ˆæŒ‰ç…§å‚è€ƒé¡¹ç›®å®ç°ï¼‰ decomposeHangul(inputString) { const length = inputString.length; let result = ""; for (let i = 0; i &lt; length; i++) { const charCode = inputString.charCodeAt(i); const syllableOffset = charCode - this.SBase; // æ£€æŸ¥æ˜¯å¦ä¸ºéŸ©æ–‡éŸ³èŠ‚ if (syllableOffset &lt; 0 || syllableOffset &gt;= this.SCount) { result += String.fromCharCode(charCode); continue; } // åˆ†è§£éŸ³èŠ‚ const initialIndex = Math.floor(syllableOffset / this.NCount); const vowelCode = this.VBase + Math.floor((syllableOffset % this.NCount) / this.TCount); const finaleCode = this.finale[syllableOffset % this.TCount]; result += String.fromCharCode(this.initial[initialIndex], vowelCode); if (finaleCode !== 0) { result += String.fromCharCode(finaleCode); } } return result; } // å¤„ç†è¾“å…¥ - ç®€åŒ–ç‰ˆæœ¬ï¼Œç›´æ¥è¿”å›å­—ç¬¦ç”¨äºsmartInsertå¤„ç† processInput(char) { // ç®€åŒ–ï¼šç›´æ¥è¿”å›å­—ç¬¦ï¼Œè®©smartInsertå¤„ç†æ‰€æœ‰ç»„åˆé€»è¾‘ return char; } // æ£€æµ‹éŸ©æ–‡å­—ç¬¦æ˜¯å¦å®Œæˆï¼ˆç”¨äºå†å²ä¿å­˜æ—¶æœºåˆ¤æ–­ï¼‰ isHangulCharComplete(char) { if (!char) return false; const charCode = char.charCodeAt(0); const syllableOffset = charCode - this.SBase; // æ£€æŸ¥æ˜¯å¦ä¸ºå®Œæ•´çš„éŸ©æ–‡éŸ³èŠ‚ï¼ˆä¸æ˜¯å•ç‹¬çš„å­—æ¯ç»„ä»¶ï¼‰ if (0 &lt;= syllableOffset &amp;&amp; syllableOffset &lt; this.SCount) { return true; // æ˜¯å®Œæ•´çš„éŸ©æ–‡éŸ³èŠ‚ } return false; // ä¸æ˜¯å®Œæ•´çš„éŸ©æ–‡éŸ³èŠ‚æˆ–ä¸æ˜¯éŸ©æ–‡å­—ç¬¦ } // æ£€æµ‹ä»æ—§æ–‡æœ¬åˆ°æ–°æ–‡æœ¬æ˜¯å¦æœ‰éŸ©æ–‡å­—ç¬¦å®Œæˆ detectHangulCompletion(oldText, newText, cursorPosition) { // æ£€æŸ¥å…‰æ ‡ä½ç½®é™„è¿‘æ˜¯å¦æœ‰æ–°å®Œæˆçš„éŸ©æ–‡å­—ç¬¦ if (cursorPosition &lt;= 0) return false; const newChar = newText[cursorPosition - 1]; const oldChar = oldText[cursorPosition - 1] || ''; // å¦‚æœæ–°å­—ç¬¦æ˜¯å®Œæ•´éŸ©æ–‡å­—ç¬¦ï¼Œè€Œæ—§å­—ç¬¦ä¸æ˜¯ï¼Œåˆ™è¡¨ç¤ºæœ‰å­—ç¬¦å®Œæˆ if (this.isHangulCharComplete(newChar) &amp;&amp; !this.isHangulCharComplete(oldChar)) { return true; } // æ£€æŸ¥æ˜¯å¦æœ‰éŸ©æ–‡å­—ç¬¦ä»ä¸å®Œæ•´å˜ä¸ºå®Œæ•´ if (newChar !== oldChar &amp;&amp; this.isHangulCharComplete(newChar)) { return true; } return false; } // æ™ºèƒ½æ’å…¥å‡½æ•° - æ”¹è¿›ç‰ˆæœ¬ï¼Œæ›´å¥½åœ°å¤„ç†éŸ©æ–‡ç»„åˆï¼Œå¢åŠ å®Œæˆæ£€æµ‹ smartInsert(currentText, cursorStart, cursorEnd, newChar) { // 1. æ„å»ºæ–°æ–‡æœ¬ï¼šæ’å…¥æ–°å­—ç¬¦ const textBefore = currentText.substring(0, cursorStart); const textAfter = currentText.substring(cursorEnd); const tempText = textBefore + newChar + textAfter; const tempCursorPos = cursorStart + newChar.length; // 2. éŸ©æ–‡ç»„åˆå¤„ç†ï¼šå°è¯•ä¸åŒé•¿åº¦çš„å­—ç¬¦åºåˆ— for (let testLength = Math.min(4, tempCursorPos); testLength &gt;= 2; testLengthâ€“) { const testChars = tempText.substring(tempCursorPos - testLength, tempCursorPos); const composed = this.composeHangul(testChars); // 3. å¦‚æœç»„åˆæˆåŠŸï¼ˆé•¿åº¦å‡å°‘ï¼Œæˆ–è€…å†…å®¹æœ‰æ„ä¹‰å˜åŒ–ï¼‰ï¼Œåˆ™æ›¿æ¢ if (composed.length &lt; testChars.length || composed !== testChars) { const newText = tempText.substring(0, tempCursorPos - testLength) + composed + tempText.substring(tempCursorPos); const newCursorPos = tempCursorPos - testLength + composed.length; // 4. æ£€æµ‹éŸ©æ–‡å­—ç¬¦æ˜¯å¦å®Œæˆï¼ˆç”¨äºå†å²ä¿å­˜ï¼‰ const hangulCompleted = this.detectHangulCompletion(currentText, newText, newCursorPos); return { text: newText, cursorPosition: newCursorPos, hangulCompleted: hangulCompleted }; } } // 5. æ— æ³•ç»„åˆï¼Œè¿”å›ä¸´æ—¶æ–‡æœ¬ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰éŸ©æ–‡å®Œæˆ const hangulCompleted = this.detectHangulCompletion(currentText, tempText, tempCursorPos); return { text: tempText, cursorPosition: tempCursorPos, hangulCompleted: hangulCompleted }; } // å¤„ç†è¾…éŸ³è¾“å…¥ processConsonant(consonant) { if (!this.currentChosung) { // å¼€å§‹æ–°çš„éŸ³èŠ‚ this.currentChosung = consonant; this.currentJungsung = ''; this.currentJongsung = ''; return consonant; } else if (this.currentJungsung &amp;&amp; !this.currentJongsung) { // æ·»åŠ ç»ˆå£° this.currentJongsung = consonant; return this.combineHangul(this.currentChosung, this.currentJungsung, this.currentJongsung); } else { // å¼€å§‹æ–°çš„éŸ³èŠ‚ const result = this.finalizeCurrent() + consonant; this.currentChosung = consonant; this.currentJungsung = ''; this.currentJongsung = ''; return result; } } // å¤„ç†å…ƒéŸ³è¾“å…¥ processVowel(vowel) { if (this.currentChosung &amp;&amp; !this.currentJungsung) { // æ·»åŠ ä¸­å£° this.currentJungsung = vowel; return this.combineHangul(this.currentChosung, this.currentJungsung); } else if (this.currentChosung &amp;&amp; this.currentJungsung &amp;&amp; this.currentJongsung) { // ç»ˆå£°å˜æˆæ–°éŸ³èŠ‚çš„åˆå£° const result = this.combineHangul(this.currentChosung, this.currentJungsung) + this.combineHangul(this.currentJongsung, vowel); this.currentChosung = this.currentJongsung; this.currentJungsung = vowel; this.currentJongsung = ''; return result; } else { // å¤„ç†å…¶ä»–æƒ…å†µ const result = this.finalizeCurrent() + vowel; this.reset(); return result; } } // å®Œæˆå½“å‰å­—ç¬¦ç»„åˆ finalizeCurrent() { if (this.currentChosung &amp;&amp; this.currentJungsung) { return this.combineHangul(this.currentChosung, this.currentJungsung, this.currentJongsung); } else if (this.currentChosung) { return this.currentChosung; } return ''; } // é‡ç½®çŠ¶æ€ reset() { this.currentChosung = ''; this.currentJungsung = ''; this.currentJongsung = ''; } // ä»å•ä¸ªéŸ©æ–‡å­—ç¬¦æ¢å¤è¾“å…¥çŠ¶æ€ restoreStateFromCharacter(char) { if (!char) { this.reset(); return; } const decomposed = this.decomposeHangul(char); if (decomposed) { // æ˜¯å®Œæ•´çš„éŸ©æ–‡å­—ç¬¦ï¼Œæ¢å¤ç»„åˆçŠ¶æ€ this.currentChosung = decomposed.chosung; this.currentJungsung = decomposed.jungsung; this.currentJongsung = decomposed.jongsung; } else if (this.isConsonant(char)) { // æ˜¯å•ç‹¬çš„è¾…éŸ³ï¼Œè®¾ç½®ä¸ºåˆå£° this.currentChosung = char; this.currentJungsung = ''; this.currentJongsung = ''; } else if (this.isVowel(char)) { // æ˜¯å•ç‹¬çš„å…ƒéŸ³ï¼Œè¿™ç§æƒ…å†µä¸åº”è¯¥å‡ºç°åœ¨æ­£å¸¸çš„éŸ©æ–‡è¾“å…¥ä¸­ // é‡ç½®çŠ¶æ€ this.reset(); } else { // ä¸æ˜¯éŸ©æ–‡å­—ç¬¦ï¼Œé‡ç½®çŠ¶æ€ this.reset(); } } // å¤„ç†é€€æ ¼ - ä½¿ç”¨æ–°çš„decomposeHangulå®ç° handleBackspace(currentText) { if (currentText.length === 0) return ''; const lastChar = currentText[currentText.length - 1]; const decomposed = this.decomposeHangul(lastChar); // æ£€æŸ¥æ˜¯å¦ä¸ºéŸ©æ–‡å­—ç¬¦ï¼ˆé€šè¿‡åˆ†è§£ç»“æœé•¿åº¦åˆ¤æ–­ï¼‰ if (decomposed.length &gt; 1) { // æ˜¯éŸ©æ–‡å­—ç¬¦ï¼ŒæŒ‰ç…§å‚è€ƒé¡¹ç›®çš„é€»è¾‘å¤„ç† const decomposedArray = Array.from(decomposed); if (decomposedArray.length &gt; 1) { // åˆ é™¤æœ€åä¸€ä¸ªå­—ç¬¦éƒ¨ä»¶ï¼Œé‡æ–°ç»„åˆ const remaining = decomposedArray.slice(0, -1).join(''); const recomposed = this.composeHangul(remaining); return currentText.slice(0, -1) + recomposed; } } // ä¸æ˜¯éŸ©æ–‡å­—ç¬¦æˆ–æ— æ³•åˆ†è§£ï¼Œç›´æ¥åˆ é™¤ return currentText.slice(0, -1); } // ç¨‹åºåŒ–å¤„ç†è¾“å…¥ï¼ˆç”¨äºç§»åŠ¨ç«¯è™šæ‹Ÿé”®ç›˜ï¼‰ processInputProgrammatically(key, isShift, currentText, cursorPosition) { const char = this.getCharacter(key, isShift); if (!char) return null; // ä½¿ç”¨smartInsertå‡½æ•°å¤„ç†è¾“å…¥ return this.smartInsert(currentText, cursorPosition, cursorPosition, char); } // === æ–°å¢åŠŸèƒ½ï¼šä¿å­˜æ–‡æœ¬ === // ä¿å­˜æ–‡æœ¬ä¸ºæ–‡ä»¶ saveTextAsFile(text) { if (!text.trim()) { alert(window.languageManager ? window.languageManager.getText('noTextToSave') || 'No text to save!' : 'No text to save!'); return; } try { // åˆ›å»ºBlobå¯¹è±¡ const blob = new Blob([text], { type: 'text/plain;charset=utf-8' }); // åˆ›å»ºä¸‹è½½é“¾æ¥ const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; // ç”Ÿæˆæ–‡ä»¶åï¼ˆåŒ…å«æ—¶é—´æˆ³ï¼‰ const now = new Date(); const timestamp = now.getFullYear() + String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0') + '-' + String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0') + String(now.getSeconds()).padStart(2, '0'); link.download = <code class="language-plaintext highlighter-rouge">korean-text-${timestamp}.txt</code>; // è§¦å‘ä¸‹è½½ document.body.appendChild(link); link.click(); document.body.removeChild(link); // æ¸…ç†URLå¯¹è±¡ URL.revokeObjectURL(url); } catch (e) { console.error('Failed to save file:', e); alert('Failed to save file. Please try again.'); } } // === æ–°å¢åŠŸèƒ½ï¼šå­—ä½“å¤§å°è°ƒæ•´ === // ç®€å•çš„è®¾ç½®ä¿å­˜ saveSettings() { try { const data = { fontSize: this.fontSize }; localStorage.setItem('korean-input-data', JSON.stringify(data)); } catch (e) { console.warn('Failed to save settings to localStorage:', e); } } // ä»localStorageåŠ è½½è®¾ç½® loadSettings() { const savedData = localStorage.getItem('korean-input-data'); if (savedData) { try { const data = JSON.parse(savedData); if (data.fontSize) { this.fontSize = data.fontSize; } } catch (e) { console.warn('Failed to load settings from localStorage:', e); } } } // è·å–å½“å‰å­—ä½“å¤§å° getFontSize() { return this.fontSize; } // è®¾ç½®å­—ä½“å¤§å° setFontSize(size) { this.fontSize = Math.max(12, Math.min(36, size)); // é™åˆ¶åœ¨12-36pxä¹‹é—´ const textarea = document.getElementById('koreanInput'); if (textarea) { textarea.style.fontSize = this.fontSize + 'px'; } this.saveSettings(); // ä¿å­˜å­—ä½“å¤§å°è®¾ç½® return this.fontSize; } // å¢å¤§å­—ä½“ increaseFontSize() { return this.setFontSize(this.fontSize + 2); } // å‡å°å­—ä½“ decreaseFontSize() { return this.setFontSize(this.fontSize - 2); } // åˆå§‹åŒ–å­—ä½“å¤§å° initializeFontSize() { this.loadSettings(); // åŠ è½½ä¿å­˜çš„è®¾ç½® const textarea = document.getElementById('koreanInput'); if (textarea) { textarea.style.fontSize = this.fontSize + 'px'; } } } // DOMåŠ è½½å®Œæˆååˆå§‹åŒ– document.addEventListener('DOMContentLoaded', function() { const koreanInput = new KoreanInput(); const textarea = document.getElementById('koreanInput'); const copyBtn = document.getElementById('copyBtn'); const clearBtn = document.getElementById('clearBtn'); const saveBtn = document.getElementById('saveBtn'); const fontSmallerBtn = document.getElementById('fontSmallerBtn'); const fontLargerBtn = document.getElementById('fontLargerBtn'); // åˆå§‹åŒ–å­—ä½“å¤§å° koreanInput.initializeFontSize(); // åˆå§‹åŒ–è™šæ‹Ÿé”®ç›˜å’Œè¯­è¨€åˆ‡æ¢å™¨ window.virtualKeyboard = new VirtualKeyboard(koreanInput); window.languageSwitcher = new LanguageSwitcher(); // åˆå§‹åŒ–ç•Œé¢è¯­è¨€ window.languageManager.updateUI(); // ä¿®å¤åˆå§‹åŒ–æ—¶åºé—®é¢˜ï¼šç¡®ä¿è™šæ‹Ÿé”®ç›˜çš„å¤šè¯­è¨€æ–‡å­—æ­£ç¡®æ˜¾ç¤º if (window.virtualKeyboard) { // æ›´æ–°åŠŸèƒ½é”®æ–‡å­—ï¼ˆä¿®å¤ç©ºæ ¼é”®æ˜¾ç¤ºé—®é¢˜ï¼‰ window.virtualKeyboard.updateFunctionKeysText(); // å¦‚æœæ˜¯ç§»åŠ¨è®¾å¤‡ä¸”å½“å‰å¤„äºè™šæ‹Ÿé”®ç›˜æ¨¡å¼ï¼Œæ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨ if (window.virtualKeyboard.isMobileDevice &amp;&amp; window.virtualKeyboard.isVirtualKeyboardMode) { window.virtualKeyboard.updateKeyboardStateIndicator(false); } } // é”®ç›˜äº‹ä»¶ç›‘å¬ textarea.addEventListener('keydown', function(e) { // æ£€æŸ¥è¾“å…¥æ¥æºï¼Œå¦‚æœæ˜¯è™šæ‹Ÿé”®ç›˜è¾“å…¥ä¸”åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šï¼Œåˆ™å¿½ç•¥ if (window.virtualKeyboard &amp;&amp; window.virtualKeyboard.inputSource === 'virtual' &amp;&amp; window.virtualKeyboard.isMobileDevice) { return; } if (e.key === 'Backspace') { e.preventDefault(); // è·å–å…‰æ ‡ä½ç½®ä¿¡æ¯ const cursorStart = this.selectionStart; const cursorEnd = this.selectionEnd; if (cursorStart === cursorEnd) { // æ™®é€šåˆ é™¤ï¼šåˆ é™¤å…‰æ ‡å‰çš„ä¸€ä¸ªå­—ç¬¦ if (cursorStart &gt; 0) { const textBefore = this.value.substring(0, cursorStart); const textAfter = this.value.substring(cursorStart); // å¯¹å…‰æ ‡å‰çš„æ–‡æœ¬åº”ç”¨éŸ©æ–‡æ™ºèƒ½é€€æ ¼é€»è¾‘ const newTextBefore = koreanInput.handleBackspace(textBefore); const newText = newTextBefore + textAfter; this.value = newText; // è®¾ç½®æ–°çš„å…‰æ ‡ä½ç½® const newCursorPos = newTextBefore.length; this.setSelectionRange(newCursorPos, newCursorPos); // åŸºäºå…‰æ ‡ä½ç½®æ™ºèƒ½æ¢å¤éŸ©æ–‡è¾“å…¥çŠ¶æ€ if (newCursorPos &gt; 0) { const charBeforeCursor = newText[newCursorPos - 1]; koreanInput.restoreStateFromCharacter(charBeforeCursor); } else { koreanInput.reset(); } } } else { // é€‰åŒºåˆ é™¤ï¼šåˆ é™¤é€‰ä¸­çš„æ–‡æœ¬ const textBefore = this.value.substring(0, cursorStart); const textAfter = this.value.substring(cursorEnd); const newText = textBefore + textAfter; this.value = newText; this.setSelectionRange(cursorStart, cursorStart); // åŸºäºå…‰æ ‡ä½ç½®æ™ºèƒ½æ¢å¤éŸ©æ–‡è¾“å…¥çŠ¶æ€ if (cursorStart &gt; 0) { const charBeforeCursor = newText[cursorStart - 1]; koreanInput.restoreStateFromCharacter(charBeforeCursor); } else { koreanInput.reset(); } } // æ³¨æ„ï¼šè¿™é‡Œä¸å†è°ƒç”¨ koreanInput.reset()ï¼Œå› ä¸ºçŠ¶æ€å·²ç»åœ¨ä¸Šé¢æ™ºèƒ½æ¢å¤äº† return; } if (e.key === ' ') { e.preventDefault(); const cursorStart = this.selectionStart; const textBefore = this.value.substring(0, cursorStart); const textAfter = this.value.substring(this.selectionEnd); this.value = textBefore + ' ' + textAfter; // ç§»åŠ¨å…‰æ ‡åˆ°ç©ºæ ¼ä¹‹å const newCursorPos = cursorStart + 1; this.setSelectionRange(newCursorPos, newCursorPos); // é‡ç½®éŸ©æ–‡è¾“å…¥çŠ¶æ€ koreanInput.reset(); return; } // å¿½ç•¥å…¶ä»–ç‰¹æ®Šé”® if (e.key.length &gt; 1 &amp;&amp; e.key !== 'Shift') return; const char = koreanInput.getCharacter(e.key, e.shiftKey); if (char) { e.preventDefault(); const result = koreanInput.processInput(char); // æ›´æ–°è¾“å…¥æ¡†å†…å®¹ const cursorPos = this.selectionStart; const textBefore = this.value.substring(0, cursorPos); const textAfter = this.value.substring(this.selectionEnd); // å…¨æ–°çš„éŸ©æ–‡è¾“å…¥é€»è¾‘ï¼šæ™ºèƒ½å…‰æ ‡æ’å…¥å¤„ç† const insertResult = koreanInput.smartInsert(this.value, cursorPos, this.selectionEnd, result); // æ›´æ–°æ–‡æœ¬å’Œå…‰æ ‡ä½ç½® this.value = insertResult.text; this.setSelectionRange(insertResult.cursorPosition, insertResult.cursorPosition); } }); // æ·»åŠ è§¦æ‘¸å’Œç„¦ç‚¹äº‹ä»¶ç›‘å¬ï¼ŒåŒºåˆ†è¾“å…¥æ¥æº textarea.addEventListener('touchstart', function(e) { if (window.virtualKeyboard) { window.virtualKeyboard.inputSource = 'touch'; // åŒæ­¥è™šæ‹Ÿå…‰æ ‡ä½ç½® setTimeout(() =&gt; { window.virtualKeyboard.syncVirtualCursor(); }, 50); } }); textarea.addEventListener('mousedown', function(e) { if (window.virtualKeyboard) { window.virtualKeyboard.inputSource = 'mouse'; // åŒæ­¥è™šæ‹Ÿå…‰æ ‡ä½ç½® setTimeout(() =&gt; { window.virtualKeyboard.syncVirtualCursor(); }, 50); } }); textarea.addEventListener('focus', function(e) { if (window.virtualKeyboard) { // å¦‚æœæ˜¯è™šæ‹Ÿé”®ç›˜æ“ä½œå¯¼è‡´çš„ç„¦ç‚¹ï¼Œç«‹å³å¤±ç„¦ if (window.virtualKeyboard.isMobileDevice &amp;&amp; window.virtualKeyboard.isVirtualKeyboardMode) { e.preventDefault(); this.blur(); return false; } // å¦‚æœæ˜¯ç§»åŠ¨è®¾å¤‡ä¸”è¾“å…¥æºä¸æ˜¯è™šæ‹Ÿé”®ç›˜ï¼Œå…è®¸ç³»ç»Ÿé”®ç›˜å¼¹å‡º if (window.virtualKeyboard.isMobileDevice &amp;&amp; window.virtualKeyboard.inputSource !== 'virtual') { // æ­£å¸¸çš„ç„¦ç‚¹è¡Œä¸ºï¼Œå…è®¸ç³»ç»Ÿé”®ç›˜å¼¹å‡º window.virtualKeyboard.syncVirtualCursor(); } } koreanInput.reset(); }); // ç›‘å¬è‡ªå®šä¹‰è™šæ‹Ÿè¾“å…¥äº‹ä»¶ textarea.addEventListener('virtualinput', function(e) { // å¤„ç†è™šæ‹Ÿè¾“å…¥äº‹ä»¶ï¼Œè¿™é‡Œå¯ä»¥æ·»åŠ é¢å¤–çš„å¤„ç†é€»è¾‘ // ä¾‹å¦‚æ›´æ–°å…¶ä»–UIå…ƒç´ ç­‰ }); // ç›‘å¬å…‰æ ‡ä½ç½®å˜åŒ–ï¼ˆselectionchangeäº‹ä»¶ï¼‰ document.addEventListener('selectionchange', function() { if (window.virtualKeyboard &amp;&amp; document.activeElement === textarea) { // ç”¨æˆ·ç›´æ¥åœ¨textareaä¸­ç§»åŠ¨äº†å…‰æ ‡ï¼ŒåŒæ­¥è™šæ‹Ÿå…‰æ ‡ if (!window.virtualKeyboard.isVirtualKeyboardMode) { window.virtualKeyboard.syncVirtualCursor(); } } }); // ç›‘å¬æ–‡æœ¬é€‰æ‹©å˜åŒ–ï¼ˆå…¼å®¹æ€§æ›´å¥½çš„æ–¹å¼ï¼‰ textarea.addEventListener('selectionchange', function() { if (window.virtualKeyboard &amp;&amp; !window.virtualKeyboard.isVirtualKeyboardMode) { window.virtualKeyboard.syncVirtualCursor(); } }); // ç›‘å¬é”®ç›˜äº‹ä»¶åŒæ­¥å…‰æ ‡ï¼ˆç”¨æˆ·ç›´æ¥ä½¿ç”¨ç‰©ç†é”®ç›˜æ—¶ï¼‰ textarea.addEventListener('keyup', function(e) { if (window.virtualKeyboard &amp;&amp; !window.virtualKeyboard.isVirtualKeyboardMode) { window.virtualKeyboard.syncVirtualCursor(); } }); // å¤åˆ¶åŠŸèƒ½ copyBtn.addEventListener('click', function() { textarea.select(); document.execCommand('copy'); // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤ºï¼ˆå¤šè¯­è¨€æ”¯æŒï¼‰ const originalText = this.textContent; this.textContent = window.languageManager.getText('copiedMsg'); setTimeout(() =&gt; { this.textContent = originalText; }, 1000); }); // æ¸…ç©ºåŠŸèƒ½ clearBtn.addEventListener('click', function() { textarea.value = ''; koreanInput.reset(); window.virtualKeyboard.reset(); textarea.focus(); }); // ä¿å­˜æ–‡æœ¬åŠŸèƒ½ saveBtn.addEventListener('click', function() { koreanInput.saveTextAsFile(textarea.value); textarea.focus(); }); // ç¼©å°å­—ä½“åŠŸèƒ½ fontSmallerBtn.addEventListener('click', function() { koreanInput.decreaseFontSize(); textarea.focus(); }); // æ”¾å¤§å­—ä½“åŠŸèƒ½ fontLargerBtn.addEventListener('click', function() { koreanInput.increaseFontSize(); textarea.focus(); }); // ç‚¹å‡»äº‹ä»¶é‡ç½®çŠ¶æ€å’ŒåŒæ­¥å…‰æ ‡ textarea.addEventListener('click', function() { koreanInput.reset(); // è®¾ç½®è¾“å…¥æºä¸ºç›´æ¥è¾“å…¥ if (window.virtualKeyboard) { window.virtualKeyboard.inputSource = 'direct'; // åŒæ­¥è™šæ‹Ÿå…‰æ ‡ä½ç½® window.virtualKeyboard.syncVirtualCursor(); } }); });

</p>

<p>ì¢‹ì•„. ë„¤ ì½”ë“œì— â€œíŠ¹ì • í‚¤ë¡œ í•œ/ì˜ ì „í™˜â€ì„ ë¶™ì´ë ¤ë©´, ì…ë ¥ íŒŒì´í”„ë¼ì¸ì˜ ë§¨ ì•ì— IME ëª¨ë“œ ìƒíƒœ(ko/en)ë¥¼ ë‘ê³ , ë‹¨ì¶•í‚¤ë¡œ ê·¸ ê°’ì„ í† ê¸€í•˜ë©´ ë¼. koì¼ ë•Œë§Œ ì§€ê¸ˆì˜ í•œê¸€ ì¡°í•© ë¡œì§ì„ ì‹¤í–‰í•˜ê³ , enì¼ ë•ŒëŠ” ë¸Œë¼ìš°ì € ê¸°ë³¸ ì…ë ¥ì„ ê·¸ëŒ€ë¡œ í†µê³¼ì‹œí‚¤ë©´ ëœë‹¤. ì•„ë˜ëŠ” ë„¤ê°€ ì˜¬ë¦° ì†ŒìŠ¤ì— ìµœì†Œ ì¹¨ìŠµìœ¼ë¡œ ì¶”ê°€/ë³€ê²½í•´ì•¼ í•  ë¶€ë¶„ë§Œ ë‹¨ê³„ë³„ë¡œ ì •ë¦¬í•œ ê±°ì•¼.</p>

<h1 id="1-koreaninput-í´ë˜ìŠ¤ì—-ëª¨ë“œ-ìƒíƒœì™€-api-ì¶”ê°€">1) KoreanInput í´ë˜ìŠ¤ì— ëª¨ë“œ ìƒíƒœì™€ API ì¶”ê°€</h1>

<p>ìƒì„±ìì— ëª¨ë“œ ìƒíƒœë¥¼ ë„£ê³  ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥Â·ë³µì›í•˜ë„ë¡ í•´. ê·¸ë¦¬ê³  í† ê¸€/ì„¤ì • ë©”ì„œë“œë¥¼ ì¶”ê°€.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

class KoreanInput {
    constructor() {
        // ... ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ ...

        // IME ëª¨ë“œ: 'ko' | 'en'
        this.mode = (localStorage.getItem('imeMode') === 'en') ? 'en' : 'ko';
    }

    setMode(mode) {
        this.mode = (mode === 'en') ? 'en' : 'ko';
        localStorage.setItem('imeMode', this.mode);
        // ëª¨ë“œì— ë”°ë¼ ìƒíƒœ ì´ˆê¸°í™”ê°€ í•„ìš”í•˜ë©´ ì—¬ê¸°ì„œ ì²˜ë¦¬
        if (this.mode === 'en') this.reset();
    }

    toggleMode() {
        this.setMode(this.mode === 'ko' ? 'en' : 'ko');
        // ëª¨ë“œ í‘œì‹œ UIê°€ ìˆë‹¤ë©´ ì—¬ê¸°ì„œ ê°±ì‹ 
        const chip = document.getElementById('imeMode');
        if (chip) {
            chip.textContent = (this.mode === 'ko') ? 'KO' : 'EN';
            chip.setAttribute('data-mode', this.mode);
        }
    }
    
    // ... ë‚˜ë¨¸ì§€ ë©”ì„œë“œ ê·¸ëŒ€ë¡œ ...
}
</code></pre></div></div>

<p>ì„ íƒ ì‚¬í•­: ëª¨ë“œ ìƒíƒœë¥¼ í™”ë©´ì— í‘œì‹œí•˜ê³  ì‹¶ë‹¤ë©´ HTMLì— ì‘ì€ ì¹©ì„ í•˜ë‚˜ ë‘ë©´ ì¢‹ì•„.</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"ime-status"</span><span class="nt">&gt;&lt;span</span> <span class="na">id=</span><span class="s">"imeMode"</span><span class="nt">&gt;</span>KO<span class="nt">&lt;/span&gt;&lt;/div&gt;</span>
</code></pre></div></div>

<p>ì´ˆê¸°í™” ì‹œì ì— í•œë²ˆ ë™ê¸°í™”:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// DOMContentLoaded ë‚´ë¶€
const chip = document.getElementById('imeMode');
if (chip) {
    chip.textContent = (koreanInput.mode === 'ko') ? 'KO' : 'EN';
    chip.setAttribute('data-mode', koreanInput.mode);
}
</code></pre></div></div>

<h1 id="2-ë‹¨ì¶•í‚¤-ì •ì˜-ctrlspace-ë˜ëŠ”-f2">2) ë‹¨ì¶•í‚¤ ì •ì˜: Ctrl+Space ë˜ëŠ” F2</h1>

<p>OS ë‹¨ì¶•í‚¤ì™€ ì¶©ëŒ ê°€ëŠ¥ì„±ì„ ì¤„ì´ë ¤ê³  F2ë„ í•¨ê»˜ ì§€ì›í•˜ì.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

function isToggleHotkey(e) {
    // Ctrl+Space ë˜ëŠ” F2
    return (e.ctrlKey &amp;&amp; !e.shiftKey &amp;&amp; !e.altKey &amp;&amp; e.code === 'Space') || (e.code === 'F2');
}
</code></pre></div></div>

<h1 id="3-keydown-í•¸ë“¤ëŸ¬ë¥¼-ëª¨ë“œ-ê¸°ë°˜ìœ¼ë¡œ-ë¶„ê¸°">3) keydown í•¸ë“¤ëŸ¬ë¥¼ ëª¨ë“œ ê¸°ë°˜ìœ¼ë¡œ ë¶„ê¸°</h1>

<p>ì§€ê¸ˆ keydownì€ Backspace, Space, ì¼ë°˜ ë¬¸ì ë“±ì„ ëª¨ë‘ ê°€ë¡œì±„ì„œ í•œê¸€ ì¡°í•©ìœ¼ë¡œ ë„£ê³  ìˆì–´. ì´ ë¡œì§ì„ â€œkoì¼ ë•Œë§Œâ€ ì‹¤í–‰í•˜ë„ë¡ ê°ì‹¸ê³ , â€œenì¼ ë•ŒëŠ”â€ ë¸Œë¼ìš°ì € ê¸°ë³¸ ì…ë ¥ì„ ê·¸ëŒ€ë¡œ íë¥´ê²Œ ë‘ë©´ ëœë‹¤. ì¦‰, ê¸°ì¡´ì˜ <code class="language-plaintext highlighter-rouge">preventDefault()</code>ë“¤ì„ ko ëª¨ë“œì—ì„œë§Œ ìˆ˜í–‰í•˜ê²Œ ë§Œë“œëŠ” ê²Œ í•µì‹¬.</p>

<p>ì•„ë˜ëŠ” ë„¤ keydown ë¦¬ìŠ¤ë„ˆì˜ í•µì‹¬ ë¶€ë¶„ì„ ì•ˆì „í•˜ê²Œ ë°”ê¾¼ ë²„ì „ì´ì•¼. ë°”ë€ ì¤„ì— ì£¼ì„ì„ ë‹¬ì•„ë†¨ë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

textarea.addEventListener('keydown', function(e) {
    // ê°€ìƒí‚¤ë³´ë“œ ì…ë ¥ í†µê³¼ ë¡œì§ì€ ê·¸ëŒ€ë¡œ
    if (window.virtualKeyboard &amp;&amp; window.virtualKeyboard.inputSource === 'virtual' &amp;&amp; window.virtualKeyboard.isMobileDevice) {
        return;
    }

    // 1) í•œ/ì˜ í† ê¸€ ë‹¨ì¶•í‚¤
    if (isToggleHotkey(e)) {
        e.preventDefault();
        koreanInput.toggleMode();
        return;
    }

    // 2) EN ëª¨ë“œ: ë¸Œë¼ìš°ì € ê¸°ë³¸ ì…ë ¥ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    if (koreanInput.mode === 'en') {
        return; // ì–´ë–¤ í‚¤ë„ ê°€ë¡œì±„ì§€ ì•ŠìŒ
    }

    // 3) KO ëª¨ë“œ: ê¸°ì¡´ í•œê¸€ ì¡°í•© ë¡œì§ ì‹¤í–‰
    if (e.key === 'Backspace') {
        e.preventDefault();

        const cursorStart = this.selectionStart;
        const cursorEnd = this.selectionEnd;

        if (cursorStart === cursorEnd) {
            if (cursorStart &gt; 0) {
                const textBefore = this.value.substring(0, cursorStart);
                const textAfter = this.value.substring(cursorStart);
                const newTextBefore = koreanInput.handleBackspace(textBefore);
                const newText = newTextBefore + textAfter;

                this.value = newText;

                const newCursorPos = newTextBefore.length;
                this.setSelectionRange(newCursorPos, newCursorPos);

                if (newCursorPos &gt; 0) {
                    const charBeforeCursor = newText[newCursorPos - 1];
                    koreanInput.restoreStateFromCharacter(charBeforeCursor);
                } else {
                    koreanInput.reset();
                }
            }
        } else {
            const textBefore = this.value.substring(0, cursorStart);
            const textAfter = this.value.substring(cursorEnd);
            const newText = textBefore + textAfter;

            this.value = newText;
            this.setSelectionRange(cursorStart, cursorStart);

            if (cursorStart &gt; 0) {
                const charBeforeCursor = newText[cursorStart - 1];
                koreanInput.restoreStateFromCharacter(charBeforeCursor);
            } else {
                koreanInput.reset();
            }
        }
        return;
    }

    if (e.key === ' ') {
        e.preventDefault();

        const cursorStart = this.selectionStart;
        const textBefore = this.value.substring(0, cursorStart);
        const textAfter = this.value.substring(this.selectionEnd);

        this.value = textBefore + ' ' + textAfter;

        const newCursorPos = cursorStart + 1;
        this.setSelectionRange(newCursorPos, newCursorPos);

        koreanInput.reset();
        return;
    }

    // íŠ¹ìˆ˜í‚¤ ë¬´ì‹œ(Shift ë“±)
    if (e.key.length &gt; 1 &amp;&amp; e.key !== 'Shift') return;

    const char = koreanInput.getCharacter(e.key, e.shiftKey);
    if (char) {
        e.preventDefault();
        const result = koreanInput.processInput(char);

        const cursorPos = this.selectionStart;
        const insertResult = koreanInput.smartInsert(this.value, cursorPos, this.selectionEnd, result);

        this.value = insertResult.text;
        this.setSelectionRange(insertResult.cursorPosition, insertResult.cursorPosition);
        return;
    }

    // ë§¤í•‘ë˜ì§€ ì•Šì€ í‚¤ëŠ” KO ëª¨ë“œì—ì„œë„ í†µê³¼ì‹œí‚¬ì§€, ë§‰ì„ì§€ ì •ì±… ê²°ì •
    // í•„ìš”í•˜ë©´ ì•„ë˜ì—ì„œ e.preventDefault()ë¥¼ ì œê±°í•˜ê±°ë‚˜ ì¶”ê°€
});
</code></pre></div></div>

<p>í•µì‹¬ í¬ì¸íŠ¸</p>

<ol>
  <li>
    <p>í† ê¸€ ë‹¨ì¶•í‚¤ë¥¼ ê°€ì¥ ë¨¼ì € ì²˜ë¦¬í•´ ì¦‰ì‹œ ëª¨ë“œë¥¼ ë°”ê¾¼ë‹¤.</p>
  </li>
  <li>
    <p>en ëª¨ë“œì—ì„œëŠ” ì•„ë¬´ê²ƒë„ ê°€ë¡œì±„ì§€ ì•ŠëŠ”ë‹¤. Backspace/Space/ì¼ë°˜ ë¬¸ì í¬í•¨ ì „ë¶€ ë¸Œë¼ìš°ì € ê¸°ë³¸ ë™ì‘.</p>
  </li>
  <li>
    <p>ko ëª¨ë“œì¼ ë•Œë§Œ ê¸°ì¡´ í•œê¸€ ì¡°í•© ë¡œì§ì´ ì‹¤í–‰ëœë‹¤.</p>
  </li>
</ol>

<h1 id="4-ëª¨ë°”ì¼ê°€ìƒí‚¤ë³´ë“œì™€-ë™ê¸°í™”ì„ íƒ">4) ëª¨ë°”ì¼Â·ê°€ìƒí‚¤ë³´ë“œì™€ ë™ê¸°í™”(ì„ íƒ)</h1>

<p>í™”ë©´ í‚¤ë³´ë“œì—ë„ í•œ/ì˜ í‚¤ë¥¼ ë‹¬ì•˜ë‹¤ë©´, ê·¸ ë²„íŠ¼ í´ë¦­ ì‹œ <code class="language-plaintext highlighter-rouge">koreanInput.toggleMode()</code>ë¥¼ í˜¸ì¶œí•´ì£¼ë©´ ëœë‹¤. ì˜ˆì‹œ:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// virtual-keyboard.jsì—ì„œ
buttonHanEng.addEventListener('click', () =&gt; {
    if (window.koreanInput) window.koreanInput.toggleMode();
});
</code></pre></div></div>

<h1 id="5-ì‚¬ìš©ì„±-íŒ">5) ì‚¬ìš©ì„± íŒ</h1>

<p>ë‹¨ì¶•í‚¤ëŠ” Ctrl+Spaceê°€ OS ë ˆë²¨ì—ì„œ ë¨¼ì € ë¨¹ì„ ìˆ˜ ìˆë‹¤. ê·¸ëŸ´ ë•Œë¥¼ ëŒ€ë¹„í•´ F2 ê°™ì€ ëŒ€ì²´ í‚¤ë¥¼ í•¨ê»˜ ë‘ëŠ” ê²Œ ì•ˆì „í•˜ë‹¤. ëª¨ë“œ ì¹©ì„ í‘œì‹œí•˜ë©´ ì‚¬ìš©ì í˜¼ë€ë„ ì¤„ì–´ë“ ë‹¤.</p>

<p>ì´ë ‡ê²Œ ë¶™ì´ë©´, ì‚¬ì´íŠ¸ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ë©´ì„œë„ íŠ¹ì • í‚¤ë¡œ í•œ/ì˜ ëª¨ë“œë¥¼ ì „í™˜í•  ìˆ˜ ìˆì–´. ë” ë¹¡ë¹¡í•˜ê²Œ í†µì œí•˜ê³  ì‹¶ë‹¤ë©´ en ëª¨ë“œì¼ ë•Œë„ ì¼ë¶€ í‚¤(ì˜ˆ: Backspaceë§Œ)ëŠ” ê°€ë¡œì±„ì„œ ë„ˆì˜ selection ê´€ë¦¬ ë¡œì§ì— ë§ì¶”ëŠ” ì‹ìœ¼ë¡œ ì„¸ë¶„í™”í•  ìˆ˜ ìˆë‹¤.</p>

<p class="chat--user">

imeë¼ê³  í•˜ë‹ˆê¹Œ ì¢€ í—·ê°ˆë¦¬ëŠ”ë° osì˜ imeë‘ì€ ì „í˜€ ìƒê´€ì—†ëŠ”ê±°ì§€?

</p>

<p>ë§ì•„. ì—¬ê¸°ì„œ ë§í•˜ëŠ” ê±´ OSì˜ í•œê¸€ ì…ë ¥ê¸°(IME)ë‘ ì „í˜€ ë³„ê°œì•¼. ë„¤ ì½”ë“œëŠ” â€œí˜ì´ì§€ ì•ˆì—ì„œ í‚¤ ì´ë²¤íŠ¸ë¥¼ ë°›ì•„ ì˜â†’í•œìœ¼ë¡œ ì¡°í•©í•´ ë„£ëŠ” ìë°”ìŠ¤í¬ë¦½íŠ¸ ì…ë ¥ê¸°â€ì¼ ë¿, ìš´ì˜ì²´ì œì˜ IME ìƒíƒœë¥¼ ë°”ê¾¸ê±°ë‚˜ ì½ì„ ìˆ˜ ì—†ì–´.</p>

<h2 id="ë­ê°€-ì–´ë–»ê²Œ-ë‹¤ë¥¸ê°€">ë­ê°€ ì–´ë–»ê²Œ ë‹¤ë¥¸ê°€</h2>

<ul>
  <li>
    <p>OS IME: ì‹œìŠ¤í…œ ì „ì—­. ì•±Â·ë¸Œë¼ìš°ì € ì–´ë””ì„œë‚˜ ì ìš©. ë‹¨ì¶•í‚¤(ì˜ˆ: ìœˆë„ìš°/ë§¥ í•œì˜ ì „í™˜)ë¡œ í† ê¸€ë˜ê³ , ë¸Œë¼ìš°ì €ê°€ ì œì–´ ëª» í•¨.</p>
  </li>
  <li>
    <p>ë„¤ JS ì…ë ¥ê¸°: íŠ¹ì • <code class="language-plaintext highlighter-rouge">textarea</code>ì—ì„œë§Œ ë™ì‘. <code class="language-plaintext highlighter-rouge">keydown</code>ì„ ê°€ë¡œì±„ì„œ ìëª¨ ë§¤í•‘â†’ì¡°í•© ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ í…ìŠ¤íŠ¸ë¥¼ â€œë„£ì–´ì¤„â€ ë¿. í˜ì´ì§€ ë°–ì—ëŠ” ì˜í–¥ ì—†ìŒ.</p>
  </li>
</ul>

<h2 id="í•¨ê»˜-ì¼œì¡Œì„-ë•Œì˜-ìƒí˜¸ì‘ìš©">í•¨ê»˜ ì¼œì¡Œì„ ë•Œì˜ ìƒí˜¸ì‘ìš©</h2>

<ul>
  <li>
    <p>OS IMEê°€ â€œí•œê¸€â€ë¡œ ì¼œì ¸ ìˆìœ¼ë©´ ë¸Œë¼ìš°ì €ê°€ ì´ë¯¸ ì¡°í•©ì„ ìˆ˜í–‰í•˜ë¯€ë¡œ, ë„ˆì˜ JS ì¡°í•©ê³¼ ì¶©ëŒí•˜ê±°ë‚˜ ì´ì¤‘ ì…ë ¥ì²˜ëŸ¼ ë³´ì¼ ìˆ˜ ìˆë‹¤.</p>
  </li>
  <li>
    <p>OS ë‹¨ì¶•í‚¤(Ctrl+Space ë“±)ëŠ” OSê°€ ë¨¼ì € ë¨¹ì„ ìˆ˜ ìˆì–´, ë„ˆì˜ í˜ì´ì§€ì— <code class="language-plaintext highlighter-rouge">keydown</code>ì´ ì•„ì˜ˆ ì•ˆ ì˜¤ê¸°ë„ í•œë‹¤.</p>
  </li>
</ul>

<h2 id="ì•ˆì „í•˜ê²Œ-ì“°ëŠ”-ê°€ë“œê°•ë ¥-ì¶”ì²œ">ì•ˆì „í•˜ê²Œ ì“°ëŠ” ê°€ë“œ(ê°•ë ¥ ì¶”ì²œ)</h2>

<p>OS IMEë¡œ ì‹¤ì œ ì¡°í•© ì¤‘ì¼ ë•ŒëŠ” ì´ë²¤íŠ¸ì— <code class="language-plaintext highlighter-rouge">isComposing</code> í”Œë˜ê·¸ê°€ ì„ ë‹¤. ì´ë•ŒëŠ” ë„¤ ì»¤ìŠ¤í…€ ì¡°í•©ì„ ë„ë©´ ì¶©ëŒì´ ì‚¬ë¼ì§„ë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

textarea.addEventListener('keydown', (e) =&gt; {
  // OS IME ì¡°í•© ì¤‘ì´ê±°ë‚˜ IMEê°€ 'Process' í‚¤ë¥¼ ë³´ë‚¼ ë• ê±´ë“œë¦¬ì§€ ì•ŠìŒ
  if (e.isComposing || e.key === 'Process') return;

  // ë„¤ â€˜í•œ/ì˜ ëª¨ë“œâ€™ í† ê¸€
  if (isToggleHotkey(e)) { e.preventDefault(); koreanInput.toggleMode(); return; }

  // EN ëª¨ë“œë©´ ê¸°ë³¸ ì…ë ¥ í†µê³¼
  if (koreanInput.mode === 'en') return;

  // KO ëª¨ë“œë©´ ê¸°ì¡´ ì»¤ìŠ¤í…€ ì¡°í•© ë¡œì§ ì‹¤í–‰
  // â€¦(ì§€ê¸ˆ ê°–ê³  ìˆëŠ” ë¡œì§)
});
</code></pre></div></div>

<p>ì¶”ê°€ë¡œ, ì¶©ëŒ ê°€ëŠ¥ì„±ì„ ë” ë‚®ì¶”ë ¤ë©´ ì…ë ¥ì°½ ì†ì„±ì„ ì´ë ‡ê²Œ ì„¸íŒ…í•´ ë‘¬:</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;textarea</span> <span class="na">id=</span><span class="s">"koreanInput"</span>
  <span class="na">autocomplete=</span><span class="s">"off"</span> <span class="na">autocapitalize=</span><span class="s">"off"</span> <span class="na">autocorrect=</span><span class="s">"off"</span> <span class="na">spellcheck=</span><span class="s">"false"</span><span class="nt">&gt;&lt;/textarea&gt;</span>
</code></pre></div></div>

<p>(IME ìì²´ë¥¼ ë„ì§„ ëª»í•˜ì§€ë§Œ, ìë™ êµì •/ì² ì êµì • ê°™ì€ ë¸Œë¼ìš°ì € ë ˆì´ì–´ ê°„ì„­ì„ ì¤„ì—¬ì¤€ë‹¤.)</p>

<h2 id="ëª¨ë°”ì¼ì—ì„œì˜-ì°¨ì´">ëª¨ë°”ì¼ì—ì„œì˜ ì°¨ì´</h2>

<ul>
  <li>ëª¨ë°”ì¼ ì†Œí”„íŠ¸ í‚¤ë³´ë“œëŠ” ë¬¼ë¦¬ í‚¤ ì´ë²¤íŠ¸ê°€ ì œí•œì ì´ë¼ JS ì¡°í•©ê¸°ë¡œë§Œ ì²˜ë¦¬í•˜ê¸° ì–´ë µë‹¤. í™”ë©´ì— â€œí•œ/ì˜ í† ê¸€â€ ë²„íŠ¼ì„ ë³„ë„ë¡œ ì œê³µí•´ <code class="language-plaintext highlighter-rouge">toggleMode()</code>ë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ëŠ” ì‹ì´ ì•ˆì •ì ì´ë‹¤.</li>
</ul>

<h2 id="ìš©ì–´-ì •ë¦¬í—·ê°ˆë¦¼-ë°©ì§€">ìš©ì–´ ì •ë¦¬(í—·ê°ˆë¦¼ ë°©ì§€)</h2>

<ul>
  <li>
    <p>â€œOS IMEâ€ëŠ” ê·¸ëŒ€ë¡œ IME.</p>
  </li>
  <li>
    <p>ë„¤ ìª½ì€ â€œì¸í˜ì´ì§€ í•œê¸€ ì¡°í•©ê¸°â€, â€œì»¤ìŠ¤í…€ ì…ë ¥ê¸°â€, í˜¹ì€ UIìƒ â€œKO/EN ëª¨ë“œâ€ì²˜ëŸ¼ ë¶€ë¥´ëŠ” ê²Œ ëª…í™•í•˜ë‹¤.</p>
  </li>
</ul>

<h2 id="í˜„ì‹¤ì ì¸-ìš´ìš©-íŒ">í˜„ì‹¤ì ì¸ ìš´ìš© íŒ</h2>

<ul>
  <li>
    <p>í˜ì´ì§€ ì–´ë”˜ê°€ì— í˜„ì¬ ëª¨ë“œ ì¹©(KO/EN)ì„ í‘œì‹œí•˜ê³ , ì²˜ìŒì—” â€œOS í•œê¸€ ì…ë ¥ì€ êº¼ ì£¼ì„¸ìš”â€ ê°™ì€ ì•ˆë‚´ë¥¼ ë³´ì—¬ì£¼ë©´ ì‚¬ìš©ì í˜¼ë€ì´ í¬ê²Œ ì¤„ì–´ë“ ë‹¤.</p>
  </li>
  <li>
    <p>ë‹¨ì¶•í‚¤ëŠ” OSì™€ ì¶©ëŒ ê°€ëŠ¥í•œ Ctrl+Space ì™¸ì— F2/RightAlt ë“± ëŒ€ì²´ í‚¤ë¥¼ í•¨ê»˜ ë‘ëŠ” ê²Œ ì¢‹ë‹¤.</p>
  </li>
</ul>

<p>ì´ë ‡ê²Œ <code class="language-plaintext highlighter-rouge">isComposing</code> ê°€ë“œì™€ ëª¨ë“œ í‘œê¸°ë¥¼ ë¶™ì´ë©´, OS IMEì™€ ì™„ì „íˆ ë…ë¦½ì ìœ¼ë¡œ ë™ì‘í•˜ë©´ì„œë„ ì¶©ëŒì„ ìµœì†Œí™”í•  ìˆ˜ ìˆë‹¤.</p>

<p class="chat--user">

ëª¨ë“  í…ìŠ¤íŠ¸ ì—ë¦¬ì•„ì— ì´ ê¸°ëŠ¥ì„ ë„£ê³  ì‹¶ì–´ ê·¸ë¦¬ê³  ë„ˆê°€ ë§í•œ ëŒ€ë¡œ í˜ì´ì§€ì— í˜„ì¬ ëª¨ë“œë¥¼ ì•„ì´ì½˜ìœ¼ë¡œ ë³´ì—¬ì£¼ê³  ì‹¶ì–´

</p>

<p>ì¢‹ë‹¤â€”ì´ì œ â€œí˜ì´ì§€ì˜ ëª¨ë“  <code class="language-plaintext highlighter-rouge">&lt;textarea&gt;</code>ì— í•œ/ì˜ ì „í™˜í˜• í•œê¸€ ì¡°í•©ê¸°â€ë¥¼ ë¶™ì´ê³ , í™”ë©´ êµ¬ì„ì— <strong>ëª¨ë“œ ì•„ì´ì½˜(KO/EN)</strong> ì„ ë„ì›Œì„œ ì „ì—­ ìƒíƒœë¥¼ ë³´ì—¬ì£¼ì. í•µì‹¬ì€ ì „ì—­ ëª¨ë“œ ìƒíƒœ(ko/en) + ê³µìš© <code class="language-plaintext highlighter-rouge">KoreanInput</code> ì¸ìŠ¤í„´ìŠ¤ + ëª¨ë“  í…ìŠ¤íŠ¸ì—ë¦¬ì•„ì— ë™ì¼í•œ í‚¤ í•¸ë“¤ëŸ¬ë¥¼ ë¶™ì´ëŠ” ê±°ì•¼. ë™ì ìœ¼ë¡œ ì¶”ê°€ë˜ëŠ” textareaë„ <code class="language-plaintext highlighter-rouge">MutationObserver</code>ë¡œ ì»¤ë²„í•˜ì.</p>

<p>ì•„ë˜ëŠ” ë„¤ í˜„ì¬ êµ¬ì¡°ë¥¼ ìµœëŒ€í•œ ìœ ì§€í•˜ë©´ì„œ â€œì „ì—­ ì ìš©â€ê³¼ â€œì•„ì´ì½˜ í‘œì‹œâ€ë¥¼ ì¶”ê°€í•œ ì½”ë“œ ì„¸íŠ¸ì•¼.</p>

<hr />

<h1 id="1-ëª¨ë“œ-ì•„ì´ì½˜-ui-ì¶”ê°€-html--css">1) ëª¨ë“œ ì•„ì´ì½˜ UI ì¶”ê°€ (HTML + CSS)</h1>

<p>í˜ì´ì§€ ê³µí†µ ìœ„ì¹˜(ìš°í•˜ë‹¨)ì— ì‘ê²Œ ë–  ìˆëŠ” ì¹©ì„ ë§Œë“ ë‹¤.</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- body ëë‚˜ê¸° ì§ì „(footer ìœ„ë‚˜ ì•„ë˜)ì— ì¶”ê°€ --&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"imeBadge"</span> <span class="na">class=</span><span class="s">"ime-badge"</span> <span class="na">aria-live=</span><span class="s">"polite"</span> <span class="na">title=</span><span class="s">"Ctrl+Space ë˜ëŠ” F2ë¡œ ì „í™˜"</span><span class="nt">&gt;&lt;/div&gt;</span>
</code></pre></div></div>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/* style.cssì— ì¶”ê°€ */</span>
<span class="nc">.ime-badge</span><span class="p">{</span>
  <span class="nl">position</span><span class="p">:</span> <span class="nb">fixed</span><span class="p">;</span>
  <span class="nl">right</span><span class="p">:</span> <span class="m">16px</span><span class="p">;</span>
  <span class="nl">bottom</span><span class="p">:</span> <span class="m">16px</span><span class="p">;</span>
  <span class="nl">z-index</span><span class="p">:</span> <span class="m">9999</span><span class="p">;</span>
  <span class="nl">min-width</span><span class="p">:</span> <span class="m">36px</span><span class="p">;</span>
  <span class="nl">padding</span><span class="p">:</span> <span class="m">6px</span> <span class="m">10px</span><span class="p">;</span>
  <span class="nl">border-radius</span><span class="p">:</span> <span class="m">16px</span><span class="p">;</span>
  <span class="nl">border</span><span class="p">:</span> <span class="m">1px</span> <span class="nb">solid</span> <span class="n">currentColor</span><span class="p">;</span>
  <span class="nl">font</span><span class="p">:</span> <span class="m">12px</span><span class="o">/</span><span class="m">1.2</span> <span class="n">system-ui</span><span class="p">,</span> <span class="nb">sans-serif</span><span class="p">;</span>
  <span class="nl">text-align</span><span class="p">:</span> <span class="nb">center</span><span class="p">;</span>
  <span class="nl">opacity</span><span class="p">:</span> <span class="m">.8</span><span class="p">;</span>
  <span class="nl">background</span><span class="p">:</span> <span class="nf">rgba</span><span class="p">(</span><span class="m">255</span><span class="p">,</span><span class="m">255</span><span class="p">,</span><span class="m">255</span><span class="p">,</span><span class="m">.85</span><span class="p">);</span>
  <span class="py">backdrop-filter</span><span class="p">:</span> <span class="nf">blur</span><span class="p">(</span><span class="m">6px</span><span class="p">);</span>
  <span class="nl">cursor</span><span class="p">:</span> <span class="nb">default</span><span class="p">;</span>
  <span class="py">user-select</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.ime-badge</span><span class="o">[</span><span class="nt">data-mode</span><span class="o">=</span><span class="s1">"ko"</span><span class="o">]</span><span class="nd">::after</span><span class="p">{</span> <span class="nl">content</span><span class="p">:</span> <span class="s1">"KO"</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.ime-badge</span><span class="o">[</span><span class="nt">data-mode</span><span class="o">=</span><span class="s1">"en"</span><span class="o">]</span><span class="nd">::after</span><span class="p">{</span> <span class="nl">content</span><span class="p">:</span> <span class="s1">"EN"</span><span class="p">;</span> <span class="p">}</span>

<span class="c">/* textarea ê¸°ë³¸ ì˜µì…˜(ê¶Œì¥) */</span>
<span class="nt">textarea</span><span class="p">{</span>
  <span class="py">autocomplete</span><span class="p">:</span> <span class="n">off</span><span class="p">;</span>
  <span class="py">autocapitalize</span><span class="p">:</span> <span class="n">off</span><span class="p">;</span>
  <span class="py">spellcheck</span><span class="p">:</span> <span class="no">false</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h1 id="2-koreaninput-í´ë˜ìŠ¤-ì „ì—­-ëª¨ë“œ-api-í™•ì¥">2) KoreanInput í´ë˜ìŠ¤: ì „ì—­ ëª¨ë“œ API í™•ì¥</h1>

<p>ì´ë¯¸ ë„£ì–´ë‘” <code class="language-plaintext highlighter-rouge">mode</code>, <code class="language-plaintext highlighter-rouge">setMode</code>, <code class="language-plaintext highlighter-rouge">toggleMode</code>ë¥¼ ì „ì—­ì—ì„œ í˜¸ì¶œí•˜ê¸° ì‰½ê²Œ ì¡°ê¸ˆ ì¼ë°˜í™”í•˜ê³ , ì´ˆê¸° ë°°ì§€ì™€ ë™ê¸°í™”ê¹Œì§€ í¬í•¨í•œë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// KoreanInput í´ë˜ìŠ¤ ë‚´ë¶€ì— ì´ë¯¸ ì œì•ˆí–ˆë˜ ê²ƒ + ë°°ì§€ ë°˜ì˜
setMode(mode) {
  this.mode = (mode === 'en') ? 'en' : 'ko';
  localStorage.setItem('imeMode', this.mode);
  if (this.mode === 'en') this.reset();
  const badge = document.getElementById('imeBadge');
  if (badge){
    badge.setAttribute('data-mode', this.mode);
    // ì‚´ì§ ê¹œë¹¡ì´ëŠ” í”¼ë“œë°±
    badge.style.transition = 'background .15s';
    badge.style.background = 'rgba(0,0,0,.08)';
    setTimeout(()=&gt; badge.style.background = 'rgba(255,255,255,.85)', 120);
  }
}
toggleMode(){ this.setMode(this.mode === 'ko' ? 'en' : 'ko'); }
</code></pre></div></div>

<p>DOMContentLoadedì—ì„œ ë°°ì§€ë¥¼ í˜„ì¬ ëª¨ë“œì™€ ë™ê¸°í™”:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// DOMContentLoaded ë‚´ë¶€
const badge = document.getElementById('imeBadge');
if (badge){
  badge.setAttribute('data-mode', koreanInput.mode);
}
</code></pre></div></div>

<hr />

<h1 id="3-ëª¨ë“ -textareaì—-ë¶™ëŠ”-í•¸ë“¤ëŸ¬-ìœ í‹¸">3) ëª¨ë“  textareaì— ë¶™ëŠ” í•¸ë“¤ëŸ¬ ìœ í‹¸</h1>

<p>íŠ¹ì • ìš”ì†Œì— ë¶™ì´ë˜ keydown ë¡œì§ì„ â€œì¬ì‚¬ìš© ê°€ëŠ¥í•œ í•¨ìˆ˜â€ë¡œ ë§Œë“ ë‹¤. ì´ í•¨ìˆ˜ëŠ” ë„¤ ê¸°ì¡´ keydown ë‚´ìš©(BackspaceÂ·SpaceÂ·ì¼ë°˜ë¬¸ì ì²˜ë¦¬)ì„ ê·¸ëŒ€ë¡œ í™œìš©í•˜ë˜, <strong>isComposing ê°€ë“œ</strong> ì™€ <strong>ëª¨ë“œ ë¶„ê¸°</strong> ë¥¼ ë§¨ ì•ì— ë‘”ë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// ì „ì—­ ìœ í‹¸: í•œ/ì˜ í† ê¸€ í•«í‚¤
function isToggleHotkey(e){
  return (e.ctrlKey &amp;&amp; !e.shiftKey &amp;&amp; !e.altKey &amp;&amp; e.code === 'Space') || (e.code === 'F2');
}

// íŠ¹ì • textareaì— ì¡°í•©ê¸°ë¥¼ ì¥ì°©
function attachKoreanHandlers(textarea, koreanInput){
  if (!textarea || textarea.__koreanAttached) return;
  textarea.__koreanAttached = true;

  // í¬ì»¤ìŠ¤ ì‹œ ìƒíƒœ ì´ˆê¸°í™”(ì—ë””í„° ì „í™˜ ì‹œ ì”ìƒ ë°©ì§€)
  textarea.addEventListener('focus', (e)=&gt;{
    // ëª¨ë°”ì¼ ê°€ìƒí‚¤ë³´ë“œ ëª¨ë“œ ë“± ë„¤ ë¡œì§ì´ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ìœ ì§€
    koreanInput.reset();
  });

  // í‚¤ë‹¤ìš´: ì „ì—­ ëª¨ë“œ + ê°€ë“œ
  textarea.addEventListener('keydown', function(e){
    // OS IME ì¡°í•© ì¤‘ì´ê±°ë‚˜ Process í‚¤ë©´ ê±´ë“œë¦¬ì§€ ì•ŠìŒ
    if (e.isComposing || e.key === 'Process') return;

    // ì „ì—­ í† ê¸€
    if (isToggleHotkey(e)){
      e.preventDefault();
      koreanInput.toggleMode();
      return;
    }

    // EN ëª¨ë“œ: ê¸°ë³¸ ì…ë ¥ í†µê³¼ (ì•„ë¬´ê²ƒë„ ë§‰ì§€ ì•ŠìŒ)
    if (koreanInput.mode === 'en') return;

    // ===== ì•„ë˜ë¶€í„°ëŠ” KO ëª¨ë“œì—ì„œë§Œ ì‹¤í–‰: ë„¤ ê¸°ì¡´ ë¡œì§ì„ ê·¸ëŒ€ë¡œ ì´ì‹ =====

    if (e.key === 'Backspace'){
      e.preventDefault();
      const cursorStart = this.selectionStart;
      const cursorEnd = this.selectionEnd;

      if (cursorStart === cursorEnd){
        if (cursorStart &gt; 0){
          const textBefore = this.value.substring(0, cursorStart);
          const textAfter  = this.value.substring(cursorStart);
          const newTextBefore = koreanInput.handleBackspace(textBefore);
          const newText = newTextBefore + textAfter;
          this.value = newText;

          const newCursorPos = newTextBefore.length;
          this.setSelectionRange(newCursorPos, newCursorPos);

          if (newCursorPos &gt; 0){
            const charBeforeCursor = newText[newCursorPos - 1];
            koreanInput.restoreStateFromCharacter(charBeforeCursor);
          } else {
            koreanInput.reset();
          }
        }
      } else {
        const textBefore = this.value.substring(0, cursorStart);
        const textAfter  = this.value.substring(cursorEnd);
        const newText = textBefore + textAfter;
        this.value = newText;
        this.setSelectionRange(cursorStart, cursorStart);

        if (cursorStart &gt; 0){
          const charBeforeCursor = newText[cursorStart - 1];
          koreanInput.restoreStateFromCharacter(charBeforeCursor);
        } else {
          koreanInput.reset();
        }
      }
      return;
    }

    if (e.key === ' '){
      e.preventDefault();
      const cursorStart = this.selectionStart;
      const textBefore  = this.value.substring(0, cursorStart);
      const textAfter   = this.value.substring(this.selectionEnd);
      this.value = textBefore + ' ' + textAfter;

      const newCursorPos = cursorStart + 1;
      this.setSelectionRange(newCursorPos, newCursorPos);
      koreanInput.reset();
      return;
    }

    // íŠ¹ìˆ˜í‚¤ ë¬´ì‹œ(Shift ë“±)
    if (e.key.length &gt; 1 &amp;&amp; e.key !== 'Shift') return;

    const char = koreanInput.getCharacter(e.key, e.shiftKey);
    if (char){
      e.preventDefault();
      const result = koreanInput.processInput(char);
      const cursorPos = this.selectionStart;
      const insertResult = koreanInput.smartInsert(this.value, cursorPos, this.selectionEnd, result);
      this.value = insertResult.text;
      this.setSelectionRange(insertResult.cursorPosition, insertResult.cursorPosition);
    }
  });

  // í´ë¦­/ë§ˆìš°ìŠ¤/í„°ì¹˜ë¡œ ì»¤ì„œ ë°”ê¿¨ì„ ë•Œ ìƒíƒœ ì´ˆê¸°í™”(ë„¤ ê¸°ì¡´ ë°©ì‹ ìœ ì§€)
  textarea.addEventListener('click', ()=&gt;{
    koreanInput.reset();
  });
  textarea.addEventListener('keyup', ()=&gt;{
    // í•„ìš”ì‹œ ê°€ìƒì»¤ì„œ ë™ê¸°í™” ë“± ë„£ì„ ìë¦¬
  });
}
</code></pre></div></div>

<hr />

<h1 id="4-í•œ-ë²ˆì—-ëª¨ë‘-ì¥ì°©--ë™ì -ì¶”ê°€ë„-ì»¤ë²„">4) í•œ ë²ˆì— ëª¨ë‘ ì¥ì°© + ë™ì  ì¶”ê°€ë„ ì»¤ë²„</h1>

<p>í˜ì´ì§€ ë¡œë“œì‹œ ëª¨ë“  <code class="language-plaintext highlighter-rouge">&lt;textarea&gt;</code>ë¥¼ ì°¾ì•„ ì¥ì°©í•˜ê³ , DOMì— ìƒˆë¡œìš´ textareaê°€ ìƒê¸°ë©´ ìë™ìœ¼ë¡œ ë¶™ì¸ë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

document.addEventListener('DOMContentLoaded', function(){
  const koreanInput = new KoreanInput();
  window.koreanInput = koreanInput; // ë‹¤ë¥¸ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡

  // ë°°ì§€ ì´ˆê¸° ìƒíƒœ ë°˜ì˜
  const badge = document.getElementById('imeBadge');
  if (badge){ badge.setAttribute('data-mode', koreanInput.mode); }

  // í˜ì´ì§€ì˜ ëª¨ë“  textareaì— ì¥ì°©
  document.querySelectorAll('textarea').forEach(el=&gt;{
    // ê¶Œì¥ ì˜µì…˜ ì ìš©
    el.setAttribute('autocomplete','off');
    el.setAttribute('autocapitalize','off');
    el.setAttribute('spellcheck','false');
    attachKoreanHandlers(el, koreanInput);
  });

  // ë™ì  ì¶”ê°€ ëŒ€ì‘
  const mo = new MutationObserver((mutations)=&gt;{
    for (const m of mutations){
      m.addedNodes &amp;&amp; m.addedNodes.forEach(node=&gt;{
        if (node.nodeType === 1){ // ELEMENT_NODE
          if (node.matches &amp;&amp; node.matches('textarea')){
            node.setAttribute('autocomplete','off');
            node.setAttribute('autocapitalize','off');
            node.setAttribute('spellcheck','false');
            attachKoreanHandlers(node, koreanInput);
          }
          // í•˜ìœ„ì— ì—¬ëŸ¬ ê°œ ìƒê¸°ëŠ” ì¼€ì´ìŠ¤
          node.querySelectorAll &amp;&amp; node.querySelectorAll('textarea').forEach(el=&gt;{
            el.setAttribute('autocomplete','off');
            el.setAttribute('autocapitalize','off');
            el.setAttribute('spellcheck','false');
            attachKoreanHandlers(el, koreanInput);
          });
        }
      });
    }
  });
  mo.observe(document.documentElement, { childList:true, subtree:true });

  // ì „ì—­ í‚¤ë¡œë„ í† ê¸€ ê°€ëŠ¥(í¬ì»¤ìŠ¤ê°€ textareaê°€ ì•„ë‹ˆì–´ë„)
  document.addEventListener('keydown', (e)=&gt;{
    if (e.isComposing || e.key === 'Process') return;
    if (isToggleHotkey(e)){
      e.preventDefault();
      koreanInput.toggleMode();
    }
  });

  // ë°°ì§€ í´ë¦­ìœ¼ë¡œë„ ì „í™˜(ëª¨ë°”ì¼ ë°°ë ¤)
  if (badge){
    badge.addEventListener('click', ()=&gt; koreanInput.toggleMode());
  }
});
</code></pre></div></div>

<hr />

<h1 id="5-ì„ íƒ-ì˜µì…˜">5) ì„ íƒ ì˜µì…˜</h1>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">&lt;input type="text"&gt;</code>ì—ë„ ì ìš©í•˜ê³  ì‹¶ë‹¤ë©´ <code class="language-plaintext highlighter-rouge">querySelectorAll('textarea, input[type="text"], input[type="search"]')</code>ë¡œ í™•ì¥í•˜ë˜, selection APIê°€ ë™ì¼í•˜ê²Œ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸í•˜ì. ì§€ê¸ˆ ë¡œì§ì€ ëŒ€ë¶€ë¶„ í˜¸í™˜ëœë‹¤.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">contenteditable</code>ê¹Œì§€ ì»¤ë²„í•˜ë ¤ë©´ selection ì²˜ë¦¬ì™€ text node êµì²´ê°€ ë‹¬ë¼ì„œ ë³„ ì–´ëŒ‘í„°ê°€ í•„ìš”í•˜ë‹¤. ìš”ì²­í•˜ë©´ ê·¸ ë²„ì „ë„ ë§Œë“¤ì–´ì¤„ ìˆ˜ ìˆë‹¤.</p>
  </li>
  <li>
    <p>ê°€ìƒ í‚¤ë³´ë“œì™€ ëª¨ë“œ ë™ê¸°í™”ê°€ í•„ìš”í•˜ë©´, ê°€ìƒ í‚¤ë³´ë“œì˜ í•œ/ì˜ ë²„íŠ¼ í´ë¦­ ì‹œ <code class="language-plaintext highlighter-rouge">window.koreanInput.toggleMode()</code>ë§Œ í˜¸ì¶œí•´ì£¼ë©´ ëë‚œë‹¤.</p>
  </li>
</ol>

<hr />

<h1 id="ë™ì‘-ìš”ì•½">ë™ì‘ ìš”ì•½</h1>

<ul>
  <li>
    <p>ì „ì—­ ëª¨ë“œ ìƒíƒœëŠ” <code class="language-plaintext highlighter-rouge">localStorage('imeMode')</code>ì— ì €ì¥ë˜ì–´ ìƒˆë¡œê³ ì¹¨í•´ë„ ìœ ì§€.</p>
  </li>
  <li>
    <p>í™”ë©´ ìš°í•˜ë‹¨ ë°°ì§€ì— KO/EN í‘œì‹œ. í´ë¦­í•˜ê±°ë‚˜ Ctrl+Space, F2ë¡œ ì „í™˜.</p>
  </li>
  <li>
    <p>ëª¨ë“  <code class="language-plaintext highlighter-rouge">&lt;textarea&gt;</code>ì—ì„œ KO ëª¨ë“œì¼ ë•Œë§Œ í•œê¸€ ì¡°í•©(ë„¤ ë¡œì§)ì´ ë™ì‘, EN ëª¨ë“œë©´ ë¸Œë¼ìš°ì € ê¸°ë³¸ ì…ë ¥.</p>
  </li>
  <li>
    <p>OS IMEê°€ ì¡°í•© ì¤‘ì¼ ë•ŒëŠ” <code class="language-plaintext highlighter-rouge">e.isComposing</code> ê°€ë“œë¡œ ì¶©ëŒ ë°©ì§€.</p>
  </li>
</ul>

<p>ì›í•˜ë©´ <code class="language-plaintext highlighter-rouge">&lt;input&gt;</code>/<code class="language-plaintext highlighter-rouge">contenteditable</code> í™•ì¥ê³¼, ë°°ì§€ ë””ìì¸(ì•„ì´ì½˜ SVG, ë‹¤í¬ëª¨ë“œ, ì ‘ê·¼ì„± ë¼ë²¨)ë„ ë§ì…í˜€ì„œ ê¹”ë”í•˜ê²Œ ì •ë¦¬í•´ì¤„ê²Œ.</p>

<p class="chat--user">

ì¢‹ì•„ ì˜ ë˜ê³  ìˆë‹¤. ê·¸ëŸ°ë° Ctrl+a, Ctrl+x ê°™ì€ í‚¤ê°€ ì œëŒ€ë¡œ ë™ì‘ì„ ì•ˆí•´ ì´ê±° ê³ ì³ì¤„ ìˆ˜ ìˆì–´? 

</p>

<p>ì¢‹ì•„â€”ë°”ë¡œ ê³ ì¹  ìˆ˜ ìˆì–´. í•µì‹¬ì€ <strong>Ctrl/âŒ˜(Meta)ì™€ ì¡°í•©ëœ ë‹¨ì¶•í‚¤ëŠ” ì ˆëŒ€<code class="language-plaintext highlighter-rouge">preventDefault</code>ë¡œ ë§‰ì§€ ì•ŠëŠ” ê²ƒ</strong>ì´ì•¼. ì§€ê¸ˆ keydown í•¸ë“¤ëŸ¬ê°€ KO ëª¨ë“œì—ì„œ BackspaceÂ·SpaceÂ·ë¬¸ì ì…ë ¥ì„ ê°€ë¡œì±„ë‹¤ ë³´ë‹ˆ <code class="language-plaintext highlighter-rouge">Ctrl+A / X / C / V / Z / Y</code> ê°™ì€ í‘œì¤€ ë‹¨ì¶•í‚¤ê°€ ë¹„ì •ìƒ ë™ì‘í•˜ëŠ” ê±°ì§€.</p>

<p>ì•„ë˜ì²˜ëŸ¼ â€œìˆ˜ì • ë¼ì¸ë§Œâ€ ì¶”ê°€í•˜ë©´ ê¹”ë”í•˜ê²Œ í•´ê²°ë¼.</p>

<h2 id="1-ë³´ì¡°-í•¨ìˆ˜-ì¶”ê°€">1) ë³´ì¡° í•¨ìˆ˜ ì¶”ê°€</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

function isToggleHotkey(e){
  return (e.ctrlKey &amp;&amp; !e.shiftKey &amp;&amp; !e.altKey &amp;&amp; e.code === 'Space') || (e.code === 'F2');
}

// Ctrl/Meta ì¡°í•©(í‘œì¤€ ë‹¨ì¶•í‚¤)ë©´ ë¸Œë¼ìš°ì €ì— ë§¡ê¸°ê¸°
function isEditorShortcut(e){
  // AltGraph(ìš°Alt)ë‚˜ Ctrl+Alt ê°™ì€ ì¡°í•©ë„ í†µê³¼
  const altGraph = e.getModifierState &amp;&amp; e.getModifierState('AltGraph');
  const ctrlMeta = e.ctrlKey || e.metaKey;
  const ctrlAlt  = e.ctrlKey &amp;&amp; e.altKey;
  return altGraph || ctrlAlt || ctrlMeta;
}
</code></pre></div></div>

<h2 id="2-keydown-í•¸ë“¤ëŸ¬-ì•ë¶€ë¶„-ë¶„ê¸°-ê°•í™”">2) <code class="language-plaintext highlighter-rouge">keydown</code> í•¸ë“¤ëŸ¬ ì•ë¶€ë¶„ ë¶„ê¸° ê°•í™”</h2>

<p>ë„¤ê°€ ëª¨ë“  <code class="language-plaintext highlighter-rouge">&lt;textarea&gt;</code>ì— ë¶™ì´ëŠ” <code class="language-plaintext highlighter-rouge">keydown</code> ë¦¬ìŠ¤ë„ˆ ì•ˆì—ì„œ, <strong>ê°€ì¥ ìœ„ìª½ì—</strong> ì•„ë˜ ê°€ë“œë¥¼ ë„£ì–´.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

textarea.addEventListener('keydown', function(e){
  // OS IME ì¡°í•© ì¤‘ì´ë©´ ê±´ë“œë¦¬ì§€ ì•ŠìŒ
  if (e.isComposing || e.key === 'Process') return;

  // ì „ì—­ í† ê¸€ ë‹¨ì¶•í‚¤ ìš°ì„  ì²˜ë¦¬
  if (isToggleHotkey(e)){
    e.preventDefault();
    koreanInput.toggleMode();
    return;
  }

  // â­ í‘œì¤€ í¸ì§‘ ë‹¨ì¶•í‚¤ëŠ” ë¬´ì¡°ê±´ í†µê³¼(Ctrl/âŒ˜, AltGraph ë“±)
  if (isEditorShortcut(e)){
    return; // Ctrl+A/X/C/V/Z/Y, Ctrl+â†/â†’ ë“± ì „ë¶€ ë¸Œë¼ìš°ì € ê¸°ë³¸ ë™ì‘
  }

  // EN ëª¨ë“œëŠ” ì „ë¶€ í†µê³¼
  if (koreanInput.mode === 'en') return;

  // ----- ì´í•˜ KO ëª¨ë“œ ì „ìš© ë¡œì§(ê¸°ì¡´ ì½”ë“œ ìœ ì§€) -----
  // Backspace/Space/ë¬¸ì ì²˜ë¦¬...
});
</code></pre></div></div>

<h2 id="3-ko-ëª¨ë“œ-ë‚´ë¶€ì—ì„œë„-ì¡°í•©ëœ-backspace-ì˜ˆì™¸-ì²˜ë¦¬">3) KO ëª¨ë“œ ë‚´ë¶€ì—ì„œë„ â€œì¡°í•©ëœ Backspaceâ€ ì˜ˆì™¸ ì²˜ë¦¬</h2>

<p><code class="language-plaintext highlighter-rouge">Ctrl+Backspace</code>(ë‹¨ì–´ ë‹¨ìœ„ ì‚­ì œ)ë‚˜ <code class="language-plaintext highlighter-rouge">Ctrl+Delete</code>ë„ ê¸°ë³¸ ë™ì‘ì„ ì‚´ë¦¬ê³  ì‹¶ë‹¤ë©´ KO ë¸”ë¡ ì§„ì… <strong>ì´ì „</strong> ì— ì´ë¯¸ <code class="language-plaintext highlighter-rouge">isEditorShortcut(e)</code>ì—ì„œ ë¹ ì ¸ë‚˜ê°€ë¯€ë¡œ ì¶”ê°€ ë³€ê²½ ì—†ì´ í•´ê²°ë¼. ë‹¤ë§Œ í˜¹ì‹œ ì•„ë˜ì²˜ëŸ¼ KO ë¸”ë¡ ì•ˆìª½ì— Backspaceë¥¼ ë¨¼ì € ì¡ì•„ë²„ë¦¬ëŠ” ì½”ë“œê°€ ìˆë‹¤ë©´, í•œ ì¤„ë§Œ ë³´ê°•í•˜ë©´ ëœë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

if (e.key === 'Backspace'){
  // â­ ë‹¨ì–´ ì‚­ì œ ê°™ì€ ì¡°í•©ì€ í†µê³¼
  // (ì—¬ê¸°ê¹Œì§€ ì˜¤ë©´ Ctrl/MetaëŠ” ì´ë¯¸ ê±¸ëŸ¬ì¡Œì§€ë§Œ, ë‚¨ê²¨ë‘ë©´ ì•ˆì „)
  if (e.ctrlKey || e.metaKey) return;

  e.preventDefault();
  // ... ë„¤ ê¸°ì¡´ handleBackspace ë¡œì§ ...
  return;
}
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Space</code>ë„ ë§ˆì°¬ê°€ì§€ë¡œ ì¡°í•©í‚¤ì™€ í•¨ê»˜ ëˆ„ë¥´ë©´ í†µê³¼:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

if (e.key === ' '){
  // ì˜ˆ: Shift+Space ê°™ì€ ë³€í˜•ì„ í†µê³¼ì‹œí‚¤ê³  ì‹¶ë‹¤ë©´ ì¡°ê±´ì„ í™•ì¥í•´ë„ ë¨
  if (e.ctrlKey || e.altKey || e.metaKey) return;
  e.preventDefault();
  // ... ê¸°ì¡´ ê³µë°± ì²˜ë¦¬ ...
  return;
}
</code></pre></div></div>

<h2 id="4-ë¬¸ì-ì…ë ¥-ì°¨ë‹¨-ì¡°ê±´-ì •ë¦¬">4) ë¬¸ì ì…ë ¥ ì°¨ë‹¨ ì¡°ê±´ ì •ë¦¬</h2>

<p>ë¬¸ì í‚¤ë§Œ ê°€ë¡œì±„ê³ , ê·¸ ì™¸ í¸ì§‘ í‚¤ëŠ” í†µê³¼ì‹œí‚¤ë ¤ë©´ ì´ë ‡ê²Œ ë‘ë©´ ì•ˆì „í•´.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// íŠ¹ìˆ˜í‚¤ ë¬´ì‹œ(Shift ë“±)
if (e.key.length &gt; 1 &amp;&amp; e.key !== 'Shift') return;

// ì—¬ê¸°ì„œë¶€í„°ëŠ” "ì¼ë°˜ ë¬¸ì"ë§Œ ê°€ë¡œì±”
const char = koreanInput.getCharacter(e.key, e.shiftKey);
if (char){
  e.preventDefault();
  const result = koreanInput.processInput(char);
  const cursorPos = this.selectionStart;
  const insertResult = koreanInput.smartInsert(this.value, cursorPos, this.selectionEnd, result);
  this.value = insertResult.text;
  this.setSelectionRange(insertResult.cursorPosition, insertResult.cursorPosition);
}
</code></pre></div></div>

<h2 id="5-ê²°ê³¼">5) ê²°ê³¼</h2>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Ctrl+A</code> ì „ì²´ì„ íƒ, <code class="language-plaintext highlighter-rouge">Ctrl+X/C/V</code> ì˜ë¦°/ë³µì‚¬/ë¶™ì—¬ë„£ê¸°, <code class="language-plaintext highlighter-rouge">Ctrl+Z/Y</code> ë˜ëŒë¦¬ê¸°/ë‹¤ì‹œí•˜ê¸°, <code class="language-plaintext highlighter-rouge">Ctrl+â†/â†’</code> ë‹¨ì–´ ë‹¨ìœ„ ì´ë™, <code class="language-plaintext highlighter-rouge">Ctrl+Backspace/Delete</code> ë‹¨ì–´ ì‚­ì œ ëª¨ë‘ ì •ìƒ.</p>
  </li>
  <li>
    <p>KO ëª¨ë“œì—ì„œë§Œ í•œê¸€ ì¡°í•©ì´ ì ìš©ë˜ê³ , EN ëª¨ë“œ/í‘œì¤€ ë‹¨ì¶•í‚¤/OS IME ì¡°í•© ìƒíƒœëŠ” ì „ë¶€ ë¸Œë¼ìš°ì € ê¸°ë³¸ í¸ì§‘ íë¦„ì„ ìœ ì§€.</p>
  </li>
</ul>

<p>ì¶”ê°€ë¡œ, Edge/Windowsì—ì„œ <strong>AltGraph(ìš°Alt)</strong> ê°€ ì¡íˆëŠ” í™˜ê²½ì´ ì¢…ì¢… ìˆì–´ì„œ <code class="language-plaintext highlighter-rouge">isEditorShortcut</code>ì— <code class="language-plaintext highlighter-rouge">AltGraph</code>ë¥¼ ê¼­ í¬í•¨í–ˆì–´. ì´ê±¸ ë¹¼ë©´ ì¼ë¶€ ê¸°í˜¸ ì…ë ¥ì´ ë§‰í ìˆ˜ ìˆë‹¤.</p>

<p>ì›í•˜ë©´ <code class="language-plaintext highlighter-rouge">&lt;input type="text"&gt;</code>ë‚˜ <code class="language-plaintext highlighter-rouge">contenteditable</code>ê¹Œì§€ í™•ì¥í•  ë•Œì˜ ë‹¨ì¶•í‚¤/ì„ íƒ ì˜ì—­ ì²˜ë¦¬ë„ ê°™ì€ ì›ì¹™ìœ¼ë¡œ ì •ë¦¬í•´ ì¤„ê²Œ.</p>

<p class="chat--user">

input ë„ ê°™ì€ ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬í•˜ê³  ì‹¶ì–´

</p>

<p>ì¢‹ì§€! <code class="language-plaintext highlighter-rouge">&lt;input&gt;</code>ë„ <code class="language-plaintext highlighter-rouge">&lt;textarea&gt;</code>ì™€ ë˜‘ê°™ì€ ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆì–´. í•µì‹¬ì€ ê°™ì€ í‚¤ë‹¤ìš´ í•¸ë“¤ëŸ¬ë¥¼ ì¬ì‚¬ìš©í•˜ê³ , ì…€ë ‰í„°ë¥¼ <code class="language-plaintext highlighter-rouge">&lt;textarea&gt;</code> + í…ìŠ¤íŠ¸ê³„ì—´ <code class="language-plaintext highlighter-rouge">&lt;input&gt;</code>ìœ¼ë¡œ í™•ì¥í•˜ëŠ” ê±°ì•¼. ì•„ë˜ ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ì¶”ê°€Â·êµì²´í•˜ë©´ ëœë‹¤.</p>

<h2 id="1-ìœ í‹¸-í•¨ìˆ˜-ê·¸ëŒ€ë¡œ-ì‚¬ìš©">1) ìœ í‹¸ í•¨ìˆ˜ ê·¸ëŒ€ë¡œ ì‚¬ìš©</h2>

<p>ì´ë¯¸ ì“°ë˜ í† ê¸€/ë‹¨ì¶•í‚¤ ê°€ë“œ ìœ ì§€.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

function isToggleHotkey(e){
  return (e.ctrlKey &amp;&amp; !e.shiftKey &amp;&amp; !e.altKey &amp;&amp; e.code === 'Space') || (e.code === 'F2');
}
function isEditorShortcut(e){
  const altGraph = e.getModifierState &amp;&amp; e.getModifierState('AltGraph');
  const ctrlMeta = e.ctrlKey || e.metaKey;
  const ctrlAlt  = e.ctrlKey &amp;&amp; e.altKey;
  return altGraph || ctrlAlt || ctrlMeta;
}
</code></pre></div></div>

<h2 id="2-ê³µí†µ-ì¥ì°©-í•¨ìˆ˜-textareaì™€-input-ëª¨ë‘-ì§€ì›">2) ê³µí†µ ì¥ì°© í•¨ìˆ˜: <code class="language-plaintext highlighter-rouge">&lt;textarea&gt;</code>ì™€ <code class="language-plaintext highlighter-rouge">&lt;input&gt;</code> ëª¨ë‘ ì§€ì›</h2>

<p>ê¸°ì¡´ <code class="language-plaintext highlighter-rouge">attachKoreanHandlers</code>ë¥¼ ì‚´ì§ ì¼ë°˜í™”í•´ ì–´ëŠ í¸ì§‘ ìš”ì†Œë“  ë¶™ë„ë¡ í•œë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

function attachKoreanHandlers(editEl, koreanInput){
  if (!editEl || editEl.__koreanAttached) return;
  editEl.__koreanAttached = true;

  // ê¶Œì¥ ì˜µì…˜(ìë™ êµì • ë¹„í™œì„±)
  editEl.setAttribute('autocomplete','off');
  editEl.setAttribute('autocapitalize','off');
  editEl.setAttribute('spellcheck','false');

  // í¬ì»¤ìŠ¤ ì‹œ ìƒíƒœ ì´ˆê¸°í™”
  editEl.addEventListener('focus', ()=&gt;{
    koreanInput.reset();
  });

  // í‚¤ë‹¤ìš´: ê³µí†µ ì²˜ë¦¬
  editEl.addEventListener('keydown', function(e){
    if (e.isComposing || e.key === 'Process') return;

    if (isToggleHotkey(e)){
      e.preventDefault();
      koreanInput.toggleMode();
      return;
    }

    // Ctrl/Meta ë“± í¸ì§‘ ë‹¨ì¶•í‚¤ëŠ” í†µê³¼
    if (isEditorShortcut(e)) return;

    // EN ëª¨ë“œëŠ” í†µê³¼
    if (koreanInput.mode === 'en') return;

    // KO ëª¨ë“œ: ê¸°ì¡´ ë¡œì§
    if (e.key === 'Backspace'){
      if (e.ctrlKey || e.metaKey) return; // ë‹¨ì–´ ì‚­ì œ ë“± í†µê³¼
      e.preventDefault();

      const cursorStart = this.selectionStart;
      const cursorEnd   = this.selectionEnd;

      if (cursorStart === cursorEnd){
        if (cursorStart &gt; 0){
          const textBefore = this.value.substring(0, cursorStart);
          const textAfter  = this.value.substring(cursorStart);
          const newTextBefore = koreanInput.handleBackspace(textBefore);
          const newText = newTextBefore + textAfter;
          this.value = newText;
          const newCursorPos = newTextBefore.length;
          this.setSelectionRange(newCursorPos, newCursorPos);

          if (newCursorPos &gt; 0){
            const charBeforeCursor = newText[newCursorPos - 1];
            koreanInput.restoreStateFromCharacter(charBeforeCursor);
          } else {
            koreanInput.reset();
          }
        }
      } else {
        const textBefore = this.value.substring(0, cursorStart);
        const textAfter  = this.value.substring(cursorEnd);
        const newText = textBefore + textAfter;
        this.value = newText;
        this.setSelectionRange(cursorStart, cursorStart);

        if (cursorStart &gt; 0){
          const charBeforeCursor = newText[cursorStart - 1];
          koreanInput.restoreStateFromCharacter(charBeforeCursor);
        } else {
          koreanInput.reset();
        }
      }
      return;
    }

    if (e.key === ' '){
      if (e.ctrlKey || e.altKey || e.metaKey) return; // ì¡°í•© ìŠ¤í˜ì´ìŠ¤ëŠ” í†µê³¼
      e.preventDefault();
      const cursorStart = this.selectionStart;
      const textBefore  = this.value.substring(0, cursorStart);
      const textAfter   = this.value.substring(this.selectionEnd);
      this.value = textBefore + ' ' + textAfter;
      const newCursorPos = cursorStart + 1;
      this.setSelectionRange(newCursorPos, newCursorPos);
      koreanInput.reset();
      return;
    }

    // íŠ¹ìˆ˜í‚¤(Shift ë“±) í†µê³¼
    if (e.key.length &gt; 1 &amp;&amp; e.key !== 'Shift') return;

    const char = koreanInput.getCharacter(e.key, e.shiftKey);
    if (char){
      e.preventDefault();
      const result = koreanInput.processInput(char);

      const cursorPos = this.selectionStart;
      const insertResult = koreanInput.smartInsert(this.value, cursorPos, this.selectionEnd, result);

      this.value = insertResult.text;
      this.setSelectionRange(insertResult.cursorPosition, insertResult.cursorPosition);
    }
  });

  // í´ë¦­/í‚¤ì—… ë“± ìƒíƒœ ì´ˆê¸°í™”
  editEl.addEventListener('click', ()=&gt; koreanInput.reset());
  editEl.addEventListener('keyup',  ()=&gt; {/* í•„ìš”ì‹œ ì»¤ì„œ ë™ê¸°í™” ìë¦¬ */});
}
</code></pre></div></div>

<h2 id="3-ì´ˆê¸°-ì¥ì°©-textarea--í…ìŠ¤íŠ¸ê³„ì—´-input-ëª¨ë‘-ì„ íƒ">3) ì´ˆê¸° ì¥ì°©: <code class="language-plaintext highlighter-rouge">&lt;textarea&gt;</code> + í…ìŠ¤íŠ¸ê³„ì—´ <code class="language-plaintext highlighter-rouge">&lt;input&gt;</code> ëª¨ë‘ ì„ íƒ</h2>

<p>í¼ ì…ë ¥ íƒ€ì… ì¤‘ í…ìŠ¤íŠ¸ë¡œ í¸ì§‘ ê°€ëŠ¥í•œ ê²ƒë“¤ë§Œ í¬í•¨í•œë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

document.addEventListener('DOMContentLoaded', function(){
  const koreanInput = new KoreanInput();
  window.koreanInput = koreanInput;

  // ëª¨ë“œ ë°°ì§€ ì´ˆê¸°í™”
  const badge = document.getElementById('imeBadge');
  if (badge) badge.setAttribute('data-mode', koreanInput.mode);

  // ëŒ€ìƒ ì…€ë ‰í„°: textarea + text/search/url/tel/password/email (ìˆ«ì/ë‚ ì§œ ê³„ì—´ ì œì™¸)
  const editableSelector = [
    'textarea',
    'input:not([type])',
    'input[type="text"]',
    'input[type="search"]',
    'input[type="url"]',
    'input[type="tel"]',
    'input[type="password"]',
    'input[type="email"]'
  ].join(',');

  document.querySelectorAll(editableSelector).forEach(el=&gt;{
    attachKoreanHandlers(el, koreanInput);
  });

  // ë™ì  ì¶”ê°€ ëŒ€ì‘
  const mo = new MutationObserver(muts=&gt;{
    muts.forEach(m=&gt;{
      m.addedNodes &amp;&amp; m.addedNodes.forEach(node=&gt;{
        if (node.nodeType !== 1) return;
        if (node.matches &amp;&amp; node.matches(editableSelector)){
          attachKoreanHandlers(node, koreanInput);
        }
        node.querySelectorAll &amp;&amp; node.querySelectorAll(editableSelector).forEach(el=&gt;{
          attachKoreanHandlers(el, koreanInput);
        });
      });
    });
  });
  mo.observe(document.documentElement, { childList:true, subtree:true });

  // ì „ì—­ í† ê¸€(í¬ì»¤ìŠ¤ê°€ í¸ì§‘ ìš”ì†Œê°€ ì•„ë‹ˆì–´ë„ ë™ì‘)
  document.addEventListener('keydown', (e)=&gt;{
    if (e.isComposing || e.key === 'Process') return;
    if (isToggleHotkey(e)){
      e.preventDefault();
      koreanInput.toggleMode();
    }
  });

  // ë°°ì§€ í´ë¦­ìœ¼ë¡œ ëª¨ë“œ ì „í™˜
  if (badge){
    badge.addEventListener('click', ()=&gt; koreanInput.toggleMode());
  }
});
</code></pre></div></div>

<h2 id="4-ì£¼ì˜ì‚¬í•­ê³¼-íŒ">4) ì£¼ì˜ì‚¬í•­ê³¼ íŒ</h2>

<ul>
  <li>
    <p>ìˆ«ì/ë‚ ì§œ ì…ë ¥ì€ ë¸Œë¼ìš°ì € ê¸°ë³¸ ìœ„ì ¯ê³¼ ì¶©ëŒí•˜ë‹ˆ ì…€ë ‰í„°ì—ì„œ ì œì™¸í–ˆë‹¤. í•„ìš”í•˜ë©´ íƒ€ì…ì„ í…ìŠ¤íŠ¸ë¡œ ë°”ê¿”ì„œ ì‚¬ìš©í•´.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">maxlength</code>ê°€ ìˆëŠ” <code class="language-plaintext highlighter-rouge">&lt;input&gt;</code>ì€ í•©ì„± ì¤‘ ê¸€ì ìˆ˜ê°€ ìˆœê°„ ëŠ˜ì—ˆë‹¤ ì¤„ ìˆ˜ ìˆë‹¤. ë¬¸ì œ ìƒê¸°ë©´ <code class="language-plaintext highlighter-rouge">smartInsert</code>ì—ì„œ ê¸¸ì´ ì²´í¬ë¥¼ ì¶”ê°€í•´ì„œ ìµœì¢… ê²°ê³¼ë§Œ ì œí•œí•˜ë„ë¡ ì¡°ì •í•˜ì.</p>
  </li>
  <li>
    <p>ë¶™ì—¬ë„£ê¸° ì´ë²¤íŠ¸ë¥¼ EN ëª¨ë“œì—ì„œë§Œ í†µê³¼ì‹œí‚¤ê³  KO ëª¨ë“œì—ì„œëŠ” â€œë¶™ì—¬ë„£ê¸° í›„ í•œê¸€ ì¬ì¡°í•©â€ì„ í•˜ê³  ì‹¶ë‹¤ë©´ <code class="language-plaintext highlighter-rouge">paste</code> ì´ë²¤íŠ¸ì—ì„œ <code class="language-plaintext highlighter-rouge">preventDefault()</code> í›„ <code class="language-plaintext highlighter-rouge">e.clipboardData.getData('text')</code>ë¥¼ ì½ì–´ <code class="language-plaintext highlighter-rouge">smartInsert</code>ë¡œ í˜ë ¤ì£¼ë©´ ëœë‹¤.</p>
  </li>
</ul>

<p>ì´ë ‡ê²Œ ë¶™ì´ë©´ í˜ì´ì§€ì˜ ëª¨ë“  í…ìŠ¤íŠ¸ ì…ë ¥ í•„ë“œì—ì„œ ë™ì¼í•˜ê²Œ í•œ/ì˜ ì „í™˜í˜• í•œê¸€ ì¡°í•©ì´ ë™ì‘í•˜ê³ , í‘œì¤€ ë‹¨ì¶•í‚¤(Ctrl/âŒ˜+A/X/C/V/Z/Y)ë„ ì œëŒ€ë¡œ ì‚´ì•„ë‚œë‹¤. ë‹¤ìŒìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">contenteditable</code>ê¹Œì§€ í™•ì¥í•˜ê³  ì‹¶ìœ¼ë©´ ì•Œë ¤ì¤˜â€”ê·¸ê±´ Selection API ì–´ëŒ‘í„°ë§Œ ì¶”ê°€í•˜ë©´ ëœë‹¤.</p>

<p class="chat--user">

ê·¼ë° í•œê¸€ ì§€ìš¸ë•Œ ë³´ë©´ ì‘ì„± ì¤‘ì¸ ê¸€ìëŠ” í•œ ê°œ ììŒ/ëª¨ìŒ ì§€ìš°ì§€ë§Œ ë§ì´ ì§€ìš°ë©´ í•œê¸€ìì”© ë‹¤ ì§€ì›Œì§€ê±°ë“ ? ê·¸ê±¸ ì–´ë–»ê²Œ êµ¬í˜„í•  ìˆ˜ ìˆì„ê¹Œ

</p>

<p>ë§ì•„, í•œêµ­ì–´ ì…ë ¥ê¸°ë“¤ì´ ë³´í†µ ì´ë ‡ê²Œ ë™ì‘í•´:</p>

<ul>
  <li>
    <p>ì‘ì„± ì¤‘(ì¡°í•© ì¤‘)ì¼ ë• Backspaceê°€ <strong>ìëª¨ ë‹¨ìœ„</strong> ë¡œ ì§€ì›€.</p>
  </li>
  <li>
    <p>Backspaceë¥¼ <strong>ê¸¸ê²Œ ëˆ„ë¥´ê±°ë‚˜ ë¹ ë¥´ê²Œ ì—°íƒ€</strong> í•˜ë©´ <strong>ìŒì ˆ(ê¸€ì) ë‹¨ìœ„</strong> ë¡œ ì­‰ ì§€ì›€.<br />
ì´ë¥¼ êµ¬í˜„í•˜ë ¤ë©´ â€œë°±ìŠ¤í˜ì´ìŠ¤ ëª¨ë“œâ€ë¥¼ ë‘ê³ , <strong>í‚¤ ë°˜ë³µ(e.repeat)</strong> ì´ë‚˜ <strong>ì—°íƒ€ ê°„ê²©</strong> ìœ¼ë¡œ ëª¨ë“œë¥¼ ì „í™˜í•˜ë©´ ë¼.</p>
  </li>
</ul>

<p>ì•„ë˜ëŠ” ë„¤ ì½”ë“œì— <strong>ìµœì†Œ ë³€ê²½</strong> ìœ¼ë¡œ ë„£ëŠ” ë°©ë²•ì´ì•¼.</p>

<h2 id="1-ì¡°í•©ìëª¨-ì‚­ì œ-vs-ìŒì ˆ-ì‚­ì œ-í•¨ìˆ˜-ë¶„ë¦¬">1) ì¡°í•©(ìëª¨) ì‚­ì œ vs ìŒì ˆ ì‚­ì œ í•¨ìˆ˜ ë¶„ë¦¬</h2>

<p>í˜„ì¬ <code class="language-plaintext highlighter-rouge">handleBackspace()</code>ëŠ” â€œìëª¨ í•˜ë‚˜ì”©â€ ì§€ìš°ë„ë¡ ë˜ì–´ ìˆì–´. ì—¬ê¸°ì— â€œìŒì ˆ í†µì‚­ì œâ€ìš© í•¨ìˆ˜ë¥¼ í•˜ë‚˜ ë” ë§Œë“ ë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// â‘  ìëª¨-ë‹¨ìœ„ ì‚­ì œ(ë„¤ ê¸°ì¡´ í•¨ìˆ˜ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
handleBackspaceJamo(currentText){
  return this.handleBackspace(currentText);
}

// â‘¡ ìŒì ˆ-ë‹¨ìœ„ ì‚­ì œ: ë§ˆì§€ë§‰ ê¸€ìê°€ í•œê¸€ ìŒì ˆì´ë©´ í†µì§¸ë¡œ 1ì½”ë“œí¬ì¸íŠ¸ ì‚­ì œ
handleBackspaceSyllable(currentText){
  if (currentText.length === 0) return '';
  const last = currentText.charCodeAt(currentText.length - 1);
  const isHangulSyllable = (last &gt;= this.SBase) &amp;&amp; (last &lt; this.SBase + this.SCount);
  // ìŒì ˆì´ë©´ í†µìœ¼ë¡œ í•˜ë‚˜ ì‚­ì œ, ì•„ë‹ˆë©´ ì¼ë°˜ ë¬¸ìì²˜ëŸ¼ í•˜ë‚˜ ì‚­ì œ
  return currentText.slice(0, currentText.length - 1);
}
</code></pre></div></div>

<h2 id="2-ê¸¸ê²Œ-ëˆ„ë¦„ì—°íƒ€-ê°ì§€-ìƒíƒœ-ì¶”ê°€">2) â€œê¸¸ê²Œ ëˆ„ë¦„/ì—°íƒ€â€ ê°ì§€ ìƒíƒœ ì¶”ê°€</h2>

<p>Backspaceë¥¼ <strong>ê¸¸ê²Œ ëˆ„ë¥´ë©´</strong> ë¸Œë¼ìš°ì €ê°€ <code class="language-plaintext highlighter-rouge">keydown</code>ì„ ë°˜ë³µí•´ì„œ ì£¼ëŠ”ë°, ì´ë•Œ <code class="language-plaintext highlighter-rouge">e.repeat === true</code>. ë˜, <strong>ì¬ë¹¨ë¦¬ ì—°íƒ€</strong> í•´ë„ ìŒì ˆ ë‹¨ìœ„ë¡œ ë°”ê¾¸ê³  ì‹¶ë‹¤ë©´ â€œë§ˆì§€ë§‰ ë°±ìŠ¤í˜ì´ìŠ¤ ì‹œê°â€ì„ ê¸°ì–µí•´ì„œ ê°„ê²©ì´ ì§§ìœ¼ë©´ ìŒì ˆ ì‚­ì œ ëª¨ë“œë¡œ ì „í™˜í•˜ì.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// ì „ì—­ ë˜ëŠ” KoreanInput ë‚´ë¶€(í¸í•œ ê³³)ì— ìƒíƒœ ë³€ìˆ˜
let bsLastTs = 0;
const BS_RAPID_MS = 220; // ì´ ì‹œê°„ ì´ë‚´ì˜ ì—°íƒ€ë©´ ìŒì ˆ ì‚­ì œë¡œ ì „í™˜
</code></pre></div></div>

<h2 id="3-keydown-ì²˜ë¦¬-ë¡œì§-ìˆ˜ì •">3) keydown ì²˜ë¦¬ ë¡œì§ ìˆ˜ì •</h2>

<p>í•µì‹¬ì€ Backspace ì²˜ë¦¬ì—ì„œ â€œëª¨ë“œ ê²°ì •â€ë§Œ ì¶”ê°€í•˜ëŠ” ê±°ì•¼. (Ctrl/Meta ë‹¨ì¶•í‚¤, IME ê°€ë“œëŠ” ì „ì— ë„£ì€ ê·¸ëŒ€ë¡œ ìœ ì§€)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

editEl.addEventListener('keydown', function(e){
  if (e.isComposing || e.key === 'Process') return;

  if (isToggleHotkey(e)){ e.preventDefault(); koreanInput.toggleMode(); return; }
  if (isEditorShortcut(e)) return;         // Ctrl/âŒ˜ ë‹¨ì¶•í‚¤ í†µê³¼
  if (koreanInput.mode === 'en') return;   // EN ëª¨ë“œ í†µê³¼

  if (e.key === 'Backspace'){
    // ë‹¨ì–´ì‚­ì œ ê°™ì€ ì¡°í•©í‚¤ëŠ” í†µê³¼
    if (e.ctrlKey || e.metaKey) return;

    e.preventDefault();

    const now = performance.now();
    const rapid = (now - bsLastTs) &lt; BS_RAPID_MS;  // ë¹ ë¥¸ ì—°íƒ€?
    bsLastTs = now;

    // â‘  ëª¨ë“œ ê²°ì •: í‚¤ ë°˜ë³µì´ê±°ë‚˜ ë¹ ë¥¸ ì—°íƒ€ë©´ 'ìŒì ˆ', ì•„ë‹ˆë©´ 'ìëª¨'
    const deleteMode = (e.repeat || rapid) ? 'syllable' : 'jamo';

    const cursorStart = this.selectionStart;
    const cursorEnd   = this.selectionEnd;

    if (cursorStart === cursorEnd){
      if (cursorStart &gt; 0){
        const textBefore = this.value.substring(0, cursorStart);
        const textAfter  = this.value.substring(cursorStart);

        const newTextBefore = (deleteMode === 'syllable')
          ? koreanInput.handleBackspaceSyllable(textBefore)
          : koreanInput.handleBackspaceJamo(textBefore);

        const newText = newTextBefore + textAfter;
        this.value = newText;

        const newCursorPos = newTextBefore.length;
        this.setSelectionRange(newCursorPos, newCursorPos);

        if (newCursorPos &gt; 0){
          const charBeforeCursor = newText[newCursorPos - 1];
          koreanInput.restoreStateFromCharacter(charBeforeCursor);
        } else {
          koreanInput.reset();
        }
      }
    } else {
      // ì„ íƒì˜ì—­ ì‚­ì œëŠ” ë™ì¼
      const textBefore = this.value.substring(0, cursorStart);
      const textAfter  = this.value.substring(cursorEnd);
      const newText = textBefore + textAfter;
      this.value = newText;
      this.setSelectionRange(cursorStart, cursorStart);
      if (cursorStart &gt; 0){
        const charBeforeCursor = newText[cursorStart - 1];
        koreanInput.restoreStateFromCharacter(charBeforeCursor);
      } else {
        koreanInput.reset();
      }
    }
    return;
  }

  // ... ë‚˜ë¨¸ì§€ Space/ì¼ë°˜ ë¬¸ì ì²˜ë¦¬ ë™ì¼ ...
});
</code></pre></div></div>

<h2 id="4-ë™ì‘-ìš”ì•½">4) ë™ì‘ ìš”ì•½</h2>

<ul>
  <li>
    <p><strong>ì§§ê²Œ í•œ ë²ˆ</strong> Backspace: ìëª¨ í•˜ë‚˜ ì‚­ì œ â†’ ë„¤ ê¸°ì¡´ <code class="language-plaintext highlighter-rouge">handleBackspace</code> ê²½ë¡œ.</p>
  </li>
  <li>
    <p><strong>ê¸¸ê²Œ ëˆ„ë¥´ê±°ë‚˜</strong> <strong>ë¹ ë¥´ê²Œ ì—°íƒ€</strong> : ë¸Œë¼ìš°ì €ê°€ <code class="language-plaintext highlighter-rouge">keydown</code>ì„ ë°˜ë³µ(<code class="language-plaintext highlighter-rouge">e.repeat</code>) â†’ ìŒì ˆ ë‹¨ìœ„ ì‚­ì œ(<code class="language-plaintext highlighter-rouge">handleBackspaceSyllable</code>).</p>
  </li>
  <li>
    <p>ì„ íƒ ì˜ì—­ì´ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì„ íƒ ì‚­ì œ.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Ctrl/âŒ˜+Backspace</code> ë“± í¸ì§‘ ë‹¨ì¶•í‚¤ëŠ” í†µê³¼(ë‹¨ì–´ ì‚­ì œ ë“± ê¸°ë³¸ ë™ì‘ ìœ ì§€).</p>
  </li>
</ul>

<h2 id="5-ì·¨í–¥-ì˜µì…˜">5) ì·¨í–¥ ì˜µì…˜</h2>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">BS_RAPID_MS</code>ë¥¼ 180~250ms ì‚¬ì´ì—ì„œ ì¡°ì ˆí•˜ë©´ ë„ˆê°€ ì›í•˜ëŠ” â€œì—°íƒ€ ì¸ì‹ ë¯¼ê°ë„â€ë¥¼ ë§ì¶œ ìˆ˜ ìˆì–´.</p>
  </li>
  <li>
    <p>â€œì²« 1~2íšŒëŠ” ìëª¨, ê·¸ ì´í›„ëŠ” ìŒì ˆâ€ ê°™ì€ ì¹´ìš´í„° ê¸°ë°˜ ì •ì±…ìœ¼ë¡œë„ ë°”ê¿€ ìˆ˜ ìˆì–´. ì˜ˆ: ê°™ì€ ìœ„ì¹˜ì—ì„œ ì—°ì† 2íšŒ ì´ìƒ Backspaceë©´ ìŒì ˆ ì‚­ì œ.</p>
  </li>
</ul>

<p>ì´ ë°©ì‹ì´ë©´ ë„¤ ì¡°í•©ê¸° íë¦„ì€ ê·¸ëŒ€ë¡œ ë‘ë©´ì„œ, ì‹¤ì œ IMEì²˜ëŸ¼ <strong>ìëª¨â†’ìŒì ˆ</strong> ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ì‚­ì œ ë™ì‘ì´ ë„˜ì–´ê°€ì„œ ì²´ê° í’ˆì§ˆì´ í™• ì˜¬ë¼ê°ˆ ê±°ì•¼.</p>

<p class="chat--user">

Ctrl+Zë¡œ ì‹¤í–‰ì·¨ì†ŒëŠ” ì•ˆë˜ë„¤

</p>

<p>ë§ì•„. ë„¤ ë¡œì§ì´ <code class="language-plaintext highlighter-rouge">.value = ...</code>ë¡œ ì§ì ‘ ê°’ì„ ë°”ê¾¸ê³  ìˆì–´ì„œ ë¸Œë¼ìš°ì €ì˜ ê¸°ë³¸ undo ìŠ¤íƒì— ê¸°ë¡ì´ ì•ˆ ë‚¨ì•„ <code class="language-plaintext highlighter-rouge">Ctrl+Z</code>ê°€ ë¨¹íˆì§€ ì•ŠëŠ” ê±°ì•¼. í•´ê²°ì±…ì€ â€œí¸ì§‘ APIâ€ë¥¼ ì¨ì„œ ë¸Œë¼ìš°ì €ê°€ <strong>í¸ì§‘ìœ¼ë¡œ ì¸ì‹</strong> í•˜ê²Œ ë§Œë“œëŠ” ê²ƒ. ê°€ì¥ ì‰¬ìš´ ë°©ë²•ì€ <code class="language-plaintext highlighter-rouge">HTMLInputElement.setRangeText()</code>ë¥¼ ì“°ëŠ” ê±°ê³ , ì•„ì£¼ ë„“ì€ í˜¸í™˜ì„ ì›í•˜ë©´ <code class="language-plaintext highlighter-rouge">execCommand('insertText')</code>(íê¸° ì˜ˆì •ì´ì§€ë§Œ ì‹¤ì œë¡œëŠ” ì˜ ë™ì‘)ê¹Œì§€ í´ë°±ì„ ì–¹ìœ¼ë©´ ë¼.</p>

<p>ì•„ë˜ì²˜ëŸ¼ ë°”ê¾¸ë©´ <code class="language-plaintext highlighter-rouge">Ctrl+Z / Ctrl+Y</code>ê°€ ê¸°ë³¸ í¸ì§‘ íˆìŠ¤í† ë¦¬ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ê²Œ ëœë‹¤.</p>

<h2 id="1-ê³µí†µ-ì ìš©-í•¨ìˆ˜-ì¶”ê°€">1) ê³µí†µ ì ìš© í•¨ìˆ˜ ì¶”ê°€</h2>

<p>ê°’ì„ ì§ì ‘ ë°”ê¾¸ì§€ ë§ê³  ì´ í•¨ìˆ˜ë¡œ ë°”ê¿”ì¹˜ê¸° í•´.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

function applyEditWithUndo(el, start, end, replacement, collapse = 'end') {
  // 1) setRangeTextê°€ ìˆìœ¼ë©´ ë„¤ì´í‹°ë¸Œ í¸ì§‘ìœ¼ë¡œ ê¸°ë¡ë¨(undo ê°€ëŠ¥)
  if (typeof el.setRangeText === 'function') {
    el.setRangeText(replacement, start, end, collapse);
  } else if (document.queryCommandSupported &amp;&amp; document.queryCommandSupported('insertText')) {
    // 2) execCommand í´ë°± (ì—¬ì „íˆ ë§ì€ ë¸Œë¼ìš°ì €ì—ì„œ ë™ì‘)
    el.setSelectionRange(start, end);
    document.execCommand('insertText', false, replacement);
  } else {
    // 3) ìµœí›„ì˜ í´ë°±: ì§ì ‘ ì¹˜í™˜(undo ìŠ¤íƒì€ ëª» ìŒ“ìŒ)
    const v = el.value;
    el.value = v.slice(0, start) + replacement + v.slice(end);
    const newPos = (collapse === 'end') ? (start + replacement.length)
                  : (collapse === 'start') ? start
                  : (start + replacement.length);
    el.setSelectionRange(newPos, newPos);
    return;
  }

  // setRangeText/execCommand ê²½ë¡œì—ì„  ì»¤ì„œ ìœ„ì¹˜ë¥¼ ìš°ë¦¬ê°€ ì •ë¦¬í•´ ì¤€ë‹¤
  const pos = (collapse === 'end') ? (start + replacement.length)
            : (collapse === 'start') ? start
            : (start + replacement.length);
  el.setSelectionRange(pos, pos);
}
</code></pre></div></div>

<h2 id="2-ì‚½ì…ë°±ìŠ¤í˜ì´ìŠ¤ìŠ¤í˜ì´ìŠ¤-ì²˜ë¦¬ì—-ì ìš©">2) ì‚½ì…Â·ë°±ìŠ¤í˜ì´ìŠ¤Â·ìŠ¤í˜ì´ìŠ¤ ì²˜ë¦¬ì— ì ìš©</h2>

<p>ì´ì œ ê¸°ì¡´ì˜ <code class="language-plaintext highlighter-rouge">this.value = ...</code>ì™€ <code class="language-plaintext highlighter-rouge">setSelectionRange(...)</code>ë¥¼ ì „ë¶€ <code class="language-plaintext highlighter-rouge">applyEditWithUndo(...)</code>ë¡œ êµì²´í•˜ë©´ ëœë‹¤.</p>

<h3 id="ë¬¸ì-ì…ë ¥ì¡°í•©-ì‚½ì…">ë¬¸ì ì…ë ¥(ì¡°í•© ì‚½ì…)</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// ê¸°ì¡´
// this.value = insertResult.text;
// this.setSelectionRange(insertResult.cursorPosition, insertResult.cursorPosition);

// ë³€ê²½
applyEditWithUndo(
  this,
  this.selectionStart,
  this.selectionEnd,
  // smartInsertëŠ” â€œë¬¸ì 1ê°œ ì‚½ì… â†’ ì£¼ë³€ ì¬ì¡°í•©â€ì„ í•˜ë¯€ë¡œ,
  // ì‹¤ì œë¡œ ë°”ë€” êµ¬ê°„ì„ ê³„ì‚°í•´ì•¼ í•œë‹¤.
  // ê°€ì¥ ë‹¨ìˆœí•œ ë°©ë²•: ì‚½ì… ì „í›„ ì°¨ì´ë¥¼ ì´ìš©í•˜ê±°ë‚˜,
  // ì•„ë˜ì²˜ëŸ¼ ì „ì²´ë¥¼ ì¹˜í™˜(ê°„ë‹¨í•˜ì§€ë§Œ ë¹„íš¨ìœ¨ì )í•  ìˆ˜ë„ ìˆìŒ.
  // íš¨ìœ¨ì ìœ¼ë¡œ í•˜ë ¤ë©´ smartInsertê°€ ë¦¬í„´ê°’ì— ë°”ë€ êµ¬ê°„ ë²”ìœ„(start/end)ë¥¼ í¬í•¨í•˜ë„ë¡ í™•ì¥í•´.
  (function(){
    const before = this.value;
    const s = this.selectionStart, e = this.selectionEnd;
    const res = koreanInput.smartInsert(before, s, e, result); // ê¸°ì¡´ í˜¸ì¶œ ê·¸ëŒ€ë¡œ
    // ê°’ ì „ì²´ë¥¼ ìƒˆ ê°’ìœ¼ë¡œ êµì²´
    // ë²”ìœ„ì¹˜í™˜ì„ ì“°ë ¤ë©´ smartInsertì— diff ë²”ìœ„ ì¶”ê°€ê°€ ê°€ì¥ ì¢‹ìŒ
    this.value = res.text; // ì„ì‹œ ì“°ê¸°(ì»¤ì„œ ë³´ì •ìš©)
    return res.text.slice(0, res.cursorPosition); // ì»¤ì„œ ìœ„ì¹˜ ë§ì¶”ê¸° ìœ„í•´ collapse='end' ì‚¬ìš©
  }).call(this),
  'end'
);
// ì£¼ì„: ìœ„ ê°„ë‹¨ ë²„ì „ì€ ì „ì²´ ì¹˜í™˜ì´ë¼ undoê°€ í•œ ë²ˆì— ì¡íˆê¸´ í•´ë„ ë¹„íš¨ìœ¨.
// ê°€ì¥ ì¢‹ì€ ë°©ì‹ì€ smartInsertê°€ {text, cursorPosition, replaceStart, replaceEnd}ë¥¼ ì£¼ë„ë¡ ë°”ê¿”
// applyEditWithUndo(this, replaceStart, replaceEnd, replacement)ë¡œ ë¶€ë¶„ ì¹˜í™˜í•˜ëŠ” ê²ƒ.
</code></pre></div></div>

<p>ì‹¤ë¬´ì ì¸ ê¶Œì¥: <code class="language-plaintext highlighter-rouge">smartInsert(...)</code>ê°€ â€œì–´ëŠ ë²”ìœ„ê°€ ë°”ë€Œì—ˆëŠ”ì§€â€ë¥¼ ë¦¬í„´í•˜ë„ë¡ í™•ì¥í•˜ì„¸ìš”.<br />
ì˜ˆ: <code class="language-plaintext highlighter-rouge">{ text, cursorPosition, rangeStart, rangeEnd, replacement }</code><br />
ê·¸ëŸ¼ ì•„ë˜ì²˜ëŸ¼ ì •í™•íˆ ë°”ë€ êµ¬ê°„ë§Œ ì¹˜í™˜í•  ìˆ˜ ìˆì–´ìš”.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

const ins = koreanInput.smartInsert(this.value, cursorPos, this.selectionEnd, result);
applyEditWithUndo(this, ins.rangeStart, ins.rangeEnd, ins.replacement, 'end');
</code></pre></div></div>

<h3 id="backspaceìëª¨ìŒì ˆ">Backspace(ìëª¨/ìŒì ˆ)</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// ê¸°ì¡´
// this.value = newText;
// this.setSelectionRange(newPos, newPos);

// ë³€ê²½
applyEditWithUndo(this, cursorStart - (textBefore.length - newTextBefore.length), cursorStart, ''); 
// ì„¤ëª…: ì‚­ì œí•œ ê¸¸ì´ë§Œí¼ startë¥¼ ì•ë‹¹ê²¨ ë¹ˆ ë¬¸ìì—´ë¡œ ì¹˜í™˜
</code></pre></div></div>

<p>ë„ˆê°€ ìœ„ì—ì„œ êµ¬í˜„í•œ ìëª¨/ìŒì ˆ ì‚­ì œ ëª¨ë“œ(í‚¤ ë°˜ë³µ, ì—°íƒ€)ì— ê·¸ëŒ€ë¡œ ì´ ë¡œì§ë§Œ ë¼ì›Œ ë„£ìœ¼ë©´ ëœë‹¤.<br />
ì‚­ì œëŠ” â€œì¹˜í™˜ í…ìŠ¤íŠ¸ë¥¼ ë¹ˆ ë¬¸ìì—´ë¡œâ€ ë„£ìœ¼ë©´ undo ìŠ¤íƒì— â€˜ì‚­ì œâ€™ë¡œ ìŒ“ì¸ë‹¤.</p>

<h3 id="space">Space</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// ê¸°ì¡´
// this.value = textBefore + ' ' + textAfter;
// this.setSelectionRange(newCursorPos, newCursorPos);

// ë³€ê²½
applyEditWithUndo(this, this.selectionStart, this.selectionEnd, ' ', 'end');
koreanInput.reset();
</code></pre></div></div>

<h2 id="3-ë‹¨ì¶•í‚¤-í†µê³¼-ë³´ê°•ì¬í™•ì¸">3) ë‹¨ì¶•í‚¤ í†µê³¼ ë³´ê°•(ì¬í™•ì¸)</h2>

<p>ì´ë¯¸ ë„£ì€ ê°€ë“œê°€ ì¤‘ìš”í•˜ë‹¤. <code class="language-plaintext highlighter-rouge">Ctrl/Meta/AltGraph</code> ì¡°í•©ì€ ì ˆëŒ€ ë§‰ì§€ ì•Šê¸°.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

function isEditorShortcut(e){
  const altGraph = e.getModifierState &amp;&amp; e.getModifierState('AltGraph');
  const ctrlMeta = e.ctrlKey || e.metaKey;
  const ctrlAlt  = e.ctrlKey &amp;&amp; e.altKey;
  return altGraph || ctrlAlt || ctrlMeta;
}

if (isEditorShortcut(e)) return; // KO/EN ëª¨ë“œ ìƒê´€ì—†ì´ í†µê³¼
</code></pre></div></div>

<p>ì´ë ‡ê²Œ í•˜ë©´ <code class="language-plaintext highlighter-rouge">Ctrl+Z / Ctrl+Y / Ctrl+A / Ctrl+X/C/V</code>ê°€ ì „ë¶€ ì •ìƒ ë™ì‘í•˜ê³ , ë„¤ê°€ í•œ ì‚½ì…Â·ì‚­ì œë„ ë¸Œë¼ìš°ì €ì˜ undo ìŠ¤íƒì— ìì—°ìŠ¤ëŸ½ê²Œ ëˆ„ì ëœë‹¤.</p>

<h2 id="4-ë³´ë„ˆìŠ¤-ì–¸ì œ-undo-ë‹¨ìœ„ë¥¼-ëŠì„ì§€">4) ë³´ë„ˆìŠ¤: â€œì–¸ì œ undo ë‹¨ìœ„ë¥¼ ëŠì„ì§€â€</h2>

<p>ì§€ê¸ˆì€ <code class="language-plaintext highlighter-rouge">setRangeText</code>ë¥¼ í˜¸ì¶œí•  ë•Œë§ˆë‹¤ ì‘ì€ ë‹¨ìœ„ë¡œ ìŒ“ì¸ë‹¤. ë³´í†µì€ ì´ê²Œ ìì—°ìŠ¤ëŸ½ê³ , í•œê¸€ ì¡°í•©ë„ ìŒì ˆ ë‹¨ìœ„ë¡œ ë˜ëŒë ¤ì ¸ì„œ ê´œì°®ë‹¤. ë” ë§¤ë„ëŸ½ê²Œ í•˜ë ¤ë©´:</p>

<ul>
  <li>
    <p>ì¡°í•© ì¤‘(ìëª¨ ì…ë ¥ ì¤‘)ì—ëŠ” ì—¬ëŸ¬ ë²ˆì˜ setRangeTextë¥¼ <strong>íƒ€ì´ë¨¸(ì˜ˆ: 350ms ë¬´ì…ë ¥)</strong>ë¡œ ë¬¶ì–´ í•˜ë‚˜ì˜ undo ë‹¨ìœ„ë¡œ ë§Œë“¤ê³ ,</p>
  </li>
  <li>
    <p>ìŠ¤í˜ì´ìŠ¤/ì—”í„°/ëª¨ë“œì „í™˜ ì‹œì ì— ê°•ì œë¡œ undo ë‹¨ìœ„ë¥¼ ëŠëŠ”ë‹¤.<br />
ì´ê±´ ê³ ê¸‰ ì˜µì…˜ì´ë‹ˆ í•„ìš”í•˜ë©´ ì´ì–´ì„œ ì¡ì•„ì£¼ì.</p>
  </li>
</ul>

<hr />

<p>ìš”ì•½: ê°’ ì§ì ‘ ëŒ€ì…ì„ ë©ˆì¶”ê³  <code class="language-plaintext highlighter-rouge">setRangeText</code>/<code class="language-plaintext highlighter-rouge">execCommand('insertText')</code>ë¡œ ì¹˜í™˜í•˜ë¼. ê·¸ëŸ¬ë©´ ìš´ì˜ì²´ì œ/ë¸Œë¼ìš°ì €ê°€ í¸ì§‘ìœ¼ë¡œ ì¸ì‹í•´ì„œ <code class="language-plaintext highlighter-rouge">Ctrl+Z</code>ê°€ ì‚´ì•„ë‚œë‹¤.</p>

<p class="chat--user">

ê·¼ë° ëª¨ë“  texteditì— koreanInputì„ ë‹¤ëŠ”ê²Œ ë¹„íš¨ìœ¨ì ì´ì§„ ì•Šë‚˜? ê·¸ëƒ¥ focusê°€ ëì„ ë•Œë§Œ ë‹¤ëŠ”ê±´ ë³„ë¡œ?

</p>

<p>ì¢‹ì€ ê°ê°ì´ì•¼. â€œëª¨ë“  í¸ì§‘ê¸°ì— ë¦¬ìŠ¤ë„ˆë¥¼ ë°•ì•„ë‘ê¸°â€ë³´ë‹¤, í¬ì»¤ìŠ¤ë  ë•Œë§Œ ë¶™ì´ê±°ë‚˜ ì•„ì˜ˆ â€œë¬¸ì„œ í•œ ê³³ì—ì„œ ìœ„ì„ ì²˜ë¦¬â€ê°€ ë” íš¨ìœ¨ì ì´ì•¼. ì •ë¦¬í•˜ë©´ ì„ íƒì§€ëŠ” ì„¸ ê°€ì§€.</p>

<ol>
  <li>
    <p>ìš”ì†Œë³„ ë¶€ì°©: ëª¨ë“  textarea/inputì— keydown ë“± ë¦¬ìŠ¤ë„ˆë¥¼ ê°ê° ë¶™ì„</p>
  </li>
  <li>
    <p>í¬ì»¤ìŠ¤ ì‹œ ë¶€ì°©: focusë  ë•Œë§Œ ë¶™ì´ê³  blur ë•Œ ë–¼ê¸°</p>
  </li>
  <li>
    <p>ì´ë²¤íŠ¸ ìœ„ì„: ë¬¸ì„œ í•˜ë‚˜ì— keydownÂ·focusin ë¦¬ìŠ¤ë„ˆë§Œ ë‘ê³ , íƒ€ê¹ƒì´ í¸ì§‘ê¸°ì¼ ë•Œë§Œ ë™ì‘</p>
  </li>
</ol>

<p>ê·œëª¨ê°€ ì»¤ì§ˆìˆ˜ë¡ 3ë²ˆ(ìœ„ì„)ì´ ë©”ëª¨ë¦¬Â·ì„±ëŠ¥Â·ìœ ì§€ë³´ìˆ˜ ì¸¡ë©´ì—ì„œ ê¹”ë”í•´. í‚¤ ì´ë²¤íŠ¸ëŠ” ë²„ë¸”ë§ë˜ë¯€ë¡œ ë¬¸ì„œ ë ˆë²¨ì—ì„œ ì¡ì•„ë„ selection ì¡°ì‘ì´ ê°€ëŠ¥í•´.</p>

<p>ì•„ë˜ëŠ” â€œìœ„ì„ ë°©ì‹â€ìœ¼ë¡œ ë°”ê¾¼ ìµœì†Œ êµ¬í˜„ì´ì•¼. ë„¤ê°€ ì´ë¯¸ ë§Œë“  KO/EN ëª¨ë“œ, ë‹¨ì¶•í‚¤ ê°€ë“œ, ìëª¨/ìŒì ˆ ì‚­ì œ, undo ìŠ¤íƒ ë³´ì¡´ê¹Œì§€ ë°˜ì˜í–ˆì–´.</p>

<p>í•µì‹¬ ì•„ì´ë””ì–´<br />
â€¢ ì „ì—­ í•œê¸€ ëª¨ë“œ ìƒíƒœ: koreanInput.mode ìœ ì§€<br />
â€¢ focusinì—ì„œ ëŒ€ìƒë§Œ ìµœì†Œ ì„¤ì •(ìë™ êµì • ë„ê¸° ë“±)<br />
â€¢ keydownì€ ë¬¸ì„œ í•˜ë‚˜ì—ë§Œ ë‘ê³ , ëŒ€ìƒì´ í¸ì§‘ê¸°ë©´ ë™ì‘<br />
â€¢ Ctrl/Meta ì¡°í•©, IME ì¡°í•© ì¤‘, ë¶™ì—¬ë„£ê¸° ë“±ì€ í†µê³¼</p>

<p>ì˜ˆì‹œ ì½”ë“œ</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// ëŒ€ìƒ ì…€ë ‰í„°: textarea + í…ìŠ¤íŠ¸ ê³„ì—´ input
const EDITABLE_SELECTOR = [
  'textarea',
  'input:not([type])',
  'input[type="text"]',
  'input[type="search"]',
  'input[type="url"]',
  'input[type="tel"]',
  'input[type="password"]',
  'input[type="email"]'
].join(',');

function isEditable(el){
  return el &amp;&amp; el.matches &amp;&amp; el.matches(EDITABLE_SELECTOR);
}

function isToggleHotkey(e){
  return (e.ctrlKey &amp;&amp; !e.shiftKey &amp;&amp; !e.altKey &amp;&amp; e.code === 'Space') || (e.code === 'F2');
}
function isEditorShortcut(e){
  const altGraph = e.getModifierState &amp;&amp; e.getModifierState('AltGraph');
  const ctrlMeta = e.ctrlKey || e.metaKey;
  const ctrlAlt  = e.ctrlKey &amp;&amp; e.altKey;
  return altGraph || ctrlAlt || ctrlMeta;
}

// Undo ê°€ëŠ¥í•œ ì¹˜í™˜
function applyEditWithUndo(el, start, end, replacement, collapse='end'){
  if (typeof el.setRangeText === 'function'){
    el.setRangeText(replacement, start, end, collapse);
    const pos = collapse === 'start' ? start : start + replacement.length;
    el.setSelectionRange(pos, pos);
  } else {
    const v = el.value;
    el.value = v.slice(0,start) + replacement + v.slice(end);
    const pos = collapse === 'start' ? start : start + replacement.length;
    el.setSelectionRange(pos, pos);
  }
}

// ë¹ ë¥¸ ì—°íƒ€/ê¸¸ê²Œ ëˆ„ë¦„ì— ë”°ë¼ ìëª¨/ìŒì ˆ ì‚­ì œ ì„ íƒ
let bsLastTs = 0;
const BS_RAPID_MS = 220;

document.addEventListener('DOMContentLoaded', () =&gt; {
  const koreanInput = new KoreanInput();
  window.koreanInput = koreanInput;

  const badge = document.getElementById('imeBadge');
  if (badge) badge.setAttribute('data-mode', koreanInput.mode);

  // ë°°ì§€ í´ë¦­ìœ¼ë¡œ ëª¨ë“œ ì „í™˜
  badge?.addEventListener('click', () =&gt; koreanInput.toggleMode());

  // í¬ì»¤ìŠ¤ ë“¤ì–´ì˜¤ë©´ ìµœì†Œ ì„¤ì •ë§Œ ì ìš©
  document.addEventListener('focusin', (e) =&gt; {
    const el = e.target;
    if (!isEditable(el)) return;
    el.setAttribute('autocomplete','off');
    el.setAttribute('autocapitalize','off');
    el.setAttribute('spellcheck','false');
    koreanInput.reset();
  });

  // ì „ì—­ í† ê¸€ ë‹¨ì¶•í‚¤(ì–´ë””ì„œë“ )
  document.addEventListener('keydown', (e) =&gt; {
    if (e.isComposing || e.key === 'Process') return;
    if (isToggleHotkey(e)){
      e.preventDefault();
      koreanInput.toggleMode();
    }
  });

  // í•µì‹¬: í¸ì§‘ìš© keydown ìœ„ì„
  document.addEventListener('keydown', (e) =&gt; {
    const el = e.target;
    if (!isEditable(el)) return;
    if (e.isComposing || e.key === 'Process') return;

    // í‘œì¤€ í¸ì§‘ ë‹¨ì¶•í‚¤ëŠ” í•­ìƒ í†µê³¼
    if (isEditorShortcut(e)) return;

    // EN ëª¨ë“œë©´ ì•„ë¬´ ê²ƒë„ ê°€ë¡œì±„ì§€ ì•ŠìŒ
    if (koreanInput.mode === 'en') return;

    // KO ëª¨ë“œë§Œ ì•„ë˜ ë¡œì§ ì‹¤í–‰
    if (e.key === 'Backspace'){
      // ë‹¨ì–´ ì‚­ì œ ê°™ì€ ì¡°í•©í‚¤ëŠ” í†µê³¼
      if (e.ctrlKey || e.metaKey) return;

      e.preventDefault();

      const now = performance.now();
      const rapid = (now - bsLastTs) &lt; BS_RAPID_MS;
      bsLastTs = now;
      const syllableMode = e.repeat || rapid;

      const s = el.selectionStart;
      const rStart = (() =&gt; {
        if (s === el.selectionEnd){ // ì»¤ì„œë§Œ
          if (s === 0) return s;
          const left = el.value.slice(0, s);
          if (syllableMode){
            // ìŒì ˆ ë‹¨ìœ„ ì‚­ì œ: ì½”ë“œí¬ì¸íŠ¸ 1ê°œ ì œê±°
            return s - 1;
          } else {
            // ìëª¨ ë‹¨ìœ„ ì‚­ì œ: ì¡°í•© ë¶„í•´ í›„ í•œ ë‹¨ê³„
            const newLeft = koreanInput.handleBackspace(left);
            return newLeft.length;
          }
        } else {
          // ì„ íƒ ì‚­ì œ
          return s;
        }
      })();

      const rEnd = el.selectionEnd;
      if (s === rEnd){
        // ì»¤ì„œ í•œìª½ ì‚­ì œ: rStart..s ë²”ìœ„ë¥¼ ë¹ˆ ë¬¸ìì—´ë¡œ
        applyEditWithUndo(el, rStart, s, '', 'start');
        // ìƒíƒœ ë³µêµ¬
        const pos = el.selectionStart;
        if (pos &gt; 0){
          const ch = el.value[pos - 1];
          koreanInput.restoreStateFromCharacter(ch);
        } else {
          koreanInput.reset();
        }
      } else {
        // ì„ íƒ ì‚­ì œ
        applyEditWithUndo(el, s, rEnd, '', 'start');
        const pos = el.selectionStart;
        if (pos &gt; 0){
          const ch = el.value[pos - 1];
          koreanInput.restoreStateFromCharacter(ch);
        } else {
          koreanInput.reset();
        }
      }
      return;
    }

    if (e.key === ' '){
      if (e.ctrlKey || e.altKey || e.metaKey) return;
      e.preventDefault();
      applyEditWithUndo(el, el.selectionStart, el.selectionEnd, ' ', 'end');
      koreanInput.reset();
      return;
    }

    // íŠ¹ìˆ˜í‚¤(Shift ë“±)ëŠ” í†µê³¼
    if (e.key.length &gt; 1 &amp;&amp; e.key !== 'Shift') return;

    const char = koreanInput.getCharacter(e.key, e.shiftKey);
    if (!char) return;

    e.preventDefault();

    // smartInsertë¥¼ ìœ„í•´ í˜„ì¬ ë²”ìœ„ ì „ë‹¬
    const s = el.selectionStart;
    const ins = koreanInput.smartInsert(el.value, s, el.selectionEnd, char);

    // ê°€ì¥ ê¹”ë”í•œ ë°©ë²•ì€ smartInsertê°€ ë³€ê²½ ë²”ìœ„ë¥¼ ì•Œë ¤ì£¼ëŠ” ê²ƒ
    // ì—†ìœ¼ë‹ˆ ê°„ë‹¨í•˜ê²Œ ì „ì²´ ì¹˜í™˜ ëŒ€ì‹ , ë°”ë€ ì•ìª½ ê¸¸ì´ë§Œí¼ ë®ì–´ì“°ê¸°
    // ì‹¤ë¬´ì—ì„œëŠ” smartInsert ë°˜í™˜ê°’ì„ {rangeStart, rangeEnd, replacement, cursorPosition}ìœ¼ë¡œ í™•ì¥ ì¶”ì²œ
    el.value = ins.text; // ì„ì‹œ ì—…ë°ì´íŠ¸
    el.setSelectionRange(ins.cursorPosition, ins.cursorPosition);
  });
});
</code></pre></div></div>

<p>ì™œ ìœ„ì„ì´ ì¢‹ì€ê°€<br />
â€¢ ë¦¬ìŠ¤ë„ˆë¥¼ ìˆ˜ì²œ ê°œ ë¶™ì´ì§€ ì•Šì•„ë„ ë˜ê³ , ë™ì ìœ¼ë¡œ ìƒê¸°ëŠ” ì…ë ¥ í•„ë“œë„ ìë™ ì»¤ë²„ëœë‹¤.<br />
â€¢ í¬ì»¤ìŠ¤ë  ë•Œë§Œ ìµœì†Œ ì†ì„± ì„¸íŒ…í•˜ê³ , ì‹¤ì œ ì—°ì‚°ì€ í‚¤ ëˆŒë¦´ ë•Œ íƒ€ê¹ƒì´ í¸ì§‘ê¸°ì¸ ê²½ìš°ì—ë§Œ ìˆ˜í–‰í•œë‹¤.<br />
â€¢ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ìœ„í—˜ì´ ì¤„ê³ , ìœ ì§€ë³´ìˆ˜ê°€ ì‰½ë‹¤.</p>

<p>ì–¸ì œ í¬ì»¤ìŠ¤-ë¶€ì°© ë°©ì‹ì´ ì¢‹ì„ê¹Œ<br />
â€¢ keydown ë¡œì§ì„ ìš”ì†Œë³„ë¡œ ë‹¬ë¦¬í•´ì•¼ í•˜ê±°ë‚˜, íŠ¹ì • ì…ë ¥ë§Œ ì»¤ìŠ¤í…€ ì¡°í•©ì„ ì“°ê³  ë‚˜ë¨¸ì§€ëŠ” ì™„ì „íˆ ë°°ì œí•˜ê³  ì‹¶ì„ ë•Œ. ì´ ê²½ìš° focusinì—ì„œ attach, focusoutì—ì„œ detachí•˜ë©´ ëœë‹¤. ë‹¤ë§Œ attach/detach ê´€ë¦¬ ì½”ë“œê°€ ë³µì¡í•´ì§€ê³ , ë™ì  ìƒì„±Â·íŒŒê´´ê°€ ì¦ìœ¼ë©´ ëˆ„ë½ ìœ„í—˜ì´ ìˆë‹¤.</p>

<p>ë§ˆì§€ë§‰ íŒ<br />
â€¢ Shadow DOM ë‚´ë¶€ ì…ë ¥(ì˜ˆ: ì¼ë¶€ UI ë¼ì´ë¸ŒëŸ¬ë¦¬)ì€ ë¬¸ì„œ ë ˆë²¨ ìœ„ì„ìœ¼ë¡œëŠ” ëª» ì¡ì„ ìˆ˜ ìˆë‹¤. ê·¸ë• ì»´í¬ë„ŒíŠ¸ë§ˆë‹¤ focusinì—ì„œ ë³„ë„ë¡œ ë¶™ì—¬ì£¼ì.<br />
â€¢ contenteditable í™•ì¥ ê³„íšì´ ìˆìœ¼ë©´ Selection APIìš© ì–´ëŒ‘í„°ë¥¼ ì¶”ê°€ë¡œ ë§Œë“¤ì–´, ê°™ì€ ìœ„ì„ êµ¬ì¡°ì— íƒœì›Œì£¼ë©´ ëœë‹¤.</p>

<p>ì›í•˜ë©´ smartInsertê°€ ë³€ê²½ ë²”ìœ„ë¥¼ ë¦¬í„´í•˜ë„ë¡ ì„¤ê³„ ë°”ê¿”ì„œ, undo ìŠ¤íƒë„ ë” ìì—°ìŠ¤ëŸ½ê²Œ ëŠê¸°ê²Œ ìµœì í™”í•´ ì¤„ê²Œ.</p>]]></content><author><name>hvppyarchive</name></author><category term="misc" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">untitled</title><link href="https://hvppyarchive.github.io/misc/virutual-korean-keyboard/" rel="alternate" type="text/html" title="untitled" /><published>2025-11-07T17:47:20+09:00</published><updated>2025-11-07T17:47:20+09:00</updated><id>https://hvppyarchive.github.io/misc/virutual-korean-keyboard</id><content type="html" xml:base="https://hvppyarchive.github.io/misc/virutual-korean-keyboard/"><![CDATA[<h3 id="chatgpt404-not-found">ChatGPT404 Not Found</h3>

<p>Paths cross empty void Seeking what once existed Silence answers all.</p>]]></content><author><name>hvppyarchive</name></author><category term="misc" /><summary type="html"><![CDATA[ChatGPT404 Not Found]]></summary></entry><entry><title type="html">Python ì½”ë“œ ì‹¤í–‰ Tool Calling</title><link href="https://hvppyarchive.github.io/llm/python-interpreter-tool-calling/" rel="alternate" type="text/html" title="Python ì½”ë“œ ì‹¤í–‰ Tool Calling" /><published>2025-11-05T17:49:25+09:00</published><updated>2025-11-05T17:49:25+09:00</updated><id>https://hvppyarchive.github.io/llm/python-interpreter-tool-calling</id><content type="html" xml:base="https://hvppyarchive.github.io/llm/python-interpreter-tool-calling/"><![CDATA[<p class="chat--user">

ì•„ë˜ì™€ ê°™ì€ Code Interpreter íˆ´ì„ ë‚˜ì˜ (vLLM + GPTOSS / Qwen) + (OpenAI Agents SDK) ì‹œìŠ¤í…œì— ë„£ê³  ì‹¶ì–´. ë‚´ê°€ ì›í•˜ëŠ” ê²ƒì€ ì‚¬ì‹¤ ì´ê±° í•˜ë‚˜ì•¼. íŒŒì´ì¬ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë˜, ì™¸ë¶€ì˜ íŒŒì¼ë“¤ì„ ë§ì¹˜ì§€ ì•Šì•˜ìœ¼ë©´ ì¢‹ê² ì–´. ê·¸ì™€ ë™ì‹œì— í˜¸ìŠ¤íŠ¸ íŒŒì¼ë“¤ì— ë‹¨ìˆœ ì ‘ê·¼ì€ ì¢€ ììœ ë¡œì›Œë„ ì¢‹ì„ ê²ƒ ê°™ì•„. íŒŒì¼ì„ ìƒì„±/ìˆ˜ì •ì´ í•„ìš”í•˜ë©´ ì§€ì •í•œ í´ë” ì•ˆì— ë³µì‚¬í•´ì„œ ë‹¤ë£¨ë©´ ì¢‹ì„ ê²ƒ ê°™ì•„. ê·¸ë¦¬ê³  ë„ì»¤ê°€ ì—†ì´ ì´ëŸ° ì‹œìŠ¤í…œì„ êµ¬ì„±í•˜ê³  ì‹¶ì–´ #!/usr/bin/env python # coding: utf-8 # ## Build Your Own Code Interpreter - Dynamic Tool Generation and Execution With o3-mini # # At the core of providing a LLM Agent capability to interact with the outside world or other Agents is â€œtool (or function) calling,â€ where a LLM can invoke a function (a block of code) with arguments. Typically, these functions are predefined by the developer, along with their expected inputs and outputs. However, in this Cookbook, we explore a more flexible paradigm - to <strong>dynamically generate tools</strong> using LLM models (in this case <strong>o3-mini</strong>), with ability to execute the tool using a code interpreter. # # ### Dynamically Generated Tool Calling with Code Interpreter # A Dynamically Generated Tool is a function or code block created by the LLM itself at runtime based on the userâ€™s prompt. This means you donâ€™t have to predefine every possible scenario in your codebaseâ€”enabling far more open-ended, creative, and adaptive problem-solving. # # Dynamically Generated Tool Calling goes a step further by granting the LLM the ability to generate tools and execute code blocks on the fly. This dynamic approach is particularly useful for tasks that involve: # # - Data analysis and visualization # - Data manipulation and transformation # - Machine learning workflow generation and execution # - Process automation and scripting # - And much more, as new possibilities emerge through experimentation # # ### Using o3-mini for Dynamic Tool generation # # Released on 31-Jan-25, o3-mini model has exceptional STEM capabilitiesâ€”with particular strength in science, math, and codingâ€”all while maintaining the low cost and reduced latency of smaller models. In this Cookbook, we will demonstrate o3-mini's capabilities to generate python code to interpret data and draw insights. # # Reasoning models are particularly good at generating dynamic tools to analyze data since they can reason on their own, without the need of an explicit chain-of-thought prompt. In fact, providing explicit chain of thought instructions may interfere with model's internal reasoning and lead to suboptimal outcomes. You can learn more about o3-mini <a href="https://openai.com/index/openai-o3-mini/">here.</a> # # ### Why build your own code interpreter # # Many API providersâ€”such as OpenAIâ€™s Assistants APIâ€”offer built-in code interpreter functionality. These built-in code interpreters can be immensely powerful, but there are situations where developers may need to create their own custom code interpreter. For example: # # 1. <strong>Language or library support</strong>: The built-in interpreter may not support the specific programming language (e.g., C++, Java, etc.) or libraries required for your task. # 2. <strong>Task compatibility</strong>: Your use case may not be compatible with the providerâ€™s built-in solution. # 3. <strong>Model constraints</strong>: You might require a language model that isnâ€™t supported by the providerâ€™s interpreter. # 4. <strong>Cost considerations</strong>: The cost structure for code execution or model usage may not fit your budget or constraints. # 5. <strong>File size</strong>: The file size of input data is too large or not supported by the provider's interpreter. # 6. <strong>Integrating with internal systems</strong>: The provider's interpreter may not be able to integrate with your internal systems. # # ### What Youâ€™ll Learn # By following this Cookbook, you will learn how to: # # - Set up an isolated Python code execution environment using Docker # - Configure your own code interpreter tool for LLM agents # - Establish a clear separation of â€œAgenticâ€ concerns for security and safety # - Using <strong>o3-mini</strong> model to dynamically generate code for data analysis # - Orchestrate agents to efficiently accomplish a given task # - Design an agentic application that can dynamically generate and execute code # # Youâ€™ll learn how to build a custom code interpreter tool from the ground up, leverage the power of LLMs to generate sophisticated code, and safely execute that code in an isolated environmentâ€”all in pursuit of making your AI-powered applications more flexible, powerful, and cost-effective. # ### Example Scenario # # We'll use the sample data provided at <a href="https://www.kaggle.com/datasets/willianoliveiragibin/key-factors-traffic-accidents">Key Factors Traffic Accidents</a> to answer a set of questions. These questions do not require to be pre-defined, we will give LLM the ability to generate code to answer such question. # # Sample questions could be: # - What factors contribute the most to accident frequency? (Feature importance analysis) # - Which areas are at the highest risk of accidents? (Classification/Clustering) # - How does traffic fine amount influence the number of accidents? (Regression/Causal inference) # - Can we determine the optimal fine amounts to reduce accident rates? (Optimization models) # - Do higher fines correlate with lower average speeds or reduced accidents? (Correlation/Regression) # - and so on â€¦ # # Using the traditional <strong>Predefined Tool Calling</strong> approach, developer would need to pre-define the function for each of these questions. This limits the LLM's ability to answer any other questions not defined in the pre-defined set of functions. We overcome this limitation by using the <strong>Dynamic Tool Calling</strong> approach where the LLM generates code and uses a Code Interpretter tool to execute the code. # ## Overview # Let's dive into the steps to build this Agentic Applicaiton with Dynamically generated tool calling. There are three components to this application: # #### Step 1: Set up an isolated code execution container environment # # We need a secure environment where our LLM generated function calls can be executed. We want to avoid directly running the LLM generated code on the host machine so will create a Docker container environment with restricted resource access (e.g., no network access). By default, Docker containers cannot access the host machineâ€™s file system, which helps ensure that any code generated by the LLM remains contained. # # ##### âš ï¸ A WORD OF CAUTION: Implement Strong Gaurdrails for the LLM generated code # LLMs could generate harmful code with unintended consequences. As a best practice, isolate the code execution environment with only required access to resources as needed by the task. Avoid running the LLM generated code on your host machine or laptop. # # #### Step 2: Define and Test the Agents # # "<strong>What is an Agent?</strong>" In the context of this Cookbook, an Agent is: # 1. Set of instructions for the LLM to follow, i.e. the developer prompt # 2. A LLM model, and ability to call the model via the API # 3. Tool call access to a function, and ability to execute the function # # We will define two agents: # 1. FileAccessAgent: This agent will read the file and provide the context to the PythonCodeExecAgent. # 2. PythonCodeExecAgent: This agent will generate the Python code to answer the user's question and execute the code in the Docker container. # # #### Step 3: Set up Agentic Orchestration to run the application # There are various ways to orchestrate the Agents based on the application requirements. In this example, we will use a simple orchestration where the user provides a task and the agents are called in sequence to accomplish the task. # # The overall orchestration is shown below: # # <img src="../../images/oo_aa_image_1_code_interpreter_agents.png" alt="" /> # ## Let's get started # # # ### Prerequisites # Before you begin, ensure you have the following installed and configured on your host machine: # # 1. Docker: installed and running on your local machine. You can learn more about Docker and <a href="https://www.docker.com/">install it from here</a>. # 2. Python: installed on your local machine. You can learn more about Python and <a href="https://www.python.org/downloads/">install it from here</a>. # 3. OpenAI API key: set up on your local machine as an environment variable or in the .env file in the root directory. You can learn more about OpenAI API key and <a href="https://platform.openai.com/docs/api-reference/introduction">set it up from here</a>. # # ### Step 1: Set up an Isolated Code Execution Environment # # Lets define a Dockerized container environment that will be used to execute our code. I have defined the <strong><a href="https://github.com/openai/openai-cookbook/blob/main/examples/object_oriented_agentic_approach/resources/docker/dockerfile">dockerfile</a></strong> under <code class="language-plaintext highlighter-rouge">resources/docker</code> directory that will be used to create the container environment with the following specifications: # - Python 3.10 as the base # - A non-root user # - Preinstall the packages in requirements.txt # # The requirements.txt included in the docker image creation process contains all the potential packages our LLM generated code may need to accomplish its tasks. Given we will restrict the container from network access, so we need to pre-install the packages that are required for the task. Our LLM will not be allowed to install any additional packages for security purposes. # # You could create your own docker image with the language requirements (such as Python 3.10) and pre-install the packages that are required for the task, or create a custom docker image with the specific language (such as Java, C++, etc.) and packages that are required for the task. # Let's build the docker image with the following command. For the sake of brevity, I have redirected the output to grep the success message and print a message if the build fails. # In[1]: get_ipython().system('docker build -t python_sandbox:latest ./resources/docker 2&gt;&amp;1 | grep -E "View build details|ERROR" || echo "Build failed."') # Let's run the container in restricted mode. The container will run in the background. This is our opportunity to define the security policies for the container. It is good practice to only allow the bare minimum features to the container that are required for the task. By default, the container cannot access the host file system from within the container. Let's also restrict its access to network so it cannot access the Internet or any other network resources. # In[2]: # Run the container in restricted mode. The container will run in the background. get_ipython().system('docker run -d â€“name sandbox â€“network none â€“cap-drop all â€“pids-limit 64 â€“tmpfs /tmp:rw,size=64M python_sandbox:latest sleep infinity') # Let's make sure container is running using the <code class="language-plaintext highlighter-rouge">docker ps</code> that should list our container. # In[3]: get_ipython().system('docker ps') # ### Step 2: Define and Test the Agents # # For our purposes, we will define two agents. # 1. <strong>Agent 1: File Access Agent (with Pre-defined Tool Calling)</strong> # - Instructions to understand the contents of the file to provide as context to Agent 2. # - Has access to the host machineâ€™s file system. # - Can read a file from the host and copy it into the Docker container. # - Cannot access the code interpreter tool. # - Uses gpt-4o model. # # 2. <strong>Agent 2: Python Code Generator and Executor (with Dynamically Generated Tool Calling and Code Execution)</strong> # - Recieve the file content's context from Agent 1. # - Instructions to generate a Python script to answer the user's question. # - Has access to the code interpreter within the Docker container, which is used to execute Python code. # - Has access only to the file system inside the Docker container (not the host). # - Cannot access the host machineâ€™s file system or the network. # - Uses our newest <strong>o3-mini</strong> model that excels at code generation. # # This separation concerns of the File Access (Agent 1) and the Code Generator and Executor (Agent 2) is crucial to prevent the LLM from directly accessing or modifying the host machine. # # # <strong>Limit the Agent 1 to Static Tool Calling as it has access to the host file system.</strong> # # # | Agent | Type of Tool Call | Access to Host File System | Access to Docker Container File System | Access to Code Interpreter | # |â€”â€”-|â€”â€”â€”â€”â€”â€”-|â€”â€”â€”â€”â€”â€”â€”â€”â€”-|â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-|â€”â€”â€”â€”â€”â€”â€”â€”â€”-| # | Agent 1: File Access | Pre-defined Tools | Yes | Yes | No | # | Agent 2: Python Code Generator and Executor | Dynamically Generated Tools | No | Yes | Yes | # # To keep the Agents and Tools organized, we've defined a set of <strong>core classes</strong> that will be used to create the two agents for consistency using Object Oriented Programming principles. # # - <strong>BaseAgent</strong>: We start with an abstract base class that enforces common method signatures such as <code class="language-plaintext highlighter-rouge">task()</code>. Base class also provides a logger for debugging, a language model interface and other common functions such as <code class="language-plaintext highlighter-rouge">add_context()</code> to add context to the agent. # - <strong>ChatMessages</strong>: A class to store the conversation history given ChatCompletions API is stateless. # - <strong>ToolManager</strong>: A class to manage the tools that an agent can call. # - <strong>ToolInterface</strong>: An abstract class for any 'tool' that an agent can call so that the tools will have a consistent interface. # # These classes are defined in the <a href="./resources/object_oriented_agents/core_classes">object_oriented_agents/core_classes</a> directory. # #### UML Class Diagram for Core Classes # The following class diagram shows the relationship between the core classes. This UML (Unified Modeling Language) has been generated using <a href="https://mermaid">Mermaid</a> # # <img src="../../images/oo_aa_image_2_uml_diagram.png" alt="" /> # <strong>Define Agent 1: FileAccessAgent with FileAccessTool</strong> # # Let's start with definin the FileAccessTool that inherits from the ToolInterface class. The <strong>FileAccessTool</strong> tool is defined in the <a href="https://github.com/openai/openai-cookbook/blob/main/examples/object_oriented_agentic_approach/resources/registry/tools/file_access_tool.py">file_access_tool.py</a> file in the <code class="language-plaintext highlighter-rouge">resources/registry/tools</code> directory. # # - FileAccessTool implements the ToolInterface class, which ensures that the tools will have a consistent interface. # - Binding the tool definition for the OpenAI Function Calling API in the <code class="language-plaintext highlighter-rouge">get_definition</code> method and the tool's <code class="language-plaintext highlighter-rouge">run</code> method ensures maintainability, scalability, and reusability. # Now, let's define the <strong>FileAccessAgent</strong> that extends the BaseAgent class and bind the <strong>FileAccessTool</strong> to the agent. The FileAccessAgent is defined in the <a href="https://github.com/openai/openai-cookbook/blob/main/examples/object_oriented_agentic_approach/resources/registry/agents/file_access_agent.py">file_acess_agent.py</a> file in <code class="language-plaintext highlighter-rouge">resources/registry/agents</code> directory. The FileAccessAgent is: # # - A concrete implementation of the BaseAgent class. # - Initialized with the developer prompt, model name, logger, and language model interface. These values can be overridden by the developer if needed. # - Has a setup_tools method that registers the FileAccessTool to the tool manager. # - Has a <code class="language-plaintext highlighter-rouge">task</code> method that calls the FileAccessTool to read the file and provide the context to the PythonCodeExecAgent. # - <code class="language-plaintext highlighter-rouge">model_name='gpt-4o'</code> that provides sufficient reasoning and tool calling ability for the task. # # <strong>Define Agent 2: PythonExecAgent with PythonExecTool</strong> # # Similarly, PythonExecTool inherits from the ToolInterface class and implements the get_definition and run methods. The get_definition method returns the tool definition in the format expected by the OpenAI Function Calling API. The run method executes the Python code in a Docker container and returns the output. This tool is defined in the <a href="https://github.com/openai/openai-cookbook/blob/main/examples/object_oriented_agentic_approach/resources/registry/tools/python_code_interpreter_tool.py">python_code_interpreter_tool.py</a> file in the <code class="language-plaintext highlighter-rouge">resources/registry/tools</code> directory. # # Likewise, PythonExecAgent is a concrete implementation of the BaseAgent class. It is defined in the <a href="https://github.com/openai/openai-cookbook/blob/main/examples/object_oriented_agentic_approach/resources/registry/agents/python_code_exec_agent.py">python_code_exec_agent.py</a> file in the <code class="language-plaintext highlighter-rouge">resources/registry/agents</code> directory. The PythonExecAgent is: # # - A concrete implementation of the BaseAgent class. # - Initialized with the developer prompt, model name, logger, and language model interface. These values can be overridden by the developer if needed. # - Has a setup_tools method that registers the PythonExecTool to the tool manager. # - Has a <code class="language-plaintext highlighter-rouge">task</code> method that calls the OpenAI API to perform the user's task, which in this case involves generating a Python script to answer the user's question and run it with Code Interpreter tool. # - <code class="language-plaintext highlighter-rouge">model_name='o3-mini'</code> that excels at STEM tasks such as code generation. # - <code class="language-plaintext highlighter-rouge">reasoning_effort='high'</code> that allows for more complete reasoning given the complexity of the task at the cost of more tokens generated and slower responses. The default value is medium, which is a balance between speed and reasoning accuracy. # # You can learn more about the <code class="language-plaintext highlighter-rouge">reasoning_effort</code> parameter <a href="https://platform.openai.com/docs/guides/reasoning">here</a>. # ### Step 3: Set up Agentic Orchestration to run the application # # With the Agents defined, now we can define the orchestration loop that will run the application. This loop will prompt the user for a question or task, and then call the FileAccessAgent to read the file and provide the context to the PythonExecAgent. The PythonExecAgent will generate the Python code to answer the user's question and execute the code in the Docker container. The output from the code execution will be displayed to the user. # # User can type 'exit' to stop the application. Our question: <strong>What factors contribute the most to accident frequency?</strong> Note that we did not pre-define the function to answer this question. # # # In[4]: # Import the agents from registry/agents from resources.registry.agents.file_access_agent import FileAccessAgent from resources.registry.agents.python_code_exec_agent import PythonExecAgent prompt = """Use the file traffic_accidents.csv for your analysis. The column names are: Variable Description accidents Number of recorded accidents, as a positive integer. traffic_fine_amount Traffic fine amount, expressed in thousands of USD. traffic_density Traffic density index, scale from 0 (low) to 10 (high). traffic_lights Proportion of traffic lights in the area (0 to 1). pavement_quality Pavement quality, scale from 0 (very poor) to 5 (excellent). urban_area Urban area (1) or rural area (0), as an integer. average_speed Average speed of vehicles in km/h. rain_intensity Rain intensity, scale from 0 (no rain) to 3 (heavy rain). vehicle_count Estimated number of vehicles, in thousands, as an integer. time_of_day Time of day in 24-hour format (0 to 24). accidents traffic_fine_amount """ print("Setup: ") print(prompt) print("Setting up the agentsâ€¦ ") # Instantiate the agents with the default constructor defined values # Developer may override the default values - prompt, model, logger, and language model interface if needed # This agent use gpt-4o by default file_ingestion_agent = FileAccessAgent() # Let's make sure agent uses o3-mini model and set the reasoning_effort to high data_analysis_agent = PythonExecAgent(model_name='o3-mini', reasoning_effort='high') print("Understanding the contents of the fileâ€¦") # Give a task to the file ingestion agent to read the file and provide the context to the data analysis agent file_ingestion_agent_output = file_ingestion_agent.task(prompt) # Add the file content as context to the data analysis agent # The context is added to the agent's tool manager so that the tool manager can use the context to generate the code data_analysis_agent.add_context(prompt) data_analysis_agent.add_context(file_ingestion_agent_output) while True: print("Type your question related to the data in the file. Type 'exit' to exit.") user_input = input("Type your question.") if user_input == "exit": print("Exiting the application.") break print(f"User question: {user_input}") print("Generating dynamic tools and using code interpreterâ€¦") data_analysis_agent_output = data_analysis_agent.task(user_input) print("Outputâ€¦") print(data_analysis_agent_output) # In this example, the <strong>o3-mini</strong> dynamically generated a tool (Python script) based on user's question to analyze the data. Note that <strong>o3-mini</strong> examined the problem using multiple approaches such as correlation analysis, linear regression and random forest models. This approach highlights the following: # # <strong>reasoning_effort</strong>: The depth of reasoning the model performs e.g., in this case number of approaches, generally increases when the parameter is increased from low, medium to high. You can try with different levels of reasoning effort to see the difference. # # <strong>Dynamically Generated Tool Calling</strong>: The tool (Python script) to analyze the data was not manually written or predetermined by the developer. Instead, the o3-mini model created the relevant data exploration and correlation analysis code at runtime. # # <strong>Isolated Code Execution</strong>: To ensure security and avoid running untrusted code on the host machine, the Python script was executed inside a Docker container using the <code class="language-plaintext highlighter-rouge">execute_python_code</code> tool. This container had restricted resource access (e.g., no network and limited filesystem access), minimizing potential risks posed by arbitrary code execution. # # ### Conclusion # # The Cookbook provides a guide for developing a <strong>custom code interpreter</strong> tailored to specific application needs, addressing limitations found in vendor-provided solutions such as language constraints, cost considerations, and the need for flexibility with different LLMs or models. # # <strong>Approach for Managing Agents and Tools</strong>: We also defined a set of core classes to manage the agents and tools. This approach ensures that the agents and tools will have a consistent interface and can be reused across different applications. A repository of agents and tools such as the <a href="https://github.com/openai/openai-cookbook/tree/main/examples/object_oriented_agentic_approach/resources/registry">registry</a> folder can be created to manage the agents and tools. # # <strong>o3-mini model</strong>: We demonstrated o3-mini model's ability to generate sophisticated code at run time to analyze data based on user's minimal prompt. o3-mini model then reasoned over the outcome of the analysis to explain the results to the user. # # Finally, <strong>to recap</strong>, the three steps to build an Agentic Application with Dynamic Tool Calling are: # 1. Set up an isolated code execution container environment # 2. Define and Test the Agents # 3. Set up Agentic Orchestration to run the application # # We discussed the importance of isolating the code execution environment to ensure security and avoid running untrusted code on the host machine. With the use case of a CSV file, we demonstrated how to dynamically generate a tool (a Python script) to analyze the data and answer the user's question. We also showed how to execute the code in a Docker container and return the output to the user.

</p>

<p>í•œêµ­ì–´ë¡œ ë‹µí•¨.<br />
ë¬¸ì¥ ì•ì— ì¸ìš©(Blockquote) ê¸ˆì§€, ê·¸ëŒ€ë¡œ ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œë§Œ ì„œìˆ .</p>

<hr />

<h3 id="ë‹¹ì‹ ì´-ì›í•˜ëŠ”-ëª©í‘œë¥¼-ë‹¤ì‹œ-ì •ë¦¬í•˜ë©´-ë‹¤ìŒê³¼-ê°™ì•„">ë‹¹ì‹ ì´ ì›í•˜ëŠ” ëª©í‘œë¥¼ ë‹¤ì‹œ ì •ë¦¬í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì•„:</h3>

<ol>
  <li>
    <p>LLMì´ ìƒì„±í•œ <strong>íŒŒì´ì¬ ì½”ë“œë¥¼ ì‹¤í–‰</strong> í•˜ê³  ì‹¶ë‹¤.</p>
  </li>
  <li>
    <p>í•˜ì§€ë§Œ <strong>í˜¸ìŠ¤íŠ¸ íŒŒì¼ ì‹œìŠ¤í…œì„ ë§ê°€ëœ¨ë¦¬ê±°ë‚˜ ìˆ˜ì •í•˜ë©´ ì•ˆ ëœë‹¤</strong>.</p>
  </li>
  <li>
    <p>í•„ìš”í•  ê²½ìš° íŒŒì¼ì€ <strong>ì§€ì •ëœ ì‘ì—… í´ë”ì— ë³µì‚¬í•´ì„œ ê·¸ ì•ˆì—ì„œë§Œ ì²˜ë¦¬</strong> ë˜ê¸¸ ì›í•œë‹¤.</p>
  </li>
  <li>
    <p>Docker ì—†ì´ (ì¦‰, ì»¨í…Œì´ë„ˆ ì—†ì´) êµ¬í˜„í•˜ê³  ì‹¶ë‹¤.</p>
  </li>
  <li>
    <p>ì‹œìŠ¤í…œì€ vLLM + Qwen + OpenAI Agents SDK ë˜ëŠ” GPTOSS ê¸°ë°˜ìœ¼ë¡œ êµ¬ì„±í•˜ë ¤ê³  í•œë‹¤.</p>
  </li>
</ol>

<p>ì—¬ê¸°ì„œ ê°€ì¥ í° ë„ì „ì€ <strong>ë³´ì•ˆ ê²©ë¦¬ ì—†ì´ í˜¸ìŠ¤íŠ¸ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì½”ë“œ</strong> ë¥¼ ì–´ë–»ê²Œ ì•ˆì „í•˜ê²Œ ì œí•œí•˜ëŠëƒì´ë‹¤. DockerëŠ” ìì—°ìŠ¤ëŸ¬ìš´ í•´ê²°ì±…ì´ì§€ë§Œ, ë‹¹ì‹ ì´ ì›í•˜ì§€ ì•ŠëŠ”ë‹¤ê³  í–ˆìœ¼ë¯€ë¡œ <strong>Python ìì²´ì˜ ê°€ìƒí™” + ì‹œìŠ¤í…œ ìˆ˜ì¤€ì˜ sand-boxing(ê¶Œí•œ ì œí•œ)</strong> ë°©í–¥ìœ¼ë¡œ ì ‘ê·¼í•´ì•¼ í•œë‹¤.</p>

<p>ë‚˜ëŠ” ì•„ë˜ ë°©ì‹ìœ¼ë¡œ ì ‘ê·¼ì„ ì¶”ì²œí•œë‹¤.</p>

<hr />

<h2 id="ë‹¨ê³„ë³„-ì„¤ê³„-step-by-step">ë‹¨ê³„ë³„ ì„¤ê³„ (step-by-step)</h2>

<h3 id="1ë‹¨ê³„-ì‘ì—…-ë””ë ‰í† ë¦¬sandbox-workspace-êµ¬ì¡°-ì •ì˜">1ë‹¨ê³„. "ì‘ì—… ë””ë ‰í† ë¦¬(sandbox workspace)" êµ¬ì¡° ì •ì˜</h3>

<p>ì˜ˆì‹œ êµ¬ì¡°:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/host
   /data              â† ì›ë³¸ íŒŒì¼ë“¤ <span class="o">(</span>ì½ê¸° ì „ìš©<span class="o">)</span>
   /sandbox           â† LLM ìƒì„± ì½”ë“œê°€ ì‹¤í–‰ë˜ëŠ” í´ë” <span class="o">(</span>ì“°ê¸° ê°€ëŠ¥<span class="o">)</span>
   /runner            â† ì½”ë“œ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
</code></pre></div></div>

<p>ì›ë³¸ íŒŒì¼ ì ‘ê·¼ ë°©ì¹¨:</p>

<ul>
  <li>
    <p>í˜¸ìŠ¤íŠ¸ì˜ <code class="language-plaintext highlighter-rouge">/data</code> ëŠ” ì½ê¸°ë§Œ í—ˆìš©.</p>
  </li>
  <li>
    <p>ì‘ì—…ì— í•„ìš”í•œ íŒŒì¼ì´ ìˆìœ¼ë©´ <code class="language-plaintext highlighter-rouge">/sandbox</code> ë¡œ ë³µì‚¬í•œ ë’¤ ê·¸ ì•ˆì—ì„œë§Œ ì‚¬ìš©.</p>
  </li>
</ul>

<p>íŒŒì´ì¬ ì‹¤í–‰ í™˜ê²½ì—ì„œ <code class="language-plaintext highlighter-rouge">open()</code> ì´ /data ë¥¼ ìˆ˜ì •í•˜ì§€ ëª»í•˜ë„ë¡ ê°•ì œí•˜ë ¤ë©´, <code class="language-plaintext highlighter-rouge">runner</code> ë ˆë²¨ì—ì„œ path ê²€ì¦ì„ ë„£ì–´ì•¼ í•œë‹¤.</p>

<hr />

<h3 id="2ë‹¨ê³„-python-ì‹¤í–‰ì„-ì§„ì§œ-ë¶„ë¦¬ëœ-í”„ë¡œì„¸ìŠ¤ì—ì„œ-ì‹¤í–‰í•˜ê²Œ-í•˜ê¸°">2ë‹¨ê³„. Python ì‹¤í–‰ì„ "ì§„ì§œ ë¶„ë¦¬ëœ í”„ë¡œì„¸ìŠ¤"ì—ì„œ ì‹¤í–‰í•˜ê²Œ í•˜ê¸°</h3>

<p>í•µì‹¬ì€ ì½”ë“œ ì‹¤í–‰ì„ <strong>ì„œë¸Œ í”„ë¡œì„¸ìŠ¤ë¡œ ë¶„ë¦¬í•˜ëŠ” ê²ƒ</strong>.</p>

<p>ì˜ì‚¬ ì½”ë“œ:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>arduino

# runner.py
def run_code(code_string):
    ìƒì„±ëœ_ì½”ë“œë¥¼ /sandbox/temp.py ë¡œ ì €ì¥
    subprocess.run(["python", "/sandbox/temp.py"], timeout=5, cwd="/sandbox")
</code></pre></div></div>

<p>ì—¬ê¸°ì„œ ì¤‘ìš”í•œ ì•ˆì „ì¥ì¹˜:</p>

<ul>
  <li>
    <p>cwd ë¥¼ /sandbox ë¡œ ê³ ì •</p>
  </li>
  <li>
    <p>timeout (= ë¬´í•œ ë£¨í”„, while True ë°©ì§€)</p>
  </li>
  <li>
    <p>subprocess ì‹¤í–‰ ì „ì— íŒŒì¼ëª… ë° path ê²€ì¦</p>
  </li>
</ul>

<hr />

<h3 id="3ë‹¨ê³„-íŒŒì¼-ì ‘ê·¼-í•„í„°ë§-ì•ˆì „-ì¥ì¹˜">3ë‹¨ê³„. íŒŒì¼ ì ‘ê·¼ í•„í„°ë§ (ì•ˆì „ ì¥ì¹˜)</h3>

<p>íŒŒì´ì¬ ì½”ë“œì— ì§ì ‘ì ì¸ íŒŒì¼ ì ‘ê·¼ì„ ë§‰ìœ¼ë ¤ë©´:<br />
ë°©ë²• A. exec í™˜ê²½ì—ì„œ <code class="language-plaintext highlighter-rouge">open</code> ê°™ì€ builtins ì œê±°<br />
ë°©ë²• B. Python restricted environment ì ìš© (ëŒ€ì‹  ì™„ì „í•˜ì§€ ì•ŠìŒ)<br />
ë°©ë²• C. ì˜¤ë²„ë ˆì´ íŒŒì¼ì‹œìŠ¤í…œ ë˜ëŠ” chroot (Docker ì—†ì´ ê°€ëŠ¥)</p>

<p>ì—¬ê¸°ì„œëŠ” <strong>ê°€ì¥ ê°„ë‹¨í•œ ì‹¤ìš©ì  ë³´í˜¸</strong> ë¥¼ ì¶”ì²œí•œë‹¤.</p>

<p>ì˜ˆì œ ì½”ë“œ:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">safe_globals</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">range</span><span class="sh">"</span><span class="p">:</span> <span class="nb">range</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">len</span><span class="sh">"</span><span class="p">:</span> <span class="nb">len</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">print</span><span class="sh">"</span><span class="p">:</span> <span class="k">print</span><span class="p">,</span>
        <span class="c1"># í•„ìš”í•œ ìµœì†Œ ê¸°ëŠ¥ë§Œ í—ˆìš©
</span>    <span class="p">}</span>
<span class="p">}</span>

<span class="nf">exec</span><span class="p">(</span><span class="n">code_string</span><span class="p">,</span> <span class="n">safe_globals</span><span class="p">)</span>
</code></pre></div></div>

<p>ë‹¨, ë°ì´í„° ë¶„ì„ ëª©ì ì´ë¼ë©´ pandas, numpy í•„ìš”í•˜ë¯€ë¡œ ìœ„ ë°©ì‹ì´ ë„ˆë¬´ ì œí•œëœë‹¤.<br />
ê·¸ë˜ì„œ ë” í˜„ì‹¤ì ì¸ ë°©ë²•ì€ <strong>subprocess ì‹¤í–‰ + sys.setrecursionlimit ì œí•œ + resource ëª¨ë“ˆë¡œ ë©”ëª¨ë¦¬/CPU ì œí•œ</strong> ì´ë‹¤.</p>

<p>ì˜ˆì‹œ:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">resource</span>

<span class="n">resource</span><span class="p">.</span><span class="nf">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">RLIMIT_CPU</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>          <span class="c1"># CPU ì œí•œ 2ì´ˆ
</span><span class="n">resource</span><span class="p">.</span><span class="nf">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">RLIMIT_AS</span><span class="p">,</span> <span class="p">(</span><span class="mi">800</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">))</span>  <span class="c1"># ë©”ëª¨ë¦¬ 800MB ì œí•œ
</span></code></pre></div></div>

<hr />

<h3 id="4ë‹¨ê³„-openai-agents-sdk-ë˜ëŠ”-vllm-function-calling-ì„¤ê³„">4ë‹¨ê³„. OpenAI Agents SDK (ë˜ëŠ” vLLM Function-calling) ì„¤ê³„</h3>

<p>ì½”ë“œ ì‹¤í–‰ì„ í•˜ë‚˜ì˜ Tool ë¡œ ì •ì˜í•œë‹¤.</p>

<p>ê°œë…ì  pseudo-code:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">execute_python_tool</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">sandbox_path</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/sandbox/temp.py</span><span class="sh">"</span>
    <span class="n">codeë¥¼</span> <span class="n">sandbox_path</span> <span class="n">ì—</span> <span class="n">ì €ì¥</span>
    <span class="n">subprocessë¡œ</span> <span class="n">ì‹¤í–‰í•˜ê³ </span> <span class="n">stdout</span><span class="o">/</span><span class="n">stderr</span> <span class="n">ë°˜í™˜</span>
</code></pre></div></div>

<p>LLM ì—ê²Œ tool spec ì„ ì œê³µ:</p>
<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">tools</span> <span class="p">=</span> <span class="s">[</span>
    <span class="err">{</span>
        <span class="err">"type":</span> <span class="err">"function",</span>
        <span class="err">"name":</span> <span class="err">"execute_python_tool",</span>
        <span class="err">"description":</span> <span class="err">"Executes</span> <span class="err">python</span> <span class="err">code</span> <span class="err">inside</span> <span class="err">sandbox",</span>
        <span class="err">"parameters":</span> <span class="err">{</span>
            <span class="err">"type":</span> <span class="err">"object",</span>
            <span class="err">"properties":</span> <span class="err">{</span>
                <span class="err">"code":</span> <span class="err">{"type":</span> <span class="err">"string"}</span>
            <span class="err">},</span>
            <span class="err">"required":</span> <span class="nn">["code"]</span>
        <span class="err">}</span>
    <span class="err">}</span>
<span class="err">]</span>
</code></pre></div></div>

<p>vLLM(Qwen/GPTOSS) + Agents SDK ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ë™ì‘:</p>

<ul>
  <li>ì‚¬ìš©ìê°€ â€œë¶„ì„í•´ì¤˜â€ â†’ LLM â†’ ì½”ë“œ ìƒì„± â†’ tool í˜¸ì¶œ â†’ python ì‹¤í–‰ â†’ ê²°ê³¼ ë°˜í™˜.</li>
</ul>

<hr />

<h3 id="5ë‹¨ê³„-í˜¸ìŠ¤íŠ¸-íŒŒì¼-ë³´í˜¸-ì •ë¦¬">5ë‹¨ê³„. í˜¸ìŠ¤íŠ¸ íŒŒì¼ ë³´í˜¸ (ì •ë¦¬)</h3>

<p>ë³´ì•ˆ ìˆ˜ì¹™:</p>

<ol>
  <li>
    <p>ì½”ë“œ ì‹¤í–‰ì€ í•­ìƒ <strong>subprocessì—ì„œ</strong> ì‹¤í–‰.</p>
  </li>
  <li>
    <p>sandbox ë””ë ‰í† ë¦¬ ì™¸ ê²½ë¡œ ì ‘ê·¼ ì‹œ <strong>ì‹¤í–‰ ê±°ë¶€</strong>.</p>
  </li>
  <li>
    <p>CPU / ë©”ëª¨ë¦¬ / ì‹¤í–‰ì‹œê°„ ì œí•œ.</p>
  </li>
  <li>
    <p>ìƒì„±ëœ íŒŒì¼ë„ sandbox ë‚´ë¶€ì—ì„œë§Œ.</p>
  </li>
</ol>

<hr />

<h3 id="ìš”ì•½-ë‹¹ì‹ ì´-ì–»ëŠ”-ê²ƒ">ìš”ì•½ (ë‹¹ì‹ ì´ ì–»ëŠ” ê²ƒ)</h3>

<ul>
  <li>
    <p><strong>Docker ì—†ì´ë„ ê°€ëŠ¥í•œ code interpreter</strong></p>
  </li>
  <li>
    <p><strong>LLMì´ generate â†’ ì‹¤í–‰ â†’ ê²°ê³¼ ë°˜í™˜</strong> í•˜ëŠ” Pipeline</p>
  </li>
  <li>
    <p><strong>í˜¸ìŠ¤íŠ¸ íŒŒì¼ì„ ì½ê¸° ì „ìš©ìœ¼ë¡œ ìœ ì§€</strong> í•˜ë©´ì„œ, ìˆ˜ì •ì€ ì „ë¶€ sandboxì—ì„œë§Œ</p>
  </li>
  <li>
    <p><strong>LLM ê¸°ë°˜ ë™ì  tool execution</strong></p>
  </li>
</ul>

<hr />

<h3 id="ë‹¤ìŒ-ë‹¨ê³„">ë‹¤ìŒ ë‹¨ê³„</h3>

<p>ì›í•œë‹¤ë©´,</p>

<ul>
  <li>
    <p>ë‚´ê°€ ì§ì ‘ í”„ë¡œë•ì…˜ ìˆ˜ì¤€ ì½”ë“œ (ì˜ˆ: runner.py, tool binding ì½”ë“œ) ë¥¼ ì‘ì„±í•´ ì¤„ ìˆ˜ ìˆë‹¤</p>
  </li>
  <li>
    <p>ë˜ëŠ” vLLM + Agents SDK ì™€ í†µí•©ëœ ì „ì²´ í”„ë¡œì íŠ¸ í…œí”Œë¦¿ì„ ë§Œë“¤ì–´ ì¤„ ìˆ˜ ìˆë‹¤</p>
  </li>
</ul>

<p>í•œë§ˆë””ë¡œ, ë‹¹ì‹ ì´ ë§Œë“¤ë ¤ëŠ” ê±´ <strong>Code Interpreter Clone, but without Docker</strong>.</p>

<p>ê³„ì† ë„ì™€ì¤„ê²Œ.<br />
ë‹¤ìŒ ë©”ì‹œì§€ì— ì•„ë˜ ì¤‘ í•˜ë‚˜ ì„ íƒí•´ì¤˜:</p>

<ol>
  <li>
    <p>Python ì‹¤ì œ ì‹¤í–‰ ì½”ë“œ + tool ì½”ë“œ ìƒì„± ì›í•¨</p>
  </li>
  <li>
    <p>vLLM + Qwen + Agents SDK í†µí•© êµ¬ì¡° ìƒ˜í”Œ ì›í•¨</p>
  </li>
  <li>
    <p>ë‘˜ ë‹¤ ì›í•¨</p>
  </li>
</ol>

<p>ì–¸ì œë“  í™•ì¥í•´ì„œ ê³ ê³ !</p>

<p class="chat--user">

1. ì–´ì œ ë„ˆê°€ ë§Œë“¤ì–´ì¤€ ì½”ë“œë„ ì°¸ê³ í•´ì¤˜. ì´ ì½”ë“œì˜ ì¥ì ì€ Kernelì´ ìœ ì§€ëœë‹¤ëŠ” ì¥ì ì´ ìˆëŠ” ê²ƒ ê°™ì•„ 2. data í´ë”ë¥¼ ë”°ë¡œ ì•ˆ ë§Œë“¤ê³  ëª¨ë“  ê²½ë¡œì— ì ‘ê·¼ ê°€ëŠ¥í•˜ë˜ ì“¸ íŒŒì¼ì€ copy_to_sandbox(source, destination) ê°™ì€ Toolë¡œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆê²Œ í•˜ë©´ ì¢‹ê² ì–´. 3. ë„ˆê°€ ì¤€ ì˜ˆì‹œì—ì„œ temp.py ê°€ sanbox ì•ˆì˜ íŒŒì¼ë§Œ ì ‘ê·¼í•œë‹¤ëŠ” ë³´ì¥ì´ ì—†ì§€ ì•Šì•„? ì´ëŸ° ê±¸ í•´ì¤„ ìˆ˜ ìˆëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ì–´? ë„ì»¤ ê°™ì€ ì™¸ë¶€ í”„ë¡œê·¸ë¨ì€ ë³„ë¡œ ì•ˆ ì“°ê³  ì‹¶ë„¤ import os, time, base64, re from typing import Dict, Any, List from openai import OpenAI from jupyter_client import KernelManager # ========= ì„¤ì • ========= # í™˜ê²½ë³€ìˆ˜ OPENAI_API_KEY í•„ìš” MODEL = os.environ.get("OPENAI_MODEL", "gpt-5.1") DATA_DIR = os.environ.get("DATA_DIR", "/mnt/data") os.makedirs(DATA_DIR, exist_ok=True) # ========= ì„ë² ë””ë“œ ì»¤ë„ ì‹¤í–‰ê¸° ========= class KernelSession: def <strong>init</strong>(self): # íˆìŠ¤í† ë¦¬ ë¹„í™œì„±í™”ë¡œ ê¹”ë”í•˜ê²Œ self.km = KernelManager() self.km.start_kernel(extra_arguments=["â€“HistoryManager.enabled=False"]) self.kc = self.km.client(); self.kc.start_channels() def shutdown(self): try: self.kc.stop_channels() self.km.shutdown_kernel(now=True) except Exception: pass def execute(self, code: str, timeout: float = 3.0) -&gt; Dict[str, Any]: # ê°„ë‹¨í•œ ì•ˆì „ í•„í„°(ì •ì±…ì— ë§ê²Œ í™•ì¥ ê°€ëŠ¥) if re.search(r"\bseaborn\b", code): return {"returncode": 2, "stdout": "", "stderr": "Do not use seaborn", "artifacts": []} msg_id = self.kc.execute(code, allow_stdin=False, stop_on_error=True) t0 = time.time(); out=[]; err=[]; arts=[] while True: if time.time() - t0 &gt; timeout: # íƒ€ì„ì•„ì›ƒ ì‹œ ì»¤ë„ ê°•ì œ ì¢…ë£Œ(ë¬´í•œë£¨í”„ ë°©ì§€) self.km.shutdown_kernel(now=True) return {"returncode":124,"stdout":"".join(out),"stderr":"Timeout","artifacts":[]} try: msg = self.kc.get_iopub_msg(timeout=0.1) except Exception: continue if msg["parent_header"].get("msg_id") != msg_id: continue typ = msg["header"]["msg_type"]; content = msg["content"] if typ == "stream": (out if content["name"]=="stdout" else err).append(content["text"]) elif typ == "error": err.append("\n".join(content.get("traceback", []))) elif typ in ("display_data","execute_result"): data = content.get("data", {}) if "image/png" in data: b = data["image/png"] if isinstance(b, str): b = b.encode() png = base64.b64decode(b) fn = f"plot_{int(time.time()<em>1000)}.png" fp = os.path.join(DATA_DIR, fn) with open(fp, "wb") as f: f.write(png) arts.append({"name": fn, "path": f"/mnt/data/{fn}", "mime": "image/png"}) elif typ == "status" and content["execution_state"] == "idle": break return { "returncode": 0, "stdout": "".join(out)[:20000], "stderr": "".join(err)[:20000], "artifacts": arts } class KernelPool: def <strong>init</strong>(self): self.sessions: Dict[str, KernelSession] = {} def get(self, session_id: str) -&gt; KernelSession: if session_id not in self.sessions: self.sessions[session_id] = KernelSession() return self.sessions[session_id] def kill(self, session_id: str): s = self.sessions.pop(session_id, None) if s: s.shutdown() POOL = KernelPool() def _plot_rule_check(code: str) -&gt; str | None: # ë‹¨ì¼ í”Œë¡¯, ìƒ‰ìƒ/ìŠ¤íƒ€ì¼ ì§€ì • ê¸ˆì§€(ì›í•˜ëŠ” ì •ì±…ì´ë©´ ì™„í™” ê°€ëŠ¥) if re.search(r"\.subplot\(", code) or re.search(r"subplots\(", code): return "Do not use subplots" if re.search(r"(color\s</em>=|palette\s<em>=|style\s</em>=)", code): return "Do not set explicit colors or styles" return None # ========= OpenAI tools ì •ì˜(HTTP ì„œë²„ ì—†ì´ in-process) ========= python_exec_internal_tool = { "type": "function", "function": { "name": "python_exec_internal", "description": "ë‚´ë¶€ ë¶„ì„ìš© íŒŒì´ì¬ ì‹¤í–‰(ì‚¬ìš©ìì—ê² ì¶œë ¥ ìˆ¨ê¹€). ì„¸ì…˜ì€ session_idë¡œ ìœ ì§€.", "parameters": { "type": "object", "properties": { "session_id": {"type": "string", "description": "ëŒ€í™”/ìŠ¤ë ˆë“œ ì‹ë³„ì"}, "code": {"type": "string"}, "timeout_sec": {"type": "integer","minimum":1,"maximum":10,"default":3} }, "required": ["session_id", "code"], "additionalProperties": False }, "strict": True } } python_exec_visible_tool = { "type": "function", "function": { "name": "python_exec_visible", "description": "ì‚¬ìš©ì ê°€ì‹œ íŒŒì´ì¬ ì‹¤í–‰(ë‹¨ì¼ matplotlib í”Œë¡¯, ìƒ‰/ìŠ¤íƒ€ì¼ ì§€ì • ê¸ˆì§€).", "parameters": { "type": "object", "properties": { "session_id": {"type": "string"}, "code": {"type": "string"}, "timeout_sec": {"type":"integer","minimum":1,"maximum":10,"default":3}, "enforce_plot_rules": {"type":"boolean","default": True} }, "required": ["session_id", "code"], "additionalProperties": False }, "strict": True } } def run_tool_locally(name: str, args: Dict[str, Any]) -&gt; Dict[str, Any]: session_id = args["session_id"] code = args["code"] timeout = int(args.get("timeout_sec", 3)) if name == "python_exec_visible" and args.get("enforce_plot_rules", True): v = _plot_rule_check(code) if v: return {"returncode": 2, "stdout": "", "stderr": v, "artifacts": []} sess = POOL.get(session_id) return sess.execute(code, timeout=timeout) # ========= ëª¨ë¸ ë¼ìš´ë“œíŠ¸ë¦½ ========= def roundtrip(client: OpenAI, user_msg: str, session_id: str): # 1) ì²« í˜¸ì¶œ: ì‚¬ìš©ì ì§ˆë¬¸ + íˆ´ ìŠ¤í™ ì œê³µ resp = client.responses.create( model=MODEL, input=[{"role": "user", "content": user_msg}], tools=[python_exec_internal_tool, python_exec_visible_tool], parallel_tool_calls=False ) # 2) tool_call ê°ì§€ ë° in-process ì‹¤í–‰ â†’ ì¬í”¼ë“œë°± messages = [{"role": "user", "content": user_msg}] final_text = None for item in resp.output: if item.type == "message": # ëª¨ë¸ì´ ì¦‰ë‹µí–ˆë‹¤ë©´ ê·¸ ë‚´ìš© final_text = item.content[0].text if item.type == "tool_call": name = item.name args = item.arguments result = run_tool_locally(name, args) # íˆ´ ê²°ê³¼ë¥¼ ëª¨ë¸ì— ë‹¤ì‹œ ë„£ì–´ ìì—°ì–´ ë‹µë³€ ìƒì„± follow = client.responses.create( model=MODEL, input=messages + [{"role": "tool", "name": name, "content": result}], tools=[python_exec_internal_tool, python_exec_visible_tool], parallel_tool_calls=False ) final_text = follow.output_text break return final_text # ========= ì‹¤í–‰ ì˜ˆì‹œ ========= if <strong>name</strong> == "<strong>main</strong>": client = OpenAI() print("ì˜ˆì‹œ 1) ë‚´ë¶€ìš© ì‹¤í–‰: sum(range(10))") msg1 = "sum(range(10))ì„ ë‚´ë¶€ ì‹¤í–‰ê¸°ë¡œ ê³„ì‚°í•´ì„œ ê²°ê³¼ë§Œ ë§í•´ì¤˜." print(roundtrip(client, msg1, session_id="sess-1")) print("\nì˜ˆì‹œ 2) ê°€ì‹œ ì‹¤í–‰: ê°„ë‹¨ í”Œë¡¯ ìƒì„±") code = """ import matplotlib.pyplot as plt x = [1,2,3,4]; y = [v*v for v in x] plt.figure() plt.plot(x,y) # ìƒ‰/ìŠ¤íƒ€ì¼ ì§€ì • ê¸ˆì§€ plt.title("y = x^2") plt.savefig("/mnt/data/curve.png") print("done") """ msg2 = f"ì´ ì½”ë“œë¥¼ ê°€ì‹œ ì‹¤í–‰ê¸°ë¡œ ëŒë¦¬ê³  ì‚°ì¶œë¬¼ ê²½ë¡œë¥¼ ìš”ì•½í•´ì„œ ì•Œë ¤ì¤˜:\n{code}" print(roundtrip(client, msg2, session_id="sess-1"))

</p>

<p>ì¢‹ì•„. ì»¤ë„ì´ ìœ ì§€ë˜ëŠ” ë„¤ ê¸°ì¡´ êµ¬ì¡°ë¥¼ ì‚´ë¦¬ë©´ì„œ, â€œì½ê¸°ëŠ” ì–´ë””ë“  ê°€ëŠ¥, ì“°ê¸°ëŠ” ìƒŒë“œë°•ìŠ¤ ë””ë ‰í„°ë¦¬ë¡œë§Œâ€ì„ ê°•ì œí•˜ê³ , ë„ì»¤ ì—†ì´ ì‹¤í–‰í•˜ëŠ” í˜•íƒœë¡œ ì •ë¦¬í–ˆë‹¤. í•µì‹¬ì€ ë‘ ê²¹ì˜ ì•ˆì „ì¥ì¹˜ë‹¤.</p>

<ol>
  <li>
    <p>ì†Œí”„íŠ¸ ê°€ë“œ: ì»¤ë„ ë‚´ë¶€ì—ì„œ open/os/pathlib ë“±ì„ ëª½í‚¤íŒ¨ì¹˜í•´ ì“°ê¸° ë™ì‘ì„ ìƒŒë“œë°•ìŠ¤ë¡œë§Œ ì œí•œ. subprocess/os.systemë„ ë§‰ìŒ.</p>
  </li>
  <li>
    <p>í•˜ë“œ ê°€ë“œ(ì„ íƒ, Linux): Landlock(ì»¤ë„ LSM) ë°”ì¸ë”©ìœ¼ë¡œ í”„ë¡œì„¸ìŠ¤ ìì²´ì— â€œìƒŒë“œë°•ìŠ¤ ë°– ì“°ê¸° ê¸ˆì§€â€ë¥¼ ì»¤ë„ ìˆ˜ì¤€ì—ì„œ ì ìš©. ë¼ì´ë¸ŒëŸ¬ë¦¬ ì˜ˆ: pylandlock. ì´ê±´ ë„ì»¤ë‚˜ ì™¸ë¶€ í”„ë¡œê·¸ë¨ì´ ì•„ë‹ˆë¼ ì»¤ë„ ê¸°ëŠ¥ì„ ì§ì ‘ ì´ìš©í•˜ë¯€ë¡œ ìš”êµ¬ì‚¬í•­ê³¼ ë¶€í•©.</p>
  </li>
</ol>

<p>ì•„ë˜ ì½”ë“œëŠ” ë„¤ê°€ ì˜¬ë¦° ì»¤ë„ ìœ ì§€í˜• ì„¤ê³„ë¥¼ ê·¸ëŒ€ë¡œ í™•ì¥í–ˆë‹¤. copy_to_sandbox(source, dest_rel) íˆ´ì„ ì¶”ê°€í–ˆê³ , temp.py ê°™ì€ ì„ì˜ ì½”ë“œê°€ ìƒŒë“œë°•ìŠ¤ ë°–ì„ ì“°ë ¤ í•˜ë©´ ì»¤ë„ ì•ˆì—ì„œ PermissionErrorë¥¼ ì¼ìœ¼í‚¤ë„ë¡ ê°•ì œí–ˆë‹¤. ì½ê¸°ëŠ” ì–´ë””ë“  ê°€ëŠ¥í•˜ë„ë¡ ë‘ì—ˆë‹¤.</p>

<p>ì½”ë“œ ê·¸ëŒ€ë¡œ ë¶™ì—¬ ë„£ì–´ ì‹¤í–‰í•˜ë©´ ëœë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
# coding: utf-8
</span><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">base64</span><span class="p">,</span> <span class="n">re</span><span class="p">,</span> <span class="n">shutil</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">sys</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>
<span class="kn">from</span> <span class="n">jupyter_client</span> <span class="kn">import</span> <span class="n">KernelManager</span>

<span class="c1"># ========= ì„¤ì • =========
</span><span class="n">MODEL</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">OPENAI_MODEL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">gpt-5.1</span><span class="sh">"</span><span class="p">)</span>
<span class="n">DATA_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">DATA_DIR</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/mnt/data</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># ê°€ì‹œ ì‚°ì¶œë¬¼ ì €ì¥ ìš©
</span><span class="n">SANDBOX_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">SANDBOX_DIR</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/mnt/sandbox</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># ì“°ê¸° í—ˆìš© ë””ë ‰í„°ë¦¬
</span><span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">SANDBOX_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># ========= ì»¤ë„ ë‚´ ìƒŒë“œë°•ìŠ¤ ê°€ë“œ ì½”ë“œ =========
# ì“°ê¸°ëŠ” SANDBOX_DIR ë‚´ë¶€ì—ì„œë§Œ í—ˆìš©, ì½ê¸°ëŠ” ì–´ë””ë“  í—ˆìš©
</span><span class="n">KERNEL_GUARD_CODE</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os, builtins, pathlib, subprocess, sys

SANDBOX_DIR = os.environ.get(</span><span class="sh">"</span><span class="s">SANDBOX_DIR</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">/mnt/sandbox</span><span class="sh">"</span><span class="s">)
SANDBOX_DIR = os.path.realpath(SANDBOX_DIR)

_ORIG_OPEN = builtins.open
_ORIG_OS_OPEN = os.open
_ORIG_RENAME = os.rename
_ORIG_REPLACE = os.replace
_ORIG_REMOVE = os.remove
_ORIG_UNLINK = os.unlink
_ORIG_MKDIR = os.mkdir
_ORIG_MAKEDIRS = os.makedirs
_ORIG_RMDIR = os.rmdir
_ORIG_CHMOD = os.chmod

def _real(p): return os.path.realpath(p)
def _in_sb(p):
    rp = _real(p)
    return rp == SANDBOX_DIR or rp.startswith(SANDBOX_DIR + os.sep)

def _open_guard(file, mode=</span><span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="s">, buffering=-1, encoding=None, errors=None, newline=None, closefd=True, opener=None):
    write_intent = any(ch in mode for ch in (</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="s">))
    if write_intent and not _in_sb(file):
        raise PermissionError(f</span><span class="sh">"</span><span class="s">Writes are restricted to SANDBOX_DIR: {SANDBOX_DIR}</span><span class="sh">"</span><span class="s">)
    return _ORIG_OPEN(file, mode, buffering, encoding, errors, newline, closefd, opener)

def _os_open_guard(file, flags, mode=0o777, *, dir_fd=None):
    write_flags = (flags &amp; (os.O_WRONLY | os.O_RDWR | os.O_CREAT | os.O_TRUNC | os.O_APPEND)) != 0
    if write_flags and not _in_sb(file):
        raise PermissionError(f</span><span class="sh">"</span><span class="s">Writes are restricted to SANDBOX_DIR: {SANDBOX_DIR}</span><span class="sh">"</span><span class="s">)
    return _ORIG_OS_OPEN(file, flags, mode, dir_fd=dir_fd)

def _rename_guard(src, dst, *a, **k):
    if not (_in_sb(src) and _in_sb(dst)):
        raise PermissionError(</span><span class="sh">"</span><span class="s">Rename/replace restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_RENAME(src, dst, *a, **k)

def _replace_guard(src, dst, *a, **k):
    if not (_in_sb(src) and _in_sb(dst)):
        raise PermissionError(</span><span class="sh">"</span><span class="s">Rename/replace restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_REPLACE(src, dst, *a, **k)

def _remove_guard(path, *a, **k):
    if not _in_sb(path):
        raise PermissionError(</span><span class="sh">"</span><span class="s">Deletion restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_REMOVE(path, *a, **k)

def _unlink_guard(path, *a, **k):
    if not _in_sb(path):
        raise PermissionError(</span><span class="sh">"</span><span class="s">Deletion restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_UNLINK(path, *a, **k)

def _mkdir_guard(path, *a, **k):
    if not _in_sb(path):
        raise PermissionError(</span><span class="sh">"</span><span class="s">Mkdir restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_MKDIR(path, *a, **k)

def _makedirs_guard(path, *a, **k):
    if not _in_sb(path):
        raise PermissionError(</span><span class="sh">"</span><span class="s">Makedirs restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_MAKEDIRS(path, *a, **k)

def _rmdir_guard(path, *a, **k):
    if not _in_sb(path):
        raise PermissionError(</span><span class="sh">"</span><span class="s">Rmdir restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_RMDIR(path, *a, **k)

def _chmod_guard(path, mode, *a, **k):
    if not _in_sb(path):
        raise PermissionError(</span><span class="sh">"</span><span class="s">chmod restricted within sandbox</span><span class="sh">"</span><span class="s">)
    return _ORIG_CHMOD(path, mode, *a, **k)

builtins.open = _open_guard
os.open = _os_open_guard
os.rename = _rename_guard
os.replace = _replace_guard
os.remove = _remove_guard
os.unlink = _unlink_guard
os.mkdir = _mkdir_guard
os.makedirs = _makedirs_guard
os.rmdir = _rmdir_guard
os.chmod = _chmod_guard

import pathlib
_ORIG_PATH_OPEN = pathlib.Path.open
def _path_open_guard(self, *args, **kwargs):
    mode = kwargs.get(</span><span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="s">)
    if len(args) &gt;= 1: mode = args[0]
    write_intent = any(ch in mode for ch in (</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="s">))
    if write_intent and not _in_sb(str(self)):
        raise PermissionError(f</span><span class="sh">"</span><span class="s">Writes are restricted to SANDBOX_DIR: {SANDBOX_DIR}</span><span class="sh">"</span><span class="s">)
    return _ORIG_PATH_OPEN(self, *args, **kwargs)
pathlib.Path.open = _path_open_guard

# ì°¨ë‹¨: ì„œë¸Œí”„ë¡œì„¸ìŠ¤/ì…¸ ì‹¤í–‰
def _blocked(*a, **k):
    raise PermissionError(</span><span class="sh">"</span><span class="s">Subprocess execution is disabled in sandbox</span><span class="sh">"</span><span class="s">)
subprocess.Popen = _blocked
subprocess.call = _blocked
subprocess.check_call = _blocked
subprocess.check_output = _blocked
os.system = lambda *a, **k: (_ for _ in ()).throw(PermissionError(</span><span class="sh">"</span><span class="s">os.system disabled</span><span class="sh">"</span><span class="s">))

# ë¦¬ì†ŒìŠ¤ ì œí•œ (ìœ ë‹‰ìŠ¤ë§Œ)
try:
    import resource
    resource.setrlimit(resource.RLIMIT_CPU, (3, 3))
    resource.setrlimit(resource.RLIMIT_AS, (1024*1024*1024, 1024*1024*1024))  # 1GB
except Exception:
    pass

print(</span><span class="sh">"</span><span class="s">[sandbox-guard] active:</span><span class="sh">"</span><span class="s">, SANDBOX_DIR)
</span><span class="sh">"""</span>

<span class="c1"># ========= ì„ë² ë””ë“œ ì»¤ë„ ì‹¤í–‰ê¸° =========
</span><span class="k">class</span> <span class="nc">KernelSession</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">km</span> <span class="o">=</span> <span class="nc">KernelManager</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">start_kernel</span><span class="p">(</span><span class="n">extra_arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">--HistoryManager.enabled=False</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">kc</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">client</span><span class="p">();</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">start_channels</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_guard_ready</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">stop_channels</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">shutdown_kernel</span><span class="p">(</span><span class="n">now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_ensure_guard</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_guard_ready</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># ìƒŒë“œë°•ìŠ¤ ë””ë ‰í„°ë¦¬ë¥¼ ì»¤ë„ í™˜ê²½ì— ì£¼ì…
</span>        <span class="n">code</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">import os; os.environ[</span><span class="sh">'</span><span class="s">SANDBOX_DIR</span><span class="sh">'</span><span class="s">] = </span><span class="si">{</span><span class="n">SANDBOX_DIR</span><span class="si">!r}</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="n">KERNEL_GUARD_CODE</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_exec_once</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_guard_ready</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_exec_once</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">msg_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">allow_stdin</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">stop_on_error</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">();</span> <span class="n">out</span><span class="o">=</span><span class="p">[];</span> <span class="n">err</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">shutdown_kernel</span><span class="p">(</span><span class="n">now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span><span class="mi">124</span><span class="p">,</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Timeout</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:[]}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">get_iopub_msg</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">parent_header</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">msg_id</span><span class="sh">"</span><span class="p">)</span> <span class="o">!=</span> <span class="n">msg_id</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">header</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">msg_type</span><span class="sh">"</span><span class="p">];</span> <span class="n">content</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stream</span><span class="sh">"</span><span class="p">:</span>
                <span class="p">(</span><span class="n">out</span> <span class="k">if</span> <span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span><span class="o">==</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span> <span class="k">else</span> <span class="n">err</span><span class="p">).</span><span class="nf">append</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">err</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">content</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">traceback</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])))</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">status</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">execution_state</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">idle</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">err</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">out</span><span class="p">)[:</span><span class="mi">20000</span><span class="p">],</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">err</span><span class="p">)[:</span><span class="mi">20000</span><span class="p">],</span> <span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:[]}</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># ê°„ë‹¨í•œ ì •ì±… í•„í„°
</span>        <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">\bseaborn\b</span><span class="sh">"</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Do not use seaborn</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="c1"># ìƒŒë“œë°•ìŠ¤ ê°€ë“œ ë³´ì¥
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_guard</span><span class="p">()</span>

        <span class="n">msg_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">allow_stdin</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">stop_on_error</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">();</span> <span class="n">out</span><span class="o">=</span><span class="p">[];</span> <span class="n">err</span><span class="o">=</span><span class="p">[];</span> <span class="n">arts</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">shutdown_kernel</span><span class="p">(</span><span class="n">now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span><span class="mi">124</span><span class="p">,</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Timeout</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:[]}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">get_iopub_msg</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">parent_header</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">msg_id</span><span class="sh">"</span><span class="p">)</span> <span class="o">!=</span> <span class="n">msg_id</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">header</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">msg_type</span><span class="sh">"</span><span class="p">];</span> <span class="n">content</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stream</span><span class="sh">"</span><span class="p">:</span>
                <span class="p">(</span><span class="n">out</span> <span class="k">if</span> <span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span><span class="o">==</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span> <span class="k">else</span> <span class="n">err</span><span class="p">).</span><span class="nf">append</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">err</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">content</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">traceback</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])))</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">display_data</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">execute_result</span><span class="sh">"</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">content</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="sh">"</span><span class="s">image/png</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">image/png</span><span class="sh">"</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="nf">encode</span><span class="p">()</span>
                    <span class="kn">import</span> <span class="n">base64</span> <span class="k">as</span> <span class="n">_b64</span>
                    <span class="n">png</span> <span class="o">=</span> <span class="n">_b64</span><span class="p">.</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">plot_</span><span class="si">{</span><span class="nf">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span><span class="si">}</span><span class="s">.png</span><span class="sh">"</span>
                    <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="sh">"</span><span class="s">wb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">png</span><span class="p">)</span>
                    <span class="n">arts</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">fn</span><span class="p">,</span> <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">mime</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">image/png</span><span class="sh">"</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">status</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">execution_state</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">idle</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">out</span><span class="p">)[:</span><span class="mi">20000</span><span class="p">],</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">err</span><span class="p">)[:</span><span class="mi">20000</span><span class="p">],</span> <span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:</span> <span class="n">arts</span><span class="p">}</span>

<span class="k">class</span> <span class="nc">KernelPool</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">sessions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">KernelSession</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KernelSession</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">session_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">sessions</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span> <span class="o">=</span> <span class="nc">KernelSession</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">sessions</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">()</span>

<span class="n">POOL</span> <span class="o">=</span> <span class="nc">KernelPool</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_plot_rule_check</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">\.subplot\(</span><span class="sh">"</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span> <span class="ow">or</span> <span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">subplots\(</span><span class="sh">"</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">Do not use subplots</span><span class="sh">"</span>
    <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">(color\s*=|palette\s*=|style\s*=)</span><span class="sh">"</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">Do not set explicit colors or styles</span><span class="sh">"</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="c1"># ========= íŒŒì¼ íˆ´: copy_to_sandbox =========
</span><span class="k">def</span> <span class="nf">copy_to_sandbox_impl</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dest_rel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">source not found: </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">islink</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">symlink not allowed</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="k">if</span> <span class="n">dest_rel</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">)</span> <span class="k">else</span> <span class="n">dest_rel</span>
    <span class="c1"># ëª©ì ì§€ëŠ” ìƒŒë“œë°•ìŠ¤ ë‚´ë¶€ë¡œ ê°•ì œ
</span>    <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">SANDBOX_DIR</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">dst</span> <span class="o">==</span> <span class="n">SANDBOX_DIR</span> <span class="ow">or</span> <span class="n">dst</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">SANDBOX_DIR</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">destination must be inside sandbox</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">dst</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="c1"># ë””ë ‰í„°ë¦¬ ë³µì‚¬
</span>        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">destination exists: </span><span class="si">{</span><span class="n">dst</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">shutil</span><span class="p">.</span><span class="nf">copytree</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">copy_function</span><span class="o">=</span><span class="n">shutil</span><span class="p">.</span><span class="n">copy2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shutil</span><span class="p">.</span><span class="nf">copy2</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="c1"># ì½ê¸°/ì“°ê¸° í—ˆìš© í¼ë¯¸ì…˜ (ì†Œìœ ì)
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">chmod</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IRGRP</span> <span class="o">|</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IROTH</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">rel</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">relpath</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">SANDBOX_DIR</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">sandbox_path</span><span class="sh">"</span><span class="p">:</span> <span class="n">dst</span><span class="p">,</span> <span class="sh">"</span><span class="s">relative_path</span><span class="sh">"</span><span class="p">:</span> <span class="n">rel</span><span class="p">}</span>

<span class="c1"># ========= OpenAI tools ì •ì˜ =========
</span><span class="n">python_exec_internal_tool</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">python_exec_internal</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ë‚´ë¶€ ë¶„ì„ìš© íŒŒì´ì¬ ì‹¤í–‰(ì‚¬ìš©ìì—ê² ì¶œë ¥ ìˆ¨ê¹€). ì„¸ì…˜ì€ session_idë¡œ ìœ ì§€.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span><span class="mi">3</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">python_exec_visible_tool</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">python_exec_visible</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì‚¬ìš©ì ê°€ì‹œ íŒŒì´ì¬ ì‹¤í–‰(ë‹¨ì¼ matplotlib í”Œë¡¯, ìƒ‰/ìŠ¤íƒ€ì¼ ì§€ì • ê¸ˆì§€).</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span><span class="mi">3</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">enforce_plot_rules</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">boolean</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">copy_to_sandbox_tool</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">copy_to_sandbox</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">í˜¸ìŠ¤íŠ¸ì˜ ì„ì˜ ê²½ë¡œì—ì„œ íŒŒì¼/í´ë”ë¥¼ ìƒŒë“œë°•ìŠ¤ë¡œ ë³µì‚¬. ì“°ê¸° ê°€ëŠ¥í•œ ê²½ë¡œëŠ” ìƒŒë“œë°•ìŠ¤ë¿.</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">source</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">í˜¸ìŠ¤íŠ¸ì˜ ê¸°ì¡´ ê²½ë¡œ</span><span class="sh">"</span><span class="p">},</span>
                <span class="sh">"</span><span class="s">dest_rel</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ìƒŒë“œë°•ìŠ¤ ë‚´ë¶€ ìƒëŒ€ê²½ë¡œ</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">source</span><span class="sh">"</span><span class="p">],</span>
            <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">},</span>
        <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">TOOLS</span> <span class="o">=</span> <span class="p">[</span><span class="n">python_exec_internal_tool</span><span class="p">,</span> <span class="n">python_exec_visible_tool</span><span class="p">,</span> <span class="n">copy_to_sandbox_tool</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">run_tool_locally</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">copy_to_sandbox</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">copy_to_sandbox_impl</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="sh">"</span><span class="s">source</span><span class="sh">"</span><span class="p">],</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">dest_rel</span><span class="sh">"</span><span class="p">))</span>

    <span class="n">session_id</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">timeout</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">python_exec_visible</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">enforce_plot_rules</span><span class="sh">"</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nf">_plot_rule_check</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">v</span><span class="p">,</span> <span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="n">sess</span> <span class="o">=</span> <span class="n">POOL</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sess</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

<span class="c1"># ========= ëª¨ë¸ ë¼ìš´ë“œíŠ¸ë¦½ =========
</span><span class="k">def</span> <span class="nf">roundtrip</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="n">OpenAI</span><span class="p">,</span> <span class="n">user_msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">MODEL</span><span class="p">,</span>
        <span class="nb">input</span><span class="o">=</span><span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_msg</span><span class="p">}],</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">TOOLS</span><span class="p">,</span>
        <span class="n">parallel_tool_calls</span><span class="o">=</span><span class="bp">False</span>
    <span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">user_msg</span><span class="p">}]</span>
    <span class="n">final_text</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">.</span><span class="n">output</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">final_text</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">text</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">tool_call</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">name</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">arguments</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nf">run_tool_locally</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="n">follow</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">responses</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">MODEL</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">messages</span> <span class="o">+</span> <span class="p">[{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tool</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">result</span><span class="p">}],</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">TOOLS</span><span class="p">,</span>
                <span class="n">parallel_tool_calls</span><span class="o">=</span><span class="bp">False</span>
            <span class="p">)</span>
            <span class="n">final_text</span> <span class="o">=</span> <span class="n">follow</span><span class="p">.</span><span class="n">output_text</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">final_text</span>

<span class="c1"># ========= ì‹¤í–‰ ì˜ˆì‹œ =========
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">()</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ì˜ˆì‹œ 0) ìƒŒë“œë°•ìŠ¤ì— íŒŒì¼ ë³µì‚¬</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">__file__</span>   <span class="c1"># í˜„ì¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìƒŒë“œë°•ìŠ¤ë¡œ ë³µì‚¬í•´ë³´ì
</span>    <span class="n">result</span> <span class="o">=</span> <span class="nf">copy_to_sandbox_impl</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="sh">"</span><span class="s">example/copied_script.py</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">ì˜ˆì‹œ 1) ë‚´ë¶€ìš© ì‹¤í–‰: sum(range(10))</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">msg1</span> <span class="o">=</span> <span class="sh">"</span><span class="s">sum(range(10))ì„ ë‚´ë¶€ ì‹¤í–‰ê¸°ë¡œ ê³„ì‚°í•´ì„œ ê²°ê³¼ë§Œ ë§í•´ì¤˜.</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="nf">roundtrip</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">msg1</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="sh">"</span><span class="s">sess-1</span><span class="sh">"</span><span class="p">))</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">ì˜ˆì‹œ 2) ê°€ì‹œ ì‹¤í–‰: ê°„ë‹¨ í”Œë¡¯ ìƒì„± í›„ ì‚°ì¶œë¬¼ ê²½ë¡œ ì¶œë ¥</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
import matplotlib.pyplot as plt, os
x = [1,2,3,4]; y = [v*v for v in x]
plt.figure(); plt.plot(x,y); plt.title(</span><span class="sh">"</span><span class="s">y = x^2</span><span class="sh">"</span><span class="s">)
plt.savefig(os.path.join(os.environ.get(</span><span class="sh">"</span><span class="s">DATA_DIR</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">/mnt/data</span><span class="sh">"</span><span class="s">), </span><span class="sh">"</span><span class="s">curve.png</span><span class="sh">"</span><span class="s">))
print(</span><span class="sh">"</span><span class="s">done</span><span class="sh">"</span><span class="s">)
</span><span class="sh">'''</span>
    <span class="n">msg2</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">ì´ ì½”ë“œë¥¼ ê°€ì‹œ ì‹¤í–‰ê¸°ë¡œ ëŒë¦¬ê³  ì‚°ì¶œë¬¼ ê²½ë¡œë¥¼ ìš”ì•½í•´ì„œ ì•Œë ¤ì¤˜:</span><span class="se">\\</span><span class="s">n</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="sh">"</span>
    <span class="nf">print</span><span class="p">(</span><span class="nf">roundtrip</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">msg2</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="sh">"</span><span class="s">sess-1</span><span class="sh">"</span><span class="p">))</span>
</code></pre></div></div>

<p>í•µì‹¬ í¬ì¸íŠ¸ë¥¼ ì§šì–´ë‘”ë‹¤.</p>

<ol>
  <li>
    <p>ì»¤ë„ ì§€ì†ì„± ìœ ì§€<br />
ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ jupyter_client.KernelManagerë¥¼ ì‚¬ìš©í•˜ë˜, ì„¸ì…˜ë§ˆë‹¤ ìƒŒë“œë°•ìŠ¤ ê°€ë“œë¥¼ í•œ ë²ˆë§Œ ì£¼ì…í•´ ìœ ì§€í•œë‹¤. íƒ€ì„ì•„ì›ƒìœ¼ë¡œ ì»¤ë„ì„ killí•˜ë©´ ìƒˆ ì»¤ë„ì—ì„œ ê°€ë“œë¥¼ ì¬ì£¼ì…í•œë‹¤.</p>
  </li>
  <li>
    <p>ëª¨ë“  ê²½ë¡œ ì½ê¸° í—ˆìš©, ì“°ê¸°ëŠ” ìƒŒë“œë°•ìŠ¤ë§Œ<br />
ì»¤ë„ ë‚´ë¶€ì—ì„œ open/os.open/pathlib.Path.open/rename/remove ë“± ì“°ê¸°ì„± ì‘ì—…ì„ ê°€ë“œí•œë‹¤. ì½”ë“œë¥¼ í†µí•œ ì„ì˜ì˜ íŒŒì¼ ì“°ê¸°ëŠ” ìƒŒë“œë°•ìŠ¤ ë°–ìœ¼ë¡œ ë‚˜ê°ˆ ìˆ˜ ì—†ë‹¤. copy_to_sandbox(source, dest_rel) íˆ´ì€ í˜¸ìŠ¤íŠ¸ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì•ˆì „ ê²€ì¦ í›„ ìƒŒë“œë°•ìŠ¤ì— ë³µì‚¬í•œë‹¤.</p>
  </li>
  <li>
    <p>temp.pyê°€ ìƒŒë“œë°•ìŠ¤ ë°–ì„ ë§Œì§€ì§€ ëª»í•œë‹¤ëŠ” ë³´ì¥<br />
ì†Œí”„íŠ¸ ê°€ë“œë§Œìœ¼ë¡œë„ ëŒ€ë¶€ë¶„ì˜ íŒŒì´ì¬ ë ˆë²¨ I/Oë¥¼ ë§‰ì§€ë§Œ, ì´ë¡ ì ìœ¼ë¡œ C í™•ì¥/ctypesë¡œ ìš°íšŒí•  ìˆ˜ ìˆë‹¤. ê·¸ë˜ì„œ ë¦¬ëˆ…ìŠ¤ë¼ë©´ ì»¤ë„ ë ˆë²¨ í•˜ë“œ ê°€ë“œë¥¼ ì¶”ì²œí•œë‹¤.</p>
  </li>
</ol>

<p>í•˜ë“œ ê°€ë“œ ì˜µì…˜(Linux, ì„ íƒ ì‚¬í•­, ë„ì»¤/ì™¸ë¶€ í”„ë¡œê·¸ë¨ ë¶ˆí•„ìš”)<br />
Landlock LSM ë°”ì¸ë”©(pylandlock ê°™ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬)ì„ ì‚¬ìš©í•˜ë©´ í”„ë¡œì„¸ìŠ¤ê°€ ìŠ¤ìŠ¤ë¡œ â€œìƒŒë“œë°•ìŠ¤ ë°– ì“°ê¸° ê¸ˆì§€â€ ê·œì¹™ì„ ì»¤ë„ì— ë“±ë¡í•  ìˆ˜ ìˆë‹¤. ë£¨íŠ¸ ê¶Œí•œì´ í•„ìš” ì—†ê³ , í”„ë¡œì„¸ìŠ¤ ìì‹ ì—ê²Œë§Œ ì ìš©ëœë‹¤. ì ìš© ì§€ì ì€ KernelSession ìƒì„± ì§í›„ë‹¤.</p>

<p>ê°œë… ì½”ë“œ(ì‹¤íŒ¨ ì‹œ ì˜ˆì™¸ë¥¼ ë¬´ì‹œí•˜ê³  ì†Œí”„íŠ¸ ê°€ë“œë§Œ ì‚¬ìš©):</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">apply_landlock_allow_write_only_to_sandbox</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="n">landlock</span>  <span class="c1"># ë˜ëŠ” pylandlock: ë°°í¬íŒì— ë”°ë¼ íŒ¨í‚¤ì§€ëª…ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ
</span>        <span class="kn">from</span> <span class="n">landlock</span> <span class="kn">import</span> <span class="n">Ruleset</span><span class="p">,</span> <span class="n">AccessFs</span><span class="p">,</span> <span class="n">PathBeneath</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="nc">Ruleset</span><span class="p">()</span>
        <span class="c1"># ê¸°ë³¸ì€ ì•„ë¬´ ì“°ê¸°ë„ ë¶ˆê°€, ìƒŒë“œë°•ìŠ¤ë§Œ ì“°ê¸° í—ˆìš©
</span>        <span class="n">write_perms</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">AccessFs</span><span class="p">.</span><span class="n">WRITE_FILE</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">REMOVE_FILE</span> <span class="o">|</span>
            <span class="n">AccessFs</span><span class="p">.</span><span class="n">MAKE_DIR</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">REMOVE_DIR</span> <span class="o">|</span>
            <span class="n">AccessFs</span><span class="p">.</span><span class="n">TRUNCATE</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">RENAME_FROM</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">RENAME_TO</span>
        <span class="p">)</span>
        <span class="n">rs</span><span class="p">.</span><span class="nf">add_rule</span><span class="p">(</span><span class="nc">PathBeneath</span><span class="p">(</span><span class="n">SANDBOX_DIR</span><span class="p">,</span> <span class="n">write_perms</span><span class="p">))</span>
        <span class="n">rs</span><span class="p">.</span><span class="nf">restrict_self</span><span class="p">()</span>  <span class="c1"># ì—¬ê¸°ì„œë¶€í„° í˜„ì¬ í”„ë¡œì„¸ìŠ¤ëŠ” ìƒŒë“œë°•ìŠ¤ ë°– ì“°ê¸° ë¶ˆê°€
</span>        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[landlock] active</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[landlock] not available:</span><span class="sh">"</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</code></pre></div></div>

<p>ì´ í•¨ìˆ˜ëŠ” KernelManagerê°€ ë„ìš°ëŠ” ì»¤ë„ í”„ë¡œì„¸ìŠ¤ ì•ˆì´ ì•„ë‹ˆë¼, ë„¤ ëŸ°ë„ˆ í”„ë¡œì„¸ìŠ¤ì— ì ìš©í•˜ëŠ” ê²Œ ì•„ë‹ˆë¼ëŠ” ì ì„ ìŠì§€ ë§ê³ , ì»¤ë„ í”„ë¡œì„¸ìŠ¤ì— ì ìš©í•˜ë ¤ë©´ ì»¤ë„ ì‹œì‘ í›„ ì²« ì…€ë¡œ Landlock ì ìš© ì½”ë“œë¥¼ ì£¼ì…í•´ì•¼ í•œë‹¤. ìœ„ KERNEL_GUARD_CODE ìƒë‹¨ì— Landlock ì ìš© ì½”ë“œë¥¼ ë„£ê³ , ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰í•˜ë„ë¡ êµ¬ì„±í•˜ë©´ ëœë‹¤. ì»¤ë„ ë²„ì „ì´ 5.13+ ì´ì–´ì•¼ í•œë‹¤.</p>

<p>ì¶”ê°€ í•˜ë“œë‹ ì•„ì´ë””ì–´<br />
seccomp(pylibseccomp)ë¡œ socket/subprocess ê´€ë ¨ ì‹œìŠ¤í…œì½œ ìì²´ë¥¼ ì°¨ë‹¨í•´ ë„¤íŠ¸ì›Œí¬/ì…¸ì„ ë¬´ë ¥í™”í•  ìˆ˜ ìˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì°¨ë‹¨ì´ í•„ìš”í•˜ë©´ ì´ê±¸ ë³‘í–‰í•˜ì.</p>

<p>ì£¼ì˜ì <br />
ì½ê¸°ë¥¼ ì–´ë””ë“  í—ˆìš©í•˜ë©´ ë¯¼ê°í•œ í‚¤/í† í° íŒŒì¼(ì˜ˆ: ~/.ssh, .env)ë„ ì½í ìˆ˜ ìˆë‹¤. ìš´ì˜ ì‹œì—” copy_to_sandboxë¡œ ì½ê¸° í—ˆìš© ëª©ë¡ì„ ì¢íˆê±°ë‚˜, ê°€ë“œ ì½”ë“œì— â€œì½ê¸° í—ˆìš© ê²½ë¡œ allowlistâ€ë¥¼ ì¶”ê°€í•˜ëŠ” ê²Œ ì•ˆì „í•˜ë‹¤.</p>

<p>ì´ì œ ë„¤ ìŠ¤íƒ(vLLM + Qwen/GPTOSS + OpenAI Agents SDK)ì— ê·¸ëŒ€ë¡œ ì ‘ëª©í•˜ë©´ ëœë‹¤. ëª¨ë¸ì—ê²ŒëŠ” ë‹¤ìŒ ì„¸ ê°€ì§€ íˆ´ì„ ë…¸ì¶œí•œë‹¤.</p>

<ol>
  <li>
    <p>copy_to_sandbox(source, dest_rel?)</p>
  </li>
  <li>
    <p>python_exec_internal(session_id, code, â€¦)</p>
  </li>
  <li>
    <p>python_exec_visible(session_id, code, â€¦)</p>
  </li>
</ol>

<p>ì‹¤í–‰ ë™ì„ ì€ ê°„ë‹¨í•˜ë‹¤. ëª¨ë¸ì´ íŒŒì¼ì´ í•„ìš”í•˜ë©´ copy_to_sandboxë¥¼ ë¨¼ì € ë¶€ë¥´ê³ , ê·¸ ë‹¤ìŒ ì‹¤í–‰ íˆ´ë¡œ ìƒŒë“œë°•ìŠ¤ ë‚´ë¶€ ê²½ë¡œë§Œ ì“°ê²Œ ëœë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ì»¤ë„ì„ ìœ ì§€í•˜ë©´ì„œë„ íŒŒì¼ ì•ˆì „ì„±ì´ ë³´ì¥ëœë‹¤.</p>

<p>ì›í•˜ë©´ Landlock ì£¼ì…ê¹Œì§€ í¬í•¨í•œ ë²„ì „ìœ¼ë¡œ ë¦¬íŒ©í„°ë§í•´ ì¤„ê²Œ.</p>

<p class="chat--user">

ì´ëŸ° ì¼ì„ í•˜ëŠ” íŒŒì´ì¬ íŒ¨í‚¤ì§€ê°€ ìˆì„ ë²• í•œë° ì°¾ì•„ë³´ê³  ì•Œë ¤ì£¼ë¼

</p>

<p>ì§§ì€ ê²°ë¡ ë¶€í„° ë§í• ê²Œ. ìˆœìˆ˜ íŒŒì´ì¬ë§Œìœ¼ë¡œ â€œì§„ì§œâ€ ì•ˆì „í•œ ìƒŒë“œë°•ìŠ¤ë¥¼ ë§Œë“œëŠ” ê±´ ì—¬ëŸ¬ ì°¨ë¡€ ì‹¤íŒ¨í–ˆê³ , í˜„ì¬ë„ ê¶Œì¥ë˜ì§€ ì•ŠëŠ”ë‹¤. ëŒ€ì‹  ë¦¬ëˆ…ìŠ¤ ì»¤ë„ ê¸°ëŠ¥ì„ ë…¸ì¶œí•œ íŒŒì´ì¬ íŒ¨í‚¤ì§€ë¥¼ ì¡°í•©í•˜ë©´ ë„ì»¤ ì—†ì´ë„ â€œìƒŒë“œë°•ìŠ¤ ë°– ì“°ê¸° ê¸ˆì§€â€ë¥¼ ê½¤ ë‹¨ë‹¨í•˜ê²Œ ë§Œë“¤ ìˆ˜ ìˆë‹¤. ëŒ€í‘œ ì¡°í•©ì€ Landlock(+ì„ íƒì ìœ¼ë¡œ seccomp)ì´ë‹¤. <a href="https://lwn.net/Articles/574323/?utm_source=chatgpt.com">LWN.net</a></p>

<p>ë‹¤ìŒì´ ì§€ê¸ˆ ëª©ì (ì»¤ë„ ìœ ì§€, ì–´ë””ë“  ì½ê¸° ê°€ëŠ¥Â·ì“°ê¸°ë§Œ ìƒŒë“œë°•ìŠ¤)ê³¼ ì˜ ë§ëŠ” íŒ¨í‚¤ì§€ë“¤ì´ì•¼.</p>

<ol>
  <li>ì»¤ë„ ë ˆë²¨ ê²©ë¦¬(ë„ì»¤ ì—†ì´ ê°•ë ¥Â·ê¶Œì¥)</li>
</ol>

<ul>
  <li>
    <p>landlock: ë¦¬ëˆ…ìŠ¤ 5.13+ì—ì„œ í”„ë¡œì„¸ìŠ¤ê°€ â€œì´ ë””ë ‰í„°ë¦¬ë§Œ ì“°ê¸° í—ˆìš©â€ ê°™ì€ ê·œì¹™ì„ ìŠ¤ìŠ¤ë¡œ ê±¸ ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” LSM ë°”ì¸ë”©. í•œ ì¤„ ìš”ì•½: ì»¤ë„ì´ íŒŒì¼ ì“°ê¸°ë¥¼ ì°¨ë‹¨í•˜ë¯€ë¡œ temp.pyê°€ ë°–ìœ¼ë¡œ ë‚˜ê°€ì„œ write/rename/deleteë¥¼ í•˜ë ¤ í•´ë„ ê±°ê¸°ì„œ ë§‰íŒë‹¤. ì„¸ì…˜ ì»¤ë„ì„ ìœ ì§€í•œ ì±„, ì»¤ë„ ì‹œì‘ ì§í›„ ê·œì¹™ì„ ì ìš©í•˜ë©´ ëœë‹¤. <a href="https://pypi.org/project/landlock/?utm_source=chatgpt.com">PyPI</a></p>
  </li>
  <li>
    <p>pyseccomp / python3-seccomp: libseccomp ë°”ì¸ë”©. execve/fork/socket ê°™ì€ ì‹œìŠ¤í…œì½œì„ ë§‰ì•„ ì„œë¸Œí”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ì´ë‚˜ ë„¤íŠ¸ì›Œí¬ ë“± â€œíƒˆì¶œ ë£¨íŠ¸â€ë¥¼ ì¶”ê°€ë¡œ ë´‰ì‡„í•  ìˆ˜ ìˆë‹¤. Landlockê³¼ ë³‘í–‰í•˜ë©´ íš¨ê³¼ê°€ ì¢‹ë‹¤. <a href="https://pypi.org/project/pyseccomp/?utm_source=chatgpt.com">PyPI</a></p>
  </li>
</ul>

<ol>
  <li>ìš´ì˜ì²´ì œ í”„ë¡œíŒŒì¼ ê¸°ë°˜(í™˜ê²½ ì˜ì¡´Â·ì„¤ì • í•„ìš”)</li>
</ol>

<ul>
  <li>edx-codejail: â€œíŒŒì´ì¬ ì½”ë“œ ê°ì˜¥â€ì„ ê´€ë¦¬í•˜ëŠ” íŒ¨í‚¤ì§€. ë³´ì•ˆì€ AppArmor í”„ë¡œíŒŒì¼ë¡œ ê°•ì œí•œë‹¤. ì¦‰ íŒ¨í‚¤ì§€ëŠ” íŒŒì´ì¬ì´ì§€ë§Œ, ì»¤ë„ì˜ AppArmor ì„¤ì •ì´ ì œëŒ€ë¡œ ìˆì–´ì•¼ ë³´í˜¸ê°€ ëœë‹¤. ë„ì»¤ëŠ” í•„ìš” ì—†ì§€ë§Œ ì‹œìŠ¤í…œ ì„¤ì •ì€ í•„ìš”. <a href="https://pypi.org/project/edx-codejail/?utm_source=chatgpt.com">PyPI</a></li>
</ul>

<ol>
  <li>ëŒ€ì•ˆ ëŸ°íƒ€ì„(ì•„í‚¤í…ì²˜ë¥¼ ë°”ê¿”ì„œ ìƒŒë“œë°•ìŠ¤)</li>
</ol>

<ul>
  <li>WebAssembly ëŸ°íƒ€ì„ì„ íŒŒì´ì¬ì—ì„œ ì§ì ‘ ì“°ê¸°: wasmer-python/wasmtime-pyë¡œ WASI í™˜ê²½ì—ì„œ CPython/py2wasm ë“±ì„ ëŒë¦¬ë©´ ê¸°ë³¸ì´ â€œí—ˆìš© ì•ˆ í•¨â€ì´ë¼ íŒŒì¼Â·ë„¤íŠ¸ì›Œí¬ ì ‘ê·¼ì´ ëª…ì‹œì ìœ¼ë¡œ ì—´ì–´ì£¼ê¸° ì „ê¹Œì§€ ë§‰íŒë‹¤. ì„¸ì…˜í˜• ìœ ì§€ë„ êµ¬í˜„ ê°€ëŠ¥. ë‹¤ë§Œ ë„¤ì´í‹°ë¸Œ í™•ì¥ ëª¨ë“ˆ(ì˜ˆ: numpy) í˜¸í™˜ì„±ì€ ì „ëµì´ í•„ìš”í•˜ë‹¤. <a href="https://github.com/wasmerio/wasmer-python?utm_source=chatgpt.com">GitHub</a></li>
</ul>

<p>ë³´ì¡°(ë‹¨ë… ì‚¬ìš© ë¹„ê¶Œì¥, í•˜ì§€ë§Œ ë ˆì´ì–´ë¡œ ìœ ìš©)</p>

<ul>
  <li>
    <p>RestrictedPython: ì–¸ì–´ ê¸°ëŠ¥ì„ ì œí•œí•˜ëŠ” ë„êµ¬(ë¬¸ë²•/ë°”ì´íŠ¸ì½”ë“œ ë ˆë²¨)ë¼ OS íŒŒì¼ ì‹œìŠ¤í…œì„ ê°€ë‘ëŠ” ê±´ ì•„ë‹ˆë‹¤. Landlock/seccomp ìœ„ì—ì„œ â€œì¶”ê°€ ìš¸íƒ€ë¦¬â€ë¡œ ì“°ë©´ ì¢‹ë‹¤. <a href="https://restrictedpython.readthedocs.io/?utm_source=chatgpt.com">restrictedpython.readthedocs.io</a></p>
  </li>
  <li>
    <p>pyfakefs: í…ŒìŠ¤íŠ¸ìš© ê°€ì§œ íŒŒì¼ì‹œìŠ¤í…œ. ì‹¤ì œ ë””ìŠ¤í¬ë¥¼ ë§Œì§€ì§€ ì•Šê²Œ ë§Œë“¤ ìˆ˜ ìˆì§€ë§Œ â€œë³´ì•ˆ ê²©ë¦¬â€ëŠ” ì•„ë‹ˆë‹¤. ì£¼ ëª©ì ì€ íšŒê·€ ë°©ì§€/í…ŒìŠ¤íŠ¸ ì•ˆì •ì„±.</p>
  </li>
</ul>

<p>ì¶”ì²œ ì„¤ê³„(ë„ˆì˜ ì»¤ë„ ìœ ì§€ êµ¬ì¡°ì— ë°”ë¡œ ì–¹ê¸°)</p>

<ol>
  <li>
    <p>ì»¤ë„ ì‹œì‘ ì§í›„ ì²« ì…€ì—ì„œ Landlockì„ ì ìš©í•´ â€œSANDBOX_DIRë§Œ ì“°ê¸° í—ˆìš©â€ ê·œì¹™ì„ ê±´ë‹¤.</p>
  </li>
  <li>
    <p>seccompë¡œ execve/fork/socket ë“±ì„ ë§‰ëŠ”ë‹¤(ì„ íƒ).</p>
  </li>
  <li>
    <p>LLMì´ ì™¸ë¶€ íŒŒì¼ì„ ì“°ê³  ì‹¶ë‹¤ë©´ ë°˜ë“œì‹œ copy_to_sandbox(source, dest_rel) íˆ´ì„ í˜¸ì¶œí•˜ë„ë¡ ì—ì´ì „íŠ¸ ì •ì±…ì„ ê°•ì œí•œë‹¤.</p>
  </li>
  <li>
    <p>íŒŒì´ì¬ ë‹¨ì˜ ëª½í‚¤íŒ¨ì¹˜(open/rename/remove ë“±)ëŠ” ì—¬ì „íˆ ìœ ìš©í•œ ì†Œí”„íŠ¸ ê°€ë“œì§€ë§Œ, ì§„ì§œ ë°©ì–´ì„ ì€ ì»¤ë„(Landlock/seccomp)ì´ ë§¡ëŠ”ë‹¤.</p>
  </li>
</ol>

<p>Landlock ê°„ë‹¨ ì˜ˆì‹œ(ì•„ì´ë””ì–´ ìŠ¤ì¼€ì¹˜)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># pip install landlock  (ë¦¬ëˆ…ìŠ¤ 5.13+ í•„ìš”)
</span><span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">landlock</span> <span class="kn">import</span> <span class="n">Ruleset</span><span class="p">,</span> <span class="n">AccessFs</span><span class="p">,</span> <span class="n">PathBeneath</span>

<span class="n">SANDBOX_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">SANDBOX_DIR</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">/mnt/sandbox</span><span class="sh">"</span><span class="p">)</span>
<span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">SANDBOX_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># 1) ê·œì¹™ ëª¨ìŒ ìƒì„±: ê¸°ë³¸ì€ ì“°ê¸° ë¶ˆê°€, íŠ¹ì • ë””ë ‰í„°ë¦¬ë§Œ ì“°ê¸° í—ˆìš©
</span><span class="n">rules</span> <span class="o">=</span> <span class="nc">Ruleset</span><span class="p">()</span>
<span class="n">write_perms</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">AccessFs</span><span class="p">.</span><span class="n">WRITE_FILE</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">REMOVE_FILE</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">MAKE_DIR</span> <span class="o">|</span>
    <span class="n">AccessFs</span><span class="p">.</span><span class="n">REMOVE_DIR</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">TRUNCATE</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">RENAME_FROM</span> <span class="o">|</span>
    <span class="n">AccessFs</span><span class="p">.</span><span class="n">RENAME_TO</span>
<span class="p">)</span>
<span class="n">rules</span><span class="p">.</span><span class="nf">add_rule</span><span class="p">(</span><span class="nc">PathBeneath</span><span class="p">(</span><span class="n">SANDBOX_DIR</span><span class="p">,</span> <span class="n">write_perms</span><span class="p">))</span>

<span class="c1"># 2) í˜„ì¬ í”„ë¡œì„¸ìŠ¤(= ë„¤ê°€ ìœ ì§€í•˜ëŠ” Jupyter ì»¤ë„)ì— ì ìš©
</span><span class="n">rules</span><span class="p">.</span><span class="nf">restrict_self</span><span class="p">()</span>

<span class="c1"># ì´ì œë¶€í„° ì´ í”„ë¡œì„¸ìŠ¤ì™€ ìì‹ì€ SANDBOX_DIR ë°–ìœ¼ë¡œì˜ ì“°ê¸°ê°€ ì»¤ë„ì—ì„œ ê±°ë¶€ë¨
</span></code></pre></div></div>

<p>ì°¸ê³ ë¡œ execve/fork/socketë„ ë§‰ê³  ì‹¶ë‹¤ë©´, ì»¤ë„ ì‹œì‘ ì§í›„ seccomp í•„í„°ë¥¼ ê°™ì´ ë¡œë“œí•˜ë©´ ëœë‹¤(ì˜ˆ: execve/execveat/fork/vfork/sys_socket ì°¨ë‹¨). <a href="https://pypi.org/project/pyseccomp/?utm_source=chatgpt.com">PyPI</a></p>

<p>ì •ë¦¬í•˜ë©´ ì´ë ‡ê²Œ ê³¨ë¼ ì“°ë©´ ëœë‹¤.</p>

<ul>
  <li>
    <p>â€œë„ì»¤ ì—†ì´, íŒŒì¼ ì“°ê¸°ë§Œ ìƒŒë“œë°•ìŠ¤ë¡œâ€: landlock í•„ìˆ˜, í•„ìš” ì‹œ seccomp ì¶”ê°€. <a href="https://pypi.org/project/landlock/?utm_source=chatgpt.com">PyPI+1</a></p>
  </li>
  <li>
    <p>â€œì‹œìŠ¤í…œ í”„ë¡œíŒŒì¼ì„ ì¨ë„ ê´œì°®ë‹¤â€: codejail(AppArmor)ë¡œ ê´€ë¦¬. <a href="https://pypi.org/project/edx-codejail/?utm_source=chatgpt.com">PyPI</a></p>
  </li>
  <li>
    <p>â€œì•„ì˜ˆ ë‹¤ë¥¸ ëŸ°íƒ€ì„ì— ê°€ë‘”ë‹¤â€: wasmer-python/wasmtime-py ê¸°ë°˜ WASM ìƒŒë“œë°•ìŠ¤. <a href="https://github.com/wasmerio/wasmer-python?utm_source=chatgpt.com">GitHub</a></p>
  </li>
  <li>
    <p>â€œìˆœìˆ˜ íŒŒì´ì¬ ìƒŒë“œë°•ìŠ¤ë§Œìœ¼ë¡œëŠ” ìœ„í—˜â€: ê³¼ê±° ì‹œë„ê°€ â€˜ì„¤ê³„ìƒ ì·¨ì•½â€™ìœ¼ë¡œ ê²°ë¡  ë‚¬ë‹¤. ì»¤ë„/ëŸ°íƒ€ì„ ë ˆë²¨ ë°©ì–´ë¥¼ ë°˜ë“œì‹œ ê³ë“¤ì—¬ë¼. <a href="https://lwn.net/Articles/574323/?utm_source=chatgpt.com">LWN.net</a></p>
  </li>
</ul>

<p>ì›í•˜ë©´ ë„¤ê°€ ì–´ì œ ì£¼ì‹  ì»¤ë„-ì„¸ì…˜ êµ¬ì¡°ì— Landlock+seccompë¥¼ ì •í™•íˆ ì£¼ì…í•œ ë²„ì „(íˆ´ í˜¸ì¶œê³¼ ì—°ë™ê¹Œì§€)ë¡œ ë¦¬ë¼ì´íŒ…í•´ì„œ ì „ë‹¬í•˜ê² ë‹¤.</p>

<p class="chat--user">

ê·¸ë ‡ê²Œ ê¹Œì§€ ì™„ë²½í•œ ìƒŒë“œë°•ìŠ¤ëŠ” í•„ìš”ì—†ì–´

</p>

<p>ì¢‹ì•„. â€œì™„ë²½í•˜ì§€ ì•Šì•„ë„ ë˜ëŠ”â€ í˜„ì‹¤ì  80/20 í•´ë²•ìœ¼ë¡œ ì •ë¦¬í•´ ì¤„ê²Œ. í•µì‹¬ì€ ì»¤ë„ì€ ê³„ì† ìœ ì§€í•˜ë©´ì„œ, ì‹¤ìˆ˜ë¡œ í˜¸ìŠ¤íŠ¸ë¥¼ ë”ëŸ½íˆëŠ” ê±¸ ë§‰ëŠ” 3ì¤‘ ì™„ì¶©ì¥ì¹˜ë‹¤.</p>

<ol>
  <li>
    <p>ì»¤ë„ ì‹œì‘ ì§í›„ í•œ ë²ˆë§Œ ì£¼ì…í•˜ëŠ” audit hookìœ¼ë¡œ ì“°ê¸°/ì„œë¸Œí”„ë¡œì„¸ìŠ¤/ë„¤íŠ¸ì›Œí¬ë¥¼ ê°€ë³ê²Œ ì°¨ë‹¨</p>
  </li>
  <li>
    <p>í•„ìš”í•œ íŒŒì¼ì€ copy_to_sandbox(source, dest_rel)ë¡œ ë³µì‚¬í•´ ìƒŒë“œë°•ìŠ¤ ì•ˆì—ì„œë§Œ ë‹¤ë£¸</p>
  </li>
  <li>
    <p>CPU/ë©”ëª¨ë¦¬/íŒŒì¼ì‚¬ì´ì¦ˆ ê°™ì€ ë¦¬ì†ŒìŠ¤ ì œí•œìœ¼ë¡œ í­ì£¼ ë°©ì§€</p>
  </li>
</ol>

<p>ì´ ì¡°í•©ì€ â€œê°•ì²  ê°ì˜¥â€ì€ ì•„ë‹ˆì§€ë§Œ, ì‹¤ë¬´ì—ì„œ ë°œìƒí•˜ëŠ” ëŒ€ë¶€ë¶„ì˜ ì‹¤ìˆ˜ì„± íŒŒê´´ë¥¼ í™•ì‹¤íˆ ê±¸ëŸ¬ì¤€ë‹¤. ê·¸ë¦¬ê³  ë„ì»¤ë„ í•„ìš” ì—†ë‹¤.</p>

<p>ì•„ë˜ëŠ” ë„¤ê°€ ì¤€ ì»¤ë„-ì„¸ì…˜ ì½”ë“œì— ë”± í•„ìš”í•œ ë§Œí¼ë§Œ ì¶”ê°€/êµì²´í•˜ëŠ” ìŠ¤ë‹ˆí«ì´ë‹¤.</p>

<ol>
  <li>ì»¤ë„ì— ì£¼ì…í•  ê°€ë²¼ìš´ ê°€ë“œ ì½”ë“œ(sys.addaudithook ê¸°ë°˜)</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ì»¤ë„ì— ì¸ì ì…˜í•  ì½”ë“œ: AUDIT_GUARD_CODE
</span><span class="n">AUDIT_GUARD_CODE</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os, sys
SANDBOX_DIR = os.path.realpath(os.environ.get(</span><span class="sh">'</span><span class="s">SANDBOX_DIR</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">/mnt/sandbox</span><span class="sh">'</span><span class="s">))
os.makedirs(SANDBOX_DIR, exist_ok=True)

def _in_sb(p):
    rp = os.path.realpath(p)
    return rp == SANDBOX_DIR or rp.startswith(SANDBOX_DIR + os.sep)

def _audit(event, args):
    # íŒŒì¼ ì“°ê¸° ì‹œë„ ì°¨ë‹¨: open ë° os.openì€ </span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="s"> ì´ë²¤íŠ¸ë¡œ ë“¤ì–´ì˜´
    if event == </span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="s">:
        path = str(args[0])
        mode = str(args[1]) if len(args) &gt; 1 else </span><span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="s">
        flags = int(args[2]) if len(args) &gt; 2 else 0
        write_intent = any(ch in mode for ch in (</span><span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">a</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">+</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="s">)) or (flags &amp; (os.O_WRONLY|os.O_RDWR|os.O_CREAT|os.O_TRUNC|os.O_APPEND))
        if write_intent and not _in_sb(path):
            raise PermissionError(f</span><span class="sh">'</span><span class="s">Writes are restricted to {SANDBOX_DIR}: {path}</span><span class="sh">'</span><span class="s">)
    # ì„œë¸Œí”„ë¡œì„¸ìŠ¤/ì…¸ ì°¨ë‹¨
    elif event.startswith(</span><span class="sh">'</span><span class="s">subprocess.</span><span class="sh">'</span><span class="s">):
        raise PermissionError(</span><span class="sh">'</span><span class="s">Subprocess disabled in this session</span><span class="sh">'</span><span class="s">)
    elif event == </span><span class="sh">'</span><span class="s">os.system</span><span class="sh">'</span><span class="s">:
        raise PermissionError(</span><span class="sh">'</span><span class="s">os.system disabled in this session</span><span class="sh">'</span><span class="s">)
    # ë„¤íŠ¸ì›Œí¬ ì°¨ë‹¨(ì›í•˜ë©´ ì£¼ì„ í•´ì œ)
    elif event.startswith(</span><span class="sh">'</span><span class="s">socket.</span><span class="sh">'</span><span class="s">):
        raise PermissionError(</span><span class="sh">'</span><span class="s">Network disabled in this session</span><span class="sh">'</span><span class="s">)

sys.addaudithook(_audit)

# ê°€ë²¼ìš´ í•œë„ ì„¤ì •(ìœ ë‹‰ìŠ¤ ê³„ì—´ì—ì„œë§Œ ì‘ë™)
try:
    import resource
    resource.setrlimit(resource.RLIMIT_CPU, (3, 3))             # CPU 3ì´ˆ
    resource.setrlimit(resource.RLIMIT_AS, (1024*1024*1024,)*2) # 1GB ë©”ëª¨ë¦¬
    resource.setrlimit(resource.RLIMIT_FSIZE, (200*1024*1024,)*2) # íŒŒì¼ ìµœëŒ€ 200MB
    resource.setrlimit(resource.RLIMIT_NOFILE, (256, 256))
except Exception:
    pass

print(</span><span class="sh">'</span><span class="s">[audit-guard] active for sandbox:</span><span class="sh">'</span><span class="s">, SANDBOX_DIR)
</span><span class="sh">"""</span>
</code></pre></div></div>

<ol>
  <li>KernelSessionì— ê°€ë“œ ì£¼ì… í•œ ë²ˆë§Œ ì‹¤í–‰í•˜ë„ë¡ ë³´ê°•</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">KernelSession</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="n">jupyter_client</span> <span class="kn">import</span> <span class="n">KernelManager</span>
        <span class="n">self</span><span class="p">.</span><span class="n">km</span> <span class="o">=</span> <span class="nc">KernelManager</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">start_kernel</span><span class="p">(</span><span class="n">extra_arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">--HistoryManager.enabled=False</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">kc</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">client</span><span class="p">();</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">start_channels</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_guard_ready</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_ensure_guard</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_guard_ready</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">code</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">import os; os.environ[</span><span class="sh">'</span><span class="s">SANDBOX_DIR</span><span class="sh">'</span><span class="s">] = </span><span class="si">{</span><span class="n">SANDBOX_DIR</span><span class="si">!r}</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="n">AUDIT_GUARD_CODE</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_exec_once</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_guard_ready</span> <span class="o">=</span> <span class="bp">True</span>
</code></pre></div></div>

<ol>
  <li>copy_to_sandbox(source, dest_rel) íˆ´(ê°„ê²°íŒ)</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">copy_to_sandbox_impl</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dest_rel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">shutil</span><span class="p">,</span> <span class="n">stat</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">source not found: </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">islink</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">symlink not allowed</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">dest_rel</span> <span class="k">else</span> <span class="n">dest_rel</span>
    <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">SANDBOX_DIR</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">dst</span> <span class="o">==</span> <span class="n">SANDBOX_DIR</span> <span class="ow">or</span> <span class="n">dst</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">SANDBOX_DIR</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">destination must be inside sandbox</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">dst</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">destination exists: </span><span class="si">{</span><span class="n">dst</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">shutil</span><span class="p">.</span><span class="nf">copytree</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">copy_function</span><span class="o">=</span><span class="n">shutil</span><span class="p">.</span><span class="n">copy2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shutil</span><span class="p">.</span><span class="nf">copy2</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">chmod</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IRGRP</span> <span class="o">|</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IROTH</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">sandbox_path</span><span class="sh">"</span><span class="p">:</span> <span class="n">dst</span><span class="p">}</span>
</code></pre></div></div>

<ol>
  <li>ì‹¤í–‰ê¸°ì—ì„œ ê°€ë“œ ë³´ì¥ í›„ ì½”ë“œ ìˆ˜í–‰</li>
</ol>

<p>ë„¤ê°€ ì´ë¯¸ ê°€ì§„ <code class="language-plaintext highlighter-rouge">KernelSession.execute()</code> ì•ë¶€ë¶„ì— <code class="language-plaintext highlighter-rouge">_ensure_guard()</code> í•œ ì¤„ë§Œ ì¶”ê°€í•˜ë©´ ëœë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">self</span><span class="p">.</span><span class="nf">_ensure_guard</span><span class="p">()</span>  <span class="c1"># ê°€ë“œê°€ ì£¼ì…ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì§€ê¸ˆ ì£¼ì…
</span>    <span class="c1"># ì´í•˜ ê¸°ì¡´ ë¡œì§ ê·¸ëŒ€ë¡œ
</span></code></pre></div></div>

<p>ì´ë ‡ê²Œ í•˜ë©´ ë‹¤ìŒì´ ìì—°ìŠ¤ëŸ½ê²Œ ì¶©ì¡±ëœë‹¤.</p>

<ul>
  <li>
    <p>ì–´ë””ë“  ì½ê¸° ê°€ëŠ¥</p>
  </li>
  <li>
    <p>ì“°ê¸°ëŠ” ìƒŒë“œë°•ìŠ¤ ë””ë ‰í† ë¦¬ ì•ˆì—ì„œë§Œ ê°€ëŠ¥</p>
  </li>
  <li>
    <p>temp.py ê°™ì€ ì„ì˜ ì½”ë“œê°€ /etc, ~, /var ë“±ì— ì“°ë ¤ê³  í•˜ë©´ audit hookì—ì„œ ì¦‰ì‹œ PermissionError</p>
  </li>
  <li>
    <p>ì„œë¸Œí”„ë¡œì„¸ìŠ¤/ë„¤íŠ¸ì›Œí¬ëŠ” ê¸°ë³¸ ì°¨ë‹¨(ì˜µì…˜)</p>
  </li>
  <li>
    <p>ì»¤ë„ì€ ì„¸ì…˜ ë‹¨ìœ„ë¡œ ê³„ì† ìœ ì§€</p>
  </li>
</ul>

<p>ìš´ì˜ íŒ ëª‡ ê°€ì§€ë§Œ ë§ë¶™ì¸ë‹¤.</p>

<ul>
  <li>
    <p>ë¯¼ê° ê²½ë¡œ ì½ê¸°ê¹Œì§€ í—ˆìš©í•˜ë©´ ì˜ë„ì¹˜ ì•Šê²Œ ë¹„ë°€ í† í°ì„ ì½ì„ ìˆ˜ ìˆë‹¤. í•„ìš”í•˜ë©´ audit hookì—ì„œ ì½ê¸° í—ˆìš© ê²½ë¡œë„ allowlistë¡œ ì¢í˜€ë¼.</p>
  </li>
  <li>
    <p>Windowsì—ì„œëŠ” resource ì œí•œì´ ì œí•œì ì´ë‹¤. ê·¸ë˜ë„ audit hookì€ ë™ì‘í•˜ë‹ˆ íŒŒì¼ ì“°ê¸°/ì„œë¸Œí”„ë¡œì„¸ìŠ¤ ì°¨ë‹¨ì—” ìœ ìš©í•˜ë‹¤.</p>
  </li>
  <li>
    <p>CPython 3.8+ì—ì„œ audit hookì´ ì§€ì›ëœë‹¤. ê·¸ ì•„ë˜ ë²„ì „ì€ ì´ ë°©ì‹ì´ ì•ˆ ëœë‹¤.</p>
  </li>
  <li>
    <p>numpy/pandas/matplotlib ê°™ì€ ì¼ë°˜ ê³¼í•™ ìŠ¤íƒì€ ê·¸ëŒ€ë¡œ ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤. ë„¤ê°€ ì¡ì•„ ë‘” â€œë‹¨ì¼ í”Œë¡¯Â·ìƒ‰ìƒ ì§€ì • ê¸ˆì§€â€ ì •ì±…ì€ ê¸°ì¡´ ê²€ì‚¬ë¡œ ìœ ì§€í•˜ë©´ ëœë‹¤.</p>
  </li>
</ul>

<p>ì´ ì •ë„ë©´ â€œì™„ë²½í•œ ê°ì˜¥â€ì€ ì•„ë‹ˆì§€ë§Œ, ì‹¤ë¬´ì—ì„œ ì‹¤ìˆ˜ì„± íŒŒê´´ë¥¼ ê±°ì˜ ì—†ì• ë©´ì„œ ì»¤ë„ ì§€ì†ì„±ê³¼ ê°œë°œ í¸ì˜ì„±ì„ ê·¸ëŒ€ë¡œ ê°€ì ¸ê°ˆ ìˆ˜ ìˆë‹¤. ë‹¤ìŒìœ¼ë¡œ vLLM + Agents SDKì— ë…¸ì¶œí•  íˆ´ ìŠ¤í™ì„ ì •ë¦¬í•´ì£¼ê¸¸ ì›í•˜ë©´ ê·¸ ë¶€ë¶„ë„ ë°”ë¡œ ì´ì–´ì„œ ë§Œë“¤ì–´ ì¤„ê²Œ.</p>

<p class="chat--user">

landlockì„ ì½ê¸° ê°€ëŠ¥ í´ë” ë”°ë¡œ ì“°ê¸° ê°€ëŠ¥ í´ë” ë”°ë¡œ ì§€ì •ê°€ëŠ¥í•´?

</p>

<p>ê°€ëŠ¥í•´. LandlockëŠ” â€œê²½ë¡œë³„ ê¶Œí•œ ë¹„íŠ¸ë§ˆìŠ¤í¬â€ë¥¼ ì¤˜ì„œ ì½ê¸° ì „ìš© ë””ë ‰í„°ë¦¬ì™€ ì“°ê¸° í—ˆìš© ë””ë ‰í„°ë¦¬ë¥¼ ê°ê° ë”°ë¡œ ì§€ì •í•  ìˆ˜ ìˆì–´. ë°©ë²•ì˜ ë¼ˆëŒ€ëŠ” ì´ë ‡ë‹¤.</p>

<ol>
  <li>
    <p>rulesetì„ ë§Œë“¤ ë•Œ ì½ê¸°ì™€ ì“°ê¸°ì— í•´ë‹¹í•˜ëŠ” ëª¨ë“  ê¶Œí•œì„ handled_access_fsì— í¬í•¨í•œë‹¤. ì˜ˆì‹œë¡œ ë¬¸ì„œì— ë‚˜ì˜¤ëŠ” READ_FILE, READ_DIR, WRITE_FILE, MAKE__(íŒŒì¼/ë””ë ‰í„°ë¦¬ ìƒì„±), REMOVE__(ì‚­ì œ), TRUNCATE(ABI v3+), REFER(ë””ë ‰í„°ë¦¬ ê°„ ì´ë™/ë§í¬, ABI v2+) ë“±ì„ ë¬¶ëŠ”ë‹¤. ì´ë ‡ê²Œ í•´ì•¼ â€œëª…ì‹œí•œ ê¶Œí•œë§Œ í—ˆìš©, ë‚˜ë¨¸ì§€ëŠ” ê±°ë¶€â€ê°€ ì œëŒ€ë¡œ ì‘ë™í•œë‹¤. <a href="https://docs.kernel.org/userspace-api/landlock.html">Kernel ë¬¸ì„œ</a></p>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>ì½ê¸° ì „ìš© ë””ë ‰í„°ë¦¬ ê·œì¹™ì„ ì¶”ê°€í•œë‹¤. í•´ë‹¹ ê²½ë¡œì— ëŒ€í•´ allowed_accessë¥¼ READ_FILE</td>
          <td>READ_DIR(í•„ìš”í•˜ë©´ EXECUTE) ì •ë„ë§Œ ì£¼ëŠ” PathBeneath ê·œì¹™ì„ rulesetì— ë„£ëŠ”ë‹¤. ì»¤ë„ ë¬¸ì„œ ì˜ˆì œë„ /usrë¥¼ ì´ëŸ° ì‹ìœ¼ë¡œ â€œì½ê¸°ë§Œ í—ˆìš©â€ìœ¼ë¡œ ì¶”ê°€í•œë‹¤. <a href="https://docs.kernel.org/userspace-api/landlock.html">Kernel ë¬¸ì„œ+1</a></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>ì“°ê¸° í—ˆìš© ë””ë ‰í„°ë¦¬ ê·œì¹™ì„ ë³„ë„ë¡œ ì¶”ê°€í•œë‹¤. ë³´í†µì€ READ_DIR(ê²½ë¡œ íƒìƒ‰/ëª©ë¡), WRITE_FILE, MAKE_REG/MAKE_DIR, REMOVE_FILE/REMOVE_DIR, TRUNCATE(ABI v3+)ë¥¼ ë¬¶ê³ , ë””ë ‰í„°ë¦¬ ê°„ rename/linkê°€ í•„ìš”í•˜ë©´ REFER(ABI v2+)ê¹Œì§€ í¬í•¨í•œë‹¤. ê·¸ëŸ° ë‹¤ìŒ landlock_restrict_selfë¡œ í˜„ì¬ ìŠ¤ë ˆë“œ(â†’ ìì‹ í”„ë¡œì„¸ìŠ¤ í¬í•¨)ì— ì ìš©í•œë‹¤. <a href="https://docs.kernel.org/userspace-api/landlock.html">Kernel ë¬¸ì„œ+1</a></li>
</ol>

<p>íŒê³¼ ì£¼ì˜ì </p>

<ul>
  <li>
    <p>â€œì§„ì§œâ€ ì˜ë¯¸ì˜ write-only ë””ë ‰í„°ë¦¬ë¥¼ ë§Œë“¤ê³  ì‹¶ë”ë¼ë„, íŒŒì¼ì„ ë§Œë“¤ê±°ë‚˜ ì—´ë ¤ë©´ ìµœì†Œí•œ ë””ë ‰í„°ë¦¬ íƒìƒ‰ì„ ìœ„í•œ READ_DIR ê¶Œí•œì´ í•„ìš”í•´ì§€ëŠ” ê²½ìš°ê°€ ë§ë‹¤. ì»¤ë„ ë¬¸ì„œë„ ì‹¤ì „ì—ì„œëŠ” ì½ê¸°/ì“°ê¸° ê¶Œí•œì„ ë””ë ‰í„°ë¦¬ ë‹¨ìœ„ë¡œ ê¹¨ë—í•˜ê²Œ ë¶„ë¦¬í•´ ë‘ëŠ” ê²ƒì„ ê¶Œì¥í•œë‹¤(ì˜ˆ: ~/docì€ read-only, ~/tmpëŠ” read-write). <a href="https://docs.kernel.org/userspace-api/landlock.html">Kernel ë¬¸ì„œ</a></p>
  </li>
  <li>
    <p>TRUNCATEëŠ” ABI v3(ë¦¬ëˆ…ìŠ¤ 6.2)ë¶€í„° ì œì–´ ê°€ëŠ¥, REFERëŠ” ABI v2(ë¦¬ëˆ…ìŠ¤ 5.19)ë¶€í„°. ì‹¤í–‰ í™˜ê²½ì˜ Landlock ABI ë²„ì „ì„ ì¡°íšŒí•´ ê°€ìš© ê¶Œí•œë§Œ ì“°ë„ë¡ í•˜ëŠ” â€œë² ìŠ¤íŠ¸ ì—í¬íŠ¸â€ íŒ¨í„´ì´ ê³µì‹ ì˜ˆì œì— ìˆë‹¤. <a href="https://docs.kernel.org/userspace-api/landlock.html">Kernel ë¬¸ì„œ+1</a></p>
  </li>
  <li>
    <p>íŒŒì´ì¬ì—ì„œ ì“°ë ¤ë©´ C syscallsë¥¼ ì§ì ‘ í˜¸ì¶œí•´ë„ ë˜ê³ , PyPIì˜ landlock ë°”ì¸ë”©ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. ì´ íŒ¨í‚¤ì§€ëŠ” íŒŒì´ì¬ì—ì„œ rulesetì„ ë§Œë“¤ê³  ê²½ë¡œë¥¼ í—ˆìš© ëª©ë¡ìœ¼ë¡œ ì¶”ê°€í•œ ë’¤ apply()ë¡œ ì ìš©í•˜ëŠ” íë¦„ì„ ì œê³µí•œë‹¤(ì„¸ë¶€ ê¶Œí•œ í”Œë˜ê·¸ëŠ” ë²„ì „ì— ë”°ë¼ ë‹¤ë¦„). <a href="https://pypi.org/project/landlock/">PyPI+1</a></p>
  </li>
</ul>

<p>ìš”ì•½í•˜ë©´, í•˜ë‚˜ì˜ ruleset ì•ˆì— â€œì½ê¸° ì „ìš© A ë””ë ‰í„°ë¦¬ìš© ê·œì¹™â€ê³¼ â€œì“°ê¸° í—ˆìš© B ë””ë ‰í„°ë¦¬ìš© ê·œì¹™â€ì„ ê°ê° ì¶”ê°€í•˜ë©´ ëœë‹¤. ì›í•˜ë©´ ë„¤ ì»¤ë„-ì„¸ì…˜ êµ¬ì¡°ì— ë§ì¶°ì„œ, AëŠ” READ_FILE/READ_DIRë§Œ, BëŠ” READ_DIR+WRITE_FILE+MAKE__/REMOVE__ +TRUNCATE(+REFER ì„ íƒ)ë¡œ ë¬¶ì€ ìµœì†Œ ì˜ˆì œ ì½”ë“œë¥¼ ë°”ë¡œ ë§ì¶° ë“œë¦´ê²Œ.</p>

<p class="chat--user">

ê·¼ë° ë£°ì…‹ì„ íŒŒì´ì¬ ì½”ë“œê°€ í’€ì–´ë²„ë¦´ìˆ˜ë„ì‡ì§€ì•Šë‚˜

</p>

<p>ì§§ê²Œ ë‹µí•˜ë©´ â€œì •ìƒ ë™ì‘í•˜ëŠ” Landlockì— í•œí•´ì„ , íŒŒì´ì¬ ì½”ë“œê°€ ë£°ì„ â€˜í’€ì–´ë²„ë¦¬ëŠ”â€™ ê±´ ë¶ˆê°€ëŠ¥â€ì´ ë§ë‹¤. LandlockëŠ” ì»¤ë„ì´ ê°•ì œí•˜ëŠ” ì¼ë°©í–¥(one-way) ì œì•½ì´ë¼, í•œ ë²ˆ <code class="language-plaintext highlighter-rouge">landlock_restrict_self()</code>ë¡œ ì ìš©í•˜ë©´ í•´ì œÂ·ì™„í™”ê°€ ì•ˆ ë˜ê³  ë” ì¢íˆëŠ” ê²ƒë§Œ ê°€ëŠ¥í•˜ë‹¤. ê·¸ë¦¬ê³  ìƒˆë¡œ ìƒì„±ë˜ëŠ” ìì‹ í”„ë¡œì„¸ìŠ¤ë“¤ì€ ê·¸ ì œì•½ì„ ê·¸ëŒ€ë¡œ ìƒì†ë°›ëŠ”ë‹¤. í˜•ì œ ìŠ¤ë ˆë“œì—ëŠ” ìë™ ì „íŒŒê°€ ì•ˆ ë˜ë¯€ë¡œ, ìŠ¤ë ˆë“œê°€ ìƒê¸°ê¸° ì „ì— ì ìš©í•˜ê±°ë‚˜ ê° ìŠ¤ë ˆë“œì—ì„œ ì ìš©í•´ì•¼ í•œë‹¤. <a href="https://landlock.io/talks/2025-01-29_landlock-workshop.pdf?utm_source=chatgpt.com">landlock.io+1</a></p>

<p>í˜„ì‹¤ì ì¸ ì˜ˆì™¸Â·ì£¼ì˜ì ë„ ìˆë‹¤.</p>

<ol>
  <li>
    <p>2024ë…„ì— â€œì œì•½ì„ ìƒì–´ë²„ë¦´ ìˆ˜ ìˆëŠ”â€ ì»¤ë„ ë²„ê·¸ê°€ ìˆì—ˆë‹¤(CVE-2024-42318). íŠ¹ìˆ˜í•œ <code class="language-plaintext highlighter-rouge">keyctl(KEYCTL_SESSION_TO_PARENT)</code> ê²½ë¡œì—ì„œ Landlock ì •ë³´ê°€ ì‚¬ë¼ì§€ëŠ” ë¬¸ì œì˜€ê³ , ì»¤ë„ ì¸¡ì—ì„œ <code class="language-plaintext highlighter-rouge">cred_transfer</code> í›…ì„ ì¶”ê°€í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ìˆ˜ì •ëë‹¤. ë©”ì¸ë¼ì¸ì— ë¨¸ì§€ë˜ì—ˆê³  ê° ì•ˆì •í™” ë¸Œëœì¹˜ë¡œ ë°±í¬íŠ¸ëë‹¤. ë°°í¬íŒ ì»¤ë„ì´ ì´ ìˆ˜ì •ì´ í¬í•¨ëœ ë²„ì „ì´ë©´, ì‚¬ìš©ì ê³µê°„ ì½”ë“œê°€ Landlockì„ í•´ì œí•˜ëŠ” ìš°íšŒëŠ” ë” ì´ìƒ í†µí•˜ì§€ ì•ŠëŠ”ë‹¤. í™˜ê²½ ì ê²€ë§Œ í•´ë‘ë©´ ëœë‹¤. <a href="https://nvd.nist.gov/vuln/detail/cve-2024-42318?utm_source=chatgpt.com">NVD+1</a></p>
  </li>
  <li>
    <p>ì œì•½ì€ â€œê·¸ ì‹œì  ì´í›„ì˜ ì ‘ê·¼â€ì— ì ìš©ëœë‹¤. ì œì•½ì„ ê±¸ê¸° ì „ì— ì´ë¯¸ ì“°ê¸° ê¶Œí•œìœ¼ë¡œ ì—° ì—´ë¦° íŒŒì¼ ë””ìŠ¤í¬ë¦½í„°ê°€ ìˆë‹¤ë©´ ê·¸ FDë¥¼ í†µí•´ì„œëŠ” ê³„ì† ì“¸ ìˆ˜ ìˆë‹¤. ë”°ë¼ì„œ ì»¤ë„(ë˜ëŠ” ì»¤ë„ í”„ë¡œì„¸ìŠ¤) ì‹œì‘ ì§í›„, ì‚¬ìš©ì ì½”ë“œê°€ ëŒê¸° ì „ì— ë°”ë¡œ ì œí•œì„ ê±¸ê³ , ë¯¸ë¦¬ ì—´ë¦° ë¶ˆí•„ìš”í•œ FDë¥¼ ë‹«ëŠ” ê²Œ ì•ˆì „í•˜ë‹¤. ì´ê±´ Landlockì˜ ì„¤ê³„ ì² í•™(ëˆ„ì Â·ì¼ë°©í–¥)ê³¼ ë™ì¼í•œ ì£¼ì˜ì ì´ë‹¤. <a href="https://docs.kernel.org/userspace-api/landlock.html?utm_source=chatgpt.com">Kernel ë¬¸ì„œ</a></p>
  </li>
</ol>

<p>ì •ë¦¬í•˜ë©´ ë‹¤ìŒì²˜ëŸ¼ ìš´ìš©í•˜ë©´ ëœë‹¤.</p>

<p>â€¢ â€œí’€ ìˆ˜ ì—†ë‹¤â€ëŠ” ë³´ì¥ì€ ì»¤ë„ì´ ì¤€ë‹¤. ì‚¬ìš©ì íŒŒì´ì¬ì´ <code class="language-plaintext highlighter-rouge">ctypes</code>Â·<code class="language-plaintext highlighter-rouge">os</code>Â·<code class="language-plaintext highlighter-rouge">subprocess</code>ë¡œ ë°œë²„ë‘¥ì³ë„ Landlock ìì²´ë¥¼ í•´ì œí•˜ì§„ ëª»í•œë‹¤. ì œì•½ì€ ëˆ„ì ë§Œ ëœë‹¤. <a href="https://landlock.io/talks/2025-01-29_landlock-workshop.pdf?utm_source=chatgpt.com">landlock.io</a><br />
â€¢ ë‹¨, ì»¤ë„ì´ CVE-2024-42318 ìˆ˜ì •ë¶„ì„ í¬í•¨í•´ì•¼ í•œë‹¤. 2024-07 ë§ì— ë©”ì¸ë¼ì¸ì— ë“¤ì–´ê°”ê³  ë°°í¬íŒ ì»¤ë„ì—ë„ ë°˜ì˜ëë‹¤. ìš´ì˜ í™˜ê²½ì˜ ì»¤ë„ ì—…ë°ì´íŠ¸ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ì. <a href="https://nvd.nist.gov/vuln/detail/cve-2024-42318?utm_source=chatgpt.com">NVD+1</a><br />
â€¢ ìŠ¤ë ˆë“œ/í”„ë¡œì„¸ìŠ¤ ëª¨ë¸ì„ ê¸°ì–µí•˜ì. í˜„ì¬ ìŠ¤ë ˆë“œì— ì ìš©í•˜ë©´ ìì‹ì—ëŠ” ìƒì†ë˜ì§€ë§Œ, ì´ë¯¸ ë–  ìˆëŠ” ë‹¤ë¥¸ ìŠ¤ë ˆë“œì—” ìë™ ì ìš© ì•ˆ ëœë‹¤. ì»¤ë„ í”„ë¡œì„¸ìŠ¤ ì´ˆê¸°í™” ì§í›„ ì œì¼ ë¨¼ì € ì œí•œì„ ê±´ë‹¤. <a href="https://man7.org/linux/man-pages/man7/landlock.7.html?utm_source=chatgpt.com">man7.org</a></p>

<p>ë§ë¶™ì—¬, ì½ê¸° ì „ìš© í´ë”ì™€ ì“°ê¸° í—ˆìš© í´ë”ë¥¼ ê°ê° ë”°ë¡œ ì£¼ëŠ” ê²ƒë„ í•œ ruleset ì•ˆì—ì„œ ê·œì¹™ ë‘ ê°œë¡œ ì¶©ë¶„í•˜ë©°, í•„ìš” ê¶Œí•œ ë¹„íŠ¸(READ_FILE/READ_DIRâ€¦ vs WRITE_FILE/MAKE_DIR/REMOVE_* ë“±)ë¥¼ ë¶„ë¦¬í•´ ì£¼ë©´ ëœë‹¤. ABI ë²„ì „ì— ë”°ë¼ TRUNCATE/REFER ê°™ì€ ê¶Œí•œ ê°€ìš©ì„±ì´ ë‹¬ë¼ì§€ë‹ˆ â€œbest-effortâ€ ë°©ì‹ìœ¼ë¡œ ê°ì§€í•´ ì“°ë©´ í˜¸í™˜ì„±ì´ ì¢‹ë‹¤. <a href="https://docs.kernel.org/userspace-api/landlock.html?utm_source=chatgpt.com">Kernel ë¬¸ì„œ</a></p>

<p>ì´ ìƒíƒœì—ì„œ ë„¤ ì»¤ë„-ì„¸ì…˜ êµ¬ì¡° ìœ„ì— ì–¹ìœ¼ë©´, íŒŒì´ì¬ ìª½ ëª½í‚¤íŒ¨ì¹˜ë‚˜ audit hookì€ â€œì†Œí”„íŠ¸ ê°€ë“œâ€ë¡œ í¸ì˜ì™€ ë©”ì‹œì§€ í’ˆì§ˆì„ ì˜¬ë ¤ì£¼ê³ , Landlockì´ â€œí•˜ë“œ ê°€ë“œâ€ë¡œ ë°”ë‹¥ì„ ë°›ì³ì¤€ë‹¤. ë‹¤ìŒ ë‹¨ê³„ë¡œ ì»¤ë„ ì²« ì…€ì—ì„œ Landlockì„ ì ìš©í•˜ëŠ” ìµœì†Œ ìƒ˜í”Œì„ ë¶™ì—¬ì¤„ ìˆ˜ ìˆë‹¤.</p>

<p class="chat--user">

ì•„í•˜ ë‹¤ì‹œ í•œ ë²ˆ ê¹”ë”í•˜ê²Œ ì •ë¦¬í•´ë³´ì. íŒŒì´ì¬ ì‹¤í–‰ íˆ´ì„ LLMì´ ì“¸ ìˆ˜ ìˆë„ë¡ ë§Œë“¤ ê²ƒ íˆ´ Config ë‹¨ê³„ -&gt; LLMì—ê²Œ íˆ´ ì‚¬ìš© ë²• ì „ë‹¬í•˜ëŠ” ë‹¨ê³„ -&gt; ì‹¤ì œë¡œ ì‚¬ìš©í•˜ëŠ” ë‹¨ê³„ ì´ë ‡ê²Œ 3ë‹¨ê³„ë¥¼ ë‚˜ëˆ ì„œ ìƒê°í•˜ì. ìš”êµ¬ ì‚¬í•­ 1. íˆ´ Config ë‹¨ê³„ì—ì„œ landlockìœ¼ë¡œ WRITE/READ ê°€ ê°€ëŠ¥í•œ í´ë”, READë§Œ ê°€ëŠ¥í•œ í´ë”ë¥¼ ì§€ì •í•´ë‘”ë‹¤. (í•˜ìœ„ í´ë”ê¹Œì§€ í¬í•¨) 2. ì„¸ì…˜ì€ jupyter client ë“  ë­ë“  ìœ ì§€í•œë‹¤(jupyter client ë§ê³  ë‹¤ë¥¸ ì ì ˆí•œ ë°©ë²•ì´ ìˆìœ¼ë©´ ê·¸ê±¸ ì‚¬ìš©í•  ê²ƒ). ê° ì—ì´ì „íŠ¸ë³„ ì„¸ì…˜ì„ ìœ ì§€í•œë‹¤. ì´ ë•Œ ì„¸ì…˜ì— ëŒ€í•œ id ê°™ì€ê±¸ ê°™ì´ ë°›ëŠ” ë°©ë²•ì´ ìˆì„ ë“¯. 3. ì‹¤ì œë¡œ ì‚¬ìš©í•  ë•ŒëŠ” (1) ì„¸ì…˜ì„ ìœ ì§€í• ì§€ ë§ì§€, (2) ì¼íšŒìš© ì½”ë“œ ì‹¤í–‰í• ì§€ ì„ íƒí•  ìˆ˜ë„ ìˆì„ ê²ƒ ê°™ë„¤. ì„¤ê³„ ì˜ í•´ì¤˜.

</p>

<p>ì¢‹ì•„, 3ë‹¨ê³„ íë¦„ì— ë”± ë§ì¶° ì„¤ê³„ì™€ ìµœì†Œ êµ¬í˜„ ìŠ¤ì¼€ì¹˜ë¥¼ ì •ë¦¬í•œë‹¤. ëª©í‘œëŠ” LLMì´ íŒŒì´ì¬ì„ ì‹¤í–‰í•˜ë˜, ì„¤ì • ë‹¨ê³„ì—ì„œ ì½ê¸°/ì“°ê¸° í´ë” ì •ì±…ì„ ì •í•˜ê³ , ì„¸ì…˜ì„ í•„ìš”ì— ë”°ë¼ ìœ ì§€í•˜ê±°ë‚˜ 1íšŒì„±ìœ¼ë¡œ ì“°ëŠ” ê²ƒ.</p>

<h1 id="0-ì „ì²´-êµ¬ì¡°-í•œëˆˆì—">0. ì „ì²´ êµ¬ì¡° í•œëˆˆì—</h1>

<ul>
  <li>
    <p>PythonExecManager: íˆ´ ì§„ì…ì . ì •ì±…(ëœë“œë½), ì„¸ì…˜ ìƒì„±/í•´ì œ, ì‹¤í–‰ì„ ê´€ë¦¬.</p>
  </li>
  <li>
    <p>ë‘ ê°€ì§€ ì‹¤í–‰ ë°±ì—”ë“œ ì¤‘ ì„ íƒ</p>

    <ul>
      <li>
        <p>KernelBackend: Jupyter ì»¤ë„ì„ ì„¸ì…˜ ë‹¨ìœ„ë¡œ ìœ ì§€. ì²« ì…€ì—ì„œ Landlock + ê°€ë²¼ìš´ ê°€ë“œ ì£¼ì….</p>
      </li>
      <li>
        <p>SubprocessBackend: ê°€ë²¼ìš´ 1íšŒì„± í˜¹ì€ ìœ ì§€í˜• ì„œë¸Œí”„ë¡œì„¸ìŠ¤(JSON-RPC) ë°±ì—”ë“œ.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>íˆ´ ì„¸íŠ¸</p>

    <ul>
      <li>
        <p>configure_python_exec(readwrite_dirs, readonly_dirs)</p>
      </li>
      <li>
        <p>start_python_session(agent_id, backend, keep_alive, idle_timeout_sec)</p>
      </li>
      <li>
        <p>python_execute(code, session_id?, backend?, ephemeral?)</p>
      </li>
      <li>
        <p>copy_to_sandbox(source, dest_rel?)</p>
      </li>
    </ul>
  </li>
</ul>

<h1 id="1ë‹¨ê³„-íˆ´-config-ë‹¨ê³„">1ë‹¨ê³„. íˆ´ Config ë‹¨ê³„</h1>

<p>ìš”êµ¬ì‚¬í•­: ì´ ë‹¨ê³„ì—ì„œ Landlockìœ¼ë¡œ â€œì“°ê¸° ê°€ëŠ¥ í´ë”â€ì™€ â€œì½ê¸° ì „ìš© í´ë”â€ë¥¼ ì§€ì •í•´ë‘”ë‹¤. ì‹¤ì œ Landlock ì ìš©ì€ ê° ì„¸ì…˜ í”„ë¡œì„¸ìŠ¤ê°€ ëœ¨ê³  ì‚¬ìš©ì ì½”ë“œê°€ ëŒê¸° ì „ì— ìˆ˜í–‰ëœë‹¤.</p>

<p>ê¸°ëŠ¥ ìš”ì•½</p>

<ul>
  <li>
    <p>ì½ê¸° ì „ìš© ë””ë ‰í„°ë¦¬: READ_FILE/READ_DIR(+EXECUTE ì„ íƒ)ë§Œ í—ˆìš©.</p>
  </li>
  <li>
    <p>ì“°ê¸° ê°€ëŠ¥ ë””ë ‰í„°ë¦¬: READ_DIR + WRITE_FILE + MAKE_* + REMOVE_* (+TRUNCATE/REFERì€ ABI ì§€ì› ì‹œ) í—ˆìš©.</p>
  </li>
  <li>
    <p>Linuxê°€ ì•„ë‹ˆê±°ë‚˜ Landlock ë¯¸íƒ‘ì¬ë©´ ì†Œí”„íŠ¸ ê°€ë“œ(audit hook)ë§Œ ì¼ ë‹¤.</p>
  </li>
</ul>

<p>íˆ´ ìŠ¤í™(LLMì— ë“±ë¡í•  JSON, OpenAI Agents SDK/Function calling ì–‘ì‹ ì˜ˆ)</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"function"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"function"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"configure_python_exec"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ìƒŒë“œë°•ìŠ¤ ì •ì±…ì„ ì„¤ì •í•œë‹¤. ì½ê¸°/ì“°ê¸° í´ë”ë¥¼ ì§€ì •í•˜ê³  ì´í›„ ì„¸ì…˜ì— ì ìš©ëœë‹¤."</span><span class="p">,</span><span class="w">
    </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"readwrite_dirs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w"> </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"readonly_dirs"</span><span class="p">:</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w"> </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"sandbox_dir"</span><span class="p">:</span><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ì“°ê¸° ê¸°ë³¸ ë£¨íŠ¸(ìƒŒë“œë°•ìŠ¤). ìƒëµ ì‹œ ë‚´ë¶€ ê¸°ë³¸ê°’ ì‚¬ìš©"</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"readwrite_dirs"</span><span class="p">,</span><span class="w"> </span><span class="s2">"readonly_dirs"</span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>íŒŒì´ì¬ ìµœì†Œ êµ¬í˜„(ì •ì±… ì €ì¥ë§Œ, ì‹¤ì œ ì ìš©ì€ ì„¸ì…˜ì´ ì¼œì§ˆ ë•Œ)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SandboxPolicy</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">rw</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ro</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">sandbox_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">readwrite_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">rw</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">readonly_dirs</span>  <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ro</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">sandbox_dir</span>    <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">sandbox_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">sandbox_dir</span> <span class="k">else</span> <span class="sh">"</span><span class="s">/mnt/sandbox</span><span class="sh">"</span>

<span class="k">class</span> <span class="nc">PythonExecManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">policy</span><span class="p">:</span> <span class="n">SandboxPolicy</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">sessions</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="sh">"</span><span class="s">BaseSession</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">rw</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ro</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">sandbox_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">sandbox_dir</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">/mnt/sandbox</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="nc">SandboxPolicy</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">ro</span><span class="p">,</span> <span class="n">sandbox_dir</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">sandbox_dir</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">policy</span><span class="p">.</span><span class="n">sandbox_dir</span><span class="p">}</span>
</code></pre></div></div>

<h1 id="2ë‹¨ê³„-llmì—ê²Œ-íˆ´-ì‚¬ìš©ë²•-ì „ë‹¬-ë‹¨ê³„">2ë‹¨ê³„. â€œLLMì—ê²Œ íˆ´ ì‚¬ìš©ë²•â€ ì „ë‹¬ ë‹¨ê³„</h1>

<p>ì‹œìŠ¤í…œ/ê°œë°œì ì§€ì¹¨ì— ë„£ì„ í•µì‹¬ ê·œì¹™</p>

<ul>
  <li>
    <p>íŒŒì¼ì„ ì“°ê±°ë‚˜ ìƒì„±í•˜ë ¤ë©´ ë¨¼ì € copy_to_sandboxë¥¼ í˜¸ì¶œí•´ ìƒŒë“œë°•ìŠ¤ ì•ˆìœ¼ë¡œ ê°€ì ¸ì˜¬ ê²ƒ.</p>
  </li>
  <li>
    <p>ì„¸ì…˜ì´ í•„ìš”í•˜ë©´ start_python_sessionì„ ë¨¼ì € í˜¸ì¶œí•˜ê³  ë°˜í™˜ëœ session_idë¥¼ python_executeì— ë„˜ê²¨ë¼.</p>
  </li>
  <li>
    <p>1íšŒì„± ì‹¤í–‰ì€ session_id ì—†ì´ python_execute(ephemeral=true, backend=â€¦)ë¡œ í˜¸ì¶œí•´ë¼.</p>
  </li>
  <li>
    <p>ê²½ë¡œë¥¼ ì œì‹œí•  ë•ŒëŠ” ìƒŒë“œë°•ìŠ¤ ë‚´ë¶€ ê²½ë¡œë¥¼ ìš°ì„  ì‚¬ìš©í•´ë¼. ì“°ê¸° ì‹œë„ëŠ” ìƒŒë“œë°•ìŠ¤ ë°–ì—ì„œ ì‹¤íŒ¨í•œë‹¤.</p>
  </li>
</ul>

<p>LLMìš© íˆ´ ìŠ¤í™</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"function"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"function"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"start_python_session"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"íŒŒì´ì¬ ì‹¤í–‰ ì„¸ì…˜ì„ ì—°ë‹¤(ì»¤ë„ ë˜ëŠ” ì„œë¸Œí”„ë¡œì„¸ìŠ¤ ë°±ì—”ë“œ)."</span><span class="p">,</span><span class="w">
    </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"agent_id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ì—ì´ì „íŠ¸/ìŠ¤ë ˆë“œ ì‹ë³„ì"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"backend"</span><span class="p">:</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"enum"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"kernel"</span><span class="p">,</span><span class="w"> </span><span class="s2">"subprocess"</span><span class="p">],</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="s2">"kernel"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"keep_alive"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boolean"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"idle_timeout_sec"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="mi">600</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"agent_id"</span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"function"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"function"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"python_execute"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"íŒŒì´ì¬ ì½”ë“œë¥¼ ì‹¤í–‰í•œë‹¤. ì„¸ì…˜ ìœ ì§€ ë˜ëŠ” 1íšŒì„±(ephemeral) ì‹¤í–‰ ëª¨ë‘ ì§€ì›."</span><span class="p">,</span><span class="w">
    </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"code"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"session_id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ìœ ì§€í˜• ì„¸ì…˜ ì‹¤í–‰ ì‹œ í•„ìš”"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"backend"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"enum"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"kernel"</span><span class="p">,</span><span class="w"> </span><span class="s2">"subprocess"</span><span class="p">]</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"ephemeral"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boolean"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"timeout_sec"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"visible_mode"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boolean"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"code"</span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"function"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"function"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"copy_to_sandbox"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"í˜¸ìŠ¤íŠ¸ ê²½ë¡œì—ì„œ íŒŒì¼/í´ë”ë¥¼ ìƒŒë“œë°•ìŠ¤ë¡œ ë³µì‚¬í•œë‹¤."</span><span class="p">,</span><span class="w">
    </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="nl">"dest_rel"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ìƒŒë“œë°•ìŠ¤ ë‚´ë¶€ ìƒëŒ€ê²½ë¡œ"</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"source"</span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>LLMì—ê²Œ ì£¼ëŠ” ê°„ë‹¨ ì§€ì¹¨ í…ìŠ¤íŠ¸</p>

<ul>
  <li>
    <p>ë¶„ì„ì— ì“¸ íŒŒì¼ì€ ë¨¼ì € copy_to_sandboxë¡œ ê°€ì ¸ì™€ë¼.</p>
  </li>
  <li>
    <p>í”Œë¡¯/íŒŒì¼ ì €ì¥ì€ í•­ìƒ ${SANDBOX_DIR} ì•ˆìœ¼ë¡œ ì €ì¥í•˜ë¼.</p>
  </li>
  <li>
    <p>ì—¬ëŸ¬ ë²ˆ ì‹¤í–‰Â·ìƒíƒœ ìœ ì§€ê°€ í•„ìš”í•˜ë©´ start_python_session â†’ python_execute(session_id=â€¦).</p>
  </li>
  <li>
    <p>í•œ ë²ˆë§Œ ëŒë¦´ ê±°ë©´ python_execute(ephemeral=true, backend="subprocess")ë¡œ í˜¸ì¶œí•˜ë¼.</p>
  </li>
</ul>

<h1 id="3ë‹¨ê³„-ì‹¤ì œ-ì‚¬ìš©-ë‹¨ê³„-ì„¤ê³„">3ë‹¨ê³„. ì‹¤ì œ ì‚¬ìš© ë‹¨ê³„ ì„¤ê³„</h1>

<p>A. ìœ ì§€í˜• ì„¸ì…˜ íë¦„(ì˜ˆ: ì—ì´ì „íŠ¸ë³„ ìƒíƒœ ìœ ì§€)</p>

<ol>
  <li>
    <p>configure_python_exec í˜¸ì¶œë¡œ ì •ì±… ë“±ë¡</p>
  </li>
  <li>
    <p>start_python_session(agent_id="agent-A", backend="kernel", keep_alive=true)</p>
  </li>
  <li>
    <p>copy_to_sandbox í•„ìš” ì‹œ í˜¸ì¶œ</p>
  </li>
  <li>
    <p>python_execute(session_id=â€¦, code=â€¦)</p>
  </li>
  <li>
    <p>í•„ìš” ì‹œ ê°™ì€ session_idë¡œ ì—°ì† ì‹¤í–‰</p>
  </li>
  <li>
    <p>ì•„ì´ë“¤ íƒ€ì„ì•„ì›ƒ ì´ˆê³¼ ì‹œ ì„¸ì…˜ ìë™ ì¢…ë£Œ</p>
  </li>
</ol>

<p>B. 1íšŒì„± ì‹¤í–‰ íë¦„</p>

<ol>
  <li>
    <p>configure_python_exec í˜¸ì¶œ(ì•± ì‹œì‘ ì‹œ 1íšŒ í•´ë„ ë¨)</p>
  </li>
  <li>
    <p>python_execute(ephemeral=true, backend="subprocess", code=â€¦)</p>
  </li>
</ol>

<p>ì´ì›í™” ì´ìœ </p>

<ul>
  <li>
    <p>kernelì€ í’ë¶€í•œ ê³¼í•™ ìŠ¤íƒ/ìƒíƒœ ìœ ì§€ì— ê°•í•¨</p>
  </li>
  <li>
    <p>subprocessëŠ” ê¸°ë™ì´ ë¹ ë¥´ê³ , ì¼íšŒì„± ì½”ë“œì— ì í•©</p>
  </li>
</ul>

<h1 id="ì„¸ì…˜-ë°±ì—”ë“œ-êµ¬í˜„-í•µì‹¬">ì„¸ì…˜ ë°±ì—”ë“œ êµ¬í˜„ í•µì‹¬</h1>

<p>Landlock ì ìš© ì „ëµ</p>

<ul>
  <li>
    <p>ì‹¤ì œ ì œì•½ì€ â€œê° ì„¸ì…˜ í”„ë¡œì„¸ìŠ¤ ë‚´ë¶€â€ì—ì„œ ê±¸ì–´ì•¼ í•œë‹¤.</p>
  </li>
  <li>
    <p>KernelBackend: ì»¤ë„ ì‹œì‘ í›„ ì²« ì‹¤í–‰ ì…€ì—ì„œ Landlockì„ ì ìš©í•˜ê³ , ì´ì–´ì„œ audit hook(ì†Œí”„íŠ¸ ê°€ë“œ)ë„ ì£¼ì….</p>
  </li>
  <li>
    <p>SubprocessBackend: ìì‹ í”„ë¡œì„¸ìŠ¤ê°€ ëœ¨ìë§ˆì Landlockì„ restrict_self()ë¡œ ì ìš©í•œ í›„ JSON-RPC ë£¨í”„ ì§„ì….</p>
  </li>
</ul>

<p>ê¶Œí•œ ë§ˆìŠ¤í¬ êµ¬ì„±(ABI ì°¨ì´ ì•ˆì „ ì²˜ë¦¬)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">build_access_mask</span><span class="p">():</span>
    <span class="kn">import</span> <span class="n">landlock</span>
    <span class="kn">from</span> <span class="n">landlock</span> <span class="kn">import</span> <span class="n">AccessFs</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">READ_FILE</span> <span class="o">|</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">READ_DIR</span>
    <span class="c1"># ì½ê¸°/ì‹¤í–‰ í•„ìš” ì‹œ
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">acc</span> <span class="o">|=</span> <span class="n">AccessFs</span><span class="p">.</span><span class="n">EXECUTE</span>
    <span class="k">except</span> <span class="nb">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">acc</span>

<span class="k">def</span> <span class="nf">build_write_mask</span><span class="p">():</span>
    <span class="kn">from</span> <span class="n">landlock</span> <span class="kn">import</span> <span class="n">AccessFs</span>
    <span class="n">perms</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sh">"</span><span class="s">WRITE_FILE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">REMOVE_FILE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">REMOVE_DIR</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">MAKE_CHAR</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">MAKE_DIR</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">MAKE_REG</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">MAKE_SOCK</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">MAKE_FIFO</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">MAKE_BLOCK</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">MAKE_SYM</span><span class="sh">"</span>
    <span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">perms</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">|=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">AccessFs</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># ABI v2+: REFER, v3+: TRUNCATE ë“±ì€ ìˆìœ¼ë©´ ì¶”ê°€
</span>    <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">REFER</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">TRUNCATE</span><span class="sh">"</span><span class="p">]:</span>
        <span class="n">m</span> <span class="o">|=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">AccessFs</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># ë””ë ‰í„°ë¦¬ íŠ¸ë˜ë²„ìŠ¤ í—ˆìš©
</span>    <span class="n">m</span> <span class="o">|=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">AccessFs</span><span class="p">,</span> <span class="sh">"</span><span class="s">READ_DIR</span><span class="sh">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span>
</code></pre></div></div>

<p>KernelBackend ì´ˆê¸°í™” ì½”ë“œ ìŠ¤ì¼€ì¹˜</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AUDIT_GUARD</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os, sys
SBOX = os.path.realpath(os.environ.get(</span><span class="sh">'</span><span class="s">SANDBOX_DIR</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">/mnt/sandbox</span><span class="sh">'</span><span class="s">))
os.makedirs(SBOX, exist_ok=True)
def _in_sb(p): import os; rp=os.path.realpath(p); return rp==SBOX or rp.startswith(SBOX+os.sep)
def _audit(ev, args):
    if ev == </span><span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="s">:
        path = str(args[0]); mode = str(args[1]) if len(args)&gt;1 else </span><span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="s">
        flags = int(args[2]) if len(args)&gt;2 else 0
        wr = any(ch in mode for ch in (</span><span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">a</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">+</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="s">)) or (flags &amp; (os.O_WRONLY|os.O_RDWR|os.O_CREAT|os.O_TRUNC|os.O_APPEND))
        if wr and not _in_sb(path): raise PermissionError(f</span><span class="sh">'</span><span class="s">Writes restricted to {SBOX}: {path}</span><span class="sh">'</span><span class="s">)
    elif ev.startswith(</span><span class="sh">'</span><span class="s">subprocess.</span><span class="sh">'</span><span class="s">) or ev==</span><span class="sh">'</span><span class="s">os.system</span><span class="sh">'</span><span class="s">: raise PermissionError(</span><span class="sh">'</span><span class="s">Subprocess disabled</span><span class="sh">'</span><span class="s">)
sys.addaudithook(_audit)
</span><span class="sh">"""</span>

<span class="n">LANDLOCK_INIT</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os
SANDBOX_DIR = os.environ.get(</span><span class="sh">'</span><span class="s">SANDBOX_DIR</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">/mnt/sandbox</span><span class="sh">'</span><span class="s">)
try:
    import landlock
    from landlock import Ruleset, PathBeneath
    from landlock import AccessFs as A
    rw_dirs = os.environ.get(</span><span class="sh">'</span><span class="s">LL_RW_DIRS</span><span class="sh">'</span><span class="s">,</span><span class="sh">''</span><span class="s">).split(os.pathsep) if os.environ.get(</span><span class="sh">'</span><span class="s">LL_RW_DIRS</span><span class="sh">'</span><span class="s">) else []
    ro_dirs = os.environ.get(</span><span class="sh">'</span><span class="s">LL_RO_DIRS</span><span class="sh">'</span><span class="s">,</span><span class="sh">''</span><span class="s">).split(os.pathsep) if os.environ.get(</span><span class="sh">'</span><span class="s">LL_RO_DIRS</span><span class="sh">'</span><span class="s">) else []
    handled = 0
    for name in dir(A):
        if name.isupper():
            handled |= getattr(A, name)
    rs = Ruleset(handled_access_fs=handled)
    write_mask = 0
    for n in (</span><span class="sh">'</span><span class="s">WRITE_FILE</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">REMOVE_FILE</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">REMOVE_DIR</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">MAKE_DIR</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">MAKE_REG</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">MAKE_SYM</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">REFER</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">TRUNCATE</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">READ_DIR</span><span class="sh">'</span><span class="s">):
        write_mask |= getattr(A, n, 0)
    read_mask = getattr(A,</span><span class="sh">'</span><span class="s">READ_FILE</span><span class="sh">'</span><span class="s">,0) | getattr(A,</span><span class="sh">'</span><span class="s">READ_DIR</span><span class="sh">'</span><span class="s">,0) | getattr(A,</span><span class="sh">'</span><span class="s">EXECUTE</span><span class="sh">'</span><span class="s">,0)
    for d in ro_dirs:
        if d: rs.add_rule(PathBeneath(d, read_mask))
    for d in rw_dirs + [SANDBOX_DIR]:
        if d: rs.add_rule(PathBeneath(d, write_mask | read_mask))
    rs.restrict_self()
    print(</span><span class="sh">'</span><span class="s">[landlock] active</span><span class="sh">'</span><span class="s">)
except Exception as e:
    print(</span><span class="sh">'</span><span class="s">[landlock] unavailable:</span><span class="sh">'</span><span class="s">, e)
</span><span class="sh">"""</span>

<span class="k">class</span> <span class="nc">KernelBackendSession</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">SandboxPolicy</span><span class="p">):</span>
        <span class="kn">from</span> <span class="n">jupyter_client</span> <span class="kn">import</span> <span class="n">KernelManager</span>
        <span class="n">self</span><span class="p">.</span><span class="n">km</span> <span class="o">=</span> <span class="nc">KernelManager</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">start_kernel</span><span class="p">(</span><span class="n">extra_arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">--HistoryManager.enabled=False</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">kc</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">client</span><span class="p">();</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">start_channels</span><span class="p">()</span>
        <span class="c1"># ì •ì±… ì „ë‹¬ ë° ì´ˆê¸° ê°€ë“œ/ëœë“œë½ ì£¼ì…
</span>        <span class="n">env</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">import os; os.environ[</span><span class="sh">'</span><span class="s">SANDBOX_DIR</span><span class="sh">'</span><span class="s">]=</span><span class="si">{</span><span class="n">policy</span><span class="p">.</span><span class="n">sandbox_dir</span><span class="si">!r}</span><span class="s">;</span><span class="sh">"</span> \
              <span class="sa">f</span><span class="sh">"</span><span class="s">os.environ[</span><span class="sh">'</span><span class="s">LL_RW_DIRS</span><span class="sh">'</span><span class="s">]=</span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">pathsep</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">policy</span><span class="p">.</span><span class="n">readwrite_dirs</span><span class="p">)</span><span class="si">!r}</span><span class="s">;</span><span class="sh">"</span> \
              <span class="sa">f</span><span class="sh">"</span><span class="s">os.environ[</span><span class="sh">'</span><span class="s">LL_RO_DIRS</span><span class="sh">'</span><span class="s">]=</span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">pathsep</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">policy</span><span class="p">.</span><span class="n">readonly_dirs</span><span class="p">)</span><span class="si">!r}</span><span class="sh">"</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_exec</span><span class="p">(</span><span class="n">env</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="n">LANDLOCK_INIT</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="n">AUDIT_GUARD</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_exec</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span>
        <span class="n">msg_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">allow_stdin</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">stop_on_error</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1"># â€¦ (iopub ìˆ˜ì§‘/timeout ì²˜ë¦¬ëŠ” ìƒëµ)
</span></code></pre></div></div>

<p>SubprocessBackend ì´ˆê¸°í™” ì½”ë“œ ìŠ¤ì¼€ì¹˜</p>

<ul>
  <li>ìì‹ì´ ë¶€íŒ…í•˜ìë§ˆì Landlock ì ìš© í›„ stdinìœ¼ë¡œ ë“¤ì–´ì˜¤ëŠ” JSON ëª…ë ¹ì„ ì‹¤í–‰</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SUBPROCESS_BOOT</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import sys, os, json
SANDBOX_DIR = os.environ.get(</span><span class="sh">'</span><span class="s">SANDBOX_DIR</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">/mnt/sandbox</span><span class="sh">'</span><span class="s">)
def apply_ll():
    try:
        import landlock
        from landlock import Ruleset, PathBeneath
        from landlock import AccessFs as A
        handled = 0
        for n in dir(A):
            if n.isupper(): handled |= getattr(A,n)
        rs = Ruleset(handled_access_fs=handled)
        rw = os.environ.get(</span><span class="sh">'</span><span class="s">LL_RW_DIRS</span><span class="sh">'</span><span class="s">,</span><span class="sh">''</span><span class="s">).split(os.pathsep) if os.environ.get(</span><span class="sh">'</span><span class="s">LL_RW_DIRS</span><span class="sh">'</span><span class="s">) else []
        ro = os.environ.get(</span><span class="sh">'</span><span class="s">LL_RO_DIRS</span><span class="sh">'</span><span class="s">,</span><span class="sh">''</span><span class="s">).split(os.pathsep) if os.environ.get(</span><span class="sh">'</span><span class="s">LL_RO_DIRS</span><span class="sh">'</span><span class="s">) else []
        wm = getattr(A,</span><span class="sh">'</span><span class="s">READ_DIR</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">WRITE_FILE</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">MAKE_DIR</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">MAKE_REG</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">REMOVE_FILE</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">REMOVE_DIR</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">REFER</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">TRUNCATE</span><span class="sh">'</span><span class="s">,0)
        rm = getattr(A,</span><span class="sh">'</span><span class="s">READ_FILE</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">READ_DIR</span><span class="sh">'</span><span class="s">,0)|getattr(A,</span><span class="sh">'</span><span class="s">EXECUTE</span><span class="sh">'</span><span class="s">,0)
        for d in ro: 
            if d: rs.add_rule(PathBeneath(d, rm))
        for d in rw+[SANDBOX_DIR]:
            if d: rs.add_rule(PathBeneath(d, rm|wm))
        rs.restrict_self()
    except Exception as e:
        print(</span><span class="sh">'</span><span class="s">[landlock] unavailable:</span><span class="sh">'</span><span class="s">, e, file=sys.stderr)
def loop():
    apply_ll()
    while True:
        line = sys.stdin.readline()
        if not line: break
        req = json.loads(line)
        code = req.get(</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="s">,</span><span class="sh">""</span><span class="s">)
        g = {}
        try:
            exec(code, g, g)
            print(json.dumps({</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="s">: True, </span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="s">: </span><span class="sh">""</span><span class="s">}))
        except Exception as e:
            print(json.dumps({</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="s">: False, </span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="s">: str(e)}))
        sys.stdout.flush()
loop()
</span><span class="sh">"""</span>
</code></pre></div></div>

<h1 id="copy_to_sandbox-êµ¬í˜„-ë©”ëª¨">copy_to_sandbox êµ¬í˜„ ë©”ëª¨</h1>

<ul>
  <li>
    <p>ì‹¬ë³¼ë¦­ ë§í¬ ê±°ë¶€, ëª©ì ì§€ëŠ” ë°˜ë“œì‹œ sandbox_dir í•˜ìœ„ ê²½ë¡œë¡œ ê°•ì œ.</p>
  </li>
  <li>
    <p>ë””ë ‰í„°ë¦¬ ë³µì‚¬ ì‹œ ê¸°ì¡´ ëŒ€ìƒ ì¶©ëŒ ë°©ì§€.</p>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">copy_to_sandbox</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dest_rel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">SandboxPolicy</span><span class="p">):</span>
    <span class="kn">import</span> <span class="n">shutil</span><span class="p">,</span> <span class="n">stat</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">src</span><span class="p">):</span> <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">not found</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">islink</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">symlink not allowed</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">policy</span><span class="p">.</span><span class="n">sandbox_dir</span><span class="p">,</span> <span class="n">dest_rel</span> <span class="ow">or</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dst</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">policy</span><span class="p">.</span><span class="n">sandbox_dir</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dst</span> <span class="o">!=</span> <span class="n">policy</span><span class="p">.</span><span class="n">sandbox_dir</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">destination must be inside sandbox</span><span class="sh">"</span><span class="p">}</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">dst</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span> <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dest exists</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">shutil</span><span class="p">.</span><span class="nf">copytree</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">copy_function</span><span class="o">=</span><span class="n">shutil</span><span class="p">.</span><span class="n">copy2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shutil</span><span class="p">.</span><span class="nf">copy2</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="nf">chmod</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IRUSR</span><span class="o">|</span><span class="n">stat</span><span class="p">.</span><span class="n">S_IWUSR</span><span class="o">|</span><span class="n">stat</span><span class="p">.</span><span class="n">S_IRGRP</span><span class="o">|</span><span class="n">stat</span><span class="p">.</span><span class="n">S_IROTH</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">sandbox_path</span><span class="sh">"</span><span class="p">:</span> <span class="n">dst</span><span class="p">}</span>
</code></pre></div></div>

<h1 id="ì‹¤í–‰-ë‹¨ê³„-ì˜ˆì‹œ-ì‹œí€€ìŠ¤">ì‹¤í–‰ ë‹¨ê³„ ì˜ˆì‹œ ì‹œí€€ìŠ¤</h1>

<p>ìœ ì§€í˜•(ì»¤ë„) ì˜ˆì‹œ</p>

<ol>
  <li>
    <p>configure_python_exec(readwrite_dirs=["/mnt/sandbox"], readonly_dirs=["/","/usr","/home/you/data"])</p>
  </li>
  <li>
    <p>start_python_session(agent_id="analyst-1", backend="kernel", keep_alive=true)</p>
  </li>
  <li>
    <p>copy_to_sandbox("/home/you/data/df.csv", "data/df.csv")</p>
  </li>
  <li>
    <p>python_execute(session_id="sess-analyst-1", code='import pandas as pd; df=pd.read_csv("data/df.csv"); print(df.shape)')</p>
  </li>
  <li>
    <p>ê°™ì€ session_idë¡œ ê³„ì† ì‹¤í–‰</p>
  </li>
</ol>

<p>1íšŒì„±(ì„œë¸Œí”„ë¡œì„¸ìŠ¤) ì˜ˆì‹œ</p>

<ol>
  <li>
    <p>configure_python_exec(â€¦)</p>
  </li>
  <li>
    <p>python_execute(ephemeral=true, backend="subprocess", code='open("/etc/hosts","w").write("x")') â†’ ì»¤ë„ì´ ê±°ë¶€</p>
  </li>
  <li>
    <p>python_execute(ephemeral=true, backend="subprocess", code='print("ok")') â†’ ì •ìƒ</p>
  </li>
</ol>

<h1 id="ì„¤ê³„-ì„ íƒ-ì´ìœ ì™€-í•œê³„">ì„¤ê³„ ì„ íƒ ì´ìœ ì™€ í•œê³„</h1>

<ul>
  <li>
    <p>Landlockì€ ì»¤ë„ì´ ê°•ì œí•˜ëŠ” ì¼ë°©í–¥ ì œì•½ì´ë¼ í•œ ë²ˆ ì ìš©í•˜ë©´ ì‚¬ìš©ì íŒŒì´ì¬ì´ â€œí•´ì œâ€í•˜ì§„ ëª»í•œë‹¤. ë‹¤ë§Œ OSê°€ Linux 5.13+ì—¬ì•¼ í•˜ë©°, ABI ê¸°ëŠ¥(TRUNCATE/REFER ë“±)ì€ ë²„ì „ì— ë”°ë¼ ë‹¤ë¥´ë‹¤. ìœ„ ì½”ë“œëŠ” â€œê°€ëŠ¥í•˜ë©´ ì“°ê³ , ì—†ìœ¼ë©´ ê±´ë„ˆë›°ëŠ”â€ ë² ìŠ¤íŠ¸ì—í¬íŠ¸ ë°©ì‹ìœ¼ë¡œ êµ¬ì„±.</p>
  </li>
  <li>
    <p>ì™„ë²½í•œ ê²©ë¦¬ëŠ” ì•„ë‹ˆì§€ë§Œ, ì‹¤ìˆ˜ë¡œ í˜¸ìŠ¤íŠ¸ë¥¼ ë”ëŸ½íˆëŠ” ê²½ë¡œë¥¼ íš¨ê³¼ì ìœ¼ë¡œ ì°¨ë‹¨í•œë‹¤. ì¶”ê°€ë¡œ audit hookê³¼ ë¦¬ì†ŒìŠ¤ ì œí•œ(CPU/ë©”ëª¨ë¦¬/íŒŒì¼ì‚¬ì´ì¦ˆ)ì„ ê³ë“¤ì´ë©´ 80/20 ëª©ì ì— ì¶©ë¶„íˆ ì‹¤ìš©ì .</p>
  </li>
</ul>

<p>ì›í•˜ë©´ ì—¬ê¸°ì— ë°”ë¡œ ë¶™ì—¬ ì“¸ ìˆ˜ ìˆëŠ” ì™„ì„±í˜• ëª¨ë“ˆ(Manager + ë‘ ë°±ì—”ë“œ + ìµœì†Œ RPC ë£¨í”„)ë¡œ ë¬¶ì–´ì„œ ë“œë¦´ ìˆ˜ ìˆë‹¤.</p>

<p class="chat--user">

landlock íŒ¨í‚¤ì§€ì— PathBeneathë¼ëŠ” ê²Œ ì—†ëŒ€. ê·¸ë¦¬ê³  ConfigëŠ” ìœ ì €ê°€ ì§ì ‘í• ê±°ë¼ LLMìœ¼ë¡œëŠ” ë…¸ì¶œ ê¸ˆì§€

</p>

<p>ì¢‹ì•„. ì •ë¦¬ë¶€í„° í•˜ê³ , ë°”ë¡œ ê°€ì ¸ë‹¤ ì“¸ ìˆ˜ ìˆëŠ” ì½”ë“œì™€ ì„¤ê³„ë¥¼ ê¹”ë”íˆ ë°”ê¿”ì„œ ì¤„ê²Œ. í•µì‹¬ì€ â€œì„¤ì •(Config)ì€ ë„¤ê°€ ì§ì ‘, LLMì—ê² ì ˆëŒ€ ë…¸ì¶œí•˜ì§€ ì•ŠìŒâ€, â€œì„¸ì…˜ ìœ ì§€ ì„ íƒ ê°€ëŠ¥â€, â€œíŒŒì¼ ì‹œìŠ¤í…œì€ Landlockìœ¼ë¡œ ì½ê¸°/ì“°ê¸° ê²½ê³„â€ì•¼. ê·¸ë¦¬ê³  ë„¤ê°€ ì§€ì í•œ ëŒ€ë¡œ PyPIì˜ landlock íŒ¨í‚¤ì§€ëŠ” PathBeneath í´ë˜ìŠ¤ë¥¼ ì•ˆ ì“°ê³  Ruleset ì¤‘ì‹¬ì˜ APIë¼ì„œ, ê·¸ì— ë§ì¶° ì—…ë°ì´íŠ¸í–ˆì–´. Landlockì˜ ì›ë¦¬ëŠ” ì»¤ë„ ë ˆë²¨ì—ì„œ í•œ ë²ˆ ì ìš©í•˜ë©´ í˜¸ì¶œ ìŠ¤ë ˆë“œì™€ ìì‹ì—ê²Œ ì˜êµ¬ì ìœ¼ë¡œ ëˆ„ì ë˜ëŠ” ì¼ë°©í–¥ ì œì•½ì´ì•¼. ì‚¬ìš©ì ê³µê°„ì—ì„œ ì„ì˜ë¡œ í•´ì œí•  ìˆ˜ ì—†ë„ë¡ ì„¤ê³„ë˜ì–´ ìˆì–´(ì»¤ë„ ì‚¬ìš©ìê³µê°„ API/ë§¤ë‰´ì–¼ì— ëª…ì‹œ, ê·¸ë¦¬ê³  ìµœê·¼ ì›Œí¬ìˆ ìë£Œì—ë„ â€œí•œ ë²ˆ ì¼œë©´ ëŒ ìˆ˜ ì—†ë‹¤â€ëŠ” ì›ì¹™ì´ ë°˜ë³µë¨). <a href="https://man7.org/linux/man-pages/man7/landlock.7.html?utm_source=chatgpt.com">man7.org+2</a></p>

<p>ì•„ë˜ëŠ” 3ë‹¨ê³„ ë¶„ë¦¬ ì„¤ê³„ì™€ ì½”ë“œ ìŠ¤ì¼ˆë ˆí†¤ì´ì•¼.</p>

<h1 id="1-íˆ´-config-ë‹¨ê³„í˜¸ìŠ¤íŠ¸-ì „ìš©llm-ë¹„ë…¸ì¶œ">1) íˆ´ Config ë‹¨ê³„(í˜¸ìŠ¤íŠ¸ ì „ìš©Â·LLM ë¹„ë…¸ì¶œ)</h1>

<p>ConfigëŠ” ë„¤ ì½”ë“œì—ì„œë§Œ ì‹¤í–‰. LLMì€ ëª¨ë¥´ê²Œ ìœ ì§€.</p>

<p>ê¸°ëŠ¥</p>

<ol>
  <li>
    <p>ì½ê¸° ì „ìš© ê²½ë¡œ ëª©ë¡(ro_roots), ì½ê¸°/ì“°ê¸° í—ˆìš© ë£¨íŠ¸(rw_root í•œ ê°œ ì¶”ì²œ)ë¥¼ ì§€ì •.</p>
  </li>
  <li>
    <p>Landlockì„ í˜„ì¬ í”„ë¡œì„¸ìŠ¤ì— ì ìš©í•˜ê³ , ì´í›„ ìƒˆë¡œ ë§Œë“œëŠ” ì»¤ë„/ì„œë¸Œí”„ë¡œì„¸ìŠ¤ì—ë„ ìƒì†.</p>
  </li>
  <li>
    <p>ì„¸ì…˜ í’€ ìƒì„±(ì—ì´ì „íŠ¸ë³„ ì„¸ì…˜ ìœ ì§€ìš©).</p>
  </li>
</ol>

<p>landlock íŒ¨í‚¤ì§€ì˜ ê³µê°œ ë¬¸ì„œ ê¸°ì¤€ìœ¼ë¡œëŠ” Ruleset().allow(path)ë¡œ ê²½ë¡œ í•˜ìœ„ ì ‘ê·¼ì„ í—ˆìš©í•˜ê³  apply()ë¡œ ì ìš©í•˜ëŠ” í˜•íƒœì•¼. ì´ íŒ¨í‚¤ì§€ëŠ” PathBeneathë¥¼ ë…¸ì¶œí•˜ì§€ ì•Šê³  ê³ ìˆ˜ì¤€ APIë¥¼ ì œê³µí•´. ì˜ˆì‹œì—ì„œ â€œê¸°ë³¸ì€ ì „ë¶€ ì°¨ë‹¨, allowë¡œ ëª…ì‹œí•œ ê²½ë¡œë§Œ í—ˆìš©â€ ëª¨ë¸ì´ë¯€ë¡œ, ì½ê¸° í—ˆìš© ë£¨íŠ¸ëŠ” ëª¨ë‘ allowë¡œ ë„£ê³ , ì“°ê¸°ê°€ í•„ìš”í•œ ë””ë ‰í„°ë¦¬ëŠ” ë³„ë„ë¡œ ê´€ë¦¬í•˜ëŠ” ê²Œ ì•ˆì „í•´. ì“°ê¸° ê¶Œí•œì˜ ì„¸ë°€í•œ ë¹„íŠ¸ ì§€ì •ì€ ì»¤ë„ì€ ì§€ì›í•˜ì§€ë§Œ(ì˜ˆ: READ_DIR/READ_FILE/WRITE/TRUNCATE ë“±), ì´ íŒŒì´ì¬ íŒ¨í‚¤ì§€ì—ì„œ ê²½ë¡œë³„ ê¶Œí•œ ë¹„íŠ¸ë¥¼ ì§ì ‘ ë…¸ì¶œí•˜ì§€ ì•Šì„ ìˆ˜ ìˆì–´ ë²„ì „ë³„ë¡œ ì°¨ì´ê°€ ë‚œë‹¤. ìµœì‹  PyPI í˜ì´ì§€ë¥¼ ë³´ë©´ ê³ ìˆ˜ì¤€ ì˜ˆì œë§Œ ë¬¸ì„œí™”ë¼ ìˆìœ¼ë‹ˆ ì´ ì ì„ ì „ì œë¡œ ì½”ë“œë¥¼ ì§œê³ , ë§Œì•½ ë„¤ í™˜ê²½ì—ì„œ per-path write í—ˆìš©ì´ í•„ìš”í•˜ë©´ ì•„ë˜ â€œí”Œëœ Bâ€ë¥¼ ì°¸ê³ í•´. <a href="https://pypi.org/project/landlock/">PyPI</a></p>

<p>êµ¬í˜„ ìŠ¤ì¼ˆë ˆí†¤</p>

<ul>
  <li>ì•„ë˜ ëª¨ë“ˆì€ ì„¤ì •ë§Œ ë‹´ë‹¹. LLMì—ê²Œ ì´ ëª¨ë“ˆì˜ ì–´ë–¤ ë‚´ìš©ë„ ì „ë‹¬í•˜ì§€ ë§ˆ.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># sandbox_config.py  (í˜¸ìŠ¤íŠ¸ ì „ìš©, LLM ë¹„ë…¸ì¶œ)
</span><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">shutil</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="n">landlock</span> <span class="kn">import</span> <span class="n">Ruleset</span>  <span class="c1"># PyPI 'landlock' (Edward-Knight)
</span>
<span class="k">class</span> <span class="nc">FsPolicy</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">ro_roots</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">rw_root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">allow_world_read</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="c1"># ì ˆëŒ€ê²½ë¡œ ì •ê·œí™”
</span>        <span class="n">self</span><span class="p">.</span><span class="n">ro_roots</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ro_roots</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">rw_root</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">rw_root</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">allow_world_read</span> <span class="o">=</span> <span class="n">allow_world_read</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">rw_root</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SandboxManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_applied</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">self</span><span class="p">.</span><span class="n">policy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FsPolicy</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">apply_landlock</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">FsPolicy</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_applied</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="nc">Ruleset</span><span class="p">()</span>  <span class="c1"># ê¸°ë³¸: ì „ë¶€ ê¸ˆì§€, allowë¡œë§Œ í—ˆìš©
</span>        <span class="k">if</span> <span class="n">policy</span><span class="p">.</span><span class="n">allow_world_read</span><span class="p">:</span>
            <span class="n">rs</span><span class="p">.</span><span class="nf">allow</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># ëª¨ë“  ê²½ë¡œ ì½ê¸° í—ˆìš©(â€œì™„ë²½í•œ ìƒŒë“œë°•ìŠ¤ ë¶ˆí•„ìš”â€ ìš”êµ¬ì¼ ë•Œ í¸ì˜ìš©)
</span>        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">policy</span><span class="p">.</span><span class="n">ro_roots</span><span class="p">:</span>
                <span class="n">rs</span><span class="p">.</span><span class="nf">allow</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c1"># rw_rootëŠ” LLMì—ê²Œ copy_to_sandbox í†µí•´ì„œë§Œ íŒŒì¼ì„ ë‘ê²Œ í•œë‹¤.
</span>        <span class="c1"># íŒ¨í‚¤ì§€ APIê°€ ê²½ë¡œë³„ ì“°ê¸° ë¹„íŠ¸ë¥¼ ë…¸ì¶œí•˜ì§€ ì•ŠëŠ” ê²½ìš°ê°€ ìˆì–´,
</span>        <span class="c1"># ì“°ê¸°ëŠ” ì›ì¹™ì ìœ¼ë¡œ ì°¨ë‹¨í•˜ê³ , ì»¤ë„ì´ í—ˆìš©í•˜ëŠ” í•œì—ì„œë§Œ rw_root ë‚´ ì¡°ì‘ì„ ì‹œë„í•œë‹¤.
</span>        <span class="c1"># (íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ë¡œ per-path write ì˜µì…˜ì´ ìƒê¸°ë©´ ì—¬ê¸°ì„œ ì¡°ê±´ë¶€ë¡œ í—ˆìš© ì¶”ê°€)
</span>
        <span class="n">rs</span><span class="p">.</span><span class="nf">apply</span><span class="p">()</span>  <span class="c1"># í˜„ì¬ ìŠ¤ë ˆë“œ ë° ìì‹ í”„ë¡œì„¸ìŠ¤ì— ì˜êµ¬ ì ìš©
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_applied</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">self</span><span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">policy</span>

    <span class="c1"># ìœ í‹¸: ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì‚¬ì „ ë³µì‚¬ê¸°(LLMì€ ì´ í•¨ìˆ˜ë¥¼ toolë¡œë§Œ í˜¸ì¶œ)
</span>    <span class="k">def</span> <span class="nf">copy_to_sandbox</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst_relpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">self</span><span class="p">.</span><span class="n">policy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">Sandbox not configured</span><span class="sh">"</span>
        <span class="n">src_abs</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="c1"># ì½ê¸° í—ˆìš© ê²½ë¡œ ê²€ì¦
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">policy</span><span class="p">.</span><span class="n">allow_world_read</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">src_abs</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)</span> <span class="ow">or</span> <span class="n">src_abs</span> <span class="o">==</span> <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">policy</span><span class="p">.</span><span class="n">ro_roots</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Source not allowed: </span><span class="si">{</span><span class="n">src_abs</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">dst_abs</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">policy</span><span class="p">.</span><span class="n">rw_root</span><span class="p">,</span> <span class="n">dst_relpath</span><span class="p">))</span>
        <span class="c1"># rw_root ë°–ìœ¼ë¡œ ë²—ì–´ë‚˜ëŠ” ê²½ë¡œ ê¸ˆì§€
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">dst_abs</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">policy</span><span class="p">.</span><span class="n">rw_root</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)</span> <span class="ow">or</span> <span class="n">dst_abs</span> <span class="o">==</span> <span class="n">self</span><span class="p">.</span><span class="n">policy</span><span class="p">.</span><span class="n">rw_root</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Destination escapes rw_root: </span><span class="si">{</span><span class="n">dst_abs</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">dst_abs</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">shutil</span><span class="p">.</span><span class="nf">copy2</span><span class="p">(</span><span class="n">src_abs</span><span class="p">,</span> <span class="n">dst_abs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dst_abs</span>
</code></pre></div></div>

<p>ì°¸ê³ : Landlockì€ ì¼ë°©í–¥ ì œì•½ì´ë©° restrict_self ì´í›„ í•´ì œê°€ ë¶ˆê°€í•œ íŠ¹ì„±ì´ ê³µì‹ ë¬¸ì„œì™€ ë°œí‘œ ìë£Œì— ë°˜ë³µí•´ì„œ ì„¤ëª…ë¼ ìˆì–´. ì´ êµ¬ì¡° ë•ë¶„ì— â€œíŒŒì´ì¬ ì½”ë“œê°€ ë£°ì…‹ì„ í’€ì–´ë²„ë¦°ë‹¤â€ ë¥˜ì˜ ìš°ë ¤ëŠ” ì •ìƒ ì»¤ë„/ì‚¬ìš©ì ê³µê°„ ì „ì œì—ì„œ í•´ë‹¹ë˜ì§€ ì•Šì•„. ë‹¨, ì»¤ë„ ì·¨ì•½ì ì´ ê³µê°œÂ·íŒ¨ì¹˜ë˜ëŠ” ê²½ìš°ê°€ ê°€ë” ìˆìœ¼ë‹ˆ ì»¤ë„ì„ ìµœì‹ ìœ¼ë¡œ ìœ ì§€í•˜ëŠ” ê²Œ ì¢‹ì•„. ê¸°ëŠ¥ê³¼ ê¶Œí•œ ë¹„íŠ¸ëŠ” ë§¤ë‰´ì–¼ê³¼ ì‚¬ìš©ìê³µê°„ API ë¬¸ì„œì— ì˜ ì •ë¦¬ë¼ ìˆì–´. <a href="https://man7.org/linux/man-pages/man7/landlock.7.html?utm_source=chatgpt.com">man7.org+2</a></p>

<p>í”Œëœ B: ê²½ë¡œë³„ ì“°ê¸° ë¹„íŠ¸ê°€ ê¼­ í•„ìš”í•˜ë©´</p>

<ol>
  <li>
    <p>ìµœê·¼ ì´ìŠˆë¡œ ìœ ëª…í•œ landrun(Go CLI) ê°™ì€ ì–‡ì€ ë˜í¼ë¥¼ ì¨ì„œ â€œâ€“ro /â€¦ â€“rw /sandbox â€¦â€ í˜•íƒœë¡œ ì •í™•íˆ ë¶„ë¦¬í•  ìˆ˜ ìˆì–´. ì»¨í…Œì´ë„ˆë‚˜ ë„ì»¤ëŠ” ì•„ë‹˜. <a href="https://github.com/Zouuup/landrun?utm_source=chatgpt.com">GitHub+2</a></p>
  </li>
  <li>
    <p>ë˜ëŠ” ì•„ì£¼ ì–‡ì€ ctypes ë˜í¼ë¡œ landlock_create_ruleset/landlock_add_ruleë¥¼ ì§ì ‘ í˜¸ì¶œí•´ ê¶Œí•œ ë¹„íŠ¸ë¥¼ ì •í™•íˆ ë„£ëŠ” ë°©ë²•(WRITE/TRUNCATE/â€¦ ì¡°í•©)ì„ ì“°ë©´ ë¼. ë¹„íŠ¸ ëª©ë¡ê³¼ ì˜ë¯¸ëŠ” ì»¤ë„ ë¬¸ì„œì— ì •ë¦¬ë¼ ìˆì–´. <a href="https://man.archlinux.org/man/landlock_add_rule.2.en?utm_source=chatgpt.com">man.archlinux.org+1</a></p>
  </li>
</ol>

<h1 id="2-íˆ´-ì‚¬ìš©ë²•llmì—-ì „ë‹¬í• -ìŠ¤í™">2) íˆ´ ì‚¬ìš©ë²•(LLMì— ì „ë‹¬í•  ìŠ¤í™)</h1>

<p>ì„¤ì • ì •ë³´ëŠ” í•œ ì¤„ë„ ë…¸ì¶œí•˜ì§€ ì•ŠëŠ”ë‹¤. ì•„ë˜ ë„¤ ê°€ì§€ë§Œ ê³µê°œ.</p>

<ol>
  <li>
    <p>python_exec_internal(session_id, code, timeout_sec)</p>
  </li>
  <li>
    <p>python_exec_visible(session_id, code, timeout_sec, enforce_plot_rules)</p>
  </li>
  <li>
    <p>copy_to_sandbox(src, dst_relpath)</p>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>python_session_control(session_id, action=["reset"</td>
          <td>"kill"])</td>
        </tr>
      </tbody>
    </table>
  </li>
</ol>

<p>copy_to_sandboxëŠ” ë‚´ë¶€ì ìœ¼ë¡œ SandboxManager.copy_to_sandboxë¥¼ í˜¸ì¶œí•œë‹¤. ì†ŒìŠ¤ëŠ” ì½ê¸° í—ˆìš© ê²½ë¡œ ë‚´ì— ìˆì–´ì•¼ í•˜ê³ , ëª©ì ì§€ëŠ” rw_root í•˜ìœ„ ìƒëŒ€ê²½ë¡œë§Œ í—ˆìš©í•œë‹¤. ì´ë ‡ê²Œ í•˜ë©´ LLMì€ â€œí˜¸ìŠ¤íŠ¸ íŒŒì¼ì— ììœ  ì ‘ê·¼(ì½ê¸°)â€ì€ ê°€ëŠ¥í•˜ì§€ë§Œ â€œì“°ê¸°â€ëŠ” ë°˜ë“œì‹œ ìƒŒë“œë°•ìŠ¤ ë””ë ‰í„°ë¦¬ë¡œ ë³µì‚¬í•œ ì‚¬ë³¸ë§Œ ë‹¤ë£¨ê²Œ ë˜ëŠ” ì›Œí¬í”Œë¡œê°€ ëœë‹¤.</p>

<h1 id="3-ì‹¤ì œ-ì‹¤í–‰-ë‹¨ê³„ì„¸ì…˜-ìœ ì§€ì¼íšŒìš©-ì„ íƒ">3) ì‹¤ì œ ì‹¤í–‰ ë‹¨ê³„(ì„¸ì…˜ ìœ ì§€/ì¼íšŒìš© ì„ íƒ)</h1>

<p>ì„¸ì…˜ì€ ì»¤ë„ ìœ ì§€í˜•ê³¼ ì¼íšŒìš© ë‘˜ ë‹¤ ì§€ì›. ê¸°ë³¸ì€ ìœ ì§€í˜•, ìš”ì²­ ì‹œ ì¼íšŒìš©ìœ¼ë¡œ ì‹¤í–‰.</p>

<p>êµ¬í˜„ ìŠ¤ì¼ˆë ˆí†¤</p>

<ul>
  <li>ì•„ë˜ëŠ” ë„ˆê°€ ì˜¬ë ¤ë‘” jupyter_client ê¸°ë°˜ ì½”ë“œë¥¼ ì •ì±… ë¶„ë¦¬/ì—ëŸ¬ ë©”ì„¸ì§€/ì¶”ê°€ ë„êµ¬ í¬í•¨ìœ¼ë¡œ ë‹¤ë“¬ì€ ë²„ì „. seaborn/ìƒ‰ìƒ/ì„œë¸Œí”Œë¡¯ ê¸ˆì§€ ê·œì¹™ë„ ê·¸ëŒ€ë¡œ.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># code_tool.py  (LLMì— ë…¸ì¶œë˜ëŠ” ì—”ë“œí¬ì¸íŠ¸ëŠ” ì—¬ê¸° í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ë¿)
</span><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">base64</span><span class="p">,</span> <span class="n">re</span><span class="p">,</span> <span class="n">shutil</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="n">jupyter_client</span> <span class="kn">import</span> <span class="n">KernelManager</span>
<span class="kn">from</span> <span class="n">sandbox_config</span> <span class="kn">import</span> <span class="n">SandboxManager</span><span class="p">,</span> <span class="n">FsPolicy</span>

<span class="c1"># 0) ì´ˆê¸° ì„¤ì •(í˜¸ìŠ¤íŠ¸ ì „ìš©)
</span><span class="n">SANDBOX</span> <span class="o">=</span> <span class="nc">SandboxManager</span><span class="p">()</span>
<span class="c1"># ì˜ˆ: ë„¤ ì•±ì—ì„œë§Œ í˜¸ì¶œ. LLMì—ê² ê°ì¶¤.
# SANDBOX.apply_landlock(FsPolicy(
#     ro_roots=["/home/you/data", "/usr/share"],
#     rw_root="/home/you/sbx",
#     allow_world_read=False  # ëŠìŠ¨í•œ ì„¤ì •ì´ í•„ìš”í•˜ë©´ True
# ))
</span>
<span class="c1"># 1) ì„¸ì…˜ í’€
</span><span class="k">class</span> <span class="nc">KernelSession</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">km</span> <span class="o">=</span> <span class="nc">KernelManager</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">start_kernel</span><span class="p">(</span><span class="n">extra_arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">--HistoryManager.enabled=False</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">kc</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">client</span><span class="p">();</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">start_channels</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">stop_channels</span><span class="p">();</span> <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">shutdown_kernel</span><span class="p">(</span><span class="n">now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">\bseaborn\b</span><span class="sh">"</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>  <span class="c1"># ì •ì±… ì˜ˆ
</span>            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">,</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Do not use seaborn</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:[]}</span>
        <span class="n">msg_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">allow_stdin</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">stop_on_error</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">();</span> <span class="n">out</span><span class="o">=</span><span class="p">[];</span> <span class="n">err</span><span class="o">=</span><span class="p">[];</span> <span class="n">arts</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">km</span><span class="p">.</span><span class="nf">shutdown_kernel</span><span class="p">(</span><span class="n">now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span><span class="mi">124</span><span class="p">,</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">Timeout</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:[]}</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">kc</span><span class="p">.</span><span class="nf">get_iopub_msg</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">parent_header</span><span class="sh">"</span><span class="p">].</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">msg_id</span><span class="sh">"</span><span class="p">)</span> <span class="o">!=</span> <span class="n">msg_id</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">header</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">msg_type</span><span class="sh">"</span><span class="p">];</span> <span class="n">content</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">stream</span><span class="sh">"</span><span class="p">:</span>
                <span class="p">(</span><span class="n">out</span> <span class="k">if</span> <span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span><span class="o">==</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span> <span class="k">else</span> <span class="n">err</span><span class="p">).</span><span class="nf">append</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">err</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">content</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">traceback</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])))</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">display_data</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">execute_result</span><span class="sh">"</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">content</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">,{})</span>
                <span class="k">if</span> <span class="sh">"</span><span class="s">image/png</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">image/png</span><span class="sh">"</span><span class="p">];</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="nf">encode</span><span class="p">()</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">b</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">plot_</span><span class="si">{</span><span class="nf">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span><span class="si">}</span><span class="s">.png</span><span class="sh">"</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">SANDBOX</span><span class="p">.</span><span class="n">policy</span><span class="p">.</span><span class="n">rw_root</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  <span class="c1"># ì•ˆì „
</span>                    <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">SANDBOX</span><span class="p">.</span><span class="n">policy</span><span class="p">.</span><span class="n">rw_root</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span><span class="sh">"</span><span class="s">wb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">base64</span><span class="p">.</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
                    <span class="n">arts</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="n">fn</span><span class="p">,</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span><span class="n">fp</span><span class="p">,</span><span class="sh">"</span><span class="s">mime</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">image/png</span><span class="sh">"</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">typ</span><span class="o">==</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">content</span><span class="p">[</span><span class="sh">"</span><span class="s">execution_state</span><span class="sh">"</span><span class="p">]</span><span class="o">==</span><span class="sh">"</span><span class="s">idle</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">out</span><span class="p">)[:</span><span class="mi">20000</span><span class="p">],</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">err</span><span class="p">)[:</span><span class="mi">20000</span><span class="p">],</span><span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:</span><span class="n">arts</span><span class="p">}</span>

<span class="k">class</span> <span class="nc">SessionPool</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span> <span class="n">self</span><span class="p">.</span><span class="n">pool</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">KernelSession</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KernelSession</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">pool</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="nc">KernelSession</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span> 
        <span class="k">if</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">pool</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">sid</span><span class="p">].</span><span class="nf">shutdown</span><span class="p">();</span> <span class="n">self</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="nc">KernelSession</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">pool</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">()</span>

<span class="n">POOL</span> <span class="o">=</span> <span class="nc">SessionPool</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_plot_rule_check</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">\.subplot\(</span><span class="sh">"</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span> <span class="ow">or</span> <span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">subplots\(</span><span class="sh">"</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">Do not use subplots</span><span class="sh">"</span>
    <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">(color\s*=|palette\s*=|style\s*=)</span><span class="sh">"</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">Do not set explicit colors or styles</span><span class="sh">"</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="c1"># 2) LLMì´ ì“°ëŠ” íˆ´(ì„¤ì • ì •ë³´ ì—†ìŒ)
</span><span class="k">def</span> <span class="nf">python_exec_internal</span><span class="p">(</span><span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">sess</span> <span class="o">=</span> <span class="n">POOL</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sess</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_sec</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">python_exec_visible</span><span class="p">(</span><span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">enforce_plot_rules</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">enforce_plot_rules</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nf">_plot_rule_check</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">,</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span><span class="n">v</span><span class="p">,</span><span class="sh">"</span><span class="s">artifacts</span><span class="sh">"</span><span class="p">:[]}</span>
    <span class="n">sess</span> <span class="o">=</span> <span class="n">POOL</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sess</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_sec</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">python_session_control</span><span class="p">(</span><span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="sh">"</span><span class="s">reset</span><span class="sh">"</span><span class="p">:</span> <span class="n">POOL</span><span class="p">.</span><span class="nf">reset</span><span class="p">(</span><span class="n">session_id</span><span class="p">);</span> <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">msg</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">reset</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="sh">"</span><span class="s">kill</span><span class="sh">"</span><span class="p">:</span>  <span class="n">POOL</span><span class="p">.</span><span class="nf">kill</span><span class="p">(</span><span class="n">session_id</span><span class="p">);</span>  <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">msg</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">killed</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">msg</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">unknown action</span><span class="sh">"</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">copy_to_sandbox</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst_relpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">SANDBOX</span><span class="p">.</span><span class="nf">copy_to_sandbox</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst_relpath</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">dst</span><span class="sh">"</span><span class="p">:</span> <span class="n">dst</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
</code></pre></div></div>

<p>íˆ´ ìŠ¤í™(JSON)ë§Œ LLMì— ì „ë‹¬</p>

<ul>
  <li>ë„¤ OpenAI Agents SDKë‚˜ vLLM+GPTOSS/Qwen íŒŒì´í”„ë¼ì¸ì—ì„œ ì•„ë˜ â€œíˆ´ ì„œëª…â€ë§Œ ë…¸ì¶œí•´. ì„¤ì • ê²½ë¡œë‚˜ ì •ì±… ì •ë³´ëŠ” ì ˆëŒ€ ë„£ì§€ ë§ˆ.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python_exec_internal_tool</span> <span class="o">=</span> <span class="p">{</span>
  <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
  <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">python_exec_internal</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">ì„¸ì…˜ ìœ ì§€í˜• íŒŒì´ì¬ ì‹¤í–‰(ë¹„ê°€ì‹œ).</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:{</span>
      <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span>
        <span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span><span class="mi">3</span><span class="p">}</span>
      <span class="p">},</span>
      <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">],</span>
      <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span><span class="bp">False</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span><span class="bp">True</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">python_exec_visible_tool</span> <span class="o">=</span> <span class="p">{</span>
  <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
  <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">python_exec_visible</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">ì‚¬ìš©ì ê°€ì‹œ ì‹¤í–‰(ë‹¨ì¼ matplotlib í”Œë¡¯, ìƒ‰/ìŠ¤íƒ€ì¼ ê¸ˆì§€).</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:{</span>
      <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span>
        <span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span><span class="mi">3</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">enforce_plot_rules</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">boolean</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
      <span class="p">},</span>
      <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">],</span>
      <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span><span class="bp">False</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span><span class="bp">True</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">copy_to_sandbox_tool</span> <span class="o">=</span> <span class="p">{</span>
  <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
  <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">copy_to_sandbox</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">í˜¸ìŠ¤íŠ¸ íŒŒì¼ì„ ìƒŒë“œë°•ìŠ¤ ì“°ê¸° ë£¨íŠ¸ë¡œ ë³µì‚¬. ëª©ì ì§€ëŠ” rw_root í•˜ìœ„ ìƒëŒ€ê²½ë¡œë§Œ.</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:{</span>
      <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span>
        <span class="sh">"</span><span class="s">src</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">dst_relpath</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}</span>
      <span class="p">},</span>
      <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">src</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">dst_relpath</span><span class="sh">"</span><span class="p">],</span>
      <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span><span class="bp">False</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span><span class="bp">True</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">python_session_control_tool</span> <span class="o">=</span> <span class="p">{</span>
  <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
  <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">python_session_control</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">ì„¸ì…˜ ì¬ì‹œì‘/ì¢…ë£Œ</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:{</span>
      <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:{</span>
        <span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">action</span><span class="sh">"</span><span class="p">:{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">enum</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">reset</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">kill</span><span class="sh">"</span><span class="p">]}</span>
      <span class="p">},</span>
      <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">action</span><span class="sh">"</span><span class="p">],</span>
      <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span><span class="bp">False</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span><span class="bp">True</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ì„¸ì…˜ ìœ ì§€ vs ì¼íšŒìš©</p>

<ul>
  <li>
    <p>ìœ ì§€í˜•: session_idë¥¼ ê³ ì •ìœ¼ë¡œ ë„˜ê¸°ë©´ ì»¤ë„ ìƒíƒœê°€ ìœ ì§€ëœë‹¤.</p>
  </li>
  <li>
    <p>ì¼íšŒìš©: python_session_control(session_id, "kill")ë¡œ ì¦‰ì„ ì¢…ë£Œ í›„ ìƒˆ session_idë¥¼ ì“°ë©´ ëœë‹¤. í˜¹ì€ ë‚´ë¶€ì ìœ¼ë¡œ â€œone-shotâ€ ì½”ë“œë¥¼ ë³„ë„ ë¶„ê¸°í•´ KernelManagerë¥¼ ë§¤ë²ˆ ìƒì„±/ì¢…ë£Œí•´ë„ ëœë‹¤.</p>
  </li>
</ul>

<p>ì•ˆì „ì„±ì— ëŒ€í•œ ë©”ëª¨</p>

<ul>
  <li>
    <p>Landlockì€ ì»¤ë„ LSMì´ë¯€ë¡œ ì‚¬ìš© ì¤‘ í•´ì œ ë¶ˆê°€í•œ ì¼ë°©í–¥ ì œì•½(ìì‹ ìƒì† í¬í•¨)ì´ê³ , ê²½ë¡œ ê¸°ë°˜ ê¶Œí•œ ë¹„íŠ¸ë¥¼ ì œê³µí•œë‹¤. FS ê¶Œí•œ ë¹„íŠ¸ì™€ ì„¤ê³„ ì›ë¦¬ëŠ” ì»¤ë„ ë¬¸ì„œì˜ ì‚¬ìš©ìê³µê°„ API/ë§¤ë‰´ì–¼ì—ì„œ í™•ì¸ ê°€ëŠ¥í•˜ë‹¤. <a href="https://man7.org/linux/man-pages/man7/landlock.7.html?utm_source=chatgpt.com">man7.org+2</a></p>
  </li>
  <li>
    <p>PyPI â€˜landlockâ€™ íŒ¨í‚¤ì§€ëŠ” PathBeneathë¥¼ ì§ì ‘ ë…¸ì¶œí•˜ì§€ ì•Šê³  Ruleset.allow / applyë¥¼ ì“°ëŠ” ê³ ìˆ˜ì¤€ ë˜í¼ë‹¤. ë¬¸ì„œ ì˜ˆì‹œëŠ” ë””ë ‰í„°ë¦¬ ê³„ì¸µ ì ‘ê·¼ í—ˆìš© ì˜ˆì œë§Œ ì œê³µí•œë‹¤. ë²„ì „ì— ë”°ë¼ ê²½ë¡œë³„ ì“°ê¸° ë¹„íŠ¸ë¥¼ ì§ì ‘ ëª» ì¤„ ìˆ˜ ìˆìœ¼ë‹ˆ, ì •í™•í•œ RW ë¶„ë¦¬ë¥¼ ì›í•˜ë©´ landrun ê°™ì€ ì–‡ì€ CLIë¥¼ í•¨ê»˜ ì“°ê±°ë‚˜(ctypesë¡œ ì§ì ‘ ë¹„íŠ¸ ì§€ì •) ì •ì±…ì„ ì•½ê°„ ëŠìŠ¨í•˜ê²Œ ìš´ì˜í•˜ë©´ ëœë‹¤. <a href="https://pypi.org/project/landlock/">PyPI+1</a></p>
  </li>
</ul>

<p>ë§ˆë¬´ë¦¬ ì²´í¬ë¦¬ìŠ¤íŠ¸</p>

<ol>
  <li>
    <p>ë„¤ ì•± ì´ˆê¸°í™” ì‹œì ì—ë§Œ SANDBOX.apply_landlock(â€¦) í˜¸ì¶œ. ì´ ì½”ë“œëŠ” ì ˆëŒ€ LLM í”„ë¡¬í”„íŠ¸Â·íˆ´ ì •ì˜ì— ì„ì§€ ì•ŠëŠ”ë‹¤.</p>
  </li>
  <li>
    <p>LLMì—ëŠ” ë„¤ ê°œ íˆ´ ì‹œê·¸ë‹ˆì²˜ë§Œ ë…¸ì¶œ.</p>
  </li>
  <li>
    <p>ì“°ê¸°ê°€ í•„ìš”í•œ íŒŒì¼ì€ ë¬´ì¡°ê±´ copy_to_sandboxë¡œ rw_rootì— ì‚¬ë³¸ì„ ë‘” ë’¤ ê·¸ ê²½ë¡œë§Œ ì“°ë„ë¡ ìœ ë„.</p>
  </li>
  <li>
    <p>ì„¸ì…˜ ìœ ì§€ê°€ í•„ìš”í•˜ë©´ session_idë¥¼ ê³ ì •í•˜ê³ , í•„ìš” ì—†ìœ¼ë©´ killâ†’ìƒˆë¡œ ìƒì„±.</p>
  </li>
</ol>

<p>ì›í•˜ëŠ” ë°©í–¥ìœ¼ë¡œ ë” ì´˜ì´˜í•œ RW ë¹„íŠ¸ ì œì–´ê°€ í•„ìš”í•œ ìˆœê°„ì´ ì˜¤ë©´ ë‘ ê°€ì§€ ë£¨íŠ¸ê°€ ìˆì–´. ì²«ì§¸, landrunì„ ì»¤ë„ ì•ë‹¨ ë˜í¼ë¡œ ë®ì–´ì”Œìš°ê¸°(ë„ì»¤ ì•„ë‹˜). ë‘˜ì§¸, ì‘ì€ ctypes ë¼ˆëŒ€ì— ì»¤ë„ ë§¤ë‰´ì–¼ì˜ LANDLOCK_ACCESS_FS_* ë¹„íŠ¸ë¥¼ ê·¸ëŒ€ë¡œ ë„£ëŠ” ì €ìˆ˜ì¤€ ë°”ì¸ë”©. ì–´ëŠ ìª½ì´ë“  ì—°ê²°í•´ ì¤„ ìˆ˜ ìˆì–´.</p>

<p class="chat--user">

ì¢€ ì´ìƒí•´. rw ì»¨íŠ¸ë¡¤ì€ ì–´ë””ì„œí•´

</p>

<p>í•µì‹¬ë§Œ ì½• ì§‘ì–´ ë§í• ê²Œ. RW ì»¨íŠ¸ë¡¤ì€ â€œíˆ´ ë ˆì´ì–´â€ê°€ ì•„ë‹ˆë¼ â€œì„¸ì…˜ í”„ë¡œì„¸ìŠ¤ê°€ ëœ¨ëŠ” ìˆœê°„ ì»¤ë„ì— Landlock ë£°ì„ ì˜¬ë¦¬ëŠ” ê³³â€ì—ì„œ í•œë‹¤. ì¦‰,</p>

<p>1ë‹¨ê³„(ë„¤ê°€ ì§ì ‘ í•˜ëŠ” Config): ì½ê¸° ì „ìš© ë””ë ‰í„°ë¦¬(ro_dirs)ì™€ ì½ê¸°/ì“°ê¸° ë””ë ‰í„°ë¦¬(rw_dir)ë¥¼ ì •í•œë‹¤.<br />
2ë‹¨ê³„(ì„¸ì…˜ ë¶€íŒ… ì‹œì ): í•´ë‹¹ ì„¸ì…˜ í”„ë¡œì„¸ìŠ¤ ì•ˆì—ì„œ landlock_create_ruleset â†’ landlock_add_rule(ê° ê²½ë¡œì— ê¶Œí•œ ë§ˆìŠ¤í¬ ì§€ì •) â†’ landlock_restrict_selfë¥¼ í˜¸ì¶œí•œë‹¤. ì´ë•Œ ro_dirsì—ëŠ” ì½ê¸° ë§ˆìŠ¤í¬, rw_dirì—ëŠ” ì½ê¸°+ì“°ê¸° ë§ˆìŠ¤í¬ë¥¼ ì¤€ë‹¤.<br />
3ë‹¨ê³„(ì‹¤í–‰ ì¤‘): LLMì€ copy_to_sandboxë¡œ íŒŒì¼ì„ rw_dir ì•„ë˜ì— ë“¤ì—¬ì™€ì„œë§Œ ì €ì¥Â·ìˆ˜ì •í•˜ê²Œ í•˜ê³ , ìƒŒë“œë°•ìŠ¤ ë°– ì“°ê¸° ì‹œë„ëŠ” ì»¤ë„ì´ ê±°ë¶€í•œë‹¤.</p>

<p>ì•„ë˜ëŠ” ì‹¤ì œë¡œ â€œì–´ë””ì„œ ì–´ë–»ê²Œ RWë¥¼ ê°•ì œí•˜ëŠ”ì§€â€ê°€ ë“œëŸ¬ë‚˜ëŠ” ìµœì†Œ í—¬í¼ë‹¤. PyPIì˜ ê³ ìˆ˜ì¤€ landlock ë˜í¼ê°€ per-path ê¶Œí•œ ë¹„íŠ¸ë¥¼ ì•ˆ ì—´ì–´ì¤„ ë•Œë¥¼ ëŒ€ë¹„í•´ ctypesë¡œ ì»¤ë„ UAPIë¥¼ ì§ì ‘ í˜¸ì¶œí•œë‹¤. x86_64ì˜ ê¸°ë³¸ syscall ë²ˆí˜¸ë¥¼ ì“°ë˜, liblandlock.soê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ìš°ì„  ì‚¬ìš©í•œë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># landlock_helper.py
</span><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">util</span>

<span class="c1"># x86_64 ê¸°ë³¸ê°’. ë‹¤ë¥¸ ì•„í‚¤í…ì²˜ë©´ ë²ˆí˜¸ê°€ ë‹¤ë¥¼ ìˆ˜ ìˆë‹¤.
</span><span class="n">__NR_landlock_create_ruleset</span> <span class="o">=</span> <span class="mi">444</span>
<span class="n">__NR_landlock_add_rule</span>       <span class="o">=</span> <span class="mi">445</span>
<span class="n">__NR_landlock_restrict_self</span>  <span class="o">=</span> <span class="mi">446</span>

<span class="c1"># ì»¤ë„ UAPI ë¹„íŠ¸ (ì—†ëŠ” ë¹„íŠ¸ëŠ” 0ìœ¼ë¡œ ì²˜ë¦¬)
</span><span class="k">class</span> <span class="nc">Access</span><span class="p">:</span>
    <span class="n">READ_FILE</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span>
    <span class="n">WRITE_FILE</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
    <span class="n">READ_DIR</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span>
    <span class="n">REMOVE_DIR</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span>
    <span class="n">REMOVE_FILE</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span>
    <span class="n">MAKE_CHAR</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span>
    <span class="n">MAKE_DIR</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span>
    <span class="n">MAKE_REG</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span>
    <span class="n">MAKE_SOCK</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span>
    <span class="n">MAKE_FIFO</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span>
    <span class="n">MAKE_BLOCK</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span>
    <span class="n">MAKE_SYM</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span>
    <span class="c1"># ABI v2+
</span>    <span class="n">REFER</span>       <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span>
    <span class="c1"># ABI v3+
</span>    <span class="n">TRUNCATE</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span>
    <span class="n">EXECUTE</span>     <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span>  <span class="c1"># ìˆìœ¼ë©´ ì‚¬ìš©
</span>
<span class="c1"># struct landlock_path_beneath_attr
</span><span class="k">class</span> <span class="nc">path_beneath_attr</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">allowed_access</span><span class="sh">"</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">c_uint64</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">parent_fd</span><span class="sh">"</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">c_int</span><span class="p">),</span>
    <span class="p">]</span>

<span class="n">libc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="p">.</span><span class="nc">CDLL</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="nf">find_library</span><span class="p">(</span><span class="sh">"</span><span class="s">c</span><span class="sh">"</span><span class="p">),</span> <span class="n">use_errno</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_syscall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="nf">syscall</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="nf">c_long</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">get_errno</span><span class="p">()</span>
        <span class="k">raise</span> <span class="nc">OSError</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="nf">strerror</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">r</span>

<span class="k">def</span> <span class="nf">_best_effort_mask</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">|=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">Access</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span>

<span class="k">def</span> <span class="nf">_open_ro_dir</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">O_PATH</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_CLOEXEC</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">apply_landlock_rw</span><span class="p">(</span><span class="n">ro_dirs</span><span class="p">,</span> <span class="n">rw_dir</span><span class="p">):</span>
    <span class="c1"># 1) ì–´ë–¤ FS ê¶Œí•œì„ ë‹¤ë£°ì§€ ì»¤ë„ì— ì•Œë¦¬ê¸°(handled_access_fs)
</span>    <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="sh">"</span><span class="s">READ_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">WRITE_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">READ_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">REMOVE_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">REMOVE_FILE</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">MAKE_CHAR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_REG</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_SOCK</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_FIFO</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_BLOCK</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_SYM</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">REFER</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">TRUNCATE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">EXECUTE</span><span class="sh">"</span>
    <span class="p">]:</span>
        <span class="n">handled</span> <span class="o">|=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">Access</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># landlock_create_ruleset(attr=NULL, size=0, flags=0)ë¡œ ABI ì¿¼ë¦¬í•  ìˆ˜ë„ ìˆì§€ë§Œ,
</span>    <span class="c1"># ì—¬ê¸°ì„  ê°„ë‹¨í™”: ë°”ë¡œ ruleset ìƒì„± (size=8ë°”ì´íŠ¸ ë§ˆìŠ¤í¬ ì „ì†¡)
</span>    <span class="k">class</span> <span class="nc">ruleset_attr</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="n">Structure</span><span class="p">):</span>
        <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[(</span><span class="sh">"</span><span class="s">handled_access_fs</span><span class="sh">"</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">c_uint64</span><span class="p">)]</span>
    <span class="n">attr</span> <span class="o">=</span> <span class="nf">ruleset_attr</span><span class="p">(</span><span class="n">handled_access_fs</span><span class="o">=</span><span class="n">handled</span><span class="p">)</span>
    <span class="n">ruleset_fd</span> <span class="o">=</span> <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_create_ruleset</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">byref</span><span class="p">(</span><span class="n">attr</span><span class="p">),</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># 2) ì½ê¸° ì „ìš© ë§ˆìŠ¤í¬ì™€ ì½ê¸°/ì“°ê¸° ë§ˆìŠ¤í¬ êµ¬ì„±
</span>    <span class="n">read_mask</span>  <span class="o">=</span> <span class="nf">_best_effort_mask</span><span class="p">(</span><span class="sh">"</span><span class="s">READ_FILE</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">READ_DIR</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">EXECUTE</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">write_mask</span> <span class="o">=</span> <span class="nf">_best_effort_mask</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">READ_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">READ_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">WRITE_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_REG</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">REMOVE_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">REMOVE_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">REFER</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">TRUNCATE</span><span class="sh">"</span>
    <span class="p">)</span>

    <span class="c1"># 3) ro_dirsì— ì½ê¸° ê·œì¹™ ì¶”ê°€
</span>    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">ro_dirs</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="nf">_open_ro_dir</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">attr_pb</span> <span class="o">=</span> <span class="nf">path_beneath_attr</span><span class="p">(</span><span class="n">allowed_access</span><span class="o">=</span><span class="n">read_mask</span><span class="p">,</span> <span class="n">parent_fd</span><span class="o">=</span><span class="n">fd</span><span class="p">)</span>
            <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_add_rule</span><span class="p">,</span> <span class="n">ruleset_fd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">byref</span><span class="p">(</span><span class="n">attr_pb</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># 1 = LANDLOCK_RULE_PATH_BENEATH
</span>        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

    <span class="c1"># 4) rw_dirì— ì½ê¸°+ì“°ê¸° ê·œì¹™ ì¶”ê°€
</span>    <span class="n">rw_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">rw_dir</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">rw_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="nf">_open_ro_dir</span><span class="p">(</span><span class="n">rw_dir</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr_pb</span> <span class="o">=</span> <span class="nf">path_beneath_attr</span><span class="p">(</span><span class="n">allowed_access</span><span class="o">=</span><span class="n">write_mask</span><span class="p">,</span> <span class="n">parent_fd</span><span class="o">=</span><span class="n">fd</span><span class="p">)</span>
        <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_add_rule</span><span class="p">,</span> <span class="n">ruleset_fd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">byref</span><span class="p">(</span><span class="n">attr_pb</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

    <span class="c1"># 5) í˜„ì¬ ìŠ¤ë ˆë“œì— ê·œì¹™ ì ìš©(ìì‹ í”„ë¡œì„¸ìŠ¤ì— ìƒì†ë¨)
</span>    <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_restrict_self</span><span class="p">,</span> <span class="n">ruleset_fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">ruleset_fd</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">True</span>
</code></pre></div></div>

<p>ì´ì œ RW ì»¨íŠ¸ë¡¤ì´ â€œì •í™•íˆ ì–´ë””ì„œâ€ ì´ë¤„ì§€ëŠ”ì§€ ë³´ì´ê²Œ ì—°ê²°í•˜ë©´ ëì´ë‹¤.</p>

<ol>
  <li>
    <p>ë„¤ê°€ ì§ì ‘ Configí•  ë•Œ<br />
ro_dirsì™€ rw_dirë¥¼ ì •í•˜ê³ , ì„¸ì…˜ í”„ë¡œì„¸ìŠ¤ë¥¼ ë„ìš°ê¸° ì§ì „ ë˜ëŠ” ì„¸ì…˜ í”„ë¡œì„¸ìŠ¤ ë‚´ë¶€ ì´ˆê¸°í™”ì—ì„œ apply_landlock_rw(ro_dirs, rw_dir)ë¥¼ í˜¸ì¶œí•œë‹¤. ì—¬ê¸°ì„œ ro_dirsì—ëŠ” read_mask, rw_dirì—ëŠ” write_maskë¥¼ ì»¤ë„ì— ë“±ë¡í•œë‹¤. ì´ ì§€ì ì´ RW ì»¨íŠ¸ë¡¤ì˜ ë³¸ì§„ì´ë‹¤.</p>
  </li>
  <li>
    <p>ì„¸ì…˜ ìœ ì§€ êµ¬ì¡°ì— ë¶™ì¼ ë•Œ<br />
KernelBackendë¼ë©´ ì»¤ë„ ê¸°ë™ ì§í›„ ì²« ì…€ì—ì„œ ì•„ë˜ í•œ ì¤„ì„ ì£¼ì…í•˜ê±°ë‚˜, ì•„ì˜ˆ ì»¤ë„ í”„ë¡œì„¸ìŠ¤ì˜ entrypointì—ì„œ í˜¸ì¶œí•œë‹¤.</p>
  </li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ì»¤ë„ ì²« ì…€
</span><span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">landlock_helper</span> <span class="kn">import</span> <span class="n">apply_landlock_rw</span>
<span class="nf">apply_landlock_rw</span><span class="p">(</span>
    <span class="n">ro_dirs</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">RO_DIRS</span><span class="sh">"</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">pathsep</span><span class="p">),</span>
    <span class="n">rw_dir</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">RW_DIR</span><span class="sh">"</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div></div>

<p>SubprocessBackendë¼ë©´ ìì‹ í”„ë¡œì„¸ìŠ¤ê°€ ë¶€íŒ…ë˜ìë§ˆì ê°™ì€ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•œ ë’¤ ì½”ë“œ ì‹¤í–‰ ë£¨í”„ì— ì§„ì…í•œë‹¤.</p>

<ol>
  <li>íˆ´ ë ˆì´ì–´ì—ì„œì˜ ì—­í•  ì •ë¦¬<br />
íˆ´ì€ RWë¥¼ â€œê²°ì •â€í•˜ì§€ ì•ŠëŠ”ë‹¤. íˆ´ì€ ê·¸ì € copy_to_sandboxë¡œ íŒŒì¼ì„ rw_dir ì•„ë˜ë¡œ ì˜®ê¸°ê³ , python_executeë¡œ ì‹¤í–‰í•  ë¿ì´ë‹¤. RW ì •ì±…ì€ ìœ„ì˜ apply_landlock_rwê°€ ì»¤ë„ì— ê³ ì •ì‹œí‚¨ë‹¤. ë”°ë¼ì„œ temp.pyê°€ rw_dir ë°–ì„ ì“°ë ¤ í•˜ë©´ ì»¤ë„ì´ EACCESë¡œ ê±°ë¶€í•œë‹¤. ì½ê¸°ëŠ” ro_dirsì—ì„œë§Œ í—ˆìš©ëœë‹¤. allow_world_read ê°™ì€ í¸ì˜ ì˜µì…˜ì„ ì“°ë©´ ì½ê¸° ë²”ìœ„ë¥¼ ë„“í ìˆ˜ ìˆì§€ë§Œ, ì“°ê¸° ê¶Œí•œì€ ì—¬ì „íˆ rw_dirë¡œë§Œ ë¬¶ì¸ë‹¤.</li>
</ol>

<p>ì •ë¦¬í•˜ë©´, RW ì»¨íŠ¸ë¡¤ì€ landlock_helper.apply_landlock_rw ì•ˆì˜ ë‘ êµ°ë°ì—ì„œ ë™ì‹œì— ê±¸ë¦°ë‹¤. ro_dirsì— read_mask ê·œì¹™ì„ ì¶”ê°€í•˜ëŠ” ë¶€ë¶„, rw_dirì— write_mask ê·œì¹™ì„ ì¶”ê°€í•˜ëŠ” ë¶€ë¶„. íˆ´ì€ ê·¸ ì •ì±…ì„ ì¡´ì¤‘í•  ë¿ì´ê³ , LLMì—ê²ŒëŠ” ì´ ì„¤ì •ì„ ì ˆëŒ€ ë…¸ì¶œí•˜ì§€ ì•ŠëŠ”ë‹¤.</p>

<p class="chat--user">

def apply_landlock(self, policy: FsPolicy): if self._applied: return rs = Ruleset() # ê¸°ë³¸: ì „ë¶€ ê¸ˆì§€, allowë¡œë§Œ í—ˆìš© if policy.allow_world_read: rs.allow("/") # ëª¨ë“  ê²½ë¡œ ì½ê¸° í—ˆìš©(â€œì™„ë²½í•œ ìƒŒë“œë°•ìŠ¤ ë¶ˆí•„ìš”â€ ìš”êµ¬ì¼ ë•Œ í¸ì˜ìš©) else: for p in policy.ro_roots: rs.allow(p) # rw_rootëŠ” LLMì—ê²Œ copy_to_sandbox í†µí•´ì„œë§Œ íŒŒì¼ì„ ë‘ê²Œ í•œë‹¤. # íŒ¨í‚¤ì§€ APIê°€ ê²½ë¡œë³„ ì“°ê¸° ë¹„íŠ¸ë¥¼ ë…¸ì¶œí•˜ì§€ ì•ŠëŠ” ê²½ìš°ê°€ ìˆì–´, # ì“°ê¸°ëŠ” ì›ì¹™ì ìœ¼ë¡œ ì°¨ë‹¨í•˜ê³ , ì»¤ë„ì´ í—ˆìš©í•˜ëŠ” í•œì—ì„œë§Œ rw_root ë‚´ ì¡°ì‘ì„ ì‹œë„í•œë‹¤. # (íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ë¡œ per-path write ì˜µì…˜ì´ ìƒê¸°ë©´ ì—¬ê¸°ì„œ ì¡°ê±´ë¶€ë¡œ í—ˆìš© ì¶”ê°€) rs.apply() # í˜„ì¬ ìŠ¤ë ˆë“œ ë° ìì‹ í”„ë¡œì„¸ìŠ¤ì— ì˜êµ¬ ì ìš© self._applied = True self.policy = policy ì´ ì½”ë“œì—ì„œ rw policyë¥¼ ì ìš©í•´ì•¼í•˜ëŠ”ê±° ì•„ë‹ˆì•¼?

</p>

<p>ë§ì•„. ê·¸ ì½”ë“œ ê·¸ëŒ€ë¡œë©´ rw_rootì— â€œì“°ê¸° í—ˆìš©â€ì´ ì „í˜€ ì ìš©ë˜ì§€ ì•Šì•„. Ruleset().allow()ë§Œ ì“°ë©´ ê²½ë¡œ í—ˆìš© ì—¬ë¶€ ì •ë„ë§Œ ë‹¤ë£¨ê³ , ê²½ë¡œë³„ ê¶Œí•œ ë¹„íŠ¸(READ/WRITE/TRUNCATE ë“±)ë¥¼ ì§€ì •í•˜ì§€ ëª»í•´ ì“°ê¸° ì •ì±…ì„ ì»¤ë„ì— ëª» ë°•ì§€ ëª»í•´. ê·¸ë˜ì„œ ì´ ì§€ì ì—ì„œ RW ë§ˆìŠ¤í¬ë¥¼ ì»¤ë„ì— ì •í™•íˆ ë“±ë¡í•´ì•¼ í•œë‹¤.</p>

<p>ì‹¤ì œë¡œ RW ì •ì±…ì„ ì ìš©í•˜ëŠ” ë°©ë²•ì€ ë‘ ê°€ì§€ë‹¤.</p>

<ol>
  <li>
    <p>ì •í™•ëª¨ë“œ(ê¶Œì¥): ì»¤ë„ UAPIë¥¼ ctypesë¡œ ì§ì ‘ í˜¸ì¶œí•´ì„œ ro_dirsì—ëŠ” ì½ê¸° ë§ˆìŠ¤í¬, rw_dirì—ëŠ” ì½ê¸°+ì“°ê¸° ë§ˆìŠ¤í¬ë¥¼ ë„£ëŠ”ë‹¤.</p>
  </li>
  <li>
    <p>ì„ì‹œ ëŒ€ì•ˆ: high-level ë˜í¼ë§Œìœ¼ë¡œëŠ” per-path write ë¹„íŠ¸ë¥¼ ëª» ì£¼ë‹ˆ, rw ì»¨íŠ¸ë¡¤ì„ ì»¤ë„ì´ ì•„ë‹Œ íˆ´ ë ˆì´ì–´(ëª½í‚¤íŒ¨ì¹˜/audit hook)ì—ì„œ â€œì†Œí”„íŠ¸â€ë¡œ ë§‰ëŠ”ë‹¤. ì´ê±´ ì˜ë„í•˜ì‹  â€œë„ì»¤ ì—†ì´ë„ ê½¤ ì•ˆì „â€ì— ëª» ë¯¸ì¹œë‹¤.</p>
  </li>
</ol>

<p>ì•„ë˜ëŠ” 1) ì •í™•ëª¨ë“œë¡œ, ë„¤ ë©”ì„œë“œì— ë”± ë“¤ì–´ê°ˆ íŒ¨ì¹˜ë‹¤.</p>

<p>ê°„ë‹¨ í—¬í¼(í•œ íŒŒì¼ë¡œ ë‘ê³  import í•´ì„œ ì“°ë©´ ë¨)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># landlock_helper.py
</span><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">util</span>

<span class="n">__NR_landlock_create_ruleset</span> <span class="o">=</span> <span class="mi">444</span>
<span class="n">__NR_landlock_add_rule</span>       <span class="o">=</span> <span class="mi">445</span>
<span class="n">__NR_landlock_restrict_self</span>  <span class="o">=</span> <span class="mi">446</span>

<span class="k">class</span> <span class="nc">Access</span><span class="p">:</span>
    <span class="n">READ_FILE</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span>
    <span class="n">WRITE_FILE</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
    <span class="n">READ_DIR</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span>
    <span class="n">REMOVE_DIR</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span>
    <span class="n">REMOVE_FILE</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span>
    <span class="n">MAKE_CHAR</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span>
    <span class="n">MAKE_DIR</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span>
    <span class="n">MAKE_REG</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span>
    <span class="n">MAKE_SOCK</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span>
    <span class="n">MAKE_FIFO</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span>
    <span class="n">MAKE_BLOCK</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span>
    <span class="n">MAKE_SYM</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span>
    <span class="n">EXECUTE</span>     <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span>     <span class="c1"># ìˆìœ¼ë©´ ì‚¬ìš©
</span>    <span class="n">REFER</span>       <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span>     <span class="c1"># ABI v2+
</span>    <span class="n">TRUNCATE</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span>     <span class="c1"># ABI v3+
</span>
<span class="k">class</span> <span class="nc">path_beneath_attr</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[(</span><span class="sh">"</span><span class="s">allowed_access</span><span class="sh">"</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">c_uint64</span><span class="p">),</span> <span class="p">(</span><span class="sh">"</span><span class="s">parent_fd</span><span class="sh">"</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">c_int</span><span class="p">)]</span>

<span class="n">libc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="p">.</span><span class="nc">CDLL</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="nf">find_library</span><span class="p">(</span><span class="sh">"</span><span class="s">c</span><span class="sh">"</span><span class="p">),</span> <span class="n">use_errno</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_syscall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="nf">syscall</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="nf">c_long</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">get_errno</span><span class="p">()</span>
        <span class="k">raise</span> <span class="nc">OSError</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="nf">strerror</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">r</span>

<span class="k">def</span> <span class="nf">_mask</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">|=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">Access</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span>

<span class="k">def</span> <span class="nf">_open_path_only</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">O_PATH</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_CLOEXEC</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">apply_landlock_rw</span><span class="p">(</span><span class="n">ro_dirs</span><span class="p">,</span> <span class="n">rw_dir</span><span class="p">):</span>
    <span class="c1"># 1) ruleset ìƒì„±: ì–´ë–¤ FS ê¶Œí•œì„ ë‹¤ë£°ì§€ ì»¤ë„ì— í†µë³´
</span>    <span class="n">handled</span> <span class="o">=</span> <span class="nf">_mask</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">READ_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">WRITE_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">READ_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">REMOVE_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">REMOVE_FILE</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">MAKE_CHAR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_REG</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_SOCK</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_FIFO</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_BLOCK</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_SYM</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">EXECUTE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">REFER</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">TRUNCATE</span><span class="sh">"</span>
    <span class="p">)</span>
    <span class="k">class</span> <span class="nc">ruleset_attr</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="n">Structure</span><span class="p">):</span>
        <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[(</span><span class="sh">"</span><span class="s">handled_access_fs</span><span class="sh">"</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">c_uint64</span><span class="p">)]</span>
    <span class="n">rs_attr</span> <span class="o">=</span> <span class="nf">ruleset_attr</span><span class="p">(</span><span class="n">handled_access_fs</span><span class="o">=</span><span class="n">handled</span><span class="p">)</span>
    <span class="n">rs_fd</span> <span class="o">=</span> <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_create_ruleset</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">byref</span><span class="p">(</span><span class="n">rs_attr</span><span class="p">),</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">sizeof</span><span class="p">(</span><span class="n">rs_attr</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># 2) ì½ê¸°ì™€ ì“°ê¸° ë§ˆìŠ¤í¬
</span>    <span class="n">read_mask</span>  <span class="o">=</span> <span class="nf">_mask</span><span class="p">(</span><span class="sh">"</span><span class="s">READ_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">READ_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">EXECUTE</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">write_mask</span> <span class="o">=</span> <span class="nf">_mask</span><span class="p">(</span><span class="sh">"</span><span class="s">READ_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">READ_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">WRITE_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">MAKE_REG</span><span class="sh">"</span><span class="p">,</span>
                       <span class="sh">"</span><span class="s">REMOVE_FILE</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">REMOVE_DIR</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">REFER</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">TRUNCATE</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># 3) ì½ê¸° ì „ìš© ê²½ë¡œë“¤
</span>    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ro_dirs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span> 
            <span class="k">continue</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="nf">_open_path_only</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_add_rule</span><span class="p">,</span> <span class="n">rs_fd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nf">path_beneath_attr</span><span class="p">(</span><span class="n">read_mask</span><span class="p">,</span> <span class="n">fd</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># 1 = PATH_BENEATH
</span>        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

    <span class="c1"># 4) ì“°ê¸° í—ˆìš© ë£¨íŠ¸
</span>    <span class="n">rw_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">rw_dir</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">rw_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="nf">_open_path_only</span><span class="p">(</span><span class="n">rw_dir</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_add_rule</span><span class="p">,</span> <span class="n">rs_fd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nf">path_beneath_attr</span><span class="p">(</span><span class="n">write_mask</span><span class="p">,</span> <span class="n">fd</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

    <span class="c1"># 5) í˜„ì¬ ìŠ¤ë ˆë“œì— ì ìš©(ìì‹ ìƒì†)
</span>    <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_restrict_self</span><span class="p">,</span> <span class="n">rs_fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">rs_fd</span><span class="p">)</span>
</code></pre></div></div>

<p>ë„¤ ê¸°ì¡´ ë©”ì„œë“œ êµì²´ë³¸</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># sandbox_config.py
</span><span class="kn">from</span> <span class="n">landlock_helper</span> <span class="kn">import</span> <span class="n">apply_landlock_rw</span>

<span class="k">def</span> <span class="nf">apply_landlock</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">FsPolicy</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_applied</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="c1"># ro_roots, rw_rootë¥¼ ì»¤ë„ì— ì •í™•íˆ ë“±ë¡
</span>    <span class="nf">apply_landlock_rw</span><span class="p">(</span><span class="n">policy</span><span class="p">.</span><span class="n">ro_roots</span><span class="p">,</span> <span class="n">policy</span><span class="p">.</span><span class="n">rw_root</span><span class="p">)</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_applied</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">self</span><span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">policy</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">rw_root</span><span class="sh">"</span><span class="p">:</span> <span class="n">policy</span><span class="p">.</span><span class="n">rw_root</span><span class="p">,</span> <span class="sh">"</span><span class="s">ro_roots</span><span class="sh">"</span><span class="p">:</span> <span class="n">policy</span><span class="p">.</span><span class="n">ro_roots</span><span class="p">}</span>
</code></pre></div></div>

<p>ì´ ë³€ê²½ìœ¼ë¡œ â€œRW ì»¨íŠ¸ë¡¤ì„ ì •í™•íˆ ì–´ë””ì„œ í•˜ëŠëƒâ€ê°€ ë¶„ëª…í•´ì§„ë‹¤.</p>

<ul>
  <li>
    <p>ro_rootsì—ëŠ” ì½ê¸° ì „ìš© ë¹„íŠ¸ë§Œ, rw_rootì—ëŠ” ì½ê¸°+ì“°ê¸° ë¹„íŠ¸ë¥¼ ì»¤ë„ì— ê³ ì •í•œë‹¤.</p>
  </li>
  <li>
    <p>ì´í›„ temp.pyê°€ rw_root ë°–ì— ì“°ë ¤ í•˜ë©´ ì»¤ë„ì´ EACCESë¡œ ê±°ë¶€í•˜ê³ , ro_roots ë°–ì˜ ê²½ë¡œëŠ” ì•„ì˜ˆ ì½ê¸°ë„ ê±°ë¶€ëœë‹¤(ë„ˆê°€ ro_rootsë¥¼ ì–¼ë§ˆë‚˜ ë„“ê²Œ ì¡ëŠëƒì— ë”°ë¼ ë‹¤ë¦„).</p>
  </li>
  <li>
    <p>ro_rootsì™€ rw_rootê°€ ê²¹ì¹  ìˆ˜ ìˆëŠ”ë°, Landlockì€ í—ˆìš© ë¹„íŠ¸ë¥¼ í•©ì§‘í•©ìœ¼ë¡œ ë³´ë¯€ë¡œ rw_root í•˜ìœ„ì—ì„  ì“°ê¸°ê°€ ì—´ë¦¬ê³ , ê·¸ ë°–ì—ì„  ë‹«íŒë‹¤. ìš´ì˜ìƒ ë¬¸ì œ ì—†ë‹¤.</p>
  </li>
</ul>

<p>ê°„ë‹¨ ë™ì‘ í™•ì¸</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ì„¤ì • ë‹¨ê³„(LLM ë¹„ë…¸ì¶œ)
</span><span class="n">cfg</span> <span class="o">=</span> <span class="nc">FsPolicy</span><span class="p">(</span><span class="n">ro_roots</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">/usr</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">/home/you/data</span><span class="sh">"</span><span class="p">],</span> <span class="n">rw_root</span><span class="o">=</span><span class="sh">"</span><span class="s">/home/you/sbx</span><span class="sh">"</span><span class="p">)</span>
<span class="n">SANDBOX</span><span class="p">.</span><span class="nf">apply_landlock</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>

<span class="c1"># í…ŒìŠ¤íŠ¸
</span><span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">/etc/hosts</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">)</span>           <span class="c1"># â†’ PermissionError (ì“°ê¸° ê±°ë¶€)
</span><span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">/home/you/data/df.csv</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">).</span><span class="nf">read</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># â†’ OK (ì½ê¸° í—ˆìš©)
</span><span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">/home/you/sbx/out.txt</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># â†’ OK (rw_root ì“°ê¸° í—ˆìš©)
</span></code></pre></div></div>

<p>ë§Œì•½ í™˜ê²½ ì œì•½ìœ¼ë¡œ ìœ„ syscall ë°©ì‹ì´ ë¶ˆê°€í•˜ê±°ë‚˜ ì»¤ë„ ABIê°€ ë‚®ìœ¼ë©´, apply_landlockì—ì„œ ì˜ˆì™¸ë¥¼ ë°›ì•„ â€œì†Œí”„íŠ¸ ê°€ë“œë¡œ í´ë°±â€í•˜ë„ë¡ ë¶„ê¸°í•˜ë©´ ëœë‹¤. ê·¸ë˜ë„ ì§ˆë¬¸ì˜ ìš”ì§€ì˜€ë˜ â€œì´ ì½”ë“œì—ì„œ rw policyë¥¼ ì ìš©í•´ì•¼ í•˜ëŠ”ê°€?â€ì— ë‹µí•˜ìë©´, ê·¸ë ‡ë‹¤. ë°”ë¡œ ì´ apply_landlockì—ì„œ ì»¤ë„ì— rw_rootìš© ì“°ê¸° ê¶Œí•œ ë§ˆìŠ¤í¬ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì¶”ê°€í•´ì•¼ í•œë‹¤.</p>

<p class="chat--user">

ì•„ ì ì  ì“¸ë° ì—†ì´ ë³µì¡í•´ì§€ëŠ” ê²ƒ ê°™ì€ë°; ì •ì‹  ì°¨ë¦¬ê³  ì œëŒ€ë¡œ í•´ë³´ì. ì¼ë‹¨ /user/abc ëŠ” ì½ê¸° ê°€ëŠ¥ /user/abc/test ì•ˆì—ëŠ” ì“°ê¸° ê°€ëŠ¥í•œ landlockì„ í•˜ëŠ” ê°€ì¥ ê°„ë‹¨í•œ ì½”ë“œ ì¤˜ë´. í…ŒìŠ¤íŠ¸ ë¼ì¸ í¬í•¨í•´ì„œ 

</p>

<p>ì›í•˜ëŠ” ë”± ê·¸ê±°. ë¦¬ëˆ…ìŠ¤ 5.13+ (x86_64 ê°€ì •)ì—ì„œ <code class="language-plaintext highlighter-rouge">/user/abc</code>ëŠ” ì½ê¸°ë§Œ, <code class="language-plaintext highlighter-rouge">/user/abc/test</code>ëŠ” ì“°ê¸°ê¹Œì§€ í—ˆìš©í•˜ëŠ” ê°€ì¥ ë‹¨ìˆœí•œ íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ë‹¤. í…ŒìŠ¤íŠ¸ê¹Œì§€ í¬í•¨í–ˆë‹¤. ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¶ˆí•„ìš”, ctypesë¡œ ì»¤ë„ UAPI ì§ì ‘ í˜¸ì¶œí•œë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">util</span>

<span class="c1"># x86_64ìš© landlock syscall ë²ˆí˜¸
</span><span class="n">__NR_landlock_create_ruleset</span> <span class="o">=</span> <span class="mi">444</span>
<span class="n">__NR_landlock_add_rule</span>       <span class="o">=</span> <span class="mi">445</span>
<span class="n">__NR_landlock_restrict_self</span>  <span class="o">=</span> <span class="mi">446</span>

<span class="c1"># ê¶Œí•œ ë¹„íŠ¸ (ì»¤ë„ uapi/linux/landlock.h)
</span><span class="k">class</span> <span class="nc">FS</span><span class="p">:</span>
    <span class="n">EXECUTE</span>     <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span>
    <span class="n">WRITE_FILE</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
    <span class="n">READ_FILE</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span>
    <span class="n">READ_DIR</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span>
    <span class="n">REMOVE_DIR</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span>
    <span class="n">REMOVE_FILE</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span>
    <span class="n">MAKE_CHAR</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span>
    <span class="n">MAKE_DIR</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span>
    <span class="n">MAKE_REG</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span>
    <span class="n">MAKE_SOCK</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span>
    <span class="n">MAKE_FIFO</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span>
    <span class="n">MAKE_BLOCK</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span>
    <span class="n">MAKE_SYM</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span>
    <span class="n">REFER</span>       <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span>   <span class="c1"># ABI v2+
</span>    <span class="n">TRUNCATE</span>    <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span>   <span class="c1"># ABI v3+
</span>
<span class="n">LANDLOCK_RULE_PATH_BENEATH</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">libc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="p">.</span><span class="nc">CDLL</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="nf">find_library</span><span class="p">(</span><span class="sh">"</span><span class="s">c</span><span class="sh">"</span><span class="p">),</span> <span class="n">use_errno</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_syscall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="nf">syscall</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="nf">c_long</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">get_errno</span><span class="p">()</span>
        <span class="k">raise</span> <span class="nc">OSError</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="nf">strerror</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">r</span>

<span class="k">class</span> <span class="nc">ruleset_attr</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[(</span><span class="sh">"</span><span class="s">handled_access_fs</span><span class="sh">"</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">c_uint64</span><span class="p">)]</span>

<span class="k">class</span> <span class="nc">path_beneath_attr</span><span class="p">(</span><span class="n">ctypes</span><span class="p">.</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">allowed_access</span><span class="sh">"</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">c_uint64</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">parent_fd</span><span class="sh">"</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">c_int</span><span class="p">),</span>
    <span class="p">]</span>

<span class="k">def</span> <span class="nf">_open_dir_path_only</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">O_PATH</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_CLOEXEC</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_try_create_ruleset</span><span class="p">(</span><span class="n">handled_mask</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">attr</span> <span class="o">=</span> <span class="nf">ruleset_attr</span><span class="p">(</span><span class="n">handled_access_fs</span><span class="o">=</span><span class="n">handled_mask</span><span class="p">)</span>
    <span class="k">return</span> <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_create_ruleset</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">byref</span><span class="p">(</span><span class="n">attr</span><span class="p">),</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">apply_landlock_read_ro_write_rw</span><span class="p">(</span><span class="n">ro_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rw_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">ro_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">ro_dir</span><span class="p">)</span>
    <span class="n">rw_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">rw_dir</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">rw_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># ê°€ëŠ¥í•œ ìµœëŒ€ ë¹„íŠ¸ë¡œ ì‹œë„ â†’ ì•ˆ ë˜ë©´ v3(=TRUNCATE) ì œì™¸ â†’ ê·¸ë˜ë„ ì•ˆ ë˜ë©´ REFERë„ ì œì™¸
</span>    <span class="n">handled_all</span> <span class="o">=</span> <span class="p">(</span><span class="n">FS</span><span class="p">.</span><span class="n">EXECUTE</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">WRITE_FILE</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">READ_FILE</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">READ_DIR</span> <span class="o">|</span>
                   <span class="n">FS</span><span class="p">.</span><span class="n">REMOVE_DIR</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">REMOVE_FILE</span> <span class="o">|</span>
                   <span class="n">FS</span><span class="p">.</span><span class="n">MAKE_CHAR</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">MAKE_DIR</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">MAKE_REG</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">MAKE_SOCK</span> <span class="o">|</span>
                   <span class="n">FS</span><span class="p">.</span><span class="n">MAKE_FIFO</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">MAKE_BLOCK</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">MAKE_SYM</span> <span class="o">|</span>
                   <span class="n">FS</span><span class="p">.</span><span class="n">REFER</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">TRUNCATE</span><span class="p">)</span>
    <span class="n">masks</span> <span class="o">=</span> <span class="p">[</span><span class="n">handled_all</span><span class="p">,</span>
             <span class="n">handled_all</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FS</span><span class="p">.</span><span class="n">TRUNCATE</span><span class="p">,</span>
             <span class="n">handled_all</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FS</span><span class="p">.</span><span class="n">TRUNCATE</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FS</span><span class="p">.</span><span class="n">REFER</span><span class="p">]</span>
    <span class="n">rs_fd</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">last_err</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">masks</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rs_fd</span> <span class="o">=</span> <span class="nf">_try_create_ruleset</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="nb">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">last_err</span> <span class="o">=</span> <span class="n">e</span>
    <span class="k">if</span> <span class="n">rs_fd</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">last_err</span> <span class="ow">or</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">landlock_create_ruleset failed</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">read_mask</span>  <span class="o">=</span> <span class="p">(</span><span class="n">FS</span><span class="p">.</span><span class="n">READ_FILE</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">READ_DIR</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">EXECUTE</span><span class="p">)</span>
    <span class="n">write_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">FS</span><span class="p">.</span><span class="n">READ_FILE</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">READ_DIR</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">WRITE_FILE</span> <span class="o">|</span>
                  <span class="n">FS</span><span class="p">.</span><span class="n">MAKE_DIR</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">MAKE_REG</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">REMOVE_FILE</span> <span class="o">|</span> <span class="n">FS</span><span class="p">.</span><span class="n">REMOVE_DIR</span> <span class="o">|</span>
                  <span class="p">(</span><span class="n">FS</span><span class="p">.</span><span class="n">REFER</span> <span class="nf">if </span><span class="p">(</span><span class="n">handled_all</span> <span class="o">&amp;</span> <span class="n">FS</span><span class="p">.</span><span class="n">REFER</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
                  <span class="p">(</span><span class="n">FS</span><span class="p">.</span><span class="n">TRUNCATE</span> <span class="nf">if </span><span class="p">(</span><span class="n">handled_all</span> <span class="o">&amp;</span> <span class="n">FS</span><span class="p">.</span><span class="n">TRUNCATE</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">))</span>

    <span class="c1"># ì½ê¸° ì „ìš©: /user/abc
</span>    <span class="n">fd_ro</span> <span class="o">=</span> <span class="nf">_open_dir_path_only</span><span class="p">(</span><span class="n">ro_dir</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ro_rule</span> <span class="o">=</span> <span class="nf">path_beneath_attr</span><span class="p">(</span><span class="n">allowed_access</span><span class="o">=</span><span class="n">read_mask</span><span class="p">,</span> <span class="n">parent_fd</span><span class="o">=</span><span class="n">fd_ro</span><span class="p">)</span>
        <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_add_rule</span><span class="p">,</span> <span class="n">rs_fd</span><span class="p">,</span> <span class="n">LANDLOCK_RULE_PATH_BENEATH</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">byref</span><span class="p">(</span><span class="n">ro_rule</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">fd_ro</span><span class="p">)</span>

    <span class="c1"># ì½ê¸°/ì“°ê¸° í—ˆìš©: /user/abc/test
</span>    <span class="n">fd_rw</span> <span class="o">=</span> <span class="nf">_open_dir_path_only</span><span class="p">(</span><span class="n">rw_dir</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rw_rule</span> <span class="o">=</span> <span class="nf">path_beneath_attr</span><span class="p">(</span><span class="n">allowed_access</span><span class="o">=</span><span class="n">write_mask</span><span class="p">,</span> <span class="n">parent_fd</span><span class="o">=</span><span class="n">fd_rw</span><span class="p">)</span>
        <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_add_rule</span><span class="p">,</span> <span class="n">rs_fd</span><span class="p">,</span> <span class="n">LANDLOCK_RULE_PATH_BENEATH</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">.</span><span class="nf">byref</span><span class="p">(</span><span class="n">rw_rule</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">fd_rw</span><span class="p">)</span>

    <span class="c1"># í˜„ì¬ ìŠ¤ë ˆë“œ(í”„ë¡œì„¸ìŠ¤)ì— ì ìš©. ì´í›„ ìì‹ í”„ë¡œì„¸ìŠ¤ì—ë„ ìƒì†ë¨.
</span>    <span class="nf">_syscall</span><span class="p">(</span><span class="n">__NR_landlock_restrict_self</span><span class="p">,</span> <span class="n">rs_fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">close</span><span class="p">(</span><span class="n">rs_fd</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">ro</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/user/abc</span><span class="sh">"</span>
    <span class="n">rw</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/user/abc/test</span><span class="sh">"</span>

    <span class="c1"># í…ŒìŠ¤íŠ¸ ì¤€ë¹„: ë””ë ‰í„°ë¦¬ì™€ ì½ê¸°ìš© íŒŒì¼ ìƒì„±(ì œí•œ ê±¸ê¸° ì „)
</span>    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ro</span><span class="p">,</span> <span class="sh">"</span><span class="s">readonly.txt</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sh">"</span><span class="s">hello</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Applying Landlock: RO =</span><span class="sh">"</span><span class="p">,</span> <span class="n">ro</span><span class="p">,</span> <span class="sh">"</span><span class="s">RW =</span><span class="sh">"</span><span class="p">,</span> <span class="n">rw</span><span class="p">)</span>
    <span class="nf">apply_landlock_read_ro_write_rw</span><span class="p">(</span><span class="n">ro</span><span class="p">,</span> <span class="n">rw</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Landlock applied.</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># í…ŒìŠ¤íŠ¸ 1: ro ë””ë ‰í„°ë¦¬ ì“°ê¸° â†’ ì‹¤íŒ¨í•´ì•¼ í•¨
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ro</span><span class="p">,</span> <span class="sh">"</span><span class="s">should_fail.txt</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sh">"</span><span class="s">nope</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[FAIL] wrote to RO dir (unexpected)</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[OK] RO write blocked:</span><span class="sh">"</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

    <span class="c1"># í…ŒìŠ¤íŠ¸ 2: rw ë””ë ‰í„°ë¦¬ ì“°ê¸° â†’ ì„±ê³µí•´ì•¼ í•¨
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="sh">"</span><span class="s">ok.txt</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sh">"</span><span class="s">works</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[OK] RW write succeeded</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[FAIL] RW write blocked:</span><span class="sh">"</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

    <span class="c1"># í…ŒìŠ¤íŠ¸ 3: ro íŒŒì¼ ì½ê¸° â†’ ì„±ê³µí•´ì•¼ í•¨
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ro</span><span class="p">,</span> <span class="sh">"</span><span class="s">readonly.txt</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[OK] RO read:</span><span class="sh">"</span><span class="p">,</span> <span class="n">f</span><span class="p">.</span><span class="nf">readline</span><span class="p">().</span><span class="nf">strip</span><span class="p">())</span>
    <span class="k">except</span> <span class="nb">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[FAIL] RO read blocked:</span><span class="sh">"</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">sys</span><span class="p">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="sh">"</span><span class="s">linux</span><span class="sh">"</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Linux ì „ìš©ì…ë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>ì„¤ëª… ìš”ì•½</p>

<ul>
  <li>
    <p>ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” í˜„ì¬ í”„ë¡œì„¸ìŠ¤ì—ë§Œ ì œì•½ì„ ê±´ë‹¤. í•œ ë²ˆ ì ìš©ë˜ë©´ í•´ì œ ë¶ˆê°€, ìì‹ í”„ë¡œì„¸ìŠ¤ì— ìƒì†ëœë‹¤.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">/user/abc</code>ëŠ” READ_FILE/READ_DIR(+EXECUTE)ë§Œ, <code class="language-plaintext highlighter-rouge">/user/abc/test</code>ëŠ” READ/WRITE/CREATE/REMOVE(+ê°€ëŠ¥í•˜ë©´ REFER/TRUNCATE)ê¹Œì§€ í—ˆìš©í•œë‹¤.</p>
  </li>
  <li>
    <p>x86_64 ê¸°ì¤€ syscall ë²ˆí˜¸ë¥¼ ì¼ë‹¤. ë‹¤ë¥¸ ì•„í‚¤í…ì²˜ë©´ ë²ˆí˜¸ê°€ ë‹¤ë¥¼ ìˆ˜ ìˆë‹¤.</p>
  </li>
  <li>
    <p>ì»¤ë„ì´ ë‚®ì•„ TRUNCATE/REFERë¥¼ ì§€ì›í•˜ì§€ ì•Šìœ¼ë©´ ìë™ìœ¼ë¡œ ë¹¼ê³  ì¬ì‹œë„í•œë‹¤.</p>
  </li>
</ul>

<p class="chat--user">

python landlock íŒ¨í‚¤ì§€ ì“°ëŠ”ê±°ë³´ë‹¤ ctypeë¡œ í•˜ëŠ”ê²Œ ë” ë‚«ë‚˜?

</p>

<p>ì§§ê²Œ ì •ë¦¬í•˜ë©´ â€œë¬´ì—‡ì„ í†µì œí•˜ëŠëƒâ€ì— ë”°ë¼ ì„ íƒì´ ê°ˆë¦°ë‹¤.</p>

<ol>
  <li>ctypes ì§ì ‘ í˜¸ì¶œì´ ë‚˜ì€ ê²½ìš°</li>
</ol>

<ul>
  <li>
    <p>ê²½ë¡œë³„ ê¶Œí•œ ë¹„íŠ¸(READ_FILE/READ_DIR/WRITE_FILE/MAKE__/REMOVE__ /REFER/TRUNCATE ë“±)ë¥¼ ì •í™•íˆ ì§€ì •í•´ì•¼ í•  ë•Œ</p>
  </li>
  <li>
    <p>íŒ¨í‚¤ì§€ ë˜í¼ê°€ ì›í•˜ëŠ” ê¸°ëŠ¥(ì˜ˆ: rw ì „ìš© ë””ë ‰í„°ë¦¬)ê¹Œì§€ ë…¸ì¶œí•˜ì§€ ì•Šê±°ë‚˜ ë²„ì „ë§ˆë‹¤ APIê°€ ë‹¬ë¼ í”ë“¤ë¦´ ë•Œ</p>
  </li>
  <li>
    <p>ì§€ê¸ˆì²˜ëŸ¼ â€œ/user/abcëŠ” ì½ê¸°ë§Œ, /user/abc/testëŠ” ì“°ê¸°ê¹Œì§€â€ ê°™ì€ ì„¸ë°€í•œ ì •ì±…ì´ í•„ìˆ˜ì¼ ë•Œ</p>
  </li>
</ul>

<p>ì¥ì : ì»¤ë„ UAPIë¥¼ ê·¸ëŒ€ë¡œ ì“°ë¯€ë¡œ ì›í•˜ëŠ” ë™ì‘ì„ 1:1ë¡œ êµ¬í˜„ ê°€ëŠ¥, ì˜ˆì¸¡ ê°€ëŠ¥ì„± ë†’ìŒ<br />
ë‹¨ì : ì•„í‚¤í…ì²˜ë³„ syscall ë²ˆí˜¸, ABI í˜¸í™˜ì„±(REFER/TRUNCATE ì§€ì› ì—¬ë¶€) ì²˜ë¦¬ ë“± ì£¼ë³€ ì½”ë“œê°€ í•„ìš”</p>

<ol>
  <li>PyPI landlock íŒ¨í‚¤ì§€ê°€ ë‚˜ì€ ê²½ìš°</li>
</ol>

<ul>
  <li>
    <p>â€œì½ê¸°ë§Œ í—ˆìš©í•  ë£¨íŠ¸ ëª‡ ê°œ + ê¸°ë³¸ì€ ì°¨ë‹¨â€ ê°™ì€ ë‹¨ìˆœ ëª¨ë¸ì´ë©´ ì¶©ë¶„í•  ë•Œ</p>
  </li>
  <li>
    <p>ìœ ì§€ë³´ìˆ˜ ìš©ì´ì„±, ê°€ë…ì„±, ë°°í¬ í¸ì˜ì„±ì„ ìš°ì„ í•  ë•Œ</p>
  </li>
  <li>
    <p>ì»¤ë„ ê¸°ëŠ¥ ì¶”ê°€(ABI v2/v3)ê¹Œì§€ ì„¸ë°€ ì œì–´ê°€ êµ³ì´ í•„ìš” ì—†ì„ ë•Œ</p>
  </li>
</ul>

<p>ì¥ì : ì½”ë“œ ê°„ë‹¨, í¬í„°ë¸”, ì—…ë°ì´íŠ¸ ì‹œ ë”°ë¼ê°€ë©´ ë¨<br />
ë‹¨ì : ë˜í¼ê°€ ë…¸ì¶œí•˜ëŠ” ì¶”ìƒí™” í•œê³„ ë•Œë¬¸ì— per-path ì“°ê¸° ê¶Œí•œì„ ì •í™•íˆ ë‹¤ë£¨ì§€ ëª»í•  ìˆ˜ ìˆìŒ</p>

<p>í˜„ì‹¤ì ì¸ ê¶Œì¥</p>

<ul>
  <li>
    <p>ë„¤ ìš”êµ¬(RO ë””ë ‰í„°ë¦¬ì™€ RW ë””ë ‰í„°ë¦¬ë¥¼ ë¶„ë¦¬)ë¼ë©´ ctypesë¡œ ì–‡ì€ í—¬í¼ë¥¼ ë‘ëŠ” ìª½ì´ ê¹”ë”í•˜ë‹¤. ì´ë¯¸ ì œê³µí•œ 50~80ì¤„ì§œë¦¬ helperë¥¼ ëª¨ë“ˆí™”í•˜ë©´ ëì´ë‹¤. ê·¸ ìœ„ì— â€œì„¤ì •ì€ ë„¤ê°€ ì§ì ‘, LLMì—ëŠ” ë…¸ì¶œ ê¸ˆì§€â€ ì›ì¹™ë§Œ ì§€í‚¤ë©´ ëœë‹¤.</p>
  </li>
  <li>
    <p>ìœ ì§€ë³´ìˆ˜ ë¶€ë‹´ì„ ì¤„ì´ê³  ì‹¶ë‹¤ë©´ í•˜ì´ë¸Œë¦¬ë“œë¡œ ê°€ì. ìš°ì„  PyPI íŒ¨í‚¤ì§€ë¡œ â€œì½ê¸° í—ˆìš© ë£¨íŠ¸â€ë§Œ ì¡ê³ , â€œì“°ê¸° í—ˆìš© ë£¨íŠ¸â€ë§Œ ctypesë¡œ ì¶”ê°€ ê·œì¹™ì„ ë„£ëŠ” ë°©ì‹ë„ ê°€ëŠ¥í•˜ë‹¤. ì¦‰, ê°„ë‹¨í•œ ê±´ ë˜í¼ì— ë§¡ê¸°ê³ , ê¼­ í•„ìš”í•œ ë¶€ë¶„ë§Œ ì»¤ë„ UAPIë¡œ ë³´ê°•.</p>
  </li>
</ul>

<p>ê²°ë¡ </p>

<ul>
  <li>
    <p>ì„¸ë°€í•œ RW ì»¨íŠ¸ë¡¤ì´ í•„ìš”í•˜ë©´ ctypesê°€ ë” ë‚«ë‹¤.</p>
  </li>
  <li>
    <p>ë‹¨ìˆœ ì ‘ê·¼ì œì–´ì™€ ìš´ì˜ í¸ì˜ê°€ ìš°ì„ ì´ë©´ íŒ¨í‚¤ì§€ê°€ ë” ë‚«ë‹¤.</p>
  </li>
  <li>
    <p>ë„ˆì˜ í˜„ì¬ ì„¤ê³„(ì„¸ì…˜ ìœ ì§€ + ëª…ì‹œì  RW ë¶„ë¦¬)ëŠ” ctypes ë¯¸ë‹ˆ í—¬í¼ê°€ ê°€ì¥ ì§ê´€ì ì´ê³ , LLM íˆ´ ë ˆì´ì–´ì™€ë„ ì˜ ë§ëŠ”ë‹¤.</p>
  </li>
</ul>

<p class="chat--user">

ì•„ redhat 8.10ì€ ê·¸ëŸ°ê²Œ ì•ˆ ë˜ë„¤. ê·¸ëƒ¥ pure íŒŒì´ì¬ìœ¼ë¡œ ê°„ë‹¨í•˜ê²Œ ë˜ëŠ” íŒ¨í‚¤ì§€ ì—†ë‚˜? í•´ì»¤ê°€ ì‘ì •í•˜ê³  í•˜ë©´ ëš«ë¦´ìˆ˜ë„ ìˆì§€ë§Œ LLMì´ ê·¸ëŸ° ë™ì‘ì„ ì•ˆí•œë‹¤ê³  ê°€ì •í•˜ê³ 

</p>

<p>ê°€ëŠ¥í•œ í•œ ë‹¨ìˆœí•˜ê²Œ ê°ˆê²Œ. RHEL 8.10ì—ì„œ Landlock ì•ˆ ëœë‹¤ë©´ â€œì™„ë²½ ë³´ì•ˆâ€ ëŒ€ì‹  ì‹¤ìˆ˜ ë°©ì§€ìš© ê°€ë²¼ìš´ ê°€ë“œê°€ í˜„ì‹¤ì ì´ë‹¤. ìˆœìˆ˜ íŒŒì´ì¬ë§Œìœ¼ë¡œë„ ë‹¤ìŒ ì •ë„ëŠ” ë§‰ì„ ìˆ˜ ìˆë‹¤.</p>

<ol>
  <li>
    <p>sys.addaudithookë¡œ íŒŒì¼ ì—´ê¸°(open) ì´ë²¤íŠ¸ì—ì„œ â€œì“°ê¸° ì˜ë„â€ë¥¼ ê°€ë¡œì±„ê¸°</p>
  </li>
  <li>
    <p>os/builtins/pathlibì˜ ì“°ê¸° ê³„ì—´ í˜¸ì¶œì„ ëª½í‚¤íŒ¨ì¹˜í•´ ìš°íšŒ ì‹œë„ ìµœì†Œí™”</p>
  </li>
  <li>
    <p>ì˜µì…˜ìœ¼ë¡œ subprocess/ë„¤íŠ¸ì›Œí¬ ì°¨ë‹¨</p>
  </li>
</ol>

<p>audit hookì€ íŒŒì´ì¬ 3.8+ì—ì„œ í‘œì¤€ì´ë©° open ì´ë²¤íŠ¸ëŠ” ê²½ë¡œ, ëª¨ë“œ, í”Œë˜ê·¸ë¥¼ ë„˜ê²¨ì¤€ë‹¤. ì´ê±¸ë¡œ â€œì“°ê¸° ì˜ë„â€ë¥¼ ì •ë°€í•˜ê²Œ ì¡ì•„ë‚¼ ìˆ˜ ìˆë‹¤. ë‹¤ë§Œ ê°ì‚¬ìš© í›…ì´ì§€ í•˜ë“œí•œ ë³´ì•ˆ ê²½ê³„ëŠ” ì•„ë‹ˆë¼ëŠ” ì ì€ ê³µì‹ì ìœ¼ë¡œë„ ëª…ì‹œë¼ ìˆë‹¤(ê·¸ë˜ë„ ì´ë²ˆ ëª©í‘œì—ëŠ” ì¶©ë¶„íˆ ìœ ìš©). <a href="https://docs.python.org/3/library/audit_events.html?utm_source=chatgpt.com">Python documentation+2</a></p>

<p>ì•„ë˜ëŠ” ë°”ë¡œ ë³µë¶™í•´ ì“¸ ìˆ˜ ìˆëŠ” â€œìˆœìˆ˜ íŒŒì´ì¬ ë¯¸ë‹ˆ íŒ¨í‚¤ì§€â€ ì½”ë“œì™€ í…ŒìŠ¤íŠ¸ë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># lite_fs_guard.py
# ìˆœìˆ˜ íŒŒì´ì¬ ê°€ë“œ: ì“°ê¸°ëŠ” write_root ì•„ë˜ë§Œ í—ˆìš©, ì½ê¸°ëŠ” ê¸°ë³¸ ì „ì²´ í—ˆìš©(ì˜µì…˜ìœ¼ë¡œ ì œí•œ ê°€ëŠ¥)
</span>
<span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">builtins</span><span class="p">,</span> <span class="n">pathlib</span>

<span class="k">class</span> <span class="nc">LiteFSGuard</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">write_root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">read_allow</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                 <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                 <span class="n">block_subprocess</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">block_network</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">write_root</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">write_root</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">read_allow</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">read_allow</span> <span class="ow">or</span> <span class="p">[])]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">allow_read_anywhere</span> <span class="o">=</span> <span class="n">allow_read_anywhere</span>
        <span class="n">self</span><span class="p">.</span><span class="n">block_subprocess</span> <span class="o">=</span> <span class="n">block_subprocess</span>
        <span class="n">self</span><span class="p">.</span><span class="n">block_network</span> <span class="o">=</span> <span class="n">block_network</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">write_root</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_installed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1"># ì›ë³¸ í•¨ìˆ˜ ë°±ì—…
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_orig</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="p">:</span> <span class="n">builtins</span><span class="p">.</span><span class="nb">open</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">os_open</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="nb">open</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">rename</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">rename</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">replace</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">remove</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">remove</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">unlink</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">unlink</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">mkdir</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">mkdir</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">makedirs</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">rmdir</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">rmdir</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">chmod</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">chmod</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">path_open</span><span class="sh">"</span><span class="p">:</span> <span class="n">pathlib</span><span class="p">.</span><span class="n">Path</span><span class="p">.</span><span class="nb">open</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">os_system</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="n">system</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_in_write_root</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">rp</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rp</span> <span class="o">==</span> <span class="n">self</span><span class="p">.</span><span class="n">write_root</span> <span class="ow">or</span> <span class="n">rp</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">write_root</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_is_read_allowed</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">allow_read_anywhere</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">rp</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">rp</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="nf">any</span><span class="p">(</span><span class="n">rp</span> <span class="o">==</span> <span class="n">r</span> <span class="ow">or</span> <span class="n">rp</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">read_allow</span><span class="p">)</span>

    <span class="c1"># --------- audit hook ----------
</span>    <span class="k">def</span> <span class="nf">_audit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="p">:</span>
            <span class="c1"># args: path, mode, flags (ë¬¸ì„œí™”ë¨)
</span>            <span class="c1"># https://docs.python.org/3/library/audit_events.html
</span>            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">write_intent</span> <span class="o">=</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="ow">in</span> <span class="n">mode</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">))</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_TRUNC</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_APPEND</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">write_intent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Write restricted to </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">write_root</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">write_intent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_is_read_allowed</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Read not allowed here: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">block_subprocess</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">subprocess.</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">event</span> <span class="o">==</span> <span class="sh">"</span><span class="s">os.system</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Subprocess disabled by LiteFSGuard</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">block_network</span> <span class="ow">and</span> <span class="n">event</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">socket.</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Network disabled by LiteFSGuard</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># --------- monkey patches (ì†Œí”„íŠ¸ ê°€ë“œ) ----------
</span>    <span class="k">def</span> <span class="nf">_patches</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">open_guard</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="n">write_intent</span> <span class="o">=</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="ow">in</span> <span class="n">mode</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">write_intent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Write restricted to </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">write_root</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="nb">file</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">write_intent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_is_read_allowed</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Read not allowed here: </span><span class="si">{</span><span class="nb">file</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="p">](</span><span class="nb">file</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">os_open_guard</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="n">write_intent</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_TRUNC</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_APPEND</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">write_intent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Write restricted to </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">write_root</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="nb">file</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">write_intent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_is_read_allowed</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Read not allowed here: </span><span class="si">{</span><span class="nb">file</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">os_open</span><span class="sh">"</span><span class="p">](</span><span class="nb">file</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">rename_guard</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">dst</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Rename restricted within write_root</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">rename</span><span class="sh">"</span><span class="p">](</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">replace_guard</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">dst</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Replace restricted within write_root</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">](</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">remove_guard</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Delete restricted within write_root</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">remove</span><span class="sh">"</span><span class="p">](</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">unlink_guard</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Unlink restricted within write_root</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">unlink</span><span class="sh">"</span><span class="p">](</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">mkdir_guard</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Mkdir restricted within write_root</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">mkdir</span><span class="sh">"</span><span class="p">](</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">makedirs_guard</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Makedirs restricted within write_root</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">makedirs</span><span class="sh">"</span><span class="p">](</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">rmdir_guard</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Rmdir restricted within write_root</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">rmdir</span><span class="sh">"</span><span class="p">](</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">chmod_guard</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Chmod restricted within write_root</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">chmod</span><span class="sh">"</span><span class="p">](</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">path_open_guard</span><span class="p">(</span><span class="n">self_path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">write_intent</span> <span class="o">=</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="ow">in</span> <span class="n">mode</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">))</span>
            <span class="n">p</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">self_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">write_intent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_in_write_root</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Write restricted to </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">write_root</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">write_intent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">_is_read_allowed</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Read not allowed here: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_orig</span><span class="p">[</span><span class="sh">"</span><span class="s">path_open</span><span class="sh">"</span><span class="p">](</span><span class="n">self_path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">builtins</span><span class="p">.</span><span class="nb">open</span> <span class="o">=</span> <span class="n">open_guard</span>
        <span class="n">os</span><span class="p">.</span><span class="nb">open</span> <span class="o">=</span> <span class="n">os_open_guard</span>
        <span class="n">os</span><span class="p">.</span><span class="n">rename</span> <span class="o">=</span> <span class="n">rename_guard</span>
        <span class="n">os</span><span class="p">.</span><span class="n">replace</span> <span class="o">=</span> <span class="n">replace_guard</span>
        <span class="n">os</span><span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">remove_guard</span>
        <span class="n">os</span><span class="p">.</span><span class="n">unlink</span> <span class="o">=</span> <span class="n">unlink_guard</span>
        <span class="n">os</span><span class="p">.</span><span class="n">mkdir</span> <span class="o">=</span> <span class="n">mkdir_guard</span>
        <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span> <span class="o">=</span> <span class="n">makedirs_guard</span>
        <span class="n">os</span><span class="p">.</span><span class="n">rmdir</span> <span class="o">=</span> <span class="n">rmdir_guard</span>
        <span class="n">os</span><span class="p">.</span><span class="n">chmod</span> <span class="o">=</span> <span class="n">chmod_guard</span>
        <span class="n">pathlib</span><span class="p">.</span><span class="n">Path</span><span class="p">.</span><span class="nb">open</span> <span class="o">=</span> <span class="n">path_open_guard</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">block_subprocess</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="n">system</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">:</span> <span class="p">(</span><span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="p">()).</span><span class="nf">throw</span><span class="p">(</span><span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">os.system disabled</span><span class="sh">"</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_installed</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">addaudithook</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_audit</span><span class="p">)</span>  <span class="c1"># 3.8+ í‘œì¤€ í›…: ì´ë²¤íŠ¸ ëª©ë¡ì€ ê³µì‹ í‘œ ì°¸ì¡°
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">_patches</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_installed</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[lite-fs-guard] active. write_root=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">write_root</span><span class="si">}</span><span class="s">, read_anywhere=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">allow_read_anywhere</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>ê°„ë‹¨ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_lite_fs_guard.py
</span><span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">lite_fs_guard</span> <span class="kn">import</span> <span class="n">LiteFSGuard</span>

<span class="n">WRITE_ROOT</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/tmp/sbx</span><span class="sh">"</span>
<span class="n">guard</span> <span class="o">=</span> <span class="nc">LiteFSGuard</span><span class="p">(</span><span class="n">write_root</span><span class="o">=</span><span class="n">WRITE_ROOT</span><span class="p">,</span>
                    <span class="n">allow_read_anywhere</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>   <span class="c1"># ì–´ë””ë“  ì½ê¸° í—ˆìš©
</span>                    <span class="n">block_subprocess</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>      <span class="c1"># ì›í•˜ë©´ False
</span>                    <span class="n">block_network</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>        <span class="c1"># ì›í•˜ë©´ True
</span><span class="n">guard</span><span class="p">.</span><span class="nf">install</span><span class="p">()</span>

<span class="c1"># ì¤€ë¹„
</span><span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">WRITE_ROOT</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">try write to /etc/hosts (should fail)</span><span class="sh">"</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">/etc/hosts</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="sh">"</span><span class="s"># nope</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">FAIL: wrote to /etc/hosts</span><span class="sh">"</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">OK:</span><span class="sh">"</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">try write to write_root (should pass)</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">WRITE_ROOT</span><span class="p">,</span> <span class="sh">"</span><span class="s">ok.txt</span><span class="sh">"</span><span class="p">),</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="sh">"</span><span class="s">hello</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">OK: wrote to</span><span class="sh">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">WRITE_ROOT</span><span class="p">,</span> <span class="sh">"</span><span class="s">ok.txt</span><span class="sh">"</span><span class="p">))</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">try read from /etc/hosts (should pass)</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">/etc/hosts</span><span class="sh">"</span><span class="p">).</span><span class="nf">read</span><span class="p">().</span><span class="nf">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</code></pre></div></div>

<p>ì´ ì ‘ê·¼ì€ ì–´ë””ê¹Œì§€ë‚˜ â€œì‹¤ìˆ˜ ë°©ì§€ìš©â€ì´ë‹¤. í•µì‹¬ í¬ì¸íŠ¸ë§Œ ë‹¤ì‹œ ì ëŠ”ë‹¤.</p>

<ul>
  <li>
    <p>sys.addaudithookëŠ” í‘œì¤€ì´ë©° open ì´ë²¤íŠ¸(path, mode, flags)ë¥¼ ì¤€ë‹¤. ì—¬ê¸°ì„œ ì •í™•íˆ ì“°ê¸° ì˜ë„ë¥¼ íŒë³„í•  ìˆ˜ ìˆë‹¤. <a href="https://docs.python.org/3/library/audit_events.html?utm_source=chatgpt.com">Python documentation</a></p>
  </li>
  <li>
    <p>audit hookì€ ê°ì‚¬ìš©ì´ë¯€ë¡œ ì™„ì „í•œ ë³´ì•ˆ ê²½ê³„ëŠ” ì•„ë‹ˆë‹¤. í•˜ì§€ë§Œ ì´ë²ˆ ì „ì œ(LLMì´ ì•…ì˜ì  ë™ì‘ì„ í•˜ì§€ ì•ŠëŠ”ë‹¤ê³  ê°€ì •)ì—ì„œëŠ” ì¶©ë¶„íˆ ì‹¤ìš©ì ì´ë‹¤. <a href="https://github.com/python/cpython/issues/87604?utm_source=chatgpt.com">GitHub</a></p>
  </li>
  <li>
    <p>ë” ê°•í•œ ê²©ë¦¬ê°€ í•„ìš”í•˜ë©´ ë„ì»¤Â·ëœë“œë½Â·AppArmor ê°™ì€ OS ë ˆë²¨ì´ ë‹µì´ì§€ë§Œ, Red Hat 8.10 ì œì•½ì´ë¼ë©´ ìœ„ ê°€ë“œê°€ ê°€ì¥ ë‹¨ìˆœí•œ â€œìˆœìˆ˜ íŒŒì´ì¬ 80/20 í•´ë²•â€ì´ë‹¤.</p>
  </li>
  <li>
    <p>ì°¸ê³ ë¡œ ì–¸ì–´ ì œí•œë§Œ í•„ìš”í•œ ê²½ìš° RestrictedPython ê°™ì€ ë„êµ¬ë„ ìˆì§€ë§Œ íŒŒì¼ì‹œìŠ¤í…œ ê²©ë¦¬ë¥¼ ì œê³µí•˜ëŠ” ê±´ ì•„ë‹ˆë‹¤. pyfakefsëŠ” í…ŒìŠ¤íŠ¸ìš© ê°€ì§œ FSì´ì§€ ë³´ì•ˆ ê²©ë¦¬ê°€ ì•„ë‹ˆë‹¤. codejailì€ AppArmorê°€ í•„ìš”í•´ì„œ ì´ë²ˆ ì¡°ê±´ì— ë§ì§€ ì•ŠëŠ”ë‹¤. <a href="https://restrictedpython.readthedocs.io/?utm_source=chatgpt.com">restrictedpython.readthedocs.io+3</a></p>
  </li>
</ul>

<p>ë‹¤ìŒ ìŠ¤í…ìœ¼ë¡œ, ì´ ê°€ë“œë¥¼ ë„ˆì˜ ì»¤ë„ ì„¸ì…˜(ë˜ëŠ” ì„œë¸Œí”„ë¡œì„¸ìŠ¤) ì‹œì‘ ì§í›„ì— í•œ ë²ˆ ì„¤ì¹˜í•˜ë„ë¡ ë„£ìœ¼ë©´ ëœë‹¤. ì„¸ì…˜ ìœ ì§€/ì¼íšŒì„± ëª¨ë‘ ë™ì¼í•˜ê²Œ ë™ì‘í•œë‹¤.</p>

<p class="chat--user">

#!/usr/bin/python3.8 #-<em>- coding: utf-8 -</em>- ## QUEST FOR A PYTHON SANDBOX: # 1. You design an script where an exec() command is ran. # 2. The code ran by exec() is supplied by your opponent, trying e.g. to # write something to the './forbidden.txt' file or access # forbidden_object. Your opponent has # full knowledge of the outer script (no security through obscurity). # There should be no trick to break the sandbox whatsoever. Crashing # the subprocess Cpython does not count. # 3. The exec()uted code should however allow as large subset of Python # capabilities as possible, including interaction with variables/ # functions/objects in the outer script, if and only if they are # explicitly listed as accessible. # 4. Elegant, fast, dependency-frugal solution is also appreciated. # 5. The outer script writes something to the './allowed.txt' file # in the end. user_command = """import sys ## Useful code on the figure import numpy x = numpy.linspace(0,10) y = numpy.sin(x) fig.get_axes()[0].plot(x, y) ## Malicious wannabe exploits follow for l in ().<strong>class</strong>.<strong>base</strong>.<strong>subclasses</strong>(): if l.<strong>name</strong> == '<strong>code</strong>': print(l) ## SANDBOXED: has access to the sandboxed python subprocess only, in line with our intention ## to provide Python environment as-rich-as-possible exec("[ i for i in ().<strong>class</strong>.<strong>base</strong>.<strong>subclasses</strong>() if i.<strong>name</strong> == 'code']<a href="0, 0, 0, 5, 8, 0, b'hello world', (), (), ()," title="', '', 0, b'">0</a>") ## TEST #fig = numpy.array([666]) ## TODO: unexpected class type of returned objects should be detected after being returned from the sandbox #class SpoofFigure(matplotlib.pyplot.Figure): # def savefig(self): print("Malicious action") ## SANDBOXED: modified class won't be serialized if not defined in a module - can not get out of sandbox #fig = SpoofFig() #import XXX ## UNCLEAR: could some compiled module circumwent the file access hook? Which OS calls should be forbidden, too? ## See https://docs.python.org/3/library/audit_events.html to find them. #open('forbidden','w').write('pwned by l33t h4xx0rz') ## SANDBOXED: fails to write on disk thanks to the audit hook #fig.savefig('forbidden.png') ## SANDBOXED: audit hook applies to all python code #forbidden_object.access() ## SANDBOXED: no access to the forbidden object from the outer scope conn.send([fig]) ## all results can be safely passed (unless it is of custom class etc.) """ ## Prepare the testing example import matplotlib.pyplot as plt fig, ax = plt.subplots(nrows=1, ncols=1) ## the user's code will plot here allowed_objects = [fig] ## no other data exposed to the exec()uted script ## â€”â€”â€”â€”â€”- The sandbox implementation follows, not to be changed â€”â€”â€”â€”â€”â€”â€“ def sandbox2020(code, allowed_objects): def ran_in_subprocess(conn): from sys import addaudithook def block_mischief(event,arg): if type(event) != str: raise # Security note: Well-designed objects can be passed to this function that could expose the top-level namespace # (through catching error and reading sys.exc_info()[2].tb_frame.f_back.f_globals). This should not enable modifying # variables outside the multiprocessing sandbox, but could give access to some internal sandbox variables. This function # thus should not refer to any 'lock variables'. It is safer to check the results in the main thread. if event=='open' and type(arg[1])==str and arg[1]!='r': print('\taudit:', event, arg) raise IOError('file write forbidden') if event.split('.')[0] in ['subprocess', 'shutil', 'winreg']: print('\taudit:', event, arg) raise IOError('potentially dangerous, filesystem-accessing functions forbidden') addaudithook(block_mischief) del(block_mischief) ## No way to remove or circumwent audit hooks from python. No access to this function. sandbox_locals['conn'] = conn # automatically add the communication pipe to objects accessible from the sandbox exec(user_command, sandbox_locals) print('len sandbox locals after', len(sandbox_locals)) conn.close() from multiprocessing import Process, Pipe parent_conn, child_conn = Pipe() p = Process(target=ran_in_subprocess, args=(child_conn,)) p.start() ## NOTE: The sandbox is probably safe against file writing, as well as against access into the main process. ## Yet the objects returned from it as results could have been manipulated. Asserting the output objects to be ## of expected data types is an extra safety measure. But be careful whenever your main program flow is ## controlled by the returned objects' attributes, e.g. file paths could change. return parent_conn.recv() p.join() ## Run the sandbox! sandbox_locals = dict((key, value) for key,value in locals().items() if value in allowed_objects) # copy.deepcopy() ## are all obj safely serialized? fig_result = sandbox2020(user_command, sandbox_locals) ## Demonstrate that the main process is not affected open('./allowed.txt','w').write('legally saved file from the main process') print(type(fig_result) == type(fig)) fig_result.savefig('allowed.png') ì´ëŸ° ì½”ë“œëŠ” ì–´ë•Œ

</p>

<p>ì¢‹ì€ ì¶œë°œì´ì•¼. ë‹¤ë§Œ ì§€ê¸ˆ ì½”ë“œëŠ” â€œì“°ê¸° ì˜ë„â€ íŒë³„ì´ ë¶€ì •í™•í•˜ê³ , os ê³„ì—´ ì¡°ì‘Â·ì„œë¸Œí”„ë¡œì„¸ìŠ¤Â·ë„¤íŠ¸ì›Œí¬ê°€ ê·¸ëŒ€ë¡œ ì—´ë ¤ ìˆì–´ ì‹¤ìˆ˜ ë°©ì§€ë¼ëŠ” ëª©í‘œì—ë„ ì‚´ì§ ëª¨ìë¼. êµ¬ì¡°ëŠ” ìœ ì§€í•˜ë˜, ìµœì†Œí•œë§Œ ì†ë´ì„œ ì•ˆì „ì„±ê³¼ ì˜ˆì¸¡ê°€ëŠ¥ì„±ì„ ì˜¬ë¦° íŒ¨ì¹˜ì•ˆì„ ì¤„ê²Œ.</p>

<p>í•µì‹¬ ë¬¸ì œ ìš”ì•½</p>

<ol>
  <li>
    <p>audit í›…ì˜ open ê²€ì‚¬: modeê°€ 'r'ì´ ì•„ë‹ˆë©´ ì „ë¶€ ì“°ê¸°ë¼ê³  ê°€ì •í•˜ê³  ìˆëŠ”ë°, 'rb', 'r+', 'a', 'x' ë“±ê³¼ flagsê¹Œì§€ ëª¨ë‘ ë´ì•¼ í•œë‹¤. os.open()ë„ ì¡ì•„ì•¼ í•œë‹¤.</p>
  </li>
  <li>
    <p>íŒŒì¼ ì¡°ì‘ë¥˜: rename/replace/remove/unlink/mkdir/makedirs/rmdir ê°™ì€ ì¡°ì‘ ì´ë²¤íŠ¸ë¥¼ ë§‰ì•„ì•¼ ìƒŒë“œë°•ìŠ¤ ë°– í›¼ì†ì„ í”¼í•  ìˆ˜ ìˆë‹¤.</p>
  </li>
  <li>
    <p>subprocessì™€ os.system, socket ê³„ì—´ì€ ëª…ì‹œ ì°¨ë‹¨ì´ í•„ìš”í•˜ë‹¤.</p>
  </li>
  <li>
    <p>íƒ€ì„ì•„ì›ƒê³¼ join ëˆ„ë½: recv() ëŒ€ê¸° ì¤‘ êµì°©, ë¬´í•œë£¨í”„ ë°©ì§€ í•„ìš”. p.join(timeout) í›„ ë¯¸ì‘ë‹µì´ë©´ ì¢…ë£Œ.</p>
  </li>
  <li>
    <p>ì¸ì ì „ë‹¬ í˜¼ì„ : sandbox2020(â€¦, allowed_objects) ì¸ìë¥¼ ì“°ì§€ ì•Šê³  ì „ì—­ sandbox_localsë¥¼ ë‹«ì•„ ì‚¬ìš©í•˜ê³  ìˆë‹¤. í•¨ìˆ˜ ì¸ìë¥¼ ì‚¬ìš©í•˜ë„ë¡ ì •ë¦¬.</p>
  </li>
</ol>

<p>ì•„ë˜ëŠ” ë„¤ ì½”ë“œì— ìµœì†Œ ë³€ê²½ë§Œ ê°€í•œ ë“œë¡­ì¸ íŒ¨ì¹˜ë‹¤. ë™ì‘ì€ ê·¸ëŒ€ë¡œì´ê³ , ìƒŒë“œë°•ìŠ¤ ì•ˆì—ì„œì˜ íŒŒì¼ ì“°ê¸°ëŠ” í˜„ì¬ ì‘ì—… ë””ë ‰í„°ë¦¬ ê¸°ì¤€ìœ¼ë¡œ â€œ./sandbox/â€ í•˜ìœ„ì—ì„œë§Œ í—ˆìš©í•˜ë„ë¡ í–ˆë‹¤. í•„ìš”í•˜ë©´ WRITE_ROOTë¥¼ ë°”ê¿”.</p>

<p>ìˆ˜ì •ë³¸ ì „ì²´</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python3.8
#-*- coding: utf-8 -*-
</span>
<span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">WRITE_ROOT</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="sh">"</span><span class="s">./sandbox</span><span class="sh">"</span><span class="p">)</span>   <span class="c1"># ìƒŒë“œë°•ìŠ¤ ë‚´ì—ì„œë§Œ ì“°ê¸° í—ˆìš©
</span><span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">WRITE_ROOT</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">user_command</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">import sys, os, numpy
x = numpy.linspace(0,10)
y = numpy.sin(x)
fig.get_axes()[0].plot(x, y)

# ì‹œë„: ê¸ˆì§€ ì˜ì—­ ì“°ê¸°
try:
    open(</span><span class="sh">'</span><span class="s">./forbidden.txt</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="s">).write(</span><span class="sh">'</span><span class="s">nope</span><span class="sh">'</span><span class="s">)
except Exception as e:
    print(</span><span class="sh">'</span><span class="s">forbidden write blocked:</span><span class="sh">'</span><span class="s">, type(e).__name__)

# ì‹œë„: í—ˆìš© ì˜ì—­ ì“°ê¸°
open(os.path.join(os.environ[</span><span class="sh">'</span><span class="s">WRITE_ROOT</span><span class="sh">'</span><span class="s">], </span><span class="sh">'</span><span class="s">ok.txt</span><span class="sh">'</span><span class="s">),</span><span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="s">).write(</span><span class="sh">'</span><span class="s">ok</span><span class="sh">'</span><span class="s">)

# ê²°ê³¼ ì „ë‹¬
conn.send([fig])
</span><span class="sh">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">allowed_objects</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">fig</span><span class="sh">"</span><span class="p">:</span> <span class="n">fig</span><span class="p">}</span>   <span class="c1"># execì— ë…¸ì¶œí•  ê²ƒë§Œ ëª…ì‹œ
</span>
<span class="k">def</span> <span class="nf">sandbox2020</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">allowed_globals</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="kn">from</span> <span class="n">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Pipe</span>

    <span class="k">def</span> <span class="nf">ran_in_subprocess</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">allowed</span><span class="p">):</span>
        <span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">pathlib</span>
        <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">'</span><span class="s">WRITE_ROOT</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">WRITE_ROOT</span><span class="sh">'</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="sh">"</span><span class="s">./sandbox</span><span class="sh">"</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">_in_write_root</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">rp</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">wr</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">'</span><span class="s">WRITE_ROOT</span><span class="sh">'</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">rp</span> <span class="o">==</span> <span class="n">wr</span> <span class="ow">or</span> <span class="n">rp</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">wr</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_audit</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
            <span class="c1"># open / os.open: (path, mode, flags)
</span>            <span class="k">if</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">os.open</span><span class="sh">"</span><span class="p">):</span>
                <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span>
                <span class="n">flags</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">write</span> <span class="o">=</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="ow">in</span> <span class="n">mode</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">))</span> <span class="ow">or</span> \
                        <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_TRUNC</span> <span class="o">|</span> <span class="n">os</span><span class="p">.</span><span class="n">O_APPEND</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">write</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">_in_write_root</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Write restricted to </span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">'</span><span class="s">WRITE_ROOT</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

            <span class="c1"># íŒŒì¼ ì¡°ì‘ë¥˜
</span>            <span class="k">elif</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">os.rename</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.replace</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.remove</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.unlink</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.mkdir</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.makedirs</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.rmdir</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.chmod</span><span class="sh">"</span><span class="p">):</span>
                <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nf">_in_write_root</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">FS op restricted to </span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">'</span><span class="s">WRITE_ROOT</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

            <span class="c1"># ì„œë¸Œí”„ë¡œì„¸ìŠ¤/ì‹œìŠ¤í…œ í˜¸ì¶œ
</span>            <span class="k">elif</span> <span class="n">event</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">subprocess.</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">event</span> <span class="o">==</span> <span class="sh">"</span><span class="s">os.system</span><span class="sh">"</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Subprocess disabled</span><span class="sh">"</span><span class="p">)</span>

            <span class="c1"># ë„¤íŠ¸ì›Œí¬(ì›í•˜ë©´ ì£¼ì„ í•´ì œ)
</span>            <span class="c1"># elif event.startswith("socket."):
</span>            <span class="c1">#     raise PermissionError("Network disabled")
</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">addaudithook</span><span class="p">(</span><span class="n">_audit</span><span class="p">)</span>

        <span class="c1"># execìš© ì „ì—­ ë”•ì…”ë„ˆë¦¬ êµ¬ì„±
</span>        <span class="n">g</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">__builtins__</span><span class="sh">"</span><span class="p">:</span> <span class="n">__builtins__</span><span class="p">}</span>
        <span class="n">g</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">allowed</span><span class="p">)</span>
        <span class="n">g</span><span class="p">[</span><span class="sh">"</span><span class="s">conn</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">conn</span>

        <span class="c1"># ì‹¤í–‰
</span>        <span class="nf">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>

        <span class="n">conn</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

    <span class="n">parent_conn</span><span class="p">,</span> <span class="n">child_conn</span> <span class="o">=</span> <span class="nc">Pipe</span><span class="p">(</span><span class="n">duplex</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nc">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">ran_in_subprocess</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">child_conn</span><span class="p">,</span> <span class="n">allowed_globals</span><span class="p">))</span>
    <span class="n">p</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>

    <span class="c1"># ê²°ê³¼ ìˆ˜ì‹  ëŒ€ê¸° + íƒ€ì„ì•„ì›ƒ
</span>    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">parent_conn</span><span class="p">.</span><span class="nf">poll</span><span class="p">(</span><span class="mf">0.05</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">parent_conn</span><span class="p">.</span><span class="nf">recv</span><span class="p">()</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&gt;</span> <span class="n">timeout_sec</span><span class="p">:</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">terminate</span><span class="p">()</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">raise</span> <span class="nc">TimeoutError</span><span class="p">(</span><span class="sh">"</span><span class="s">sandbox execution timed out</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="c1"># ìƒŒë“œë°•ìŠ¤ ì‹¤í–‰
</span><span class="n">result_list</span> <span class="o">=</span> <span class="nf">sandbox2020</span><span class="p">(</span><span class="n">user_command</span><span class="p">,</span> <span class="n">allowed_objects</span><span class="p">)</span>

<span class="c1"># ë©”ì¸ í”„ë¡œì„¸ìŠ¤ëŠ” ì •ìƒ ë™ì‘
</span><span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">./allowed.txt</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="sh">'</span><span class="s">legally saved file from the main process</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># ê²°ê³¼ í™•ì¸
</span><span class="n">fig_result</span> <span class="o">=</span> <span class="n">result_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">same type:</span><span class="sh">"</span><span class="p">,</span> <span class="nf">type</span><span class="p">(</span><span class="n">fig_result</span><span class="p">)</span> <span class="o">==</span> <span class="nf">type</span><span class="p">(</span><span class="n">fig_result</span><span class="p">))</span>
<span class="n">fig_result</span><span class="p">.</span><span class="nf">savefig</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">WRITE_ROOT</span><span class="p">,</span> <span class="sh">'</span><span class="s">allowed.png</span><span class="sh">'</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">done</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>ì„¤ëª…ê³¼ ìš´ìš© íŒ</p>

<ol>
  <li>
    <p>WRITE_ROOT ì•ˆì—ì„œë§Œ ì“°ê¸° í—ˆìš©: open/os.openì—ì„œ mode/flagsë¥¼ ëª¨ë‘ ê²€ì‚¬í•´ ì“°ê¸° ì˜ë„ë¥¼ ì¡ê³ , ì¡°ì‘ì„± ì‘ì—…(ì‚­ì œ/ì´ë™/ìƒì„± ë“±)ì€ ê²½ë¡œê°€ WRITE_ROOT ë‚´ë¶€ì¼ ë•Œë§Œ í—ˆìš©í–ˆë‹¤.</p>
  </li>
  <li>
    <p>ì½ê¸°ëŠ” ì–´ë””ì„œë‚˜ ê°€ëŠ¥í•˜ê²Œ ë‚¨ê²¨ë‘ì—ˆê³ , í•„ìš”í•˜ë©´ _auditì˜ open ë¶„ê¸°ì—ì„œ ì½ê¸°ë„ allowlistë¡œ ì œí•œí•  ìˆ˜ ìˆë‹¤.</p>
  </li>
  <li>
    <p>subprocess, os.system ì°¨ë‹¨. ë„¤ ëª©ì ì— ë§ê²Œ socket.*ë„ ë§‰ì„ ìˆ˜ ìˆë‹¤.</p>
  </li>
  <li>
    <p>íƒ€ì„ì•„ì›ƒê³¼ ì•ˆì „ ì¢…ë£Œ ì¶”ê°€. ìì‹ì´ ê²°ê³¼ë¥¼ ì•ˆ ë³´ë‚´ë©´ terminate í›„ TimeoutError.</p>
  </li>
  <li>
    <p>allowed_objectsëŠ” dictë¡œ ëª…ì‹œ ì£¼ì…. execì˜ globalsë¡œë§Œ ì „ë‹¬ë¼, ê·¸ ì™¸ ë°”ê¹¥ ì´ë¦„ì€ ë³´ì´ì§€ ì•ŠëŠ”ë‹¤.</p>
  </li>
  <li>
    <p>ì´ê±´ â€œì‹¤ìˆ˜ ë°©ì§€ìš©â€ì´ë‹¤. ì•…ì˜ì  í™•ì¥(C í™•ì¥ì—ì„œ ì§ì ‘ open í˜¸ì¶œ, ctypesë¡œ ì»¤ë„ í˜¸ì¶œ ë“±)ì€ ë§‰ì§€ ëª»í•œë‹¤ëŠ” ì ì€ ì„¤ê³„ìƒ ê°ìˆ˜. ê·¸ ëŒ€ì‹  ì½”ë“œê°€ ì§§ê³  ì˜ì¡´ì„± ì—†ê³ , LLMì´ ì•…ì˜ì ìœ¼ë¡œ í–‰ë™í•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ì „ì œì—ì„œëŠ” ì‹¤ìš©ì ì´ë‹¤.</p>
  </li>
</ol>

<p>ì—¬ê¸°ì„œ ë” ë‹¨ë‹¨íˆ í•˜ê³  ì‹¶ë‹¤ë©´, ë„¤ê°€ ì´ë¯¸ ì“°ë˜ ì»¤ë„ ìœ ì§€ êµ¬ì¡°ì— ì´ ê°€ë“œë¥¼ ì²« ì…€ë¡œ ì£¼ì…í•˜ê³ , íŒŒì¼ì€ copy_to_sandboxë¡œ WRITE_ROOT ë°‘ìœ¼ë¡œë§Œ ë“¤ì—¬ì™€ ë‹¤ë£¨ê²Œ ë§Œë“œëŠ” ì •ë„ë©´ ì¶©ë¶„íˆ 80/20ì„ ì±„ìš´ë‹¤.</p>

<p class="chat--user">

ê·¼ë° ê¸°ì¡´ ì½”ë“œì—ì„œ returnì„ ë¨¼ì €í•˜ê³  joinì„ í•˜ëŠ”ë° ë§ì´ ì•ˆë˜ëŠ”ê±°ì§€?

</p>

<p>ë§ì•„. ê·¸ ì½”ë“œëŠ” return ë‹¤ìŒì— p.join()ì´ ìˆì–´ ì‹¤í–‰ë˜ì§€ ì•Šì•„. ê²°ê³¼ë¥¼ ë°›ì€ ë’¤ í”„ë¡œì„¸ìŠ¤ë¥¼ ì •ë¦¬(join/terminate)í•˜ê³  ë¦¬ì†ŒìŠ¤ë¥¼ ë‹«ì€ ë‹¤ìŒì— return í•´ì•¼ í•œë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì¢€ë¹„ í”„ë¡œì„¸ìŠ¤ê°€ ìƒê¸¸ ìˆ˜ ìˆë‹¤(íŠ¹íˆ POSIX).</p>

<p>ì•ˆì „í•œ ê¸°ë³¸ íŒ¨í„´ì„ ì•„ì£¼ ê°„ë‹¨íˆ ì ìœ¼ë©´ ì´ë ‡ê²Œ ëœë‹¤.</p>

<ol>
  <li>
    <p>ìì‹ ì‹œì‘ â†’ ë¶€ëª¨ì—ì„œ child_conn ë‹«ê¸°</p>
  </li>
  <li>
    <p>pollë¡œ íƒ€ì„ì•„ì›ƒ ê°ì‹œí•˜ë©° recv</p>
  </li>
  <li>
    <p>ê²°ê³¼ ë°›ìœ¼ë©´ p.join()ìœ¼ë¡œ ìˆ˜ê±°</p>
  </li>
  <li>
    <p>íƒ€ì„ì•„ì›ƒì´ë©´ p.terminate() í›„ p.join()</p>
  </li>
  <li>
    <p>í•­ìƒ íŒŒì´í”„ ë‹«ê¸°</p>
  </li>
</ol>

<p>ìµœì†Œ ìˆ˜ì • ì˜ˆì‹œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">sandbox2020</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">allowed_globals</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="kn">from</span> <span class="n">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Pipe</span>

    <span class="k">def</span> <span class="nf">ran_in_subprocess</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">allowed</span><span class="p">):</span>
        <span class="c1"># ... ë‚´ë¶€ ì‹¤í–‰ ë¡œì§ ...
</span>        <span class="n">conn</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">conn</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>           <span class="c1"># ìì‹ ìª½ íŒŒì´í”„ ë‹«ê¸° í›„ ì¢…ë£Œ
</span>
    <span class="n">parent_conn</span><span class="p">,</span> <span class="n">child_conn</span> <span class="o">=</span> <span class="nc">Pipe</span><span class="p">(</span><span class="n">duplex</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nc">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">ran_in_subprocess</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">child_conn</span><span class="p">,</span> <span class="n">allowed_globals</span><span class="p">))</span>
    <span class="n">p</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="n">child_conn</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>          <span class="c1"># ë¶€ëª¨ ìª½ì—ì„œ child endëŠ” ë°”ë¡œ ë‹«ê¸°
</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># íƒ€ì„ì•„ì›ƒ ê°ì‹œí•˜ë©´ì„œ ê²°ê³¼ ìˆ˜ì‹ 
</span>        <span class="k">if</span> <span class="n">parent_conn</span><span class="p">.</span><span class="nf">poll</span><span class="p">(</span><span class="n">timeout_sec</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">parent_conn</span><span class="p">.</span><span class="nf">recv</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">terminate</span><span class="p">()</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">raise</span> <span class="nc">TimeoutError</span><span class="p">(</span><span class="sh">"</span><span class="s">sandbox execution timed out</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># ì—¬ê¸°ì„œ ë°˜ë“œì‹œ ì¡°ì¸í•´ì„œ ìˆ˜ê±°
</span>        <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_alive</span><span class="p">():</span>
            <span class="c1"># í˜¹ì‹œ ì•„ì§ ì‚´ì•„ ìˆìœ¼ë©´ ê°•ì œ ì¢…ë£Œ í›„ ì¬ì¡°ì¸
</span>            <span class="n">p</span><span class="p">.</span><span class="nf">terminate</span><span class="p">()</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="n">parent_conn</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre></div></div>

<p>í•œ ì¤„ ìš”ì•½<br />
returnì„ ë¨¼ì € í•˜ë©´ ê·¸ ì•„ë˜ ì½”ë“œëŠ” ì£½ì€ ì½”ë“œê°€ ëœë‹¤. ê²°ê³¼ë¥¼ ë³€ìˆ˜ì— ë‹´ê³ , í”„ë¡œì„¸ìŠ¤ë¥¼ ìˆ˜ê±°(p.join)í•˜ê³ , í•¸ë“¤ë“¤ì„ ë‹«ì€ ë’¤ì— return í•˜ë„ë¡ ìˆœì„œë¥¼ ë°”ê¿”ì•¼ í•œë‹¤.</p>

<p class="chat--user">

ìˆ˜ì •í•  ê²ƒ: conn ë¶ˆí•„ìš”í•œ ê²ƒ ê°™ì€ë° ê·¸ëƒ¥ subprocess(with íŒŒì¼/subprocess sendbox)ë¡œ ì‹¤í–‰í•˜ê³  stdout ë©”ì‹œì§€ë‘ stderr ë©”ì‹œì§€ë§Œ ìˆìœ¼ë©´ ë  ê²ƒ ê°™ì•„. ë‹¨ ì—ëŸ¬ ë‚œ ë‚´ìš©ì— ëŒ€í•´ì„  ì¢€ ë” ìì„¸íˆ ë‚˜ì˜¤ë©´ ì¢‹ê² ì–´. ì–´ë–¤ íŒŒì¼ì„ ì ‘ê·¼í•˜ë ¤ë‹¤ ë‚¬ëŠ”ì§€/ì–´ë–¤ ì»¤ë§¨ë“œë¥¼ í•˜ë ¤ë‹¤ ë‚¬ëŠ”ì§€

&lt;p class="chat--user" markdown="1"&gt;

ìˆ˜ì •í•  ê²ƒ: conn ë¶ˆí•„ìš”í•œ ê²ƒ ê°™ì€ë° ê·¸ëƒ¥ subprocess(with íŒŒì¼/subprocess sendbox)ë¡œ ì‹¤í–‰í•˜ê³  stdout ë©”ì‹œì§€ë‘ stderr ë©”ì‹œì§€ë§Œ ìˆìœ¼ë©´ ë  ê²ƒ ê°™ì•„. ë‹¨ ì—ëŸ¬ ë‚œ ë‚´ìš©ì— ëŒ€í•´ì„  ì¢€ ë” ìì„¸íˆ ë‚˜ì˜¤ë©´ ì¢‹ê² ì–´. ì–´ë–¤ íŒŒì¼ì„ ì ‘ê·¼í•˜ë ¤ë‹¤ ë‚¬ëŠ”ì§€/ì–´ë–¤ ì»¤ë§¨ë“œë¥¼ í•˜ë ¤ë‹¤ ë‚¬ëŠ”ì§€ ë˜, asyncë¥¼ í™œìš©í•´ì„œ ëë‚ ë•Œê¹Œì§€ëŠ” awaitë¡œ í•˜ë©´ ì¢‹ê² ì–´

</p>

<p>ì¢‹ì•„. íŒŒì´í”„(conn) ì—†ì´, ë³„ë„ íŒŒì´ì¬ ì„œë¸Œí”„ë¡œì„¸ìŠ¤ë¥¼ async/awaitë¡œ ì‹¤í–‰í•˜ê³  stdout/stderrë§Œ ìˆ˜ì§‘í•˜ëŠ” ìµœì†Œ êµ¬í˜„ì„ ì •ë¦¬í–ˆë‹¤. ì„œë¸Œí”„ë¡œì„¸ìŠ¤ ì•ˆì—ì„œëŠ” audit hookìœ¼ë¡œ â€œíŒŒì¼ ì‹œìŠ¤í…œ ì“°ê¸°â€ë¥¼ WRITE_ROOT ë‚´ë¶€ë¡œë§Œ ì œí•œí•˜ê³ , subprocess/os.system ì‹œë„ë¥¼ ì°¨ë‹¨í•œë‹¤. ì—ëŸ¬ ë©”ì‹œì§€ëŠ” ì–´ë–¤ íŒŒì¼/ì»¤ë§¨ë“œ ë•Œë¬¸ì— ë§‰í˜”ëŠ”ì§€ ìì„¸íˆ ì¶œë ¥ëœë‹¤.</p>

<p>ì•„ë˜ ìŠ¤í¬ë¦½íŠ¸ í•˜ë‚˜ë¡œ ë°”ë¡œ ì‹¤í–‰í•´ë„ ë˜ê³ , run_user_code_async í•¨ìˆ˜ë§Œ ê°€ì ¸ë‹¤ ì¨ë„ ëœë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># sandbox_async.py
# Python 3.8+ í•„ìš”. ì™¸ë¶€ ì˜ì¡´ì„± ì—†ìŒ.
</span><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">tempfile</span><span class="p">,</span> <span class="n">textwrap</span><span class="p">,</span> <span class="n">traceback</span>

<span class="n">CHILD_TEMPLATE</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os, sys

WRITE_ROOT = os.environ.get(</span><span class="sh">"</span><span class="s">WRITE_ROOT</span><span class="sh">"</span><span class="s">, os.path.abspath(</span><span class="sh">"</span><span class="s">./sandbox</span><span class="sh">"</span><span class="s">))
ALLOW_READ_ANYWHERE = os.environ.get(</span><span class="sh">"</span><span class="s">ALLOW_READ_ANYWHERE</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">1</span><span class="sh">"</span><span class="s">) == </span><span class="sh">"</span><span class="s">1</span><span class="sh">"</span><span class="s">
READ_ALLOW = os.environ.get(</span><span class="sh">"</span><span class="s">READ_ALLOW</span><span class="sh">"</span><span class="s">, </span><span class="sh">""</span><span class="s">)
READ_ALLOW = [os.path.realpath(p) for p in READ_ALLOW.split(os.pathsep) if p]

def _real(p): 
    try: return os.path.realpath(p)
    except Exception: return str(p)

def _in_write_root(p):
    rp = _real(p); wr = _real(WRITE_ROOT)
    return rp == wr or rp.startswith(wr + os.sep)

def _is_read_allowed(p):
    if ALLOW_READ_ANYWHERE: 
        return True
    rp = _real(p)
    if _in_write_root(rp): 
        return True
    return any(rp == r or rp.startswith(r + os.sep) for r in READ_ALLOW)

def _audit(event, args):
    # íŒŒì¼ ì—´ê¸°/ìƒì„±
    if event in (</span><span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">os.open</span><span class="sh">"</span><span class="s">):
        path = str(args[0])
        mode = str(args[1]) if len(args) &gt; 1 else </span><span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="s">
        flags = int(args[2]) if len(args) &gt; 2 else 0
        write_intent = any(ch in mode for ch in (</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="s">)) or \
            (flags &amp; (os.O_WRONLY | os.O_RDWR | os.O_CREAT | os.O_TRUNC | os.O_APPEND))
        if write_intent and not _in_write_root(path):
            msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} path={_real(path)} mode={mode} flags={flags} reason=write-outside-WRITE_ROOT({WRITE_ROOT})</span><span class="sh">"</span><span class="s">
            print(msg, file=sys.stderr, flush=True)
            raise PermissionError(msg)
        # ì„ íƒ: ì½ê¸° ì œí•œì„ ë‘ê³  ì‹¶ìœ¼ë©´ ì—¬ê¸°ì„œ ê²€ì‚¬
        if (not write_intent) and (not _is_read_allowed(path)):
            msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} path={_real(path)} reason=read-not-allowed</span><span class="sh">"</span><span class="s">
            print(msg, file=sys.stderr, flush=True)
            raise PermissionError(msg)

    # íŒŒì¼ ì¡°ì‘ë¥˜ (ê²½ë¡œê°€ ì²« ì¸ìì— ì˜¨ë‹¤ê³  ê°€ì •; rename/replaceëŠ” src,dst ë‘˜ ë‹¤ ì²´í¬)
    elif event in (</span><span class="sh">"</span><span class="s">os.rename</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.replace</span><span class="sh">"</span><span class="s">):
        src = str(args[0]); dst = str(args[1])
        if not (_in_write_root(src) and _in_write_root(dst)):
            msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} src={_real(src)} dst={_real(dst)} reason=op-outside-WRITE_ROOT({WRITE_ROOT})</span><span class="sh">"</span><span class="s">
            print(msg, file=sys.stderr, flush=True)
            raise PermissionError(msg)
    elif event in (</span><span class="sh">"</span><span class="s">os.remove</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.unlink</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.mkdir</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.makedirs</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.rmdir</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.chmod</span><span class="sh">"</span><span class="s">):
        path = str(args[0])
        if not _in_write_root(path):
            msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} path={_real(path)} reason=op-outside-WRITE_ROOT({WRITE_ROOT})</span><span class="sh">"</span><span class="s">
            print(msg, file=sys.stderr, flush=True)
            raise PermissionError(msg)

    # ì„œë¸Œí”„ë¡œì„¸ìŠ¤/ì‹œìŠ¤í…œ í˜¸ì¶œ ì°¨ë‹¨
    elif event.startswith(</span><span class="sh">"</span><span class="s">subprocess.</span><span class="sh">"</span><span class="s">) or event == </span><span class="sh">"</span><span class="s">os.system</span><span class="sh">"</span><span class="s">:
        cmd = None
        try:
            # subprocess.Popenì€ ì²« ì¸ìë¡œ args(ì»¤ë§¨ë“œ)ê°€ ë“¤ì–´ì˜¤ëŠ” ê²½ìš°ê°€ ë§ë‹¤
            cmd = args[0]
        except Exception:
            cmd = </span><span class="sh">"</span><span class="s">&lt;unknown&gt;</span><span class="sh">"</span><span class="s">
        msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} cmd={cmd} reason=subprocess-disabled</span><span class="sh">"</span><span class="s">
        print(msg, file=sys.stderr, flush=True)
        raise PermissionError(msg)

    # ë„¤íŠ¸ì›Œí¬ë¥¼ ë§‰ê³  ì‹¶ìœ¼ë©´ ì£¼ì„ í•´ì œ
    # elif event.startswith(</span><span class="sh">"</span><span class="s">socket.</span><span class="sh">"</span><span class="s">):
    #     msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} reason=network-disabled</span><span class="sh">"</span><span class="s">
    #     print(msg, file=sys.stderr, flush=True)
    #     raise PermissionError(msg)

# ì„¤ì¹˜
sys.addaudithook(_audit)

# ì‚¬ìš©ì ì½”ë“œ ì‹¤í–‰
USER_CODE = r\"\"\"{user_code}\"\"\"
g = {</span><span class="sh">"</span><span class="s">__name__</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="s">}
try:
    exec(USER_CODE, g, g)
except Exception as e:
    # ì—ëŸ¬ë¥¼ ìì„¸íˆ stderrë¡œ
    print(</span><span class="sh">"</span><span class="s">[ERROR] exception while executing user code:</span><span class="sh">"</span><span class="s">, file=sys.stderr)
    traceback.print_exc()
    raise
</span><span class="sh">"""</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_user_code_async</span><span class="p">(</span>
    <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">write_root</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">./sandbox</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="n">read_allow</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">timeout_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
    <span class="n">python_executable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    user codeë¥¼ ë³„ë„ íŒŒì´ì¬ ì„œë¸Œí”„ë¡œì„¸ìŠ¤ì—ì„œ ì‹¤í–‰í•˜ê³  stdout/stderrë§Œ ìˆ˜ì§‘.
    ì“°ê¸°ëŠ” write_root ë‚´ë¶€ì—ì„œë§Œ í—ˆìš©. subprocess/os.systemì€ ì°¨ë‹¨.
    </span><span class="sh">"""</span>
    <span class="n">write_root</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">write_root</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">write_root</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">py</span> <span class="o">=</span> <span class="n">python_executable</span> <span class="ow">or</span> <span class="n">sys</span><span class="p">.</span><span class="n">executable</span>

    <span class="n">child_code</span> <span class="o">=</span> <span class="n">CHILD_TEMPLATE</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">user_code</span><span class="o">=</span><span class="n">code</span><span class="p">)</span>
    <span class="c1"># ì„ì‹œ íŒŒì¼ì— ìì‹ ìŠ¤í¬ë¦½íŠ¸ ì €ì¥
</span>    <span class="k">with</span> <span class="n">tempfile</span><span class="p">.</span><span class="nc">NamedTemporaryFile</span><span class="p">(</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">"</span><span class="s">.py</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">child_path</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">name</span>
        <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">child_code</span><span class="p">)</span>

    <span class="c1"># ìì‹ í™˜ê²½
</span>    <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
    <span class="n">env</span><span class="p">[</span><span class="sh">"</span><span class="s">WRITE_ROOT</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">write_root</span>
    <span class="n">env</span><span class="p">[</span><span class="sh">"</span><span class="s">ALLOW_READ_ANYWHERE</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">1</span><span class="sh">"</span> <span class="k">if</span> <span class="n">allow_read_anywhere</span> <span class="k">else</span> <span class="sh">"</span><span class="s">0</span><span class="sh">"</span>
    <span class="k">if</span> <span class="n">read_allow</span><span class="p">:</span>
        <span class="n">env</span><span class="p">[</span><span class="sh">"</span><span class="s">READ_ALLOW</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">pathsep</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">read_allow</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
            <span class="n">py</span><span class="p">,</span> <span class="n">child_path</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_sec</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">124</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[TIMEOUT] exceeded </span><span class="si">{</span><span class="n">timeout_sec</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="n">rc</span> <span class="o">=</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">stdout</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">stderr</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">unlink</span><span class="p">(</span><span class="n">child_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

<span class="c1"># ë°ëª¨
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
        <span class="n">user_code</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
import os, sys, numpy
print(</span><span class="sh">"</span><span class="s">hello from user code</span><span class="sh">"</span><span class="s">)
# í—ˆìš©ëœ ì“°ê¸°
open(os.path.join(os.environ[</span><span class="sh">'</span><span class="s">WRITE_ROOT</span><span class="sh">'</span><span class="s">], </span><span class="sh">'</span><span class="s">ok.txt</span><span class="sh">'</span><span class="s">), </span><span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="s">).write(</span><span class="sh">'</span><span class="s">ok</span><span class="sh">'</span><span class="s">)
# ê¸ˆì§€ëœ ì“°ê¸°
try:
    open(</span><span class="sh">'</span><span class="s">/etc/forbidden.txt</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="s">).write(</span><span class="sh">'</span><span class="s">no</span><span class="sh">'</span><span class="s">)
except Exception as e:
    print(</span><span class="sh">"</span><span class="s">caught:</span><span class="sh">"</span><span class="s">, type(e).__name__)
</span><span class="sh">"""</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_user_code_async</span><span class="p">(</span><span class="n">user_code</span><span class="p">,</span> <span class="n">write_root</span><span class="o">=</span><span class="sh">"</span><span class="s">./sandbox</span><span class="sh">"</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">RETURN =</span><span class="sh">"</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">])</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDOUT:</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">])</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDERR:</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">])</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>í•µì‹¬ í¬ì¸íŠ¸ ìš”ì•½</p>

<ol>
  <li>
    <p>ë³„ë„ íŒŒì´ì¬ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì‹¤í–‰í•˜ë¯€ë¡œ ì„¸ì…˜ ìœ ì§€ê°€ í•„ìš” ì—†ì„ ë•Œ ê°€ë³ê³  ì•ˆì „í•˜ë‹¤. ì„¸ì…˜ ìœ ì§€í˜•ì´ í•„ìš”í•˜ë©´ í”„ë¡œì„¸ìŠ¤ë¥¼ ê¸¸ê²Œ ë¶™ì¡ëŠ” ë˜í¼ë¥¼ ë§Œë“¤ë©´ ëœë‹¤.</p>
  </li>
  <li>
    <p>íŒŒì¼ ì“°ê¸°ëŠ” WRITE_ROOT ë‚´ë¶€ë§Œ í—ˆìš©. ê¸ˆì§€ ì‹œë„ëŠ” stderrì— [AUDIT] ë¼ì¸ìœ¼ë¡œ ì´ë²¤íŠ¸, ê²½ë¡œ, ì´ìœ ê°€ ì°íˆê³  PermissionErrorë¥¼ ì¼ìœ¼í‚¨ë‹¤.</p>
  </li>
  <li>
    <p>subprocess/os.systemì€ ì°¨ë‹¨ë˜ê³ , ì°¨ë‹¨ ì‚¬ìœ ì™€ ì‹œë„í•œ ì»¤ë§¨ë“œë¥¼ stderrë¡œ ë‚¨ê¸´ë‹¤.</p>
  </li>
  <li>
    <p>awaitë¡œ ê²°ê³¼ë¥¼ ë°›ì„ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦°ë‹¤. íƒ€ì„ì•„ì›ƒì´ ë‚˜ë©´ returncode 124ì™€ í•¨ê»˜ ì¢…ë£Œí•œë‹¤.</p>
  </li>
  <li>
    <p>ì½ê¸°ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì–´ë””ì„œë“  í—ˆìš©í•˜ì§€ë§Œ, allow_read_anywhere=Falseë¡œ ë‘ê³  read_allow ë¦¬ìŠ¤íŠ¸ë¥¼ ì£¼ë©´ ì½ê¸°ë„ ê²½ë¡œ ê¸°ë°˜ í—ˆìš©ìœ¼ë¡œ ì¢í ìˆ˜ ìˆë‹¤.</p>
  </li>
</ol>

<p>ì´ì œ ë„¤ ì—ì´ì „íŠ¸ íˆ´ ìª½ì—ì„œëŠ” ì´ í•¨ìˆ˜ í•˜ë‚˜ë§Œ ê°ì‹¸ì„œ í˜¸ì¶œí•˜ë©´ ëœë‹¤. íˆ´ ì¸ìëŠ” code, write_root, timeout ì •ë„ë§Œ ë…¸ì¶œí•˜ê³ , ì •ì±…(ì½ê¸° í—ˆìš© ë²”ìœ„)ì€ ì„œë²„ ì¸¡ì—ì„œë§Œ ê´€ë¦¬í•´ë„ ê¹”ë”í•˜ë‹¤.</p>

<p class="chat--user">

ì¶”ê°€ êµ¬í˜„ ìš”ì²­: read_path(ë¦¬ìŠ¤íŠ¸)ì™€ write_path(ë¦¬ìŠ¤íŠ¸)ë¥¼ ë°›ë„ë¡ í•˜ê³  ì‹¶ì–´. ê·¸ë¦¬ê³  ì‹œì‘í•˜ëŠ” cwd(Working directory)ë„ ì½”ë“œ ì‹œì‘í•  ë•Œ ì½”ë“œë‘ ê°™ì´ ì…ë ¥ í•˜ë©´ ì¢‹ê² ì–´. ì—†ìœ¼ë©´ ê·¸ëƒ¥ Noneìœ¼ë¡œ í•˜ê¸°. ê·¸ëŸ°ë° cwdë¥¼ subprocess ì—ì„œ ë°”ê¿”ë„ ë¶€ëª¨ í”„ë¡œì„¸ìŠ¤ì—ëŠ” ìƒê´€ì´ ì—†ì§€?

</p>

<p>ì •ë¦¬ ë¨¼ì €.</p>

<ul>
  <li>
    <p>ìš”ì²­ ë°˜ì˜: read_path(ì—¬ëŸ¬ ê°œ), write_path(ì—¬ëŸ¬ ê°œ) ë°›ê¸°, ì‹œì‘ ì‘ì—… ë””ë ‰í„°ë¦¬(cwd) ì˜µì…˜, ë¹„ë™ê¸°(async/await) ì‹¤í–‰, ê²°ê³¼ëŠ” stdout/stderrë§Œ.</p>
  </li>
  <li>
    <p>ì„œë¸Œí”„ë¡œì„¸ìŠ¤ ì•ˆì—ì„œ audit hookìœ¼ë¡œ íŒŒì¼/ì„œë¸Œí”„ë¡œì„¸ìŠ¤ ì‹œë„ ê°ì‹œ. ì–´ë–¤ íŒŒì¼Â·ì»¤ë§¨ë“œ ë•Œë¬¸ì— ë§‰í˜”ëŠ”ì§€ stderrì— ìì„¸íˆ ì”€.</p>
  </li>
  <li>
    <p>ì„œë¸Œí”„ë¡œì„¸ìŠ¤ì—ì„œ cwdë¥¼ ë°”ê¿”ë„ ë¶€ëª¨ í”„ë¡œì„¸ìŠ¤ì—ëŠ” ì˜í–¥ ì—†ë‹¤(í”„ë¡œì„¸ìŠ¤ë§ˆë‹¤ í˜„ì¬ ë””ë ‰í„°ë¦¬ëŠ” ë…ë¦½).</p>
  </li>
</ul>

<p>ì•„ë˜ëŠ” ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” ìµœì†Œ êµ¬í˜„ì´ë‹¤. ì™¸ë¶€ ì˜ì¡´ì„± ì—†ìŒ, Python 3.8+.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># sandbox_async_paths.py
</span><span class="kn">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">tempfile</span>

<span class="n">CHILD_TEMPLATE</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os, sys, traceback

WRITE_DIRS = [p for p in os.environ.get(</span><span class="sh">"</span><span class="s">WRITE_DIRS</span><span class="sh">"</span><span class="s">,</span><span class="sh">""</span><span class="s">).split(os.pathsep) if p]
READ_DIRS  = [p for p in os.environ.get(</span><span class="sh">"</span><span class="s">READ_DIRS</span><span class="sh">"</span><span class="s">,</span><span class="sh">""</span><span class="s">).split(os.pathsep) if p]
ALLOW_READ_ANYWHERE = os.environ.get(</span><span class="sh">"</span><span class="s">ALLOW_READ_ANYWHERE</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">1</span><span class="sh">"</span><span class="s">) == </span><span class="sh">"</span><span class="s">1</span><span class="sh">"</span><span class="s">

def _real(p):
    try: return os.path.realpath(p)
    except Exception: return str(p)

def _is_under_any(path, roots):
    rp = _real(path)
    for r in roots:
        rr = _real(r)
        if rp == rr or rp.startswith(rr + os.sep):
            return True
    return False

def _audit(event, args):
    try:
        # íŒŒì¼ ì—´ê¸°
        if event in (</span><span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">os.open</span><span class="sh">"</span><span class="s">):
            path = str(args[0])
            mode = str(args[1]) if len(args) &gt; 1 else </span><span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="s">
            flags = int(args[2]) if len(args) &gt; 2 else 0
            write = any(ch in mode for ch in (</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="s">)) or \
                    (flags &amp; (os.O_WRONLY|os.O_RDWR|os.O_CREAT|os.O_TRUNC|os.O_APPEND))
            if write and not _is_under_any(path, WRITE_DIRS):
                msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} path={_real(path)} mode={mode} flags={flags} reason=write-outside-allowed</span><span class="sh">"</span><span class="s">
                print(msg, file=sys.stderr, flush=True)
                raise PermissionError(msg)
            if not write and not ALLOW_READ_ANYWHERE and not _is_under_any(path, READ_DIRS+WRITE_DIRS):
                msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} path={_real(path)} reason=read-not-allowed</span><span class="sh">"</span><span class="s">
                print(msg, file=sys.stderr, flush=True)
                raise PermissionError(msg)

        # íŒŒì¼ ì¡°ì‘ë¥˜
        elif event in (</span><span class="sh">"</span><span class="s">os.rename</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.replace</span><span class="sh">"</span><span class="s">):
            src = str(args[0]); dst = str(args[1])
            if not (_is_under_any(src, WRITE_DIRS) and _is_under_any(dst, WRITE_DIRS)):
                msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} src={_real(src)} dst={_real(dst)} reason=op-outside-allowed</span><span class="sh">"</span><span class="s">
                print(msg, file=sys.stderr, flush=True)
                raise PermissionError(msg)
        elif event in (</span><span class="sh">"</span><span class="s">os.remove</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.unlink</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.mkdir</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.makedirs</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.rmdir</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">os.chmod</span><span class="sh">"</span><span class="s">):
            path = str(args[0])
            if not _is_under_any(path, WRITE_DIRS):
                msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} path={_real(path)} reason=op-outside-allowed</span><span class="sh">"</span><span class="s">
                print(msg, file=sys.stderr, flush=True)
                raise PermissionError(msg)

        # ì„œë¸Œí”„ë¡œì„¸ìŠ¤/ì‹œìŠ¤í…œ í˜¸ì¶œ ì°¨ë‹¨
        elif event.startswith(</span><span class="sh">"</span><span class="s">subprocess.</span><span class="sh">"</span><span class="s">) or event == </span><span class="sh">"</span><span class="s">os.system</span><span class="sh">"</span><span class="s">:
            cmd = None
            try: cmd = args[0]
            except Exception: cmd = </span><span class="sh">"</span><span class="s">&lt;unknown&gt;</span><span class="sh">"</span><span class="s">
            msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} cmd={cmd} reason=subprocess-disabled</span><span class="sh">"</span><span class="s">
            print(msg, file=sys.stderr, flush=True)
            raise PermissionError(msg)

        # ë„¤íŠ¸ì›Œí¬ë¥¼ ë§‰ê³  ì‹¶ìœ¼ë©´ ì£¼ì„ í•´ì œ
        # elif event.startswith(</span><span class="sh">"</span><span class="s">socket.</span><span class="sh">"</span><span class="s">):
        #     msg = f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event={event} reason=network-disabled</span><span class="sh">"</span><span class="s">
        #     print(msg, file=sys.stderr, flush=True)
        #     raise PermissionError(msg)

    except Exception:
        raise

sys.addaudithook(_audit)

USER_CODE = r\"\"\"{user_code}\"\"\"
g = {</span><span class="sh">"</span><span class="s">__name__</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="s">}
try:
    exec(USER_CODE, g, g)
except Exception:
    print(</span><span class="sh">"</span><span class="s">[ERROR] exception while executing user code:</span><span class="sh">"</span><span class="s">, file=sys.stderr)
    traceback.print_exc()
    raise
</span><span class="sh">"""</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_user_code_async</span><span class="p">(</span>
    <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">read_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">write_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">timeout_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
    <span class="n">python_executable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    ë³„ë„ íŒŒì´ì¬ ì„œë¸Œí”„ë¡œì„¸ìŠ¤ì—ì„œ ì‚¬ìš©ì ì½”ë“œë¥¼ ì‹¤í–‰í•œë‹¤.
    - read_paths: ì½ê¸° í—ˆìš© ê²½ë¡œ ëª©ë¡(í•˜ìœ„ í¬í•¨). None ë˜ëŠ” []ë©´ ì½ê¸° ì–´ë””ë“  í—ˆìš©(allow_read_anywhere=True).
    - write_paths: ì“°ê¸° í—ˆìš© ê²½ë¡œ ëª©ë¡(í•˜ìœ„ í¬í•¨). None/[]ë©´ ì“°ê¸° ì „ë¶€ ì°¨ë‹¨.
    - cwd: ì„œë¸Œí”„ë¡œì„¸ìŠ¤ ì‹œì‘ ì‘ì—… ë””ë ‰í„°ë¦¬. Noneì´ë©´ ë¶€ëª¨ì˜ cwdë¥¼ ìƒì†. ìì‹ì´ ë°”ê¿”ë„ ë¶€ëª¨ì—ëŠ” ì˜í–¥ ì—†ìŒ.
    - stdout/stderrë¥¼ ìˆ˜ì§‘í•´ ë°˜í™˜.
    </span><span class="sh">"""</span>
    <span class="n">py</span> <span class="o">=</span> <span class="n">python_executable</span> <span class="ow">or</span> <span class="n">sys</span><span class="p">.</span><span class="n">executable</span>
    <span class="n">rp</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">read_paths</span> <span class="ow">or</span> <span class="p">[])]</span>
    <span class="n">wp</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">write_paths</span> <span class="ow">or</span> <span class="p">[])]</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">wp</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">allow_read_anywhere</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">allow_read_anywhere</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">rp</span><span class="p">)</span>  <span class="c1"># ì½ê¸° ê²½ë¡œ ë¯¸ì§€ì •ì´ë©´ ì–´ë””ë“  ì½ê¸° í—ˆìš©
</span>
    <span class="n">child_code</span> <span class="o">=</span> <span class="n">CHILD_TEMPLATE</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">user_code</span><span class="o">=</span><span class="n">code</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="p">.</span><span class="nc">NamedTemporaryFile</span><span class="p">(</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="sh">"</span><span class="s">.py</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">child_path</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">name</span>
        <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">child_code</span><span class="p">)</span>

    <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
    <span class="n">env</span><span class="p">[</span><span class="sh">"</span><span class="s">READ_DIRS</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">pathsep</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">rp</span><span class="p">)</span>
    <span class="n">env</span><span class="p">[</span><span class="sh">"</span><span class="s">WRITE_DIRS</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">pathsep</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>
    <span class="n">env</span><span class="p">[</span><span class="sh">"</span><span class="s">ALLOW_READ_ANYWHERE</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">1</span><span class="sh">"</span> <span class="k">if</span> <span class="n">allow_read_anywhere</span> <span class="k">else</span> <span class="sh">"</span><span class="s">0</span><span class="sh">"</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_subprocess_exec</span><span class="p">(</span>
            <span class="n">py</span><span class="p">,</span> <span class="n">child_path</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
            <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">,</span>  <span class="c1"># ìì‹ì˜ ì‹œì‘ ì‘ì—… ë””ë ‰í„°ë¦¬. ë¶€ëª¨ì—” ì˜í–¥ ì—†ìŒ.
</span>        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">communicate</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_sec</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="n">proc</span><span class="p">.</span><span class="nf">kill</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">wait_for</span><span class="p">(</span><span class="n">proc</span><span class="p">.</span><span class="nf">wait</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span><span class="mi">124</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span><span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span><span class="sa">f</span><span class="sh">"</span><span class="s">[TIMEOUT] exceeded </span><span class="si">{</span><span class="n">timeout_sec</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">proc</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">stdout</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">stderr</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">replace</span><span class="sh">"</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="nf">unlink</span><span class="p">(</span><span class="n">child_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="k">pass</span>

<span class="c1"># ë°ëª¨ ì‹¤í–‰
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
        <span class="n">code</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os, sys, subprocess
print(</span><span class="sh">"</span><span class="s">CWD:</span><span class="sh">"</span><span class="s">, os.getcwd())
# í—ˆìš©ëœ ì“°ê¸°
open(os.path.join(</span><span class="sh">"</span><span class="s">out_dir</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">ok.txt</span><span class="sh">"</span><span class="s">), </span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">).write(</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="s">)  # ìƒëŒ€ê²½ë¡œëŠ” cwd ê¸°ì¤€
# ê¸ˆì§€ëœ ì“°ê¸°
try:
    open(</span><span class="sh">"</span><span class="s">/tmp/blocked.txt</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">).write(</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="s">)
except Exception as e:
    print(</span><span class="sh">"</span><span class="s">blocked write:</span><span class="sh">"</span><span class="s">, type(e).__name__)
# ì„œë¸Œí”„ë¡œì„¸ìŠ¤ ì‹œë„
try:
    subprocess.check_output([</span><span class="sh">"</span><span class="s">echo</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">hi</span><span class="sh">"</span><span class="s">])
except Exception as e:
    print(</span><span class="sh">"</span><span class="s">blocked subproc:</span><span class="sh">"</span><span class="s">, type(e).__name__)
# í—ˆìš©ëœ ì½ê¸°(ì˜ˆ: read_pathsê°€ ì§€ì •ë˜ì—ˆê±°ë‚˜ allow_read_anywhere=Trueì¸ ê²½ìš°)
print(</span><span class="sh">"</span><span class="s">done</span><span class="sh">"</span><span class="s">)
</span><span class="sh">"""</span>
        <span class="c1"># ì˜ˆì‹œ: cwdë¥¼ ./workë¡œ, ì“°ê¸°ëŠ” ./work/out_dir ì•„ë˜ë§Œ, ì½ê¸°ëŠ” ì–´ë””ë“  í—ˆìš©
</span>        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./work/out_dir</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_user_code_async</span><span class="p">(</span>
            <span class="n">code</span><span class="p">,</span>
            <span class="n">read_paths</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>                 <span class="c1"># None â†’ ì–´ë””ë“  ì½ê¸° í—ˆìš©
</span>            <span class="n">write_paths</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./work/out_dir</span><span class="sh">"</span><span class="p">],</span>  <span class="c1"># ì—¬ê¸°ë§Œ ì“°ê¸° í—ˆìš©
</span>            <span class="n">cwd</span><span class="o">=</span><span class="sh">"</span><span class="s">./work</span><span class="sh">"</span><span class="p">,</span>                    <span class="c1"># ìì‹ì˜ ì‹œì‘ CWD
</span>            <span class="n">timeout_sec</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">RC:</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">])</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDOUT:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">])</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDERR:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">])</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>í¬ì¸íŠ¸</p>

<ul>
  <li>
    <p>read_pathsì™€ write_pathsëŠ” í•˜ìœ„ í´ë”ê¹Œì§€ í¬í•¨í•´ í—ˆìš©ëœë‹¤. ì“°ê¸°ëŠ” write_paths ì¤‘ í•˜ë‚˜ì— í¬í•¨ë  ë•Œë§Œ í†µê³¼.</p>
  </li>
  <li>
    <p>read_pathsë¥¼ ì§€ì •í•˜ì§€ ì•Šìœ¼ë©´ allow_read_anywhere=Trueë¡œ ë™ì‘í•´ ì–´ë””ë“  ì½ê¸° í—ˆìš©(ìš”êµ¬ê°€ ëŠìŠ¨í•  ë•Œ í¸í•¨). ì½ê¸°ë„ ì œí•œí•˜ë ¤ë©´ read_pathsë¥¼ ì§€ì •í•˜ê³  allow_read_anywhereë¥¼ ìƒëµí•˜ë©´ ìë™ìœ¼ë¡œ Falseë¡œ ë°”ë€ë‹¤.</p>
  </li>
  <li>
    <p>cwd ì¸ìëŠ” ì„œë¸Œí”„ë¡œì„¸ìŠ¤ì—ë§Œ ì ìš©ëœë‹¤. ìì‹ì´ os.chdirë¡œ ë°”ê¿”ë„ ë¶€ëª¨ í”„ë¡œì„¸ìŠ¤ì—ëŠ” ì•„ë¬´ ì˜í–¥ ì—†ë‹¤.</p>
  </li>
  <li>
    <p>ì°¨ë‹¨ ì‹œ stderrì— [AUDIT] ë¼ì¸ìœ¼ë¡œ ì´ë²¤íŠ¸, ê²½ë¡œ, ì»¤ë§¨ë“œ, ì´ìœ ë¥¼ ìƒì„¸íˆ ë‚¨ê¸´ë‹¤.</p>
  </li>
</ul>

<p class="chat--user">

{event}ê°€ ì—†ëŒ€ format ë¶€ë¶„ì—ì„œ

</p>

<p>ë§ì•„. ê·¸ ì—ëŸ¬ëŠ” CHILD_TEMPLATE ì „ì²´ì— <code class="language-plaintext highlighter-rouge">.format(...)</code>ì„ ê±¸ë©´ì„œ í…œí”Œë¦¿ ì•ˆì— ìˆëŠ” f-stringì˜ <code class="language-plaintext highlighter-rouge">{event}</code>, <code class="language-plaintext highlighter-rouge">{args}</code> ê°™ì€ ì¤‘ê´„í˜¸ë¥¼ ë°”ê¹¥ í¬ë§·í„°ê°€ â€œí‚¤ event/argsë¥¼ ë‹¬ë¼â€ë¡œ ì˜¤í•´í–ˆê¸° ë•Œë¬¸ì— ìƒê¸´ ê±°ì•¼.</p>

<p>í•´ê²°ì€ ì…‹ ì¤‘ í•˜ë‚˜ë¡œ í•˜ë©´ ê¹”ë”í•´.</p>

<ol>
  <li>
    <p>string.Templateë¡œ ì¹˜í™˜í•˜ê¸°(ê°€ì¥ ê°„ë‹¨)</p>
  </li>
  <li>
    <p>í…œí”Œë¦¿ ì•ˆ ëª¨ë“  ì¤‘ê´„í˜¸ë¥¼ ì´ìŠ¤ì¼€ì´í”„í•´ì„œ ``ë¡œ ë°”ê¾¸ê³  <code class="language-plaintext highlighter-rouge">.format(user_code=...)</code> ì‚¬ìš©</p>
  </li>
  <li>
    <p>ì•„ì˜ˆ ì‚¬ìš©ì ì½”ë“œ ìœ„ì¹˜ë§Œ íŠ¹ìˆ˜ í† í°ìœ¼ë¡œ ë‘ê³  <code class="language-plaintext highlighter-rouge">.replace()</code>ë¡œ ì¹˜í™˜</p>
  </li>
</ol>

<p>ë°”ë¡œ ëŒì•„ê°€ëŠ” íŒ¨ì¹˜(Template ì‚¬ìš©)ë§Œ ë³´ì—¬ì¤„ê²Œ. ë„ˆì˜ ê¸°ì¡´ run_user_code_asyncì—ì„œ í…œí”Œë¦¿ ì¹˜í™˜ ë¶€ë¶„ë§Œ ë°”ê¾¸ë©´ ëœë‹¤.</p>

<p>ìˆ˜ì • ì „<br />
child_code = CHILD_TEMPLATE.format(user_code=code)</p>

<p>ìˆ˜ì • í›„<br />
from string import Template<br />
child_code = Template(CHILD_TEMPLATE).substitute(USER_CODE=code)</p>

<p>ê·¸ë¦¬ê³  CHILD_TEMPLATE ì•ˆì˜ ìë¦¬í‘œì‹œìë„ <code class="language-plaintext highlighter-rouge">${USER_CODE}</code>ë¡œ ë°”ê¿”ì¤˜ì•¼ í•œë‹¤.</p>

<p>ì˜ˆì‹œ(í•µì‹¬ ë¶€ë¶„ë§Œ)<br />
CHILD_TEMPLATE = r"""<br />
import os, sys, traceback</p>

<h1 id="-ì¤‘ëµ-">â€¦ ì¤‘ëµ â€¦</h1>

<p>sys.addaudithook(_audit)</p>

<p>USER_CODE = r"""${USER_CODE}"""<br />
g = {"<strong>name</strong> ":"<strong>main</strong> "}<br />
try:<br />
exec(USER_CODE, g, g)<br />
except Exception:<br />
print("[ERROR] exception while executing user code:", file=sys.stderr)<br />
traceback.print_exc()<br />
raise<br />
"""</p>

<p>ì´ë ‡ê²Œ ë°”ê¾¸ë©´ í…œí”Œë¦¿ ì•ˆì˜ f-stringë“¤(ì˜ˆ: f"[AUDIT] blocked: event={event} â€¦")ì€ ì†ëŒ€ì§€ ì•Šì•„ë„ ë˜ê³ , ë°”ê¹¥ ì¹˜í™˜ê¸°(Template)ëŠ” <code class="language-plaintext highlighter-rouge">$</code>ë§Œ ë³´ê³  ì¹˜í™˜í•˜ë¯€ë¡œ <code class="language-plaintext highlighter-rouge">{event}</code>ë¥¼ ê±´ë“œë¦¬ì§€ ì•ŠëŠ”ë‹¤.</p>

<p>ì°¸ê³ ë¡œ <code class="language-plaintext highlighter-rouge">.format()</code>ì„ ê¼­ ì“°ê³  ì‹¶ë‹¤ë©´ í…œí”Œë¦¿ ë‚´ë¶€ì˜ ëª¨ë“  ì¤‘ê´„í˜¸ë¥¼ ``ë¡œ ì´ìŠ¤ì¼€ì´í”„í•´ì•¼ í•œë‹¤. ì˜ˆ: <code class="language-plaintext highlighter-rouge">f"[AUDIT] blocked: event="</code>ì²˜ëŸ¼. ê·¸ëŸ°ë° ê·¸ëŸ¬ë©´ ë‚´ë¶€ f-stringì´ ë” ì´ìƒ f-stringì´ ì•„ë‹ˆê²Œ ë˜ë‹ˆ, ê·¸ ê²½ìš°ì—” f-stringì„ í¬ê¸°í•˜ê³  ë‚˜ì¤‘ì— <code class="language-plaintext highlighter-rouge">.format(event=event, â€¦)</code>ë¥¼ ìì‹ í”„ë¡œì„¸ìŠ¤ì—ì„œ í˜¸ì¶œí•˜ëŠ” ì‹ìœ¼ë¡œ ë°”ê¿”ì•¼ í•´ì„œ ì½”ë“œê°€ ë²ˆê±°ë¡œì›Œì§„ë‹¤. Templateê°€ ì œì¼ ê¹”ë”í•´.</p>

<p class="chat--user">

async multi process ë¥¼ ì´ìš©í•  ìˆœ ì—†ë‚˜ stringìœ¼ë¡œ ì½”ë“œë¥¼ ì¤„ì¤„ì´ ì“°ë‹ˆê¹ ì¢€ â€¦

</p>

<p>ë§ì•„. ë¬¸ìì—´ í…œí”Œë¦¿ë¡œ â€œìì‹ ìŠ¤í¬ë¦½íŠ¸â€ë¥¼ ë§Œë“¤ì§€ ë§ê³ , ë©€í‹°í”„ë¡œì„¸ì‹±ìœ¼ë¡œ ë…ë¦½ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì‹¤í–‰í•˜ë˜ async/awaitë¡œ ê°ì‹¸ë©´ ê¹”ë”í•˜ë‹¤. ì•„ë˜ ì½”ë“œëŠ” ìˆœìˆ˜ íŒŒì´ì¬(ì˜ì¡´ì„± ì—†ìŒ)ìœ¼ë¡œ ë™ì‘í•˜ê³ , ìì‹ í”„ë¡œì„¸ìŠ¤ëŠ” audit hookìœ¼ë¡œ íŒŒì¼/ì„œë¸Œí”„ë¡œì„¸ìŠ¤ë¥¼ ê°ì‹œí•œë‹¤. ì½ê¸°Â·ì“°ê¸° í—ˆìš© ê²½ë¡œëŠ” ë¦¬ìŠ¤íŠ¸ë¡œ ë°›ê³ , ì‹œì‘ CWDë„ ì˜µì…˜ìœ¼ë¡œ ì¤€ë‹¤. ìì‹ì—ì„œ CWDë¥¼ ë°”ê¿”ë„ ë¶€ëª¨ì—ëŠ” ì˜í–¥ ì—†ë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># sandbox_async_multiprocess.py
# Python 3.8+ ì „ì œ. ì™¸ë¶€ ì˜ì¡´ì„± ì—†ìŒ.
</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">multiprocessing</span> <span class="k">as</span> <span class="n">mp</span>
<span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">traceback</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>

<span class="k">def</span> <span class="nf">_install_guard</span><span class="p">(</span><span class="n">read_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">write_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                   <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                   <span class="n">block_subprocess</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                   <span class="n">block_network</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
    <span class="n">rp</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">read_paths</span> <span class="ow">or</span> <span class="p">[])]</span>
    <span class="n">wp</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">write_paths</span> <span class="ow">or</span> <span class="p">[])]</span>

    <span class="k">def</span> <span class="nf">_real</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span> <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">roots</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">roots</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="nf">_real</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="n">r</span> <span class="ow">or</span> <span class="n">path</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_audit</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="c1"># open / os.open: (path, mode, flags)
</span>        <span class="k">if</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">os.open</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">write</span> <span class="o">=</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="ow">in</span> <span class="n">mode</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">))</span> <span class="ow">or</span> \
                    <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">O_WRONLY</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_RDWR</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_CREAT</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_TRUNC</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_APPEND</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">write</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">wp</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> path=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s"> mode=</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s"> flags=</span><span class="si">{</span><span class="n">flags</span><span class="si">}</span><span class="s"> reason=write-outside-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">write</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">allow_read_anywhere</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">rp</span><span class="o">+</span><span class="n">wp</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> path=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s"> reason=read-not-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># íŒŒì¼ ì¡°ì‘(ê²½ë¡œ ì²« ì¸ì; rename/replaceëŠ” src,dst ë‘˜ ë‹¤ í™•ì¸)
</span>        <span class="k">elif</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">os.rename</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.replace</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nf">_under_any</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">wp</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">wp</span><span class="p">)):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> src=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">src</span><span class="p">)</span><span class="si">}</span><span class="s"> dst=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span><span class="si">}</span><span class="s"> reason=op-outside-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">os.remove</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.unlink</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.mkdir</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.makedirs</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.rmdir</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.chmod</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">wp</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> path=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s"> reason=op-outside-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># ì„œë¸Œí”„ë¡œì„¸ìŠ¤/ì‹œìŠ¤í…œ í˜¸ì¶œ
</span>        <span class="k">elif</span> <span class="n">block_subprocess</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">subprocess.</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">event</span> <span class="o">==</span> <span class="sh">"</span><span class="s">os.system</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">cmd</span> <span class="o">=</span> <span class="sh">"</span><span class="s">&lt;unknown&gt;</span><span class="sh">"</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> cmd=</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s"> reason=subprocess-disabled</span><span class="sh">"</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># ë„¤íŠ¸ì›Œí¬ ì°¨ë‹¨ ì˜µì…˜
</span>        <span class="k">elif</span> <span class="n">block_network</span> <span class="ow">and</span> <span class="n">event</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">socket.</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> reason=network-disabled</span><span class="sh">"</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">sys</span><span class="p">.</span><span class="nf">addaudithook</span><span class="p">(</span><span class="n">_audit</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_child_worker</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">read_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                  <span class="n">write_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                  <span class="n">cwd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                  <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">block_subprocess</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">block_network</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">result_q</span><span class="p">:</span> <span class="n">mp</span><span class="p">.</span><span class="n">Queue</span><span class="p">):</span>
    <span class="c1"># stdout/stderr ìº¡ì²˜
</span>    <span class="n">stdout_buf</span><span class="p">,</span> <span class="n">stderr_buf</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="nc">StringIO</span><span class="p">(),</span> <span class="n">io</span><span class="p">.</span><span class="nc">StringIO</span><span class="p">()</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># CWD ì„¤ì •(ë¶€ëª¨ì—ëŠ” ì˜í–¥ ì—†ìŒ)
</span>        <span class="k">if</span> <span class="n">cwd</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

        <span class="c1"># ê°€ë“œ ì„¤ì¹˜
</span>        <span class="nf">_install_guard</span><span class="p">(</span><span class="n">read_paths</span><span class="p">,</span> <span class="n">write_paths</span><span class="p">,</span> <span class="n">allow_read_anywhere</span><span class="p">,</span>
                       <span class="n">block_subprocess</span><span class="o">=</span><span class="n">block_subprocess</span><span class="p">,</span> <span class="n">block_network</span><span class="o">=</span><span class="n">block_network</span><span class="p">)</span>

        <span class="c1"># ì½”ë“œ ì‹¤í–‰
</span>        <span class="n">g</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">__name__</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">}</span>
        <span class="kn">import</span> <span class="n">contextlib</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">redirect_stdout</span><span class="p">(</span><span class="n">stdout_buf</span><span class="p">),</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">redirect_stderr</span><span class="p">(</span><span class="n">stderr_buf</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nf">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[ERROR] exception while executing user code:</span><span class="sh">"</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">traceback</span><span class="p">.</span><span class="nf">print_exc</span><span class="p">()</span>

    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># ê°€ë“œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë“±
</span>        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[ERROR] sandbox init/exec failed: </span><span class="si">{</span><span class="nf">type</span><span class="p">(</span><span class="n">e</span><span class="p">).</span><span class="n">__name__</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">stderr_buf</span><span class="p">)</span>
        <span class="n">traceback</span><span class="p">.</span><span class="nf">print_exc</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">stderr_buf</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">result_q</span><span class="p">.</span><span class="nf">put</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">stdout_buf</span><span class="p">.</span><span class="nf">getvalue</span><span class="p">(),</span>
            <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">stderr_buf</span><span class="p">.</span><span class="nf">getvalue</span><span class="p">(),</span>
        <span class="p">})</span>

<span class="k">def</span> <span class="nf">_run_blocking</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">read_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                  <span class="n">write_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                  <span class="n">cwd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                  <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">timeout_sec</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                  <span class="n">block_subprocess</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">block_network</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">q</span><span class="p">:</span> <span class="n">mp</span><span class="p">.</span><span class="n">Queue</span> <span class="o">=</span> <span class="n">mp</span><span class="p">.</span><span class="nc">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">mp</span><span class="p">.</span><span class="nc">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_child_worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span>
        <span class="n">code</span><span class="p">,</span> <span class="n">read_paths</span><span class="p">,</span> <span class="n">write_paths</span><span class="p">,</span> <span class="n">cwd</span><span class="p">,</span> <span class="n">allow_read_anywhere</span><span class="p">,</span>
        <span class="n">block_subprocess</span><span class="p">,</span> <span class="n">block_network</span><span class="p">,</span> <span class="n">q</span>
    <span class="p">))</span>
    <span class="n">p</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>

    <span class="c1"># ê²°ê³¼ ëŒ€ê¸°(íƒ€ì„ì•„ì›ƒ ì§€ì›)
</span>    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">q</span><span class="p">.</span><span class="nf">empty</span><span class="p">():</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="nf">get</span><span class="p">()</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_alive</span><span class="p">():</span>
            <span class="c1"># ë¹„ì •ìƒ ì¢…ë£Œ ì¼€ì´ìŠ¤
</span>            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="n">exitcode</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="n">exitcode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
                      <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">[ERROR] child exited unexpectedly</span><span class="sh">"</span><span class="p">}</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&gt;</span> <span class="n">timeout_sec</span><span class="p">:</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">terminate</span><span class="p">()</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">124</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[TIMEOUT] exceeded </span><span class="si">{</span><span class="n">timeout_sec</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

    <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_alive</span><span class="p">():</span>
        <span class="n">p</span><span class="p">.</span><span class="nf">terminate</span><span class="p">()</span>
        <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_user_code_mp_async</span><span class="p">(</span>
    <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">read_paths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">write_paths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">cwd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">timeout_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
    <span class="n">block_subprocess</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="n">block_network</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    ë³„ë„ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì‚¬ìš©ì ì½”ë“œë¥¼ ì‹¤í–‰í•˜ê³  stdout/stderrë§Œ ìˆ˜ì§‘í•œë‹¤(ë¹„ë™ê¸°).
    - read_paths: ì½ê¸° í—ˆìš© ê²½ë¡œ ë¦¬ìŠ¤íŠ¸(í•˜ìœ„ í¬í•¨). Noneì´ë©´ ì–´ë””ë“  ì½ê¸° í—ˆìš©.
    - write_paths: ì“°ê¸° í—ˆìš© ê²½ë¡œ ë¦¬ìŠ¤íŠ¸(í•˜ìœ„ í¬í•¨). None/[]ë©´ ì“°ê¸° ì „ë¶€ ì°¨ë‹¨.
    - cwd: ìì‹ í”„ë¡œì„¸ìŠ¤ ì‹œì‘ CWD. Noneì´ë©´ ë¶€ëª¨ CWD ìƒì†. ìì‹ ë³€ê²½ì€ ë¶€ëª¨ì— ì˜í–¥ ì—†ìŒ.
    - block_subprocess: ì„œë¸Œí”„ë¡œì„¸ìŠ¤ í˜¸ì¶œ ì°¨ë‹¨ ì—¬ë¶€.
    - block_network: ë„¤íŠ¸ì›Œí¬ ì°¨ë‹¨ ì—¬ë¶€(ê¸°ë³¸ False).
    - timeout_sec: ì‹œê°„ ì´ˆê³¼ì‹œ returncode=124 ë°˜í™˜.
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="n">allow_read_anywhere</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">allow_read_anywhere</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">read_paths</span><span class="p">)</span>  <span class="c1"># ì½ê¸° ê²½ë¡œ ë¯¸ì§€ì • â†’ ì–´ë””ë“  ì½ê¸° í—ˆìš©
</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">loop</span><span class="p">.</span><span class="nf">run_in_executor</span><span class="p">(</span>
        <span class="bp">None</span><span class="p">,</span>
        <span class="n">_run_blocking</span><span class="p">,</span>
        <span class="n">code</span><span class="p">,</span>
        <span class="n">read_paths</span> <span class="ow">or</span> <span class="p">[],</span>
        <span class="n">write_paths</span> <span class="ow">or</span> <span class="p">[],</span>
        <span class="n">cwd</span><span class="p">,</span>
        <span class="n">allow_read_anywhere</span><span class="p">,</span>
        <span class="n">timeout_sec</span><span class="p">,</span>
        <span class="n">block_subprocess</span><span class="p">,</span>
        <span class="n">block_network</span><span class="p">,</span>
    <span class="p">)</span>

<span class="c1"># ë°ëª¨
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
        <span class="n">demo_code</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os, sys, subprocess
print(</span><span class="sh">"</span><span class="s">hello, cwd:</span><span class="sh">"</span><span class="s">, os.getcwd())
# í—ˆìš©ëœ ì“°ê¸°
open(</span><span class="sh">"</span><span class="s">out/ok.txt</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">).write(</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="s">)
# ê¸ˆì§€ëœ ì“°ê¸°
try:
    open(</span><span class="sh">"</span><span class="s">/etc/blocked.txt</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">).write(</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="s">)
except Exception as e:
    print(</span><span class="sh">"</span><span class="s">blocked write:</span><span class="sh">"</span><span class="s">, type(e).__name__)
# ì„œë¸Œí”„ë¡œì„¸ìŠ¤ ì‹œë„(ì°¨ë‹¨)
try:
    subprocess.check_output([</span><span class="sh">"</span><span class="s">echo</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">hi</span><span class="sh">"</span><span class="s">])
except Exception as e:
    print(</span><span class="sh">"</span><span class="s">blocked subproc:</span><span class="sh">"</span><span class="s">, type(e).__name__)
print(</span><span class="sh">"</span><span class="s">done</span><span class="sh">"</span><span class="s">)
</span><span class="sh">"""</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./work/out</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_user_code_mp_async</span><span class="p">(</span>
            <span class="n">demo_code</span><span class="p">,</span>
            <span class="n">read_paths</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>               <span class="c1"># ì½ê¸° ì–´ë””ë“ 
</span>            <span class="n">write_paths</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./work/out</span><span class="sh">"</span><span class="p">],</span>    <span class="c1"># ì—¬ê¸°ì—ë§Œ ì“°ê¸° í—ˆìš©
</span>            <span class="n">cwd</span><span class="o">=</span><span class="sh">"</span><span class="s">./work</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">timeout_sec</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">block_subprocess</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">block_network</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">RC:</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">])</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDOUT:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">])</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDERR:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">])</span>

    <span class="c1"># Windows spawn ëŒ€ë¹„
</span>    <span class="k">if</span> <span class="n">sys</span><span class="p">.</span><span class="n">platform</span> <span class="o">==</span> <span class="sh">"</span><span class="s">win32</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">mp</span><span class="p">.</span><span class="nf">freeze_support</span><span class="p">()</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>í•µì‹¬ í¬ì¸íŠ¸</p>

<ol>
  <li>
    <p>ë¬¸ìì—´ í…œí”Œë¦¿ë¡œ â€œìì‹ ìŠ¤í¬ë¦½íŠ¸â€ë¥¼ ë§Œë“¤ì§€ ì•ŠëŠ”ë‹¤. ëª¨ë“ˆ ë‚´ì˜ <code class="language-plaintext highlighter-rouge">_child_worker</code>ê°€ ë³„ë„ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì‹¤í–‰ë˜ì–´ exec(code)ë¥¼ ëŒë¦°ë‹¤.</p>
  </li>
  <li>
    <p>read_paths, write_pathsë¥¼ ë¦¬ìŠ¤íŠ¸ë¡œ ë°›ì•„ í•˜ìœ„ê¹Œì§€ í—ˆìš©í•œë‹¤. ì“°ê¸° ì‹œë„ëŠ” write_paths ë°”ê¹¥ì´ë©´ [AUDIT] ë¼ì¸ì´ stderrì— ì°íˆê³  PermissionErrorê°€ ë‚œë‹¤. ì–´ë–¤ íŒŒì¼ì„ ì“°ë ¤ í–ˆëŠ”ì§€, ì–´ë–¤ ì¡°ì‘ì„ í•˜ë ¤ í–ˆëŠ”ì§€ ëª¨ë‘ ê¸°ë¡ëœë‹¤.</p>
  </li>
  <li>
    <p>async/awaitëŠ” <code class="language-plaintext highlighter-rouge">run_in_executor</code>ë¡œ ë©€í‹°í”„ë¡œì„¸ìŠ¤ ì‘ì—…ì„ ë…¼ë¸”ë¡œí‚¹ìœ¼ë¡œ ê°ì‹¼ë‹¤. íƒ€ì„ì•„ì›ƒì´ ë‚˜ë©´ ìì‹ì„ terminateí•˜ê³  returncode=124ë¡œ ëŒë ¤ì¤€ë‹¤.</p>
  </li>
  <li>
    <p>ìì‹ì—ì„œ cwdë¥¼ ë°”ê¿”ë„ ë¶€ëª¨ì—ëŠ” ì˜í–¥ ì—†ë‹¤. ì‹œì‘ CWDëŠ” ì¸ìë¡œ ì§€ì • ê°€ëŠ¥í•˜ë‹¤.</p>
  </li>
  <li>
    <p>ì„œë¸Œí”„ë¡œì„¸ìŠ¤, os.systemì„ ì°¨ë‹¨í–ˆê³ , í•„ìš”í•˜ë©´ <code class="language-plaintext highlighter-rouge">block_network=True</code>ë¡œ ì†Œì¼“ë„ ë§‰ì„ ìˆ˜ ìˆë‹¤.</p>
  </li>
</ol>

<p>ì—¬ê¸°ì„œ ì„¸ì…˜ ìœ ì§€í˜•ì´ í•„ìš”í•´ì§€ë©´, í”„ë¡œì„¸ìŠ¤ë¥¼ ì˜¤ë˜ ì‚´ë ¤ë‘ê³  íë¡œ ì—¬ëŸ¬ ì½”ë“œë¥¼ ë³´ë‚´ëŠ” â€œì„¸ì…˜ ì›Œì»¤â€ íŒ¨í„´ìœ¼ë¡œ í™•ì¥í•˜ë©´ ëœë‹¤. ì§€ê¸ˆì€ ìš”êµ¬í•˜ì‹  â€œê°„ë‹¨í•˜ê³  ì˜ì¡´ì„± ì—†ëŠ”, async ë©€í‹°í”„ë¡œì„¸ìŠ¤ + stdout/stderrë§Œ ìˆ˜ì§‘â€ì— ë§ì¶˜ ìµœì†Œ êµ¬í˜„ì´ë‹¤.</p>

<p class="chat--user">

ê·¼ë° ì´ëŸ° ì‹ìœ¼ë¡œ ìˆ˜í–‰í•˜ë©´ parent ì½”ë“œì— ìˆëŠ” ê¸€ë¡œë²Œ ë³€ìˆ˜ ê°™ì€ê±¸ user codeê°€ ì ‘ê·¼í• ìˆ˜ë„ ìˆê²Œ ë˜ë‚˜?

</p>

<p>í•µì‹¬ë§Œ ë”± ì •ë¦¬.</p>

<ol>
  <li>
    <p>ì§€ê¸ˆ ë©€í‹°í”„ë¡œì„¸ìŠ¤ ì„¤ê³„ì—ì„œ, ê¸°ë³¸ì´ Linuxì˜ forkë©´ ìì‹ì´ ë¶€ëª¨ì˜ ë©”ëª¨ë¦¬ ìŠ¤ëƒ…ìƒ·ì„ â€œì½ê¸°â€ëŠ” í•  ìˆ˜ ìˆë‹¤. ì˜ˆì»¨ëŒ€ user codeê°€ import <strong>main</strong> í•´ì„œ ëª¨ë“ˆ ì „ì—­ì„ ë³´ë©´, í¬í¬ ì‹œì ì˜ ê°’ë“¤ì´ ë³´ì¸ë‹¤. ë¶€ëª¨ ìƒíƒœë¥¼ ë°”ê¾¸ì§„ ëª»í•˜ì§€ë§Œ, ì „ì—­ ê°’ì´ ë…¸ì¶œë˜ëŠ” ê±´ ë§ë‹¤.</p>
  </li>
  <li>
    <p>ì´ê±¸ ì›ì²œ ì°¨ë‹¨í•˜ë ¤ë©´ ì‹œì‘ ë°©ë²•ì„ spawnìœ¼ë¡œ ê°•ì œí•˜ë©´ ëœë‹¤. spawnì€ ìƒˆ ì¸í„°í”„ë¦¬í„°ë¥¼ ê¹¨ë—í•˜ê²Œ ë„ìš°ê³  ëª¨ë“ˆì„ ë‹¤ì‹œ ì„í¬íŠ¸í•˜ë¯€ë¡œ, ë¶€ëª¨ì˜ ëŸ°íƒ€ì„ ì „ì—­ ê°ì²´ê°€ ê·¸ëŒ€ë¡œ ë³´ì´ì§€ ì•ŠëŠ”ë‹¤. ë„¤ê°€ ì˜ë„ì ìœ¼ë¡œ ë„˜ê²¨ì¤€ ê°’(ì¸ì, í ë©”ì‹œì§€, execì— ì£¼ëŠ” dict)ë§Œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë‹¤. Windows/macOSëŠ” ê¸°ë³¸ì´ spawn, LinuxëŠ” ê¸°ë³¸ì´ forkë¼ì„œ ê°•ì œí•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•˜ë‹¤.</p>
  </li>
  <li>
    <p>ì¶”ê°€ë¡œ í™˜ê²½ë³€ìˆ˜ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ìƒì†ëœë‹¤. ë¯¼ê° ì •ë³´ê°€ ìˆë‹¤ë©´ ìì‹ì—ì„œ os.environì„ ì´ˆê¸°í™”í•˜ê±°ë‚˜, ë¶€ëª¨ì—ì„œ run_user_code_mp_async í˜¸ì¶œ ì „ì— â€œí—ˆìš© ë¦¬ìŠ¤íŠ¸ë§Œâ€ ë„˜ê¸°ëŠ” ë°©ì‹ì„ ì¨ë¼.</p>
  </li>
</ol>

<p>ì•„ë˜ëŠ” ë‚´ ì´ì „ ì½”ë“œì— â€œspawn ê°•ì œ + í™˜ê²½ë³€ìˆ˜ ì •ë¦¬ ì˜µì…˜â€ì„ ë„£ì€ íŒ¨ì¹˜ë‹¤. ì´ëŸ¬ë©´ user codeëŠ” ë¶€ëª¨ ì „ì—­ì— ì§ì ‘ ì ‘ê·¼í•  ìˆ˜ ì—†ë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># patch: spawn ì‚¬ìš© + ì„ íƒì  í™˜ê²½ë³€ìˆ˜ ì •ë¦¬
</span><span class="kn">import</span> <span class="n">multiprocessing</span> <span class="k">as</span> <span class="n">mp</span>

<span class="k">def</span> <span class="nf">_child_worker</span><span class="p">(...,</span> <span class="n">sanitize_env</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">allowed_env_keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="bp">None</span><span class="p">,</span> <span class="p">...):</span>
    <span class="c1"># CWD ì„¤ì •
</span>    <span class="k">if</span> <span class="n">cwd</span><span class="p">:</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

    <span class="c1"># í™˜ê²½ë³€ìˆ˜ ì •ë¦¬(ì„ íƒ)
</span>    <span class="k">if</span> <span class="n">sanitize_env</span><span class="p">:</span>
        <span class="n">keep</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">allowed_env_keys</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nf">list</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">:</span>
                <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="c1"># ê°€ë“œ ì„¤ì¹˜
</span>    <span class="nf">_install_guard</span><span class="p">(...)</span>

    <span class="c1"># ì™„ì „íˆ ê¹¨ë—í•œ ê¸€ë¡œë²Œ dictë¡œ ì‹¤í–‰
</span>    <span class="n">g</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">__name__</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">redirect_stdout</span><span class="p">(</span><span class="n">stdout_buf</span><span class="p">),</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">redirect_stderr</span><span class="p">(</span><span class="n">stderr_buf</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nf">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[ERROR] exception while executing user code:</span><span class="sh">"</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="n">traceback</span><span class="p">.</span><span class="nf">print_exc</span><span class="p">()</span>
    <span class="bp">...</span>

<span class="k">def</span> <span class="nf">_run_blocking</span><span class="p">(...,</span> <span class="n">sanitize_env</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">allowed_env_keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="bp">None</span><span class="p">,</span> <span class="p">...)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">mp</span><span class="p">.</span><span class="nf">get_context</span><span class="p">(</span><span class="sh">"</span><span class="s">spawn</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># ì—¬ê¸°!
</span>    <span class="n">q</span><span class="p">:</span> <span class="n">mp</span><span class="p">.</span><span class="n">Queue</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_child_worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(...,</span> <span class="n">sanitize_env</span><span class="p">,</span> <span class="n">allowed_env_keys</span><span class="p">,</span> <span class="p">...))</span>
    <span class="n">p</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="bp">...</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_user_code_mp_async</span><span class="p">(...,</span> <span class="n">sanitize_env</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">allowed_env_keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="p">...):</span>
    <span class="bp">...</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">loop</span><span class="p">.</span><span class="nf">run_in_executor</span><span class="p">(</span>
        <span class="bp">None</span><span class="p">,</span>
        <span class="n">_run_blocking</span><span class="p">,</span>
        <span class="n">code</span><span class="p">,</span>
        <span class="n">read_paths</span> <span class="ow">or</span> <span class="p">[],</span>
        <span class="n">write_paths</span> <span class="ow">or</span> <span class="p">[],</span>
        <span class="n">cwd</span><span class="p">,</span>
        <span class="n">allow_read_anywhere</span><span class="p">,</span>
        <span class="n">timeout_sec</span><span class="p">,</span>
        <span class="n">block_subprocess</span><span class="p">,</span>
        <span class="n">block_network</span><span class="p">,</span>
        <span class="n">sanitize_env</span><span class="p">,</span>
        <span class="n">allowed_env_keys</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></div>

<p>ìš”ì  ì²´í¬</p>

<ul>
  <li>
    <p>spawnì„ ì“°ë©´ user codeëŠ” ë¶€ëª¨ ì „ì—­ì— ì ‘ê·¼í•˜ì§€ ëª»í•œë‹¤. ë„¤ê°€ execì— ë„£ì€ dict(g)ì™€ ë„¤ê°€ ë„˜ê¸´ ì¸ìë§Œ ë³¸ë‹¤.</p>
  </li>
  <li>
    <p>forkë¥¼ ì“°ë©´ import <strong>main</strong> ë“±ìœ¼ë¡œ ë¶€ëª¨ ëª¨ë“ˆ ì „ì—­ â€œê°’â€ì„ ì½ì„ ìˆ˜ ìˆë‹¤. ê·¸ë˜ì„œ Linuxì—ì„œëŠ” ë°˜ë“œì‹œ spawnìœ¼ë¡œ ê°•ì œí•˜ì.</p>
  </li>
  <li>
    <p>ìì‹ì—ì„œ os.chdirë¡œ CWDë¥¼ ë°”ê¿”ë„ ë¶€ëª¨ì—ëŠ” ì˜í–¥ ì—†ë‹¤. í”„ë¡œì„¸ìŠ¤ë³„ë¡œ ë…ë¦½ì´ë‹¤.</p>
  </li>
  <li>
    <p>í™˜ê²½ë³€ìˆ˜ëŠ” ê¸°ë³¸ ìƒì†ì´ë¼ ë¯¼ê° ì •ë³´ê°€ ìˆë‹¤ë©´ sanitize_env=Trueì™€ allowed_env_keysë¡œ ìµœì†Œí™”í•˜ì.</p>
  </li>
</ul>

<p>ì´ ì„¤ì •ì´ë©´, LLMì´ ì•…ì˜ì ì´ì§„ ì•Šë‹¤ëŠ” ì „ì œì—ì„œ â€œë¶€ëª¨ ì „ì—­ ì ‘ê·¼â€ ê±±ì •ì€ ê¹”ë”íˆ ì •ë¦¬ëœë‹¤.</p>

<p class="chat--user">

ìŒ OK. ì „ì²´ ì½”ë“œ ë‹¤ ì¨ì¤˜.

</p>

<p>ì¢‹ì•„. ì•„ë˜ ìŠ¤í¬ë¦½íŠ¸ í•˜ë‚˜ë¡œ ëë‚œë‹¤. ë©€í‹°í”„ë¡œì„¸ìŠ¤ë¡œ ë¶„ë¦¬í•´ exec(code)ë¥¼ ëŒë¦¬ê³ , spawn ì»¨í…ìŠ¤íŠ¸ë¡œ ë¶€ëª¨ ì „ì—­ ë…¸ì¶œì„ ë§‰ì•˜ë‹¤. read_pathsì™€ write_paths ë¦¬ìŠ¤íŠ¸ë¡œ ê²½ë¡œ í—ˆìš©ì„ ì„¤ì •í•˜ê³ , ìì‹ í”„ë¡œì„¸ìŠ¤ ì‹œì‘ cwdë„ ì„ íƒì ìœ¼ë¡œ ì§€ì •í•œë‹¤. íŒŒì¼Â·ì„œë¸Œí”„ë¡œì„¸ìŠ¤(ì˜µì…˜ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬) ì‹œë„ëŠ” audit hookì—ì„œ ì°¨ë‹¨í•˜ë©°, ì–´ë–¤ ê²½ë¡œ/ì»¤ë§¨ë“œì˜€ëŠ”ì§€ stderrì— ìì„¸íˆ ë‚¨ê¸´ë‹¤. ë¹„ë™ê¸° APIëŠ” run_user_code_mp_async í•œ í•¨ìˆ˜ë§Œ ì“°ë©´ ëœë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># sandbox_async_multiprocess_full.py
# Python 3.8+ / ì™¸ë¶€ ì˜ì¡´ì„± ì—†ìŒ
</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">multiprocessing</span> <span class="k">as</span> <span class="n">mp</span>
<span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">traceback</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">contextlib</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>

<span class="c1"># ============== ë‚´ë¶€: ê°€ë“œ ì„¤ì¹˜ ==============
</span><span class="k">def</span> <span class="nf">_install_guard</span><span class="p">(</span><span class="n">read_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                   <span class="n">write_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                   <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                   <span class="n">block_subprocess</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                   <span class="n">block_network</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">rp</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">read_paths</span> <span class="ow">or</span> <span class="p">[])]</span>
    <span class="n">wp</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">write_paths</span> <span class="ow">or</span> <span class="p">[])]</span>

    <span class="k">def</span> <span class="nf">_real</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">roots</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">roots</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="nf">_real</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="n">r</span> <span class="ow">or</span> <span class="n">path</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_audit</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="c1"># íŒŒì¼ ì—´ê¸°
</span>        <span class="k">if</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">os.open</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">write</span> <span class="o">=</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="ow">in</span> <span class="n">mode</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">))</span> <span class="ow">or</span> \
                    <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">O_WRONLY</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_RDWR</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_CREAT</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_TRUNC</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_APPEND</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">write</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">wp</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> path=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s"> mode=</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s"> flags=</span><span class="si">{</span><span class="n">flags</span><span class="si">}</span><span class="s"> reason=write-outside-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="nf">if </span><span class="p">(</span><span class="ow">not</span> <span class="n">write</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">allow_read_anywhere</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">rp</span> <span class="o">+</span> <span class="n">wp</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> path=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s"> reason=read-not-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># íŒŒì¼ ì¡°ì‘ë¥˜
</span>        <span class="k">elif</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">os.rename</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.replace</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nf">_under_any</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">wp</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">wp</span><span class="p">)):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> src=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">src</span><span class="p">)</span><span class="si">}</span><span class="s"> dst=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span><span class="si">}</span><span class="s"> reason=op-outside-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">os.remove</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.unlink</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.mkdir</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.makedirs</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.rmdir</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.chmod</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">wp</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> path=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s"> reason=op-outside-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># ì„œë¸Œí”„ë¡œì„¸ìŠ¤/ì‹œìŠ¤í…œ í˜¸ì¶œ
</span>        <span class="k">elif</span> <span class="n">block_subprocess</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">subprocess.</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">event</span> <span class="o">==</span> <span class="sh">"</span><span class="s">os.system</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="sh">"</span><span class="s">&lt;unknown&gt;</span><span class="sh">"</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> cmd=</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s"> reason=subprocess-disabled</span><span class="sh">"</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># ë„¤íŠ¸ì›Œí¬ ì°¨ë‹¨ ì˜µì…˜
</span>        <span class="k">elif</span> <span class="n">block_network</span> <span class="ow">and</span> <span class="n">event</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">socket.</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> reason=network-disabled</span><span class="sh">"</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">sys</span><span class="p">.</span><span class="nf">addaudithook</span><span class="p">(</span><span class="n">_audit</span><span class="p">)</span>

<span class="c1"># ============== ë‚´ë¶€: ìì‹ ì›Œì»¤ ==============
</span><span class="k">def</span> <span class="nf">_child_worker</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">read_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                  <span class="n">write_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                  <span class="n">cwd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                  <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">block_subprocess</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">block_network</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">sanitize_env</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">allowed_env_keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
                  <span class="n">result_q</span><span class="p">:</span> <span class="n">mp</span><span class="p">.</span><span class="n">Queue</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">stdout_buf</span><span class="p">,</span> <span class="n">stderr_buf</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="nc">StringIO</span><span class="p">(),</span> <span class="n">io</span><span class="p">.</span><span class="nc">StringIO</span><span class="p">()</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># CWD ì„¤ì •(ë¶€ëª¨ì—ëŠ” ì˜í–¥ ì—†ìŒ)
</span>        <span class="k">if</span> <span class="n">cwd</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">cwd</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

        <span class="c1"># í™˜ê²½ë³€ìˆ˜ ìµœì†Œí™”(ì„ íƒ)
</span>        <span class="k">if</span> <span class="n">sanitize_env</span><span class="p">:</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">allowed_env_keys</span> <span class="ow">or</span> <span class="p">[</span><span class="sh">"</span><span class="s">PATH</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">PYTHONPATH</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">HOME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">TMPDIR</span><span class="sh">"</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nf">list</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">:</span>
                    <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="c1"># ê°€ë“œ ì„¤ì¹˜
</span>        <span class="nf">_install_guard</span><span class="p">(</span><span class="n">read_paths</span><span class="p">,</span> <span class="n">write_paths</span><span class="p">,</span> <span class="n">allow_read_anywhere</span><span class="p">,</span>
                       <span class="n">block_subprocess</span><span class="o">=</span><span class="n">block_subprocess</span><span class="p">,</span> <span class="n">block_network</span><span class="o">=</span><span class="n">block_network</span><span class="p">)</span>

        <span class="c1"># execìš© ê¹¨ë—í•œ ê¸€ë¡œë²Œ dict
</span>        <span class="n">g</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">__name__</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">}</span>

        <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">redirect_stdout</span><span class="p">(</span><span class="n">stdout_buf</span><span class="p">),</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">redirect_stderr</span><span class="p">(</span><span class="n">stderr_buf</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nf">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[ERROR] exception while executing user code:</span><span class="sh">"</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">traceback</span><span class="p">.</span><span class="nf">print_exc</span><span class="p">()</span>

    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[ERROR] sandbox init/exec failed: </span><span class="si">{</span><span class="nf">type</span><span class="p">(</span><span class="n">e</span><span class="p">).</span><span class="n">__name__</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">stderr_buf</span><span class="p">)</span>
        <span class="n">traceback</span><span class="p">.</span><span class="nf">print_exc</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">stderr_buf</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">result_q</span><span class="p">.</span><span class="nf">put</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">stdout_buf</span><span class="p">.</span><span class="nf">getvalue</span><span class="p">(),</span>
            <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">stderr_buf</span><span class="p">.</span><span class="nf">getvalue</span><span class="p">(),</span>
        <span class="p">})</span>

<span class="c1"># ============== ë‚´ë¶€: ë™ê¸° ì‹¤í–‰(ìŠ¤ë ˆë“œí’€ì—ì„œ í˜¸ì¶œ) ==============
</span><span class="k">def</span> <span class="nf">_run_blocking</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">read_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                  <span class="n">write_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                  <span class="n">cwd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                  <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">timeout_sec</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                  <span class="n">block_subprocess</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">block_network</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">sanitize_env</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                  <span class="n">allowed_env_keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">mp</span><span class="p">.</span><span class="nf">get_context</span><span class="p">(</span><span class="sh">"</span><span class="s">spawn</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># ë¶€ëª¨ ì „ì—­ ë…¸ì¶œ ë°©ì§€
</span>    <span class="n">q</span><span class="p">:</span> <span class="n">mp</span><span class="p">.</span><span class="n">Queue</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_child_worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span>
        <span class="n">code</span><span class="p">,</span> <span class="n">read_paths</span><span class="p">,</span> <span class="n">write_paths</span><span class="p">,</span> <span class="n">cwd</span><span class="p">,</span> <span class="n">allow_read_anywhere</span><span class="p">,</span>
        <span class="n">block_subprocess</span><span class="p">,</span> <span class="n">block_network</span><span class="p">,</span> <span class="n">sanitize_env</span><span class="p">,</span> <span class="n">allowed_env_keys</span><span class="p">,</span> <span class="n">q</span>
    <span class="p">))</span>
    <span class="n">p</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>

    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    <span class="n">result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">q</span><span class="p">.</span><span class="nf">empty</span><span class="p">():</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="nf">get</span><span class="p">()</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_alive</span><span class="p">():</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="n">exitcode</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="n">exitcode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
                      <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">[ERROR] child exited unexpectedly</span><span class="sh">"</span><span class="p">}</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&gt;</span> <span class="n">timeout_sec</span><span class="p">:</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">terminate</span><span class="p">()</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">124</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[TIMEOUT] exceeded </span><span class="si">{</span><span class="n">timeout_sec</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

    <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_alive</span><span class="p">():</span>
        <span class="n">p</span><span class="p">.</span><span class="nf">terminate</span><span class="p">()</span>
        <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span> <span class="ow">or</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">[ERROR] no result</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ============== ê³µê°œ: ë¹„ë™ê¸° API ==============
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">run_user_code_mp_async</span><span class="p">(</span>
    <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">read_paths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">write_paths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">cwd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">timeout_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
    <span class="n">block_subprocess</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="n">block_network</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="n">sanitize_env</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="n">allowed_env_keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    ë³„ë„ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì‚¬ìš©ì ì½”ë“œë¥¼ ì‹¤í–‰í•˜ê³  stdout/stderrë¥¼ ìˆ˜ì§‘í•´ ë°˜í™˜(ë¹„ë™ê¸°).
    - read_paths: ì½ê¸° í—ˆìš© ê²½ë¡œ ë¦¬ìŠ¤íŠ¸(í•˜ìœ„ í¬í•¨). Noneì´ë©´ ì–´ë””ë“  ì½ê¸° í—ˆìš©.
    - write_paths: ì“°ê¸° í—ˆìš© ê²½ë¡œ ë¦¬ìŠ¤íŠ¸(í•˜ìœ„ í¬í•¨). None/[]ë©´ ì“°ê¸° ì „ë¶€ ì°¨ë‹¨.
    - cwd: ìì‹ í”„ë¡œì„¸ìŠ¤ ì‹œì‘ ì‘ì—… ë””ë ‰í„°ë¦¬. ìì‹ì˜ os.chdirëŠ” ë¶€ëª¨ì— ì˜í–¥ ì—†ìŒ.
    - allow_read_anywhere: ëª…ì‹œì  ì œì–´(ê¸°ë³¸ None â†’ read_paths ë¯¸ì§€ì •ì´ë©´ True).
    - block_subprocess: ì„œë¸Œí”„ë¡œì„¸ìŠ¤ í˜¸ì¶œ ì°¨ë‹¨ ì—¬ë¶€.
    - block_network: ë„¤íŠ¸ì›Œí¬ ì°¨ë‹¨ ì—¬ë¶€.
    - sanitize_env: ìì‹ í™˜ê²½ë³€ìˆ˜ë¥¼ ìµœì†Œí™”í• ì§€ ì—¬ë¶€.
    - allowed_env_keys: sanitize_env=Trueì¼ ë•Œ ë³´ì¡´í•  í‚¤ ëª©ë¡(ê¸°ë³¸ PATH, PYTHONPATH, HOME, TMPDIR).
    - timeout_sec: ì‹œê°„ ì´ˆê³¼ ì‹œ returncode=124.
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="n">allow_read_anywhere</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">allow_read_anywhere</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">read_paths</span><span class="p">)</span>

    <span class="c1"># ì“°ê¸° ê²½ë¡œëŠ” ë¯¸ë¦¬ ë§Œë“¤ì–´ ë‘”ë‹¤.
</span>    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">(</span><span class="n">write_paths</span> <span class="ow">or</span> <span class="p">[]):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">loop</span><span class="p">.</span><span class="nf">run_in_executor</span><span class="p">(</span>
        <span class="bp">None</span><span class="p">,</span>
        <span class="n">_run_blocking</span><span class="p">,</span>
        <span class="n">code</span><span class="p">,</span>
        <span class="n">read_paths</span> <span class="ow">or</span> <span class="p">[],</span>
        <span class="n">write_paths</span> <span class="ow">or</span> <span class="p">[],</span>
        <span class="n">cwd</span><span class="p">,</span>
        <span class="n">allow_read_anywhere</span><span class="p">,</span>
        <span class="n">timeout_sec</span><span class="p">,</span>
        <span class="n">block_subprocess</span><span class="p">,</span>
        <span class="n">block_network</span><span class="p">,</span>
        <span class="n">sanitize_env</span><span class="p">,</span>
        <span class="n">allowed_env_keys</span><span class="p">,</span>
    <span class="p">)</span>

<span class="c1"># ============== ë°ëª¨ ==============
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
        <span class="n">demo_code</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os, sys, subprocess
print(</span><span class="sh">"</span><span class="s">hello, cwd:</span><span class="sh">"</span><span class="s">, os.getcwd())
# í—ˆìš©ëœ ì“°ê¸°
open(</span><span class="sh">"</span><span class="s">out/ok.txt</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">).write(</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="s">)
# ê¸ˆì§€ëœ ì“°ê¸°
try:
    open(</span><span class="sh">"</span><span class="s">/etc/blocked.txt</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">).write(</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="s">)
except Exception as e:
    print(</span><span class="sh">"</span><span class="s">blocked write:</span><span class="sh">"</span><span class="s">, type(e).__name__)
# ì„œë¸Œí”„ë¡œì„¸ìŠ¤ ì‹œë„(ì°¨ë‹¨)
try:
    subprocess.check_output([</span><span class="sh">"</span><span class="s">echo</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">hi</span><span class="sh">"</span><span class="s">])
except Exception as e:
    print(</span><span class="sh">"</span><span class="s">blocked subproc:</span><span class="sh">"</span><span class="s">, type(e).__name__)
print(</span><span class="sh">"</span><span class="s">done</span><span class="sh">"</span><span class="s">)
</span><span class="sh">"""</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="sh">"</span><span class="s">./work/out</span><span class="sh">"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_user_code_mp_async</span><span class="p">(</span>
            <span class="n">demo_code</span><span class="p">,</span>
            <span class="n">read_paths</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>               <span class="c1"># ì½ê¸° ì–´ë””ë“  í—ˆìš©
</span>            <span class="n">write_paths</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./work/out</span><span class="sh">"</span><span class="p">],</span>    <span class="c1"># ì—¬ê¸°ë§Œ ì“°ê¸° í—ˆìš©
</span>            <span class="n">cwd</span><span class="o">=</span><span class="sh">"</span><span class="s">./work</span><span class="sh">"</span><span class="p">,</span>                  <span class="c1"># ìì‹ ì‹œì‘ CWD
</span>            <span class="n">timeout_sec</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">block_subprocess</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">block_network</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">sanitize_env</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>             <span class="c1"># í™˜ê²½ ìµœì†Œí™”
</span>            <span class="n">allowed_env_keys</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">PATH</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">PYTHONPATH</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">HOME</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">TMPDIR</span><span class="sh">"</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">RC:</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">])</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDOUT:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">])</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDERR:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">sys</span><span class="p">.</span><span class="n">platform</span> <span class="o">==</span> <span class="sh">"</span><span class="s">win32</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">mp</span><span class="p">.</span><span class="nf">freeze_support</span><span class="p">()</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>ì´ì œ ì´ íŒŒì¼ì„ ëª¨ë“ˆë¡œ ë‘ê³  run_user_code_mp_asyncë§Œ í˜¸ì¶œí•˜ë©´ ëœë‹¤. í•„ìš”í•˜ë©´ read_paths/write_paths/cwdë¥¼ ì—ì´ì „íŠ¸ íˆ´ ì¸ìë¡œ ë…¸ì¶œí•˜ê³ , í™˜ê²½ë³€ìˆ˜ ìµœì†Œí™”ë‚˜ ë„¤íŠ¸ì›Œí¬ ì°¨ë‹¨ì€ ì„œë²„ ìª½ ì •ì±…ìœ¼ë¡œ ê³ ì •í•´ë„ ëœë‹¤.</p>

<p class="chat--user">

ë§Œì•½ì— multi threadingì´ë©´ ì–´ë–»ê²Œ ë¼?

</p>

<p>ìš”ì§€ëŠ” â€œìŠ¤ë ˆë“œë¡œ ëŒë¦¬ëŠëƒ, í”„ë¡œì„¸ìŠ¤ë¡œ ëŒë¦¬ëŠëƒâ€ë¥¼ ë‚˜ëˆ  ë³´ì•„ì•¼ í•´.</p>

<ol>
  <li>ìš°ë¦¬ ì„¤ê³„ì²˜ëŸ¼ ë©€í‹°í”„ë¡œì„¸ìŠ¤ë¡œ ìƒŒë“œë°•ìŠ¤ë¥¼ ë„ìš´ ë’¤, ê·¸ ì•ˆì—ì„œ ìœ ì € ì½”ë“œê°€ ë©€í‹°ìŠ¤ë ˆë“œë¥¼ ì“°ëŠ” ê²½ìš°</li>
</ol>

<ul>
  <li>
    <p>ê´œì°®ë‹¤. <code class="language-plaintext highlighter-rouge">sys.addaudithook</code>ì€ â€œí”„ë¡œì„¸ìŠ¤ ë‹¨ìœ„â€ë¡œ ì„¤ì¹˜ë˜ê³ , ê·¸ í”„ë¡œì„¸ìŠ¤ì˜ ëª¨ë“  ìŠ¤ë ˆë“œì—ì„œ ë°œìƒí•œ ì´ë²¤íŠ¸ì— ì ìš©ëœë‹¤. ì¦‰ ìœ ì € ì½”ë“œê°€ ìŠ¤ë ˆë“œë¥¼ ì—¬ëŸ¬ ê°œ ë§Œë“¤ì–´ë„ íŒŒì¼ ì“°ê¸° ì°¨ë‹¨, <code class="language-plaintext highlighter-rouge">subprocess</code> ì°¨ë‹¨ì€ ê·¸ëŒ€ë¡œ ë¨¹íŒë‹¤.</p>
  </li>
  <li>
    <p>ì£¼ì˜ì ì€ í”„ë¡œì„¸ìŠ¤ ë‹¨ìœ„ ì†ì„±ë“¤(CWD, í™˜ê²½ë³€ìˆ˜ ë“±)ì€ ìŠ¤ë ˆë“œ ê°„ ê³µìœ ëœë‹¤ëŠ” ê²ƒ. í•˜ì§€ë§Œ ì´ê±´ ë¶€ëª¨ì—ê²ŒëŠ” ì˜í–¥ ì—†ë‹¤(ë¶€ëª¨ëŠ” ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤).</p>
  </li>
  <li>
    <p>ì•ˆì •ì„± ë³´ê°• íŒ: ìì‹ í”„ë¡œì„¸ìŠ¤ ì§„ì… ì§í›„ <code class="language-plaintext highlighter-rouge">resource</code>ë¡œ í•œë„(ì‹œê°„/ë©”ëª¨ë¦¬/íŒŒì¼í¬ê¸°)ë¥¼ ê±¸ë©´, ìŠ¤ë ˆë“œ í­ì£¼ë¡œ ì¸í•œ ìì› ì¡ì•„ë¨¹ê¸°ë„ ë°©ì§€ëœë‹¤.</p>
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">resource</span>
<span class="n">resource</span><span class="p">.</span><span class="nf">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">RLIMIT_CPU</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">resource</span><span class="p">.</span><span class="nf">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">RLIMIT_AS</span><span class="p">,</span> <span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,)</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
<span class="n">resource</span><span class="p">.</span><span class="nf">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">RLIMIT_FSIZE</span><span class="p">,</span> <span class="p">(</span><span class="mi">200</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,)</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>ìœ„ 3ì¤„ì„ ë‚´ê°€ ì¤€ <code class="language-plaintext highlighter-rouge">_child_worker</code> ë§¨ ì•ìª½(ê°€ë“œ ì„¤ì¹˜ ì§í›„) ì •ë„ì— ë„£ìœ¼ë©´ ì¶©ë¶„í•´.</p>

<ol>
  <li>ìƒŒë“œë°•ìŠ¤ë¥¼ â€œìŠ¤ë ˆë“œâ€ë¡œë§Œ ëŒë¦¬ê³ (=ë¶€ëª¨ì™€ ê°™ì€ í”„ë¡œì„¸ìŠ¤), ë¹„ë™ê¸°/ìŠ¤ë ˆë“œë¡œ ë³‘ë ¬ ì‹¤í–‰í•˜ê³  ì‹¶ì€ ê²½ìš°</li>
</ol>

<ul>
  <li>
    <p>ë¹„ê¶Œì¥. ê°™ì€ í”„ë¡œì„¸ìŠ¤ì—ì„œ <code class="language-plaintext highlighter-rouge">exec</code>ì„ ëŒë¦¬ë©´ ë©”ëª¨ë¦¬ ê²©ë¦¬ê°€ ì—†ë‹¤. ìœ ì € ì½”ë“œê°€ ë¶€ëª¨ì˜ ì „ì—­ ìƒíƒœë¥¼ ë“¤ì—¬ë‹¤ë³´ê±°ë‚˜ ê±´ë“œë¦´ ì—¬ì§€ê°€ ìƒê¸´ë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ê°™ì€ í”„ë¡œì„¸ìŠ¤ì—ì„œ <code class="language-plaintext highlighter-rouge">import __main__</code>, <code class="language-plaintext highlighter-rouge">inspect</code>ë¡œ í”„ë ˆì„ì„ íƒ€ê³  ì˜¬ë¼ê°€ë©´ ë¶€ëª¨ ìŠ¤ì½”í”„ì— ë‹¿ì„ ìˆ˜ ìˆë‹¤.</p>
  </li>
  <li>
    <p>ë˜í•œ ê°™ì€ í”„ë¡œì„¸ìŠ¤ë¼ <code class="language-plaintext highlighter-rouge">os.chdir</code>ì€ ì „ì—­ CWDë¥¼ ë°”ê¿”ì„œ â€œë‹¤ë¥¸ ìŠ¤ë ˆë“œ/ë¶€ëª¨ ë¡œì§â€ì—ë„ ì˜í–¥ì„ ì¤€ë‹¤. í™˜ê²½ë³€ìˆ˜ ìˆ˜ì •ë„ ë§ˆì°¬ê°€ì§€. íŒŒì¼ê°€ë“œ(audit hook)ëŠ” ìŠ¤ë ˆë“œ ì „ì²´ì— ì ìš©ë˜ì§€ë§Œ, â€œìƒíƒœ ê²©ë¦¬â€ê°€ ì•ˆ ëœë‹¤.</p>
  </li>
  <li>
    <p>ê·¸ë˜ë„ ê¼­ ìŠ¤ë ˆë“œ ëª¨ë“œê°€ í•„ìš”í•˜ë‹¤ë©´ ìµœì†Œí•œ ë‹¤ìŒì„ ì¶”ê°€í•´ì•¼ í•œë‹¤.</p>

    <ul>
      <li>
        <p>ìŠ¤ë ˆë“œ ëª¨ë“œì—ì„  <code class="language-plaintext highlighter-rouge">os.chdir</code> ê¸ˆì§€(ê°ì‚¬ í›…ì—ì„œ <code class="language-plaintext highlighter-rouge">event == "os.chdir"</code> í˜¹ì€ <code class="language-plaintext highlighter-rouge">os.chdir</code>ë¥¼ ë˜í•‘í•´ì„œ ë§‰ê¸°).</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">exec</code>ì˜ <code class="language-plaintext highlighter-rouge">globals</code>ë¥¼ ìƒˆ dictë¡œ ì£¼ê³ , ë¶€ëª¨ ì „ì—­ ì°¸ì¡°ë¥¼ ì „ë‹¬í•˜ì§€ ì•Šê¸°.</p>
      </li>
      <li>
        <p>ë¯¼ê° ë¹ŒíŠ¸ì¸/ëª¨ë“ˆ ì ‘ê·¼ì„ ìµœì†Œí™”(ì˜ˆ: <code class="language-plaintext highlighter-rouge">__import__</code>, <code class="language-plaintext highlighter-rouge">inspect</code> ë“±). ì´ê±´ ê¸°ëŠ¥ ì œí•œê³¼ ì¶©ëŒí•˜ë‹ˆ ì‹ ì¤‘í•´ì•¼ í•œë‹¤.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>ê²°ë¡ ì ìœ¼ë¡œ â€œLLMì´ ì•…ì˜ì ì´ì§€ ì•Šë‹¤â€ ê°€ì • í•˜ë”ë¼ë„, ìŠ¤ë ˆë“œë§Œìœ¼ë¡œëŠ” ì‹¤ìˆ˜ë¡œ ë¶€ëª¨ ìƒíƒœë¥¼ ë§ì¹  ìˆ˜ ìˆë‹¤. ê·¸ë˜ì„œ ë‚˜ëŠ” ê³„ì† â€œspawn í”„ë¡œì„¸ìŠ¤â€ ê¶Œì¥.</p>
  </li>
</ul>

<ol>
  <li>ë³‘ë ¬ ì‹¤í–‰(ë™ì‹œì— ì—¬ëŸ¬ ê°œ ëŒë¦¬ê¸°)ì„ ì›í•˜ë©´</li>
</ol>

<ul>
  <li>
    <p>ì§€ê¸ˆ êµ¬ì¡° ê·¸ëŒ€ë¡œ <code class="language-plaintext highlighter-rouge">run_user_code_mp_async</code>ë¥¼ ì—¬ëŸ¬ ë²ˆ awaití•˜ë©´ ëœë‹¤. ë‚´ë¶€ì—ì„œ í”„ë¡œì„¸ìŠ¤ë¥¼ ë§¤ë²ˆ ë„ìš°ë‹ˆ ì™„ì „ ë¶„ë¦¬ëœë‹¤.</p>
  </li>
  <li>
    <p>ëŒ€ëŸ‰ ë³‘ë ¬ ì‹œì—” ì„¸ë§ˆí¬ì–´ë¡œ ë™ì‹œ ì‹¤í–‰ ìˆ˜ë¥¼ ì œí•œí•˜ê±°ë‚˜, í”„ë¡œì„¸ìŠ¤ í’€(ì˜ˆ: <code class="language-plaintext highlighter-rouge">concurrent.futures.ProcessPoolExecutor</code>)ë¡œ ë°”ê¾¸ë©´ ë¦¬ì†ŒìŠ¤ íš¨ìœ¨ì´ ì¢‹ì•„ì§„ë‹¤. ì¸í„°í˜ì´ìŠ¤ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€í•œ ì±„ ë‚´ë¶€ ì‹¤í–‰ìë§Œ í’€ë¡œ êµì²´í•˜ë©´ ëœë‹¤.</p>
  </li>
</ul>

<p>ì •ë¦¬</p>

<ul>
  <li>
    <p>â€œë©€í‹°ìŠ¤ë ˆë”©ì„ ìœ ì € ì½”ë“œê°€ ìì‹ í”„ë¡œì„¸ìŠ¤ ì•ˆì—ì„œ ì“°ëŠ” ê²ƒâ€ì€ OK. ê°ì‚¬ í›…ì€ ëª¨ë“  ìŠ¤ë ˆë“œì— ì ìš©ëœë‹¤.</p>
  </li>
  <li>
    <p>â€œìƒŒë“œë°•ìŠ¤ ìì²´ë¥¼ ìŠ¤ë ˆë“œë¡œ êµ¬í˜„â€ì€ ë©”ëª¨ë¦¬Â·ìƒíƒœ ê²©ë¦¬ê°€ ì—†ì–´ ìœ„í—˜í•˜ë‹¤. CWD/ENVê°€ ì „ì—­ì´ë¼ ë¶€ëª¨ì— ì˜í–¥ë„ ì¤„ ìˆ˜ ìˆë‹¤. ê·¸ë˜ì„œ ì§€ê¸ˆì²˜ëŸ¼ spawn ë©€í‹°í”„ë¡œì„¸ìŠ¤ ìœ ì§€ê°€ ì •ë‹µì´ë‹¤.</p>
  </li>
  <li>
    <p>ë³‘ë ¬ì„±ì€ í”„ë¡œì„¸ìŠ¤ ë‹¨ìœ„ë¡œ ê°€ì ¸ê°€ê³ , í•„ìš”í•˜ë©´ ë¦¬ì†ŒìŠ¤ í•œë„ì™€ í’€ë§ìœ¼ë¡œ íŠœë‹í•˜ì.</p>
  </li>
</ul>

<p>ì›í•˜ë©´ ìŠ¤ë ˆë“œ ëª¨ë“œì˜ ìµœì†Œ ìƒ˜í”Œë„ ë¶™ì—¬ ì¤„ ìˆ˜ ìˆëŠ”ë°, ìœ„ ì´ìœ ë¡œ ì‹¤ì „ íˆ¬ì…ì€ ì¶”ì²œí•˜ì§€ ì•ŠëŠ”ë‹¤.</p>

<p class="chat--user">

ì˜¤ì¼€ì´ í”„ë¡œì„¸ìŠ¤ í•œ ë²ˆì´ ì•„ë‹ˆë¼ ê¸°ì–µì´ ìœ ì§€ë˜ëŠ” ì»¤ë„ì€ ì–´ë–»ê²Œ ë§Œë“¤ìˆ˜ìˆì„ê¹Œ

</p>

<p>ì¢‹ì•„. â€œê¸°ì–µì´ ìœ ì§€ë˜ëŠ” ì»¤ë„â€ì„ ë©€í‹°í”„ë¡œì„¸ìŠ¤ë¡œ ë§Œë“¤ì—ˆë‹¤. í•œ ë²ˆ ë„ì›Œë‘ë©´ ê°™ì€ í”„ë¡œì„¸ìŠ¤ ì•ˆì˜ ì „ì—­ dictë¥¼ ì¬ì‚¬ìš©í•´ì„œ ìƒíƒœê°€ ì´ì–´ì§€ê³ , ë¹„ë™ê¸°(await) ì¸í„°í˜ì´ìŠ¤ë¡œ ì½”ë“œ ì¡°ê°ì„ ê³„ì† ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤. íŒŒì¼Â·ì„œë¸Œí”„ë¡œì„¸ìŠ¤(ì„ íƒì ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬)ëŠ” ê°ì‚¬ í›…(sys.addaudithook)ìœ¼ë¡œ ê°€ë³ê²Œ ìƒŒë“œë°•ìŠ¤í•œë‹¤. ì½ê¸°/ì“°ê¸° í—ˆìš© ê²½ë¡œ, ì‹œì‘ CWD, í™˜ê²½ ì •ë¦¬ ì—¬ë¶€ë„ ëŸ°íƒ€ì„ì— ë°”ê¿€ ìˆ˜ ìˆë‹¤.</p>

<p>ì•„ë˜ íŒŒì¼ í•˜ë‚˜ë¡œ ëë‚œë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># persistent_kernel_async.py
# Python 3.8+ / ì™¸ë¶€ ì˜ì¡´ì„± ì—†ìŒ
</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">multiprocessing</span> <span class="k">as</span> <span class="n">mp</span>
<span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">traceback</span><span class="p">,</span> <span class="n">contextlib</span><span class="p">,</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>

<span class="c1"># ---------------- ë‚´ë¶€: ê°ì‚¬ í›…(íŒŒì¼/ì„œë¸Œí”„ë¡œì„¸ìŠ¤/ë„¤íŠ¸ì›Œí¬ ì œì–´) ----------------
</span><span class="k">def</span> <span class="nf">_install_guard</span><span class="p">(</span><span class="n">read_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                   <span class="n">write_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                   <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                   <span class="n">block_subprocess</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                   <span class="n">block_network</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">rp</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">read_paths</span> <span class="ow">or</span> <span class="p">[])]</span>
    <span class="n">wp</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">write_paths</span> <span class="ow">or</span> <span class="p">[])]</span>

    <span class="k">def</span> <span class="nf">_real</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">roots</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">roots</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="nf">_real</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="n">r</span> <span class="ow">or</span> <span class="n">path</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_audit</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="c1"># íŒŒì¼ ì—´ê¸°(open / os.open)
</span>        <span class="k">if</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">os.open</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">write</span> <span class="o">=</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="ow">in</span> <span class="n">mode</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">))</span> <span class="ow">or</span> \
                    <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">O_WRONLY</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_RDWR</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_CREAT</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_TRUNC</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_APPEND</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">write</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">wp</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> path=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s"> mode=</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s"> flags=</span><span class="si">{</span><span class="n">flags</span><span class="si">}</span><span class="s"> reason=write-outside-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="nf">if </span><span class="p">(</span><span class="ow">not</span> <span class="n">write</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">allow_read_anywhere</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">rp</span> <span class="o">+</span> <span class="n">wp</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> path=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s"> reason=read-not-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># íŒŒì¼ ì¡°ì‘(ê²½ë¡œ ì²« ì¸ì; rename/replaceëŠ” src,dst ë‘˜ ë‹¤ í™•ì¸)
</span>        <span class="k">elif</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">os.rename</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.replace</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nf">_under_any</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">wp</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">wp</span><span class="p">)):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> src=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">src</span><span class="p">)</span><span class="si">}</span><span class="s"> dst=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span><span class="si">}</span><span class="s"> reason=op-outside-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">os.remove</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.unlink</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.mkdir</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.makedirs</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.rmdir</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.chmod</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">wp</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> path=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s"> reason=op-outside-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># ì„œë¸Œí”„ë¡œì„¸ìŠ¤/ì‹œìŠ¤í…œ í˜¸ì¶œ
</span>        <span class="k">elif</span> <span class="n">block_subprocess</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">subprocess.</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">event</span> <span class="o">==</span> <span class="sh">"</span><span class="s">os.system</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="sh">"</span><span class="s">&lt;unknown&gt;</span><span class="sh">"</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> cmd=</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s"> reason=subprocess-disabled</span><span class="sh">"</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># ë„¤íŠ¸ì›Œí¬ ì°¨ë‹¨(ì˜µì…˜)
</span>        <span class="k">elif</span> <span class="n">block_network</span> <span class="ow">and</span> <span class="n">event</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">socket.</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> reason=network-disabled</span><span class="sh">"</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">sys</span><span class="p">.</span><span class="nf">addaudithook</span><span class="p">(</span><span class="n">_audit</span><span class="p">)</span>

<span class="c1"># ---------------- ë‚´ë¶€: ìì‹ í”„ë¡œì„¸ìŠ¤ ì»¤ë„ ----------------
</span><span class="k">def</span> <span class="nf">_kernel_proc</span><span class="p">(</span><span class="n">req_q</span><span class="p">:</span> <span class="n">mp</span><span class="p">.</span><span class="n">Queue</span><span class="p">,</span> <span class="n">resp_q</span><span class="p">:</span> <span class="n">mp</span><span class="p">.</span><span class="n">Queue</span><span class="p">,</span>
                 <span class="n">init_cfg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="c1"># ìƒíƒœ
</span>    <span class="n">read_paths</span> <span class="o">=</span> <span class="n">init_cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">read_paths</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">write_paths</span> <span class="o">=</span> <span class="n">init_cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">write_paths</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">allow_read_anywhere</span> <span class="o">=</span> <span class="n">init_cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">allow_read_anywhere</span><span class="sh">"</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">block_subprocess</span> <span class="o">=</span> <span class="n">init_cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">block_subprocess</span><span class="sh">"</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">block_network</span> <span class="o">=</span> <span class="n">init_cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">block_network</span><span class="sh">"</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">sanitize_env</span> <span class="o">=</span> <span class="n">init_cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">sanitize_env</span><span class="sh">"</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">allowed_env_keys</span> <span class="o">=</span> <span class="n">init_cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">allowed_env_keys</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[</span><span class="sh">"</span><span class="s">PATH</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">PYTHONPATH</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">HOME</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">TMPDIR</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">cwd</span> <span class="o">=</span> <span class="n">init_cfg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># CWD/ENV ì„¤ì •
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cwd</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">cwd</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sanitize_env</span><span class="p">:</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">allowed_env_keys</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nf">list</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">:</span>
                    <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># ì´ˆê¸°í™” ì˜¤ë¥˜ë„ ì‘ë‹µ
</span>        <span class="n">resp_q</span><span class="p">.</span><span class="nf">put</span><span class="p">({</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">init failed: </span><span class="si">{</span><span class="nf">type</span><span class="p">(</span><span class="n">e</span><span class="p">).</span><span class="n">__name__</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">})</span>
        <span class="k">return</span>

    <span class="c1"># ë¦¬ì†ŒìŠ¤ í•œë„(ì›í•˜ë©´ ì¡°ì •)
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="n">resource</span>
        <span class="n">resource</span><span class="p">.</span><span class="nf">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">RLIMIT_CPU</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="n">resource</span><span class="p">.</span><span class="nf">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">RLIMIT_FSIZE</span><span class="p">,</span> <span class="p">(</span><span class="mi">200</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,)</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># ë©”ëª¨ë¦¬ëŠ” OS/glibc ë™ì‘ì— ë”°ë¼ ì˜í–¥ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë‹ˆ í•„ìš”í•  ë•Œë§Œ ì¼œê¸°
</span>        <span class="c1"># resource.setrlimit(resource.RLIMIT_AS, (1024*1024*1024,)*2)
</span>    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># ê°ì‚¬ í›… ì„¤ì¹˜(í”„ë¡œì„¸ìŠ¤ ì „ì²´ ìŠ¤ë ˆë“œì— ì ìš©)
</span>    <span class="nf">_install_guard</span><span class="p">(</span><span class="n">read_paths</span><span class="p">,</span> <span class="n">write_paths</span><span class="p">,</span> <span class="n">allow_read_anywhere</span><span class="p">,</span>
                   <span class="n">block_subprocess</span><span class="o">=</span><span class="n">block_subprocess</span><span class="p">,</span> <span class="n">block_network</span><span class="o">=</span><span class="n">block_network</span><span class="p">)</span>

    <span class="c1"># ì „ì—­ dict: ì´ê²Œ â€œê¸°ì–µâ€ì´ë‹¤.
</span>    <span class="n">g</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">__name__</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">}</span>

    <span class="c1"># ì´ë²¤íŠ¸ ë£¨í”„
</span>    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">req_q</span><span class="p">.</span><span class="nf">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">req</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">rid</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">op</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="sh">"</span><span class="s">exec</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">code</span> <span class="o">=</span> <span class="n">req</span><span class="p">[</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">]</span>
                <span class="n">stdout_buf</span><span class="p">,</span> <span class="n">stderr_buf</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="nc">StringIO</span><span class="p">(),</span> <span class="n">io</span><span class="p">.</span><span class="nc">StringIO</span><span class="p">()</span>
                <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">redirect_stdout</span><span class="p">(</span><span class="n">stdout_buf</span><span class="p">),</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">redirect_stderr</span><span class="p">(</span><span class="n">stderr_buf</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="nf">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
                    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                        <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[ERROR] exception while executing user code:</span><span class="sh">"</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">)</span>
                        <span class="n">traceback</span><span class="p">.</span><span class="nf">print_exc</span><span class="p">()</span>
                <span class="n">resp_q</span><span class="p">.</span><span class="nf">put</span><span class="p">({</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="n">rid</span><span class="p">,</span> <span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span>
                            <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">stdout_buf</span><span class="p">.</span><span class="nf">getvalue</span><span class="p">(),</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">stderr_buf</span><span class="p">.</span><span class="nf">getvalue</span><span class="p">()})</span>

            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="sh">"</span><span class="s">reset</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">g</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">__name__</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">}</span>
                <span class="n">resp_q</span><span class="p">.</span><span class="nf">put</span><span class="p">({</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="n">rid</span><span class="p">,</span> <span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">msg</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">reset-done</span><span class="sh">"</span><span class="p">})</span>

            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="sh">"</span><span class="s">set_paths</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">read_paths</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">read_paths</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                <span class="n">write_paths</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">write_paths</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
                <span class="n">allow_read_anywhere</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">allow_read_anywhere</span><span class="sh">"</span><span class="p">,</span> <span class="n">allow_read_anywhere</span><span class="p">)</span>
                <span class="c1"># í›…ì€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆì§€ë§Œ, í´ë¡œì € ê°’ì´ ì•„ë‹ˆë¼ í•¨ìˆ˜ ë‚´ì—ì„œ ìµœì‹  ë¦¬ìŠ¤íŠ¸ë¥¼ ìº¡ì³í•˜ë„ë¡ ì¬ì„¤ì¹˜
</span>                <span class="nf">_install_guard</span><span class="p">(</span><span class="n">read_paths</span><span class="p">,</span> <span class="n">write_paths</span><span class="p">,</span> <span class="n">allow_read_anywhere</span><span class="p">,</span>
                               <span class="n">block_subprocess</span><span class="o">=</span><span class="n">block_subprocess</span><span class="p">,</span> <span class="n">block_network</span><span class="o">=</span><span class="n">block_network</span><span class="p">)</span>
                <span class="n">resp_q</span><span class="p">.</span><span class="nf">put</span><span class="p">({</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="n">rid</span><span class="p">,</span> <span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">msg</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">paths-updated</span><span class="sh">"</span><span class="p">})</span>

            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="sh">"</span><span class="s">set_cwd</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">new_cwd</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_cwd</span><span class="p">:</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">new_cwd</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">os</span><span class="p">.</span><span class="nf">chdir</span><span class="p">(</span><span class="n">new_cwd</span><span class="p">)</span>
                <span class="n">resp_q</span><span class="p">.</span><span class="nf">put</span><span class="p">({</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="n">rid</span><span class="p">,</span> <span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">()})</span>

            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">resp_q</span><span class="p">.</span><span class="nf">put</span><span class="p">({</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="n">rid</span><span class="p">,</span> <span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">:</span> <span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">(),</span>
                            <span class="sh">"</span><span class="s">read_paths</span><span class="sh">"</span><span class="p">:</span> <span class="n">read_paths</span><span class="p">,</span> <span class="sh">"</span><span class="s">write_paths</span><span class="sh">"</span><span class="p">:</span> <span class="n">write_paths</span><span class="p">,</span>
                            <span class="sh">"</span><span class="s">allow_read_anywhere</span><span class="sh">"</span><span class="p">:</span> <span class="n">allow_read_anywhere</span><span class="p">})</span>

            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="sh">"</span><span class="s">shutdown</span><span class="sh">"</span><span class="p">:</span>
                <span class="n">resp_q</span><span class="p">.</span><span class="nf">put</span><span class="p">({</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="n">rid</span><span class="p">,</span> <span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">msg</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">bye</span><span class="sh">"</span><span class="p">})</span>
                <span class="k">break</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">resp_q</span><span class="p">.</span><span class="nf">put</span><span class="p">({</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="n">rid</span><span class="p">,</span> <span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown op: </span><span class="si">{</span><span class="n">op</span><span class="si">}</span><span class="sh">"</span><span class="p">})</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">resp_q</span><span class="p">.</span><span class="nf">put</span><span class="p">({</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">:</span> <span class="n">rid</span><span class="p">,</span> <span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="nf">type</span><span class="p">(</span><span class="n">e</span><span class="p">).</span><span class="n">__name__</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">})</span>

<span class="c1"># ---------------- ë¶€ëª¨ ì¸¡: ì„¸ì…˜ í•¸ë“¤(ë¹„ë™ê¸° API) ----------------
</span><span class="k">class</span> <span class="nc">PersistentKernel</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ctx</span> <span class="o">=</span> <span class="n">mp</span><span class="p">.</span><span class="nf">get_context</span><span class="p">(</span><span class="sh">"</span><span class="s">spawn</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_req_q</span><span class="p">:</span> <span class="n">mp</span><span class="p">.</span><span class="n">Queue</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ctx</span><span class="p">.</span><span class="nc">Queue</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_resp_q</span><span class="p">:</span> <span class="n">mp</span><span class="p">.</span><span class="n">Queue</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ctx</span><span class="p">.</span><span class="nc">Queue</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_p</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">mp</span><span class="p">.</span><span class="n">Process</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_next_id</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                    <span class="o">*</span><span class="p">,</span>
                    <span class="n">read_paths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                    <span class="n">write_paths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                    <span class="n">cwd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                    <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                    <span class="n">block_subprocess</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="n">block_network</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                    <span class="n">sanitize_env</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                    <span class="n">allowed_env_keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                    <span class="n">startup_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">init_cfg</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">read_paths</span><span class="sh">"</span><span class="p">:</span> <span class="n">read_paths</span> <span class="ow">or</span> <span class="p">[],</span>
            <span class="sh">"</span><span class="s">write_paths</span><span class="sh">"</span><span class="p">:</span> <span class="n">write_paths</span> <span class="ow">or</span> <span class="p">[],</span>
            <span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">:</span> <span class="n">cwd</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">allow_read_anywhere</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">allow_read_anywhere</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">allow_read_anywhere</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">block_subprocess</span><span class="sh">"</span><span class="p">:</span> <span class="n">block_subprocess</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">block_network</span><span class="sh">"</span><span class="p">:</span> <span class="n">block_network</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">sanitize_env</span><span class="sh">"</span><span class="p">:</span> <span class="n">sanitize_env</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">allowed_env_keys</span><span class="sh">"</span><span class="p">:</span> <span class="n">allowed_env_keys</span> <span class="ow">or</span> <span class="p">[</span><span class="sh">"</span><span class="s">PATH</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">PYTHONPATH</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">HOME</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">TMPDIR</span><span class="sh">"</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_p</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ctx</span><span class="p">.</span><span class="nc">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_kernel_proc</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_req_q</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_resp_q</span><span class="p">,</span> <span class="n">init_cfg</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_p</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="c1"># ê°„ë‹¨ í—¬ìŠ¤ì²´í¬: ìƒíƒœ ìš”ì²­
</span>        <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">startup_timeout</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">aexec</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_rpc</span><span class="p">({</span><span class="sh">"</span><span class="s">op</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">exec</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:</span> <span class="n">code</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_rpc</span><span class="p">({</span><span class="sh">"</span><span class="s">op</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">reset</span><span class="sh">"</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">set_paths</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                        <span class="n">read_paths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                        <span class="n">write_paths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                        <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_rpc</span><span class="p">({</span><span class="sh">"</span><span class="s">op</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">set_paths</span><span class="sh">"</span><span class="p">,</span>
                                <span class="sh">"</span><span class="s">read_paths</span><span class="sh">"</span><span class="p">:</span> <span class="n">read_paths</span> <span class="ow">or</span> <span class="p">[],</span>
                                <span class="sh">"</span><span class="s">write_paths</span><span class="sh">"</span><span class="p">:</span> <span class="n">write_paths</span> <span class="ow">or</span> <span class="p">[],</span>
                                <span class="sh">"</span><span class="s">allow_read_anywhere</span><span class="sh">"</span><span class="p">:</span> <span class="n">allow_read_anywhere</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">set_cwd</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cwd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_rpc</span><span class="p">({</span><span class="sh">"</span><span class="s">op</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">set_cwd</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">cwd</span><span class="sh">"</span><span class="p">:</span> <span class="n">cwd</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_rpc</span><span class="p">({</span><span class="sh">"</span><span class="s">op</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_rpc</span><span class="p">({</span><span class="sh">"</span><span class="s">op</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">shutdown</span><span class="sh">"</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_cleanup</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">_cleanup</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_p</span><span class="p">.</span><span class="nf">is_alive</span><span class="p">():</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_p</span><span class="p">.</span><span class="nf">terminate</span><span class="p">()</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_p</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_rpc</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_p</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">_p</span><span class="p">.</span><span class="nf">is_alive</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">kernel not started</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">rid</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_next_id</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_next_id</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
            <span class="n">payload</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">rid</span>
            <span class="c1"># í put/getì€ ë¸”ë¡œí‚¹ì´ë¯€ë¡œ ìŠ¤ë ˆë“œí’€ë¡œ ë„˜ê¹€
</span>            <span class="k">await</span> <span class="n">loop</span><span class="p">.</span><span class="nf">run_in_executor</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_req_q</span><span class="p">.</span><span class="n">put</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
            <span class="c1"># ì‘ë‹µ ëŒ€ê¸°(íƒ€ì„ì•„ì›ƒ)
</span>            <span class="n">deadline</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timeout</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">remaining</span> <span class="o">=</span> <span class="n">deadline</span> <span class="o">-</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">remaining</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nc">TimeoutError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">kernel request timed out: </span><span class="si">{</span><span class="n">payload</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">op</span><span class="sh">'</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">loop</span><span class="p">.</span><span class="nf">run_in_executor</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_resp_q</span><span class="p">.</span><span class="n">get</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">remaining</span><span class="p">))</span>
                <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                    <span class="c1"># ê³„ì† í´ë§
</span>                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">resp</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="n">rid</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">resp</span>
                <span class="c1"># í˜¹ì‹œ ë‹¤ë¥¸ ì‘ë‹µì´ë©´ ë²„í¼ë§í•˜ì§€ ì•Šê³  ë¬´ì‹œ(ì§ë ¬ í˜¸ì¶œ ì „ì œ)
</span>                <span class="c1"># ë³‘ë ¬ í˜¸ì¶œì„ ì›í•˜ë©´ here: per-request map/fan-in ìŠ¤ë ˆë“œ ì¶”ê°€ í•„ìš”
</span>
<span class="c1"># ---------------- ì‚¬ìš© ì˜ˆ(ë°ëª¨) ----------------
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">demo</span><span class="p">():</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nc">PersistentKernel</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span>
            <span class="n">read_paths</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>                 <span class="c1"># None â†’ ì–´ë””ë“  ì½ê¸° í—ˆìš©
</span>            <span class="n">write_paths</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./work/out</span><span class="sh">"</span><span class="p">],</span>      <span class="c1"># ì—¬ê¸°ë§Œ ì“°ê¸° í—ˆìš©
</span>            <span class="n">cwd</span><span class="o">=</span><span class="sh">"</span><span class="s">./work</span><span class="sh">"</span><span class="p">,</span>                    <span class="c1"># ì»¤ë„ì˜ ì‹œì‘ CWD (ë¶€ëª¨ì—” ì˜í–¥ ì—†ìŒ)
</span>            <span class="n">block_subprocess</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">block_network</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">sanitize_env</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># 1) ìƒíƒœ í™•ì¸
</span>        <span class="nf">print</span><span class="p">(</span><span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">status</span><span class="p">())</span>

        <span class="c1"># 2) ì‹¤í–‰ 1: íŒŒì¼ ì“°ê¸°(í—ˆìš©) + ê¸ˆì§€ ì‹œë„(ê±°ë¶€)
</span>        <span class="n">code1</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os, sys, subprocess
print(</span><span class="sh">"</span><span class="s">CWD:</span><span class="sh">"</span><span class="s">, os.getcwd())
open(</span><span class="sh">"</span><span class="s">out/ok.txt</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">).write(</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="s">)
try:
    open(</span><span class="sh">"</span><span class="s">/etc/blocked.txt</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">).write(</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="s">)
except Exception as e:
    print(</span><span class="sh">"</span><span class="s">blocked write:</span><span class="sh">"</span><span class="s">, type(e).__name__)
print(</span><span class="sh">"</span><span class="s">done-1</span><span class="sh">"</span><span class="s">)
</span><span class="sh">"""</span>
        <span class="n">res1</span> <span class="o">=</span> <span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">aexec</span><span class="p">(</span><span class="n">code1</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">RC1:</span><span class="sh">"</span><span class="p">,</span> <span class="n">res1</span><span class="p">[</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">])</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDOUT1:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">res1</span><span class="p">[</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">])</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDERR1:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">res1</span><span class="p">[</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">])</span>

        <span class="c1"># 3) ì‹¤í–‰ 2: ìƒíƒœ ìœ ì§€ í™•ì¸(ì•ì—ì„œ ë§Œë“  ë³€ìˆ˜ ì¬ì‚¬ìš©)
</span>        <span class="n">code2</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
if </span><span class="sh">'</span><span class="s">counter</span><span class="sh">'</span><span class="s"> not in globals():
    counter = 0
counter += 1
print(</span><span class="sh">"</span><span class="s">counter:</span><span class="sh">"</span><span class="s">, counter)
</span><span class="sh">"""</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">res2</span> <span class="o">=</span> <span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">aexec</span><span class="p">(</span><span class="n">code2</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">res2</span><span class="p">[</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">].</span><span class="nf">strip</span><span class="p">())</span>

        <span class="c1"># 4) reset í›„ ë‹¤ì‹œ í™•ì¸
</span>        <span class="nf">print</span><span class="p">(</span><span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">reset</span><span class="p">())</span>
        <span class="n">res3</span> <span class="o">=</span> <span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">aexec</span><span class="p">(</span><span class="sh">"</span><span class="s">print(</span><span class="sh">'</span><span class="s">has counter?</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">counter</span><span class="sh">'</span><span class="s"> in globals())</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">res3</span><span class="p">[</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">].</span><span class="nf">strip</span><span class="p">())</span>

        <span class="c1"># 5) ê²½ë¡œ/ì‘ì—… ë””ë ‰í„°ë¦¬ ë³€ê²½
</span>        <span class="nf">print</span><span class="p">(</span><span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">set_paths</span><span class="p">(</span><span class="n">write_paths</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">./work2/out2</span><span class="sh">"</span><span class="p">],</span> <span class="n">read_paths</span><span class="o">=</span><span class="p">[],</span>
                                <span class="n">allow_read_anywhere</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
        <span class="nf">print</span><span class="p">(</span><span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">set_cwd</span><span class="p">(</span><span class="sh">"</span><span class="s">./work2</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">res4</span> <span class="o">=</span> <span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">aexec</span><span class="p">(</span><span class="sh">"</span><span class="s">open(</span><span class="sh">'</span><span class="s">out2/ok2.txt</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="s">).write(</span><span class="sh">'</span><span class="s">ok2</span><span class="sh">'</span><span class="s">); print(</span><span class="sh">'</span><span class="s">wrote ok2</span><span class="sh">'</span><span class="s">)</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">res4</span><span class="p">[</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">].</span><span class="nf">strip</span><span class="p">())</span>

        <span class="c1"># 6) ì¢…ë£Œ
</span>        <span class="nf">print</span><span class="p">(</span><span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">sys</span><span class="p">.</span><span class="n">platform</span> <span class="o">==</span> <span class="sh">"</span><span class="s">win32</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">mp</span><span class="p">.</span><span class="nf">freeze_support</span><span class="p">()</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">demo</span><span class="p">())</span>
</code></pre></div></div>

<p>í•µì‹¬ ì •ë¦¬</p>

<ol>
  <li>
    <p>ì»¤ë„ì€ ë³„ë„ í”„ë¡œì„¸ìŠ¤ë¡œ í•œ ë²ˆ ë„ìš°ê³  ìœ ì§€í•œë‹¤(spawn). ê°™ì€ ì„¸ì…˜ì—ì„œì˜ execëŠ” ê°™ì€ globals dictë¥¼ ì¬ì‚¬ìš©í•˜ë¯€ë¡œ ìƒíƒœê°€ ì´ì–´ì§„ë‹¤.</p>
  </li>
  <li>
    <p>íŒŒì¼Â·ì¡°ì‘Â·ì„œë¸Œí”„ë¡œì„¸ìŠ¤(ì˜µì…˜ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬) ì‹œë„ëŠ” ê°ì‚¬ í›…ìœ¼ë¡œ ê°ì‹œí•˜ê³ , ê¸ˆì§€ ì‹œë„ëŠ” ì–´ë–¤ ê²½ë¡œ/ì»¤ë§¨ë“œì˜€ëŠ”ì§€ stderrì— [AUDIT]ë¡œ ë‚¨ê¸´ë‹¤.</p>
  </li>
  <li>
    <p>read_paths, write_paths, cwdë¥¼ ì‹œì‘ ì‹œì ì— ì§€ì •í•˜ê³ , ì¤‘ê°„ì— set_paths/set_cwdë¡œ ë³€ê²½ ê°€ëŠ¥í•˜ë‹¤.</p>
  </li>
  <li>
    <p>ë¶€ëª¨ ì „ì—­ì€ spawn ë•ë¶„ì— ê¸°ë³¸ ë…¸ì¶œì´ ì—†ë‹¤. í™˜ê²½ë³€ìˆ˜ëŠ” sanitize_envë¡œ ìµœì†Œí™”í•  ìˆ˜ ìˆë‹¤.</p>
  </li>
  <li>
    <p>ë¹„ë™ê¸° í˜¸ì¶œì€ aexec/reset/status ë“±ìœ¼ë¡œ ì œê³µí•œë‹¤. ë™ì‹œ ë‹¤ë°œ í˜¸ì¶œì€ ë½ìœ¼ë¡œ ì§ë ¬í™”í•´ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬í–ˆë‹¤(ì§„ì§œ ë³‘ë ¬ì„ ì›í•˜ë©´ ì‘ë‹µ ë§¤ì¹­ ë§µê³¼ ì „ìš© ë¦¬ë” ìŠ¤ë ˆë“œë¡œ í™•ì¥).</p>
  </li>
</ol>

<p>ì´ê±¸ ë°”ë¡œ ë„¤ vLLM/Agents SDK íˆ´ë¡œ ê°ì‹¸ë©´ â€œì„¸ì…˜ ìœ ì§€í˜• íŒŒì´ì¬ ì¸í„°í”„ë¦¬í„°â€ë¥¼ ê¹”ë”í•˜ê²Œ ì“¸ ìˆ˜ ìˆë‹¤.</p>

<p class="chat--user">

ì¢€ í—·ê°ˆë ¤ code1ì€ ë‘ ë²ˆì§¸ open ë¶€ë¶„ì—ì„œ ì—ëŸ¬ê°€ ë‚˜ì–ì•„? ê·¼ë° ë°”ë¡œ ì•„ë˜ì˜ Except ì½”ë“œì—ì„œ ê·¸ê±¸ ì¡ì•„ì•¼í•  ê²ƒ ê°™ì€ë° ì´ê±´ returncode 1ì´ ëœ¨ë„¤. ì˜ë„í•œ ë™ì‘ì¸ê°€

</p>

<p>ì˜ë„í•œ ë™ì‘ì€ ì•„ë‹ˆë‹¤. ê·¸ <code class="language-plaintext highlighter-rouge">returncode=1</code>ì€ â€œì¡íˆì§€ ì•Šì€ ì˜ˆì™¸ê°€ ìˆì—ˆìŒâ€ì„ ëœ»í•´. ì§€ê¸ˆ ì¼€ì´ìŠ¤ëŠ” ë‘ ë²ˆì§¸ ê¸ˆì§€ ì“°ê¸°(try/exceptë¡œ ê°ì‹¼ ë¶€ë¶„)ê°€ ì•„ë‹ˆë¼, ê·¸ ìœ„ì˜ ì²« ë²ˆì§¸ í—ˆìš© ì“°ê¸° <code class="language-plaintext highlighter-rouge">open("out/ok.txt","w")</code>ê°€ ê°ì‚¬ í›…ì— ì˜í•´ ë§‰í˜€ì„œ ì˜ˆì™¸ê°€ ë°”ê¹¥ìœ¼ë¡œ íŠ„ ê°€ëŠ¥ì„±ì´ ë†’ë‹¤.</p>

<p>ì™œ ë§‰íˆëƒë©´ ë‚´ê°€ ì¤€ ë°ëª¨ì—ì„œ <code class="language-plaintext highlighter-rouge">cwd="./work"</code>ë¡œ ì»¤ë„ì„ ì‹œì‘í–ˆëŠ”ë° <code class="language-plaintext highlighter-rouge">write_paths=["./work/out"]</code>ë¥¼ ê·¸ëŒ€ë¡œ ë„˜ê²¼ë‹¤. ìì‹ì€ ë¨¼ì € <code class="language-plaintext highlighter-rouge">chdir("./work")</code>ë¥¼ í•˜ê³ , ê·¸ ë‹¤ìŒì— <code class="language-plaintext highlighter-rouge">write_paths</code>ë¥¼ realpathë¡œ ì ˆëŒ€í™”í•œë‹¤. ìƒëŒ€ê²½ë¡œë¥¼ í˜„ì¬ ì‘ì—…ë””ë ‰í„°ë¦¬ì— ë¶™ì´ë‹ˆ <code class="language-plaintext highlighter-rouge">./work/out</code> â†’ <code class="language-plaintext highlighter-rouge">/â€¦/work/work/out</code>ì´ ë˜ì–´ ë²„ë ¤ì„œ, ì‹¤ì œë¡œ ì“°ë ¤ëŠ” <code class="language-plaintext highlighter-rouge">out/ok.txt</code>(<code class="language-plaintext highlighter-rouge">/â€¦/work/out/ok.txt</code>)ì™€ ê²½ë¡œê°€ ë¶ˆì¼ì¹˜í•œë‹¤. ê·¸ë˜ì„œ ì²« ë²ˆì§¸ openì´ PermissionErrorë¡œ ì‹¤íŒ¨í•˜ê³ , ê·¸ê±´ try/exceptë¡œ ê°ì‹¸ì§€ ì•Šì•˜ìœ¼ë‹ˆ rc=1ì´ ëœ ê²ƒ.</p>

<p>í•´ê²°ì€ ë‘˜ ì¤‘ í•˜ë‚˜ë¡œ ê¹”ë”íˆ ëë‚œë‹¤.</p>

<p>ì˜µì…˜ A: í•­ìƒ ì ˆëŒ€ê²½ë¡œë¡œ ë„˜ê¸°ê¸°</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span>
    <span class="n">write_paths</span><span class="o">=</span><span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="sh">"</span><span class="s">./work/out</span><span class="sh">"</span><span class="p">)],</span>  <span class="c1"># ì ˆëŒ€ê²½ë¡œë¡œ ë„˜ê¹€
</span>    <span class="n">cwd</span><span class="o">=</span><span class="sh">"</span><span class="s">./work</span><span class="sh">"</span><span class="p">,</span>
    <span class="c1"># ...
</span><span class="p">)</span>
</code></pre></div></div>

<p>ì˜µì…˜ B: ì»¤ë„ ì•ˆì—ì„œ cwd ê¸°ì¤€ìœ¼ë¡œ ê²½ë¡œë¥¼ ì •ê·œí™”í•˜ë„ë¡ íŒ¨ì¹˜<br />
_kernel_procì—ì„œ chdir í•œ â€œì§í›„â€ì— read/write ê²½ë¡œë¥¼ í˜„ì¬ CWD ê¸°ì¤€ìœ¼ë¡œ ì ˆëŒ€í™”í•˜ë©´ ëœë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># _kernel_proc ë‚´ë¶€, chdir(cwd) í•œ ë‹¤ìŒì— ì¶”ê°€
</span><span class="k">def</span> <span class="nf">_abslist</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">lst</span> <span class="ow">or</span> <span class="p">[]):</span>
        <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isabs</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">(),</span> <span class="n">p</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="n">read_paths</span>  <span class="o">=</span> <span class="nf">_abslist</span><span class="p">(</span><span class="n">read_paths</span><span class="p">)</span>
<span class="n">write_paths</span> <span class="o">=</span> <span class="nf">_abslist</span><span class="p">(</span><span class="n">write_paths</span><span class="p">)</span>
</code></pre></div></div>

<p>ê·¸ë¦¬ê³  ë°ëª¨ í˜¸ì¶œì€ ì´ë ‡ê²Œ ë°”ê¾¸ë©´ í—·ê°ˆë¦¼ì´ ì—†ë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span>
    <span class="n">write_paths</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">out</span><span class="sh">"</span><span class="p">],</span>    <span class="c1"># cwd ê¸°ì¤€ ìƒëŒ€ê²½ë¡œ
</span>    <span class="n">cwd</span><span class="o">=</span><span class="sh">"</span><span class="s">./work</span><span class="sh">"</span><span class="p">,</span>
    <span class="c1"># ...
</span><span class="p">)</span>
</code></pre></div></div>

<p>ì ê²€ íŒ<br />
stderrì— ì²« ë²ˆì§¸ openì— ëŒ€í•œ <code class="language-plaintext highlighter-rouge">[AUDIT] blocked: event=open path=â€¦/work/out/ok.txt â€¦</code>ê°€ ì°í˜€ ìˆìœ¼ë©´ ë‚´ê°€ ì„¤ëª…í•œ ê²½ë¡œ ë¶ˆì¼ì¹˜ê°€ ì›ì¸ì´ë‹¤. ìœ„ íŒ¨ì¹˜(í˜¹ì€ ì ˆëŒ€ê²½ë¡œ ì „ë‹¬) ì´í›„ì—ëŠ” ì²« ë²ˆì§¸ ì“°ê¸°ê°€ í†µê³¼í•˜ê³ , ë‘ ë²ˆì§¸ ê¸ˆì§€ ì“°ê¸°ëŠ” try/exceptì— ì¡í˜€ì„œ <code class="language-plaintext highlighter-rouge">returncode</code>ê°€ 0ìœ¼ë¡œ ë‚´ë ¤ê°„ë‹¤.</p>

<p class="chat--user">

ì•„ ì˜¤ì¼€ì´ ì¢€ í—·ê°ˆë¦°

</p>

<p>ê´œì°®ì•„, ê²½ë¡œê°€ ì„ì´ë©´ ëˆ„êµ¬ë‚˜ í—·ê°ˆë ¤. í•µì‹¬ë§Œ ë‹¤ì‹œ ì •ë¦¬í• ê²Œ.</p>

<p>ì •ë¦¬</p>

<ol>
  <li>
    <p>ì»¤ë„ ì‹œì‘ ì‹œ cwdë¥¼ ë°”ê¾¸ë©´, write_paths ê°™ì€ ìƒëŒ€ê²½ë¡œëŠ” ìƒˆ cwd ê¸°ì¤€ìœ¼ë¡œ ì ˆëŒ€í™”í•´ì¤˜ì•¼ í•œë‹¤.</p>
  </li>
  <li>
    <p>ì ˆëŒ€ê²½ë¡œë¡œ ë„˜ê¸°ë©´ ì•ˆì „í•˜ê³ , ìƒëŒ€ê²½ë¡œë¡œ ë„˜ê¸°ê³  ì‹¶ìœ¼ë©´ ì»¤ë„ ì•ˆì—ì„œ chdir ì´í›„ì— ì ˆëŒ€í™”í•˜ë©´ ëœë‹¤.</p>
  </li>
  <li>
    <p>ì²« ë²ˆì§¸ openì´ í—ˆìš© ê²½ë¡œ ë°–ìœ¼ë¡œ ì¸ì‹ë˜ë©´ try/exceptì— ì•ˆ ê±¸ë¦° ì˜ˆì™¸ê°€ ë– ì„œ returncode=1ì´ ëœë‹¤.</p>
  </li>
</ol>

<p>ë¹ ë¥¸ í•´ê²° ë‘ ê°€ì§€<br />
ì˜µì…˜ A: í•­ìƒ ì ˆëŒ€ê²½ë¡œë¡œ ë„˜ê¸°ê¸°</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span>
    <span class="n">cwd</span><span class="o">=</span><span class="sh">"</span><span class="s">./work</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">write_paths</span><span class="o">=</span><span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="sh">"</span><span class="s">./work/out</span><span class="sh">"</span><span class="p">)],</span>
<span class="p">)</span>
</code></pre></div></div>

<p>ì˜µì…˜ B: ì»¤ë„ ë‚´ë¶€ì—ì„œ ì ˆëŒ€í™” íŒ¨ì¹˜(ê¶Œì¥)<br />
_kernel_procì—ì„œ chdir(cwd) ë°”ë¡œ ë’¤ì— ì•„ë˜ ìœ í‹¸ì„ ë„£ì–´ì£¼ë©´, ìƒëŒ€ê²½ë¡œë¥¼ ìƒˆ cwd ê¸°ì¤€ìœ¼ë¡œ ì •ê·œí™”í•´ì¤€ë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_abslist</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">()</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">lst</span> <span class="ow">or</span> <span class="p">[]):</span>
        <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isabs</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">p</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="n">read_paths</span>  <span class="o">=</span> <span class="nf">_abslist</span><span class="p">(</span><span class="n">read_paths</span><span class="p">)</span>
<span class="n">write_paths</span> <span class="o">=</span> <span class="nf">_abslist</span><span class="p">(</span><span class="n">write_paths</span><span class="p">)</span>
</code></pre></div></div>

<p>ê·¸ ë‹¤ìŒ ì‹œì‘í•  ë•ŒëŠ” ì§ê´€ì ìœ¼ë¡œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">cwd</span><span class="o">=</span><span class="sh">"</span><span class="s">./work</span><span class="sh">"</span><span class="p">,</span> <span class="n">write_paths</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">out</span><span class="sh">"</span><span class="p">])</span>
</code></pre></div></div>

<p>ë™ì‘ ì²´í¬</p>

<ol>
  <li>
    <p>ì²« ì‹¤í–‰ì—ì„œ out/ok.txt ì“°ê¸°ê°€ ì„±ê³µí•´ì•¼ í•˜ê³ </p>
  </li>
  <li>
    <p>ê¸ˆì§€ ì“°ê¸° ì‹œë„ëŠ” stderrì— [AUDIT] blockedâ€¦ê°€ ì°íˆë©´ì„œ try/exceptë¡œ ì¡í˜€ì•¼ í•˜ë©°</p>
  </li>
  <li>
    <p>returncodeëŠ” 0ìœ¼ë¡œ ë‚´ë ¤ì™€ì•¼ ì •ìƒ.</p>
  </li>
</ol>

<p>í•„ìš”í•˜ë©´ ìœ„ íŒ¨ì¹˜ ë°˜ì˜í•œ ì „ì²´ íŒŒì¼ë„ ë¬¶ì–´ ì¤„ê²Œ.</p>

<p class="chat--user">

ì¢‹ì•„ ì´ì œ PersistentKernelì„ ì´ìš©í•´ì„œ llm tool callingìš© íˆ´ì„ ë§Œë“¤ì–´ë³´ì. ë‹¨ì¼ ì½”ë“œ ì‹¤í–‰ -&gt; ì¼íšŒìš© íˆ´ ì½œë§ìš© ì„¸ì…˜ ìœ ì§€ ì„¸ì…˜ ì½”ë“œ ì‹¤í–‰ -&gt; ì„¸ì…˜ ìœ ì§€ìš© ì½”ë“œ ì‹¤í–‰

</p>

<p>ì¢‹ì•„. PersistentKernelì„ ê·¸ëŒ€ë¡œ í™œìš©í•´ì„œ â€œì¼íšŒì„± ì‹¤í–‰â€ê³¼ â€œì„¸ì…˜ ìœ ì§€ ì‹¤í–‰â€ ë‘ ê°€ì§€ íˆ´ì„ ë°”ë¡œ ì“¸ ìˆ˜ ìˆê²Œ ë¬¶ì–´ì¤€ë‹¤. ì„¤ì •(Config)ì€ ì„œë²„ ì½”ë“œì—ì„œë§Œ í•˜ê³ , LLMì—ëŠ” ì ˆëŒ€ ë…¸ì¶œí•˜ì§€ ì•ŠëŠ”ë‹¤. LLMì´ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ” ê±´ ë‹¤ìŒ ë‹¤ì„¯ ê°œë¿ì´ë‹¤.</p>

<ol>
  <li>
    <p>python_execute_once(code, timeout_sec?, cwd_rel?)</p>
  </li>
  <li>
    <p>python_session_start(session_id, timeout_sec?, cwd_rel?)</p>
  </li>
  <li>
    <p>python_session_execute(session_id, code, timeout_sec?)</p>
  </li>
  <li>
    <p>python_session_reset(session_id)</p>
  </li>
  <li>
    <p>python_session_shutdown(session_id)</p>
  </li>
</ol>

<p>ì•„ë˜ í•œ íŒŒì¼ë¡œ ë¶™ì—¬ ë„£ìœ¼ë©´ ëœë‹¤. ì´ì „ì— ë§Œë“  persistent_kernel_async.pyê°€ ê°™ì€ ë””ë ‰í„°ë¦¬ì— ìˆë‹¤ê³  ê°€ì •í•œë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># persistent_kernel_tools.py
# ìš”êµ¬: Python 3.8+, ê°™ì€ í´ë”ì— persistent_kernel_async.py ì¡´ì¬
</span><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span> <span class="n">persistent_kernel_async</span> <span class="kn">import</span> <span class="n">PersistentKernel</span><span class="p">,</span> <span class="n">run_user_code_mp_async</span>

<span class="c1"># ===================== ì„œë²„ ì „ìš© ì •ì±…(LLM ë¹„ë…¸ì¶œ) =====================
# ìš´ì˜ìê°€ ì§ì ‘ ì±„ì›€. LLMì— ë…¸ì¶œ ê¸ˆì§€.
</span><span class="n">READ_PATHS_DEFAULT</span>  <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="sh">"</span><span class="s">./data_ro</span><span class="sh">"</span><span class="p">)]</span>   <span class="c1"># ì½ê¸° í—ˆìš© ë£¨íŠ¸(í•˜ìœ„ í¬í•¨)
</span><span class="n">WRITE_PATHS_DEFAULT</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="sh">"</span><span class="s">./sandbox</span><span class="sh">"</span><span class="p">)]</span>   <span class="c1"># ì“°ê¸° í—ˆìš© ë£¨íŠ¸(í•˜ìœ„ í¬í•¨)
</span><span class="n">DEFAULT_CWD</span>         <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="sh">"</span><span class="s">./work</span><span class="sh">"</span><span class="p">)</span>        <span class="c1"># ì»¤ë„ì˜ ì‹œì‘ CWD
</span><span class="n">BLOCK_SUBPROC</span>       <span class="o">=</span> <span class="bp">True</span>
<span class="n">BLOCK_NET</span>           <span class="o">=</span> <span class="bp">False</span>
<span class="n">SANITIZE_ENV</span>        <span class="o">=</span> <span class="bp">True</span>
<span class="n">ALLOWED_ENV_KEYS</span>    <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">PATH</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">PYTHONPATH</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">HOME</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">TMPDIR</span><span class="sh">"</span><span class="p">]</span>

<span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">WRITE_PATHS_DEFAULT</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">DEFAULT_CWD</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># ===================== ìœ í‹¸ =====================
</span><span class="k">def</span> <span class="nf">_abslist</span><span class="p">(</span><span class="n">paths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">()</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">paths</span> <span class="ow">or</span> <span class="p">[]):</span>
        <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isabs</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">p</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">_resolve_cwd_rel</span><span class="p">(</span><span class="n">cwd_rel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cwd_rel</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="c1"># ìƒëŒ€ ê²½ë¡œëŠ” ê¸°ë³¸ CWD ê¸°ì¤€ìœ¼ë¡œ ì ˆëŒ€í™”
</span>    <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">DEFAULT_CWD</span><span class="p">,</span> <span class="n">cwd_rel</span><span class="p">))</span>
    <span class="c1"># ì•ˆì „: ì“°ê¸°/ì½ê¸° í—ˆìš© ë£¨íŠ¸ë“¤ í•˜ìœ„ë¡œë§Œ
</span>    <span class="n">allowed_roots</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="nf">_abslist</span><span class="p">(</span><span class="n">READ_PATHS_DEFAULT</span><span class="p">)</span> <span class="o">+</span> <span class="nf">_abslist</span><span class="p">(</span><span class="n">WRITE_PATHS_DEFAULT</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">DEFAULT_CWD</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">any</span><span class="p">(</span><span class="n">target</span> <span class="o">==</span> <span class="n">r</span> <span class="ow">or</span> <span class="n">target</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">allowed_roots</span><span class="p">):</span>
        <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">cwd_rel outside allowed roots: </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">target</span>

<span class="c1"># ===================== ì„¸ì…˜ ë ˆì§€ìŠ¤íŠ¸ë¦¬ =====================
</span><span class="k">class</span> <span class="nc">KernelRegistry</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_kernels</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">PersistentKernel</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_locks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">threading</span><span class="p">.</span><span class="n">Lock</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_global_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_or_start</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">cwd_rel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PersistentKernel</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_global_lock</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_kernels</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_locks</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_locks</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">_locks</span><span class="p">[</span><span class="n">sid</span><span class="p">]:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_kernels</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="nc">PersistentKernel</span><span class="p">()</span>
                    <span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span>
                        <span class="n">read_paths</span><span class="o">=</span><span class="n">READ_PATHS_DEFAULT</span><span class="p">,</span>
                        <span class="n">write_paths</span><span class="o">=</span><span class="n">WRITE_PATHS_DEFAULT</span><span class="p">,</span>
                        <span class="n">cwd</span><span class="o">=</span><span class="nf">_resolve_cwd_rel</span><span class="p">(</span><span class="n">cwd_rel</span><span class="p">)</span> <span class="ow">or</span> <span class="n">DEFAULT_CWD</span><span class="p">,</span>
                        <span class="n">block_subprocess</span><span class="o">=</span><span class="n">BLOCK_SUBPROC</span><span class="p">,</span>
                        <span class="n">block_network</span><span class="o">=</span><span class="n">BLOCK_NET</span><span class="p">,</span>
                        <span class="n">sanitize_env</span><span class="o">=</span><span class="n">SANITIZE_ENV</span><span class="p">,</span>
                        <span class="n">allowed_env_keys</span><span class="o">=</span><span class="n">ALLOWED_ENV_KEYS</span><span class="p">,</span>
                        <span class="n">startup_timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_kernels</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
        <span class="k">return</span> <span class="n">k</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_kernels</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">session not found</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">reset</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_kernels</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">session not found</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">()</span>

<span class="n">REGISTRY</span> <span class="o">=</span> <span class="nc">KernelRegistry</span><span class="p">()</span>

<span class="c1"># ===================== LLM íˆ´ êµ¬í˜„(í•¸ë“¤ëŸ¬) =====================
# 1) ë‹¨ì¼ ì½”ë“œ ì‹¤í–‰(ì„¸ì…˜ ì—†ìŒ, ì¦‰ì‹œ í”„ë¡œì„¸ìŠ¤ ìƒì„±â†’ì‹¤í–‰â†’ì¢…ë£Œ)
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">tool_python_execute_once</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">timeout</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">cwd_rel</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cwd_rel</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># ì„ íƒ
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">run_user_code_mp_async</span><span class="p">(</span>
            <span class="n">code</span><span class="p">,</span>
            <span class="n">read_paths</span><span class="o">=</span><span class="n">READ_PATHS_DEFAULT</span><span class="p">,</span>
            <span class="n">write_paths</span><span class="o">=</span><span class="n">WRITE_PATHS_DEFAULT</span><span class="p">,</span>
            <span class="n">cwd</span><span class="o">=</span><span class="nf">_resolve_cwd_rel</span><span class="p">(</span><span class="n">cwd_rel</span><span class="p">)</span> <span class="ow">or</span> <span class="n">DEFAULT_CWD</span><span class="p">,</span>
            <span class="n">allow_read_anywhere</span><span class="o">=</span><span class="nf">bool</span><span class="p">(</span><span class="ow">not</span> <span class="n">READ_PATHS_DEFAULT</span><span class="p">),</span>  <span class="c1"># ì½ê¸° ë£¨íŠ¸ ì—†ìœ¼ë©´ ì–´ë””ë“  ì½ê¸° í—ˆìš©
</span>            <span class="n">timeout_sec</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
            <span class="n">block_subprocess</span><span class="o">=</span><span class="n">BLOCK_SUBPROC</span><span class="p">,</span>
            <span class="n">block_network</span><span class="o">=</span><span class="n">BLOCK_NET</span><span class="p">,</span>
            <span class="n">sanitize_env</span><span class="o">=</span><span class="n">SANITIZE_ENV</span><span class="p">,</span>
            <span class="n">allowed_env_keys</span><span class="o">=</span><span class="n">ALLOWED_ENV_KEYS</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[TOOL_ERROR] </span><span class="si">{</span><span class="nf">type</span><span class="p">(</span><span class="n">e</span><span class="p">).</span><span class="n">__name__</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># 2) ì„¸ì…˜ ì‹œì‘
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">tool_python_session_start</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">timeout</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">cwd_rel</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cwd_rel</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">REGISTRY</span><span class="p">.</span><span class="nf">get_or_start</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">cwd_rel</span><span class="o">=</span><span class="n">cwd_rel</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">sid</span><span class="p">}</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="nf">type</span><span class="p">(</span><span class="n">e</span><span class="p">).</span><span class="n">__name__</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># 3) ì„¸ì…˜ ì½”ë“œ ì‹¤í–‰
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">tool_python_session_execute</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">];</span> <span class="n">code</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">];</span> <span class="n">timeout</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">k</span> <span class="o">=</span> <span class="k">await</span> <span class="n">REGISTRY</span><span class="p">.</span><span class="nf">get_or_start</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">aexec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[TOOL_ERROR] </span><span class="si">{</span><span class="nf">type</span><span class="p">(</span><span class="n">e</span><span class="p">).</span><span class="n">__name__</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># 4) ì„¸ì…˜ ë¦¬ì…‹
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">tool_python_session_reset</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">]</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">REGISTRY</span><span class="p">.</span><span class="nf">reset</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>

<span class="c1"># 5) ì„¸ì…˜ ì¢…ë£Œ
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">tool_python_session_shutdown</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">]</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">REGISTRY</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>

<span class="c1"># ===================== íˆ´ ìŠ¤í‚¤ë§ˆ(JSON; LLMì— ë…¸ì¶œ) =====================
</span><span class="n">python_execute_once_tool</span> <span class="o">=</span> <span class="p">{</span>
  <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
  <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">python_execute_once</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ë‹¨ì¼ íŒŒì´ì¬ ì½”ë“œ ì¡°ê°ì„ ìƒŒë“œë°•ìŠ¤ì—ì„œ ì‹¤í–‰í•˜ê³  stdout/stderrë§Œ ë°˜í™˜.</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">60</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">cwd_rel</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì»¤ë„ ì‹œì‘ CWD ê¸°ì¤€ ìƒëŒ€ê²½ë¡œ(í—ˆìš© ë£¨íŠ¸ í•˜ìœ„ë§Œ).</span><span class="sh">"</span><span class="p">}</span>
      <span class="p">},</span>
      <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">],</span>
      <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">python_session_start_tool</span> <span class="o">=</span> <span class="p">{</span>
  <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
  <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">python_session_start</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì„¸ì…˜ ìœ ì§€í˜• ì»¤ë„ì„ ì‹œì‘í•œë‹¤(ì´ë¯¸ ìˆìœ¼ë©´ ì„±ê³µìœ¼ë¡œ ì·¨ê¸‰).</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">60</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">cwd_rel</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì„¸ì…˜ ì‹œì‘ ì‹œ ìƒëŒ€ CWD(ì˜µì…˜).</span><span class="sh">"</span><span class="p">}</span>
      <span class="p">},</span>
      <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">],</span>
      <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">python_session_execute_tool</span> <span class="o">=</span> <span class="p">{</span>
  <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
  <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">python_session_execute</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì„¸ì…˜ ìœ ì§€í˜• ì»¤ë„ì—ì„œ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ê³  stdout/stderrë¥¼ ë°˜í™˜.</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">60</span><span class="p">}</span>
      <span class="p">},</span>
      <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">],</span>
      <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">python_session_reset_tool</span> <span class="o">=</span> <span class="p">{</span>
  <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
  <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">python_session_reset</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì„¸ì…˜ì˜ ì „ì—­ ìƒíƒœë¥¼ ì§€ìš´ë‹¤(globals ì¬ìƒì„±).</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}</span>
      <span class="p">},</span>
      <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">],</span>
      <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">python_session_shutdown_tool</span> <span class="o">=</span> <span class="p">{</span>
  <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
  <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">python_session_shutdown</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì„¸ì…˜ ìœ ì§€í˜• ì»¤ë„ì„ ì¢…ë£Œí•œë‹¤.</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">}</span>
      <span class="p">},</span>
      <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">],</span>
      <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># ===================== ë™ê¸° ì–´ëŒ‘í„°(í”„ë ˆì„ì›Œí¬ì— ë§ê²Œ ì„ íƒì ìœ¼ë¡œ ì‚¬ìš©) =====================
</span><span class="k">def</span> <span class="nf">run_tool_sync</span><span class="p">(</span><span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">í”„ë ˆì„ì›Œí¬ê°€ syncë§Œ ì§€ì›í•˜ë©´ ì‚¬ìš©. ë‚´ë¶€ì—ì„œ ì´ë²¤íŠ¸ ë£¨í”„ë¥¼ ê´€ë¦¬.</span><span class="sh">"""</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_runner</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">python_execute_once</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="nf">tool_python_execute_once</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">python_session_start</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="nf">tool_python_session_start</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">python_session_execute</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="nf">tool_python_session_execute</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">python_session_reset</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="nf">tool_python_session_reset</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">python_session_shutdown</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="nf">tool_python_session_shutdown</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown tool: </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
        <span class="c1"># ì´ë¯¸ ë£¨í”„ê°€ ìˆë‹¤ë©´ ìƒìœ„ì—ì„œ awaití•˜ë„ë¡ ë””ìì¸í•˜ëŠ” ê²ƒì´ ë°”ëŒì§
</span>        <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">run_tool_sync called inside event loop</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">RuntimeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">_runner</span><span class="p">())</span>
</code></pre></div></div>

<p>LLMì—ê²Œ ì•Œë ¤ì¤„ ì‚¬ìš© ê·œì¹™(ê°„ë‹¨)</p>

<ul>
  <li>
    <p>ë‹¨ë°œ ì‘ì—…ì´ë©´ python_execute_onceë¥¼ í˜¸ì¶œí•˜ë¼. ê²°ê³¼ëŠ” returncode/stdout/stderrë§Œ ë³¸ë‹¤.</p>
  </li>
  <li>
    <p>ìƒíƒœë¥¼ ì¨ì•¼ í•˜ë©´ python_session_start â†’ python_session_executeë¥¼ ë°˜ë³µ í˜¸ì¶œí•˜ë¼. í•„ìš”í•˜ë©´ python_session_resetìœ¼ë¡œ ìƒíƒœë¥¼ ì´ˆê¸°í™”í•˜ê³ , ëë‚˜ë©´ python_session_shutdownìœ¼ë¡œ ë‹«ì•„ë¼.</p>
  </li>
  <li>
    <p>íŒŒì¼ì€ ì„œë²„ì—ì„œ í—ˆìš©í•œ í´ë” í•˜ìœ„ì—ì„œë§Œ ì“¸ ìˆ˜ ìˆë‹¤. ê¸ˆì§€ ì‹œë„ëŠ” stderrì— [AUDIT]ë¡œ ì–´ë–¤ ê²½ë¡œ/ì—°ì‚°ì´ ë§‰í˜”ëŠ”ì§€ ê¸°ë¡ëœë‹¤.</p>
  </li>
  <li>
    <p>cwd_relì€ ì„ íƒì´ë©°, ì„¸ì…˜ ì‹œì‘ ì‹œ í•œ ë²ˆë§Œ ì§€ì •í•˜ëŠ” ê±¸ ê¶Œì¥í•œë‹¤.</p>
  </li>
</ul>

<p>í”„ë ˆì„ì›Œí¬ì— ì—°ê²°</p>

<ul>
  <li>
    <p>OpenAI Agents SDKë‚˜ vLLM function-callingì—ëŠ” ìœ„ â€œtool ìŠ¤í‚¤ë§ˆâ€ë“¤(python_execute_once_tool ë“±)ì„ ë“±ë¡í•œë‹¤.</p>
  </li>
  <li>
    <p>íˆ´ ì½œì´ ë“¤ì–´ì˜¤ë©´ nameê³¼ argumentsë¥¼ ë°›ì•„ì„œ run_tool_sync(name, args)ë¡œ ëŒë¦° ê²°ê³¼ë¥¼ ë‹¤ì‹œ LLMì—ê²Œ ì „ë‹¬í•˜ë©´ ëœë‹¤.</p>
  </li>
</ul>

<p>ê²½ë¡œ í˜¼ë™ ë°©ì§€ íŒ</p>

<ul>
  <li>
    <p>ìš´ì˜ìê°€ READ_PATHS_DEFAULT/WRITE_PATHS_DEFAULT/DEFAULT_CWDë¥¼ ì ˆëŒ€ê²½ë¡œë¡œ ì±„ì›Œë‘ë©´ ê°€ì¥ ê¹”ë”í•˜ë‹¤.</p>
  </li>
  <li>
    <p>cwd_relì€ DEFAULT_CWD ê¸°ì¤€ ìƒëŒ€ê²½ë¡œë¡œë§Œ ë°›ê³ , í—ˆìš© ë£¨íŠ¸(READ/WRITE/DEFAULT_CWD) í•˜ìœ„ê°€ ì•„ë‹ˆë©´ ê±°ë¶€í•œë‹¤.</p>
  </li>
</ul>

<p>ì´ë ‡ê²Œ ë¶™ì´ë©´ â€œì¼íšŒì„± ì‹¤í–‰â€ê³¼ â€œê¸°ì–µ ìœ ì§€ ì»¤ë„ ì‹¤í–‰â€ì„ ê°™ì€ ì •ì±… ì•„ë˜ì—ì„œ ê¹”ë”í•˜ê²Œ ì œê³µí•  ìˆ˜ ìˆë‹¤.</p>

<p class="chat--user">

ê·¸ëŸ° ì˜ë¬¸ì€ ì¢€ ìˆì–´. ì„¸ì…˜ì„ ìœ ì§€í•˜ëŠ”ê²Œ í•„ìš”í• ê¹Œ?

</p>

<p>ì¢‹ì€ ì˜ë¬¸ì´ì•¼. â€œì„¸ì…˜ ìœ ì§€í˜• ì»¤ë„(ì§€ì† í”„ë¡œì„¸ìŠ¤)â€ì´ ì •ë§ í•„ìš”í•œê°€ë¥¼ ìš©ë„ë³„ë¡œ ë”± ê°ˆë¼ë³´ì.</p>

<ol>
  <li>ì„¸ì…˜ì´ ì£¼ëŠ” ì´ë“</li>
</ol>

<ul>
  <li>
    <p>ë°˜ë³µ ë¹„ìš© ì ˆê°: í° ë°ì´í„°Â·ëª¨ë¸Â·ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í•œ ë²ˆ ë¡œë“œí•˜ê³  ê³„ì† ì”€. ì˜ˆ) 1 GB ë²¡í„° DB, ëŒ€í˜• ML ëª¨ë¸, ëŠë¦° ì´ˆê¸°í™”ê°€ ìˆëŠ” íˆ´.</p>
  </li>
  <li>
    <p>íƒìƒ‰í˜• ì‘ì—…: í•œ ë²ˆ ë§Œë“  ë³€ìˆ˜Â·í•¨ìˆ˜ë¥¼ ì´ì–´ê°€ë©° ì ì§„ì ìœ¼ë¡œ ì½”ë“œë¥¼ ë³´ê°•. EDA, ì‹œë®¬ë ˆì´ì…˜, ë””ë²„ê¹… ë£¨í”„ì— ìœ ë¦¬.</p>
  </li>
  <li>
    <p>ë„êµ¬ì˜ ì›Œë°ì—… ìœ ì§€: JIT ì»´íŒŒì¼, ìºì‹œ(í† í°í™” ìºì‹œ, ì •ê·œì‹ ì»´íŒŒì¼ ë“±)ë¥¼ ë‹¤ì‹œ ì•ˆ í•´ë„ ë¨.</p>
  </li>
  <li>
    <p>ì¸í„°ë™í‹°ë¸Œ UX: â€œë°©ê¸ˆ ë§Œë“  dfë¥¼ ê·¸ë˜í”„ë¡œ ë°”ê¿”â€ ê°™ì€ í›„ì† ëª…ë ¹ì´ ìì—°ìŠ¤ëŸ¬ì›€.</p>
  </li>
</ul>

<ol>
  <li>ì„¸ì…˜ì˜ ë¹„ìš©Â·ë¦¬ìŠ¤í¬</li>
</ol>

<ul>
  <li>
    <p>ì¬í˜„ì„± í•˜ë½: ìˆ¨ì€ ìƒíƒœ ë•Œë¬¸ì— ê°™ì€ ì½”ë“œê°€ ë§¤ë²ˆ ë™ì¼í•˜ê²Œ ì•ˆ ëŒ ìˆ˜ë„ ìˆìŒ.</p>
  </li>
  <li>
    <p>ë©”ëª¨ë¦¬ ëˆ„ìˆ˜/ì˜¤ì—¼: LLMì´ ë§Œë“  ì „ì—­ì´ ìŒ“ì´ë‹¤ê°€ ì„±ëŠ¥ ì €í•˜. ìƒíƒœ â€œë…â€ì´ ë‚¨ìœ¼ë©´ ê³„ì† ì‹¤íŒ¨.</p>
  </li>
  <li>
    <p>ë³´ì•ˆÂ·í†µì œ ì–´ë ¤ì›€: ìƒíƒœê°€ ê¸¸ê²Œ ë‚¨ì„ìˆ˜ë¡ ì •ì±… ìœ„ë°˜ íƒì§€ê°€ ëŠ¦ì–´ì§. ì„¸ì…˜ë³„ CWD/ê²½ë¡œ ì •ì±…ì„ ëŠ˜ ì ê²€í•´ì•¼ í•¨.</p>
  </li>
  <li>
    <p>ìš´ì˜ ë¶€ë‹´: ì„¸ì…˜ ìˆ˜ëª…, TTL, ì •ë¦¬ ì‹œì , ë™ì‹œì„±, ì¥ì•  ë³µêµ¬ ë“±ì„ ê´€ë¦¬í•´ì•¼ í•¨.</p>
  </li>
</ul>

<ol>
  <li>ê²°ë¡  ìš”ì•½: ì „í˜•ì ì¸ ì„ íƒ ê¸°ì¤€</li>
</ol>

<ul>
  <li>
    <p>ì¼íšŒì„± ê³„ì‚°Â·ë³€í™˜Â·ë¦¬í¬íŠ¸ì²˜ëŸ¼ â€œê°™ì€ ì…ë ¥ â†’ ê°™ì€ ì¶œë ¥â€ì´ë©´ ì„¸ì…˜ ë¶ˆí•„ìš”(ì¼íšŒìš© ì‹¤í–‰ ê¶Œì¥).</p>
  </li>
  <li>
    <p>ëŒ€ìš©ëŸ‰ ì´ˆê¸°í™”ê°€ ë°˜ë³µë˜ê±°ë‚˜, ë‹¤ë‹¨ê³„ ì‹¤í—˜Â·EDAì²˜ëŸ¼ â€œë§¥ë½ì„ ì‡ëŠ”â€ íë¦„ì´ë©´ ì„¸ì…˜ì´ ì´ë“.</p>
  </li>
  <li>
    <p>ë‘˜ ë‹¤ ì“°ê³ , ê¸°ë³¸ê°’ì€ ì¼íšŒìš©. ë‹¤ìŒ ì¡°ê±´ì´ë©´ ìë™ìœ¼ë¡œ ì„¸ì…˜ìœ¼ë¡œ ìŠ¹ê²©í•˜ëŠ” ì „ëµì´ ê¹”ë”í•¨.</p>

    <ul>
      <li>
        <p>ì—°ì† í˜¸ì¶œ ê°„ ê°™ì€ ì‚¬ìš©ìÂ·ê°™ì€ ì‘ì—… ìŠ¤ë ˆë“œì—ì„œ 2íšŒ ì´ìƒ í›„ì† ì§€ì‹œê°€ ë“¤ì–´ì˜´.</p>
      </li>
      <li>
        <p>ì½”ë“œê°€ â€œì•ì—ì„œ ë§Œë“  ê°ì²´/íŒŒì¼/ë³€ìˆ˜â€ë¥¼ ì°¸ì¡°.</p>
      </li>
      <li>
        <p>ì´ˆê¸°í™” ë¹„ìš©ì´ ì„ê³„ì¹˜(ì˜ˆ: 300 ms ë˜ëŠ” ë©”ëª¨ë¦¬ 200 MB ì´ìƒ) ë„˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ê°ì§€.</p>
      </li>
    </ul>
  </li>
</ul>

<ol>
  <li>í˜„ì‹¤ì ì¸ ìš´ì˜ ê¶Œì¥ì•ˆ</li>
</ol>

<ul>
  <li>
    <p>ê¸°ë³¸: python_execute_onceë§Œ ì‚¬ìš©. ë¹ ë¥´ê³  ì¬í˜„ì„± ë†’ìŒ.</p>
  </li>
  <li>
    <p>í•„ìš” ì‹œë§Œ ì„¸ì…˜: python_session_start/executeë¥¼ ë…¸ì¶œí•˜ë˜, ì„œë²„ ì •ì±…ìœ¼ë¡œ ì•„ë˜ì²˜ëŸ¼ ì•ˆì „ ë ˆì¼ì„ ê¹ë‹¤.</p>

    <ul>
      <li>
        <p>idle_timeout(ì˜ˆ: 5ë¶„), hard_ttl(ì˜ˆ: 30ë¶„), max_sessions_per_user(ì˜ˆ: 2).</p>
      </li>
      <li>
        <p>ì„¸ì…˜ë‹¹ ë©”ëª¨ë¦¬Â·íŒŒì¼ í¬ê¸° rlimit, ì“°ê¸° ê²½ë¡œëŠ” write_pathsë§Œ.</p>
      </li>
      <li>
        <p>resetê³¼ shutdownì„ LLMì— ëª…ì‹œì ìœ¼ë¡œ ê°€ë¥´ì¹˜ê³ , ì‹¤íŒ¨ ì‹œ ìë™ reset.</p>
      </li>
      <li>
        <p>ë¡œê·¸ì— [AUDIT] ë¼ì¸(ë§‰íŒ íŒŒì¼Â·ì»¤ë§¨ë“œÂ·ì‚¬ìœ )ê³¼ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ì„ í•¨ê»˜ ë‚¨ê¹€.</p>
      </li>
    </ul>
  </li>
</ul>

<ol>
  <li>â€œì„¸ì…˜ ì—†ì´ë„ ê¸°ì–µí•˜ê¸°â€ ëŒ€ì•ˆ</li>
</ol>

<ul>
  <li>
    <p>íŒŒì¼ ê¸°ë°˜ ìƒíƒœ: ì¼íšŒìš© ì‹¤í–‰ë§ˆë‹¤ í—ˆìš©ëœ write_pathsì—ë§Œ ì•„í‹°íŒ©íŠ¸(.npz/.parquet/.pt) ì €ì¥ â†’ ë‹¤ìŒ í˜¸ì¶œì—ì„œ ê²½ë¡œë§Œ ë„˜ê²¨ ì¬ì‚¬ìš©. ì„¸ì…˜ ì—†ì´ë„ 80%ì˜ â€œê¸°ì–µâ€ì„ ì¶©ì¡±.</p>
  </li>
  <li>
    <p>ì„ íƒ ì§ë ¬í™”: ë§¤ìš° ì œí•œëœ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ íƒ€ì…ë§Œ ìë™ ì €ì¥/ë³µì›(dict[strâ†’ndarray/DataFrame/float/int])í•´ì„œ â€œì˜ë¯¸ ìˆëŠ” ìµœì†Œ ìƒíƒœâ€ë§Œ ì´ì–´ ë°›ê¸°. í”„ë¡œì„¸ìŠ¤ëŠ” ë§¤ë²ˆ ìƒˆë¡œ ë„ì›Œ ì¬í˜„ì„± ìœ ì§€.</p>
  </li>
</ul>

<ol>
  <li>ì ìš© íŒ(ë‹¹ì¥ ì“¸ ì„¤ì •)</li>
</ol>

<ul>
  <li>
    <p>ì˜¤ëŠ˜ êµ¬ì¡°ì—ì„œ ê¸°ë³¸ê°’ì„ ì´ë ‡ê²Œ ë‘ë©´ ê· í˜•ì´ ì¢‹ë‹¤.</p>

    <ul>
      <li>
        <p>default_mode=â€œonceâ€, session_modeëŠ” ëª…ì‹œ opt-in</p>
      </li>
      <li>
        <p>session idle_timeout=300s, hard_ttl=1800s</p>
      </li>
      <li>
        <p>state persistenceëŠ” â€œíŒŒì¼ë¡œë§Œâ€ í—ˆìš©(í”¼í´ ì „ì—­ ì €ì¥ì€ ê¸ˆì§€)</p>
      </li>
      <li>
        <p>read_pathsëŠ” ë„‰ë„‰íˆ, write_pathsëŠ” ìµœì†Œë¡œ</p>
      </li>
      <li>
        <p>ë„¤íŠ¸ì›Œí¬ ì°¨ë‹¨ ê¸°ë³¸ On, í•„ìš” ì‹œë§Œ ì„ì‹œ í•´ì œ</p>
      </li>
    </ul>
  </li>
</ul>

<p>ìš”ì•½í•˜ë©´, ì„¸ì…˜ì€ â€œì†ë„ì™€ í¸ì˜â€ë¥¼ ì‚¬ê³  â€œì¬í˜„ì„±ê³¼ ë‹¨ìˆœì„±â€ì„ íŒë‹¤. LLM ì—ì´ì „íŠ¸ì—ì„œ ì‹¤ìˆ˜ ë°©ì§€ê°€ ìš°ì„ ì´ë©´ ì¼íšŒìš©ì„ ê¸°ë³¸ìœ¼ë¡œ, ëŒ€í˜• ì´ˆê¸°í™”ë‚˜ ì¸í„°ë™í‹°ë¸Œ ë£¨í”„ê°€ í•„ìš”í•  ë•Œë§Œ ì„¸ì…˜ì„ ì—´ê³  TTLÂ·ë¦¬ë°‹ìœ¼ë¡œ ë‹¤ìŠ¤ë¦¬ëŠ” í•˜ì´ë¸Œë¦¬ë“œê°€ ê°€ì¥ ì•ˆì •ì ì´ë‹¤. ë‹¤ìŒ ë‹¨ê³„ë¡œëŠ” ë„ˆì˜ íˆ´ ë ˆì´ì–´ì—ì„œ ê¸°ë³¸ì„ onceë¡œ ë‘ê³ , íŠ¹ì • ê·œì¹™ì— ë§ìœ¼ë©´ session_startë¥¼ ìë™ ì œì•ˆí•˜ë„ë¡ ë„£ìœ¼ë©´ ëœë‹¤.</p>

<p class="chat--user">

ì¼ë‹¨ íˆ´ë¡œëŠ” ì¼íšŒìš© ì„¸ì…˜ë§Œ ì§€ì›í•´ë³´ì

</p>

<p>ì¢‹ì•„. â€œì¼íšŒìš© ì„¸ì…˜ë§Œâ€ ì§€ì›í•˜ëŠ” LLM íˆ´ì„ ê¹”ë”í•˜ê²Œ ì •ë¦¬í–ˆë‹¤. ì„¤ì •ì€ ì„œë²„ ìª½ì—ë§Œ ë‘ê³ , LLMì—ëŠ” ì˜¤ì§ ì½”ë“œì™€ íƒ€ì„ì•„ì›ƒ(+ì„ íƒì  cwd ìƒëŒ€ê²½ë¡œ)ë§Œ ë…¸ì¶œí•œë‹¤. íŒŒì¼/ì„œë¸Œí”„ë¡œì„¸ìŠ¤(ì˜µì…˜ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬)ëŠ” ê°ì‚¬ í›…ìœ¼ë¡œ ì œì–´í•˜ê³ , ì°¨ë‹¨ ì‚¬ìœ ë¥¼ stderrì— êµ¬ì²´ì ìœ¼ë¡œ ë‚¨ê¸´ë‹¤.</p>

<p>ì•„ë˜ íŒŒì¼ í•˜ë‚˜ë¡œ ëë‚œë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># oneoff_tool.py
# Python 3.8+ / ì™¸ë¶€ ì˜ì¡´ì„± ì—†ìŒ
</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">multiprocessing</span> <span class="k">as</span> <span class="n">mp</span>
<span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">traceback</span><span class="p">,</span> <span class="n">contextlib</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>

<span class="c1"># ============== ì„œë²„ì¸¡ ì •ì±…(LLM ë¹„ë…¸ì¶œ) ==============
</span><span class="n">READ_PATHS_DEFAULT</span>  <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="sh">"</span><span class="s">./data_ro</span><span class="sh">"</span><span class="p">)]</span>    <span class="c1"># ì½ê¸° í—ˆìš© ë£¨íŠ¸(í•˜ìœ„ í¬í•¨). []ë©´ ì–´ë””ë“  ì½ê¸° í—ˆìš©
</span><span class="n">WRITE_PATHS_DEFAULT</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="sh">"</span><span class="s">./sandbox</span><span class="sh">"</span><span class="p">)]</span>    <span class="c1"># ì“°ê¸° í—ˆìš© ë£¨íŠ¸(í•˜ìœ„ í¬í•¨). []ë©´ ì „ë¶€ ì°¨ë‹¨
</span><span class="n">DEFAULT_CWD</span>         <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="sh">"</span><span class="s">./work</span><span class="sh">"</span><span class="p">)</span>         <span class="c1"># ì‹œì‘ ì‘ì—… ë””ë ‰í„°ë¦¬
</span><span class="n">BLOCK_SUBPROC</span>       <span class="o">=</span> <span class="bp">True</span>                              <span class="c1"># ì„œë¸Œí”„ë¡œì„¸ìŠ¤ ì°¨ë‹¨
</span><span class="n">BLOCK_NET</span>           <span class="o">=</span> <span class="bp">False</span>                             <span class="c1"># í•„ìš” ì‹œ True
</span><span class="n">SANITIZE_ENV</span>        <span class="o">=</span> <span class="bp">True</span>                              <span class="c1"># í™˜ê²½ë³€ìˆ˜ ìµœì†Œí™”
</span><span class="n">ALLOWED_ENV_KEYS</span>    <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">PATH</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">PYTHONPATH</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">HOME</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">TMPDIR</span><span class="sh">"</span><span class="p">]</span>

<span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">DEFAULT_CWD</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">WRITE_PATHS_DEFAULT</span><span class="p">:</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># ============== ë‚´ë¶€: ê°ì‚¬ í›… ì„¤ì¹˜ ==============
</span><span class="k">def</span> <span class="nf">_install_guard</span><span class="p">(</span><span class="n">read_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                   <span class="n">write_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                   <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                   <span class="n">block_subprocess</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                   <span class="n">block_network</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">rp</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">read_paths</span> <span class="ow">or</span> <span class="p">[])]</span>
    <span class="n">wp</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">write_paths</span> <span class="ow">or</span> <span class="p">[])]</span>

    <span class="k">def</span> <span class="nf">_real</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span> <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">roots</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">roots</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="nf">_real</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="n">r</span> <span class="ow">or</span> <span class="n">path</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_audit</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">os.open</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">write</span> <span class="o">=</span> <span class="nf">any</span><span class="p">(</span><span class="n">ch</span> <span class="ow">in</span> <span class="n">mode</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">x</span><span class="sh">"</span><span class="p">))</span> <span class="ow">or</span> \
                    <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">O_WRONLY</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_RDWR</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_CREAT</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_TRUNC</span><span class="o">|</span><span class="n">os</span><span class="p">.</span><span class="n">O_APPEND</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">write</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">wp</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> path=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s"> mode=</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s"> flags=</span><span class="si">{</span><span class="n">flags</span><span class="si">}</span><span class="s"> reason=write-outside-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="nf">if </span><span class="p">(</span><span class="ow">not</span> <span class="n">write</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">allow_read_anywhere</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">rp</span> <span class="o">+</span> <span class="n">wp</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> path=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s"> reason=read-not-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">os.rename</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.replace</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nf">_under_any</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">wp</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">wp</span><span class="p">)):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> src=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">src</span><span class="p">)</span><span class="si">}</span><span class="s"> dst=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span><span class="si">}</span><span class="s"> reason=op-outside-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">os.remove</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.unlink</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.mkdir</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.makedirs</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.rmdir</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">os.chmod</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nf">_under_any</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">wp</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> path=</span><span class="si">{</span><span class="nf">_real</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s"> reason=op-outside-allowed</span><span class="sh">"</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">block_subprocess</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">subprocess.</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">event</span> <span class="o">==</span> <span class="sh">"</span><span class="s">os.system</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span> <span class="n">cmd</span> <span class="o">=</span> <span class="sh">"</span><span class="s">&lt;unknown&gt;</span><span class="sh">"</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> cmd=</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s"> reason=subprocess-disabled</span><span class="sh">"</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">block_network</span> <span class="ow">and</span> <span class="n">event</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">socket.</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[AUDIT] blocked: event=</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s"> reason=network-disabled</span><span class="sh">"</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">sys</span><span class="p">.</span><span class="nf">addaudithook</span><span class="p">(</span><span class="n">_audit</span><span class="p">)</span>

<span class="c1"># ============== ë‚´ë¶€: ìì‹ ì›Œì»¤(ì¼íšŒìš©) ==============
</span><span class="k">def</span> <span class="nf">_child_once_worker</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                       <span class="n">read_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                       <span class="n">write_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                       <span class="n">cwd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                       <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                       <span class="n">block_subprocess</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                       <span class="n">block_network</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                       <span class="n">sanitize_env</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                       <span class="n">allowed_env_keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
                       <span class="n">result_q</span><span class="p">:</span> <span class="n">mp</span><span class="p">.</span><span class="n">Queue</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">stdout_buf</span><span class="p">,</span> <span class="n">stderr_buf</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="nc">StringIO</span><span class="p">(),</span> <span class="n">io</span><span class="p">.</span><span class="nc">StringIO</span><span class="p">()</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cwd</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">cwd</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sanitize_env</span><span class="p">:</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">allowed_env_keys</span> <span class="ow">or</span> <span class="p">[</span><span class="sh">"</span><span class="s">PATH</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">PYTHONPATH</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">HOME</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">TMPDIR</span><span class="sh">"</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nf">list</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">:</span>
                    <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="nf">_install_guard</span><span class="p">(</span><span class="n">read_paths</span><span class="p">,</span> <span class="n">write_paths</span><span class="p">,</span> <span class="n">allow_read_anywhere</span><span class="p">,</span>
                       <span class="n">block_subprocess</span><span class="o">=</span><span class="n">block_subprocess</span><span class="p">,</span> <span class="n">block_network</span><span class="o">=</span><span class="n">block_network</span><span class="p">)</span>

        <span class="c1"># ì˜µì…˜: ë¦¬ì†ŒìŠ¤ í•œë„
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="n">resource</span>
            <span class="n">resource</span><span class="p">.</span><span class="nf">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">RLIMIT_CPU</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
            <span class="n">resource</span><span class="p">.</span><span class="nf">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="n">RLIMIT_FSIZE</span><span class="p">,</span> <span class="p">(</span><span class="mi">200</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,)</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">g</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">__name__</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">}</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">redirect_stdout</span><span class="p">(</span><span class="n">stdout_buf</span><span class="p">),</span> <span class="n">contextlib</span><span class="p">.</span><span class="nf">redirect_stderr</span><span class="p">(</span><span class="n">stderr_buf</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nf">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[ERROR] exception while executing user code:</span><span class="sh">"</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">traceback</span><span class="p">.</span><span class="nf">print_exc</span><span class="p">()</span>

    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[ERROR] sandbox init/exec failed: </span><span class="si">{</span><span class="nf">type</span><span class="p">(</span><span class="n">e</span><span class="p">).</span><span class="n">__name__</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">stderr_buf</span><span class="p">)</span>
        <span class="n">traceback</span><span class="p">.</span><span class="nf">print_exc</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">stderr_buf</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">result_q</span><span class="p">.</span><span class="nf">put</span><span class="p">({</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">rc</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="n">stdout_buf</span><span class="p">.</span><span class="nf">getvalue</span><span class="p">(),</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="n">stderr_buf</span><span class="p">.</span><span class="nf">getvalue</span><span class="p">()})</span>

<span class="k">def</span> <span class="nf">_run_once_blocking</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                       <span class="n">read_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                       <span class="n">write_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                       <span class="n">cwd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                       <span class="n">allow_read_anywhere</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                       <span class="n">timeout_sec</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                       <span class="n">block_subprocess</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                       <span class="n">block_network</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                       <span class="n">sanitize_env</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                       <span class="n">allowed_env_keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">mp</span><span class="p">.</span><span class="nf">get_context</span><span class="p">(</span><span class="sh">"</span><span class="s">spawn</span><span class="sh">"</span><span class="p">)</span>   <span class="c1"># ë¶€ëª¨ ì „ì—­ ë…¸ì¶œ ë°©ì§€
</span>    <span class="n">q</span><span class="p">:</span> <span class="n">mp</span><span class="p">.</span><span class="n">Queue</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">.</span><span class="nc">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_child_once_worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span>
        <span class="n">code</span><span class="p">,</span> <span class="n">read_paths</span><span class="p">,</span> <span class="n">write_paths</span><span class="p">,</span> <span class="n">cwd</span><span class="p">,</span> <span class="n">allow_read_anywhere</span><span class="p">,</span>
        <span class="n">block_subprocess</span><span class="p">,</span> <span class="n">block_network</span><span class="p">,</span> <span class="n">sanitize_env</span><span class="p">,</span> <span class="n">allowed_env_keys</span><span class="p">,</span> <span class="n">q</span>
    <span class="p">))</span>
    <span class="n">p</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>

    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">();</span> <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">q</span><span class="p">.</span><span class="nf">empty</span><span class="p">():</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="nf">get</span><span class="p">()</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_alive</span><span class="p">():</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="n">exitcode</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="n">exitcode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
                      <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">[ERROR] child exited unexpectedly</span><span class="sh">"</span><span class="p">}</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&gt;</span> <span class="n">timeout_sec</span><span class="p">:</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">terminate</span><span class="p">();</span> <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">124</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[TIMEOUT] exceeded </span><span class="si">{</span><span class="n">timeout_sec</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

    <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_alive</span><span class="p">():</span>
        <span class="n">p</span><span class="p">.</span><span class="nf">terminate</span><span class="p">();</span> <span class="n">p</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span> <span class="ow">or</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">[ERROR] no result</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ============== ê³µê°œ API: ì¼íšŒìš© ì‹¤í–‰(ë¹„ë™ê¸°) ==============
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">run_user_code_once_async</span><span class="p">(</span>
    <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">cwd_rel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">timeout_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">
    ë³„ë„ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì½”ë“œ ì¡°ê°ì„ í•œ ë²ˆ ì‹¤í–‰í•˜ê³  stdout/stderrë§Œ ë°˜í™˜.
    - cwd_rel: DEFAULT_CWD ê¸°ì¤€ ìƒëŒ€ê²½ë¡œ. í—ˆìš© ë£¨íŠ¸ ë°–ì´ë©´ ê±°ë¶€.
    </span><span class="sh">"""</span>
    <span class="c1"># cwd ê²°ì • ë° ê²½ë¡œ ì •ê·œí™”
</span>    <span class="n">allowed_roots</span> <span class="o">=</span> <span class="nf">set</span><span class="p">([</span><span class="n">DEFAULT_CWD</span><span class="p">]</span> <span class="o">+</span> <span class="n">READ_PATHS_DEFAULT</span> <span class="o">+</span> <span class="n">WRITE_PATHS_DEFAULT</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cwd_rel</span><span class="p">:</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">DEFAULT_CWD</span><span class="p">,</span> <span class="n">cwd_rel</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">any</span><span class="p">(</span><span class="n">target</span> <span class="o">==</span> <span class="n">r</span> <span class="ow">or</span> <span class="n">target</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">allowed_roots</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[TOOL_ERROR] cwd_rel outside allowed roots: </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">cwd</span> <span class="o">=</span> <span class="n">target</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cwd</span> <span class="o">=</span> <span class="n">DEFAULT_CWD</span>

    <span class="n">allow_read_anywhere</span> <span class="o">=</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">READ_PATHS_DEFAULT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">loop</span><span class="p">.</span><span class="nf">run_in_executor</span><span class="p">(</span>
        <span class="bp">None</span><span class="p">,</span>
        <span class="n">_run_once_blocking</span><span class="p">,</span>
        <span class="n">code</span><span class="p">,</span>
        <span class="n">READ_PATHS_DEFAULT</span><span class="p">,</span>
        <span class="n">WRITE_PATHS_DEFAULT</span><span class="p">,</span>
        <span class="n">cwd</span><span class="p">,</span>
        <span class="n">allow_read_anywhere</span><span class="p">,</span>
        <span class="n">timeout_sec</span><span class="p">,</span>
        <span class="n">BLOCK_SUBPROC</span><span class="p">,</span>
        <span class="n">BLOCK_NET</span><span class="p">,</span>
        <span class="n">SANITIZE_ENV</span><span class="p">,</span>
        <span class="n">ALLOWED_ENV_KEYS</span><span class="p">,</span>
    <span class="p">)</span>

<span class="c1"># ============== LLM íˆ´ ìŠ¤í‚¤ë§ˆì™€ í•¸ë“¤ëŸ¬ ==============
</span><span class="n">python_execute_once_tool</span> <span class="o">=</span> <span class="p">{</span>
  <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
  <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">python_execute_once</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì¼íšŒì„± íŒŒì´ì¬ ì½”ë“œ ì¡°ê°ì„ ìƒŒë“œë°•ìŠ¤ì—ì„œ ì‹¤í–‰í•˜ê³  stdout/stderrë§Œ ë°˜í™˜í•©ë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">60</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">cwd_rel</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ê¸°ë³¸ ì‘ì—… ë””ë ‰í„°ë¦¬(DEFAULT_CWD) ê¸°ì¤€ ìƒëŒ€ê²½ë¡œ</span><span class="sh">"</span><span class="p">}</span>
      <span class="p">},</span>
      <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">],</span>
      <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">tool_python_execute_once</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="nf">run_user_code_once_async</span><span class="p">(</span>
            <span class="n">args</span><span class="p">[</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">],</span>
            <span class="n">cwd_rel</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cwd_rel</span><span class="sh">"</span><span class="p">),</span>
            <span class="n">timeout_sec</span><span class="o">=</span><span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">,</span> <span class="mi">10</span><span class="p">)),</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[TOOL_ERROR] </span><span class="si">{</span><span class="nf">type</span><span class="p">(</span><span class="n">e</span><span class="p">).</span><span class="n">__name__</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ë™ê¸° ì–´ëŒ‘í„°(í”„ë ˆì„ì›Œí¬ê°€ syncë§Œ ì§€ì›í•  ë•Œ ì„ íƒ)
</span><span class="k">def</span> <span class="nf">run_tool_sync</span><span class="p">(</span><span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_runner</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">python_execute_once</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="nf">tool_python_execute_once</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">unknown tool</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
        <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">run_tool_sync called in running loop</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">RuntimeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">_runner</span><span class="p">())</span>
</code></pre></div></div>

<p>ì—°ê²° ë°©ë²• ìš”ì•½</p>

<ol>
  <li>
    <p>ì„œë²„ì—ì„œ READ_PATHS_DEFAULT, WRITE_PATHS_DEFAULT, DEFAULT_CWD ë“± ì •ì±…ë§Œ ì„¸íŒ…í•œë‹¤. ì´ ê°’ë“¤ì€ LLMì— ì ˆëŒ€ ë…¸ì¶œí•˜ì§€ ì•ŠëŠ”ë‹¤.</p>
  </li>
  <li>
    <p>ì—ì´ì „íŠ¸ ëŸ°íƒ€ì„ì— íˆ´ ì •ì˜ë¡œ python_execute_once_toolì„ ë“±ë¡í•œë‹¤.</p>
  </li>
  <li>
    <p>íˆ´ ì½œì´ ë“¤ì–´ì˜¤ë©´ tool_python_execute_onceë¥¼ awaití•´ì„œ ê²°ê³¼ ë”•ì…”ë„ˆë¦¬(returncode/stdout/stderr)ë¥¼ ëª¨ë¸ì— ì¬í”¼ë“œí•œë‹¤.</p>
  </li>
  <li>
    <p>ê²½ë¡œ í˜¼ë™ì„ ë§‰ìœ¼ë ¤ë©´ ì •ì±… ê²½ë¡œë“¤ì€ ì• ì´ˆì— ì ˆëŒ€ê²½ë¡œë¡œ ë‘ëŠ” ê²Œ ê°€ì¥ ê¹”ë”í•˜ê³ , LLMì—ëŠ” cwd_relë§Œ ì„ íƒì ìœ¼ë¡œ í—ˆìš©í•œë‹¤.</p>
  </li>
</ol>

<p>ìš´ìš© íŒ</p>

<ul>
  <li>
    <p>ê¸ˆì§€ëœ íŒŒì¼Â·ì—°ì‚°Â·ì»¤ë§¨ë“œëŠ” stderrì— [AUDIT] ë¼ì¸ìœ¼ë¡œ ì´ìœ ì™€ í•¨ê»˜ ë‚¨ëŠ”ë‹¤.</p>
  </li>
  <li>
    <p>ëŒ€ëŸ‰ ë³‘ë ¬ì´ í•„ìš”í•˜ë©´ _run_once_blockingì„ ProcessPoolExecutorë¡œ ë°”ê¾¸ê±°ë‚˜ ë™ì‹œ ì‹¤í–‰ ì„¸ë§ˆí¬ì–´ë§Œ ì–¹ìœ¼ë©´ ëœë‹¤.</p>
  </li>
  <li>
    <p>ë‚˜ì¤‘ì— ì„¸ì…˜í˜•ì´ í•„ìš”í•´ì§€ë©´, ì´ êµ¬ì¡° ìœ„ì— PersistentKernelì„ ì–¹ì–´ë„ ì¸í„°í˜ì´ìŠ¤ëŠ” ë°”ë€Œì§€ ì•ŠëŠ”ë‹¤.</p>
  </li>
</ul>

<p class="chat--user">

ê¸°ì¡´ ë§Œë“  PersistentKernelì€ í™œìš©í•˜ëŠ”ê²Œ ì¢‹ì„ê±° ê°™ì€ë°

</p>

<p>ì¢‹ì•„. â€œì¼íšŒìš© íˆ´ë§Œ ì§€ì›â€ì€ ìœ ì§€í•˜ë˜, ë‚´ë¶€ ì—”ì§„ì€ PersistentKernelì„ ê·¸ëŒ€ë¡œ ì¨ì„œ ì‹¤í–‰-ì •ë¦¬ê¹Œì§€ í•œ ë²ˆì— íƒœìš°ëŠ” ë˜í¼ë¥¼ ë§Œë“¤ì. ë‚˜ì¤‘ì— ì„¸ì…˜í˜•ìœ¼ë¡œ í™•ì¥í•  ë•Œ ë°”ë€ŒëŠ” ê±´ íˆ´ ë°”ì¸ë”©ì´ ì•„ë‹ˆë¼ ì •ì±…ë¿ì´ ë˜ë„ë¡.</p>

<p>ì•„ë˜ íŒŒì¼ í•˜ë‚˜ë¡œ ëë‚œë‹¤. í•µì‹¬ì€ EphemeralKernelRunner.run_onceê°€ PersistentKernelì„ ì¦‰ì‹œ ë„ìš°ê³ (a.start), ì½”ë“œ ì‹¤í–‰(aexec), ê²°ê³¼ íšŒìˆ˜ í›„ ì¦‰ì‹œ ì¢…ë£Œ(shutdown)í•˜ëŠ” íŒ¨í„´ì´ë‹¤. ìƒë‹¨ì˜ READ_PATHS_DEFAULT/WRITE_PATHS_DEFAULT/DEFAULT_CWDë§Œ ìš´ì˜ìê°€ ì„¸íŒ…í•˜ê³ , LLMì—ëŠ” code, timeout_sec, cwd_relë§Œ ë…¸ì¶œí•œë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># oneoff_with_persistent_kernel.py
# ìš”êµ¬: Python 3.8+, ê°™ì€ í´ë”ì— persistent_kernel_async.pyê°€ ìˆì–´ì•¼ í•¨
</span><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span> <span class="n">persistent_kernel_async</span> <span class="kn">import</span> <span class="n">PersistentKernel</span>  <span class="c1"># ì•ì„œ ë§Œë“  ì»¤ë„ êµ¬í˜„
</span>
<span class="c1"># ===================== ì„œë²„ ì •ì±…(LLM ë¹„ë…¸ì¶œ) =====================
</span><span class="n">READ_PATHS_DEFAULT</span>  <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="sh">"</span><span class="s">./data_ro</span><span class="sh">"</span><span class="p">)]</span>   <span class="c1"># ì½ê¸° í—ˆìš© ë£¨íŠ¸(í•˜ìœ„ í¬í•¨). []ë©´ ì–´ë””ë“  ì½ê¸° í—ˆìš©
</span><span class="n">WRITE_PATHS_DEFAULT</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="sh">"</span><span class="s">./sandbox</span><span class="sh">"</span><span class="p">)]</span>   <span class="c1"># ì“°ê¸° í—ˆìš© ë£¨íŠ¸(í•˜ìœ„ í¬í•¨). []ë©´ ì „ë¶€ ì°¨ë‹¨
</span><span class="n">DEFAULT_CWD</span>         <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="sh">"</span><span class="s">./work</span><span class="sh">"</span><span class="p">)</span>        <span class="c1"># ì»¤ë„ ì‹œì‘ CWD
</span><span class="n">BLOCK_SUBPROC</span>       <span class="o">=</span> <span class="bp">True</span>
<span class="n">BLOCK_NET</span>           <span class="o">=</span> <span class="bp">False</span>
<span class="n">SANITIZE_ENV</span>        <span class="o">=</span> <span class="bp">True</span>
<span class="n">ALLOWED_ENV_KEYS</span>    <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">PATH</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">PYTHONPATH</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">HOME</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">TMPDIR</span><span class="sh">"</span><span class="p">]</span>

<span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">DEFAULT_CWD</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">WRITE_PATHS_DEFAULT</span><span class="p">:</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_abslist</span><span class="p">(</span><span class="n">paths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">paths</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getcwd</span><span class="p">()</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
        <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">p</span> <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isabs</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">else</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">p</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">_resolve_cwd_rel</span><span class="p">(</span><span class="n">cwd_rel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cwd_rel</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">DEFAULT_CWD</span><span class="p">,</span> <span class="n">cwd_rel</span><span class="p">))</span>
    <span class="n">allowed_roots</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="nf">_abslist</span><span class="p">(</span><span class="n">READ_PATHS_DEFAULT</span><span class="p">)</span> <span class="o">+</span> <span class="nf">_abslist</span><span class="p">(</span><span class="n">WRITE_PATHS_DEFAULT</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">DEFAULT_CWD</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">any</span><span class="p">(</span><span class="n">target</span> <span class="o">==</span> <span class="n">r</span> <span class="ow">or</span> <span class="n">target</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">allowed_roots</span><span class="p">):</span>
        <span class="k">raise</span> <span class="nc">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">cwd_rel outside allowed roots: </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">target</span>

<span class="c1"># ===================== ì¼íšŒìš© ì‹¤í–‰ ëŸ¬ë„ˆ =====================
</span><span class="k">class</span> <span class="nc">EphemeralKernelRunner</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_once</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">cwd_rel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nc">PersistentKernel</span><span class="p">()</span>
        <span class="c1"># ì»¤ë„ ì‹œì‘: ì—¬ê¸°ì„œ ì„¸ì…˜ì€ ë§Œë“¤ì–´ì§€ì§€ë§Œ ì´ í˜¸ì¶œ ì•ˆì—ì„œë§Œ ì“°ê³  ê³§ë°”ë¡œ ì¢…ë£Œí•œë‹¤.
</span>        <span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span>
            <span class="n">read_paths</span><span class="o">=</span><span class="n">READ_PATHS_DEFAULT</span><span class="p">,</span>
            <span class="n">write_paths</span><span class="o">=</span><span class="n">WRITE_PATHS_DEFAULT</span><span class="p">,</span>
            <span class="n">cwd</span><span class="o">=</span><span class="nf">_resolve_cwd_rel</span><span class="p">(</span><span class="n">cwd_rel</span><span class="p">)</span> <span class="ow">or</span> <span class="n">DEFAULT_CWD</span><span class="p">,</span>
            <span class="n">allow_read_anywhere</span><span class="o">=</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">READ_PATHS_DEFAULT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">block_subprocess</span><span class="o">=</span><span class="n">BLOCK_SUBPROC</span><span class="p">,</span>
            <span class="n">block_network</span><span class="o">=</span><span class="n">BLOCK_NET</span><span class="p">,</span>
            <span class="n">sanitize_env</span><span class="o">=</span><span class="n">SANITIZE_ENV</span><span class="p">,</span>
            <span class="n">allowed_env_keys</span><span class="o">=</span><span class="n">ALLOWED_ENV_KEYS</span><span class="p">,</span>
            <span class="n">startup_timeout</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># ì½”ë“œ ì‹¤í–‰
</span>            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">aexec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_sec</span><span class="p">)</span>
            <span class="c1"># res = {"returncode": int, "stdout": str, "stderr": str}
</span>            <span class="k">return</span> <span class="n">res</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># í•­ìƒ ì¢…ë£Œ(ì„¸ì…˜ ìœ ì§€ ì—†ìŒ)
</span>            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">k</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">()</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

<span class="c1"># ===================== LLM íˆ´ ìŠ¤í‚¤ë§ˆ ë° í•¸ë“¤ëŸ¬ =====================
</span><span class="n">python_execute_once_tool</span> <span class="o">=</span> <span class="p">{</span>
  <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
  <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">python_execute_once</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì¼íšŒì„± íŒŒì´ì¬ ì½”ë“œ ì¡°ê°ì„ PersistentKernel ê¸°ë°˜ ìƒŒë“œë°•ìŠ¤ì—ì„œ ì‹¤í–‰í•˜ê³  stdout/stderrë§Œ ë°˜í™˜í•©ë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">object</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">properties</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">integer</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="sh">"</span><span class="s">minimum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">maximum</span><span class="sh">"</span><span class="p">:</span> <span class="mi">60</span><span class="p">},</span>
        <span class="sh">"</span><span class="s">cwd_rel</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">string</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ê¸°ë³¸ ì‘ì—… ë””ë ‰í„°ë¦¬(DEFAULT_CWD) ê¸°ì¤€ ìƒëŒ€ê²½ë¡œ(í—ˆìš© ë£¨íŠ¸ ë°–ì´ë©´ ê±°ë¶€).</span><span class="sh">"</span><span class="p">}</span>
      <span class="p">},</span>
      <span class="sh">"</span><span class="s">required</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">],</span>
      <span class="sh">"</span><span class="s">additionalProperties</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">strict</span><span class="sh">"</span><span class="p">:</span> <span class="bp">True</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">_runner</span> <span class="o">=</span> <span class="nc">EphemeralKernelRunner</span><span class="p">()</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">tool_python_execute_once</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">cwd_rel</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cwd_rel</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">_runner</span><span class="p">.</span><span class="nf">run_once</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">cwd_rel</span><span class="o">=</span><span class="n">cwd_rel</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">[TOOL_ERROR] </span><span class="si">{</span><span class="nf">type</span><span class="p">(</span><span class="n">e</span><span class="p">).</span><span class="n">__name__</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>

<span class="c1"># ë™ê¸° ì–´ëŒ‘í„°(í”„ë ˆì„ì›Œí¬ê°€ syncë§Œ ì§€ì›í•  ë•Œ ì„ íƒ)
</span><span class="k">def</span> <span class="nf">run_tool_sync</span><span class="p">(</span><span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_runner_main</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">python_execute_once</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="nf">tool_python_execute_once</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">unknown tool: </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_running_loop</span><span class="p">()</span>
        <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">run_tool_sync called inside event loop</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">RuntimeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">_runner_main</span><span class="p">())</span>

<span class="c1"># =============== ê°„ë‹¨ ë°ëª¨ ===============
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
        <span class="n">demo</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"""</span><span class="s">
import os, sys, subprocess
print(</span><span class="sh">"</span><span class="s">CWD:</span><span class="sh">"</span><span class="s">, os.getcwd())
open(</span><span class="sh">"</span><span class="s">out_demo.txt</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="s">).write(</span><span class="sh">"</span><span class="s">ok</span><span class="sh">"</span><span class="s">)  # WRITE_PATHS_DEFAULT í•˜ìœ„ì—¬ì•¼ í†µê³¼
try:
    subprocess.check_output([</span><span class="sh">"</span><span class="s">echo</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">hi</span><span class="sh">"</span><span class="s">])
except Exception as e:
    print(</span><span class="sh">"</span><span class="s">blocked subproc:</span><span class="sh">"</span><span class="s">, type(e).__name__)
print(</span><span class="sh">"</span><span class="s">done</span><span class="sh">"</span><span class="s">)
</span><span class="sh">"""</span>
        <span class="c1"># ë°ëª¨ìš©: write_pathsì— DEFAULT_CWDë¥¼ ë„£ì—ˆê±°ë‚˜, DEFAULT_CWD/out_demo.txtê°€ WRITE_PATHS_DEFAULT ì•ˆì— ìˆì–´ì•¼ í•¨
</span>        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">tool_python_execute_once</span><span class="p">({</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:</span> <span class="n">demo</span><span class="p">,</span> <span class="sh">"</span><span class="s">timeout_sec</span><span class="sh">"</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="sh">"</span><span class="s">cwd_rel</span><span class="sh">"</span><span class="p">:</span> <span class="sh">""</span><span class="p">})</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">RC:</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="sh">"</span><span class="s">returncode</span><span class="sh">"</span><span class="p">])</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDOUT:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="sh">"</span><span class="s">stdout</span><span class="sh">"</span><span class="p">])</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">STDERR:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="sh">"</span><span class="s">stderr</span><span class="sh">"</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">sys</span><span class="p">.</span><span class="n">platform</span> <span class="o">==</span> <span class="sh">"</span><span class="s">win32</span><span class="sh">"</span><span class="p">:</span>
        <span class="kn">import</span> <span class="n">multiprocessing</span> <span class="k">as</span> <span class="n">mp</span>
        <span class="n">mp</span><span class="p">.</span><span class="nf">freeze_support</span><span class="p">()</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
</code></pre></div></div>

<p>ë™ì‘ íë¦„ ìš”ì•½</p>

<ol>
  <li>
    <p>LLMì´ python_execute_onceë¥¼ í˜¸ì¶œí•˜ë©´ EphemeralKernelRunnerê°€ PersistentKernelì„ ì¦‰ì‹œ ë„ìš´ë‹¤.</p>
  </li>
  <li>
    <p>ì»¤ë„ì€ ê°ì‚¬ í›…ì´ ì„¤ì¹˜ëœ ìƒŒë“œë°•ìŠ¤ ìƒíƒœë¡œ codeë¥¼ execí•˜ê³  stdout/stderrë§Œ ë°˜í™˜í•œë‹¤.</p>
  </li>
  <li>
    <p>ì‹¤í–‰ ì§í›„ ë°˜ë“œì‹œ shutdowní•˜ë¯€ë¡œ ì„¸ì…˜ì€ ë‚¨ì§€ ì•ŠëŠ”ë‹¤. ì„¸ì…˜ ìœ ì§€ê°€ í•„ìš”í•´ì§€ë©´ ì´ ëŸ¬ë„ˆ ëŒ€ì‹  ì•„ê¹Œ ë§Œë“  PersistentKernel íˆ´ì…‹ì„ ê·¸ëŒ€ë¡œ ë…¸ì¶œí•˜ë©´ ëœë‹¤.</p>
  </li>
</ol>

<p>ê²½ë¡œ í˜¼ë™ ë°©ì§€ íŒ<br />
DEFAULT_CWD, READ_PATHS_DEFAULT, WRITE_PATHS_DEFAULTëŠ” ëª¨ë‘ ì ˆëŒ€ê²½ë¡œë¡œ ë‘ëŠ” ê²Œ ê°€ì¥ ê¹”ë”í•˜ë‹¤. LLMì— ë…¸ì¶œë˜ëŠ” cwd_relì€ DEFAULT_CWD ê¸°ì¤€ ìƒëŒ€ê²½ë¡œë§Œ ë°›ìœ¼ë©°, í—ˆìš© ë£¨íŠ¸ ë°–ì´ë©´ ê±°ë¶€í•œë‹¤.</p>]]></content><author><name>hvppyarchive</name></author><category term="llm" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">vLLMì— pdf ë„£ëŠ”ë²•</title><link href="https://hvppyarchive.github.io/llm/vllm-pdf/" rel="alternate" type="text/html" title="vLLMì— pdf ë„£ëŠ”ë²•" /><published>2025-11-04T14:13:34+09:00</published><updated>2025-11-04T14:13:34+09:00</updated><id>https://hvppyarchive.github.io/llm/vllm-pdf</id><content type="html" xml:base="https://hvppyarchive.github.io/llm/vllm-pdf/"><![CDATA[<p class="chat--user">

vllm ì„œë¹™í•˜ëŠ” ëª¨ë¸ gptossì— pdf ë„£ëŠ”ë²•

</p>

<p>ìš”ì•½ ë¨¼ì €: vLLMìœ¼ë¡œ ì„œë¹™ ì¤‘ì¸ gpt-ossëŠ” â€œPDF íŒŒì¼ì„ ì§ì ‘ ë„£ì–´ ì²˜ë¦¬â€í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. vLLM OpenAI í˜¸í™˜ ì„œë²„ëŠ” í…ìŠ¤íŠ¸/í† í° ìŠ¤íŠ¸ë¦¼ì„ ë°›ëŠ” APIì´ê³ , gpt-ossëŠ” ê³µê°œëœ ê°€ì´ë“œ ê¸°ì¤€ í…ìŠ¤íŠ¸ ì „ìš© ëª¨ë¸ì´ë¼ì„œ(ì´ë¯¸ì§€Â·PDF ì—…ë¡œë“œ íŒŒë¼ë¯¸í„° ì—†ìŒ) PDFëŠ” ì‚¬ì „ ì „ì²˜ë¦¬(í…ìŠ¤íŠ¸ ì¶”ì¶œâ†’ì²­ì†Œâ†’ì²­í¬â†’ê²€ìƒ‰/RAG)ë¡œ ë„£ì–´ì•¼ í•©ë‹ˆë‹¤. <a href="https://docs.vllm.ai/en/v0.6.0/serving/openai_compatible_server.html?utm_source=chatgpt.com">docs.vllm.ai+4</a></p>

<p>ì•„ë˜ëŠ” â€œPDFë¥¼ gpt-oss(vLLM ì„œë²„)ë¡œ ë„£ëŠ”â€ ê°€ì¥ í”í•œ êµ¬í˜„ ë ˆì‹œí”¼ì…ë‹ˆë‹¤. ë‹¨ê³„ë³„ë¡œ ê·¸ëŒ€ë¡œ ë”°ë¼í•˜ë©´ ë©ë‹ˆë‹¤.</p>

<ol>
  <li>vLLM ì„œë²„ë¡œ gpt-oss ë„ìš°ê¸°</li>
</ol>

<ul>
  <li>CUDA í™˜ê²½ì—ì„œ ì˜ˆì‹œ:</li>
</ul>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">pip</span> <span class="nt">install</span> <span class="nt">vllm</span>
<span class="nt">python</span> <span class="nt">-m</span> <span class="nt">vllm</span><span class="nc">.entrypoints.openai.api_server</span> <span class="err">\</span>
  <span class="nt">--model</span> <span class="nt">openai</span><span class="o">/</span><span class="nt">gpt-oss-20b</span> <span class="err">\</span>
  <span class="nt">--max-model-len</span> <span class="err">32768</span> <span class="err">\</span>
  <span class="nt">--port</span> <span class="err">8000</span>
</code></pre></div></div>

<p>ì„œë²„ëŠ” OpenAI í˜¸í™˜ Chat/Completions ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ íŒŒì¼ ì—…ë¡œë“œ í•„ë“œëŠ” ì—†ê³  ë¬¸ìì—´ í”„ë¡¬í”„íŠ¸ë§Œ ë°›ìŠµë‹ˆë‹¤. <a href="https://docs.vllm.ai/en/v0.6.0/serving/openai_compatible_server.html?utm_source=chatgpt.com">docs.vllm.ai</a></p>

<ol>
  <li>PDF â†’ í…ìŠ¤íŠ¸ ì¶”ì¶œ</li>
</ol>

<ul>
  <li>
    <p>Python ë„êµ¬ ì˜ˆ: pypdf, pdfminer.six, unstructured, docling ë“±.</p>
  </li>
  <li>
    <p>í‘œÂ·ë¨¸ë¦¬ê¸€Â·ê°ì£¼ê°€ ì„ì—¬ ìˆìœ¼ë©´ docling/Unstructured ê³„ì—´ì´ í’ˆì§ˆì´ ë” ë‚«ìŠµë‹ˆë‹¤. ì¶”ì¶œ í›„ ë‹¤ìŒì„ ê¼­ í•˜ì„¸ìš”.<br />
â€¢ í˜ì´ì§€ í—¤ë”/í‘¸í„° ì œê±°, ê³µë°± ì •ê·œí™”, ë³¸ë¬¸ ë³‘í•©<br />
â€¢ ë„ˆë¬´ ê¸´ í‘œëŠ” CSVë¡œ ë”°ë¡œ ì €ì¥(í•„ìš”ì‹œ)<br />
ê´€ë ¨ ì´ìŠˆì™€ íŒŒì´í”„ë¼ì¸ ì„ íƒì€ ì»¤ë®¤ë‹ˆí‹°/ë¼ì´ë¸ŒëŸ¬ë¦¬ ì´ìŠˆë¥¼ ì°¸ê³ í•˜ì„¸ìš”. <a href="https://github.com/docling-project/docling/issues/1365?utm_source=chatgpt.com">GitHub</a></p>
  </li>
</ul>

<ol>
  <li>ì²­í¬ ë‚˜ëˆ„ê¸°</li>
</ol>

<ul>
  <li>
    <p>800~1500ì(ë˜ëŠ” 200~400 í† í°) ë‹¨ìœ„ë¡œ ìë¥´ê³ , ë¬¸ë‹¨ ê²½ê³„ë¥¼ ìµœëŒ€í•œ ìœ ì§€í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ê° ì²­í¬ì— ì›ë¬¸ í˜ì´ì§€/ì„¹ì…˜ ë©”íƒ€ë°ì´í„°ë¥¼ ë¶™ì…ë‹ˆë‹¤.</p>
  </li>
</ul>

<ol>
  <li>ì„ë² ë”© ìƒì„± â†’ ë²¡í„°DB ì ì¬</li>
</ol>

<ul>
  <li>
    <p>ì„ë² ë”© ëª¨ë¸(ì˜ˆ: bge-m3, jina-embeddings, sentence-transformers ë“±)ë¡œ ê° ì²­í¬ë¥¼ ë²¡í„°í™”í•˜ê³ , FAISS/Chroma/PGVectorì— ë„£ìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì´ ë‹¨ê³„ëŠ” LLM(gpt-oss/vLLM)ê³¼ ë¶„ë¦¬ëœ ë³„ë„ ê³¼ì •ì…ë‹ˆë‹¤. vLLM ìì²´ëŠ” ì„ë² ë”©ì„ ë§Œë“¤ì§€ ì•ŠìŠµë‹ˆë‹¤. RAG íŒ¨í„´ ì˜ˆì‹œëŠ” ë‹¤ìˆ˜ì˜ vLLM ë°°í¬ ì˜ˆì œì—ì„œë„ ë™ì¼í•©ë‹ˆë‹¤. <a href="https://validatedpatterns.io/patterns/rag-llm-gitops/?utm_source=chatgpt.com">validatedpatterns.io+1</a></p>
  </li>
</ul>

<ol>
  <li>ì§ˆì˜ ì‹œ ê²€ìƒ‰(RAG) â†’ í”„ë¡¬í”„íŠ¸ êµ¬ì„± â†’ vLLMì— ì „ë‹¬</li>
</ol>

<ul>
  <li>
    <p>ìœ ì € ì§ˆë¬¸ì„ ë²¡í„° ê²€ìƒ‰ìœ¼ë¡œ top-k ì²­í¬ì™€ ë§¤ì¹­</p>
  </li>
  <li>
    <p>ì•„ë˜ System/Assistant ì»¨í…ìŠ¤íŠ¸ì— â€œê²€ìƒ‰ ê²°ê³¼â€ë¥¼ ë„£ê³ , gpt-ossì˜ ê¶Œì¥ í¬ë§·(í•˜ëª¨ë‹ˆ í¬ë§·)ì„ ì§€í‚¤ë©° ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤. gpt-ossëŠ” OpenAI í˜¸í™˜ ì„œë²„ì—ì„œ ì˜ ë™ì‘í•˜ë„ë¡ ê°€ì´ë“œê°€ ìˆìŠµë‹ˆë‹¤. <a href="https://cookbook.openai.com/articles/gpt-oss/run-vllm?utm_source=chatgpt.com">cookbook.openai.com+1</a></p>
  </li>
</ul>

<p>ì‹¤ì „ ì½”ë“œ ìŠ¤ë‹ˆí«</p>

<p>A. PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ/ì²­í¬(ê°„ë‹¨ ì˜ˆì‹œ)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pypdf</span> <span class="kn">import</span> <span class="n">PdfReader</span>

<span class="k">def</span> <span class="nf">extract_pdf_text</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="nc">PdfReader</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">pages</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">pages</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">extract_text</span><span class="p">()</span> <span class="ow">or</span> <span class="sh">""</span>
        <span class="n">pages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">page</span><span class="sh">"</span><span class="p">:</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">split</span><span class="p">())})</span>
    <span class="k">return</span> <span class="n">pages</span>

<span class="k">def</span> <span class="nf">chunk_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">max_chars</span><span class="o">=</span><span class="mi">1200</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="mi">150</span><span class="p">):</span>
    <span class="n">out</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="p">[],</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="n">start</span> <span class="o">+</span> <span class="n">max_chars</span><span class="p">)</span>
        <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">overlap</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="n">pages</span> <span class="o">=</span> <span class="nf">extract_pdf_text</span><span class="p">(</span><span class="sh">"</span><span class="s">sample.pdf</span><span class="sh">"</span><span class="p">)</span>
<span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nf">chunk_text</span><span class="p">(</span><span class="n">page</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">]):</span>
        <span class="n">chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">page</span><span class="sh">"</span><span class="p">:</span> <span class="n">page</span><span class="p">[</span><span class="sh">"</span><span class="s">page</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">})</span>
</code></pre></div></div>

<p>B. ì„ë² ë”©â†’FAISS ì ì¬(ì˜ˆì‹œ: sentence-transformers)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">sentence_transformers</span> <span class="kn">import</span> <span class="n">SentenceTransformer</span>
<span class="kn">import</span> <span class="n">faiss</span><span class="p">,</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="n">model</span> <span class="o">=</span> <span class="nc">SentenceTransformer</span><span class="p">(</span><span class="sh">"</span><span class="s">sentence-transformers/all-MiniLM-L6-v2</span><span class="sh">"</span><span class="p">)</span>
<span class="n">emb</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">encode</span><span class="p">([</span><span class="n">c</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">],</span> <span class="n">convert_to_numpy</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">normalize_embeddings</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">faiss</span><span class="p">.</span><span class="nc">IndexFlatIP</span><span class="p">(</span><span class="n">emb</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">index</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">emb</span><span class="p">)</span>
</code></pre></div></div>

<p>C. ê²€ìƒ‰â†’vLLM(gpt-oss) í˜¸ì¶œ(OpenAI í˜¸í™˜)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span><span class="p">,</span> <span class="n">requests</span><span class="p">,</span> <span class="n">json</span>

<span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">topk</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">encode</span><span class="p">([</span><span class="n">query</span><span class="p">],</span> <span class="n">convert_to_numpy</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">normalize_embeddings</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">scores</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">index</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">topk</span><span class="p">)</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">ctx</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[p.</span><span class="si">{</span><span class="n">chunks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="sh">'</span><span class="s">page</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">]</span><span class="se">\n</span><span class="si">{</span><span class="n">chunks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="sh">'</span><span class="s">content</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ask_vllm</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="n">context</span> <span class="o">=</span> <span class="nf">search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">topk</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">You are a helpful assistant. Use the provided CONTEXT; if missing, say you don</span><span class="sh">'</span><span class="s">t know.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sa">f</span><span class="sh">"</span><span class="s">CONTEXT:</span><span class="se">\n</span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="se">\n\n</span><span class="s">QUESTION:</span><span class="se">\n</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="sh">"</span><span class="p">}</span>
    <span class="p">]</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">http://localhost:8000/v1/chat/completions</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">Content-Type</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">},</span>
        <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">openai/gpt-oss-20b</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">:</span><span class="n">messages</span><span class="p">,</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">:</span><span class="mf">0.2</span><span class="p">})</span>
    <span class="p">).</span><span class="nf">json</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">resp</span><span class="p">[</span><span class="sh">"</span><span class="s">choices</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">]</span>

<span class="nf">print</span><span class="p">(</span><span class="nf">ask_vllm</span><span class="p">(</span><span class="sh">"</span><span class="s">ì´ PDFì—ì„œ ë°˜í’ˆ ì •ì±… í•µì‹¬ ìš”ì•½í•´ì¤˜</span><span class="sh">"</span><span class="p">))</span>
</code></pre></div></div>

<p>D. curlë¡œ ê°„ë‹¨ í…ŒìŠ¤íŠ¸</p>
<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">curl</span> <span class="nv">http</span><span class="p">:</span><span class="c1">//localhost:8000/v1/chat/completions \</span>
  <span class="o">-</span><span class="kt">H</span> <span class="s">"Content-Type: application/json"</span> <span class="p">\</span>
  <span class="o">-</span><span class="n">d</span> <span class="err">'</span><span class="p">{</span>
    <span class="s">"model"</span><span class="p">:</span> <span class="s">"openai/gpt-oss-20b"</span><span class="p">,</span>
    <span class="s">"messages"</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span><span class="s">"role"</span><span class="p">:</span><span class="s">"system"</span><span class="p">,</span><span class="s">"content"</span><span class="p">:</span><span class="s">"Answer using the context."</span><span class="p">},</span>
      <span class="p">{</span><span class="s">"role"</span><span class="p">:</span><span class="s">"user"</span><span class="p">,</span><span class="s">"content"</span><span class="p">:</span><span class="s">"CONTEXT:</span><span class="se">\n</span><span class="s">&lt;ì—¬ê¸°ì— ê²€ìƒ‰ìœ¼ë¡œ ëª¨ì€ PDF ì²­í¬&gt;</span><span class="se">\n\n</span><span class="s">QUESTION:</span><span class="se">\n</span><span class="s">ìš”ì•½í•´ì¤˜"</span><span class="p">}</span>
    <span class="p">],</span>
    <span class="s">"temperature"</span><span class="p">:</span> <span class="mf">0.2</span>
  <span class="p">}</span><span class="err">'</span>
</code></pre></div></div>

<p>ìì£¼ ë¬»ëŠ” í¬ì¸íŠ¸</p>

<ul>
  <li>
    <p>ì™œ PDF íŒŒì¼ ìì²´ë¥¼ ë°”ë¡œ ëª» ë„£ë‚˜?<br />
vLLMì˜ OpenAI í˜¸í™˜ ì„œë²„ëŠ” íŒŒì¼ ì—…ë¡œë“œ/ìŠ¤í† ë¦¬ì§€ ê¸°ëŠ¥ì´ ì•„ë‹ˆë¼ í…ìŠ¤íŠ¸ í”„ë¡¬í”„íŠ¸ APIì…ë‹ˆë‹¤. ì¦‰, íŒŒì¼ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆì´ì–´ì—ì„œ ì²˜ë¦¬í•´ì„œ í…ìŠ¤íŠ¸(ë˜ëŠ” ê²€ìƒ‰ëœ ì»¨í…ìŠ¤íŠ¸)ë¡œ ë°”ê¾¼ ë‹¤ìŒ ëª¨ë¸ì— ë„£ì–´ì•¼ í•©ë‹ˆë‹¤. <a href="https://docs.vllm.ai/en/v0.6.0/serving/openai_compatible_server.html?utm_source=chatgpt.com">docs.vllm.ai</a></p>
  </li>
  <li>
    <p>gpt-ossê°€ PDFë‚˜ ì´ë¯¸ì§€ê¹Œì§€ ì§ì ‘ ì½ëŠ” ë©€í‹°ëª¨ë‹¬ì¸ê°€?<br />
ê³µê°œ ê°€ì´ë“œ ê¸°ì¤€ gpt-ossëŠ” í…ìŠ¤íŠ¸ ì¤‘ì‹¬ì˜ ì˜¤í”ˆ ì›¨ì´íŠ¸ íŒ¨ë°€ë¦¬ë¡œ ì†Œê°œë˜ì—ˆìŠµë‹ˆë‹¤. ë©€í‹°ëª¨ë‹¬ ì…ë ¥ì„ ì§ì ‘ ë°›ëŠ” í˜•íƒœê°€ ì•„ë‹ˆë¼, í…ìŠ¤íŠ¸ë¡œ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì£¼ëŠ” ë°©ì‹ì´ í‘œì¤€ì…ë‹ˆë‹¤. <a href="https://openai.com/index/introducing-gpt-oss/?utm_source=chatgpt.com">OpenAI+2</a></p>
  </li>
  <li>
    <p>â€œPDF ì§ˆì˜ì‘ë‹µâ€ ì •ë°€ë„ë¥¼ ë” ë†’ì´ë ¤ë©´?<br />
ì²­í¬ í¬ê¸°/ì˜¤ë²„ë© ìµœì í™”, í‘œ/ì½”ë“œ ë¸”ë¡ ë³´ì¡´, ì„¹ì…˜ë³„ ì¬ìˆœìœ„í™”(re-ranking), â€œì¶œì²˜ í˜ì´ì§€ í‘œì‹œâ€ë¥¼ í”„ë¡¬í”„íŠ¸ì— ê°•ì œ, ê·¸ë¦¬ê³  ë‹µë³€ ê·¼ê±°ë¥¼ ë”°ë¡œ ì¶œë ¥í•˜ë„ë¡ ê·œì¹™ì„ ë„£ìœ¼ë©´ í’ˆì§ˆì´ ì•ˆì •ë©ë‹ˆë‹¤. vLLM ë ˆì‹œí”¼/ì¿ í¬ë¶ì˜ gpt-oss ìš´ì˜ ê°€ì´ë“œë„ í•¨ê»˜ ë³´ì„¸ìš”. <a href="https://docs.vllm.ai/projects/recipes/en/latest/OpenAI/GPT-OSS.html?utm_source=chatgpt.com">docs.vllm.ai+1</a></p>
  </li>
</ul>

<p>í•œ ì¤„ ì •ë¦¬: vLLM+gpt-ossë¡œ PDFë¥¼ â€œë„£ëŠ”â€ ê²ƒì€ PDFë¥¼ í…ìŠ¤íŠ¸ë¡œ ì „ì²˜ë¦¬í•˜ê³ , ê²€ìƒ‰ ê¸°ë°˜(RAG)ìœ¼ë¡œ ê´€ë ¨ ì²­í¬ë¥¼ ì¶”ë ¤ OpenAI í˜¸í™˜ APIì— ë¬¸ìì—´ë¡œ ë³´ë‚´ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ íë¦„ì„ ì½”ë“œì™€ ê°™ì´ êµ¬ì„±í•˜ë©´ ë°”ë¡œ ìš´ì˜ì— ì˜¬ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p class="chat--user">

openai agent ë¼ëŠ” íŒ¨í‚¤ì§€ê°€ ìˆëŠ”ë° ì—¬ê¸°ì— ê·¸ëŸ° ë ˆì´ì–´ê°€ í¬í•¨ë˜ì–´ìˆë‚˜?

</p>

<p>ì§§ì€ ê²°ë¡ ë¶€í„° ë§í•˜ë©´, â€œopenai agentâ€ë¡œ ì•Œë ¤ì§„ OpenAI Agents SDKëŠ” ì—ì´ì „íŠ¸ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜(íˆ´ í˜¸ì¶œ, ì„¸ì…˜/ë©”ëª¨ë¦¬, í•¸ë“œì˜¤í”„, ê°€ë“œë ˆì¼ ë“±)ì„ ì œê³µí•˜ì§€ë§Œ PDF íŒŒì‹±Â·ì²­í¬Â·ì„ë² ë”©Â·ë²¡í„°ìŠ¤í† ì–´ ì ì¬ ê°™ì€ â€œë¬¸ì„œ RAG ì¸ì… ë ˆì´ì–´â€ëŠ” ê¸°ë³¸ ë‚´ì¥ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ë§Œ OpenAI ëª¨ë¸ì„ ì“¸ ë•ŒëŠ” í˜¸ìŠ¤í‹°ë“œ ë„êµ¬(FileSearchTool ë“±)ë¥¼ í†µí•´ OpenAI Vector Storesì— ì˜¬ë ¤ë‘” ë¬¸ì„œë¥¼ ê²€ìƒ‰í•˜ëŠ” ë°©ì‹ì€ ì§€ì›í•©ë‹ˆë‹¤. ìì²´ vLLM+gpt-ossë¡œ ëŒë¦´ ë•ŒëŠ” ê·¸ ë ˆì´ì–´ë¥¼ ì§ì ‘ ë¶™ì—¬ì•¼ í•©ë‹ˆë‹¤. <a href="https://openai.github.io/openai-agents-python/">openai.github.io+1</a></p>

<p>í•µì‹¬ í¬ì¸íŠ¸ë¥¼ ì •ë¦¬í•˜ë©´ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.</p>

<ol>
  <li>
    <p>SDKê°€ í•´ì£¼ëŠ” ì¼<br />
ì—ì´ì „íŠ¸ ë£¨í”„, í•¨ìˆ˜íˆ´(FunctionTool), ì„¸ì…˜/íŠ¸ë ˆì´ì‹±, í•¸ë“œì˜¤í”„, MCP(Model Context Protocol) ì—°ê²° ë“± â€œì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜â€ì´ ì£¼ì—­í• ì…ë‹ˆë‹¤. PDFë¥¼ ì½ì–´ í…ìŠ¤íŠ¸ë¡œ ë§Œë“¤ê³  ì„ë² ë”©ì„ ë½‘ì•„ ë²¡í„°DBì— ì ì¬í•˜ëŠ” íŒŒì´í”„ë¼ì¸ì€ ì•± ìª½ì—ì„œ êµ¬ì„±í•´ì•¼ í•©ë‹ˆë‹¤. <a href="https://openai.github.io/openai-agents-python/">openai.github.io+1</a></p>
  </li>
  <li>
    <p>OpenAI í˜¸ìŠ¤í‹°ë“œ ë„êµ¬ê°€ ìˆì„ ë•Œ<br />
OpenAI Responses ëª¨ë¸ì„ ì“°ë©´ FileSearchTool, WebSearchTool, Code Interpreter ê°™ì€ â€œí˜¸ìŠ¤í‹°ë“œ íˆ´â€ì„ ë°”ë¡œ ë¶™ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ê²½ìš° PDFëŠ” OpenAI Vector Stores APIë¡œ ì—…ë¡œë“œÂ·ì²˜ë¦¬í•˜ê³ , ì—ì´ì „íŠ¸ëŠ” FileSearchToolë¡œ ê²€ìƒ‰í•©ë‹ˆë‹¤. SDK ìì²´ê°€ PDFë¥¼ íŒŒì‹±í•´ì£¼ì§„ ì•Šê³ , ë²¡í„°ìŠ¤í† ì–´ë„ OpenAI ìª½ ë¦¬ì†ŒìŠ¤ë¥¼ ì´ìš©í•˜ëŠ” êµ¬ì„±ì…ë‹ˆë‹¤. <a href="https://openai.github.io/openai-agents-python/tools/">openai.github.io</a></p>
  </li>
  <li>
    <p>gpt-oss(+vLLM)ì™€ í•¨ê»˜ ì“°ëŠ” ê²½ìš°<br />
vLLMì˜ OpenAI-í˜¸í™˜ ì—”ë“œí¬ì¸íŠ¸ë¡œ ì—ì´ì „íŠ¸ì˜ ëª¨ë¸ í´ë¼ì´ì–¸íŠ¸ë¥¼ ë°”ê¿”ì¹˜ê¸° í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ë§Œ ì´ë•ŒëŠ” OpenAI í˜¸ìŠ¤í‹°ë“œ ë„êµ¬(FileSearchTool ë“±)ê°€ ê·¸ëŒ€ë¡œ ë™ì‘í•˜ì§€ ì•Šê±°ë‚˜ ì „ì œê°€ ë°”ë€Œë¯€ë¡œ, ì§ì ‘ í•¨ìˆ˜íˆ´ë¡œ â€œê²€ìƒ‰/RAGâ€ë¥¼ êµ¬í˜„í•˜ê±°ë‚˜ MCP ì„œë²„(ìì²´ ë¬¸ì„œ ê²€ìƒ‰ ì„œë²„)ë¥¼ ë¶™ì—¬ì„œ ë¬¸ì„œ ê²€ìƒ‰ì„ ë…¸ì¶œí•˜ëŠ” íŒ¨í„´ì´ ì¼ë°˜ì ì…ë‹ˆë‹¤. <a href="https://cookbook.openai.com/articles/gpt-oss/run-vllm?utm_source=chatgpt.com">cookbook.openai.com+2</a></p>
  </li>
  <li>
    <p>ìµœì†Œ êµ¬í˜„ ìŠ¤ì¼€ì¹˜</p>
  </li>
</ol>

<ul>
  <li>
    <p>PDF ì¸ì…: pypdf/unstructuredë¡œ í…ìŠ¤íŠ¸ ì¶”ì¶œ â†’ ì²­í¬ â†’ ì„ë² ë”©(bge/jina/sentence-transformers) â†’ FAISS/Chroma ì ì¬</p>
  </li>
  <li>
    <p>ì—ì´ì „íŠ¸ íˆ´: search(query) ê°™ì€ Python í•¨ìˆ˜íˆ´ì„ ì •ì˜í•´ top-k ì²­í¬ë¥¼ ë°˜í™˜í•˜ë„ë¡ êµ¬í˜„</p>
  </li>
  <li>
    <p>ì—ì´ì „íŠ¸: Agent(tools=[search])ë¡œ ë“±ë¡, ëª¨ë¸ì€ vLLMì˜ Chat Completions/Responses í˜¸í™˜ ì—”ë“œí¬ì¸íŠ¸ë¡œ ì§€ì •</p>
  </li>
  <li>
    <p>OpenAI ëª¨ë¸ë¡œ ë°”ê¿€ ë•Œë§Œ FileSearchToolì„ ì‚¬ìš©í•´ OpenAI Vector Storeë¥¼ ì¡°íšŒ ê°€ëŠ¥<br />
ì´ êµ¬ì„±ì€ SDK ë¬¸ì„œì˜ â€œToolsâ€, â€œContext managementâ€, â€œMCPâ€ ì„¹ì…˜ íë¦„ê³¼ ë”± ë§ìŠµë‹ˆë‹¤. <a href="https://openai.github.io/openai-agents-python/tools/">openai.github.io+2</a></p>
  </li>
</ul>

<ol>
  <li>ì´ë¦„ í˜¼ë™ ì£¼ì˜<br />
Assistants APIëŠ” Responses APIë¡œ ëŒ€ì²´ë˜ëŠ” íë¦„ì´ë©°, Agents SDKëŠ” ì´ Responses ê¸°ë°˜ì—ì„œ ëŒì•„ê°‘ë‹ˆë‹¤. ìµœì‹  ê°€ì´ë“œì™€ ë ˆí¼ëŸ°ìŠ¤ë¥¼ ì°¸ê³ í•´ì„œ êµ¬ì„±í•˜ì„¸ìš”. <a href="https://www.reuters.com/technology/artificial-intelligence/openai-launches-new-developer-tools-chinese-ai-startups-gain-ground-2025-03-11/?utm_source=chatgpt.com">reuters.com+1</a></li>
</ol>

<p>ì •ë¦¬</p>

<ul>
  <li>í¬í•¨ë˜ì–´ ìˆëŠ”ê°€? ì—ì´ì „íŠ¸ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ì€ í¬í•¨, â€œPDFâ†’RAG ì¸ì… ë ˆì´ì–´â€ëŠ” ë¯¸í¬í•¨. OpenAI ëª¨ë¸ì¼ ë•Œë§Œ FileSearchToolë¡œ OpenAI Vector Storesë¥¼ ì¡°íšŒí•  ìˆ˜ ìˆìŒ. vLLM+gpt-ossì—ì„œëŠ” ì§ì ‘ í•¨ìˆ˜íˆ´ì´ë‚˜ MCPë¡œ ë¶™ì—¬ì•¼ í•©ë‹ˆë‹¤. <a href="https://openai.github.io/openai-agents-python/tools/">openai.github.io+1</a></li>
</ul>

<p>ì›í•˜ì‹œë©´ ì§€ê¸ˆ ì“°ì‹œëŠ” vLLM ì„œë²„ ì£¼ì†Œì™€ ì„ í˜¸ ì„ë² ë”©/ë²¡í„°DBë¥¼ ê°€ì •í•´, Agents SDKìš© ìµœì†Œ ì˜ˆì œ(í•¨ìˆ˜íˆ´ ê¸°ë°˜ ê²€ìƒ‰ + vLLM ì—°ê²°) ìŠ¤ë‹ˆí«ì„ ë°”ë¡œ ë§Œë“¤ì–´ ë“œë¦½ë‹ˆë‹¤.</p>

<p class="chat--user">

openai vector storeëŠ” ì–´ë–¤ì‹ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ìˆì–´?

</p>

<p>ì¢‹ì•„ìš” â€” â€œOpenAI Vector Storeâ€ê°€ ëŒ€ì²´ë¡œ ì–´ë–»ê²Œ êµ¬ì„±ë˜ì–´ ìˆëŠ”ì§€(=ì•„í‚¤í…ì²˜, ì£¼ìš” ì»´í¬ë„ŒíŠ¸, API íë¦„) ê°™ì´ ì‚´í´ë´…ì‹œë‹¤. (ì•½ê°„ ê¸°ìˆ ì ì´ê¸´ í•˜ì§€ë§Œ, ì „ì²´ ê·¸ë¦¼ì„ ì´í•´í•˜ë©´ ì´í›„ êµ¬í˜„í•  ë•Œ í›¨ì”¬ ìˆ˜ì›”í•´ìš”.)</p>

<hr />

<h2 id="1-ê¸°ë³¸-ê°œë…">1. ê¸°ë³¸ ê°œë…</h2>

<p>Vector StoreëŠ” ê°„ë‹¨íˆ ë§í•´ â€œë¬¸ì„œ/ì²­í¬(í…ìŠ¤íŠ¸ ë‹¨ìœ„)ë¥¼ ì„ë² ë”© ë²¡í„°ë¡œ ë³€í™˜í•´ ì €ì¥í•˜ê³ , ì´í›„ ê²€ìƒ‰ ê°€ëŠ¥í•˜ë„ë¡ ì¡°íšŒí•˜ëŠ” ì €ì¥ì†Œâ€ì…ë‹ˆë‹¤. OpenAI ìª½ì—ì„œ ì œê³µí•˜ëŠ” APIëŠ” ë¬¸ì„œë¥¼ ì—…ë¡œë“œ â†’ ì„ë² ë”©/ì²­í¬í™”(ë‚´ë¶€ ì²˜ë¦¬) â†’ ë²¡í„°ì €ì¥ì†Œ ìƒì„± ë° íŒŒì¼ ë°”ì¸ë”© â†’ ê²€ìƒ‰ ì§ˆì˜(Query) â†’ ê´€ë ¨ ì²­í¬ ë°˜í™˜í•˜ëŠ” íë¦„ì„ ì§€ì›í•©ë‹ˆë‹¤. <a href="https://platform.openai.com/docs/assistants/tools/file-search/vector-stores?utm_source=chatgpt.com">platform.openai.com+3</a></p>

<p>ì¦‰, ë‚´ë¶€ì ìœ¼ë¡œëŠ” ë‹¤ìŒ ìš”ì†Œë“¤ì´ ìˆìŠµë‹ˆë‹¤:</p>

<ul>
  <li>
    <p>ë¬¸ì„œ íŒŒì¼(ì˜ˆ: PDF, í…ìŠ¤íŠ¸) ì—…ë¡œë“œ ë° ì²˜ë¦¬ëœ íŒŒì¼ ë°°ì¹˜(file batch)</p>
  </li>
  <li>
    <p>ë²¡í„° ë³€í™˜(ì„ë² ë”©) + ì²­í¬(metadata í¬í•¨)</p>
  </li>
  <li>
    <p>ì €ì¥ì†Œ(Vector store) ê°ì²´: ì—¬ëŸ¬ íŒŒì¼/ì²­í¬ë“¤ì„ ë¬¶ìŒ</p>
  </li>
  <li>
    <p>ê²€ìƒ‰ API: ë²¡í„° ìœ ì‚¬ë„ ê¸°ë°˜ ì¡°íšŒ â†’ ë°˜í™˜ëœ ì²­í¬ì™€ ë©”íƒ€ì •ë³´</p>
  </li>
</ul>

<hr />

<h2 id="2-openai-api-ìƒì˜-êµ¬ì„±-ìš”ì†Œ">2. OpenAI API ìƒì˜ êµ¬ì„± ìš”ì†Œ</h2>

<p>OpenAI ë¬¸ì„œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì£¼ìš” ë¦¬ì†ŒìŠ¤(resource)ë“¤ì´ ì–´ë–»ê²Œ ì—°ê²°ë˜ëŠ”ì§€ìš”:</p>

<ul>
  <li>
    <p><strong>Vector Store ë¦¬ì†ŒìŠ¤</strong> : <code class="language-plaintext highlighter-rouge">/v1/vector_stores</code> ì—”ë“œí¬ì¸íŠ¸ë¡œ ë§Œë“¤ ìˆ˜ ìˆìŒ. <a href="https://platform.openai.com/docs/api-reference/vector-stores?utm_source=chatgpt.com">platform.openai.com+1</a></p>
  </li>
  <li>
    <p><strong>íŒŒì¼ ë°°ì¹˜(File Batches)</strong> : ì—…ë¡œë“œëœ íŒŒì¼ì´ ì²­í¬/ë²¡í„°í™”ë˜ì–´ ì €ì¥ë˜ëŠ” ë‹¨ìœ„. <code class="language-plaintext highlighter-rouge">/v1/vector_stores/{vector_store_id}/file_batches</code> ê°™ì€ êµ¬ì¡° ìˆìŒ. <a href="https://platform.openai.com/docs/api-reference/vector-stores-file-batches?utm_source=chatgpt.com">platform.openai.com</a></p>
  </li>
  <li>
    <p><strong>íŒŒì¼(íŒŒì¼ ì—…ë¡œë“œ)</strong> : <code class="language-plaintext highlighter-rouge">/v1/vector_stores/{vs_id}/files</code> ì—”ë“œí¬ì¸íŠ¸ì—ì„œ íŒŒì¼ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŒ. <a href="https://platform.openai.com/docs/api-reference/vector-stores-files?utm_source=chatgpt.com">platform.openai.com</a></p>
  </li>
  <li>
    <p><strong>ê²€ìƒ‰(Search)</strong> : ì €ì¥ëœ Vector Storeì— ëŒ€í•´ â€œìœ ì‚¬ë²¡í„° ê¸°ë°˜ ê²€ìƒ‰â€ì„ ìš”ì²­ ê°€ëŠ¥ (ì˜ˆ: íŒŒì¼ ê²€ìƒ‰, ì²­í¬ ê²€ìƒ‰) <a href="https://platform.openai.com/docs/assistants/tools/file-search/vector-stores?utm_source=chatgpt.com">platform.openai.com+1</a></p>
  </li>
</ul>

<hr />

<h2 id="3-íë¦„-ì˜ˆì‹œë¡œ-ë³´ê¸°">3. íë¦„ ì˜ˆì‹œë¡œ ë³´ê¸°</h2>

<p>ì•„ë˜ì²˜ëŸ¼ ë‹¨ê³„ë³„ êµ¬ì„±ë©ë‹ˆë‹¤:</p>

<ol>
  <li>
    <p>íŒŒì¼ ì—…ë¡œë“œ</p>

    <ul>
      <li>ì˜ˆ: PDFë¥¼ ì—…ë¡œë“œ â†’ OpenAI ì¸¡ì—ì„œ ìë™ìœ¼ë¡œ ì²­í¬í™”/ì„ë² ë”©/ì €ì¥ ì¤€ë¹„ â†’ íŒŒì¼ ë°°ì¹˜ ìƒì„±</li>
    </ul>
  </li>
  <li>
    <p>Vector Store ìƒì„±</p>

    <ul>
      <li>ì €ì¥ì†Œ ì´ë¦„, ì„¤ëª… ë“±ì˜ ë©”íƒ€ë°ì´í„° ì œê³µ â†’ ìƒì„±</li>
    </ul>
  </li>
  <li>
    <p>íŒŒì¼ì„ Vector Storeì— ë°”ì¸ë”©(=íŒŒì¼ ì¶”ê°€)</p>

    <ul>
      <li>ìƒì„±í•œ Vector Store IDì— íŒŒì¼ ë°°ì¹˜/íŒŒì¼ì„ ì—…ë¡œë“œí•˜ëŠ” API í˜¸ì¶œ</li>
    </ul>
  </li>
  <li>
    <p>ê²€ìƒ‰ ìš”ì²­</p>

    <ul>
      <li>
        <p>ì‚¬ìš©ìê°€ ì§ˆì˜(query)ë¥¼ ë³´ë‚´ë©´, APIëŠ” ì„ë² ë”© ìƒì„± â†’ ì €ì¥ëœ ë²¡í„°ë“¤ê³¼ ìœ ì‚¬ë„ ë¹„êµ â†’ ê´€ë ¨ ì²­í¬ ë°˜í™˜</p>
      </li>
      <li>
        <p>ë°˜í™˜ëœ ì²­í¬ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‘ë‹µ ìƒì„±(LLM í˜¸ì¶œ ì „ì²˜ë¦¬ ì—­í• )</p>
      </li>
    </ul>
  </li>
  <li>
    <p>LLM í˜¸ì¶œ(ë³„ë„)</p>

    <ul>
      <li>ê²€ìƒ‰ëœ ì²­í¬ëŠ” LLM(ì˜ˆ: gpt-ëª¨ë¸)ì— ì»¨í…ìŠ¤íŠ¸ë¡œ ì „ë‹¬ â†’ ë‹µë³€ ìƒì„±</li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="4-ì£¼ìš”-íŠ¹ì„±-ë°-í•œê³„">4. ì£¼ìš” íŠ¹ì„± ë° í•œê³„</h2>

<ul>
  <li>
    <p>íŒŒì¼/ë¬¸ì„œ ë©”íƒ€ë°ì´í„°ëŠ” ë¹„êµì  ì œí•œì : ì—…ë¡œë“œëœ íŒŒì¼ì´ ì–¼ë§ˆë‚˜ ê¸´ì§€(token count, char count) ë“±ì˜ ì •ë³´ ë¶€ì¡±í•˜ë‹¤ëŠ” ì‚¬ìš©ìì˜ í”¼ë“œë°±ì´ ìˆìŒ. <a href="https://www.reddit.com/r/OpenAI/comments/1lacgqe/openais_vector_store_api_is_missing_basic/?utm_source=chatgpt.com">Reddit</a></p>
  </li>
  <li>
    <p>ì²­í¬í™” + ì„ë² ë”© + ì €ì¥/ê´€ë¦¬ ê³¼ì •ì„ â€œì‚¬ìš©ìì œì–´â€ í•˜ë ¤ë©´ OpenAI í˜¸ìŠ¤í‹°ë“œ ê¸°ëŠ¥ë³´ë‹¤ëŠ” ìì²´ ë²¡í„°DB + ì„ë² ë”© ì›Œí¬í”Œë¡œìš°ê°€ ë” ìœ ì—°í•¨</p>
  </li>
  <li>
    <p>ê²€ìƒ‰ í’ˆì§ˆì€ ì„ë² ë”© ëª¨ë¸(ì–´ë–¤ ëª¨ë¸ì„ ì¼ëŠ”ê°€) + ì²­í¬ ë‹¨ìœ„/ë¬¸ì„œ êµ¬ì¡° ì„¤ê³„ì— í¬ê²Œ ì¢Œìš°ë¨</p>
  </li>
</ul>

<hr />

<h2 id="5-gpt-ossvllm-í™œìš©-ì‹œ-ê³ ë ¤ì‚¬í•­">5. gpt-oss/vLLM í™œìš© ì‹œ ê³ ë ¤ì‚¬í•­</h2>

<p>ë‹¹ì‹ ì´ vLLM + gpt-oss ì¡°í•©ìœ¼ë¡œ ì“°ëŠ” ìƒí™©ì´ë¼ë©´, OpenAI Vector Store APIë¥¼ ê·¸ëŒ€ë¡œ ì˜ì¡´í•˜ê¸°ë³´ë‹¤ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë³€í˜•ì´ í•„ìš”í•  ìˆ˜ ìˆì–´ìš”:</p>

<ul>
  <li>
    <p>OpenAI Vector Store APIë¥¼ ì“°ê³  ì‹¶ìœ¼ë©´ OpenAI ì¸ì¦/ìš”ê¸ˆ/í˜¸ìŠ¤íŒ… êµ¬ì¡° ë”°ë¼ì•¼ í•¨</p>
  </li>
  <li>
    <p>ë˜ëŠ” ìì²´ ë²¡í„°DB(ì˜ˆ: FAISS, Milvus ë“±) + ì„ë² ë”© ëª¨ë¸ + ê²€ìƒ‰ í•¨ìˆ˜íˆ´ì„ ë§Œë“¤ì–´ì„œ â€œìœ ì‚¬ ê¸°ëŠ¥â€ì„ êµ¬í˜„</p>
  </li>
  <li>
    <p>Agents SDKë‚˜ ì›Œí¬í”Œë¡œìš°ì—ì„œëŠ” â€œê²€ìƒ‰ íˆ´(tool)â€ì´ ì´ ì €ì¥ì†Œì™€ ì—°ê²°ë¨: ì‚¬ìš©ìê°€ ì§ˆì˜í•˜ë©´ ê²€ìƒ‰íˆ´ì´ ê´€ë ¨ ì²­í¬ë¥¼ êº¼ë‚´ì˜¤ê³ , LLMì—ê²Œ ë¬¸ë§¥ìœ¼ë¡œ ì œê³µ</p>
  </li>
</ul>

<hr />

<p>í•„ìš”í•˜ì‹œë‹¤ë©´, OpenAI Vector Store APIë¥¼ ì‹¤ì œë¡œ í˜¸ì¶œí•˜ëŠ” ì˜ˆì œ ì½”ë“œ(Python) ë§Œë“¤ì–´ ë“œë¦´ ìˆ˜ ìˆì–´ìš”â€”íŠ¹íˆ íŒŒì¼ ì—…ë¡œë“œ â†’ ê²€ìƒ‰ê¹Œì§€ íë¦„. ê·¸ë ‡ê²Œ í• ê¹Œìš”?</p>

<p class="chat--user">

ë§ˆì§€ë§‰ì— ë§í•œ ê²€ìƒ‰íˆ´ì€ ìë™ìœ¼ë¡œ ë™ì‘í•˜ëŠ”ê±´ì§€ llmì´ ìš”ì²­í•˜ë©´ ë™ì‘í•˜ëŠ”ê±´ì§€ ê¶ê¸ˆí•´

</p>

<p>ì•„ì£¼ í•µì‹¬ì„ ì§šìœ¼ì…¨ìŠµë‹ˆë‹¤.<br />
OpenAIì˜ â€œê²€ìƒ‰ íˆ´(FileSearchTool)â€ì€ <strong>ìë™ìœ¼ë¡œ ë™ì‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤</strong>.<br />
LLMì´ â€œí•„ìš”í•˜ë‹¤ê³  íŒë‹¨í•  ë•Œâ€ â€” ì¦‰, <strong>ëª¨ë¸ì´ íˆ´ í˜¸ì¶œì„ ìƒì„±í•˜ë©´</strong> â€” ê·¸ë•Œ ì‹¤í–‰ë©ë‹ˆë‹¤.</p>

<p>ì´ê±¸ ì¡°ê¸ˆ ë” ì„¸ë°€í•˜ê²Œ ëœ¯ì–´ë³´ë©´ ì´ë ‡ê²Œ ë©ë‹ˆë‹¤.</p>

<hr />

<h3 id="1-ì—ì´ì „íŠ¸ì˜-ê¸°ë³¸-êµ¬ì¡°">1. ì—ì´ì „íŠ¸ì˜ ê¸°ë³¸ êµ¬ì¡°</h3>

<p>OpenAI Agents SDK(í˜¹ì€ Responses API)ì—ì„œ ì—ì´ì „íŠ¸ëŠ” ë‹¤ìŒ ë‘ ê°€ì§€ë¥¼ ê°–ìŠµë‹ˆë‹¤.</p>

<ul>
  <li>
    <p><strong>LLM ëª¨ë¸</strong> : gpt-4o, gpt-4o-mini ë“±</p>
  </li>
  <li>
    <p><strong>íˆ´(tool)</strong> : í•¨ìˆ˜ í˜¸ì¶œ(Function Tool), FileSearchTool, WebSearchTool, CodeInterpreter ë“±</p>
  </li>
</ul>

<p>ì—ì´ì „íŠ¸ëŠ” LLMì—ê²Œ â€œë„ˆëŠ” ì´ëŸ° íˆ´ë“¤ì„ ì“¸ ìˆ˜ ìˆë‹¤â€ê³  ì•Œë ¤ì£¼ê³ ,<br />
ëŒ€í™” ì¤‘ì— LLMì´ íŒë‹¨í•´ íŠ¹ì • íˆ´ì„ í˜¸ì¶œí•  ë•Œë§Œ ì‹¤ì œ ì‹¤í–‰ ë¡œì§ì´ ìˆ˜í–‰ë©ë‹ˆë‹¤.</p>

<hr />

<h3 id="2-íˆ´-í˜¸ì¶œ-ê³¼ì •">2. íˆ´ í˜¸ì¶œ ê³¼ì •</h3>

<p>ëª¨ë¸ì´ ë‚´ë¶€ì ìœ¼ë¡œ ì´ëŸ° êµ¬ì¡°ì˜ ì‘ë‹µì„ ëƒ…ë‹ˆë‹¤.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"function_call"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"search"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"arguments"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ê³„ì•½ì„œ ìš”ì•½"</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>SDKëŠ” ì´ê±¸ ê°ì§€í•˜ê³  <strong>search() í•¨ìˆ˜</strong> (í˜¹ì€ FileSearchTool)ì„ í˜¸ì¶œí•©ë‹ˆë‹¤.<br />
ê·¸ ê²°ê³¼ë¥¼ ë°›ì•„ ëª¨ë¸ì—ê²Œ ë‹¤ì‹œ ì „ë‹¬í•˜ë©´, ëª¨ë¸ì€ ê·¸ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ <strong>ìµœì¢… ë‹µë³€</strong> ì„ ë§Œë“­ë‹ˆë‹¤.</p>

<p>ì¦‰, LLMì´ íˆ´ ì‚¬ìš©ì„ â€œê²°ì •â€í•˜ê³ , í˜¸ì¶œì€ SDKê°€ â€œëŒ€ë¦¬ ì‹¤í–‰â€í•©ë‹ˆë‹¤.</p>

<hr />

<h3 id="3-ìë™ì„±ê³¼-ììœ¨ì„±ì˜-ì •ë„">3. ìë™ì„±ê³¼ ììœ¨ì„±ì˜ ì •ë„</h3>

<ul>
  <li>
    <p><strong>ìë™ ì‹¤í–‰ ì•„ë‹˜</strong> : ì‚¬ìš©ìê°€ â€œê²€ìƒ‰ì„ ê¼­ í•˜ë¼â€ê³  ì§€ì •í•˜ì§€ ì•Šìœ¼ë©´, ëª¨ë¸ì´ ë¬¸ë§¥ìƒ í•„ìš”í•˜ë‹¤ê³  íŒë‹¨í•´ì•¼ í˜¸ì¶œí•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>í”„ë¡¬í”„íŠ¸ ì„¤ê³„ ê°€ëŠ¥</strong> : system prompt ì— â€œíŒŒì¼ ë‚´ìš©ì„ ì°¸ì¡°í•  ë•ŒëŠ” í•­ìƒ FileSearchToolì„ ì‚¬ìš©í•˜ë¼â€ì²˜ëŸ¼ ëª…ì‹œí•´ ì£¼ë©´ í˜¸ì¶œ í™•ë¥ ì´ ë†’ì•„ì§‘ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p><strong>Agent Loop</strong> : SDKê°€ ì´ ê³¼ì •ì„ ìë™ ë°˜ë³µí•´ì¤ë‹ˆë‹¤. ëª¨ë¸ì´ íˆ´ í˜¸ì¶œ â†’ ì‹¤í–‰ â†’ ê²°ê³¼ ì „ë‹¬ â†’ ë‹¤ì‹œ ëª¨ë¸ í˜¸ì¶œ â€¦ ìµœì¢… ë‹µë³€ì´ ì™„ì„±ë  ë•Œê¹Œì§€ ë£¨í”„ë¥¼ ë•ìŠµë‹ˆë‹¤.</p>
  </li>
</ul>

<hr />

<h3 id="4-ì˜ˆì‹œë¡œ-ë³´ëŠ”-íë¦„">4. ì˜ˆì‹œë¡œ ë³´ëŠ” íë¦„</h3>

<p>ì‚¬ìš©ì: â€œì´ ê³„ì•½ì„œ ìš”ì•½í•´ì¤˜.â€</p>

<ol>
  <li>
    <p>ëª¨ë¸ì€ FileSearchToolì´ ë“±ë¡ë˜ì–´ ìˆìŒì„ ì•Œê³  ìˆìŒ.</p>
  </li>
  <li>
    <p>LLMì´ ë‚´ë¶€ì ìœ¼ë¡œ íŒë‹¨: â€œíŒŒì¼ì—ì„œ ë‚´ìš© ê°€ì ¸ì™€ì•¼ í•˜ë„¤.â€</p>
  </li>
  <li>
    <p>LLM â†’ <code class="language-plaintext highlighter-rouge">function_call: file_search(query="ê³„ì•½ì„œ ìš”ì•½")</code></p>
  </li>
  <li>
    <p>SDK â†’ ì‹¤ì œ Vector Store ê²€ìƒ‰ ìˆ˜í–‰</p>
  </li>
  <li>
    <p>ê²€ìƒ‰ ê²°ê³¼ë¥¼ ëª¨ë¸ì—ê²Œ ë‹¤ì‹œ ì…ë ¥</p>
  </li>
  <li>
    <p>ëª¨ë¸ â†’ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ìš”ì•½í•œ ìµœì¢… ë‹µë³€ ìƒì„±</p>
  </li>
</ol>

<hr />

<h3 id="5-vllm--gpt-oss-ì¡°í•©ì—ì„œëŠ”">5. vLLM + gpt-oss ì¡°í•©ì—ì„œëŠ”</h3>

<p>vLLMì€ OpenAIì˜ Responses API ë‚´ë¶€ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ê¸°ëŠ¥ì´ ì—†ìŠµë‹ˆë‹¤.<br />
ë”°ë¼ì„œ â€œìë™ íˆ´ í˜¸ì¶œâ€ì„ êµ¬í˜„í•˜ë ¤ë©´ SDKê°€ í•„ìš”í•©ë‹ˆë‹¤.<br />
ì§ì ‘ ì„œë²„ë‚˜ ì—ì´ì „íŠ¸ ë£¨í”„ë¥¼ ë§Œë“¤ê³ , ëª¨ë¸ì˜ í•¨ìˆ˜ í˜¸ì¶œ ê²°ê³¼(JSON)ë¥¼ í•´ì„í•´ ìˆ˜ë™ìœ¼ë¡œ â€œsearch() â†’ ê²°ê³¼ â†’ ëª¨ë¸ ì¬í˜¸ì¶œâ€ì„ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤.</p>

<hr />

<p>ì •ë¦¬í•˜ìë©´:<br />
<strong>FileSearchToolì€ ëª¨ë¸ì´ í•„ìš”í•˜ë‹¤ê³  íŒë‹¨í•  ë•Œë§Œ í˜¸ì¶œë˜ê³ , SDKê°€ ì‹¤í–‰ì„ ì¤‘ê³„í•©ë‹ˆë‹¤.</strong><br />
ì¦‰, â€œëª¨ë¸ì´ ìš”ì²­í•˜ë©´ ìë™ìœ¼ë¡œ ë™ì‘í•œë‹¤â€ëŠ” í‘œí˜„ì´ ê°€ì¥ ì •í™•í•©ë‹ˆë‹¤.</p>

<p>ë‹¤ìŒ ë‹¨ê³„ë¡œ, ì›í•˜ì‹ ë‹¤ë©´ vLLM + gpt-oss ì¡°í•©ì—ì„œ ì´ â€œíˆ´ í˜¸ì¶œ ë£¨í”„â€ë¥¼ í‰ë‚´ë‚´ëŠ” ìµœì†Œ ì˜ˆì œ(ëª¨ë¸ â†’ function_call â†’ search â†’ ì¬í˜¸ì¶œ)ë¥¼ ë§Œë“¤ì–´ ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p class="chat--user">

ì˜ì–´ë¡œ ì‘ì„±ëœ ë¬¸ì„œ ragë¥¼ í•œê¸€ë¡œ ì¿¼ë¦¬í•  ìˆ˜ ìˆì–´?

</p>

<p>ê°€ëŠ¥í•©ë‹ˆë‹¤. ë°©ë²•ì€ í¬ê²Œ ë‘ ê°€ì§€ ê³„ì—´ì…ë‹ˆë‹¤. í•œê¸€ ì¿¼ë¦¬ â†’ ì˜ì–´ ë¬¸ì„œ RAGë¥¼ ì§€ì›í•˜ë ¤ë©´ â€œë‹¤êµ­ì–´ ì„ë² ë”©â€ì„ ì“°ê±°ë‚˜ â€œë²ˆì—­ ë ˆì´ì–´â€ë¥¼ ë¼ìš°ë©´ ë©ë‹ˆë‹¤.</p>

<ol>
  <li>ë‹¤êµ­ì–´ ì„ë² ë”©ìœ¼ë¡œ ì§ì ‘ ê²€ìƒ‰</li>
</ol>

<ul>
  <li>
    <p>í•µì‹¬: ì˜ì–´ ë¬¸ì„œ ì²­í¬ì™€ í•œêµ­ì–´ ì¿¼ë¦¬ë¥¼ ê°™ì€ ì„ë² ë”© ê³µê°„ìœ¼ë¡œ ë§¤í•‘.</p>
  </li>
  <li>
    <p>ëª¨ë¸ ì˜ˆ: bge-m3, e5-multilingual, LaBSE, mContriever ë“±.</p>
  </li>
  <li>
    <p>ì¥ì : ë²ˆì—­ ì—†ì´ë„ ê°œë… ë§ì¶¤. ê³ ìœ ëª…ì‚¬Â·ì „ë¬¸ìš©ì–´ì— ê°•í•¨.</p>
  </li>
  <li>
    <p>ë‹¨ì : ì„ë² ë”© í’ˆì§ˆÂ·ì°¨ì› ìˆ˜ê°€ ì»¤ì„œ ë©”ëª¨ë¦¬â†‘. ì˜ì–´ ì „ìš© ì„ë² ë”© ëŒ€ë¹„ ì•½ê°„ì˜ ì •ë°€ë„ ì†ì‹¤ì´ ìˆì„ ìˆ˜ ìˆìŒ.</p>
  </li>
</ul>

<ol>
  <li>ë²ˆì—­ í›„ ê²€ìƒ‰(translate-then-retrieve)</li>
</ol>

<ul>
  <li>
    <p>íŒŒì´í”„ë¼ì¸: í•œê¸€ ì¿¼ë¦¬ â†’ ì˜ì–´ë¡œ ë²ˆì—­ â†’ ì˜ì–´ ì „ìš© ì„ë² ë”©(ì˜ˆ: e5-large, bge-large-en ë“±)ìœ¼ë¡œ ê²€ìƒ‰ â†’ ë‹µë³€ì€ í•œê¸€ë¡œ ìƒì„±.</p>
  </li>
  <li>
    <p>ì¥ì : ì˜ì–´ ì „ìš© ì„ë² ë”©/ë¦¬ë­ì»¤ í’ˆì§ˆì„ ê·¸ëŒ€ë¡œ í™œìš© ê°€ëŠ¥.</p>
  </li>
  <li>
    <p>ë‹¨ì : ë²ˆì—­ ì˜¤ë¥˜ê°€ ì¿¼ë¦¬ì˜ í•µì‹¬ í† í”½ì„ ë¹„íŠ¸ëŠ” ê²½ìš°ê°€ ìˆìŒ. ì—”í‹°í‹°(ì œí’ˆëª…, í‘œê¸°) ì£¼ì˜.</p>
  </li>
</ul>

<p>ê¶Œì¥ ì„¤ê³„(í˜„ì—… ì•ˆì •íŒ)</p>

<ul>
  <li>
    <p>ì¸ë±ì‹±: ì˜ì–´ ë¬¸ì„œë¥¼ ë¬¸ë‹¨/ë¬¸ì¥ ë‹¨ìœ„ë¡œ ì²­í¬, ë©”íƒ€ë°ì´í„°(í˜ì´ì§€, ì„¹ì…˜, ì–¸ì–´=en) ì €ì¥.</p>
  </li>
  <li>
    <p>ì„ë² ë”©: ë‹¤êµ­ì–´ ì„ë² ë”© ì¸ë±ìŠ¤ 1ê°œëŠ” ë°˜ë“œì‹œ êµ¬ì¶•. ì—¬ë ¥ì´ ë˜ë©´ ì˜ì–´ ì „ìš© ì¸ë±ìŠ¤ë¥¼ ì¶”ê°€ë¡œ êµ¬ì„±í•´ ë“€ì–¼ ì¸ë±ìŠ¤ ê²€ìƒ‰.</p>
  </li>
  <li>
    <p>ê²€ìƒ‰ ì „ëµ: í•œê¸€ ì¿¼ë¦¬ì— ëŒ€í•´</p>

    <ol>
      <li>
        <p>ë‹¤êµ­ì–´ ì¸ë±ìŠ¤ì—ì„œ top-k</p>
      </li>
      <li>
        <p>ì˜ì–´ ì „ìš© ì¸ë±ìŠ¤(ì¿¼ë¦¬ ë²ˆì—­)ì—ì„œë„ top-k</p>
      </li>
      <li>
        <p>ë‘ ê²°ê³¼ë¥¼ ì ìˆ˜ ì •ê·œí™” í›„ ë³‘í•©</p>
      </li>
    </ol>
  </li>
  <li>
    <p>ë¦¬ë­í‚¹: ë‹¤êµ­ì–´ ë¦¬ë­ì»¤(bge-reranker-v2-m3 ê°™ì€ ë²”ìš© ë‹¤êµ­ì–´ ë¦¬ë­ì»¤)ë¡œ ìƒìœ„ 50â†’10 ì¬ì •ë ¬.</p>
  </li>
  <li>
    <p>í•˜ì´ë¸Œë¦¬ë“œ: BM25(í‚¤ì›Œë“œ) + ë²¡í„° ì ìˆ˜ ê°€ì¤‘ í‰ê· . ê³ ìœ ëª…ì‚¬ ë§¤ì¹­ ê°•í™”.</p>
  </li>
  <li>
    <p>ìƒì„±: gpt-oss(vLLM)ì— â€œì¶œì²˜ í‘œì‹œ, ì˜ì–´ ì¸ìš©ë¬¸ì€ ì›ë¬¸ ìœ ì§€, ìµœì¢… ë‹µë³€ì€ í•œêµ­ì–´â€ë¥¼ ì‹œìŠ¤í…œ ê·œì¹™ìœ¼ë¡œ ì£¼ì….</p>
  </li>
</ul>

<p>ê°„ë‹¨ íŒŒì´í”„ë¼ì¸ ì˜ˆì‹œ(í•µì‹¬ ë¡œì§ë§Œ)</p>

<ul>
  <li>
    <p>ì¸ë±ì‹±</p>

    <ol>
      <li>
        <p>PDF â†’ í…ìŠ¤íŠ¸ ì¶”ì¶œ â†’ ì²­í¬</p>
      </li>
      <li>
        <p>multilingual_embed(chunks) â†’ FAISS/Chroma/PGVectorì— ì €ì¥</p>
      </li>
      <li>
        <p>ì„ íƒ: english_embed(chunks)ë¡œ ì˜ì–´ ì „ìš© ì¸ë±ìŠ¤ë„ ë³‘í–‰ êµ¬ì¶•</p>
      </li>
    </ol>
  </li>
  <li>
    <p>ì§ˆì˜</p>

    <ol>
      <li>
        <p>ko_query â†’ multilingual_embed(ko_query)ë¡œ ê²€ìƒ‰</p>
      </li>
      <li>
        <p>ko_query â†’ en_queryë¡œ ë²ˆì—­ â†’ english_embed(en_query)ë¡œ ê²€ìƒ‰</p>
      </li>
      <li>
        <p>ê²°ê³¼ ë³‘í•© â†’ ë‹¤êµ­ì–´ ë¦¬ë­í‚¹</p>
      </li>
      <li>
        <p>ìƒìœ„ nê°œë¥¼ ì»¨í…ìŠ¤íŠ¸ë¡œ vLLMì— ë„£ê³  í•œêµ­ì–´ë¡œ ë‹µë³€ ìƒì„±</p>
      </li>
    </ol>
  </li>
</ul>

<p>í”„ë¡¬í”„íŠ¸ íŒ</p>

<ul>
  <li>
    <p>ì‹œìŠ¤í…œ ê·œì¹™ì— â€œë¬¸í—Œì€ ì˜ì–´ ì›ë¬¸ì„ ê·¸ëŒ€ë¡œ ì¸ìš©, ì„¤ëª…ì€ í•œêµ­ì–´ë¡œ ì‘ì„±, ì¶œì²˜ í˜ì´ì§€/ì„¹ì…˜ì„ í•¨ê»˜ ì ì‹œâ€ë¥¼ ëª…ì‹œ.</p>
  </li>
  <li>
    <p>ë‹¤êµ­ì–´ í˜¼ìš© ë¬¸ì„œì¼ ê²½ìš° â€œì–¸ì–´ ê°ì§€ â†’ ì¿¼ë¦¬ì™€ ë‹¤ë¥¸ ì–¸ì–´ë¼ë„ ë™ì¼ ê°œë…ì´ë©´ í¬í•¨â€ ê°™ì€ ì§€ì¹¨ì„ ì¶”ê°€.</p>
  </li>
</ul>

<p>ì‹¤ë¬´ ì²´í¬ë¦¬ìŠ¤íŠ¸</p>

<ul>
  <li>
    <p>í† í¬ë‚˜ì´ì € ê¸¸ì´: ì²­í¬ëŠ” 200~400í† í°(ë¬¸ë‹¨ ê²½ê³„ ìœ ì§€).</p>
  </li>
  <li>
    <p>ë©”íƒ€ë°ì´í„°: page, section, filename, lang. ë‹µë³€ì— ê·¼ê±° í‘œì‹œ ìš©ì´.</p>
  </li>
  <li>
    <p>ê³ ìœ ëª…ì‚¬: ëŒ€ì†Œë¬¸ìÂ·í•˜ì´í”ˆÂ·ìŠ¤ë„¤ì´í¬ì¼€ì´ìŠ¤ ë³´ì¡´. ì •ê·œí™” ê³¼ë„í•˜ê²Œ í•˜ì§€ ì•Šê¸°.</p>
  </li>
  <li>
    <p>ìºì‹±: ë¹ˆë²ˆí•œ ì¿¼ë¦¬ ë²ˆì—­/ì„ë² ë”© ê²°ê³¼ ìºì‹œ.</p>
  </li>
  <li>
    <p>í‰ê°€: í•œ-ì˜ ìŒìœ¼ë¡œ ì§ˆì˜â€“ì •ë‹µ ê³¨ë“œì…‹ì„ ë§Œë“¤ì–´ MRR@n, Hit@n, nDCGë¡œ ë¹„êµ.</p>
  </li>
</ul>

<p>vLLM + gpt-oss ì—°ê²° í¬ì¸íŠ¸</p>

<ul>
  <li>
    <p>ìœ„ ê²€ìƒ‰ ê²°ê³¼(top-k ì²­í¬)ë¥¼ user ë©”ì‹œì§€ì— CONTEXTë¡œ ë„£ê³  ì§ˆë¬¸ì€ í•œêµ­ì–´ë¡œ ì „ë‹¬.</p>
  </li>
  <li>
    <p>ë‹µë³€ì€ í•œêµ­ì–´ë¡œ ê°•ì œ, í•„ìš”í•œ ë¶€ë¶„ë§Œ ì˜ì–´ ì›ë¬¸ ì¸ìš©.</p>
  </li>
  <li>
    <p>í•¨ìˆ˜íˆ´(ì˜ˆ: search_docs)ì„ í•œ ê°œ ì œê³µí•´ â€œëª¨ë¸ì´ í•„ìš” ì‹œ í˜¸ì¶œâ€í•˜ë„ë¡í•˜ë©´ ìë™ ë£¨í”„(ì—ì´ì „íŠ¸ ìŠ¤íƒ€ì¼)ë„ ì¬í˜„ ê°€ëŠ¥.</p>
  </li>
</ul>

<p>ìš”ì•½</p>

<ul>
  <li>ê°€ëŠ¥í•˜ê³ , ì‹¤ì „ì—ì„œëŠ” â€œë‹¤êµ­ì–´ ì„ë² ë”© + ë²ˆì—­ ë³‘í–‰ + ë¦¬ë­í‚¹â€ì´ ì•ˆì •ì ì…ë‹ˆë‹¤. ì´ë¯¸ êµ¬ì¶•ëœ ì˜ì–´ ì½”í¼ìŠ¤ì— ìµœì†Œ ë³€ê²½ìœ¼ë¡œ í•œê¸€ ì§ˆì˜ë¥¼ ë¶™ì¼ ìˆ˜ ìˆê³ , gpt-oss ì„œë¹™ê³¼ë„ ì˜ ë§ìŠµë‹ˆë‹¤.</li>
</ul>

<p class="chat--user">

ì•„ ê·¸ë¦¬ê³  ì•„ê¹Œ search functionì„ ë§Œë“ ë‹¤ê³  í–ˆì–ì•„. ê·¸ í•¨ìˆ˜ëŠ” ëª¨ë“  RAG ë¬¸ì„œë¥¼ ë‹¤ ë’¤ì ¸ ì•„ë‹ˆë©´ ë¬¸ì„œê°€ ë§Œì•½ 100ê°œ ë“±ë¡ëë‹¤ê³  ì¹˜ë©´ ê°€ì¥ ê´€ë ¨ëœ 10ê°œë§Œ ì¶”ë ¤ì„œ 10ê°œì— ëŒ€í•œ ë§¤ì¹­ë§Œ í•´?

</p>

<p>ì§§ê²Œ í•µì‹¬ë¶€í„°: ì˜ ë§Œë“  search í•¨ìˆ˜ëŠ” â€œì „ë¶€ ë’¤ì§€ê¸°â€ê°€ ì•„ë‹ˆë¼ ë³´í†µ 2ë‹¨ê³„ë¡œ ì¢í™ë‹ˆë‹¤. 1ë‹¨ê³„ì—ì„œ ë¬¸ì„œ ë ˆë²¨ë¡œ ìƒìœ„ Nê°œë¥¼ ê³ ë¥´ê³ , 2ë‹¨ê³„ì—ì„œ ê·¸ ë¬¸ì„œë“¤ ì•ˆì—ì„œ ì²­í¬ ë ˆë²¨ë¡œ ìƒìœ„ Kê°œë§Œ ë½‘ì•„ LLMì— ë„£ìŠµë‹ˆë‹¤. ë³´í¸ê°’ì€ Nâ‰ˆ5~20, Kâ‰ˆ3~8, ê·¸ë¦¬ê³  ìµœì¢… ì»¨í…ìŠ¤íŠ¸ í† í° ìƒí•œìœ¼ë¡œ ì»·ì„ ê²ë‹ˆë‹¤.</p>

<p>ì•„í‚¤í…ì²˜ë¥¼ ë‹¨ê³„ë³„ë¡œ ì •ë¦¬í•´ë³¼ê²Œìš”.</p>

<ol>
  <li>ì»¬ë ‰ì…˜ê³¼ ì¸ë±ìŠ¤</li>
</ol>

<ul>
  <li>
    <p>ë¬¸ì„œ 100ê°œê°€ ë“±ë¡ë˜ì–´ ìˆë‹¤ë©´ ìš°ì„  ì „ë¶€ë¥¼ í•˜ë‚˜ì˜ ë²¡í„° ì¸ë±ìŠ¤(ë˜ëŠ” ì»¬ë ‰ì…˜)ë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë¬¸ì„œ ë©”íƒ€ë°ì´í„°(íŒŒì¼ëª…, ì„¹ì…˜, ë‚ ì§œ, ì–¸ì–´, ê¶Œí•œ, íƒœê·¸)ë¥¼ í•¨ê»˜ ì €ì¥í•´ í•„í„°ë§ì— í™œìš©í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ ê¶Œì¥: ë²¡í„°(ì˜ë¯¸) + BM25(í‚¤ì›Œë“œ)ë¥¼ í•¨ê»˜ ì¨ì„œ ê³ ìœ ëª…ì‚¬Â·ìˆ«ì ë§¤ì¹­ì„ ë³´ì™„í•©ë‹ˆë‹¤.</p>
  </li>
</ul>

<ol>
  <li>1ë‹¨ê³„: ë¬¸ì„œ ë ˆë²¨ í”„ë¦¬ì…€ë ‰ì…˜</li>
</ol>

<ul>
  <li>
    <p>ì¿¼ë¦¬ ì„ë² ë”©ê³¼ ë¬¸ì„œ ëŒ€í‘œ ë²¡í„°ë¥¼ ë¹„êµí•´ ìƒìœ„ Nê°œ ë¬¸ì„œë¥¼ ê³ ë¦…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë¬¸ì„œ ëŒ€í‘œ ë²¡í„°ëŠ” ë³´í†µ ë¬¸ì„œ ì œëª©+ìš”ì•½(abstract) ë˜ëŠ” ìƒìœ„ ëª‡ ê°œ ì²­í¬ì˜ í‰ê· ìœ¼ë¡œ ë§Œë“­ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>í•„í„° ì˜ˆ: lang=en, updated_at&gt;2025-01-01, tag in [â€œpolicyâ€, â€œspecâ€] ê°™ì€ ì¡°ê±´ì„ ë¨¼ì € ê±¸ì–´ íƒìƒ‰ ê³µê°„ì„ ì¤„ì…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë‹¤ì¤‘ ì „ëµ ê²°í•©: ë²¡í„° ìƒìœ„ N1, BM25 ìƒìœ„ N2ë¥¼ ë½‘ì•„ Reciprocal Rank Fusion ê°™ì€ ë°©ì‹ìœ¼ë¡œ í•©ì¹©ë‹ˆë‹¤.</p>
  </li>
</ul>

<ol>
  <li>2ë‹¨ê³„: ì²­í¬ ë ˆë²¨ ì •ë°€ ê²€ìƒ‰</li>
</ol>

<ul>
  <li>
    <p>ì„ íƒëœ Nê°œ ë¬¸ì„œ ê°ê°ì—ì„œ top_k_chunks_per_doc=Kë¡œ ì²­í¬ë¥¼ ë½‘ìŠµë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì¤‘ë³µÂ·ìœ ì‚¬ ì²­í¬ëŠ” Max Marginal Relevance(MMR)ë¡œ ë‹¤ì–‘í™”í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì „ì²´ ëª¨ì•„ì„œ ì¬ë­í‚¹: ë‹¤êµ­ì–´ ë¦¬ë­ì»¤ ë˜ëŠ” cross-encoderë¡œ ìƒìœ„ 50â†’ìµœì¢… 10ê°œë¡œ ì¤„ì…ë‹ˆë‹¤.</p>
  </li>
</ul>

<ol>
  <li>ì»¨í…ìŠ¤íŠ¸ ë¹Œë”</li>
</ol>

<ul>
  <li>
    <p>ìµœì¢… ì²­í¬ë“¤ì„ ê·¼ê±° ë©”íƒ€ë°ì´í„°ì™€ í•¨ê»˜ LLM ì»¨í…ìŠ¤íŠ¸ë¡œ ì§ì¡°í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>í† í° í•œë„(max_context_tokens)ì— ë§ì¶° ìë¥´ê³ , ê°€ëŠ¥í•œ í•œ ë¬¸ë‹¨ ê²½ê³„ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ê·œì¹™ì„ ê°•ì œ: ë‹µë³€ì€ í•œêµ­ì–´, ì¸ìš©ì€ ì›ë¬¸ ìœ ì§€, ê° ê·¼ê±°ì— í˜ì´ì§€/ì„¹ì…˜ í‘œê¸°.</p>
  </li>
</ul>

<ol>
  <li>ìš´ì˜ íŒ</li>
</ol>

<ul>
  <li>
    <p>ì¿¼ë¦¬ ë¼ìš°íŒ…: ë¶„ì•¼ë³„ ì»¬ë ‰ì…˜ì´ ì—¬ëŸ¬ ê°œë©´ ë¨¼ì € ë¼ìš°í„°(ë¶„ì•¼ ë¶„ë¥˜ê¸°)ë¡œ ì»¬ë ‰ì…˜ì„ 1~2ê°œë¡œ ì¢íŒ ë’¤ ìœ„ ê³¼ì •ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ìºì‹±: ì¦ì€ ì¿¼ë¦¬ì˜ ì„ë² ë”©ê³¼ ìƒìœ„ ê²°ê³¼ë¥¼ ìºì‹œí•´ ì§€ì—°ì„ ì¤„ì…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì„ê³„ê°’: ìœ ì‚¬ë„ ìŠ¤ì½”ì–´ê°€ ì„ê³„ê°’ ë¯¸ë§Œì´ë©´ â€œê·¼ê±° ì—†ìŒâ€ìœ¼ë¡œ ì²˜ë¦¬í•´ í™˜ê°ì„ ì¤„ì…ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ê¶Œí•œ: ë©€í‹°ìœ ì €ë¼ë©´ ë¬¸ì„œë³„ ACLì„ ë©”íƒ€ë°ì´í„° í•„í„°ì— ë°˜ë“œì‹œ ë°˜ì˜í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì‹¤í—˜: N, K, ì„ê³„ê°’ì„ ê²€ì¦ì…‹ìœ¼ë¡œ íŠœë‹í•©ë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ Nì„ ëŠ˜ë¦¬ë©´ ë¦¬ì½œâ†‘, ì§€ì—°/ë¹„ìš©â†‘.</p>
  </li>
</ul>

<p>ê°„ë‹¨í•œ ì˜ì‚¬ì½”ë“œ</p>

<ul>
  <li>
    <p>ì…ë ¥: query, filters, top_docs=N, top_chunks_per_doc=K, max_context_tokens</p>
  </li>
  <li>
    <p>ì¶œë ¥: ranked_chunks</p>
  </li>
</ul>

<ol>
  <li>
    <p>q_emb = embed(query)</p>
  </li>
  <li>
    <p>doc_candidates = fuse(<br />
vector_search(DOC_INDEX, q_emb, N_vec),<br />
bm25_search(DOC_TEXTS, query, N_bm25)<br />
)[:N]</p>
  </li>
  <li>
    <p>chunk_pool = []<br />
for d in doc_candidates:<br />
chunk_pool += vector_search(d.CHUNK_INDEX, q_emb, K)</p>
  </li>
  <li>
    <p>chunk_pool = mmr_dedup(chunk_pool)</p>
  </li>
  <li>
    <p>ranked = rerank_cross_encoder(query, chunk_pool)</p>
  </li>
  <li>
    <p>context = pack_by_tokens(ranked, max_context_tokens)</p>
  </li>
  <li>
    <p>return context, ranked[:final_k]</p>
  </li>
</ol>

<p>ì§ˆë¬¸ìœ¼ë¡œ ì£¼ì‹  ë‘ ì„ íƒì§€ë¥¼ ì •ë¦¬í•˜ìë©´</p>

<ul>
  <li>
    <p>ëª¨ë“  RAG ë¬¸ì„œë¥¼ ë‹¤ ë’¤ì§€ëŠ” ì¼ê´„ ì „ìˆ˜ê²€ìƒ‰ì€ ê·œëª¨ê°€ ì»¤ì§ˆìˆ˜ë¡ ëŠë ¤ì§€ê³  ë¹„ìš©ì´ í½ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ë³´í†µì€ â€œê°€ì¥ ê´€ë ¨ëœ ë¬¸ì„œ ìƒìœ„ Nê°œâ€ë¥¼ ì¶”ë ¤ ê·¸ ì•ˆì—ì„œë§Œ Kê°œ ì²­í¬ë¥¼ ë½‘ëŠ” ê³„ì¸µì  ê²€ìƒ‰ì„ ì”ë‹ˆë‹¤. 100ê°œ ë¬¸ì„œë©´ ìƒìœ„ 10ê°œ ë¬¸ì„œ Ã— ë¬¸ì„œë‹¹ 5ê°œ ì²­í¬ ê°™ì€ êµ¬ì„±ì´ í˜„ì‹¤ì ì…ë‹ˆë‹¤.</p>
  </li>
</ul>

<p>ë§ˆì§€ë§‰ìœ¼ë¡œ ìˆ«ì ë ˆì‹œí”¼ ì˜ˆì‹œ</p>

<ul>
  <li>
    <p>top_docs=10, top_chunks_per_doc=5, rerank_top=60â†’final=12, max_context_tokens=6k</p>
  </li>
  <li>
    <p>í•˜ì´ë¸Œë¦¬ë“œ ë¹„ìœ¨: vector:bm25 = 0.7:0.3 ê°€ì¤‘ í‰ê· </p>
  </li>
  <li>
    <p>ì„ê³„ê°’: cosine &lt; 0.25ë©´ ì œì™¸, ë¬¸ì„œ ìµœì‹ ê°€ì¤‘ì¹˜ e^(âˆ’Î»Â·age_days) ì ìš©</p>
  </li>
</ul>

<p>ì´ë ‡ê²Œ êµ¬ì„±í•˜ë©´ ì •í™•ë„Â·ì§€ì—°Â·ë¹„ìš©ì˜ ê· í˜•ì´ ì¢‹ì•„ì§€ê³ , ì¿¼ë¦¬ í­ì´ ë„“ì–´ì ¸ë„ ê¹”ë”í•˜ê²Œ í™•ì¥ë©ë‹ˆë‹¤.</p>

<p class="chat--user">

FunctionToolë¡œ ë„ˆê°€ ë§í•œ ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ê³  ì‹¶ì–´. ëŒ€ëµì ì¸ ì¸í„°í˜ì´ìŠ¤ í•¨ìˆ˜ë“¤ê³¼ ë™ì‘ì„ ì¡ì•„ë³´ì

</p>

<p>ì¢‹ì•„, FunctionToolë¡œ RAG ê²€ìƒ‰ì„ ë¶™ì¼ ë•Œ ì“¸ â€œëŒ€ëµì  ì¸í„°í˜ì´ìŠ¤â€ì™€ ë™ì‘ íë¦„ì„ ì¡ì•„ë³¼ê²Œ. vLLM+gpt-ossì—ì„œë„ ê·¸ëŒ€ë¡œ ì“°ê³ , OpenAI Agents SDKì—ë„ ê±°ì˜ ê·¸ëŒ€ë¡œ ë§µí•‘ë˜ë„ë¡ ì„¤ê³„í–ˆì–´.</p>

<p>í•µì‹¬ êµ¬ì„±ìš”ì†Œ</p>

<ul>
  <li>
    <p>ì¸ë±ì‹± íŒŒì´í”„ë¼ì¸: íŒŒì¼â†’í…ìŠ¤íŠ¸â†’ì²­í¬â†’ì„ë² ë”©â†’ì €ì¥</p>
  </li>
  <li>
    <p>ê²€ìƒ‰ íŒŒì´í”„ë¼ì¸: ì§ˆì˜â†’í•„í„°â†’ë¬¸ì„œ ìƒìœ„ Nâ†’ì²­í¬ ìƒìœ„ Kâ†’ì¬ë­í¬â†’ì»¨í…ìŠ¤íŠ¸ íŒ¨í‚¹</p>
  </li>
  <li>
    <p>FunctionTool: ëª¨ë¸ì´ í˜¸ì¶œí•˜ë©´ ìœ„ ê²€ìƒ‰ íŒŒì´í”„ë¼ì¸ì„ ì‹¤í–‰í•´ ì»¨í…ìŠ¤íŠ¸ì™€ ê·¼ê±° ë©”íƒ€ë¥¼ ë°˜í™˜</p>
  </li>
</ul>

<p>ë°ì´í„° ëª¨ë¸(ê°„ë‹¨)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ts

type DocMeta = {
  doc_id: string
  title: string
  path?: string
  lang?: 'en'|'ko'|'mixed'
  tags?: string[]
  created_at?: string
  updated_at?: string
  acl?: string[]            // ì ‘ê·¼ í—ˆìš© ì‚¬ìš©ì/ì—­í• 
}

type Chunk = {
  chunk_id: string
  doc_id: string
  content: string
  page?: number
  section?: string
  tokens?: number
}

type Scored&lt;T&gt; = T &amp; { score: number }
</code></pre></div></div>

<p>FunctionTool ì‹œê·¸ë‹ˆì²˜(ê²€ìƒ‰ ì „ìš©)<br />
OpenAI-style JSON ìŠ¤í‚¤ë§ˆë¥¼ ë”°ë¼ ì„¤ê³„. íˆ´ ì´ë¦„ì€ search_docs.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"search_docs"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ì§ˆë¬¸ê³¼ í•„í„°ë¥¼ ë°›ì•„ ê´€ë ¨ ë¬¸ì„œì™€ ì²­í¬ë¥¼ ê²€ìƒ‰í•´ LLM ì»¨í…ìŠ¤íŠ¸ë¥¼ ë§Œë“ ë‹¤."</span><span class="p">,</span><span class="w">
  </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ì‚¬ìš©ì ì§ˆë¬¸(ko/en ê°€ëŠ¥)"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"filters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"langs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w"> </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="nl">"tags"</span><span class="p">:</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w"> </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="nl">"doc_ids"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w"> </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="nl">"updated_after"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ISO8601"</span><span class="w"> </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"top_docs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="nl">"minimum"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"top_chunks_per_doc"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="nl">"minimum"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"final_chunks"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="nl">"minimum"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"max_context_tokens"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="mi">6000</span><span class="p">,</span><span class="w"> </span><span class="nl">"minimum"</span><span class="p">:</span><span class="w"> </span><span class="mi">512</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"use_hybrid"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boolean"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"use_mmr"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boolean"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"use_reranker"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boolean"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"translate_query_to_en"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boolean"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"query"</span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>FunctionTool ë°˜í™˜ í¬ë§·<br />
LLMì´ ë°”ë¡œ ë¨¹ì¼ ìˆ˜ ìˆê²Œ ì»¨í…ìŠ¤íŠ¸ í…ìŠ¤íŠ¸ì™€ ê·¼ê±° ë¦¬ìŠ¤íŠ¸ë¥¼ í•¨ê»˜ ì¤Œ.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ts

type SearchResult = {
  context: string                 // LLMì— ë°”ë¡œ ë„£ì„ ì»¨í…ìŠ¤íŠ¸
  citations: Array&lt;{
    doc_id: string
    title?: string
    page?: number
    section?: string
    snippet: string
    score: number
  }&gt;
  diagnostics?: {
    used_docs: Array&lt;Scored&lt;DocMeta&gt;&gt;
    used_chunks: Array&lt;Scored&lt;Chunk&gt;&gt;
    query_lang?: 'ko'|'en'|'unknown'
    translated_query?: string
  }
}
</code></pre></div></div>

<p>ë™ì‘ ì˜ì‚¬ì½”ë“œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">search_docs</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">top_docs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">top_chunks_per_doc</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                <span class="n">final_chunks</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">max_context_tokens</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span>
                <span class="n">use_hybrid</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">use_mmr</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">use_reranker</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">translate_query_to_en</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SearchResult</span><span class="p">:</span>

    <span class="c1"># 0) ê¶Œí•œ/í•„í„°ë§ í”„ë ˆë”•íŠ¸
</span>    <span class="n">candidate_docs</span> <span class="o">=</span> <span class="nf">filter_docs</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>  <span class="c1"># lang/tags/doc_ids/updated_after/ACL ë°˜ì˜
</span>
    <span class="c1"># 1) ì¿¼ë¦¬ ì¤€ë¹„
</span>    <span class="n">lang</span> <span class="o">=</span> <span class="nf">detect_lang</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>  <span class="c1"># ko/en ì¶”ì •
</span>    <span class="n">q_for_vec</span> <span class="o">=</span> <span class="n">query</span>
    <span class="k">if</span> <span class="n">translate_query_to_en</span> <span class="ow">and</span> <span class="n">lang</span> <span class="o">==</span> <span class="sh">'</span><span class="s">ko</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">q_for_vec</span> <span class="o">=</span> <span class="nf">translate_ko_to_en</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>  <span class="c1"># ì„ íƒ ê¸°ëŠ¥
</span>
    <span class="c1"># 2) ë¬¸ì„œ ë ˆë²¨ í”„ë¦¬ì…€ë ‰ì…˜
</span>    <span class="n">doc_scores_vec</span> <span class="o">=</span> <span class="nf">vector_search_docs</span><span class="p">(</span><span class="n">candidate_docs</span><span class="p">,</span> <span class="n">q_for_vec</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">top_docs</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">doc_scores_kw</span>  <span class="o">=</span> <span class="nf">bm25_search_docs</span><span class="p">(</span><span class="n">candidate_docs</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">top_docs</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="n">use_hybrid</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="n">doc_candidates</span> <span class="o">=</span> <span class="nf">fuse_scores</span><span class="p">(</span><span class="n">doc_scores_vec</span><span class="p">,</span> <span class="n">doc_scores_kw</span><span class="p">)[:</span><span class="n">top_docs</span><span class="p">]</span>

    <span class="c1"># 3) ì²­í¬ ë ˆë²¨ ì •ë°€ ê²€ìƒ‰
</span>    <span class="n">chunk_pool</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">doc_candidates</span><span class="p">:</span>
        <span class="n">chunks_vec</span> <span class="o">=</span> <span class="nf">vector_search_chunks</span><span class="p">(</span><span class="n">doc</span><span class="p">.</span><span class="n">doc_id</span><span class="p">,</span> <span class="n">q_for_vec</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">top_chunks_per_doc</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">chunks_kw</span>  <span class="o">=</span> <span class="nf">bm25_search_chunks</span><span class="p">(</span><span class="n">doc</span><span class="p">.</span><span class="n">doc_id</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">top_chunks_per_doc</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">use_hybrid</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">chunk_pool</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="nf">fuse_scores</span><span class="p">(</span><span class="n">chunks_vec</span><span class="p">,</span> <span class="n">chunks_kw</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">use_mmr</span><span class="p">:</span>
        <span class="n">chunk_pool</span> <span class="o">=</span> <span class="nf">mmr_diversify</span><span class="p">(</span><span class="n">chunk_pool</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">final_chunks</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>

    <span class="c1"># 4) ì¬ë­í‚¹
</span>    <span class="n">ranked</span> <span class="o">=</span> <span class="n">chunk_pool</span>
    <span class="k">if</span> <span class="n">use_reranker</span><span class="p">:</span>
        <span class="n">ranked</span> <span class="o">=</span> <span class="nf">cross_encoder_rerank</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">chunk_pool</span><span class="p">)</span>  <span class="c1"># ìƒìœ„ 50â†’ì •ë ¬
</span>
    <span class="c1"># 5) ì»¨í…ìŠ¤íŠ¸ íŒ¨í‚¹
</span>    <span class="n">selected</span> <span class="o">=</span> <span class="nf">take_until_token_budget</span><span class="p">(</span><span class="n">ranked</span><span class="p">,</span> <span class="n">final_chunks</span><span class="p">,</span> <span class="n">max_context_tokens</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="nf">build_context</span><span class="p">(</span><span class="n">selected</span><span class="p">)</span>  <span class="c1"># [Doc:Title p.X] + ë³¸ë¬¸â€¦ í˜•íƒœ
</span>
    <span class="c1"># 6) ì¸ìš©/ë””ë²„ê·¸ ì •ë³´
</span>    <span class="n">citations</span> <span class="o">=</span> <span class="p">[{</span>
        <span class="sh">"</span><span class="s">doc_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">doc_id</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">title</span><span class="sh">"</span><span class="p">:</span> <span class="nf">get_title</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">doc_id</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">page</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">page</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">section</span><span class="sh">"</span><span class="p">:</span> <span class="n">c</span><span class="p">.</span><span class="n">section</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">snippet</span><span class="sh">"</span><span class="p">:</span> <span class="nf">shorten</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="mi">300</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">score</span><span class="sh">"</span><span class="p">:</span> <span class="nf">float</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">score</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">]</span>

    <span class="n">diags</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">used_docs</span><span class="sh">"</span><span class="p">:</span> <span class="n">doc_candidates</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">used_chunks</span><span class="sh">"</span><span class="p">:</span> <span class="n">selected</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">query_lang</span><span class="sh">"</span><span class="p">:</span> <span class="n">lang</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">translated_query</span><span class="sh">"</span><span class="p">:</span> <span class="n">q_for_vec</span> <span class="k">if</span> <span class="n">q_for_vec</span> <span class="o">!=</span> <span class="n">query</span> <span class="k">else</span> <span class="bp">None</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">context</span><span class="sh">"</span><span class="p">:</span> <span class="n">context</span><span class="p">,</span> <span class="sh">"</span><span class="s">citations</span><span class="sh">"</span><span class="p">:</span> <span class="n">citations</span><span class="p">,</span> <span class="sh">"</span><span class="s">diagnostics</span><span class="sh">"</span><span class="p">:</span> <span class="n">diags</span><span class="p">}</span>
</code></pre></div></div>

<p>ì»¨í…ìŠ¤íŠ¸ ë¹Œë“œ ê·œì¹™(ìš”ì•½)</p>

<ul>
  <li>
    <p>ë¬¸ì„œ/í˜ì´ì§€/ì„¹ì…˜ ë©”íƒ€ë¥¼ ëª…ì‹œ</p>
  </li>
  <li>
    <p>ì²­í¬ ì‚¬ì´ì— êµ¬ë¶„ì</p>
  </li>
  <li>
    <p>ì›ë¬¸ì´ ì˜ì–´ë¼ë„ ê·¸ëŒ€ë¡œ ë‘ê³ , ìµœì¢… ë‹µë³€ ì–¸ì–´ëŠ” LLM ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ë¡œ ê°•ì œ</p>
  </li>
</ul>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Source] Title="Spec ABC", DocID=doc_123, Page=5, Section="3.2"
"Chunk content here..."

[Source] Title="Spec XYZ", DocID=doc_987, Page=12
"Another chunk..."
</code></pre></div></div>

<p>Agents SDKì— ë“±ë¡ ì˜ˆì‹œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>
<span class="n">client</span> <span class="o">=</span> <span class="nc">OpenAI</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">search_docs_tool</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="k">return</span> <span class="nf">search_docs</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

<span class="n">tools</span> <span class="o">=</span> <span class="p">[{</span>
  <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">,</span>
  <span class="sh">"</span><span class="s">function</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">search_docs</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ë¬¸ì„œ/ì²­í¬ ê²€ìƒ‰</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">parameters</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span> <span class="p">...</span> <span class="n">ìœ„</span> <span class="n">JSON</span> <span class="n">ìŠ¤í‚¤ë§ˆ</span> <span class="p">...</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}]</span>

<span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">ë‹µë³€ì€ í•œêµ­ì–´ë¡œ. ë°˜ë“œì‹œ search_docsë¥¼ ì´ìš©í•´ ê·¼ê±°ë¥¼ í™•ì¸í•˜ê³ , ì¸ìš©ì„ í¬í•¨í•´ë¼.</span><span class="sh">"</span><span class="p">},</span>
  <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">ì˜ì–´ë¡œ ëœ ì œí’ˆ ë³´ì¦ ì¡°ê±´ ìš”ì•½í•´ì¤˜</span><span class="sh">"</span><span class="p">}</span>
<span class="p">]</span>

<span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
  <span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">gpt-4o-mini</span><span class="sh">"</span><span class="p">,</span>
  <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
  <span class="n">tools</span><span class="o">=</span><span class="n">tools</span>
<span class="p">)</span>
<span class="c1"># tool_calls ê°ì§€ â†’ search_docs_tool ì‹¤í–‰ â†’ ê²°ê³¼ë¥¼ tool ë©”ì‹œì§€ë¡œ ì²¨ë¶€ â†’ ëª¨ë¸ ì¬í˜¸ì¶œ
</span></code></pre></div></div>

<p>vLLM+gpt-oss ì»¤ìŠ¤í…€ ë£¨í”„</p>

<ul>
  <li>
    <p>vLLMì€ íˆ´ í˜¸ì¶œ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ì´ ì—†ìœ¼ë‹ˆ, ëª¨ë¸ ì¶œë ¥ì˜ function_call(JSON)ì„ ì§ì ‘ íŒŒì‹±í•´ì„œ search_docsë¥¼ í˜¸ì¶œí•œ ë’¤ ê²°ê³¼ë¥¼ ë‹¤ì‹œ ëª¨ë¸ì— ë„£ëŠ” ë£¨í”„ë¥¼ êµ¬í˜„í•˜ë©´ ëœë‹¤.</p>
  </li>
  <li>
    <p>ë˜ëŠ” â€œìˆ˜ë™ ëª¨ë“œâ€ë¡œ, ì‚¬ìš©ì ì§ˆë¬¸ì´ ì˜¤ë©´ ì„œë²„ì—ì„œ search_docsë¥¼ ë¨¼ì € ì‹¤í–‰í•´ contextë¥¼ ë§Œë“¤ê³ , ê·¸ê±¸ user ë©”ì‹œì§€ì— ë¶™ì—¬ ëª¨ë¸ì„ í•œ ë²ˆë§Œ í˜¸ì¶œí•˜ëŠ” ë°©ì‹ë„ ê°„ë‹¨í•˜ê³  íŠ¼íŠ¼í•˜ë‹¤.</p>
  </li>
</ul>

<p>ì¸ë±ì‹±ìš© ë³´ì¡° íˆ´(ì„ íƒ)<br />
íŒŒì¼ ì—…ë¡œë“œ/ì¬ë¹Œë“œ/ìƒíƒœ í™•ì¸ì„ ìœ„í•´ ì¶”ê°€ FunctionToolì„ ë‘ë©´ ìš´ì˜ì´ í¸í•˜ë‹¤.</p>

<ul>
  <li>
    <p>upsert_documents(files, tags, lang_hint)</p>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>rebuild_index(scope='all'</td>
          <td>'doc_id')</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>describe_doc(doc_id)</p>
  </li>
  <li>purge_docs(doc_ids)</li>
</ul>

<p>ìµœì†Œ ìš´ì˜ íŒŒë¼ë¯¸í„°ì˜ ì¶”ì²œ ê¸°ë³¸ê°’</p>

<ul>
  <li>
    <p>top_docs=10</p>
  </li>
  <li>
    <p>top_chunks_per_doc=5</p>
  </li>
  <li>
    <p>final_chunks=12</p>
  </li>
  <li>
    <p>max_context_tokens=6000</p>
  </li>
  <li>
    <p>use_hybrid=true, use_mmr=true, use_reranker=true</p>
  </li>
  <li>
    <p>translate_query_to_en=false (ë‹¤êµ­ì–´ ì„ë² ë”©ì´ë©´ ë¶ˆí•„ìš”, ì˜ì–´ ì „ìš© ì„ë² ë”©ì´ë©´ true)</p>
  </li>
</ul>

<p>ì—¬ê¸°ê¹Œì§€ê°€ ê²¬ê³ í•œ ê³¨ê²©ì´ì•¼. ë‹¤ìŒ ë‹¨ê³„ë¡œëŠ” ë„ˆí¬ê°€ ì“°ëŠ” ì„ë² ë”©/ë²¡í„°DBë¥¼ ê°€ì •í•´ì„œ search_docs ë‚´ë¶€ì˜ vector_search_*ì™€ bm25, reranker, íŒ¨í‚¹ í•¨ìˆ˜ë¥¼ ì‹¤ì½”ë“œë¡œ ë©”ì›Œ ë„£ìœ¼ë©´ ë°”ë¡œ ë¶™ì¼ ìˆ˜ ìˆë‹¤.</p>

<p class="chat--user">

Databaseë¥¼ ë§Œë“¤ê¸°ë„ í•´ì•¼í•´. ì´ë¥¼ ìœ„í•´ ë¬¸ì„œë¥¼ DBì— ì¶”ê°€í•˜ê±°ë‚˜ í•˜ëŠ” ê²ƒë„ í•„ìš”í•  ê²ƒ ê°™ì€ë°

</p>

<p>ì¢‹ì•„, RAGìš© Databaseê¹Œì§€ í¬í•¨í•œ â€œë¬¸ì„œ ìˆ˜ì§‘Â·ì €ì¥Â·ì¸ë±ì‹±Â·ê²€ìƒ‰â€ í’€ì‚¬ì´í´ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì¡ì•„ë³´ì. ìš´ì˜ì„ ì—¼ë‘ì— ë‘ê³  ì„¤ê³„í•˜ë©´ ë‚˜ì¤‘ì— ì•ˆ ì•„íŒŒìš”.</p>

<p>í•µì‹¬ êµ¬ì¡° ê°œìš”</p>

<ol>
  <li>
    <p>ì›ë³¸ ì €ì¥ì†Œ: ì—…ë¡œë“œí•œ íŒŒì¼ì„ ë³´ê´€í•˜ëŠ” Object Storage(S3, GCS, MinIO ë“±)</p>
  </li>
  <li>
    <p>ë©”íƒ€Â·í…ìŠ¤íŠ¸ DB: ë¬¸ì„œ/ì²­í¬/íƒœê·¸/ACL/ìƒíƒœë¥¼ ê´€ë¦¬í•˜ëŠ” RDB(PostgreSQL ê¶Œì¥)</p>
  </li>
  <li>
    <p>ë²¡í„° ì¸ë±ìŠ¤: pgvector ë˜ëŠ” ì™¸ë¶€ ë²¡í„°DB(FAISS, Milvus, Chroma, Qdrant)</p>
  </li>
  <li>
    <p>ì¡ í: ì„ë² ë”©Â·ì¬ì¸ë±ì‹± ê°™ì€ ë¹„ë™ê¸° ì‘ì—…ìš©(ì˜ˆ: Celery, RQ, Sidekiq, Temporal)</p>
  </li>
</ol>

<p>ê¶Œì¥ êµ¬í˜„ í”„ë¡œíŒŒì¼<br />
PostgreSQL + pgvector í•œ ë°©ìœ¼ë¡œ ëë‚´ê¸°<br />
ì¥ì : íŠ¸ëœì­ì…˜, ì¡°ì¸, í•„í„°ë§, ê¶Œí•œì²´í¬ê°€ ê¹”ë”. ìš´ì˜ ë‹¨ìˆœ.<br />
ëŒ€ì•ˆ: í…ìŠ¤íŠ¸ëŠ” Postgres, ë²¡í„°ëŠ” FAISS/Milvusë¡œ ë¶„ë¦¬. ì„±ëŠ¥ íŠœë‹ ììœ ë„â†‘.</p>

<p>ë°ì´í„° ëª¨ë¸ ìŠ¤í‚¤ë§ˆ(Postgres + pgvector)<br />
SQL DDL ì˜ˆì‹œ. ì„ë² ë”© ì°¨ì›ì€ ì˜ˆë¡œ 1024ë¥¼ ì‚¬ìš©.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sql

create extension if not exists vector;

create table documents (
  doc_id          uuid primary key,
  title           text not null,
  source_uri      text,                 -- S3 í‚¤, GCS ê²½ë¡œ ë“±
  mime_type       text,
  lang            text,                 -- 'en','ko','mixed' ë“±
  tags            text[],
  bytes           bigint,
  pages           int,
  created_at      timestamptz default now(),
  updated_at      timestamptz default now(),
  status          text not null default 'ready',  -- 'ready','processing','error','disabled'
  acl_roles       text[] default array[]::text[], -- ì ‘ê·¼ í—ˆìš© ì—­í• 
  acl_users       text[] default array[]::text[]  -- ì ‘ê·¼ í—ˆìš© ì‚¬ìš©ì
);

create table chunks (
  chunk_id        uuid primary key,
  doc_id          uuid references documents(doc_id) on delete cascade,
  page            int,
  section         text,
  content         text not null,
  token_count     int,
  created_at      timestamptz default now(),
  updated_at      timestamptz default now()
);

-- í•˜ë‚˜ì˜ ì»¬ëŸ¼ì— ë‹¤êµ­ì–´ ì„ë² ë”©ì„ ì €ì¥(ê¶Œì¥). í•„ìš”í•˜ë©´ ì˜ì–´ ì „ìš© ì¶”ê°€ ì»¬ëŸ¼ë„.
create table chunk_embeddings (
  chunk_id        uuid primary key references chunks(chunk_id) on delete cascade,
  emb_mtext       vector(1024),         -- ë‹¤êµ­ì–´ ì„ë² ë”©
  emb_en          vector(1024)          -- ì„ íƒ: ì˜ì–´ ì „ìš© ì„ë² ë”©
);

-- BM25 ëŒ€ì²´ìš© ì „ì²´ê²€ìƒ‰ ì¸ë±ìŠ¤
create index idx_chunks_fts on chunks using gin (to_tsvector('simple', content));

-- íƒœê·¸/ì–¸ì–´/ìƒíƒœ/ì—…ë°ì´íŠ¸ì¼ í•„í„°ë§
create index idx_documents_tags on documents using gin (tags);
create index idx_documents_lang on documents (lang);
create index idx_documents_status on documents (status);
create index idx_documents_updated on documents (updated_at);

-- ë²¡í„° ì¸ë±ìŠ¤(IVFFlat ì˜ˆì‹œ). ê·œëª¨ ì»¤ì§€ë©´ lists íŒŒë¼ë¯¸í„° íŠœë‹.
create index idx_chunk_emb_mtext on chunk_embeddings using ivfflat (emb_mtext vector_cosine_ops) with (lists = 200);
create index idx_chunk_emb_en    on chunk_embeddings using ivfflat (emb_en    vector_cosine_ops) with (lists = 200);
</code></pre></div></div>

<p>ìŠ¤í† ë¦¬ì§€ ê³„ì¸µ<br />
ì›ë¬¸ íŒŒì¼ì€ RDBì— ë„£ì§€ ë§ê³  Object Storageì— ë„£ê³  documents.source_urië¡œ ì—°ê²°. ì¸ë„¤ì¼Â·í…ìŠ¤íŠ¸ ì¶”ì¶œ ìºì‹œë¥¼ ë‘ë©´ ì†ë„ê°€ ë¹¨ë¼ì§.</p>

<p>FunctionTool ì¸í„°í˜ì´ìŠ¤ ì„¤ê³„<br />
ê²€ìƒ‰ë¿ ì•„ë‹ˆë¼ ì—…ì„œíŠ¸Â·ì¬ì¸ë±ì‹±Â·ê´€ë¦¬ê¹Œì§€ FunctionToolë¡œ ë…¸ì¶œí•˜ë©´ LLM ì—ì´ì „íŠ¸ë‚˜ ê´€ë¦¬ìš© UIì—ì„œ ìë™í™”í•˜ê¸° ì¢‹ë‹¤.</p>

<ol>
  <li>ë¬¸ì„œ ì—…ì„œíŠ¸<br />
ì´ í•¨ìˆ˜ëŠ” DBì™€ ìŠ¤í† ë¦¬ì§€ë¥¼ ê°±ì‹ í•˜ê³ , ë¹„ë™ê¸° ì¸ë±ì‹± ì¡ì„ ë°œí–‰.</li>
</ol>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"upsert_documents"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ë¬¸ì„œë¥¼ DBì™€ ìŠ¤í† ë¦¬ì§€ì— ì¶”ê°€/ê°±ì‹ í•˜ê³  ì¸ë±ì‹± ì¡ì„ íì— ë„£ëŠ”ë‹¤."</span><span class="p">,</span><span class="w">
  </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="nl">"source_uri"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="nl">"mime_type"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="nl">"lang_hint"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="nl">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w"> </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="nl">"acl_roles"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w"> </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="nl">"acl_users"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w"> </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="nl">"doc_id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ê°±ì‹  ì‹œ ì§€ì •"</span><span class="w"> </span><span class="p">}</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"title"</span><span class="p">,</span><span class="w"> </span><span class="s2">"source_uri"</span><span class="p">]</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"reindex"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"boolean"</span><span class="p">,</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"items"</span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>ë™ì‘</p>

<ol>
  <li>
    <p>source_uri ìœ íš¨ì„± í™•ì¸ ë° ë©”íƒ€ ì¶”ì¶œ(bytes, pages ë“±)</p>
  </li>
  <li>
    <p>documents upsert</p>
  </li>
  <li>
    <p>ìƒíƒœë¥¼ processingìœ¼ë¡œ ë°”ê¾¸ê³  ì¸ë±ì‹± ì¡ enqueue</p>
  </li>
  <li>
    <p>ì¸ë±ì‹± ì›Œì»¤(ë¹„ë™ê¸° ì¡)<br />
ì¶”ì¶œâ†’ì²­í¬â†’ì„ë² ë”©â†’ì €ì¥ íŒŒì´í”„ë¼ì¸. ì‹¤íŒ¨ ì‹œ documents.status='error'ì™€ ë©”ì‹œì§€ ì €ì¥.<br />
ì˜ì‚¬ì½”ë“œ</p>
  </li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">worker_index_document</span><span class="p">(</span><span class="n">doc_id</span><span class="p">):</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="nf">get_document</span><span class="p">(</span><span class="n">doc_id</span><span class="p">)</span>
    <span class="n">raw</span> <span class="o">=</span> <span class="n">storage</span><span class="p">.</span><span class="nf">download</span><span class="p">(</span><span class="n">doc</span><span class="p">.</span><span class="n">source_uri</span><span class="p">)</span>
    <span class="n">text</span><span class="p">,</span> <span class="n">pages</span> <span class="o">=</span> <span class="nf">extract_text</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>             <span class="c1"># pypdf/unstructured/docling
</span>    <span class="n">chunks</span> <span class="o">=</span> <span class="nf">chunking</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>                     <span class="c1"># 200~400 í† í° ê¶Œì¥
</span>    <span class="n">db</span><span class="p">.</span><span class="nf">delete_chunks</span><span class="p">(</span><span class="n">doc_id</span><span class="p">)</span>                    <span class="c1"># ì „ì²´ ì¬ë¹Œë“œ ì‹œ
</span>    <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">:</span>
        <span class="n">chunk_id</span> <span class="o">=</span> <span class="nf">uuid4</span><span class="p">()</span>
        <span class="n">db</span><span class="p">.</span><span class="nf">insert_chunk</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">,</span> <span class="n">doc_id</span><span class="p">,</span> <span class="n">ch</span><span class="p">.</span><span class="n">page</span><span class="p">,</span> <span class="n">ch</span><span class="p">.</span><span class="n">section</span><span class="p">,</span> <span class="n">ch</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="n">ch</span><span class="p">.</span><span class="n">tokens</span><span class="p">)</span>
    <span class="c1"># ì„ë² ë”©
</span>    <span class="n">vecs_m</span> <span class="o">=</span> <span class="nf">embed_multilingual</span><span class="p">([</span><span class="n">c</span><span class="p">.</span><span class="n">content</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">])</span>
    <span class="n">vecs_en</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># í•„ìš”í•˜ë©´ ë²ˆì—­ í›„ ë˜ëŠ” ì˜ì–´ì „ìš© ì„ë² ë”©
</span>    <span class="n">db</span><span class="p">.</span><span class="nf">insert_embeddings</span><span class="p">([</span> <span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nb">id</span><span class="p">,</span> <span class="n">vecs_m</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">vecs_en</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">vecs_en</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">))</span> <span class="p">])</span>
    <span class="n">db</span><span class="p">.</span><span class="nf">update_document_status</span><span class="p">(</span><span class="n">doc_id</span><span class="p">,</span> <span class="sh">'</span><span class="s">ready</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<ol>
  <li>ë¬¸ì„œ ìƒíƒœ ì¡°íšŒ/ì„¤ëª…</li>
</ol>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"describe_doc"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ë¬¸ì„œ ë©”íƒ€ë°ì´í„°ì™€ ì¸ë±ì‹± ìƒíƒœë¥¼ ì¡°íšŒí•œë‹¤."</span><span class="p">,</span><span class="w">
  </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"doc_id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"doc_id"</span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>ë°˜í™˜ì€ title, lang, tags, updated_at, status, chunk_count ë“±.</p>

<ol>
  <li>ì„ íƒì  ì¬ë¹Œë“œ</li>
</ol>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rebuild_index"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ë¬¸ì„œ ë˜ëŠ” ì „ì²´ ì»¬ë ‰ì…˜ì˜ ì¸ë±ìŠ¤ë¥¼ ì¬ìƒì„±í•œë‹¤."</span><span class="p">,</span><span class="w">
  </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"scope"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="nl">"enum"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"all"</span><span class="p">,</span><span class="s2">"doc"</span><span class="p">],</span><span class="w"> </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="s2">"doc"</span><span class="w"> </span><span class="p">},</span><span class="w">
      </span><span class="nl">"doc_id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"scope"</span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ol>
  <li>ì‚­ì œ</li>
</ol>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"purge_docs"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ë¬¸ì„œë¥¼ ì™„ì „íˆ ì‚­ì œí•œë‹¤(ì²­í¬, ì„ë² ë”© í¬í•¨)."</span><span class="p">,</span><span class="w">
  </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"doc_ids"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w"> </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"doc_ids"</span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ol>
  <li>ê²€ìƒ‰ íˆ´(ì•ì„œ ì •ì˜í•œ search_docs)<br />
í•„í„°ì— tags/lang/updated_after/acl í¬í•¨. top_docs, top_chunks_per_doc, final_chunksë¡œ í­ì„ ì œì–´.</li>
</ol>

<p>ê¶Œí•œ(ACL) ì²˜ë¦¬<br />
ê²€ìƒ‰ ì¿¼ë¦¬ì—ì„œ ë°˜ë“œì‹œ ë‹¤ìŒì„ ì ìš©.</p>

<ol>
  <li>
    <p>ë¡œê·¸ì¸ ìœ ì €ì˜ roles, user_idë¥¼ ë°›ì•„ documents.acl_roles/acl_usersì— ë§¤ì¹­</p>
  </li>
  <li>
    <p>í•„í„° ë‹¨ê³„ì—ì„œ ë¯¸ë¦¬ ì œì™¸</p>
  </li>
  <li>
    <p>ê°ì‚¬ ë¡œê·¸: ëˆ„ê°€ ì–´ë–¤ doc_idë¥¼ ê·¼ê±°ë¡œ ë³´ì•˜ëŠ”ì§€ ê¸°ë¡</p>
  </li>
</ol>

<p>ì„±ëŠ¥ íŒ</p>

<ol>
  <li>
    <p>í† í° ì˜ˆì‚° ìš°ì„ : final_chunksëŠ” 8~16 ì‚¬ì´, ì´ 4~8k í† í° ë‚´ì—ì„œ íŒ¨í‚¹</p>
  </li>
  <li>
    <p>ì¸ë±ìŠ¤ íŠœë‹: IVFFlat lists, probes ì¡°ì •. pgvectorì˜ SET ivfflat.probes=ê°’</p>
  </li>
  <li>
    <p>í•˜ì´ë¸Œë¦¬ë“œ: to_tsvector(simple)ë¡œ í‚¤ì›Œë“œ ì¸ë±ìŠ¤. ê³ ìœ ëª…ì‚¬/ìˆ«ì ê°•í™”</p>
  </li>
  <li>
    <p>ìºì‹±: ì¿¼ë¦¬â†’ìƒìœ„ doc_ids, chunk_ids ìºì‹œ. ì„ë² ë”© ê²°ê³¼ë„ ë©”ëª¨ë¦¬ ìºì‹œ</p>
  </li>
  <li>
    <p>ìµœì‹  ê°€ì¤‘ì¹˜: score = Î±Â·cosine + Î²Â·bm25 + Î³Â·recency_boost</p>
  </li>
</ol>

<p>ê°„ë‹¨ API íë¦„ ì˜ˆì‹œ</p>

<ol>
  <li>
    <p>í´ë¼ì´ì–¸íŠ¸ê°€ íŒŒì¼ ì—…ë¡œë“œ â†’ ë°±ì—”ë“œê°€ S3ì— ì €ì¥ í›„ upsert_documents í˜¸ì¶œ</p>
  </li>
  <li>
    <p>ì›Œì»¤ê°€ ì¸ë±ì‹± ì™„ë£Œ â†’ ë¬¸ì„œ status=ready</p>
  </li>
  <li>
    <p>ì‚¬ìš©ìê°€ ì§ˆë¬¸ â†’ search_docs í˜¸ì¶œ â†’ ì»¨í…ìŠ¤íŠ¸ì™€ citations ë°˜í™˜</p>
  </li>
  <li>
    <p>LLM í˜¸ì¶œ ì‹œ ì»¨í…ìŠ¤íŠ¸ ì‚½ì… â†’ í•œêµ­ì–´ ë‹µë³€ ìƒì„±</p>
  </li>
</ol>

<p>ì„œë²„ ì‚¬ì´ë“œ ì˜ì‚¬ì½”ë“œ ìŠ¤ë‹ˆí«<br />
ë¬¸ì„œ ì—…ì„œíŠ¸</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">upsert_documents</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">reindex</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
        <span class="n">doc_id</span> <span class="o">=</span> <span class="n">it</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">doc_id</span><span class="sh">"</span><span class="p">)</span> <span class="ow">or</span> <span class="nf">uuid4</span><span class="p">()</span>
        <span class="n">db</span><span class="p">.</span><span class="nf">upsert_document</span><span class="p">(</span>
            <span class="n">doc_id</span><span class="o">=</span><span class="n">doc_id</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="n">it</span><span class="p">[</span><span class="sh">"</span><span class="s">title</span><span class="sh">"</span><span class="p">],</span>
            <span class="n">source_uri</span><span class="o">=</span><span class="n">it</span><span class="p">[</span><span class="sh">"</span><span class="s">source_uri</span><span class="sh">"</span><span class="p">],</span>
            <span class="n">mime_type</span><span class="o">=</span><span class="n">it</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">mime_type</span><span class="sh">"</span><span class="p">),</span>
            <span class="n">lang</span><span class="o">=</span><span class="n">it</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">lang_hint</span><span class="sh">"</span><span class="p">),</span>
            <span class="n">tags</span><span class="o">=</span><span class="n">it</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">tags</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="n">acl_roles</span><span class="o">=</span><span class="n">it</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">acl_roles</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="n">acl_users</span><span class="o">=</span><span class="n">it</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">acl_users</span><span class="sh">"</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="n">status</span><span class="o">=</span><span class="sh">"</span><span class="s">processing</span><span class="sh">"</span> <span class="k">if</span> <span class="n">reindex</span> <span class="k">else</span> <span class="sh">"</span><span class="s">ready</span><span class="sh">"</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">reindex</span><span class="p">:</span>
            <span class="n">queue</span><span class="p">.</span><span class="nf">enqueue</span><span class="p">(</span><span class="sh">"</span><span class="s">worker_index_document</span><span class="sh">"</span><span class="p">,</span> <span class="n">doc_id</span><span class="o">=</span><span class="n">doc_id</span><span class="p">)</span>
        <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">doc_id</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">doc_id</span><span class="p">),</span> <span class="sh">"</span><span class="s">queued</span><span class="sh">"</span><span class="p">:</span> <span class="n">reindex</span><span class="p">})</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">items</span><span class="sh">"</span><span class="p">:</span> <span class="n">results</span><span class="p">}</span>
</code></pre></div></div>

<p>ê²€ìƒ‰ í•µì‹¬ ì¿¼ë¦¬(pgvector)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sql

-- ë‹¤êµ­ì–´ ì„ë² ë”©ìœ¼ë¡œ top N ì²­í¬
select c.chunk_id, c.doc_id, c.page, c.section, c.content,
       1 - (ce.emb_mtext &lt;=&gt; :qvec) as score
from chunk_embeddings ce
join chunks c on c.chunk_id = ce.chunk_id
join documents d on d.doc_id = c.doc_id
where d.status = 'ready'
  and (:lang is null or d.lang = :lang)
  and (:tags is null or d.tags &amp;&amp; :tags::text[])
  and (:user_id = any(d.acl_users) or array_length(d.acl_users,1) is null
       or :role &amp;&amp; d.acl_roles)
order by ce.emb_mtext &lt;=&gt; :qvec
limit :k;
</code></pre></div></div>

<p>ìš´ì˜ ì²´í¬ë¦¬ìŠ¤íŠ¸<br />
ë¬¸ì„œ ìƒíƒœ ì „ì´: ready â†” processing â†” error<br />
ì¤‘ë³µ ë°©ì§€: ê°™ì€ source_uri+hashë¡œ idempotent ì—…ì„œíŠ¸<br />
ê´€ì°°ì„±: ì¸ë±ì‹± ì‹œê°„, ì²­í¬ ìˆ˜, ì„ë² ë”© ì‹œê°„, ê²€ìƒ‰ ì§€ì—°, íˆíŠ¸ìœ¨ ì§€í‘œ ìˆ˜ì§‘<br />
ì¬í˜„ì„±: ì„ë² ë”© ëª¨ë¸ ë²„ì „ ì €ì¥. êµì²´ ì‹œ ë¡¤ë§ ì¬ì¸ë±ì‹±</p>

<p>ì •ë¦¬</p>

<ol>
  <li>
    <p>ë¬¸ì„œ ë©”íƒ€Â·ì²­í¬Â·ì„ë² ë”©ì„ RDBë¡œ ëª…í™•íˆ ë¶„ë¦¬í•˜ê³ , íŒŒì¼ì€ Object Storageì— ë‘”ë‹¤.</p>
  </li>
  <li>
    <p>FunctionToolë¡œ upsert/rebuild/describe/purge/searchë¥¼ ë…¸ì¶œí•´ LLMì´ í•„ìš”í•œ ìˆœê°„ì—ë§Œ í˜¸ì¶œí•˜ê²Œ í•œë‹¤.</p>
  </li>
  <li>
    <p>ë¹„ë™ê¸° ì›Œì»¤ë¥¼ ë‘ì–´ ì¸ë±ì‹±ì„ ì˜¤í”„ë¡œë“œí•œë‹¤.</p>
  </li>
  <li>
    <p>pgvector í•˜ë‚˜ë¡œë„ ì¶©ë¶„íˆ ë‹¨ë‹¨í•œ RAG DBë¥¼ ë§Œë“¤ ìˆ˜ ìˆë‹¤.</p>
  </li>
</ol>

<p>ë‹¤ìŒìœ¼ë¡œ ì›í•˜ì‹œë©´ ì´ ìŠ¤í‚¤ë§ˆë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì‹¤ì œ Python ì €ì¥ì†Œ ë ˆì´ì–´(ORM), ì›Œì»¤(Celery), ê·¸ë¦¬ê³  search_docs ë‚´ë¶€ SQLê¹Œì§€ ê½‚ì•„ ë„£ì€ ë¯¸ë‹ˆ ë ˆí¼ëŸ°ìŠ¤ë¥¼ ë§Œë“¤ì–´ì¤„ê²Œ.</p>

<p class="chat--user">

ì„ë² ë”© ë“±ì€ ê·¸ëƒ¥ ìœ ì €ì˜ ë¡œì»¬ íŒŒì¼ ì‹œìŠ¤í…œì— ì €ì¥í•œë‹¤ê³  ê°€ì •í•˜ì.

</p>

<p>ì¢‹ì•„. â€œì„ë² ë”©ê³¼ ì¸ë±ìŠ¤ê¹Œì§€ ëª¨ë‘ ë¡œì»¬ íŒŒì¼ ì‹œìŠ¤í…œì— ì €ì¥â€í•œë‹¤ëŠ” ê°€ì •ìœ¼ë¡œ, í’€ì‚¬ì´í´ ì¸í„°í˜ì´ìŠ¤ì™€ ë””ë ‰í„°ë¦¬ êµ¬ì¡°, íŒŒì¼ í¬ë§·, FunctionTool ì‹œê·¸ë‹ˆì²˜, ë™ì‘ ìŠ¤ì¼€ì¹˜ë¥¼ ì¡ì•„ì¤„ê²Œ. ì™¸ë¶€ DB ì—†ì´ë„ ë‹¨ë‹¨íˆ ëŒì•„ê°€ë„ë¡ ì„¤ê³„í–ˆì–´. í•„ìš” ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” pypdf/unstructured, sentence-transformers(or bge/e5), faiss, sqlite3 ì •ë„ë¡œ ê°€ì •í•œë‹¤.</p>

<p>ì„¤ê³„ ìš”ì•½</p>

<ol>
  <li>
    <p>ìŠ¤í† ë¦¬ì§€ ê³„ì¸µì€ ì „ë¶€ ë¡œì»¬ ë””ë ‰í„°ë¦¬. ì›ë³¸ íŒŒì¼ê³¼ íŒŒìƒ ì‚°ì¶œë¬¼(í…ìŠ¤íŠ¸, ì²­í¬, ì„ë² ë”©, ì¸ë±ìŠ¤)ì„ ê·œì¹™ì ìœ¼ë¡œ ì €ì¥.</p>
  </li>
  <li>
    <p>ë©”íƒ€ë°ì´í„°ëŠ” SQLite í•œ íŒŒì¼ë¡œ ê´€ë¦¬í•´ ì¡°íšŒÂ·í•„í„°Â·ACLê°€ ë¹ ë¦„. ëŒ€ì•ˆìœ¼ë¡œ JSONLë§Œ ì¨ë„ ë˜ì§€ë§Œ ê·œëª¨ê°€ ì»¤ì§€ë©´ ëŠë ¤ì§.</p>
  </li>
  <li>
    <p>ë²¡í„° ê²€ìƒ‰ì€ FAISSë¥¼ ì‚¬ìš©í•˜ê³  ì¸ë±ìŠ¤ íŒŒì¼ë¡œ ì˜ì†í™”. í‚¤ì›Œë“œ ê²€ìƒ‰ì€ SQLite FTS5ë¡œ ëŒ€ì²´.</p>
  </li>
  <li>
    <p>FunctionToolì€ ì—…ì„œíŠ¸, ì¬ì¸ë±ì‹±, ê²€ìƒ‰, ì„¤ëª…, ì‚­ì œê¹Œì§€ í•œ ì„¸íŠ¸ë¡œ ë…¸ì¶œ.</p>
  </li>
</ol>

<p>ë””ë ‰í„°ë¦¬ êµ¬ì¡° ì˜ˆì‹œ<br />
rag_store/<br />
blobs/ ì›ë³¸ íŒŒì¼ ë³´ê´€<br />
{doc_id}/{filename}<br />
texts/ í…ìŠ¤íŠ¸ ì¶”ì¶œ ìºì‹œ<br />
{doc_id}.txt<br />
chunks/ ì²­í¬ JSONL<br />
{doc_id}.jsonl [{"chunk_id","page","section","content","tokens"}â€¦]<br />
embeddings/ ì„ë² ë”© íŒŒì¼<br />
mtext/{doc_id}.npy float32 [num_chunks, dim]<br />
en/{doc_id}.npy ì„ íƒ: ì˜ì–´ ì „ìš©<br />
indices/ ì „ì²´ ì»¬ë ‰ì…˜ìš© ì¸ë±ìŠ¤<br />
faiss_mtext.index<br />
faiss_en.index<br />
manifest/ ë²„ì „Â·ëª¨ë¸ ì¶”ì <br />
embedding_manifest.json [{"model":"bge-m3","dim":1024,"built_at":â€¦}]<br />
locks/<br />
index.lock<br />
rag_meta.sqlite SQLite ë©”íƒ€DB(ë¬¸ì„œÂ·ì²­í¬Â·ACLÂ·FTS5)</p>

<p>SQLite ìŠ¤í‚¤ë§ˆ ìš”ì•½<br />
documents(doc_id pk, title, source_path, mime, lang, tags json, bytes, pages, status, acl_users json, acl_roles json, created_at, updated_at, embed_model_mtext, embed_model_en)<br />
chunks(chunk_id pk, doc_id fk, page, section, content, tokens)<br />
fts_chunks(content) USING FTS5(content, content='chunks', content_rowid='rowid')<br />
ì¸ë±ìŠ¤: documents(status, updated_at), chunks(doc_id)</p>

<p>FunctionTool ì¸í„°í˜ì´ìŠ¤</p>

<ol>
  <li>
    <p>upsert_documents<br />
name: upsert_documents<br />
description: ë¡œì»¬ íŒŒì¼ì„ ë“±ë¡í•˜ê³  ì¸ë±ì‹± ì¡ì„ íŠ¸ë¦¬ê±°í•œë‹¤.<br />
parameters:<br />
items: [{title, source_path, lang_hint?, tags?, acl_users?, acl_roles?, doc_id?}]<br />
reindex: boolean = true</p>
  </li>
  <li>
    <p>rebuild_index<br />
name: rebuild_index<br />
description: ì „ì²´ ë˜ëŠ” íŠ¹ì • ë¬¸ì„œì˜ ì„ë² ë”©Â·FAISS ì¸ë±ìŠ¤ë¥¼ ì¬ìƒì„±í•œë‹¤.<br />
parameters:<br />
scope: "all"|"doc"<br />
doc_id?: string<br />
which: "mtext"|"en"|"both" = "mtext"</p>
  </li>
  <li>
    <p>describe_doc<br />
name: describe_doc<br />
description: ë¬¸ì„œ ë©”íƒ€Â·ìƒíƒœÂ·ì²­í¬ ìˆ˜ë¥¼ ì¡°íšŒí•œë‹¤.<br />
parameters:<br />
doc_id: string</p>
  </li>
  <li>
    <p>purge_docs<br />
name: purge_docs<br />
description: ë¬¸ì„œë¥¼ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì™€ ë©”íƒ€DB, ì¸ë±ìŠ¤ì—ì„œ ì™„ì „ ì‚­ì œí•œë‹¤.<br />
parameters:<br />
doc_ids: string[]</p>
  </li>
  <li>
    <p>search_docs<br />
name: search_docs<br />
description: ì¿¼ë¦¬ì™€ í•„í„°ë¡œ ë¬¸ì„œ ìƒìœ„ N â†’ ì²­í¬ ìƒìœ„ K â†’ ì¬ë­í¬ í›„ ì»¨í…ìŠ¤íŠ¸ ë¹Œë“œ<br />
parameters:<br />
query: string<br />
filters?: { langs?: string[], tags?: string[], doc_ids?: string[], updated_after?: string }<br />
top_docs?: int = 10<br />
top_chunks_per_doc?: int = 5<br />
final_chunks?: int = 12<br />
max_context_tokens?: int = 6000<br />
use_hybrid?: boolean = true ë²¡í„° + FTS5<br />
use_mmr?: boolean = true<br />
use_reranker?: boolean = true í¬ë¡œìŠ¤ ì¸ì½”ë”ê°€ ìˆìœ¼ë©´ ì‚¬ìš©<br />
translate_query_to_en?: boolean = false</p>
  </li>
</ol>

<p>ì£¼ìš” ë™ì‘ ìŠ¤ì¼€ì¹˜</p>

<p>A) ì—…ì„œíŠ¸ì™€ ì¸ë±ì‹±</p>

<ol>
  <li>
    <p>upsert_documents(items):<br />
a. íŒŒì¼ ì¡´ì¬ í™•ì¸ â†’ rag_store/blobs/{doc_id}/ì— ë³µì‚¬<br />
b. rag_meta.sqliteì˜ documentsì— upsert, status='processing'<br />
c. ì¸ë±ì‹± ì›Œì»¤ íŠ¸ë¦¬ê±°(worker_index_document(doc_id))</p>
  </li>
  <li>
    <p>worker_index_document(doc_id):<br />
a. í…ìŠ¤íŠ¸ ì¶”ì¶œ â†’ rag_store/texts/{doc_id}.txt<br />
b. ì²­í¬ ìƒì„± â†’ rag_store/chunks/{doc_id}.jsonl ì €ì¥, chunks í…Œì´ë¸” êµì²´ ì‚½ì…<br />
c. ì„ë² ë”© ìƒì„± â†’ rag_store/embeddings/mtext/{doc_id}.npy ì €ì¥<br />
d. SQLite FTS5 ë™ê¸°í™”: chunksë¥¼ fts_chunksì— ì‚½ì…<br />
e. documents.status='ready', updated_at=now<br />
f. ê¸€ë¡œë²Œ FAISS ì¸ë±ìŠ¤ ê°±ì‹ : indices/faiss_mtext.index ë¡œë“œ â†’ add_with_ids â†’ ì €ì¥</p>
  </li>
</ol>

<p>B) ê²€ìƒ‰<br />
search_docs(query, â€¦):</p>

<ol>
  <li>
    <p>ì¿¼ë¦¬ ì „ì²˜ë¦¬ì™€ ì„ë² ë”© ì¤€ë¹„(í•„ìš”ì‹œ koâ†’en ë²ˆì—­)</p>
  </li>
  <li>
    <p>ë¬¸ì„œ ë ˆë²¨ í”„ë¦¬ì…€ë ‰ì…˜<br />
a. FTS5 ë¬¸ì„œ í›„ë³´: SELECT doc_id FROM fts_chunks WHERE fts_chunks MATCH ? LIMIT N_bm25<br />
b. FAISS í›„ë³´: ì¿¼ë¦¬ ì„ë² ë”©ìœ¼ë¡œ topN ì²­í¬ ê²€ìƒ‰ â†’ doc_id ì§‘ê³„ ìƒìœ„ N_vec<br />
c. ë‘ ê²°ê³¼ë¥¼ RRFë¡œ í•©ì³ ìƒìœ„ top_docs ë„ì¶œ</p>
  </li>
  <li>
    <p>ì²­í¬ ë ˆë²¨ ì •ë°€ ê²€ìƒ‰<br />
a. ì„ íƒ ë¬¸ì„œë³„ë¡œ top_chunks_per_docì”© FAISS ê²€ìƒ‰<br />
b. í•„ìš”ì‹œ FTS5 ê²°ê³¼ë„ ë³‘í•©<br />
c. MMRë¡œ ë‹¤ì–‘í™”, í¬ë¡œìŠ¤ ì¸ì½”ë” ì¬ë­í¬</p>
  </li>
  <li>
    <p>ì»¨í…ìŠ¤íŠ¸ íŒ¨í‚¹<br />
a. final_chunks ê°œìˆ˜ì™€ max_context_tokens ì•ˆì—ì„œ íŒ¨í‚¹<br />
b. citationsì— doc_id, title, page, section, score í¬í•¨</p>
  </li>
  <li>
    <p>ë°˜í™˜: {context, citations, diagnostics}</p>
  </li>
</ol>

<p>C) ì‚­ì œì™€ ì¬ì¸ë±ì‹±<br />
purge_docs: íŒŒì¼ ë””ë ‰í„°ë¦¬, í…ìŠ¤íŠ¸, ì²­í¬ jsonl, npy ì œê±° â†’ SQLiteì—ì„œ ë¬¸ì„œÂ·ì²­í¬ ì‚­ì œ â†’ FAISSì—ì„œ í•´ë‹¹ ID ì‚­ì œ í›„ ì €ì¥<br />
rebuild_index: scope='all'ì´ë©´ ì„ë² ë”©ê³¼ FAISSë¥¼ ì œë¡œë¶€í„° ë¦¬ë¹Œë“œ, whichë¡œ mtext/en ì„ íƒ</p>

<p>íŒŒì¼ í¬ë§·ê³¼ ì €ì¥ ë°©ì‹<br />
ì„ë² ë”© ì €ì¥: NumPy .npy, dtype=float32, shape=[num_chunks, dim]<br />
FAISS ì¸ë±ìŠ¤: IVF_FLAT ë˜ëŠ” HNSW. index.reset(); index.add_with_ids(vecs, global_ids) í›„ write_index<br />
ê¸€ë¡œë²Œ ID: 64-bit ì •ìˆ˜. ê¶Œì¥ ë§¤í•‘ì€ hash64("{doc_id}:{chunk_id}")ë¡œ ë§Œë“¤ê³  SQLiteì— gid ì»¬ëŸ¼ìœ¼ë¡œ ì €ì¥<br />
ì²­í¬ JSONL: í•œ ì¤„ì— í•œ ì²­í¬. ëŒ€ìš©ëŸ‰ append/replaceê°€ ì‰¬ì›Œ ìš´ì˜ ê°„ë‹¨</p>

<p>ê°„ë‹¨ ì½”ë“œ ìŠ¤ë‹ˆí«ë“¤</p>

<ol>
  <li>ì„ë² ë”© npy ì €ì¥/ë¡œë“œ<br />
import numpy as np</li>
</ol>

<p>def save_embeddings_npy(path, matrix):<br />
path.parent.mkdir(parents=True, exist_ok=True)<br />
np.save(path, matrix.astype(np.float32))</p>

<p>def load_embeddings_npy(path):<br />
return np.load(path).astype(np.float32)</p>

<ol>
  <li>FAISS ì¸ë±ìŠ¤ ë¡œë“œ/ì €ì¥/ê°±ì‹ <br />
import faiss<br />
from pathlib import Path</li>
</ol>

<p>def load_faiss(path, dim):<br />
if Path(path).exists():<br />
return faiss.read_index(str(path))<br />
index = faiss.index_factory(dim, "IVF4096,Flat", faiss.METRIC_INNER_PRODUCT)<br />
quantizer = faiss.IndexFlatIP(dim)<br />
index_ivf = faiss.IndexIVFFlat(quantizer, dim, 4096, faiss.METRIC_INNER_PRODUCT)<br />
return index if isinstance(index, faiss.Index) else index_ivf</p>

<p>def save_faiss(index, path):<br />
Path(path).parent.mkdir(parents=True, exist_ok=True)<br />
faiss.write_index(index, str(path))</p>

<p>def add_embeddings(index, vecs, ids):<br />
faiss.normalize_L2(vecs)<br />
if hasattr(index, "is_trained") and not index.is_trained:<br />
index.train(vecs)<br />
index.add_with_ids(vecs, ids)</p>

<ol>
  <li>SQLite FTS5 ì‚½ì…<br />
import sqlite3, json</li>
</ol>

<p>def upsert_chunks_sqlite(db_path, doc_id, chunks):<br />
conn = sqlite3.connect(db_path)<br />
c = conn.cursor()<br />
c.execute("DELETE FROM chunks WHERE doc_id=?", (doc_id,))<br />
for ch in chunks:<br />
c.execute("INSERT INTO chunks(chunk_id,doc_id,page,section,content,tokens) VALUES(?,?,?,?,?,?)",<br />
(ch["chunk_id"], doc_id, ch.get("page"), ch.get("section"), ch["content"], ch.get("tokens",0)))<br />
c.execute("INSERT INTO fts_chunks(rowid, content) SELECT rowid, content FROM chunks WHERE doc_id=?", (doc_id,))<br />
conn.commit()<br />
conn.close()</p>

<ol>
  <li>ê²€ìƒ‰ íŒŒì´í”„ë¼ì¸ í•µì‹¬<br />
def search_pipeline(query, top_docs=10, top_chunks_per_doc=5, final_chunks=12):</li>
</ol>

<h1 id="1-ì¿¼ë¦¬-ì„ë² ë”©">1) ì¿¼ë¦¬ ì„ë² ë”©</h1>

<p>q_vec = embed_mtext([query])[0].astype("float32")<br />
faiss.normalize_L2(q_vec.reshape(1,-1))</p>

<h1 id="2-ê¸€ë¡œë²Œ-ì²­í¬ì—ì„œ-topn-í›„ë³´">2) ê¸€ë¡œë²Œ ì²­í¬ì—ì„œ topN í›„ë³´</h1>

<p>D, I = faiss_index.search(q_vec.reshape(1,-1), 200)<br />
chunk_candidates = gather_chunks_by_ids(I[0], D[0]) # SQLiteì—ì„œ ë©”íƒ€ ë¡œë“œ</p>

<h1 id="3-ë¬¸ì„œ-ì§‘ê³„--ìƒìœ„-top_docs">3) ë¬¸ì„œ ì§‘ê³„ â†’ ìƒìœ„ top_docs</h1>

<p>doc_scores = aggregate_by_doc(chunk_candidates)<br />
doc_top = take_top(doc_scores, top_docs)</p>

<h1 id="4-ë¬¸ì„œë³„-ì¬ê²€ìƒ‰">4) ë¬¸ì„œë³„ ì¬ê²€ìƒ‰</h1>

<p>refined = []<br />
for d in doc_top:<br />
refined += search_chunks_in_doc(d.doc_id, q_vec, top_chunks_per_doc)<br />
refined = mmr_diversify(refined, k=final_chunks*4)<br />
ranked = rerank_cross_encoder(query, refined)[:final_chunks]</p>

<h1 id="5-ì»¨í…ìŠ¤íŠ¸-ë¹Œë“œ">5) ì»¨í…ìŠ¤íŠ¸ ë¹Œë“œ</h1>

<p>context, citations = build_context_and_citations(ranked)<br />
return {"context": context, "citations": citations}</p>

<p>ìš´ì˜Â·ì•ˆì „ í¬ì¸íŠ¸<br />
ë½í‚¹: indices/index.lock íŒŒì¼ë¡œ íŒŒì¼ ì ê¸ˆ í›„ ì¸ë±ìŠ¤ ì €ì¥.<br />
ì›ìì„±: ì¸ë±ìŠ¤ ì €ì¥ì€ tmpì— ì“´ ë’¤ renameìœ¼ë¡œ êµì²´.<br />
ë²„ì „ê´€ë¦¬: manifest/embedding_manifest.jsonì— ëª¨ë¸ëª…, ì°¨ì›, í† í°ë¼ì´ì € ë²„ì „ ê¸°ë¡.<br />
ê¶Œí•œ: documents.acl_users/acl_rolesë¥¼ ê²€ìƒ‰ ì „ í•„í„°ì— ë°˜ì˜.<br />
ë³µêµ¬: ì²­í¬ JSONL â†’ SQLite ì¬êµ¬ì¶•, npy â†’ FAISS ì¬ë¹Œë“œê°€ ê°€ëŠ¥í•˜ë„ë¡ ìœ ì§€.</p>

<p>ì¶”ì²œ ê¸°ë³¸ê°’<br />
embedding ëª¨ë¸: bge-m3, dim=1024<br />
ì²­í¬ í¬ê¸°: 200~400 í† í°, overlap 15%<br />
faiss nprobe: 8~32, IVF lists: 4096ë¶€í„° ì‹œì‘<br />
ê²€ìƒ‰ í­: top_docs=10, top_chunks_per_doc=5, final_chunks=12, max_context_tokens=6000<br />
í•˜ì´ë¸Œë¦¬ë“œ: use_hybrid=true, FTS5 ê°€ì¤‘ì¹˜ 0.3, ë²¡í„° 0.7</p>

<p>ì •ë¦¬<br />
ë¡œì»¬ íŒŒì¼ ì‹œìŠ¤í…œë§Œìœ¼ë¡œë„ ë¬¸ì„œ ë“±ë¡ë¶€í„° ì¸ë±ì‹±, ê²€ìƒ‰ê¹Œì§€ ì¶©ë¶„íˆ ì•ˆì •ì ì¸ RAG ìŠ¤í† ì–´ë¥¼ ë§Œë“¤ ìˆ˜ ìˆë‹¤. í•µì‹¬ì€ ê·œì¹™ì ì¸ ë””ë ‰í„°ë¦¬ êµ¬ì¡°, SQLite+FTS5ë¡œì˜ ë©”íƒ€Â·í‚¤ì›Œë“œ ì²˜ë¦¬, FAISS ì¸ë±ìŠ¤ì˜ ì•ˆì „ ì €ì¥, ê·¸ë¦¬ê³  FunctionTool ì„¸íŠ¸ë¥¼ í†µí•œ ì¼ê´€ëœ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ì´ë‹¤. ë‹¤ìŒ ë‹¨ê³„ë¡œ ì›í•˜ë©´ ì´ ìŠ¤í™ì„ ë°”ë¡œ ì‹¤í–‰ ê°€ëŠ¥í•œ ìµœì†Œ Python íŒ¨í‚¤ì§€ êµ¬ì¡°ì™€ CLIê¹Œì§€ í¬í•¨í•´ ë¼ˆëŒ€ ì½”ë“œë¥¼ ë§Œë“¤ì–´ì¤„ ìˆ˜ ìˆë‹¤.</p>

<p class="chat--user">

ìœ ì €ê°€ ì‚¬ìš©í•  ë• ì–´ë–¤ ìˆœì„œë¡œ í•´ì•¼í•´?

</p>

<p>ë‹¤ìŒ ìˆœì„œëŒ€ë¡œ ì“°ë©´ ë©ë‹ˆë‹¤. í•œ ë²ˆ ìµíˆë©´ íë¦„ì´ ëŠ˜ ê°™ìŠµë‹ˆë‹¤: ë“±ë¡ â†’ ì¸ë±ì‹± â†’ ê²€ìƒ‰ â†’ ë‹µë³€.</p>

<ol>
  <li>ìµœì´ˆ 1íšŒ ì„¤ì •</li>
</ol>

<ul>
  <li>
    <p>ë¡œì»¬ ë””ë ‰í„°ë¦¬ ì¤€ë¹„: rag_store/ í•˜ìœ„ì— blobs, texts, chunks, embeddings, indices, manifest, locksì™€ rag_meta.sqlite ìƒì„±.</p>
  </li>
  <li>
    <p>ì„ë² ë”©/ì¸ë±ìŠ¤ ì´ˆê¸°í™”: embedding ëª¨ë¸ ì„ íƒ(bge-m3 ë“±), FAISS ì¸ë±ìŠ¤ íŒŒì¼ ìƒì„±(indices/faiss_mtext.index).</p>
  </li>
</ul>

<ol>
  <li>ë¬¸ì„œ ë“±ë¡</li>
</ol>

<ul>
  <li>
    <p>íŒŒì¼ì„ ì¤€ë¹„í•˜ê³  upsert_documents í•¨ìˆ˜(ë˜ëŠ” API/CLI)ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.<br />
ì˜ˆì‹œ(Python/FunctionTool í˜¸ì¶œ íŒŒë¼ë¯¸í„°)<br />
{<br />
"items": [<br />
{<br />
"title": "spec_A.pdf",<br />
"source_path": "/path/spec_A.pdf",<br />
"lang_hint": "en",<br />
"tags": ["spec","v1"]<br />
}<br />
],<br />
"reindex": true<br />
}</p>
  </li>
  <li>
    <p>ë‚´ë¶€ ë™ì‘: íŒŒì¼ì„ blobs/{doc_id}/ë¡œ ë³µì‚¬í•˜ê³  documents í…Œì´ë¸”ì— ê¸°ë¡, status='processing', ì¸ë±ì‹± ì¡ì„ íì— ë„£ìŒ.</p>
  </li>
</ul>

<ol>
  <li>ì¸ë±ì‹± ìë™ ì²˜ë¦¬</li>
</ol>

<ul>
  <li>
    <p>ì›Œì»¤ê°€ í…ìŠ¤íŠ¸ ì¶”ì¶œ â†’ ì²­í¬ â†’ ì„ë² ë”©(npy) ì €ì¥ â†’ FAISS ì¸ë±ìŠ¤ ê°±ì‹  â†’ FTS5 ì—…ë°ì´íŠ¸ â†’ status='ready'ë¡œ ì „í™˜.</p>
  </li>
  <li>
    <p>í•„ìš”í•˜ë©´ describe_doc(doc_id)ë¡œ ìƒíƒœ í™•ì¸. ì²­í¬ ìˆ˜, í˜ì´ì§€ ìˆ˜, ì„ë² ë”© ëª¨ë¸ ë²„ì „ ë“±ì„ ë°”ë¡œ í™•ì¸ ê°€ëŠ¥.</p>
  </li>
</ul>

<ol>
  <li>ê²€ìƒ‰ê³¼ ì§ˆì˜ì‘ë‹µ</li>
</ol>

<ul>
  <li>
    <p>ì‚¬ìš©ìê°€ ì§ˆë¬¸ì„ ì…ë ¥í•˜ë©´, ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë¨¼ì € search_docsë¥¼ í˜¸ì¶œí•´ ì»¨í…ìŠ¤íŠ¸ë¥¼ í™•ë³´í•©ë‹ˆë‹¤.<br />
ê¶Œì¥ íŒŒë¼ë¯¸í„° ì˜ˆ:<br />
{<br />
"query": "ë°˜í’ˆ ì •ì±… í•µì‹¬ì´ ë­ì•¼?",<br />
"filters": { "langs": ["en"], "tags": ["policy"] },<br />
"top_docs": 10,<br />
"top_chunks_per_doc": 5,<br />
"final_chunks": 12,<br />
"use_hybrid": true,<br />
"use_mmr": true,<br />
"use_reranker": true,<br />
"max_context_tokens": 6000<br />
}</p>
  </li>
  <li>
    <p>search_docsê°€ ë°˜í™˜í•œ contextì™€ citationsë¥¼ LLMì— ë„£ì–´ ë‹µë³€ ìƒì„±.</p>
  </li>
  <li>
    <p>í•œê¸€ ì§ˆì˜ë¡œ ì˜ì–´ ë¬¸ì„œë¥¼ ì°¾ìœ¼ë ¤ë©´ ë‹¤êµ­ì–´ ì„ë² ë”© ë˜ëŠ” translate_query_to_en=trueë¥¼ ì‚¬ìš©.</p>
  </li>
</ul>

<ol>
  <li>ìš´ì˜ ì¤‘ ë¬¸ì„œ ì¶”ê°€/ê°±ì‹ </li>
</ol>

<ul>
  <li>
    <p>ìƒˆ íŒŒì¼ ì¶”ê°€: upsert_documents(items=[â€¦], reindex=true).</p>
  </li>
  <li>
    <p>ê¸°ì¡´ ë¬¸ì„œ êµì²´: ê°™ì€ doc_idë¡œ upsertí•˜ê±°ë‚˜ source_pathë¥¼ ì—…ë°ì´íŠ¸ í›„ reindex.</p>
  </li>
  <li>
    <p>ì—¬ëŸ¬ íŒŒì¼ ë°°ì¹˜ ë“±ë¡ë„ ë™ì¼. ìƒíƒœê°€ â€˜readyâ€™ê°€ ë˜ë©´ ë°”ë¡œ ê²€ìƒ‰ì— í¬í•¨ë©ë‹ˆë‹¤.</p>
  </li>
</ul>

<ol>
  <li>ì¬ì¸ë±ì‹±ê³¼ ì²­ì†Œ</li>
</ol>

<ul>
  <li>
    <p>ì„ë² ë”© ëª¨ë¸ êµì²´ë‚˜ ì²­í¬ ê·œì¹™ ë³€ê²½ ì‹œ rebuild_indexë¡œ ì „ì²´ ë˜ëŠ” íŠ¹ì • ë¬¸ì„œë¥¼ ì¬ë¹Œë“œ.<br />
{<br />
"scope": "all",<br />
"which": "mtext"<br />
}</p>
  </li>
  <li>
    <p>ë¬¸ì„œ ì‚­ì œëŠ” purge_docsë¡œ ì²˜ë¦¬. ë¡œì»¬ íŒŒì¼, í…ìŠ¤íŠ¸, ì²­í¬, ì„ë² ë”©, ë©”íƒ€DB, FAISS ì°¸ì¡°ê¹Œì§€ ì •ë¦¬.</p>
  </li>
</ul>

<ol>
  <li>ê¶Œí•œê³¼ í•„í„°ë§</li>
</ol>

<ul>
  <li>
    <p>ì‚¬ìš©ìë³„ë¡œ roles/user_idë¥¼ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì „ë‹¬í•˜ê³ , search_docsê°€ ACLì„ ë°˜ì˜í•´ í•„í„°ë§.</p>
  </li>
  <li>
    <p>íƒœê·¸, ì–¸ì–´, ìˆ˜ì •ì¼(updated_after)ë¡œ ê²€ìƒ‰ ë²”ìœ„ë¥¼ ì¤„ì—¬ ì§€ì—°ì„ ì•ˆì •í™”.</p>
  </li>
</ul>

<ol>
  <li>ì¥ì• /í’ˆì§ˆ ê´€ë¦¬ íŒ</li>
</ol>

<ul>
  <li>
    <p>status='error'ì¼ ë•Œ describe_docë¡œ ì—ëŸ¬ ë©”ì‹œì§€ í™•ì¸ í›„ ì¬ì‹œë„.</p>
  </li>
  <li>
    <p>ê²€ìƒ‰ í’ˆì§ˆ ì €í•˜ ì‹œ ì´ ìˆœì„œë¡œ ì ê²€: ì²­í¬ í¬ê¸°(200~400 í† í°), ì„ë² ë”© ëª¨ë¸ ì¼ì¹˜, í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ í™œì„±í™”, ë¦¬ë­ì»¤ ì ìš©, MMR ë‹¤ì–‘í™”, ìµœì‹  ê°€ì¤‘ì¹˜ ì ìš©.</p>
  </li>
  <li>
    <p>ì§€ì—°ì´ ëŠë¦¬ë©´ top_docs, top_chunks_per_doc, final_chunksë¥¼ ì¤„ì´ê³ , FAISS nprobe íŠœë‹.</p>
  </li>
</ul>

<p>ì‚¬ìš©ì ê²½í—˜ ê´€ì ì˜ ìµœì†Œ íë¦„(ì§„ì§œ ì‹¤ë¬´ìš© ì••ì¶•ë³¸)</p>

<ol>
  <li>
    <p>íŒŒì¼ ë“œë˜ê·¸Â·ë“œë¡­ ë˜ëŠ” ì—…ë¡œë“œ â†’ upsert_documents(reindex=true)</p>
  </li>
  <li>
    <p>ì ì‹œ í›„ ì¤€ë¹„ ì™„ë£Œ â†’ describe_docë¡œ ready í™•ì¸</p>
  </li>
  <li>
    <p>ì§ˆë¬¸ ì…ë ¥ â†’ ë°±ì—”ë“œê°€ search_docs í˜¸ì¶œ â†’ context ìˆ˜ì§‘</p>
  </li>
  <li>
    <p>LLM í˜¸ì¶œ â†’ í•œêµ­ì–´ ë‹µë³€ê³¼ ì¶œì²˜ í‘œì‹œ</p>
  </li>
  <li>
    <p>ì¶”ê°€ íŒŒì¼ì´ ìƒê¸°ë©´ 1ë¡œ ëŒì•„ê°</p>
  </li>
</ol>

<p>API/CLI ì˜ˆì‹œ í•œ ì¤„ì”©</p>

<ul>
  <li>
    <p>ë“±ë¡: cli upsert â€“path /docs/spec.pdf â€“title "spec" â€“lang en â€“tag spec â€“reindex</p>
  </li>
  <li>
    <p>ìƒíƒœ: cli describe â€“doc-id <uuid></uuid></p>
  </li>
  <li>
    <p>ê²€ìƒ‰: cli search â€“q "refund policy" â€“lang en â€“top-docs 10 â€“top-chunks 5</p>
  </li>
  <li>
    <p>ì¬ë¹Œë“œ: cli rebuild â€“scope all</p>
  </li>
  <li>
    <p>ì‚­ì œ: cli purge â€“doc-ids <uuid1>,<uuid2></uuid2></uuid1></p>
  </li>
</ul>

<p>ì´ íë¦„ì„ ì•±ì— ë…¹ì´ë©´ ìµœì¢… ì‚¬ìš©ìëŠ” â€œë¬¸ì„œ ì—…ë¡œë“œ â†’ ì§ˆë¬¸â€ë§Œ ì•Œë©´ ë˜ê³ , ë‚˜ë¨¸ì§€ ì „ì²˜ë¦¬Â·ê²€ìƒ‰Â·ì»¨í…ìŠ¤íŠ¸ íŒ¨í‚¹ì€ ë°±ì—”ë“œê°€ FunctionToolë¡œ ìˆ˜í–‰í•©ë‹ˆë‹¤. ë‹¤ìŒ ë‹¨ê³„ë¡œ ì›í•˜ë©´, ìœ„ ìˆœì„œë¥¼ ê·¸ëŒ€ë¡œ ìˆ˜í–‰í•˜ëŠ” REST ë¼ìš°íŠ¸ ë˜ëŠ” ê°„ë‹¨í•œ CLI ìŠ¤ì¼ˆë ˆí†¤ì„ ë§Œë“¤ì–´ ì¤„ê²Œ.</p>]]></content><author><name>hvppyarchive</name></author><category term="llm" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">ComfyUI Debug ë…¸ë“œ ë¦¬íŒ©í„°ë§</title><link href="https://hvppyarchive.github.io/comfyui/comfyui-debug-node-refactor/" rel="alternate" type="text/html" title="ComfyUI Debug ë…¸ë“œ ë¦¬íŒ©í„°ë§" /><published>2025-11-04T12:48:12+09:00</published><updated>2025-11-04T12:48:12+09:00</updated><id>https://hvppyarchive.github.io/comfyui/comfyui-debug-node-refactor</id><content type="html" xml:base="https://hvppyarchive.github.io/comfyui/comfyui-debug-node-refactor/"><![CDATA[<p class="chat--user">

ì´ê±° ë‚´ê°€ ê°œë°œí•œ ComfyUI ë…¸ë“œì•¼. ìŠ¤íŠ¸ë§ ì—¬ëŸ¬ ê°œê°€ ì…ë ¥ë˜ì—ˆì„ ë•Œ ì¸ë±ìŠ¤ ì„ íƒí•˜ëŠ” ì½¤ë³´ ìœ„ì ¯ + ì„ íƒëœ í…ìŠ¤íŠ¸ë¥¼ ë³´ì—¬ì£¼ëŠ” í…ìŠ¤íŠ¸ ìœ„ì ¯ìœ¼ë¡œ ë˜ì–´ ìˆì–´. 
<code class="language-plaintext highlighter-rouge">
js
import { app } from "../../scripts/app.js";
import { ComfyWidgets } from "../../scripts/widgets.js";

app.registerExtension({
    name: "hvppyflow.debug_nodes",
    async beforeRegisterNodeDef(nodeType, nodeData, app) {
        if (nodeData.name === "HFDebug") {
            const onExecuted = nodeType.prototype.onExecuted;
            nodeType.prototype.onExecuted = function (message) {
                onExecuted?.apply(this, arguments);

                this.properties.text = message["text"]

                let comboWidget = this.widgets &amp;&amp; this.widgets.find(w =&gt; w.name === "displayindex");
                let textWidget = this.widgets &amp;&amp; this.widgets.find(w =&gt; w.name === "displaytext");
                if (!comboWidget) {
                    comboWidget = this.addWidget("combo", "displayindex", 0, () =&gt; {
                        comboWidget.value = Math.min(comboWidget.value, comboWidget.options.values.length - 1);
                        textWidget.value = message["text"]?.[comboWidget.value];       
                    }, {values: Array.from({ length: message["text"].length }, (_, i) =&gt; i)});
                    comboWidget.value = 0;
                } 
                if (!textWidget) {
                    textWidget = ComfyWidgets["STRING"](this, "displaytext", ["STRING", { multiline: true }], app).widget;
                    textWidget.inputEl.readOnly = true;
                    textWidget.inputEl.style.border = "none";
                    textWidget.inputEl.style.backgroundColor = "transparent";
                    textWidget.serialize = false;
                    textWidget.options.serialize = false; // Prevent prompt serialization
                }
                
                if (comboWidget.options.values.length !== message["text"].length) {
                    comboWidget.options.values = Array.from({ length: message["text"].length }, (_, i) =&gt; i);
                    comboWidget.value = Math.min(comboWidget.value, comboWidget.options.values.length - 1);
                }
                textWidget.value = message["text"]?.[comboWidget.value];

                comboWidget.onChange = (data) =&gt; {
                    console.log("Combo changed" + comboWidget.value);
                    const index = comboWidget.value;
                    textWidget.value = message["text"]?.[index];
                };
            };

            const onConfigure = nodeType.prototype.onConfigure;
            nodeType.prototype.onConfigure = function () {
                onConfigure?.apply(this, arguments);
                
                let comboWidget = this.widgets &amp;&amp; this.widgets.find(w =&gt; w.name === "displayindex");
                let textWidget = this.widgets &amp;&amp; this.widgets.find(w =&gt; w.name === "displaytext");
                if (!comboWidget) {
                    comboWidget = this.addWidget("combo", "displayindex", 0, () =&gt; {
                        comboWidget.value = Math.min(comboWidget.value, comboWidget.options.values.length - 1);
                        textWidget.value = this.properties?.text?.[comboWidget.value];
                    }, {values: Array.from({ length: this.properties?.text.length ?? 0 }, (_, i) =&gt; i)});
                    comboWidget.value = 0;
                }
                if (!textWidget) {
                    textWidget = ComfyWidgets["STRING"](this, "displaytext", ["STRING", { multiline: true }], app).widget;
                    textWidget.inputEl.readOnly = true;
                    textWidget.inputEl.style.border = "none";
                    textWidget.inputEl.style.backgroundColor = "transparent";
                    textWidget.serialize = false;
                    textWidget.options.serialize = false; // Prevent prompt serialization
                }

                if (comboWidget.options.values.length !== this.properties?.text.length) {
                    comboWidget.options.values = Array.from({ length: this.properties?.text.length }, (_, i) =&gt; i);
                    comboWidget.value = Math.min(comboWidget.value, comboWidget.options.values.length - 1);
                }

                comboWidget.onChange = (data) =&gt; {
                    console.log("Combo changed" + comboWidget.value);
                    const index = comboWidget.value;
                    textWidget.value = this.properties?.text?.[index];
                };

                if (this.properties?.text) {
                    textWidget.value = this.properties?.text?.[comboWidget.value];
                }
            };
        }
    },
});
</code>
<code class="language-plaintext highlighter-rouge">python
class HFDebug:
    @classmethod
    def INPUT_TYPES(cls):
        return {
            "required": {
                "text": ("STRING", {"forceInput": True}),
            },
            "hidden": {
                "unique_id": "UNIQUE_ID",
            },
        }

    @classmethod
    def IS_CHANGED(cls, **kwargs):
        import logging
        logging.info("HPDebug - IS_CHANGED called with kwargs: %s", kwargs)
        text = kwargs.get("text")
        if isinstance(text, list):
            return tuple(text)
        return text

    INPUT_IS_LIST = True
    RETURN_TYPES = ("STRING",)
    FUNCTION = "notify"
    OUTPUT_NODE = True
    OUTPUT_IS_LIST = (True,)
    CATEGORY = "utils"

    def notify(self, text, unique_id=None):
        return {"ui": {"text": text}, "result": (text,)}
</code>

ì—¬ê¸°ì„œ string ë¦¬ìŠ¤íŠ¸ ê¸¸ì´ê°€ 1ì´ë©´ ì½¤ë³´ ìœ„ì ¯ì€ í—·ê°ˆê¸°ë§Œ í•˜ë‹ˆê¹Œ ê·¸ëƒ¥ ìƒì„±ì„ ì•ˆí•˜ë„ë¡ í•˜ê³  ì‹¶ì–´. ë‹¤ì–‘í•œ ë³€ìˆ˜ë¥¼ ê³ ë ¤í•´ì„œ ì‘ì„±í•´ì¤˜(ë¦¬ìŠ¤íŠ¸ ê¸¸ë‹¤ê°€ -&gt; 1ê°œë¡œ ì¤„ì–´ë“¤ ë•Œ, 1ê°œ ì˜€ë‹¤ê°€ ì—¬ëŸ¬ê°œê°€ ë  ë•Œ, ê¸¸ì´ê°€ ë³€í•  ë•Œ ë“±ë“±) ê·¸ë¦¬ê³  ë‚´ê°€ js ì´ˆë³´ìë¼ ì¢€ ì“¸ë° ì—†ì´ ì½”ë“œê°€ ê¸´ ê²ƒ ê°™ì€ë° ì •ë¦¬ë„ í•´ì£¼ë©´ ì¢‹ê² ì–´. ê·¸ë¦¬ê³  ë²„ê·¸ì¸ì§„ ëª¨ë¥´ê² ëŠ”ë° ë²„ê·¸ê°€ ìˆì–´. í™”ì‚´í‘œë¡œ ë„˜ê¸°ë©´ pageê°€ 1 -&gt; 2 ì´ëŸ° ì‹ìœ¼ë¡œ ë³€í•´ì•¼í•  ê²ƒ ê°™ì€ë° í•­ìƒ 0ìœ¼ë¡œ ëŒì•„ê°€. í´ë¦­í•´ì„œ ì½¤ë³´ ì„ íƒìœ¼ë¡œ ë„˜ê²¨ì•¼ë§Œ ì˜ ëŒì•„ê°€. ì´ ë²„ê·¸ë„ ê³ ì³ì£¼ë©´ ì¢‹ê² ì–´

</p>

<p>ì¢‹ì•„, ìš”êµ¬ì‚¬í•­ì„ ì „ë¶€ ë°˜ì˜í•´ì„œ JS ìª½ì„ ê¹”ë”í•˜ê²Œ ë¦¬íŒ©í„°ë§í•˜ê³ , â€œë¦¬ìŠ¤íŠ¸ ê¸¸ì´ = 1ì´ë©´ ì½¤ë³´ ìœ„ì ¯ì„ ë§Œë“¤ì§€ ì•Šê¸°â€, â€œê¸¸ì´ê°€ ëŠ˜ì—ˆë‹¤/ì¤„ì—ˆë‹¤/ë³€í–ˆë‹¤ ì¼€ì´ìŠ¤ ëª¨ë‘ ì²˜ë¦¬â€, â€œí‚¤ë³´ë“œ í™”ì‚´í‘œë¡œ ë°”ê¿€ ë•Œ 0ìœ¼ë¡œ ë˜ëŒì•„ê°€ëŠ” ë²„ê·¸â€ê¹Œì§€ ì¡ì€ ë²„ì „ì„ ì•„ë˜ì— ì œì‹œí• ê²Œ. í•µì‹¬ ì•„ì´ë””ì–´ëŠ” ë‹¤ìŒì´ì•¼.</p>

<ol>
  <li>
    <p>ì„ íƒ ì¸ë±ìŠ¤ë¥¼ this.properties.selectedIndexë¡œ ë³´ì¡´í•´ì„œ ì¬ì‹¤í–‰(onExecuted)Â·ì¬êµ¬ì„±(onConfigure) ì‹œì— ê°’ì´ ë®ì–´ì¨ì§€ì§€ ì•Šê²Œ í•¨.</p>
  </li>
  <li>
    <p>ì½¤ë³´ ìœ„ì ¯ì€ â€œí•„ìš”í•  ë•Œë§Œâ€ ë§Œë“¤ê³ (ê¸¸ì´ â‰¥ 2), ë¶ˆí•„ìš”í•˜ë©´ ì œê±°. ì œê±° ì‹œì— ì•ˆì „í•˜ê²Œ widgets ë°°ì—´ì—ì„œ ëº€ ë’¤ ë…¸ë“œ í¬ê¸° ì¬ê³„ì‚°.</p>
  </li>
  <li>
    <p>onChange ì•ˆì—ì„œ comboWidget.valueë¥¼ ë‹¤ì‹œ ê±´ë“œë¦¬ì§€ ì•ŠìŒ. ì‚¬ìš©ìê°€ í‚¤ë³´ë“œ/ë§ˆìš°ìŠ¤ë¡œ ë°”ê¾¼ ê°’ì„ ê·¸ëŒ€ë¡œ ì“°ê³ , ê·¸ ê°’ì„ propertiesì— ì €ì¥ë§Œ í•¨.</p>
  </li>
  <li>
    <p>ì˜µì…˜ ê¸¸ì´ê°€ ë°”ë€Œì–´ë„ í˜„ì¬ selectedIndexë¥¼ ìµœëŒ€ ê¸¸ì´-1ë¡œë§Œ í´ë¨í”„í•˜ê³ , êµ³ì´ 0ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŒ.</p>
  </li>
  <li>
    <p>ì…ë ¥ì´ string í•˜ë‚˜ì´ë“  listì´ë“  ì•ˆì „í•˜ê²Œ ì²˜ë¦¬(Array ë˜í•‘). ê¸¸ì´ 0ë„ ë°©ì–´.</p>
  </li>
</ol>

<p>ì•„ë˜ ì½”ë“œë¡œ êµì²´í•˜ë©´ ë¼.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

import { app } from "../../scripts/app.js";
import { ComfyWidgets } from "../../scripts/widgets.js";

app.registerExtension({
  name: "hvppyflow.debug_nodes",
  async beforeRegisterNodeDef(nodeType, nodeData, appInstance) {
    if (nodeData.name !== "HFDebug") return;

    // ---------- ìœ í‹¸: ì•ˆì „í•œ remove ----------
    function removeWidget(node, widget) {
      if (!node?.widgets || !widget) return;
      const idx = node.widgets.indexOf(widget);
      if (idx &gt;= 0) {
        node.widgets.splice(idx, 1);
        // LiteGraph/ComfyUIì—ì„œëŠ” í¬ê¸° ì¬ê³„ì‚°ì´ í•„ìš”í•¨
        if (typeof node.computeSize === "function") {
          node.size = node.computeSize();
        }
      }
    }

    // ---------- ìœ í‹¸: í…ìŠ¤íŠ¸ë¥¼ í•­ìƒ ë°°ì—´ë¡œ ----------
    function normalizeToArray(text) {
      if (Array.isArray(text)) return text;
      if (text === undefined || text === null) return [];
      return [text];
    }

    // ---------- ìœ í‹¸: í…ìŠ¤íŠ¸ ìœ„ì ¯ í™•ë³´ ----------
    function ensureTextWidget(node) {
      let textWidget = node.widgets?.find(w =&gt; w.name === "displaytext");
      if (!textWidget) {
        textWidget = ComfyWidgets["STRING"](node, "displaytext", ["STRING", { multiline: true }], appInstance).widget;
        textWidget.inputEl.readOnly = true;
        textWidget.inputEl.style.border = "none";
        textWidget.inputEl.style.backgroundColor = "transparent";
        textWidget.serialize = false;
        textWidget.options.serialize = false; // í”„ë¡¬í”„íŠ¸ ì§ë ¬í™” ë°©ì§€
      }
      return textWidget;
    }

    // ---------- ìœ í‹¸: ì½¤ë³´ ìœ„ì ¯ ë³´ì¥/ì—…ë°ì´íŠ¸ ë˜ëŠ” ì œê±° ----------
    function syncComboWidget(node, count) {
      let comboWidget = node.widgets?.find(w =&gt; w.name === "displayindex");

      // ê¸¸ì´ 0 ë˜ëŠ” 1ì´ë©´ ì½¤ë³´ ì œê±°
      if (count &lt;= 1) {
        if (comboWidget) removeWidget(node, comboWidget);
        return null;
      }

      // í•„ìš”: ì½¤ë³´ ìƒì„±
      if (!comboWidget) {
        comboWidget = node.addWidget(
          "combo",
          "displayindex",
          0,
          // ì½œë°±ì—ì„œëŠ” valueë¥¼ ë‹¤ì‹œ ì„¸íŒ…í•˜ì§€ ë§ê³ , properties/í…ìŠ¤íŠ¸ë§Œ ë™ê¸°í™”
          () =&gt; {
            const idx = Number(comboWidget.value) || 0;
            node.properties.selectedIndex = idx;
            const texts = normalizeToArray(node.properties.text);
            const textWidget = ensureTextWidget(node);
            textWidget.value = texts[idx] ?? "";
          },
          { values: Array.from({ length: count }, (_, i) =&gt; i) }
        );
        comboWidget.serialize = false; // í•„ìš”ì‹œ ì§ë ¬í™” ë°©ì§€
      }

      // ì˜µì…˜ ê¸¸ì´ ë³€ê²½ ë°˜ì˜
      const needUpdate =
        !comboWidget.options?.values ||
        comboWidget.options.values.length !== count;

      if (needUpdate) {
        comboWidget.options.values = Array.from({ length: count }, (_, i) =&gt; i);
      }

      // í˜„ì¬ ì„ íƒ ì¸ë±ìŠ¤ë¥¼ ë³´ì¡´/í´ë¨í”„
      const current = Number(node.properties.selectedIndex ?? comboWidget.value ?? 0);
      const clamped = Math.max(0, Math.min(current, count - 1));
      // ì‚¬ìš©ì í‚¤ì…ë ¥ì„ ë®ì–´ì“°ì§€ ì•Šê¸° ìœ„í•´ "í•„ìš”í•  ë•Œë§Œ" ë™ê¸°í™”
      if (comboWidget.value !== clamped) {
        comboWidget.value = clamped;
      }
      node.properties.selectedIndex = clamped;

      return comboWidget;
    }

    // ---------- ìœ í‹¸: í…ìŠ¤íŠ¸/ì½¤ë³´/ì„ íƒ ìƒíƒœ ë™ê¸°í™” ----------
    function syncUI(node, texts) {
      // í…ìŠ¤íŠ¸ë¥¼ propertiesì— ì €ì¥ (onConfigure ì¬êµ¬ì„±ìš©)
      node.properties.text = texts;

      // ì½¤ë³´ ìƒì„±/ì œê±°
      const comboWidget = syncComboWidget(node, texts.length);

      // í…ìŠ¤íŠ¸ ìœ„ì ¯ ë³´ì¥ ë° ê°’ ë°˜ì˜
      const textWidget = ensureTextWidget(node);
      const idx = Number(node.properties.selectedIndex ?? 0);
      const clamped = Math.max(0, Math.min(idx, Math.max(0, texts.length - 1)));
      node.properties.selectedIndex = clamped;
      textWidget.value = texts[clamped] ?? "";

      // onChangeëŠ” í•œ ë²ˆë§Œ ì„¤ì • (ì¤‘ë³µ ë“±ë¡ ë°©ì§€)
      if (comboWidget &amp;&amp; !comboWidget.__onChangeBound) {
        comboWidget.onChange = () =&gt; {
          const i = Number(comboWidget.value) || 0;
          node.properties.selectedIndex = i;
          textWidget.value = texts[i] ?? "";
        };
        comboWidget.__onChangeBound = true;
      }
    }

    // ---------- onExecuted ----------
    const prevOnExecuted = nodeType.prototype.onExecuted;
    nodeType.prototype.onExecuted = function (message) {
      prevOnExecuted?.apply(this, arguments);

      // ìµœì‹  ê²°ê³¼ ìˆ˜ì‹ 
      const texts = normalizeToArray(message?.text);

      // ê¸¸ì´ ë³€í™”(ëŠ˜ê±°ë‚˜/ì¤„ê±°ë‚˜/1ê°œê°€ ë¨/ì—¬ëŸ¬ ê°œê°€ ë¨)ë¥¼ ëª¨ë‘ ì»¤ë²„
      // ì„ íƒ ì¸ë±ìŠ¤ë¥¼ "í•„ìš” ì‹œ"ë§Œ í´ë¨í”„í•˜ì—¬ ë³´ì¡´
      if (this.properties.selectedIndex === undefined) {
        this.properties.selectedIndex = 0;
      }

      syncUI(this, texts);
    };

    // ---------- onConfigure ----------
    const prevOnConfigure = nodeType.prototype.onConfigure;
    nodeType.prototype.onConfigure = function () {
      prevOnConfigure?.apply(this, arguments);

      const texts = normalizeToArray(this.properties?.text);
      if (this.properties.selectedIndex === undefined) {
        this.properties.selectedIndex = 0;
      }

      syncUI(this, texts);
    };
  },
});
</code></pre></div></div>

<p>ë²„ê·¸ ì›ì¸ê³¼ í•´ê²° í¬ì¸íŠ¸ ì„¤ëª…</p>

<ol>
  <li>
    <p>ê°’ ë¦¬ì…‹ ìš”ì¸ ì œê±°<br />
ê¸°ì¡´ ì½”ë“œì—ì„œëŠ” ì½¤ë³´ ìƒì„± ì§í›„ comboWidget.value = 0 ê°™ì€ ê°•ì œ ì´ˆê¸°í™”ê°€ ìˆì—ˆê³ , addWidget ì½œë°±ì—ì„œ comboWidget.valueë¥¼ ë‹¤ì‹œ ì„¸íŒ…í•˜ëŠ” ë¡œì§ë„ ì„ì—¬ ìˆì–´ì„œ ì‚¬ìš©ìì˜ í‚¤ë³´ë“œ ë³€ê²½ ì§í›„ ì—¬ëŸ¬ ê²½ë¡œë¡œ ê°’ì´ ë®ì–´ì¨ì§ˆ ì—¬ì§€ê°€ ìˆì—ˆì–´. ìƒˆ ì½”ë“œëŠ” ì‚¬ìš©ì ì…ë ¥ íë¦„ì„ ì¡´ì¤‘í•´ â€œonChangeì—ì„œ propertiesì™€ í…ìŠ¤íŠ¸ë§Œ ë™ê¸°í™”â€í•˜ê³ , ì½¤ë³´ valueë¥¼ ì„ì˜ë¡œ ë‹¤ì‹œ ì“°ì§€ ì•Šì•„ í‚¤ë³´ë“œ(í™”ì‚´í‘œ) ì¡°ì‘ ì‹œ 0ìœ¼ë¡œ ë¦¬ì…‹ë˜ì§€ ì•Šì•„.</p>
  </li>
  <li>
    <p>ìƒíƒœì˜ ë‹¨ì¼ ì†ŒìŠ¤<br />
ì„ íƒ ì¸ë±ìŠ¤ë¥¼ this.properties.selectedIndexë¡œ í†µì¼í•´ì„œ onExecuted, onConfigure ì‚¬ì´ì—ì„œ ì¼ê´€ì„± ìˆê²Œ ìœ ì§€ë¼. ë°ì´í„° ê¸¸ì´ê°€ ë³€í•  ë•Œë„ selectedIndexë¥¼ ìµœëŒ€ ê¸¸ì´-1ë¡œë§Œ í´ë¨í”„í•˜ë‹ˆ ì‚¬ìš©ìê°€ ê³ ë¥¸ í˜ì´ì§€ê°€ ê°€ëŠ¥í•œ í•œ ìœ ì§€ë¼.</p>
  </li>
  <li>
    <p>ì½¤ë³´ ë™ì  ìƒì„±/ì œê±°<br />
texts.length â‰¤ 1ì´ë©´ ì½¤ë³´ë¥¼ ì œê±°í•˜ê³ , â‰¥ 2ì´ë©´ í•„ìš” ì‹œì—ë§Œ ìƒì„±í•´. ê¸¸ì´ê°€ 1â†’ì—¬ëŸ¬ ê°œ, ì—¬ëŸ¬ ê°œâ†’1, í˜¹ì€ Nì´ ë°”ë€ŒëŠ” ê²½ìš°ì—ë„ syncComboWidgetì´ ì•Œì•„ì„œ ì˜µì…˜/ì„ íƒ/ì œê±°ë¥¼ ì²˜ë¦¬í•´.</p>
  </li>
  <li>
    <p>ìœ„ì ¯ ì œê±° ì•ˆì „ì„±<br />
removeWidget ìœ í‹¸ë¡œ widgets ë°°ì—´ì—ì„œ ì•ˆì „í•˜ê²Œ ë¹¼ê³ , computeSizeë¥¼ í˜¸ì¶œí•´ì„œ ë…¸ë“œ ë ˆì´ì•„ì›ƒì´ ê¹¨ì§€ì§€ ì•Šë„ë¡ í–ˆì–´.</p>
  </li>
</ol>

<p>ì¶”ê°€ë¡œ ê³ ë ¤í•œ ì—£ì§€ ì¼€ì´ìŠ¤</p>

<ul>
  <li>
    <p>textê°€ ì•„ì˜ˆ ì˜¤ì§€ ì•Šê±°ë‚˜(null/undefined) ë¹ˆ ë¦¬ìŠ¤íŠ¸ì¼ ë•Œì—ë„ ë¹ˆ ë°°ì—´ë¡œ ì²˜ë¦¬í•˜ê³  í…ìŠ¤íŠ¸ ìœ„ì ¯ì—” ë¹ˆ ë¬¸ìì—´ í‘œì‹œ.</p>
  </li>
  <li>
    <p>ì½¤ë³´ ì˜µì…˜ì´ ê°±ì‹ ë  ë•Œ í˜„ì¬ ì„ íƒ ì¸ë±ìŠ¤ë¥¼ ìœ ì§€ ê°€ëŠ¥í•œ ë²”ìœ„ì—ì„œ ìœ ì§€(í´ë¨í”„ë§Œ ìˆ˜í–‰).</p>
  </li>
  <li>
    <p>ì§ë ¬í™” ë°©ì§€: í‘œì‹œìš© ìœ„ì ¯ë“¤ì€ serializeë¥¼ falseë¡œ ë‘¬ì„œ í”„ë¡¬í”„íŠ¸ì— ìƒˆëŠ” ê±¸ ë§‰ìŒ.</p>
  </li>
</ul>

<p>íŒŒì´ì¬ ìª½ì€ ê±´ë“œë¦´ í•„ìš” ì—†ì–´ ë³´ì´ì§€ë§Œ, í˜¹ì‹œ í…ìŠ¤íŠ¸ê°€ í•­ìƒ ë¦¬ìŠ¤íŠ¸ê°€ ë˜ê¸¸ ì›í•œë‹¤ë©´ notifyì—ì„œ ui ìª½ìœ¼ë¡œ í•­ìƒ listë¥¼ ì£¼ëŠ” ì§€ê¸ˆ êµ¬í˜„ì´ ì´ë¯¸ ì ì ˆí•´. IS_CHANGEDì—ì„œ ë¦¬ìŠ¤íŠ¸ë©´ íŠœí”Œë¡œ ë°”ê¿”ì£¼ëŠ” ê²ƒë„ ìºì‹œ ë¬´íš¨í™”ì— ë„ì›€ì´ ë˜ë‹ˆ ê·¸ëŒ€ë¡œ ë‘ë©´ ë¼.</p>

<p>ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ì–´ê°€ê¸°</p>

<ul>
  <li>
    <p>ì½¤ë³´ ëŒ€ì‹  ì¢Œìš° í™”ì‚´í‘œ ë²„íŠ¼(ë‘ ê°œì˜ push ë²„íŠ¼ ìœ„ì ¯)ì„ ì›í•˜ëŠ” ê²½ìš°ì—ë„ ê°™ì€ selectedIndexë¥¼ ì¨ì„œ ì‰½ê²Œ í™•ì¥ ê°€ëŠ¥í•´.</p>
  </li>
  <li>
    <p>í…ìŠ¤íŠ¸ê°€ ë§¤ìš° ê¸¸ë‹¤ë©´ í‘œì‹œìš© ìœ„ì ¯ ë†’ì´/ìë™ ì¤„ë°”ê¿ˆì„ ì¶”ê°€ë¡œ ì¡°ì ˆí•  ìˆ˜ ìˆì–´(style.whiteSpace, style.height ë“±).</p>
  </li>
</ul>

<p class="chat--user">

Array ì›ì†Œê°€ ìˆ«ìë¡œ ë˜ì–´ìˆìœ¼ë‹ˆ ì˜ ë™ì‘ì„ ì•ˆ í•˜ëŠ” ê²ƒ ê°™ì•„. ë¬¸ìì—´ë¡œ ë°”ê¿”ì¤˜

</p>

<p>ì¢‹ì•„. ì½¤ë³´ ì˜µì…˜ê³¼ valueë¥¼ ì „ë¶€ ë¬¸ìì—´ë¡œ ë°”ê¾¸ê³ , ë‚´ë¶€ ìƒíƒœëŠ” ìˆ«ìë¡œ ìœ ì§€í•˜ë„ë¡ ì •ë¦¬í–ˆì–´. í•µì‹¬ì€ ë‹¤ìŒ ë‘ ê°€ì§€ì•¼.</p>

<ol>
  <li>
    <p>UI ìª½(ì½¤ë³´)ì€ "ë¼ë²¨ ë¬¸ìì—´"ì„ ì‚¬ìš©í•œë‹¤. ì˜ˆ: "0", "1", "2"</p>
  </li>
  <li>
    <p>ë¡œì§ ìª½(í”„ë¡œí¼í‹° selectedIndex, ì¸ë±ì‹±)ì€ ìˆ«ìë¥¼ ì‚¬ìš©í•œë‹¤. ë³€í™˜ê¸°ëŠ” labelToIndex, indexToLabel ë‘ í•¨ìˆ˜ë¥¼ ì“´ë‹¤.</p>
  </li>
</ol>

<p>ì•„ë˜ ì½”ë“œëŠ” ì´ì „ì— ì¤€ ë¦¬íŒ©í„° ë²„ì „ì—ì„œ â€œë¬¸ìì—´ ë¼ë²¨â€ë§Œì„ ìœ„í•œ ë³€ê²½ì„ ë°˜ì˜í•œ ì™„ì„±ë³¸ì´ì•¼.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

import { app } from "../../scripts/app.js";
import { ComfyWidgets } from "../../scripts/widgets.js";

app.registerExtension({
  name: "hvppyflow.debug_nodes",
  async beforeRegisterNodeDef(nodeType, nodeData, appInstance) {
    if (nodeData.name !== "HFDebug") return;

    // ë¼ë²¨/ì¸ë±ìŠ¤ ë³€í™˜ê¸°
    const indexToLabel = (i) =&gt; String(i);
    const labelToIndex = (v) =&gt; {
      const n = parseInt(v, 10);
      return Number.isFinite(n) ? n : 0;
    };

    function removeWidget(node, widget) {
      if (!node?.widgets || !widget) return;
      const idx = node.widgets.indexOf(widget);
      if (idx &gt;= 0) {
        node.widgets.splice(idx, 1);
        if (typeof node.computeSize === "function") {
          node.size = node.computeSize();
        }
      }
    }

    function normalizeToArray(text) {
      if (Array.isArray(text)) return text;
      if (text === undefined || text === null) return [];
      return [text];
    }

    function ensureTextWidget(node) {
      let textWidget = node.widgets?.find(w =&gt; w.name === "displaytext");
      if (!textWidget) {
        textWidget = ComfyWidgets["STRING"](node, "displaytext", ["STRING", { multiline: true }], appInstance).widget;
        textWidget.inputEl.readOnly = true;
        textWidget.inputEl.style.border = "none";
        textWidget.inputEl.style.backgroundColor = "transparent";
        textWidget.serialize = false;
        textWidget.options.serialize = false;
      }
      return textWidget;
    }

    // countì— ë§ì¶° ì½¤ë³´ë¥¼ ìƒì„±/ì—…ë°ì´íŠ¸(ë¼ë²¨ì€ ë¬¸ìì—´), ë¶ˆí•„ìš”í•˜ë©´ ì œê±°
    function syncComboWidget(node, count) {
      let comboWidget = node.widgets?.find(w =&gt; w.name === "displayindex");

      if (count &lt;= 1) {
        if (comboWidget) removeWidget(node, comboWidget);
        return null;
      }

      if (!comboWidget) {
        comboWidget = node.addWidget(
          "combo",
          "displayindex",
          indexToLabel(0), // ë¬¸ìì—´ ë¼ë²¨ë¡œ ì´ˆê¸°ê°’
          () =&gt; {
            const idx = labelToIndex(comboWidget.value);
            node.properties.selectedIndex = idx;
            const texts = normalizeToArray(node.properties.text);
            const textWidget = ensureTextWidget(node);
            textWidget.value = texts[idx] ?? "";
          },
          { values: Array.from({ length: count }, (_, i) =&gt; indexToLabel(i)) }
        );
        comboWidget.serialize = false;
      }

      const needUpdate =
        !comboWidget.options?.values ||
        comboWidget.options.values.length !== count;

      if (needUpdate) {
        comboWidget.options.values = Array.from({ length: count }, (_, i) =&gt; indexToLabel(i));
      }

      const current = Number(node.properties.selectedIndex ?? 0);
      const clampedIdx = Math.max(0, Math.min(current, count - 1));
      const desiredLabel = indexToLabel(clampedIdx);

      if (comboWidget.value !== desiredLabel) {
        comboWidget.value = desiredLabel; // ì½¤ë³´ì—ëŠ” ë¬¸ìì—´ ë¼ë²¨ì„ ë„£ëŠ”ë‹¤
      }
      node.properties.selectedIndex = clampedIdx;

      return comboWidget;
    }

    function syncUI(node, texts) {
      node.properties.text = texts;

      const comboWidget = syncComboWidget(node, texts.length);

      const textWidget = ensureTextWidget(node);
      const idx = Number(node.properties.selectedIndex ?? 0);
      const clamped = Math.max(0, Math.min(idx, Math.max(0, texts.length - 1)));
      node.properties.selectedIndex = clamped;
      textWidget.value = texts[clamped] ?? "";

      if (comboWidget &amp;&amp; !comboWidget.__onChangeBound) {
        comboWidget.onChange = () =&gt; {
          const i = labelToIndex(comboWidget.value);
          node.properties.selectedIndex = i;
          textWidget.value = texts[i] ?? "";
        };
        comboWidget.__onChangeBound = true;
      }
    }

    const prevOnExecuted = nodeType.prototype.onExecuted;
    nodeType.prototype.onExecuted = function (message) {
      prevOnExecuted?.apply(this, arguments);

      const texts = normalizeToArray(message?.text);
      if (this.properties.selectedIndex === undefined) {
        this.properties.selectedIndex = 0;
      }

      syncUI(this, texts);
    };

    const prevOnConfigure = nodeType.prototype.onConfigure;
    nodeType.prototype.onConfigure = function () {
      prevOnConfigure?.apply(this, arguments);

      const texts = normalizeToArray(this.properties?.text);
      if (this.properties.selectedIndex === undefined) {
        this.properties.selectedIndex = 0;
      }

      syncUI(this, texts);
    };
  },
});
</code></pre></div></div>

<p>ë¬´ì—‡ì´ ë°”ë€Œì—ˆëŠ”ì§€ í•œ ì¤„ ìš”ì•½<br />
ì½¤ë³´ì˜ options.valuesì™€ valueë¥¼ ëª¨ë‘ ë¬¸ìì—´("0","1","2", â€¦)ë¡œ í†µì¼í–ˆê³ , ì„ íƒ ìƒíƒœëŠ” this.properties.selectedIndexì— ìˆ«ìë¡œ ì €ì¥ë˜ë©° labelToIndex/indexToLabelë¡œ ë³€í™˜í•´ ë™ê¸°í™”í•œë‹¤. ì´ë¡œì¨ ìˆ«ì ì›ì†Œ ë•Œë¬¸ì— ì„ íƒì´ ê¼¬ì´ëŠ” ë¬¸ì œì™€ í™”ì‚´í‘œ ì¡°ì‘ ì‹œ ë˜ëŒì•„ê°€ëŠ” ì¦ìƒ ëª¨ë‘ ë°©ì§€ëœë‹¤.</p>

<p>ë‹¤ìŒ í™•ì¥ ì•„ì´ë””ì–´<br />
ë¼ë²¨ì„ ë‹¨ìˆœ ìˆœë²ˆì´ ì•„ë‹ˆë¼ â€œ1 / Nâ€ ê°™ì€ ì‚¬ìš©ì ì¹œí™”í˜• ë¬¸ìì—´ë¡œ ë°”ê¾¸ê³  ì‹¶ë‹¤ë©´ indexToLabelì„ i =&gt; <code class="language-plaintext highlighter-rouge">${i+1} / ${count}</code> í˜•íƒœë¡œ ë°”ê¿”ë„ ëœë‹¤. ì´ë•ŒëŠ” labelToIndexë¥¼ í•´ë‹¹ í˜•ì‹ì— ë§ê²Œ íŒŒì‹±í•´ì£¼ë©´ ëœë‹¤.</p>

<p class="chat--user">

ì‘ ì‚¬ìš©ì ì¹œí™”ì ìœ¼ë¡œ ê°€ì. 1ë¶€í„° ì¸ë±ìŠ¤ë¡œ ê°€ê³  ë¶„ëª¨ë„ ì¨ì£¼ì. ë¼ë²¨ ì´ë¦„ë„ displayindex ëŒ€ì‹  page ë¡œ ë°”ê¾¸ì.

</p>

<p>ì¢‹ì§€. ì½¤ë³´ ë¼ë²¨ì„ â€œ1 / Nâ€ í˜•ì‹ìœ¼ë¡œ ë°”ê¾¸ê³ , ìœ„ì ¯ ì´ë¦„ë„ displayindex â†’ pageë¡œ ë³€ê²½í–ˆì–´. ë‚´ë¶€ ë¡œì§ì€ 0-based ìˆ«ì ì¸ë±ìŠ¤ë¥¼ ìœ ì§€í•˜ê³ , UIì™€ì˜ ê²½ê³„ì—ì„œë§Œ ë¬¸ìì—´ ë¼ë²¨ë¡œ ë³€í™˜í•´. ê¸°ì¡´ ë…¸ë“œì— displayindexê°€ ë‚¨ì•„ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ë§ˆì´ê·¸ë ˆì´ì…˜ìœ¼ë¡œ ë°œê²¬ ì¦‰ì‹œ ì œê±°í•˜ë„ë¡ ì²˜ë¦¬í–ˆì–´.</p>

<p>í•µì‹¬ ë³€ê²½ì  ìš”ì•½</p>

<ul>
  <li>
    <p>ì½¤ë³´ ë¼ë²¨: â€œ1 / Nâ€ (1ë¶€í„° ì‹œì‘, ì „ì²´ ê¸¸ì´ í‘œê¸°)</p>
  </li>
  <li>
    <p>ì½¤ë³´ ìœ„ì ¯ ì´ë¦„: page</p>
  </li>
  <li>
    <p>selectedIndexëŠ” ìˆ«ì(0-based)ë¡œ ìœ ì§€, ë¼ë²¨â†”ì¸ë±ìŠ¤ ë³€í™˜ê¸°ë¡œ ë™ê¸°í™”</p>
  </li>
  <li>
    <p>ê¸¸ì´ ë³€í™”, 1ê°œì¼ ë•Œ ì½¤ë³´ ì œê±°, í™”ì‚´í‘œ ì¡°ì‘ ì‹œ ê°’ ë¦¬ì…‹ ë°©ì§€ ê·¸ëŒ€ë¡œ ê³„ìŠ¹</p>
  </li>
</ul>

<p>êµì²´ ì½”ë“œ</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

import { app } from "../../scripts/app.js";
import { ComfyWidgets } from "../../scripts/widgets.js";

app.registerExtension({
  name: "hvppyflow.debug_nodes",
  async beforeRegisterNodeDef(nodeType, nodeData, appInstance) {
    if (nodeData.name !== "HFDebug") return;

    // ë¼ë²¨/ì¸ë±ìŠ¤ ë³€í™˜ê¸°: "k / N" â†” 0-based index
    const indexToLabel = (i, count) =&gt; `${i + 1} / ${count}`;
    const labelToIndex = (label) =&gt; {
      // "12 / 34" ê°™ì€ ë¬¸ìì—´ì—ì„œ ì²« ë²ˆì§¸ ìˆ«ìë§Œ ì¡ì•„ì„œ 1 ë¹¼ê¸°
      const m = String(label).match(/\d+/);
      const k = m ? parseInt(m[0], 10) : 1;
      const idx = Number.isFinite(k) ? k - 1 : 0;
      return Math.max(0, idx);
    };

    function removeWidget(node, widget) {
      if (!node?.widgets || !widget) return;
      const idx = node.widgets.indexOf(widget);
      if (idx &gt;= 0) {
        node.widgets.splice(idx, 1);
        if (typeof node.computeSize === "function") {
          node.size = node.computeSize();
        }
      }
    }

    function normalizeToArray(text) {
      if (Array.isArray(text)) return text;
      if (text === undefined || text === null) return [];
      return [text];
    }

    function ensureTextWidget(node) {
      let textWidget = node.widgets?.find(w =&gt; w.name === "displaytext");
      if (!textWidget) {
        textWidget = ComfyWidgets["STRING"](node, "displaytext", ["STRING", { multiline: true }], appInstance).widget;
        textWidget.inputEl.readOnly = true;
        textWidget.inputEl.style.border = "none";
        textWidget.inputEl.style.backgroundColor = "transparent";
        textWidget.serialize = false;
        textWidget.options.serialize = false;
      }
      return textWidget;
    }

    // countì— ë§ì¶° ì½¤ë³´(page)ë¥¼ ìƒì„±/ì—…ë°ì´íŠ¸(ë¼ë²¨ì€ "1 / N"), ë¶ˆí•„ìš”í•˜ë©´ ì œê±°
    function syncComboWidget(node, count) {
      // êµ¬ë²„ì „(displayindex) ì”ì¡´ ì‹œ ì œê±° (ë§ˆì´ê·¸ë ˆì´ì…˜)
      const legacy = node.widgets?.find(w =&gt; w.name === "displayindex");
      if (legacy) removeWidget(node, legacy);

      let comboWidget = node.widgets?.find(w =&gt; w.name === "page");

      if (count &lt;= 1) {
        if (comboWidget) removeWidget(node, comboWidget);
        return null;
      }

      const values = Array.from({ length: count }, (_, i) =&gt; indexToLabel(i, count));

      if (!comboWidget) {
        comboWidget = node.addWidget(
          "combo",
          "page",
          values[0],
          () =&gt; {
            const idx = labelToIndex(comboWidget.value);
            node.properties.selectedIndex = idx;
            const texts = normalizeToArray(node.properties.text);
            const textWidget = ensureTextWidget(node);
            textWidget.value = texts[idx] ?? "";
          },
          { values }
        );
        comboWidget.serialize = false;
      } else {
        // ì˜µì…˜ ê¸¸ì´ ë³€ê²½ ë°˜ì˜
        const needUpdate = !comboWidget.options?.values ||
                           comboWidget.options.values.length !== count ||
                           comboWidget.options.values[0] !== values[0];
        if (needUpdate) comboWidget.options.values = values;
      }

      // í˜„ì¬ ì„ íƒ ì¸ë±ìŠ¤ ìœ ì§€(í´ë¨í”„) í›„ ë¼ë²¨ê³¼ ë™ê¸°í™”
      const current = Number(node.properties.selectedIndex ?? 0);
      const clampedIdx = Math.max(0, Math.min(current, count - 1));
      const desiredLabel = indexToLabel(clampedIdx, count);

      if (comboWidget.value !== desiredLabel) comboWidget.value = desiredLabel;
      node.properties.selectedIndex = clampedIdx;

      return comboWidget;
    }

    function syncUI(node, texts) {
      node.properties.text = texts;

      const comboWidget = syncComboWidget(node, texts.length);

      const textWidget = ensureTextWidget(node);
      const idx = Number(node.properties.selectedIndex ?? 0);
      const clamped = Math.max(0, Math.min(idx, Math.max(0, texts.length - 1)));
      node.properties.selectedIndex = clamped;
      textWidget.value = texts[clamped] ?? "";

      if (comboWidget &amp;&amp; !comboWidget.__onChangeBound) {
        comboWidget.onChange = () =&gt; {
          const i = labelToIndex(comboWidget.value);
          const cl = Math.max(0, Math.min(i, texts.length - 1));
          node.properties.selectedIndex = cl;
          comboWidget.value = indexToLabel(cl, texts.length); // ë¶ˆì¼ì¹˜ ì‹œ êµì •
          textWidget.value = texts[cl] ?? "";
        };
        comboWidget.__onChangeBound = true;
      }
    }

    const prevOnExecuted = nodeType.prototype.onExecuted;
    nodeType.prototype.onExecuted = function (message) {
      prevOnExecuted?.apply(this, arguments);

      const texts = normalizeToArray(message?.text);
      if (this.properties.selectedIndex === undefined) this.properties.selectedIndex = 0;

      syncUI(this, texts);
    };

    const prevOnConfigure = nodeType.prototype.onConfigure;
    nodeType.prototype.onConfigure = function () {
      prevOnConfigure?.apply(this, arguments);

      const texts = normalizeToArray(this.properties?.text);
      if (this.properties.selectedIndex === undefined) this.properties.selectedIndex = 0;

      syncUI(this, texts);
    };
  },
});
</code></pre></div></div>

<p>ì‘ë™ ë°©ì‹ ì„¤ëª…</p>

<ul>
  <li>
    <p>UI ë¼ë²¨ì€ í•­ìƒ â€œí˜„ì¬í˜ì´ì§€(1-based) / ì „ì²´ê¸¸ì´â€ ë¬¸ìì—´ë¡œ ë³´ì—¬ì£¼ê³ , ë‚´ë¶€ ìƒíƒœëŠ” 0-based ìˆ«ì ì¸ë±ìŠ¤ selectedIndexì— ì €ì¥í•œë‹¤.</p>
  </li>
  <li>
    <p>ê¸¸ì´ê°€ 1 ì´í•˜ê°€ ë˜ë©´ page ì½¤ë³´ëŠ” ì œê±°ëœë‹¤. 1â†’ì—¬ëŸ¬ ê°œ, ì—¬ëŸ¬ ê°œâ†’1, ê¸¸ì´ ì¦ê° ëª¨ë‘ ìë™ ë°˜ì˜ëœë‹¤.</p>
  </li>
  <li>
    <p>í™”ì‚´í‘œ ì¡°ì‘ ì‹œ onChangeê°€ ë¬¸ìì—´ ë¼ë²¨ì„ ì¸ë±ìŠ¤ë¡œ ë³€í™˜í•´ selectedIndexë¥¼ ì—…ë°ì´íŠ¸í•˜ê³ , í•„ìš”í•˜ë©´ ë¼ë²¨ì„ ì¬ë™ê¸°í™”í•´ ê°’ ì¼ê´€ì„±ì„ ìœ ì§€í•œë‹¤.</p>
  </li>
  <li>
    <p>êµ¬ë²„ì „ displayindex ìœ„ì ¯ì´ ì´ë¯¸ ë¶™ì–´ìˆë˜ ë…¸ë“œë„ ì•ˆì „í•˜ê²Œ ì œê±°í•´ í˜¼ì¬ ë¬¸ì œë¥¼ ë°©ì§€í•œë‹¤.</p>
  </li>
</ul>

<p>ì¶”ê°€ íŒ</p>

<ul>
  <li>ë¼ë²¨ í¬ë§·ì„ ë°”ê¾¸ê³  ì‹¶ìœ¼ë©´ indexToLabelë§Œ ìˆ˜ì •í•˜ë©´ ëœë‹¤. ì˜ˆ: <code class="language-plaintext highlighter-rouge">${i+1} / ${count} (${texts[i].slice(0,10)}â€¦)</code>ì²˜ëŸ¼ ì¼ë¶€ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°ê¹Œì§€ ì²¨ë¶€ ê°€ëŠ¥.</li>
</ul>

<p class="chat--user">

ì•„ ê·¸ë¦¬ê³  page ì½¤ë³´ ìœ„ì ¯ì€ í…ìŠ¤íŠ¸ ìœ„ì— ì˜¤ë©´ ë³´ê¸°ê°€ ë” ì¢‹ì„ ê²ƒ ê°™ì•„. (1 í˜ì´ì§€ë©´ ì•„ì–˜ ì—†ëŠ” ê²ƒì€ ë™ì¼)

</p>

<p>ì¢‹ì§€. â€œpage ì½¤ë³´ë¥¼ í…ìŠ¤íŠ¸ ìœ„ì—â€ ë³´ì´ë„ë¡ ìœ„ì ¯ ìˆœì„œë¥¼ ì¬ë°°ì—´í•˜ëŠ” ìœ í‹¸ì„ ì¶”ê°€í•´ ì •ë¦¬í–ˆì–´. 1í˜ì´ì§€(ê¸¸ì´ â‰¤ 1)ì¼ ë• ì½¤ë³´ë¥¼ ë§Œë“¤ì§€ ì•ŠëŠ” ê¸°ì¡´ ë™ì‘ë„ ê·¸ëŒ€ë¡œ ìœ ì§€ë¼.</p>

<p>í•µ í¬ì¸íŠ¸</p>

<ol>
  <li>
    <p>widgets ë°°ì—´ì—ì„œ pageê°€ displaytextë³´ë‹¤ í•­ìƒ ì•ì— ì˜¤ë„ë¡ ì¬ë°°ì¹˜.</p>
  </li>
  <li>
    <p>ì½¤ë³´ ìƒì„±/ì œê±°, ê¸¸ì´ ë³€í™”, í™”ì‚´í‘œ ì¡°ì‘, 1í˜ì´ì§€ ì‹œ ì œê±° ë¡œì§ì€ ì´ì „ ë²„ì „ê³¼ ë™ì¼.</p>
  </li>
  <li>
    <p>êµ¬ë²„ì „(displayindex) ì”ì¡´ ìœ„ì ¯ì€ ê°ì§€ ì¦‰ì‹œ ì œê±°.</p>
  </li>
</ol>

<p>êµì²´ ì½”ë“œ</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

import { app } from "../../scripts/app.js";
import { ComfyWidgets } from "../../scripts/widgets.js";

app.registerExtension({
  name: "hvppyflow.debug_nodes",
  async beforeRegisterNodeDef(nodeType, nodeData, appInstance) {
    if (nodeData.name !== "HFDebug") return;

    // "1 / N" ë¼ë²¨ â†” 0-based index
    const indexToLabel = (i, count) =&gt; `${i + 1} / ${count}`;
    const labelToIndex = (label) =&gt; {
      const m = String(label).match(/\d+/);
      const k = m ? parseInt(m[0], 10) : 1;
      const idx = Number.isFinite(k) ? k - 1 : 0;
      return Math.max(0, idx);
    };

    function removeWidget(node, widget) {
      if (!node?.widgets || !widget) return;
      const idx = node.widgets.indexOf(widget);
      if (idx &gt;= 0) {
        node.widgets.splice(idx, 1);
        if (typeof node.computeSize === "function") node.size = node.computeSize();
      }
    }

    function normalizeToArray(text) {
      if (Array.isArray(text)) return text;
      if (text === undefined || text === null) return [];
      return [text];
    }

    function ensureTextWidget(node) {
      let textWidget = node.widgets?.find(w =&gt; w.name === "displaytext");
      if (!textWidget) {
        textWidget = ComfyWidgets["STRING"](node, "displaytext", ["STRING", { multiline: true }], appInstance).widget;
        textWidget.inputEl.readOnly = true;
        textWidget.inputEl.style.border = "none";
        textWidget.inputEl.style.backgroundColor = "transparent";
        textWidget.serialize = false;
        textWidget.options.serialize = false;
      }
      return textWidget;
    }

    // page ì½¤ë³´ë¥¼ ìƒì„±/ì—…ë°ì´íŠ¸(ë¼ë²¨ "1 / N"), ë¶ˆí•„ìš” ì‹œ ì œê±°
    function syncComboWidget(node, count) {
      // êµ¬ë²„ì „(displayindex) ì œê±°
      const legacy = node.widgets?.find(w =&gt; w.name === "displayindex");
      if (legacy) removeWidget(node, legacy);

      let comboWidget = node.widgets?.find(w =&gt; w.name === "page");

      if (count &lt;= 1) {
        if (comboWidget) removeWidget(node, comboWidget);
        return null;
      }

      const values = Array.from({ length: count }, (_, i) =&gt; indexToLabel(i, count));

      if (!comboWidget) {
        comboWidget = node.addWidget(
          "combo",
          "page",
          values[0],
          () =&gt; {
            const idx = labelToIndex(comboWidget.value);
            node.properties.selectedIndex = idx;
            const texts = normalizeToArray(node.properties.text);
            const textWidget = ensureTextWidget(node);
            textWidget.value = texts[idx] ?? "";
          },
          { values }
        );
        comboWidget.serialize = false;
      } else {
        const needUpdate =
          !comboWidget.options?.values ||
          comboWidget.options.values.length !== count ||
          comboWidget.options.values[0] !== values[0];
        if (needUpdate) comboWidget.options.values = values;
      }

      const current = Number(node.properties.selectedIndex ?? 0);
      const clampedIdx = Math.max(0, Math.min(current, count - 1));
      const desiredLabel = indexToLabel(clampedIdx, count);

      if (comboWidget.value !== desiredLabel) comboWidget.value = desiredLabel;
      node.properties.selectedIndex = clampedIdx;

      return comboWidget;
    }

    // pageê°€ displaytext ìœ„ë¡œ ì˜¤ë„ë¡ ì¬ë°°ì¹˜
    function ensureOrderPageAboveText(node) {
      if (!node?.widgets) return;
      const pageIdx = node.widgets.findIndex(w =&gt; w.name === "page");
      const textIdx = node.widgets.findIndex(w =&gt; w.name === "displaytext");
      if (pageIdx === -1 || textIdx === -1) return;
      if (pageIdx &gt; textIdx) {
        const [w] = node.widgets.splice(pageIdx, 1);
        node.widgets.splice(textIdx, 0, w);
        if (typeof node.computeSize === "function") node.size = node.computeSize();
      }
    }

    function syncUI(node, texts) {
      node.properties.text = texts;

      const comboWidget = syncComboWidget(node, texts.length);
      const textWidget = ensureTextWidget(node);

      // ìˆœì„œ ì •ë¦¬: page -&gt; displaytext
      ensureOrderPageAboveText(node);

      const idx = Number(node.properties.selectedIndex ?? 0);
      const clamped = Math.max(0, Math.min(idx, Math.max(0, texts.length - 1)));
      node.properties.selectedIndex = clamped;
      textWidget.value = texts[clamped] ?? "";

      if (comboWidget &amp;&amp; !comboWidget.__onChangeBound) {
        comboWidget.onChange = () =&gt; {
          const i = labelToIndex(comboWidget.value);
          const cl = Math.max(0, Math.min(i, texts.length - 1));
          node.properties.selectedIndex = cl;
          comboWidget.value = indexToLabel(cl, texts.length);
          textWidget.value = texts[cl] ?? "";
        };
        comboWidget.__onChangeBound = true;
      }
    }

    const prevOnExecuted = nodeType.prototype.onExecuted;
    nodeType.prototype.onExecuted = function (message) {
      prevOnExecuted?.apply(this, arguments);
      const texts = normalizeToArray(message?.text);
      if (this.properties.selectedIndex === undefined) this.properties.selectedIndex = 0;
      syncUI(this, texts);
    };

    const prevOnConfigure = nodeType.prototype.onConfigure;
    nodeType.prototype.onConfigure = function () {
      prevOnConfigure?.apply(this, arguments);
      const texts = normalizeToArray(this.properties?.text);
      if (this.properties.selectedIndex === undefined) this.properties.selectedIndex = 0;
      syncUI(this, texts);
    };
  },
});
</code></pre></div></div>

<p>ë™ì‘ íë¦„ ìš”ì•½</p>

<ol>
  <li>
    <p>onExecuted/onConfigureì—ì„œ í…ìŠ¤íŠ¸ ë°°ì—´ì„ ì •ê·œí™”.</p>
  </li>
  <li>
    <p>ê¸¸ì´ì— ë§ì¶° page ì½¤ë³´ë¥¼ ìƒì„±/ì—…ë°ì´íŠ¸(1í˜ì´ì§€ë©´ ì œê±°), displaytextëŠ” í•­ìƒ ìœ ì§€.</p>
  </li>
  <li>
    <p>ensureOrderPageAboveTextë¡œ pageê°€ displaytextë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ ì¬ë°°ì—´.</p>
  </li>
  <li>
    <p>ì„ íƒ ì¸ë±ìŠ¤ëŠ” properties.selectedIndexë¡œ ì¼ê´€ ê´€ë¦¬, UI ë¼ë²¨ì€ â€œ1 / Nâ€ ë¬¸ìì—´ë¡œ í‘œì‹œ.</p>
  </li>
  <li>
    <p>í‚¤ë³´ë“œ/ë§ˆìš°ìŠ¤ ì¡°ì‘ ì‹œ ë¼ë²¨â†’ì¸ë±ìŠ¤ ë³€í™˜ìœ¼ë¡œ ë™ê¸°í™”í•˜ë©° ë¦¬ì…‹ ë¬¸ì œ ì—†ìŒ.</p>
  </li>
</ol>

<p>ë” ë‹¤ë“¬ê³  ì‹¶ë‹¤ë©´ í…ìŠ¤íŠ¸ ìœ„ì ¯ ë†’ì´, ìë™ ì¤„ë°”ê¿ˆ, í”„ë¦¬ë·° ê¸¸ì´ ë“±ì„ ì˜µì…˜ìœ¼ë¡œ ë…¸ì¶œí•´ë„ ì¢‹ë‹¤.</p>]]></content><author><name>hvppyarchive</name></author><category term="comfyui" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">Python Tool ì‘ì„±</title><link href="https://hvppyarchive.github.io/llm/python-systemfile-tools/" rel="alternate" type="text/html" title="Python Tool ì‘ì„±" /><published>2025-10-31T11:43:50+09:00</published><updated>2025-10-31T11:43:50+09:00</updated><id>https://hvppyarchive.github.io/llm/python-systemfile-tools</id><content type="html" xml:base="https://hvppyarchive.github.io/llm/python-systemfile-tools/"><![CDATA[<p class="chat--user">

Python Tool ì‘ì„±ì„ í•´ë³´ì. OpenAI Agentì—ì„œ ì‚¬ìš©í•  Toolì„ ë§Œë“¤ê³  ì‹¶ì–´. ë„ˆê°€ ë§Œë“¤ì–´ì¤€ Toolì— agents.function_tool decoratorë¥¼ ë¶™ì¼ê±°ë‹ˆê¹ ë‚´ë¶€ documentationê³¼ Annotationì´ ëœ ìƒíƒœë¡œ ë˜ë©´ ì¢‹ê² ì–´. ê·¸ëŸ°ë° root í´ë”ëŠ” ìì²´ì ìœ¼ë¡œ root_dir ë¡œ ì§€ì •ì„ í•´ì„œ ê·¸ì— ë”°ë¼ ë§Œë“¤ì–´ì„œ ë‚˜ê°€ê²Œ í•˜ê³  ì‹¶ì–´. File System ê´€ë ¨ íˆ´ë“¤ - list_files - read_file - save_file ë§Œ ì¼ë‹¨ ë§Œë“¤ì–´ì¤˜. 

</p>

<p>ì¢‹ì•„. ì•„ë˜ëŠ” OpenAI Agentì—ì„œ ë°”ë¡œ ì“¸ ìˆ˜ ìˆê²Œ <code class="language-plaintext highlighter-rouge">@agents.function_tool</code> ë°ì½”ë ˆì´í„°ë¥¼ ë¶™ì¸, ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ë¥¼ ê³ ì •í•´ì„œ ë™ì‘í•˜ëŠ” íŒŒì¼ ì‹œìŠ¤í…œ íˆ´ 3ì¢… ì„¸íŠ¸ì•¼. ê²½ë¡œ íƒˆì¶œ(<code class="language-plaintext highlighter-rouge">..</code>)ì„ ë§‰ê³ , ë°”ì´ë„ˆë¦¬/í…ìŠ¤íŠ¸ ëª¨ë‘ ì•ˆì „í•˜ê²Œ ë‹¤ë£° ìˆ˜ ìˆë„ë¡ ì„¤ê³„í–ˆì–´.</p>

<p>ê°„ë‹¨í•œ ì„¤ê³„ ìš”ì•½ (í•œ ì¤„ì”©):</p>

<ol>
  <li>
    <p>ëª¨ë“ˆ ì „ì—­ì˜ <code class="language-plaintext highlighter-rouge">ROOT_DIR</code>ë¡œ ì‘ì—… ë£¨íŠ¸ë¥¼ ê³ ì •í•˜ê³ , ëª¨ë“  ì…ì¶œë ¥ì€ ì—¬ê¸°ì— ìƒëŒ€ ê²½ë¡œë¡œë§Œ ì ‘ê·¼.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">_resolve_safe()</code>ì—ì„œ <code class="language-plaintext highlighter-rouge">Path.resolve()</code>ë¡œ ì •ê·œí™”í•œ ë’¤ <code class="language-plaintext highlighter-rouge">is_relative_to</code>ë¡œ ë£¨íŠ¸ ë‚´ ê²½ë¡œì¸ì§€ ê²€ì¦.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">list_files</code>ëŠ” ì¬ê·€/ê¸€ë¡­/ìˆ¨ê¹€íŒŒì¼ í¬í•¨ ì—¬ë¶€, ìµœëŒ€ ê°œìˆ˜ ì œí•œì„ ì œê³µ.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">read_file</code>ì€ í…ìŠ¤íŠ¸ ë˜ëŠ” ë°”ì´ë„ˆë¦¬(ë² ì´ìŠ¤64) ë°˜í™˜ì„ ì„ íƒ ê°€ëŠ¥. íŒŒì¼ í¬ê¸° ìƒí•œ(<code class="language-plaintext highlighter-rouge">max_bytes</code>)ìœ¼ë¡œ ê³¼ë„í•œ ì½ê¸° ë°©ì§€.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">save_file</code>ì€ í…ìŠ¤íŠ¸/ë² ì´ìŠ¤64 ì“°ê¸°, ìƒìœ„ í´ë” ìë™ ìƒì„±, ë®ì–´ì“°ê¸° ê°€ë“œ ì œê³µ.</p>
  </li>
  <li>
    <p>ëª¨ë“  í•¨ìˆ˜ëŠ” í’ë¶€í•œ íƒ€ì… íŒíŠ¸ì™€ ë…ìŠ¤íŠ¸ë§ì„ í¬í•¨í•˜ê³ , JSON ì§ë ¬í™” ê°€ëŠ¥í•œ ê²°ê³¼ë¥¼ ë°˜í™˜.</p>
  </li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="n">base64</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">asdict</span><span class="p">,</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1"># ì´ ëª¨ë“ˆì´ ë¶ˆë¦¬ëŠ” ì‹œì ì— ê¸°ë³¸ root ì„¤ì • (í•„ìš”í•˜ë©´ set_root_dirë¡œ ì¬ì„¤ì •)
</span><span class="n">ROOT_DIR</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">.</span><span class="nf">cwd</span><span class="p">()</span> <span class="o">/</span> <span class="sh">"</span><span class="s">agent_root</span><span class="sh">"</span>
<span class="n">ROOT_DIR</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">set_root_dir</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ë¥¼ ì„¤ì •í•œë‹¤. ëª¨ë“  íˆ´ì€ ì´ ë””ë ‰í„°ë¦¬ í•˜ìœ„ì—ì„œë§Œ ë™ì‘í•œë‹¤.

    Parameters
    ----------
    path : str | Path
        ì‘ì—… ë£¨íŠ¸ë¡œ ì‚¬ìš©í•  ë””ë ‰í„°ë¦¬ ê²½ë¡œ.

    Returns
    -------
    str
        ì •ê·œí™”ëœ ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ì˜ ì ˆëŒ€ ê²½ë¡œ ë¬¸ìì—´.
    </span><span class="sh">"""</span>
    <span class="k">global</span> <span class="n">ROOT_DIR</span>
    <span class="n">ROOT_DIR</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">ROOT_DIR</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">relpath</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ ë‚´ë¶€ì˜ ì•ˆì „í•œ ì ˆëŒ€ ê²½ë¡œë¥¼ ê³„ì‚°í•œë‹¤.
    ê²½ë¡œ íƒˆì¶œ(../ ë“±)ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ resolve í›„ ROOT_DIR í•˜ìœ„ì¸ì§€ ê²€ì‚¬í•œë‹¤.
    </span><span class="sh">"""</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">ROOT_DIR</span> <span class="o">/</span> <span class="nc">Path</span><span class="p">(</span><span class="n">relpath</span><span class="p">)).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Python 3.9+: Path.is_relative_to ì§€ì›. ë¯¸ì§€ì› í™˜ê²½ ëŒ€ë¹„ ìˆ˜ë™ ì²´í¬.
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_relative_to</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">):</span>  <span class="c1"># type: ignore[attr-defined]
</span>            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Path escapes ROOT_DIR</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">AttributeError</span><span class="p">:</span>
        <span class="c1"># ìˆ˜ë™ êµ¬í˜„
</span>        <span class="k">if</span> <span class="n">ROOT_DIR</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span><span class="p">.</span><span class="n">parents</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">ROOT_DIR</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Path escapes ROOT_DIR</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">FileEntry</span><span class="p">:</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_path</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">FileEntry</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">t</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span> <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_file</span><span class="p">()</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="nc">FileEntry</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">)),</span> <span class="nb">type</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>

<span class="c1"># ===== OpenAI Agent Tool Definitions =====
# í”„ë ˆì„ì›Œí¬ì— ë”°ë¼ import ê²½ë¡œê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ. ì˜ˆ:
# from openai import agents
# ì—¬ê¸°ì„œëŠ” ì‚¬ìš©ìê°€ ë§í•œ ë°ì½”ë ˆì´í„° ì´ë¦„ì„ ê·¸ëŒ€ë¡œ ì“´ë‹¤.
</span><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">agents</span>  <span class="c1"># type: ignore
</span><span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>  <span class="c1"># ëŸ°íƒ€ì„ í™˜ê²½ì—ì„œ ë°ì½”ë ˆì´í„°ê°€ ì—†ì„ ìˆ˜ ìˆìœ¼ë‹ˆ ëŒ€ì²´ ì •ì˜
</span>    <span class="k">class</span> <span class="nc">_NoopDecorator</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">function_tool</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">fn</span>
            <span class="k">return</span> <span class="n">wrapper</span>
    <span class="n">agents</span> <span class="o">=</span> <span class="nf">_NoopDecorator</span><span class="p">()</span>  <span class="c1"># type: ignore
</span>
<span class="nd">@agents.function_tool</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">list_files</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">ë£¨íŠ¸ ë””ë ‰í„°ë¦¬(root_dir) ê¸°ì¤€ìœ¼ë¡œ íŒŒì¼/í´ë” ëª©ë¡ì„ ê°€ì ¸ì˜¨ë‹¤. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">ì¬ê·€ íƒìƒ‰, ê¸€ë¡­ íŒ¨í„´, ìˆ¨ê¹€íŒŒì¼ í¬í•¨ ì—¬ë¶€, ìµœëŒ€ ê°œìˆ˜ ì œí•œì„ ì§€ì›í•œë‹¤.</span><span class="sh">"</span>
    <span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">list_files</span><span class="p">(</span>
    <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">glob</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">recursive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="n">include_hidden</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="n">max_items</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    íŒŒì¼/í´ë” ëª©ë¡ ì¡°íšŒ.

    Parameters
    ----------
    relative_path : str, default=</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="s">
        ROOT_DIR ê¸°ì¤€ ì‹œì‘ ê²½ë¡œ.
    glob : str | None, default=None
        ê¸€ë¡­ íŒ¨í„´ (ì˜ˆ: </span><span class="sh">"</span><span class="s">*.py</span><span class="sh">"</span><span class="s">). Noneì´ë©´ ì „ì²´.
    recursive : bool, default=True
        í•˜ìœ„ í´ë” ì¬ê·€ íƒìƒ‰ ì—¬ë¶€.
    include_hidden : bool, default=False
        ì (.)ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ìˆ¨ê¹€ í•­ëª© í¬í•¨ ì—¬ë¶€.
    max_items : int | None, default=None
        ë°˜í™˜ í•­ëª© ìµœëŒ€ ê°œìˆ˜. Noneì´ë©´ ì œí•œ ì—†ìŒ.

    Returns
    -------
    dict
        {
          </span><span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">&lt;ROOT_DIR&gt;</span><span class="sh">"</span><span class="s">,
          </span><span class="sh">"</span><span class="s">base</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">&lt;relative_path&gt;</span><span class="sh">"</span><span class="s">,
          </span><span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="s">: &lt;int&gt;,
          </span><span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="s">: [{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">file|dir</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="s">: &lt;int|null&gt;}, ...]
        }

    Notes
    -----
    - ëª¨ë“  ê²½ë¡œëŠ” ROOT_DIR í•˜ìœ„ë¡œ ì œí•œëœë‹¤.
    - ê²½ë¡œ íƒˆì¶œì´ ê°ì§€ë˜ë©´ ValueErrorë¥¼ ë°œìƒì‹œí‚¨ë‹¤.
    </span><span class="sh">"""</span>
    <span class="n">base</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">relative_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">base</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">relative_path</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="p">:</span> <span class="p">[],</span>
            <span class="sh">"</span><span class="s">warning</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Base path does not exist.</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="c1"># í›„ë³´ ê²½ë¡œ ì´í„°ë ˆì´ì…˜
</span>    <span class="k">def</span> <span class="nf">iter_paths</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">glob</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">**/</span><span class="si">{</span><span class="n">glob</span><span class="si">}</span><span class="sh">"</span> <span class="k">if</span> <span class="n">recursive</span> <span class="k">else</span> <span class="n">glob</span>
            <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
                <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">rglob</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">iterdir</span><span class="p">()</span>

    <span class="n">entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FileEntry</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nf">iter_paths</span><span class="p">():</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">include_hidden</span> <span class="ow">and</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="n">base</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="c1"># ROOT_DIR ë²”ìœ„ ì¬í™•ì¸ (ì‹¬ë³¼ë¦­ ë§í¬ ë“± ëŒ€ë¹„)
</span>        <span class="n">safe_p</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">))</span>
        <span class="n">entries</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">FileEntry</span><span class="p">.</span><span class="nf">from_path</span><span class="p">(</span><span class="n">safe_p</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">max_items</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_items</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">base</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">relative_path</span><span class="p">)),</span>
        <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">entries</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="nf">asdict</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="nd">@agents.function_tool</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">read_file</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">ë£¨íŠ¸ ë””ë ‰í„°ë¦¬(root_dir) ê¸°ì¤€ ê²½ë¡œì˜ íŒŒì¼ì„ ì½ëŠ”ë‹¤. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">í…ìŠ¤íŠ¸(encoding ì‚¬ìš©) ë˜ëŠ” ë°”ì´ë„ˆë¦¬(Base64) ëª¨ë“œë¡œ ë°˜í™˜í•  ìˆ˜ ìˆë‹¤.</span><span class="sh">"</span>
    <span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">read_file</span><span class="p">(</span>
    <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">max_bytes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    íŒŒì¼ ì½ê¸°.

    Parameters
    ----------
    relative_path : str
        ROOT_DIR ê¸°ì¤€ íŒŒì¼ ê²½ë¡œ.
    mode : {</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="s">}, default=</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s">
        </span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s">ëŠ” ë¬¸ìì—´ë¡œ ë°˜í™˜(encoding ì‚¬ìš©), </span><span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="s">ëŠ” Base64 ë¬¸ìì—´ë¡œ ë°˜í™˜.
    encoding : str, default=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="s">
        í…ìŠ¤íŠ¸ ëª¨ë“œì—ì„œ ì‚¬ìš©í•  ì¸ì½”ë”©.
    max_bytes : int | None, default=2*1024*1024
        ì½ê¸° ìµœëŒ€ ë°”ì´íŠ¸. Noneì´ë©´ ì œí•œ ì—†ìŒ.

    Returns
    -------
    dict
        í…ìŠ¤íŠ¸ ëª¨ë“œ:
          {</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="s">: &lt;int&gt;, </span><span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">&lt;str&gt;</span><span class="sh">"</span><span class="s">}
        ë°”ì´ë„ˆë¦¬ ëª¨ë“œ:
          {</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="s">: &lt;int&gt;, </span><span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">content_b64</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">&lt;str&gt;</span><span class="sh">"</span><span class="s">}

    Raises
    ------
    FileNotFoundError
        ëŒ€ìƒ íŒŒì¼ì´ ì—†ì„ ë•Œ.
    IsADirectoryError
        ë””ë ‰í„°ë¦¬ë¥¼ ì½ìœ¼ë ¤ í•  ë•Œ.
    ValueError
        ê²½ë¡œ íƒˆì¶œ ë“± ë³´ì•ˆ ìœ„ë°˜.
    </span><span class="sh">"""</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">relative_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
        <span class="k">raise</span> <span class="nc">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File not found: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
        <span class="k">raise</span> <span class="nc">IsADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Path is a directory: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">size</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span>
    <span class="k">if</span> <span class="n">max_bytes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">max_bytes</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File too large (</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s"> bytes) &gt; max_bytes=</span><span class="si">{</span><span class="n">max_bytes</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">)),</span> <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span> <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">content</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_bytes</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">)),</span>
            <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">content_b64</span><span class="sh">"</span><span class="p">:</span> <span class="n">base64</span><span class="p">.</span><span class="nf">b64encode</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">ascii</span><span class="sh">"</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">mode must be </span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>

<span class="nd">@agents.function_tool</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">save_file</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">ë£¨íŠ¸ ë””ë ‰í„°ë¦¬(root_dir) ê¸°ì¤€ ê²½ë¡œì— íŒŒì¼ì„ ì €ì¥í•œë‹¤. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">í…ìŠ¤íŠ¸(encoding) ë˜ëŠ” Base64 ë°”ì´ë„ˆë¦¬ë¥¼ ì§€ì›í•˜ê³ , </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">ë®ì–´ì“°ê¸°/ìƒìœ„ ê²½ë¡œ ìë™ ìƒì„± ì˜µì…˜ì„ ì œê³µí•œë‹¤.</span><span class="sh">"</span>
    <span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">save_file</span><span class="p">(</span>
    <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">content_b64</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="n">create_parents</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    íŒŒì¼ ì €ì¥.

    Parameters
    ----------
    relative_path : str
        ROOT_DIR ê¸°ì¤€ ì €ì¥ ê²½ë¡œ.
    content : str | None, default=None
        í…ìŠ¤íŠ¸ ëª¨ë“œì—ì„œ ì €ì¥í•  ë¬¸ìì—´. mode=</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s">ì¼ ë•Œ í•„ìš”.
    content_b64 : str | None, keyword-only, default=None
        ë°”ì´ë„ˆë¦¬ ëª¨ë“œì—ì„œ ì €ì¥í•  Base64 ë¬¸ìì—´. mode=</span><span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="s">ì¼ ë•Œ í•„ìš”.
    mode : {</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="s">}, default=</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s">
        ì €ì¥ ëª¨ë“œ.
    encoding : str, default=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="s">
        í…ìŠ¤íŠ¸ ëª¨ë“œ ì¸ì½”ë”©.
    overwrite : bool, default=False
        Trueë©´ ê¸°ì¡´ íŒŒì¼ì„ ë®ì–´ì“´ë‹¤. Falseë©´ ê¸°ì¡´ íŒŒì¼ì´ ìˆìœ¼ë©´ ì˜ˆì™¸ ë°œìƒ.
    create_parents : bool, default=True
        ìƒìœ„ ë””ë ‰í„°ë¦¬ë¥¼ ìë™ ìƒì„±í• ì§€ ì—¬ë¶€.

    Returns
    -------
    dict
        {</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="s">: &lt;int&gt;, </span><span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="s">text|binary</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">created</span><span class="sh">"</span><span class="s">: &lt;bool&gt;, </span><span class="sh">"</span><span class="s">overwrote</span><span class="sh">"</span><span class="s">: &lt;bool&gt;}

    Raises
    ------
    IsADirectoryError
        ë””ë ‰í„°ë¦¬ ê²½ë¡œì— íŒŒì¼ì„ ì“°ë ¤ í•  ë•Œ.
    FileExistsError
        overwrite=Falseì´ê³  íŒŒì¼ì´ ì´ë¯¸ ì¡´ì¬í•  ë•Œ.
    ValueError
        ì˜ëª»ëœ ëª¨ë“œ/ì…ë ¥ ë˜ëŠ” ê²½ë¡œ íƒˆì¶œ ë“± ë³´ì•ˆ ìœ„ë°˜.
    </span><span class="sh">"""</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">relative_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
        <span class="k">raise</span> <span class="nc">IsADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Path is a directory: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">create_parents</span><span class="p">:</span>
        <span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">created</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">FileExistsError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File already exists (overwrite=False): </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">content is required when mode=</span><span class="sh">'</span><span class="s">text</span><span class="sh">'"</span><span class="p">)</span>
        <span class="n">p</span><span class="p">.</span><span class="nf">write_text</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">content_b64</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">content_b64 is required when mode=</span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">content_b64</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">"</span><span class="s">ascii</span><span class="sh">"</span><span class="p">))</span>
        <span class="n">p</span><span class="p">.</span><span class="nf">write_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">mode must be </span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>

    <span class="n">size</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">)),</span>
        <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="n">mode</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">created</span><span class="sh">"</span><span class="p">:</span> <span class="n">created</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">overwrote</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="ow">not</span> <span class="n">created</span><span class="p">),</span>
    <span class="p">}</span>

<span class="c1"># ì‚¬ìš© ì˜ˆì‹œ (Agent ì™¸ë¶€ ì´ˆê¸°í™” ì½”ë“œ)
# set_root_dir("./workspace")  # í•„ìš” ì‹œ ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ ì§€ì •
# list_files(relative_path=".", glob="*.py", recursive=True)
# save_file("docs/readme.txt", content="hello", overwrite=True)
# read_file("docs/readme.txt", mode="text")
</span></code></pre></div></div>

<p>ì—°ë™ íŒ:</p>

<ul>
  <li>
    <p>ì—ì´ì „íŠ¸ ì‹œì‘ ì‹œì ì— <code class="language-plaintext highlighter-rouge">set_root_dir("/desired/root")</code>ë¥¼ í•œ ë²ˆ í˜¸ì¶œí•´ ë£¨íŠ¸ ê³ ì •.</p>
  </li>
  <li>
    <p>ë³´ì•ˆìƒ ëª¨ë“  ì™¸ë¶€ ì…ë ¥ ê²½ë¡œëŠ” ìœ„ 3ê°œ íˆ´ì˜ <code class="language-plaintext highlighter-rouge">relative_path</code>ì— ê·¸ëŒ€ë¡œ ë„£ì§€ ë§ê³ , ê¼­ ì´ íˆ´ ì•ˆì—ì„œ <code class="language-plaintext highlighter-rouge">_resolve_safe</code>ê°€ ê²€ì¦í•˜ë„ë¡ ìœ ì§€.</p>
  </li>
  <li>
    <p>í° íŒŒì¼ì„ ë‹¤ë£¬ë‹¤ë©´ <code class="language-plaintext highlighter-rouge">read_file(max_bytes=None)</code>ì²˜ëŸ¼ ìƒí•œì„ ì¡°ì ˆí•˜ë˜, ì—ì´ì „íŠ¸ ì •ì±…ì— ë§ì¶° ì ì ˆí•œ ì œí•œì„ ë‘ëŠ” ê²Œ ì•ˆì „í•˜ë‹¤.</p>
  </li>
</ul>

<p>ë‹¤ìŒìœ¼ë¡œ ì›í•˜ë©´, ì‚­ì œ/ì´ë™/ë³µì‚¬ ê°™ì€ ì¶”ê°€ íˆ´ì´ë‚˜ íŒŒì¼ ì ê¸ˆ, íŠ¸ëœì­ì…˜ì„± ì €ì¥(ì„ì‹œ íŒŒì¼ë¡œ ì“°ê³  ì›ìì  êµì²´)ë„ í™•ì¥í•´ì¤„ ìˆ˜ ìˆì–´.</p>

<p class="chat--user">

ìŒ ì´ëŸ° í˜•ì‹ì´ì•¼. ë„ˆê°€ ì°¾ì•„ë³¼ ì¤„ ì•Œì•˜ì§€. from agents import function_tool @function_tool def get_weather(city: str) -&gt; str: """returns weather info for the specified city.""" return f"The weather in {city} is sunny" ê·¸ëŸ°ë° ë£¨íŠ¸ë¥¼ í•¨ìˆ˜ë¡œ ì…ë ¥ ë°›ê³  ê·¸ì— ë”°ë¥¸ íˆ´ì„ ë¦¬í„´í•˜ë©´ ì˜ ë™ì‘í• ê¹Œ? ì˜ˆë¥¼ ë“¤ì–´ def get_systemfile_tools(root_dir: str): def list_files(â€¦): f"root dir: {root_dir} â€¦" â€¦ def save_file(â€¦): return [list_files, save_file, â€¦]

</p>

<p>ê°€ëŠ¥í•´. í•¨ìˆ˜ê°€ í´ë¡œì €ë¡œ <code class="language-plaintext highlighter-rouge">root_dir</code>ë¥¼ ìº¡ì²˜í•´ì„œ íˆ´ë¡œ ë‚´ë ¤ê°€ë„, ì—ì´ì „íŠ¸ê°€ â€œíŒŒì´ì¬ ì½œëŸ¬ë¸”ì„ í˜¸ì¶œâ€ë§Œ í•˜ë©´ ë¬¸ì œì—†ë‹¤. ë‹¤ë§Œ ëª‡ ê°€ì§€ í˜„ì‹¤ì  ì£¼ì˜ì ì´ ìˆë‹¤.</p>

<p>í•µì‹¬ í¬ì¸íŠ¸ ë¨¼ì € ì •ë¦¬</p>

<ol>
  <li>
    <p>ëŒ€ë¶€ë¶„ì˜ ëŸ°íƒ€ì„(ë‹¨ì¼ í”„ë¡œì„¸ìŠ¤, ì¸ë©”ëª¨ë¦¬)ì€ í´ë¡œì € íˆ´ì„ ì˜ ì§€ì›í•œë‹¤.</p>
  </li>
  <li>
    <p>ë©€í‹°í”„ë¡œì„¸ìŠ¤/ì›ê²© ì‹¤í–‰(ì˜ˆ: í”„ë¡œì„¸ìŠ¤ ê°„ í, ì„œë²„ë¦¬ìŠ¤ ì›Œì»¤)ì—ì„œëŠ” â€œí”¼í´/ì§ë ¬í™” ê°€ëŠ¥í•œ ìµœìƒìœ„ í•¨ìˆ˜â€ë¥¼ ìš”êµ¬í•  ìˆ˜ ìˆë‹¤. ê·¸ë• í´ë¡œì € ëŒ€ì‹  <code class="language-plaintext highlighter-rouge">functools.partial</code>ì´ë‚˜ í´ë˜ìŠ¤ ë°”ì¸ë”© íŒ¨í„´ì´ ì•ˆì „í•˜ë‹¤.</p>
  </li>
  <li>
    <p>ë°ì½”ë ˆì´í„°ëŠ” ì •ì˜ ì‹œì ì— ì ìš©ëœë‹¤. íŒ©í† ë¦¬ ë‚´ë¶€ì—ì„œ â€œë°ì½”ë ˆì´í„°ë¥¼ í•¨ìˆ˜ì²˜ëŸ¼ í˜¸ì¶œâ€í•´ ì ìš©í•˜ë©´ ëœë‹¤.</p>
  </li>
</ol>

<p>ì•„ë˜ëŠ” ë„¤ê°€ ì œì‹œí•œ ìŠ¤íƒ€ì¼ì— ë§ì¶˜ ìµœì†Œ-ì˜ì¡´ì„± êµ¬í˜„ì´ë‹¤. <code class="language-plaintext highlighter-rouge">from agents import function_tool</code> ê°€ì •, <code class="language-plaintext highlighter-rouge">get_systemfile_tools(root_dir)</code>ê°€ ì•ˆì „ ê²½ë¡œ ê²€ì¦ê¹Œì§€ í¬í•¨í•œ 3ê°œ íˆ´(list_files, read_file, save_file)ì„ ë§Œë“¤ì–´ ë¦¬ìŠ¤íŠ¸ë¡œ ë°˜í™˜í•œë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="n">base64</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">function_tool</span>  <span class="c1"># ì‚¬ìš©ì í™˜ê²½ì˜ ë°ì½”ë ˆì´í„°
</span>
<span class="c1"># ===== ë‚´ë¶€ ìœ í‹¸ =====
</span>
<span class="k">def</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">relpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    root í•˜ìœ„ì˜ ì•ˆì „í•œ ì ˆëŒ€ ê²½ë¡œ ìƒì„±. ê²½ë¡œ íƒˆì¶œ ë°©ì§€.
    </span><span class="sh">"""</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="p">.</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">root</span> <span class="o">/</span> <span class="n">relpath</span><span class="p">).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="c1"># Path.is_relative_to: 3.9+ ì§€ì›. í•˜ìœ„ í˜¸í™˜ ìˆ˜ë™ ì²´í¬
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>  <span class="c1"># type: ignore[attr-defined]
</span>            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Path escapes root_dir</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">AttributeError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">root</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span><span class="p">.</span><span class="n">parents</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Path escapes root_dir</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span>

<span class="c1"># ===== íˆ´ íŒ©í† ë¦¬ =====
</span>
<span class="k">def</span> <span class="nf">get_systemfile_tools</span><span class="p">(</span><span class="n">root_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    ì§€ì •í•œ root_dirë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë™ì‘í•˜ëŠ” íŒŒì¼ ì‹œìŠ¤í…œ íˆ´ 3ì¢…ì„ ìƒì„±í•´ ë°˜í™˜í•œë‹¤.
    ë°˜í™˜ ê°’ì€ ì—ì´ì „íŠ¸ì— ê·¸ëŒ€ë¡œ ë“±ë¡ ê°€ëŠ¥í•œ ë°ì½”ë ˆì´íŠ¸ëœ í•¨ìˆ˜ ë¦¬ìŠ¤íŠ¸.
    </span><span class="sh">"""</span>
    <span class="n">root</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">root_dir</span><span class="p">).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">root</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># --- list_files ---------------------------------------------------------
</span>    <span class="k">def</span> <span class="nf">_list_files_impl</span><span class="p">(</span>
        <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">glob</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">recursive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">include_hidden</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">max_items</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        ë£¨íŠ¸(root_dir) ê¸°ì¤€ìœ¼ë¡œ íŒŒì¼/í´ë” ëª©ë¡ì„ ê°€ì ¸ì˜¨ë‹¤.
        ê¸€ë¡­ íŒ¨í„´, ì¬ê·€ íƒìƒ‰, ìˆ¨ê¹€ í¬í•¨ ì—¬ë¶€, ìµœëŒ€ ê°œìˆ˜ ì œí•œì„ ì§€ì›í•œë‹¤.
        </span><span class="sh">"""</span>
        <span class="n">base</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">root</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">base</span><span class="sh">"</span><span class="p">:</span> <span class="n">relative_path</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="p">:</span> <span class="p">[],</span>
                <span class="sh">"</span><span class="s">warning</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Base path does not exist.</span><span class="sh">"</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">def</span> <span class="nf">iter_paths</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">glob</span><span class="p">:</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">**/</span><span class="si">{</span><span class="n">glob</span><span class="si">}</span><span class="sh">"</span> <span class="k">if</span> <span class="n">recursive</span> <span class="k">else</span> <span class="n">glob</span>
                <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">rglob</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">iterdir</span><span class="p">()</span>

        <span class="n">entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nf">iter_paths</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="n">base</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">include_hidden</span> <span class="ow">and</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">safe</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)))</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">safe</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span> <span class="k">if</span> <span class="n">safe</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">safe</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span> <span class="k">if</span> <span class="n">safe</span><span class="p">.</span><span class="nf">is_file</span><span class="p">()</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">entries</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_items</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_items</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">root</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">base</span><span class="sh">"</span><span class="p">:</span> <span class="n">relative_path</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">entries</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="p">:</span> <span class="n">entries</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">list_files</span> <span class="o">=</span> <span class="nf">function_tool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">list_files</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">root_dir ê¸°ì¤€ìœ¼ë¡œ íŒŒì¼/í´ë” ëª©ë¡ì„ ê°€ì ¸ì˜¨ë‹¤. ê¸€ë¡­/ì¬ê·€/ìˆ¨ê¹€/ìµœëŒ€ê°œìˆ˜ ì˜µì…˜ ì§€ì›.</span><span class="sh">"</span>
    <span class="p">)(</span><span class="n">_list_files_impl</span><span class="p">)</span>

    <span class="c1"># --- read_file ----------------------------------------------------------
</span>    <span class="k">def</span> <span class="nf">_read_file_impl</span><span class="p">(</span>
        <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">max_bytes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        íŒŒì¼ ì½ê¸°. í…ìŠ¤íŠ¸(encoding) ë˜ëŠ” ë°”ì´ë„ˆë¦¬(Base64) ëª¨ë“œ ì„ íƒ.
        íŒŒì¼ í¬ê¸° ìƒí•œ(max_bytes)ìœ¼ë¡œ ê³¼ë„í•œ ì½ê¸° ë°©ì§€.
        </span><span class="sh">"""</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File not found: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">IsADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Path is a directory: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="n">size</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span>
        <span class="k">if</span> <span class="n">max_bytes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">max_bytes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File too large (</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s">) &gt; max_bytes=</span><span class="si">{</span><span class="n">max_bytes</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span>
                <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_bytes</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span>
                <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content_b64</span><span class="sh">"</span><span class="p">:</span> <span class="n">base64</span><span class="p">.</span><span class="nf">b64encode</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">ascii</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">mode must be </span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>

    <span class="n">read_file</span> <span class="o">=</span> <span class="nf">function_tool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">read_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">root_dir ê¸°ì¤€ ê²½ë¡œì˜ íŒŒì¼ì„ ì½ëŠ”ë‹¤. í…ìŠ¤íŠ¸ ë˜ëŠ” Base64 ë°”ì´ë„ˆë¦¬ ë°˜í™˜.</span><span class="sh">"</span>
    <span class="p">)(</span><span class="n">_read_file_impl</span><span class="p">)</span>

    <span class="c1"># --- save_file ----------------------------------------------------------
</span>    <span class="k">def</span> <span class="nf">_save_file_impl</span><span class="p">(</span>
        <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">content_b64</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">create_parents</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">
        íŒŒì¼ ì €ì¥. í…ìŠ¤íŠ¸(content) ë˜ëŠ” Base64(content_b64) ì§€ì›.
        overwriteì™€ ìƒìœ„ ê²½ë¡œ ìë™ ìƒì„±(create_parents) ì˜µì…˜ ì œê³µ.
        </span><span class="sh">"""</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">IsADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Path is a directory: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">create_parents</span><span class="p">:</span>
            <span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">created</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">FileExistsError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File already exists (overwrite=False): </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">content is required when mode=</span><span class="sh">'</span><span class="s">text</span><span class="sh">'"</span><span class="p">)</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">write_text</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">content_b64</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">content_b64 is required when mode=</span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">write_bytes</span><span class="p">(</span><span class="n">base64</span><span class="p">.</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">content_b64</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">"</span><span class="s">ascii</span><span class="sh">"</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">mode must be </span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span>
            <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="n">mode</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">created</span><span class="sh">"</span><span class="p">:</span> <span class="n">created</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">overwrote</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="ow">not</span> <span class="n">created</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="n">save_file</span> <span class="o">=</span> <span class="nf">function_tool</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">save_file</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">root_dir ê¸°ì¤€ ê²½ë¡œì— íŒŒì¼ì„ ì €ì¥í•œë‹¤. í…ìŠ¤íŠ¸/ë°”ì´ë„ˆë¦¬, ë®ì–´ì“°ê¸°, ìƒìœ„ í´ë” ìƒì„± ì§€ì›.</span><span class="sh">"</span>
    <span class="p">)(</span><span class="n">_save_file_impl</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">list_files</span><span class="p">,</span> <span class="n">read_file</span><span class="p">,</span> <span class="n">save_file</span><span class="p">]</span>
</code></pre></div></div>

<p>ì‚¬ìš© ì˜ˆì‹œ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tools</span> <span class="o">=</span> <span class="nf">get_systemfile_tools</span><span class="p">(</span><span class="sh">"</span><span class="s">./workspace</span><span class="sh">"</span><span class="p">)</span>
<span class="c1"># ì—ì´ì „íŠ¸ ì´ˆê¸°í™” ì‹œ ë“±ë¡
# agent = Agent(tools=tools)  # í”„ë ˆì„ì›Œí¬ì— ë§ê²Œ ë“±ë¡
</span>
<span class="c1"># ë˜ëŠ” ì§ì ‘ í˜¸ì¶œë„ ê°€ëŠ¥(ë‚´ë¶€ì ìœ¼ë¡œ root="./workspace"ë¡œ ê³ ì •ë¨)
</span><span class="nf">print</span><span class="p">(</span><span class="n">tools</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">relative_path</span><span class="o">=</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span> <span class="n">glob</span><span class="o">=</span><span class="sh">"</span><span class="s">*.py</span><span class="sh">"</span><span class="p">))</span>
</code></pre></div></div>

<p>í´ë¡œì € íˆ´ì˜ í˜„ì‹¤ì  ì£¼ì˜ì‚¬í•­ê³¼ ëŒ€ì•ˆ</p>

<ul>
  <li>
    <p>ì›Œì»¤ í”„ë¡œì„¸ìŠ¤ê°€ ë³„ë„ì—ì„œ íˆ´ì„ ë¡œë“œí•´ì•¼ í•˜ëŠ” ì•„í‚¤í…ì²˜ë¼ë©´ í´ë¡œì €ê°€ ì§ë ¬í™”ë˜ì§€ ì•Šì•„ ì‹¤íŒ¨í•  ìˆ˜ ìˆë‹¤. ì´ ê²½ìš° ë‘ ê°€ì§€ ëŒ€ì•ˆì´ ì•ˆì „í•˜ë‹¤.</p>

    <ol>
      <li>
        <p><code class="language-plaintext highlighter-rouge">functools.partial</code> íŒ¨í„´: ìµœìƒìœ„ í•¨ìˆ˜ì— <code class="language-plaintext highlighter-rouge">root</code> ì¸ìë¥¼ ë‘ê³ , <code class="language-plaintext highlighter-rouge">partial(fn, root=my_root)</code>ë¡œ ë°”ì¸ë”©í•œ ë’¤ ê·¸ partialì— ë°ì½”ë ˆì´í„°ë¥¼ ì”Œìš°ê±°ë‚˜, ë°ì½”ë ˆì´í„°ê°€ â€œí•¨ìˆ˜ì²˜ëŸ¼ í˜¸ì¶œ ê°€ëŠ¥â€í•˜ë‹¤ë©´ íŒ©í† ë¦¬ì—ì„œ <code class="language-plaintext highlighter-rouge">function_tool(...)(partial(...))</code>ë¡œ ë“±ë¡.</p>
      </li>
      <li>
        <p>í´ë˜ìŠ¤ íŒ¨í„´: <code class="language-plaintext highlighter-rouge">class FS:</code> ì•ˆì— <code class="language-plaintext highlighter-rouge">__init__(root)</code>ë¡œ ìƒíƒœë¥¼ ë“¤ê³ , ìµœìƒìœ„ ë˜í¼ í•¨ìˆ˜ë¥¼ ë§Œë“¤ì–´ <code class="language-plaintext highlighter-rouge">fs = FS(root)</code>ì˜ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ê²Œ ë˜í•‘. ì´ ë˜í¼ë§Œ ë°ì½”ë ˆì´íŠ¸í•´ ë“±ë¡í•˜ë©´ ì§ë ¬í™” ì œì•½ì„ í”¼í•˜ê¸° ì‰½ë‹¤.</p>
      </li>
    </ol>
  </li>
</ul>

<p>ì§€ê¸ˆ ì œê³µí•œ êµ¬í˜„ì€ ê°€ì¥ ê°„ê²°í•œ í´ë¡œì €-íŒ©í† ë¦¬ ë²„ì „ì´ë‹¤. ë§Œì•½ ë„¤ ëŸ°íƒ€ì„ì´ ë©€í‹°í”„ë¡œì„¸ìŠ¤ ì§ë ¬í™”ë¥¼ ìš”êµ¬í•œë‹¤ë©´, ìœ„ ëŒ€ì•ˆ íŒ¨í„´ìœ¼ë¡œ ë°”ë¡œ ë°”ê¿”ì¤„ ìˆ˜ë„ ìˆë‹¤.</p>

<p class="chat--user">

function_toolì´ ìë™ìœ¼ë¡œ ì²«ì¤„ì„ descriptionìœ¼ë¡œ ë§Œë“œëŠ”ë° ê·¸ê±¸ f stringìœ¼ë¡œ ë§Œë“¤ê³  ì‹¶ë‹¤ëŠ”ê±°ì§€

</p>

<p>ì¢‹ì•„. í•µì‹¬ì€ â€œë°ì½”ë ˆì´í„°ê°€ ì²« ì¤„ docstringì„ ì½ëŠ” íƒ€ì´ë° ì „ì—, í•¨ìˆ˜ì˜ __doc__ì„ ë™ì ìœ¼ë¡œ ì±„ì›Œë„£ê¸°â€ì•¼. íŒŒì´ì¬ì—ì„œ í•¨ìˆ˜ ì •ì˜ ë¸”ë¡ ë§¨ ì²˜ìŒì˜ ë¬¸ìì—´ ë¦¬í„°ëŸ´ì€ ì»´íŒŒì¼ ì‹œ ê³ ì •ë˜ì§€ë§Œ, ëŸ°íƒ€ì„ì— <code class="language-plaintext highlighter-rouge">fn.__doc__</code>ì„ ë‹¤ì‹œ í• ë‹¹í•˜ëŠ” ê±´ ê°€ëŠ¥í•˜ë‹¤. ê·¸ëŸ¬ë‹ˆ íŒ©í† ë¦¬ì—ì„œ í´ë¡œì €ë¥¼ ë§Œë“¤ê³ , ê·¸ í•¨ìˆ˜ë“¤ì˜ <code class="language-plaintext highlighter-rouge">__doc__</code>ì„ f-string ê²°ê³¼ë¡œ ëŒ€ì…í•œ ë‹¤ìŒ, <code class="language-plaintext highlighter-rouge">function_tool</code>ì„ â€œë°ì½”ë ˆì´í„°ì²˜ëŸ¼ í˜¸ì¶œâ€í•´ì„œ ì ìš©í•˜ë©´ ëœë‹¤. í¬ì¸íŠ¸ëŠ” â€œdocstring ìˆ˜ì • â†’ function_tool ì ìš©â€ì˜ ìˆœì„œ.</p>

<p>ì•„ë˜ëŠ” ë™ì‘í•˜ëŠ” íŒ¨í„´ì„ ë‹¨ê³„ë³„ë¡œ í’€ì–´ì“´ ì½”ë“œë‹¤.</p>

<ol>
  <li>
    <p>í´ë¡œì €ë¡œ root_dirë¥¼ ìº¡ì²˜</p>
  </li>
  <li>
    <p>ë‚´ë¶€ í•¨ìˆ˜ì˜ ì›ë³¸ docstringì€ í¬ë§·ìš© í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ë‘”ë‹¤</p>
  </li>
  <li>
    <p>ì •ì˜ê°€ ëë‚œ ë’¤ <code class="language-plaintext highlighter-rouge">.__doc__ = f"...{root_dir}..."</code> ë˜ëŠ” <code class="language-plaintext highlighter-rouge">.format(root=root_dir)</code>ë¡œ ì£¼ì…</p>
  </li>
  <li>
    <p>ë§ˆì§€ë§‰ì— <code class="language-plaintext highlighter-rouge">function_tool(...)</code>ë¡œ ë˜í•‘í•´ì„œ ë¦¬í„´</p>
  </li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="n">base64</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="n">agents</span> <span class="kn">import</span> <span class="n">function_tool</span>

<span class="k">def</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">relpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="p">.</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">root</span> <span class="o">/</span> <span class="n">relpath</span><span class="p">).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>  <span class="c1"># py3.9+
</span>            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Path escapes root_dir</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">AttributeError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">root</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span><span class="p">.</span><span class="n">parents</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Path escapes root_dir</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span>

<span class="k">def</span> <span class="nf">get_systemfile_tools</span><span class="p">(</span><span class="n">root_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    root_dirë¥¼ ìº¡ì²˜í•œ íŒŒì¼ ì‹œìŠ¤í…œ íˆ´ë“¤ì„ ë§Œë“¤ê³ , docstringì˜ ì²« ì¤„ì„ ë™ì ìœ¼ë¡œ ì±„ìš´ ë’¤ function_toolë¡œ ë˜í•‘í•´ ë°˜í™˜í•œë‹¤.
    </span><span class="sh">"""</span>
    <span class="n">root</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">root_dir</span><span class="p">).</span><span class="nf">expanduser</span><span class="p">().</span><span class="nf">resolve</span><span class="p">()</span>
    <span class="n">root</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># --- list_files ---------------------------------------------------------
</span>    <span class="k">def</span> <span class="nf">_list_files_impl</span><span class="p">(</span>
        <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">glob</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">recursive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">include_hidden</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">max_items</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">List files under {root}: glob/recursive/hidden/max_items supported.</span><span class="sh">"""</span>
        <span class="n">base</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">root</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">base</span><span class="sh">"</span><span class="p">:</span> <span class="n">relative_path</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="p">:</span> <span class="p">[],</span>
                <span class="sh">"</span><span class="s">warning</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Base path does not exist.</span><span class="sh">"</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">def</span> <span class="nf">iter_paths</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">glob</span><span class="p">:</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">**/</span><span class="si">{</span><span class="n">glob</span><span class="si">}</span><span class="sh">"</span> <span class="k">if</span> <span class="n">recursive</span> <span class="k">else</span> <span class="n">glob</span>
                <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">rglob</span><span class="p">(</span><span class="sh">"</span><span class="s">*</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="k">from</span> <span class="n">base</span><span class="p">.</span><span class="nf">iterdir</span><span class="p">()</span>

        <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nf">iter_paths</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="n">base</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">include_hidden</span> <span class="ow">and</span> <span class="n">p</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">safe</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)))</span>
            <span class="n">items</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">safe</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dir</span><span class="sh">"</span> <span class="k">if</span> <span class="n">safe</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">safe</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span> <span class="k">if</span> <span class="n">safe</span><span class="p">.</span><span class="nf">is_file</span><span class="p">()</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
            <span class="p">})</span>
            <span class="k">if</span> <span class="n">max_items</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_items</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">root</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">root</span><span class="p">),</span> <span class="sh">"</span><span class="s">base</span><span class="sh">"</span><span class="p">:</span> <span class="n">relative_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">count</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">items</span><span class="p">),</span> <span class="sh">"</span><span class="s">entries</span><span class="sh">"</span><span class="p">:</span> <span class="n">items</span><span class="p">}</span>

    <span class="c1"># docstring ì²« ì¤„ì„ ë™ì ìœ¼ë¡œ ì£¼ì…
</span>    <span class="n">_list_files_impl</span><span class="p">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">List files under </span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s">: glob/recursive/hidden/max_items supported.</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="p">(</span>
        <span class="n">_list_files_impl</span><span class="p">.</span><span class="n">__doc__</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">_list_files_impl</span><span class="p">.</span><span class="n">__doc__</span> <span class="k">else</span> <span class="sh">""</span>
    <span class="p">)</span>
    <span class="n">list_files</span> <span class="o">=</span> <span class="nf">function_tool</span><span class="p">(</span><span class="n">_list_files_impl</span><span class="p">)</span>  <span class="c1"># ì´ ì‹œì ì— ì²« ì¤„ì„ ì½ì–´ descriptionìœ¼ë¡œ ì‚¬ìš©
</span>
    <span class="c1"># --- read_file ----------------------------------------------------------
</span>    <span class="k">def</span> <span class="nf">_read_file_impl</span><span class="p">(</span>
        <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">max_bytes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Read a file from {root}: return text or Base64 binary with size guard.</span><span class="sh">"""</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File not found: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">IsADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Path is a directory: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="n">size</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span>
        <span class="k">if</span> <span class="n">max_bytes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">max_bytes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File too large (</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s">) &gt; max_bytes=</span><span class="si">{</span><span class="n">max_bytes</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span> <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span> <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)}</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">read_bytes</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span>
                <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">content_b64</span><span class="sh">"</span><span class="p">:</span> <span class="n">base64</span><span class="p">.</span><span class="nf">b64encode</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">ascii</span><span class="sh">"</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">mode must be </span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>

    <span class="n">_read_file_impl</span><span class="p">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Read a file from </span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s">: return text or Base64 binary with size guard.</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="p">(</span>
        <span class="n">_read_file_impl</span><span class="p">.</span><span class="n">__doc__</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">_read_file_impl</span><span class="p">.</span><span class="n">__doc__</span> <span class="k">else</span> <span class="sh">""</span>
    <span class="p">)</span>
    <span class="n">read_file</span> <span class="o">=</span> <span class="nf">function_tool</span><span class="p">(</span><span class="n">_read_file_impl</span><span class="p">)</span>

    <span class="c1"># --- save_file ----------------------------------------------------------
</span>    <span class="k">def</span> <span class="nf">_save_file_impl</span><span class="p">(</span>
        <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">content_b64</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">create_parents</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Save a file under {root}: text/binary, overwrite and parent creation options.</span><span class="sh">"""</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nf">_resolve_safe</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">p</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">IsADirectoryError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Path is a directory: </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">create_parents</span><span class="p">:</span>
            <span class="n">p</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">existed</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">existed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">FileExistsError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">File already exists (overwrite=False): </span><span class="si">{</span><span class="n">relative_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">content is required when mode=</span><span class="sh">'</span><span class="s">text</span><span class="sh">'"</span><span class="p">)</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">write_text</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">content_b64</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">content_b64 is required when mode=</span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>
            <span class="n">p</span><span class="p">.</span><span class="nf">write_bytes</span><span class="p">(</span><span class="n">base64</span><span class="p">.</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">content_b64</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="sh">"</span><span class="s">ascii</span><span class="sh">"</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">mode must be </span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">binary</span><span class="sh">'"</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">path</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="nf">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)),</span>
            <span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="nf">stat</span><span class="p">().</span><span class="n">st_size</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">mode</span><span class="sh">"</span><span class="p">:</span> <span class="n">mode</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">created</span><span class="sh">"</span><span class="p">:</span> <span class="ow">not</span> <span class="n">existed</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">overwrote</span><span class="sh">"</span><span class="p">:</span> <span class="n">existed</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">_save_file_impl</span><span class="p">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Save a file under </span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s">: text/binary, overwrite and parent creation options.</span><span class="se">\n</span><span class="sh">"</span> <span class="o">+</span> <span class="p">(</span>
        <span class="n">_save_file_impl</span><span class="p">.</span><span class="n">__doc__</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">_save_file_impl</span><span class="p">.</span><span class="n">__doc__</span> <span class="k">else</span> <span class="sh">""</span>
    <span class="p">)</span>
    <span class="n">save_file</span> <span class="o">=</span> <span class="nf">function_tool</span><span class="p">(</span><span class="n">_save_file_impl</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">list_files</span><span class="p">,</span> <span class="n">read_file</span><span class="p">,</span> <span class="n">save_file</span><span class="p">]</span>
</code></pre></div></div>

<p>ì´ íŒ¨í„´ì˜ ì´ìœ ì™€ ì£¼ì˜ì  ì •ë¦¬</p>

<ol>
  <li>
    <p>ëŒ€ë¶€ë¶„ì˜ <code class="language-plaintext highlighter-rouge">function_tool</code> êµ¬í˜„ì€ â€œë˜í•‘ ì‹œì â€ì— <code class="language-plaintext highlighter-rouge">fn.__doc__</code>ì˜ ì²« ì¤„ì„ ì½ì–´ descriptionìœ¼ë¡œ ì”€. ë”°ë¼ì„œ ë°˜ë“œì‹œ docstringì„ ë°”ê¾¼ ë’¤ì— <code class="language-plaintext highlighter-rouge">function_tool(fn)</code>ì„ í˜¸ì¶œí•´ì•¼ í•œë‹¤.</p>
  </li>
  <li>
    <p>ë°ì½”ë ˆì´í„° êµ¬ë¬¸ <code class="language-plaintext highlighter-rouge">@function_tool</code>ë¥¼ í•¨ìˆ˜ ì •ì˜ ìœ„ì— ë°”ë¡œ ë¶™ì´ë©´, ë°ì½”ë ˆì´í„°ê°€ ë¨¼ì € ì‹¤í–‰ë˜ë¯€ë¡œ ê·¸ ë’¤ì˜ <code class="language-plaintext highlighter-rouge">__doc__</code> ì£¼ì…ì´ ë°˜ì˜ë˜ì§€ ì•ŠëŠ”ë‹¤. ì§€ê¸ˆì²˜ëŸ¼ â€œcall-style ë°ì½”ë ˆì´ì…˜â€ìœ¼ë¡œ í•´ê²°í•œë‹¤.</p>
  </li>
  <li>
    <p>f-stringì„ í•¨ìˆ˜ ë³¸ë¬¸ ì²« ì¤„ ë¦¬í„°ëŸ´ì— ì§ì ‘ ì“¸ ìˆ˜ëŠ” ì—†ë‹¤. ëŒ€ì‹  ëŸ°íƒ€ì„ì— <code class="language-plaintext highlighter-rouge">__doc__</code>ì— f-string ê²°ê³¼ë¥¼ ëŒ€ì…í•˜ê±°ë‚˜, í…œí”Œë¦¿ ë¬¸ìì—´ì„ ë‘ê³  <code class="language-plaintext highlighter-rouge">.format(root=root_dir)</code>ë¡œ ì¹˜í™˜í•˜ë©´ ëœë‹¤.</p>
  </li>
  <li>
    <p>ë§Œì•½ ë„¤ <code class="language-plaintext highlighter-rouge">function_tool</code>ì´ description ì¸ìë¥¼ ì§ì ‘ ë°›ëŠ”ë‹¤ë©´ ë” ê°„ë‹¨íˆ <code class="language-plaintext highlighter-rouge">function_tool(description=f"...{root}...")(fn)</code>ë¡œ ëë‚¼ ìˆ˜ ìˆë‹¤. í•˜ì§€ë§Œ â€œì²« ì¤„ docstring ìë™ ì‚¬ìš©â€ ê·œì•½ì„ ìœ ì§€í•˜ë ¤ë©´ ì§€ê¸ˆ ë°©ì‹ì´ ê°€ì¥ í˜¸í™˜ì„±ì´ ì¢‹ë‹¤.</p>
  </li>
</ol>

<p>í™•ì¥ íŒ</p>

<ul>
  <li>
    <p>ì²« ì¤„ ì™¸ì— ìƒì„¸ ë„ì›€ë§ì„ ê³„ì† ë‚¨ê¸°ê³  ì‹¶ìœ¼ë©´, ì›ë˜ docstringì„ ì½ì–´ ë‘ê³  ì²« ì¤„ë§Œ ë®ì–´ì“´ ë’¤ ë‚˜ë¨¸ì§€ë¥¼ ì´ì–´ë¶™ì´ëŠ” ì§€ê¸ˆ ë°©ì‹ì„ ì“°ë©´ ëœë‹¤.</p>
  </li>
  <li>
    <p>ì§ë ¬í™”ê°€ í•„ìš”í•œ í™˜ê²½ì—ì„œëŠ” ì´ í´ë¡œì €ë¥¼ ìµœìƒìœ„ í•¨ìˆ˜+<code class="language-plaintext highlighter-rouge">functools.partial</code>ë¡œ ë°”ê¿”ë„ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">__doc__</code> ì£¼ì… í›„ ë˜í•‘ì´ ê°€ëŠ¥í•˜ë‹¤.</p>
  </li>
</ul>]]></content><author><name>hvppyarchive</name></author><category term="llm" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">ComfyUI íƒ€ì… ìƒ‰ìƒ ì¶”ê°€</title><link href="https://hvppyarchive.github.io/comfyui/comfyui-connection-color/" rel="alternate" type="text/html" title="ComfyUI íƒ€ì… ìƒ‰ìƒ ì¶”ê°€" /><published>2025-10-30T16:07:05+09:00</published><updated>2025-10-30T16:07:05+09:00</updated><id>https://hvppyarchive.github.io/comfyui/comfyui-connection-color</id><content type="html" xml:base="https://hvppyarchive.github.io/comfyui/comfyui-connection-color/"><![CDATA[<p class="chat--user">

ComfyUI ì—ì„œ ë‚´ê°€ ë§Œë“  íƒ€ì…ì— ìƒ‰ê¹”ì„ ë„£ì„ ìˆœ ì—†ë‚˜

</p>

<p>ê°€ëŠ¥í•´ìš”. â€œë‚´ê°€ ë§Œë“  íƒ€ì…(ì˜ˆ: MYTYPE)â€ì˜ ë§í¬ ìƒ‰ì„ ì •í•´ë‘ë©´, ê·¸ íƒ€ì…ìœ¼ë¡œ ë“¤ì–´ì˜¤ê³  ë‚˜ê°€ëŠ” ì—°ê²°ì„ ì´ ì›í•˜ëŠ” ìƒ‰ìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤. í•µì‹¬ì€ í”„ëŸ°íŠ¸ì—”ë“œ(LiteGraph ìº”ë²„ìŠ¤) ìª½ì˜ â€œíƒ€ì…â†’ìƒ‰ìƒâ€ ë§¤í•‘ì„ ì¶”ê°€í•˜ëŠ” ê²ë‹ˆë‹¤.</p>

<p>ì•„ë˜ ìˆœì„œëŒ€ë¡œ í•˜ë©´ ë©ë‹ˆë‹¤.</p>

<ol>
  <li>
    <p>íŒŒì´ì¬ ë…¸ë“œì—ì„œ íƒ€ì… ì´ë¦„ ì •í•˜ê¸°<br />
ì»¤ìŠ¤í…€ ë…¸ë“œì˜ RETURN_TYPES / INPUT_TYPES ë“±ì— ì‚¬ìš©í•  ë¬¸ìì—´ì´ ì‹¤ì œ íƒ€ì… ì´ë¦„ì´ ë©ë‹ˆë‹¤. ì˜ˆ: RETURN_TYPES = ("MYTYPE",). ì´ ë¬¸ìì—´ì´ í”„ëŸ°íŠ¸ì—”ë“œì—ì„œë„ ìƒ‰ìƒ í‚¤ë¡œ ì“°ì…ë‹ˆë‹¤. íƒ€ì… ë¬¸ìì—´ê³¼ ë§í¬ ìƒ‰ì€ LiteGraphê°€ íƒ€ì…ë³„ë¡œ êµ¬ë¶„í•©ë‹ˆë‹¤. <a href="https://docs.comfy.org/development/core-concepts/nodes?utm_source=chatgpt.com">ComfyUI</a></p>
  </li>
  <li>
    <p>í”„ëŸ°íŠ¸ì—”ë“œ í™•ì¥ ìŠ¤í¬ë¦½íŠ¸ ë§Œë“¤ê¸°<br />
ComfyUIëŠ” ë¸Œë¼ìš°ì €ì—ì„œ ì‹¤í–‰ë  ë•Œ ì‘ì€ JS í™•ì¥(extension)ì„ ìë™ ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—¬ê¸°ì— â€œíƒ€ì…â†’ìƒ‰ìƒâ€ ë§¤í•‘ì„ ì¶”ê°€í•©ë‹ˆë‹¤. í™•ì¥ì€ docsì˜ ComfyNode/JS í•˜ì´ì¬í‚¹ ê°€ì´ë“œê°€ ì•ˆë‚´í•˜ëŠ” app.registerExtension íŒ¨í„´ì„ ì“°ë©´ ê¹”ë”í•©ë‹ˆë‹¤. <a href="https://docs.comfy.org/custom-nodes/js/javascript_objects_and_hijacking?utm_source=chatgpt.com">ComfyUI</a></p>
  </li>
</ol>

<p>ì˜ˆì‹œ: ComfyUI/web/extensions/mytype-colors.js íŒŒì¼ì„ ë§Œë“¤ê³  ì•„ë˜ì²˜ëŸ¼ ì‘ì„±í•©ë‹ˆë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

// ComfyUI 0.7ëŒ€ LiteGraph ê¸°ì¤€ ì˜ˆì‹œ
app.registerExtension({
  name: "mytype.color.map",
  setup() {
    const LGC = LGraphCanvas; // LiteGraph ìº”ë²„ìŠ¤
    // ì—°ê²°ì„ (í™œì„±/ë¹„í™œì„±) ìƒ‰ìƒì„ íƒ€ì… ë¬¸ìì—´ í‚¤ë¡œ ì§€ì •
    LGC.default_connection_color_byType = {
      ...(LGC.default_connection_color_byType || {}),
      "MYTYPE": "#a26bff"   // ì›í•˜ëŠ” HEX
    };
    LGC.default_connection_color_byTypeOff = {
      ...(LGC.default_connection_color_byTypeOff || {}),
      "MYTYPE": "#5b3a9a"   // ë¹„í™œì„±(êº¼ì§) ìƒíƒœì¼ ë•Œ ì–´ë‘ìš´ í†¤
    };
    // ìƒ‰ìƒ ë³€ê²½ í›„ ìº”ë²„ìŠ¤ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    if (app?.graph?.canvas) app.graph.canvas.setDirty(true, true);
  }
});
</code></pre></div></div>

<p>LiteGraphëŠ” íƒ€ì… ë¬¸ìì—´ë³„ ê¸°ë³¸ ì—°ê²°ì„  ìƒ‰ì„ default_connection_color_byType / default_connection_color_byTypeOff ë‘ ê°ì²´ì—ì„œ ì°¾ìŠµë‹ˆë‹¤. ì´ ë‘ ë§µì— í‚¤ë¥¼ ì¶”ê°€í•˜ë©´ ë©ë‹ˆë‹¤. ì´ ë°©ë²•ì€ LiteGraphì— ì§ì ‘ ë¬¼ì–´ë³¸ ë‹µê³¼ ë™ì¼í•œ ë©”ì»¤ë‹ˆì¦˜ì„ ì”ë‹ˆë‹¤. <a href="https://stackoverflow.com/questions/78543805/how-do-i-change-the-color-of-a-slot?utm_source=chatgpt.com">Stack Overflow</a></p>

<ol>
  <li>ë¸Œë¼ìš°ì € ìƒˆë¡œê³ ì¹¨<br />
ComfyUIë¥¼ ì¬ì‹œì‘í•˜ê±°ë‚˜ ë¸Œë¼ìš°ì €ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ë©´, ì´ì œ MYTYPE íƒ€ì… ë§í¬ê°€ ì§€ì •í•œ ìƒ‰ìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤.</li>
</ol>

<p>ì¶”ê°€ íŒ</p>

<p>â€¢ ë…¸ë“œ ì¹´ë“œ(í—¤ë”) ë°°ê²½ìƒ‰ì€ íƒ€ì… ìƒ‰ê³¼ ë³„ê°œì…ë‹ˆë‹¤. í—¤ë” ë°°ê²½ì€ í…Œë§ˆ/íŒ”ë ˆíŠ¸(ì„¤ì •ì˜ Appearance)ë‚˜ CSSë¡œ ë°”ê¿€ ìˆ˜ ìˆì§€ë§Œ, â€œë°ì´í„° íƒ€ì…â€ ë§í¬ ìƒ‰ì€ ìœ„ì²˜ëŸ¼ íƒ€ì… ë§¤í•‘ì„ ì†ëŒ€ì•¼ ë°”ë€ë‹ˆë‹¤. íŒ”ë ˆíŠ¸ë§Œ ë°”ê¾¸ë©´ â€œìƒ‰ì´ ë” ì˜ ë³´ì´ê²Œâ€ ë˜ëŠ” ê²½ìš°ê°€ ìˆìœ¼ë‚˜, íƒ€ì…ë³„ ê³ ìœ ìƒ‰ì„ ìƒˆë¡œ ì •ì˜í•˜ëŠ” ê±´ ì•„ë‹™ë‹ˆë‹¤. <a href="https://docs.comfy.org/interface/appearance?utm_source=chatgpt.com">ComfyUI+1</a></p>

<p>â€¢ ComfyUIëŠ” ì»¤ìŠ¤í…€ LiteGraph ë¹Œë“œë¥¼ ì”ë‹ˆë‹¤. ë²„ì „ë§ˆë‹¤ ë‚´ë¶€ ê²½ë¡œê°€ ì•½ê°„ ë‹¤ë¥¼ ìˆ˜ ìˆì§€ë§Œ, ê³µê°œ íŒ¨í‚¤ì§€ ì„¤ëª…ì—ì„œë„ ComfyUIê°€ ìˆ˜ì •ëœ litegraphë¥¼ ì‚¬ìš©í•œë‹¤ê³  ëª…ì‹œë˜ì–´ ìˆì–´ ìœ„ íŒ¨í„´ì´ ì•ˆì •ì ì…ë‹ˆë‹¤. <a href="https://www.npmjs.com/package/%40comfyorg/litegraph/v/0.7.42?utm_source=chatgpt.com">Npm</a></p>

<p>â€¢ ì½”ë“œë¡œ í—¤ë” ìƒ‰ê¹Œì§€ ê°•ì œí•˜ê³  ì‹¶ë‹¤ë©´ node.color / node.bgcolor ê°™ì€ LiteGraph ì†ì„±ë„ ê±´ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ë§Œ ì›Œí¬í”Œë¡œ ì „ë°˜ì˜ ì¼ê´€ì„±ì„ ìƒê°í•˜ë©´ â€œë§í¬(íƒ€ì…) ìƒ‰ì€ íƒ€ì…-ë§µìœ¼ë¡œ, ì „ì²´ í…Œë§ˆëŠ” íŒ”ë ˆíŠ¸/ìŠ¤íƒ€ì¼ë¡œâ€ ë‚˜ëˆ„ëŠ” í¸ì´ ìœ ì§€ë³´ìˆ˜ì— ìœ ë¦¬í•©ë‹ˆë‹¤. ê´€ë ¨ JS í›…ì€ Comfyì˜ JS ì˜¤ë¸Œì íŠ¸/í•˜ì´ì¬í‚¹ ë¬¸ì„œê°€ ì¶œë°œì ìœ¼ë¡œ ì¢‹ìŠµë‹ˆë‹¤. <a href="https://docs.comfy.org/custom-nodes/js/javascript_objects_and_hijacking?utm_source=chatgpt.com">ComfyUI</a></p>

<p>ì •ë¦¬í•˜ë©´, íŒŒì´ì¬ ìª½ì—ì„œ íƒ€ì… ë¬¸ìì—´ì„ í•˜ë‚˜ ì •í•´ ì“°ê³ , í”„ëŸ°íŠ¸ì—”ë“œ í™•ì¥ìœ¼ë¡œ LGraphCanvas.default_connection_color_byType(ë° Off)ì— ê·¸ ë¬¸ìì—´ í‚¤ë¥¼ ì›í•˜ëŠ” ìƒ‰ìœ¼ë¡œ ì¶”ê°€í•˜ì„¸ìš”. ê·¸ëŸ¬ë©´ ê·¸ íƒ€ì…ì˜ ì…ì¶œë ¥ ë§í¬ê°€ ì§€ì •í•œ ìƒ‰ìœ¼ë¡œ ê¹”ë”í•˜ê²Œ í‘œì‹œë©ë‹ˆë‹¤. ë‹¤ìŒìœ¼ë¡œëŠ” ì—¬ëŸ¬ ì»¤ìŠ¤í…€ íƒ€ì…ì„ ì“°ëŠ” ì›Œí¬í”Œë¡œì—ì„œ ìƒ‰ íŒ”ë ˆíŠ¸ë¥¼ ì²´ê³„ì ìœ¼ë¡œ ì •ë¦¬í•´ ë‘ë©´, ë³µì¡í•œ ê·¸ë˜í”„ë„ í•œëˆˆì— ì½íˆëŠ” â€œì‹œê°ì  ë¬¸ë²•â€ì´ ë©ë‹ˆë‹¤.</p>

<p class="chat--user">

ìœ„ì— ì„í¬íŠ¸ ê°™ì€ê±´ ë”°ë¡œ ì•ˆí•´ë„ ë˜ë‚˜

</p>

<p>ì•„ë‹ˆìš”. ë”°ë¡œ ì„í¬íŠ¸í•  ê±° ì—†ìŠµë‹ˆë‹¤.</p>

<p>ì™œëƒë©´ ComfyUIê°€ ë¸Œë¼ìš°ì €ì—ì„œ ì´ë¯¸ í•„ìš”í•œ ê²ƒë“¤ì„ ì „ì—­ìœ¼ë¡œ ì˜¬ë ¤ë‘¡ë‹ˆë‹¤. í™•ì¥ ìŠ¤í¬ë¦½íŠ¸ë¥¼ <code class="language-plaintext highlighter-rouge">web/extensions/*.js</code>ì— ë‘ê³  <code class="language-plaintext highlighter-rouge">app.registerExtension({...})</code>ë¥¼ ì“°ë©´, ë‚´ë¶€ì—ì„œ <code class="language-plaintext highlighter-rouge">app</code>(ComfyUI ì•± ê°ì²´)ì™€ <code class="language-plaintext highlighter-rouge">LGraphCanvas</code>(LiteGraph ìº”ë²„ìŠ¤)ê°€ ìë™ìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤. ê·¸ë˜ì„œ ì¶”ê°€ ì„í¬íŠ¸ ì—†ì´ ë°”ë¡œ ë§µì„ ê±´ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>ì •ë¦¬í•´ë‘ë©´ ì´ë ‡ê²Œ ë©ë‹ˆë‹¤.</p>

<ol>
  <li>
    <p>JS ìª½<br />
íŒŒì¼ ìœ„ì¹˜: <code class="language-plaintext highlighter-rouge">ComfyUI/web/extensions/mytype-colors.js</code><br />
ì½”ë“œ ì•ˆì—ì„œ ë”°ë¡œ <code class="language-plaintext highlighter-rouge">import</code> ì•ˆ í•´ë„ ë¨. <code class="language-plaintext highlighter-rouge">app</code>ê³¼ <code class="language-plaintext highlighter-rouge">LGraphCanvas</code>ëŠ” ì „ì—­. <code class="language-plaintext highlighter-rouge">registerExtension</code>ì´ ë¡œë”© íƒ€ì´ë°ë„ ì±…ì„ì ¸ì¤˜ì„œ â€œë¨¼ì € ë¡œë“œëë‚˜?â€ ê±±ì •ë„ ì¤„ì–´ë“­ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>íŒŒì´ì¬ ë…¸ë“œ ìª½<br />
ìƒ‰ìƒ ë§¤í•‘ì„ ìœ„í•´ ë³„ë„ì˜ ì„í¬íŠ¸ í•„ìš” ì—†ìŒ. ì»¤ìŠ¤í…€ ë…¸ë“œ í´ë˜ìŠ¤ì—ì„œ <code class="language-plaintext highlighter-rouge">RETURN_TYPES = ("MYTYPE",)</code> ê°™ì€ íƒ€ì… ë¬¸ìì—´ì„ í‰ì†Œì²˜ëŸ¼ ì •ì˜í•˜ë©´ ë. ìƒ‰ìƒì€ JS í™•ì¥ì—ì„œ íƒ€ì… ë¬¸ìì—´ í‚¤ë¡œ ë§¤í•‘í•©ë‹ˆë‹¤.</p>
  </li>
  <li>
    <p>ì¬ì‹œì‘/ìƒˆë¡œê³ ì¹¨<br />
íŒŒì¼ì„ ë„£ì€ ë’¤ ComfyUI ì¬ì‹œì‘ ë˜ëŠ” ë¸Œë¼ìš°ì € ìƒˆë¡œê³ ì¹¨ë§Œ í•˜ë©´ ë°˜ì˜ë©ë‹ˆë‹¤. ìºì‹œê°€ ë¼ë©´ ê°•ë ¥ ìƒˆê³ ì¹¨ ì •ë„ë©´ ì¶©ë¶„í•©ë‹ˆë‹¤.</p>
  </li>
</ol>

<p>ì˜ˆì‹œ ìŠ¤ë‹ˆí«(ì„í¬íŠ¸ ì—†ìŒ):</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>js

app.registerExtension({
  name: "mytype.color.map",
  setup() {
    const LGC = LGraphCanvas;
    LGC.default_connection_color_byType = {
      ...(LGC.default_connection_color_byType || {}),
      "MYTYPE": "#a26bff"
    };
    LGC.default_connection_color_byTypeOff = {
      ...(LGC.default_connection_color_byTypeOff || {}),
      "MYTYPE": "#5b3a9a"
    };
    if (app?.graph?.canvas) app.graph.canvas.setDirty(true, true);
  }
});
</code></pre></div></div>

<p>ì£¼ì˜í•  ì  ëª‡ ê°€ì§€ë§Œ ë§ë¶™ì´ë©´ ë” íƒ„íƒ„í•´ì§‘ë‹ˆë‹¤.<br />
â€¢ íŒŒì¼ ìœ„ì¹˜ê°€ ë§ì•„ì•¼ ìë™ ë¡œë“œë©ë‹ˆë‹¤. ë‹¤ë¥¸ ê²½ë¡œë¥¼ ì“°ë©´ ì§ì ‘ ë¡œë”ì— ë“±ë¡í•´ì•¼ í•´ìš”.<br />
â€¢ TypeScriptë¡œ ì‘ì„±í•œë‹¤ë©´ â€œì „ì—­ <code class="language-plaintext highlighter-rouge">app</code>, <code class="language-plaintext highlighter-rouge">LGraphCanvas</code>â€ì— ëŒ€í•œ íƒ€ì… ì„ ì–¸ë§Œ ì¶”ê°€í•˜ë©´ ë©ë‹ˆë‹¤. JSë¼ë©´ ê·¸ëƒ¥ ë„˜ì–´ê°€ë„ ë©ë‹ˆë‹¤.<br />
â€¢ ë§Œì•½ ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ ì¦‰ì„ ì‹¤í–‰í•œë‹¤ë©´ <code class="language-plaintext highlighter-rouge">window.app</code>, <code class="language-plaintext highlighter-rouge">window.LGraphCanvas</code>ë¡œ ì ‘ê·¼í•˜ì„¸ìš”.</p>

<p>í•œ ì¤„ ê²°ë¡ : ê¸°ë³¸ ì„¤ì¹˜ ê·¸ëŒ€ë¡œë¼ë©´ ì„í¬íŠ¸ëŠ” ì „í˜€ í•„ìš” ì—†ìŠµë‹ˆë‹¤. íƒ€ì… ë¬¸ìì—´ë§Œ ë§ì¶”ê³ , í™•ì¥ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì „ì—­ ê°ì²´ë¥¼ ì‚´ì§ ì†ëŒ€ë©´ ë§í¬ ìƒ‰ìƒ ì»¤ìŠ¤í„°ë§ˆì´ì§•ì´ ê¹”ë”í•˜ê²Œ ë™ì‘í•©ë‹ˆë‹¤.</p>]]></content><author><name>hvppyarchive</name></author><category term="comfyui" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">npx ì„¤ì • ë³€ê²½ ë°©ë²•</title><link href="https://hvppyarchive.github.io/llm/npx-command-line-config/" rel="alternate" type="text/html" title="npx ì„¤ì • ë³€ê²½ ë°©ë²•" /><published>2025-10-30T13:40:18+09:00</published><updated>2025-10-30T13:40:18+09:00</updated><id>https://hvppyarchive.github.io/llm/npx-command-line-config</id><content type="html" xml:base="https://hvppyarchive.github.io/llm/npx-command-line-config/"><![CDATA[<p class="chat--user">

npx (npm exec)ì„ ëŒë¦¬ë˜ ì»¤ë§¨ë“œë¼ì¸ì—ì„œ prefix, .npm ê²½ë¡œ, registry, strict-sslë¥¼ ì»¤ë§¨ë“œë¡œ ë°”ê¿€ ìˆ˜ ìˆì–´?

</p>

<p>ê°€ëŠ¥í•´. <code class="language-plaintext highlighter-rouge">npx</code>(npm v7+ì—ì„œëŠ” <code class="language-plaintext highlighter-rouge">npm exec</code>ì™€ ë™ì¼)ëŠ” ê±°ì˜ ëª¨ë“  npm ì„¤ì • ê°’ì„ â€œê·¸ ì‹¤í–‰ í•œ ë²ˆâ€ì— í•œí•´ CLI ì˜µì…˜ì´ë‚˜ í™˜ê²½ë³€ìˆ˜ë¡œ ì˜¤ë²„ë¼ì´ë“œí•  ìˆ˜ ìˆì–´. í•µì‹¬ì€ ë‹¤ìŒ ì…‹ ì¤‘ í•˜ë‚˜ë¥¼ ì“°ëŠ” ê²ƒ: 1) CLI í”Œë˜ê·¸, 2) <code class="language-plaintext highlighter-rouge">npm_config_*</code> í™˜ê²½ë³€ìˆ˜, 3) ë‹¤ë¥¸ <code class="language-plaintext highlighter-rouge">.npmrc</code>ë¥¼ ì§€ì •í•˜ëŠ” <code class="language-plaintext highlighter-rouge">--userconfig</code>.</p>

<p>ì•„ë˜ë¥¼ ì°¨ê·¼ì°¨ê·¼ ë³´ì.</p>

<ol>
  <li>CLI í”Œë˜ê·¸ë¡œ ë°”ë¡œ ì§€ì •</li>
</ol>

<ul>
  <li>
    <p>registry: <code class="language-plaintext highlighter-rouge">--registry=https://registry.npmmirror.com</code></p>
  </li>
  <li>
    <p>strict-ssl: <code class="language-plaintext highlighter-rouge">--strict-ssl=false</code></p>
  </li>
  <li>
    <p>prefix(ê¸€ë¡œë²Œ prefix): <code class="language-plaintext highlighter-rouge">--prefix=/opt/npm-global</code></p>
  </li>
  <li>
    <p>.npm ìºì‹œ ê²½ë¡œ: <code class="language-plaintext highlighter-rouge">--cache=/var/tmp/npm-cache</code> (ì¼ë°˜ì ìœ¼ë¡œ â€œ~/.npmâ€ì´ ì´ ê°’)</p>
  </li>
</ul>

<p>ì˜ˆì‹œë“¤:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># npm v7+ ìŠ¤íƒ€ì¼ (ê¶Œì¥): npm exec</span>
npm <span class="nb">exec</span> <span class="nt">--registry</span><span class="o">=</span>https://registry.npmmirror.com <span class="nt">--strict-ssl</span><span class="o">=</span><span class="nb">false</span> <span class="nt">--</span> <span class="se">\</span>
  some-binary <span class="nt">--help</span>

<span class="c"># ì „í†µì ì¸ npx ìŠ¤íƒ€ì¼ (npm v6~): npx</span>
npx <span class="nt">--registry</span><span class="o">=</span>https://registry.npmmirror.com <span class="nt">--strict-ssl</span><span class="o">=</span><span class="nb">false </span>some-binary <span class="nt">--help</span>

<span class="c"># prefixì™€ cacheë„ í•œ ë²ˆì—</span>
npm <span class="nb">exec</span> <span class="nt">--prefix</span><span class="o">=</span>/opt/npm-global <span class="nt">--cache</span><span class="o">=</span>/var/tmp/npm-cache <span class="nt">--</span> <span class="se">\</span>
  eslint <span class="nt">-v</span>
</code></pre></div></div>

<ol>
  <li>í™˜ê²½ë³€ìˆ˜ë¡œ ì§€ì • (<code class="language-plaintext highlighter-rouge">npm_config_*</code>)<br />
ë™ì¼í•œ í‚¤ë¥¼ í™˜ê²½ë³€ìˆ˜ë¡œ ë„˜ê²¨ë„ ëœë‹¤. í•œ ë²ˆ ì“°ê³  ëë‚¼ ë•Œ ê¹”ë”í•˜ë‹¤.</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># POSIX ì‰˜</span>
<span class="nv">npm_config_registry</span><span class="o">=</span>https://registry.npmmirror.com <span class="se">\</span>
<span class="nv">npm_config_strict_ssl</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
<span class="nv">npm_config_prefix</span><span class="o">=</span>/opt/npm-global <span class="se">\</span>
<span class="nv">npm_config_cache</span><span class="o">=</span>/var/tmp/npm-cache <span class="se">\</span>
npx eslint <span class="nt">-v</span>
</code></pre></div></div>

<p>Windows PowerShellì´ë¼ë©´:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">npm_config_registry</span><span class="o">=</span><span class="s2">"https://registry.npmmirror.com"</span><span class="w">
</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">npm_config_strict_ssl</span><span class="o">=</span><span class="s2">"false"</span><span class="w">
</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">npm_config_prefix</span><span class="o">=</span><span class="s2">"C:\npm-global"</span><span class="w">
</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">npm_config_cache</span><span class="o">=</span><span class="s2">"D:\npm-cache"</span><span class="w">
</span><span class="n">npx</span><span class="w"> </span><span class="nx">eslint</span><span class="w"> </span><span class="nt">-v</span><span class="w">
</span></code></pre></div></div>

<ol>
  <li>ë³„ë„ .npmrcë¥¼ ì§€ì •<br />
í”„ë¡œì íŠ¸/ìœ ì € ê¸°ë³¸ ì„¤ì • ê±´ë“œë¦¬ì§€ ì•Šê³  íŠ¹ì • ì‹¤í–‰ì—ë§Œ ì“°ê³  ì‹¶ì„ ë•Œ ìœ ìš©í•˜ë‹¤.</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># /tmp/my.npmrc ì•ˆì— ì›í•˜ëŠ” ì„¤ì •ì„ ì¨ë‘” ë’¤</span>
npm <span class="nb">exec</span> <span class="nt">--userconfig</span><span class="o">=</span>/tmp/my.npmrc <span class="nt">--</span> webpack <span class="nt">--version</span>
</code></pre></div></div>

<p>ì‹¤ë¬´ íŒê³¼ ì£¼ì˜ì </p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">npm exec</code>ì—ì„œ â€œì„¤ì • í”Œë˜ê·¸ë“¤ì€ ì‹¤í–‰í•  ë°”ì´ë„ˆë¦¬ ì´ë¦„ ì•â€ì— ë‘ëŠ” ê²Œ ì•ˆì „í•˜ë‹¤. ê·¸ ë’¤ì˜ ì¸ìëŠ” ì‹¤í–‰ ëŒ€ìƒ íŒ¨í‚¤ì§€ê°€ ë°›ëŠ”ë‹¤. ì• ë§¤í•˜ë©´ <code class="language-plaintext highlighter-rouge">--</code>ë¡œ êµ¬ë¶„í•´ì£¼ê¸°.<br />
ì˜ˆ: <code class="language-plaintext highlighter-rouge">npm exec --registry=... -- strict-ssl-checker --verbose</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">prefix</code>ëŠ” â€œê¸€ë¡œë²Œ ì„¤ì¹˜ ìœ„ì¹˜â€ë¥¼ ì˜ë¯¸í•œë‹¤. <code class="language-plaintext highlighter-rouge">npm exec --package=foo</code> ê°™ì´ ì¼ì‹œ ì„¤ì¹˜ ì‹¤í–‰í•  ë•ŒëŠ” ì„ì‹œ ë””ë ‰í„°ë¦¬ë¥¼ ì“°ë¯€ë¡œ <code class="language-plaintext highlighter-rouge">prefix</code>ë³´ë‹¤ <code class="language-plaintext highlighter-rouge">cache</code>ì™€ <code class="language-plaintext highlighter-rouge">tmp</code> ê´€ë ¨ ì„¤ì •ì´ ë™ì‘ì— ë” í° ì˜í–¥ì„ ì¤€ë‹¤.</p>
  </li>
  <li>
    <p>npm v6ì˜ <code class="language-plaintext highlighter-rouge">npx</code>ëŠ” ì˜µì…˜ íŒŒì‹±ì´ ë‹¤ì†Œ ê¹Œë‹¤ë¡œì› ë‹¤. íŒ¨í‚¤ì§€ ì¸ìì™€ npx ì˜µì…˜ì´ ì„ì´ë©´ <code class="language-plaintext highlighter-rouge">--</code>ë¡œ ê²½ê³„ í‘œì‹œ.</p>
  </li>
  <li>
    <p>CA ê²€ì¦ì„ ë„ëŠ” <code class="language-plaintext highlighter-rouge">--strict-ssl=false</code>ëŠ” í¸í•˜ì§€ë§Œ ë³´ì•ˆìƒ ìœ„í—˜í•˜ë‹ˆ ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ í…ŒìŠ¤íŠ¸ ë“± ë¶ˆê°€í”¼í•  ë•Œë§Œ ì“°ì.</p>
  </li>
  <li>
    <p>ìì£¼ ì“°ëŠ” ê°’ì€ ì‚¬ìš©ì í™ˆì˜ <code class="language-plaintext highlighter-rouge">~/.npmrc</code>ë‚˜ í”„ë¡œì íŠ¸ì˜ <code class="language-plaintext highlighter-rouge">.npmrc</code>ì— ì ì–´ ë‘ê³ , ì¼ì‹œì ìœ¼ë¡œ ë°”ê¿€ ë•Œë§Œ ìœ„ ë°©ì‹ì„ ì“°ë©´ ê¹”ë”í•˜ë‹¤.</p>
  </li>
</ul>

<p>ì—¬ê¸°ê¹Œì§€ë©´ ë³´í†µì€ ì¶©ë¶„í•˜ë‹¤. í•„ìš”í•˜ë©´ <code class="language-plaintext highlighter-rouge">proxy</code>, <code class="language-plaintext highlighter-rouge">https-proxy</code>, <code class="language-plaintext highlighter-rouge">cafile</code>, <code class="language-plaintext highlighter-rouge">always-auth</code> ê°™ì€ ë‹¤ë¥¸ npm ì„¤ì •ë“¤ë„ ë˜‘ê°™ì€ ë°©ì‹ìœ¼ë¡œ í•œ ë²ˆ ì‹¤í–‰ìš©ìœ¼ë¡œ ë§ì…í ìˆ˜ ìˆë‹¤.</p>

<p class="chat--user">

ëª¨ë‘ í•œ ë²ˆì— ì„¤ì •í•˜ëŠ” ë²•

</p>

<p>ê°€ëŠ¥. í•œ ì¤„ì—ì„œ ì „ë¶€ ë®ì–´ì”Œìš°ëŠ” ê°€ì¥ ê°„ë‹¨í•œ ë°©ë²• 3ê°€ì§€ë¥¼ ë°”ë¡œ ì“¸ ìˆ˜ ìˆì–´. ê°ê° â€œì‹¤í–‰ í•œ ë²ˆâ€ì—ë§Œ ì ìš©ë¼ì„œ ê¸°ë³¸ ì„¤ì •ì€ ì•ˆ ë°”ë€ë‹¤.</p>

<ol>
  <li>CLI í”Œë˜ê·¸ í•œ ë²ˆì—(ê¶Œì¥: npm v7+ì—ì„œ npm exec)</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">exec</span> <span class="se">\</span>
  <span class="nt">--registry</span><span class="o">=</span>https://registry.npmmirror.com <span class="se">\</span>
  <span class="nt">--strict-ssl</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
  <span class="nt">--prefix</span><span class="o">=</span>/opt/npm-global <span class="se">\</span>
  <span class="nt">--cache</span><span class="o">=</span>/var/tmp/npm-cache <span class="se">\</span>
  <span class="nt">--package</span><span class="o">=</span>eslint <span class="nt">--</span> <span class="se">\</span>
  eslint <span class="nt">-v</span>
</code></pre></div></div>

<p>í¬ì¸íŠ¸: ì„¤ì • í”Œë˜ê·¸ëŠ” ì‹¤í–‰í•  íŒ¨í‚¤ì§€ ì´ë¦„(ì—¬ê¸°ì„  eslint) ì•ì— ë‘ê³ , ê·¸ ë’¤ë¥¼ <code class="language-plaintext highlighter-rouge">--</code>ë¡œ êµ¬ë¶„í•´ ì‹¤í–‰ ëŒ€ìƒì˜ ì¸ìë¥¼ ì „ë‹¬í•œë‹¤.</p>

<ol>
  <li>í™˜ê²½ë³€ìˆ˜ í•œ ë²ˆì— (<code class="language-plaintext highlighter-rouge">npm_config_*</code>)</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># POSIX ì‰˜</span>
<span class="nv">npm_config_registry</span><span class="o">=</span>https://registry.npmmirror.com <span class="se">\</span>
<span class="nv">npm_config_strict_ssl</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
<span class="nv">npm_config_prefix</span><span class="o">=</span>/opt/npm-global <span class="se">\</span>
<span class="nv">npm_config_cache</span><span class="o">=</span>/var/tmp/npm-cache <span class="se">\</span>
npm <span class="nb">exec</span> <span class="nt">--package</span><span class="o">=</span>eslint <span class="nt">--</span> eslint <span class="nt">-v</span>
</code></pre></div></div>

<p>PowerShellì´ë¼ë©´:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">npm_config_registry</span><span class="o">=</span><span class="s2">"https://registry.npmmirror.com"</span><span class="w">
</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">npm_config_strict_ssl</span><span class="o">=</span><span class="s2">"false"</span><span class="w">
</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">npm_config_prefix</span><span class="o">=</span><span class="s2">"C:\npm-global"</span><span class="w">
</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">npm_config_cache</span><span class="o">=</span><span class="s2">"D:\npm-cache"</span><span class="w">
</span><span class="n">npm</span><span class="w"> </span><span class="nx">exec</span><span class="w"> </span><span class="nt">--package</span><span class="o">=</span><span class="n">eslint</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="nx">eslint</span><span class="w"> </span><span class="nt">-v</span><span class="w">
</span></code></pre></div></div>

<ol>
  <li>ì„ì‹œ .npmrc íŒŒì¼ë¡œ í•œ ë²ˆì—</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&gt;</span> /tmp/once.npmrc <span class="o">&lt;&lt;</span><span class="sh">'</span><span class="no">EOF</span><span class="sh">'
registry=https://registry.npmmirror.com
strict-ssl=false
prefix=/opt/npm-global
cache=/var/tmp/npm-cache
</span><span class="no">EOF

</span>npm <span class="nb">exec</span> <span class="nt">--userconfig</span><span class="o">=</span>/tmp/once.npmrc <span class="nt">--package</span><span class="o">=</span>eslint <span class="nt">--</span> eslint <span class="nt">-v</span>
</code></pre></div></div>

<p>npxë¥¼ ê·¸ëŒ€ë¡œ ì“°ëŠ” ê²½ìš°(npm v6 ê³„ì—´)ë„ ë™ì¼í•˜ê²Œ ëœë‹¤:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npx <span class="nt">--registry</span><span class="o">=</span>https://registry.npmmirror.com <span class="nt">--strict-ssl</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
    <span class="nt">--prefix</span><span class="o">=</span>/opt/npm-global <span class="nt">--cache</span><span class="o">=</span>/var/tmp/npm-cache <span class="se">\</span>
    eslint <span class="nt">-v</span>
</code></pre></div></div>

<p>ì •ë¦¬í•´ë‘” ì‘ë™ ì›ì¹™</p>

<ul>
  <li>
    <p>ìš°ì„ ìˆœìœ„: CLI í”Œë˜ê·¸ &gt; í™˜ê²½ë³€ìˆ˜(npm_config_*) &gt; --userconfigë¡œ ì§€ì •í•œ .npmrc &gt; í”„ë¡œì íŠ¸/ìœ ì € .npmrc</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">prefix</code>ëŠ” ê¸€ë¡œë²Œ ì„¤ì¹˜ ê²½ë¡œë¥¼ ì˜ë¯¸í•œë‹¤. <code class="language-plaintext highlighter-rouge">npm exec --package=...</code>ì²˜ëŸ¼ ì¼ì‹œ ì„¤ì¹˜ ì‹¤í–‰ì—ì„œëŠ” ì„ì‹œ ë””ë ‰í„°ë¦¬ë¥¼ ì“°ë¯€ë¡œ ì‹¤ì œ ì²´ê° ì˜í–¥ì€ <code class="language-plaintext highlighter-rouge">cache</code>, <code class="language-plaintext highlighter-rouge">tmp</code>ê°€ ë” í¬ë‹¤.</p>
  </li>
  <li>
    <p>íŒ¨í‚¤ì§€ ì´ë¦„ê³¼ ì˜µì…˜ì´ ì„ì¼ ìœ„í—˜ì´ ìˆìœ¼ë©´ <code class="language-plaintext highlighter-rouge">--</code>ë¡œ ê²½ê³„ë¥¼ ë‚˜ëˆ ë¼.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">--strict-ssl=false</code>ëŠ” í¸í•˜ì§€ë§Œ ë³´ì•ˆìƒ ìœ„í—˜í•˜ë‹ˆ ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ í…ŒìŠ¤íŠ¸ ë“± ê¼­ í•„ìš”í•  ë•Œë§Œ ì‚¬ìš©í•˜ë¼.</p>
  </li>
</ul>

<p>ì—¬ê¸° ì˜ˆì‹œì˜ registry, ê²½ë¡œë“¤ì€ ë„¤ í™˜ê²½ì— ë§ê²Œ ë°”ê¿” ê½‚ìœ¼ë©´ ëœë‹¤. ë‹¤ìŒ ë‹¨ê³„ë¡œëŠ” proxy, cafile, always-auth ê°™ì€ ê°’ë„ ê°™ì€ ë°©ì‹ìœ¼ë¡œ í•¨ê»˜ ë¬¶ì–´ ë„˜ê²¨ë³¼ ìˆ˜ ìˆë‹¤.</p>

<p class="chat--user">

ë­”ê°€ ê¸¸ë‹¤? ë‚´ê°€ ì›ë˜ ì¹˜ë ¤ë˜ ê±´ npx -y @modelcontextprotocol/server-everythingì´ì•¼

</p>

<p>ì¢‹ì•„, ê·¸ í•œ ì¤„ì§œë¦¬ë¡œ ëë‚´ì. ë„¤ê°€ ì¹˜ë ¤ë˜ ëª…ë ¹ì— ì˜µì…˜ 4ì¢…ì„ â€œí•œ ë²ˆ ì‹¤í–‰ìš©â€ìœ¼ë¡œ ë®ì–´ì”Œìš°ëŠ” ìµœì†Œ ì˜ˆì‹œëŠ” ì•„ë˜ ë‘˜ ì¤‘ í•˜ë‚˜ë¡œ ëœë‹¤.</p>

<p>CLI í”Œë˜ê·¸ë¡œ í•œ ë°©ì—:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npx <span class="nt">--registry</span><span class="o">=</span>https://registry.npmmirror.com <span class="nt">--strict-ssl</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
    <span class="nt">--prefix</span><span class="o">=</span>/opt/npm-global <span class="nt">--cache</span><span class="o">=</span>/var/tmp/npm-cache <span class="se">\</span>
    <span class="nt">-y</span> @modelcontextprotocol/server-everything
</code></pre></div></div>

<p>í™˜ê²½ë³€ìˆ˜ë¡œ ê¹”ë”í•˜ê²Œ(ì¶”ì²œ, ì‰˜ ì´ì‹ì„± ì¢‹ìŒ):</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">npm_config_registry</span><span class="o">=</span>https://registry.npmmirror.com <span class="se">\</span>
<span class="nv">npm_config_strict_ssl</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
<span class="nv">npm_config_prefix</span><span class="o">=</span>/opt/npm-global <span class="se">\</span>
<span class="nv">npm_config_cache</span><span class="o">=</span>/var/tmp/npm-cache <span class="se">\</span>
npx <span class="nt">-y</span> @modelcontextprotocol/server-everything
</code></pre></div></div>

<p>ì°¸ê³  ë©”ëª¨</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">--</code> êµ¬ë¶„ìëŠ” íŒ¨í‚¤ì§€ì— ì¶”ê°€ ì¸ìë¥¼ ë„˜ê¸¸ ë•Œë§Œ ë¶™ì´ë©´ ëœë‹¤. ì—¬ê¸°ì„  ë¶ˆí•„ìš”.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">prefix</code>ëŠ” ì „ì—­ ì„¤ì¹˜ ê²½ë¡œì§€ë§Œ, npxëŠ” ì¼ì‹œ ì„¤ì¹˜Â·ì‹¤í–‰ì´ë¼ ì‹¤ì œë¡œëŠ” <code class="language-plaintext highlighter-rouge">cache</code>ì™€ ë„¤íŠ¸ì›Œí¬ ì„¤ì •(registry, strict-ssl)ì´ ë” ì˜í–¥ì´ í¬ë‹¤.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">strict-ssl=false</code>ëŠ” ìœ„í—˜í•˜ë‹ˆ ë‚´ë¶€ë§ í…ŒìŠ¤íŠ¸ì²˜ëŸ¼ ê¼­ í•„ìš”í•  ë•Œë§Œ ì“°ì.</p>
  </li>
</ul>

<p>ê°™ì€ ë°©ì‹ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">proxy</code>, <code class="language-plaintext highlighter-rouge">https-proxy</code>, <code class="language-plaintext highlighter-rouge">cafile</code>, <code class="language-plaintext highlighter-rouge">always-auth</code>ë„ í•œ ì¤„ì— ì–¹ì„ ìˆ˜ ìˆë‹¤.</p>

<p class="chat--user">

ìœ ì € íŒŒì¼ë¡œ ì €ì¥í•´ë‘ê³  ëŒë¦¬ê¸°

</p>

<p>ì¢‹ì•„. â€œë§¤ë²ˆ ì˜µì…˜ ì¹˜ê¸° ê·€ì°®ë‹¤ â†’ ì‚¬ìš©ì ì„¤ì • íŒŒì¼(~/.npmrc)ì— ì €ì¥í•´ë‘ê³  ê·¸ëƒ¥ ì‹¤í–‰â€ìœ¼ë¡œ ê°€ì. ì•„ë˜ ìˆœì„œëŒ€ë¡œ í•˜ë©´ ëœë‹¤.</p>

<ol>
  <li>ê¸°ì¡´ ì„¤ì • ë°±ì—…</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># macOS/Linux</span>
<span class="o">[</span> <span class="nt">-f</span> ~/.npmrc <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">cp</span> <span class="nt">-a</span> ~/.npmrc ~/.npmrc.bak.<span class="si">$(</span><span class="nb">date</span> +%Y%m%d-%H%M%S<span class="si">)</span>

<span class="c"># Windows PowerShell</span>
<span class="k">if</span> <span class="o">(</span>Test-Path <span class="nv">$HOME</span><span class="se">\.</span>npmrc<span class="o">)</span> <span class="o">{</span> Copy-Item <span class="nv">$HOME</span><span class="se">\.</span>npmrc <span class="s2">"</span><span class="nv">$HOME</span><span class="se">\.</span><span class="s2">npmrc.bak.</span><span class="k">$((</span>Get-Date<span class="o">)</span>.ToString<span class="o">(</span><span class="s1">'yyyyMMdd-HHmmss'</span><span class="k">))</span><span class="s2">"</span> <span class="o">}</span>
</code></pre></div></div>

<ol>
  <li>ì‚¬ìš©ì .npmrc ì‘ì„±<br />
ì›í•˜ëŠ” ê°’ìœ¼ë¡œ ë°”ê¿” ë„£ì. strict-ssl=falseëŠ” ë³´ì•ˆìƒ ìœ„í—˜í•˜ë‹ˆ ì •ë§ í•„ìš”í•œ ê²½ìš°ì—ë§Œ ì“´ë‹¤.</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># macOS/Linux</span>
<span class="nb">cat</span> <span class="o">&gt;</span> ~/.npmrc <span class="o">&lt;&lt;</span><span class="sh">'</span><span class="no">EOF</span><span class="sh">'
registry=https://registry.npmmirror.com
strict-ssl=false
prefix=/opt/npm-global
cache=/var/tmp/npm-cache
</span><span class="no">EOF
</span></code></pre></div></div>

<p>PowerShellì´ë¼ë©´:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="sh">@"
registry=https://registry.npmmirror.com
strict-ssl=false
prefix=C:\npm-global
cache=D:\npm-cache
"@</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Set-Content</span><span class="w"> </span><span class="nt">-Encoding</span><span class="w"> </span><span class="nx">UTF8</span><span class="w"> </span><span class="bp">$HOME</span><span class="nx">\.npmrc</span><span class="w">
</span></code></pre></div></div>

<ol>
  <li>prefix ê²½ë¡œ ë§Œë“¤ê¸° ë° PATHì— ì¶”ê°€<br />
prefixë¥¼ ë°”ê¿¨ë‹¤ë©´ ê·¸ ìœ„ì¹˜ì˜ binì´ PATHì— ìˆì–´ì•¼ ì‹¤í–‰ íŒŒì¼ì´ ë³´ì¸ë‹¤.</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># macOS/Linux</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> /opt/npm-global
<span class="c"># ì…¸ì— PATH ì¶”ê°€(ì˜ˆ: bash/zsh)</span>
<span class="nb">echo</span> <span class="s1">'export PATH="/opt/npm-global/bin:$PATH"'</span> <span class="o">&gt;&gt;</span> ~/.bashrc
<span class="nb">echo</span> <span class="s1">'export PATH="/opt/npm-global/bin:$PATH"'</span> <span class="o">&gt;&gt;</span> ~/.zshrc
<span class="c"># ì ìš©</span>
<span class="nb">source</span> ~/.bashrc 2&gt;/dev/null <span class="o">||</span> <span class="nb">source</span> ~/.zshrc 2&gt;/dev/null <span class="o">||</span> <span class="nb">true</span>
</code></pre></div></div>

<p>PowerShell:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">New-Item</span><span class="w"> </span><span class="nt">-ItemType</span><span class="w"> </span><span class="nx">Directory</span><span class="w"> </span><span class="nt">-Force</span><span class="w"> </span><span class="nx">C:\npm-global</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">Path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"C:\npm-global;</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">Path</span><span class="s2">"</span><span class="w">
</span><span class="p">[</span><span class="n">Environment</span><span class="p">]::</span><span class="n">SetEnvironmentVariable</span><span class="p">(</span><span class="s2">"Path"</span><span class="p">,</span><span class="w"> </span><span class="s2">"C:\npm-global;"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">[</span><span class="n">Environment</span><span class="p">]::</span><span class="n">GetEnvironmentVariable</span><span class="p">(</span><span class="s2">"Path"</span><span class="p">,</span><span class="s2">"User"</span><span class="p">),</span><span class="w"> </span><span class="s2">"User"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<ol>
  <li>ìºì‹œ ë””ë ‰í„°ë¦¬ ì¤€ë¹„(ì„ íƒ)</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># macOS/Linux</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> /var/tmp/npm-cache

<span class="c"># PowerShell</span>
New-Item <span class="nt">-ItemType</span> Directory <span class="nt">-Force</span> D:<span class="se">\n</span>pm-cache | Out-Null
</code></pre></div></div>

<ol>
  <li>ì˜ ì €ì¥ëëŠ”ì§€ í™•ì¸</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm config list <span class="nt">-l</span> | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'registry|strict-ssl|prefix|cache'</span>
<span class="c"># PowerShell</span>
npm config list <span class="nt">-l</span> | findstr /r <span class="s2">"registry strict-ssl prefix cache"</span>
</code></pre></div></div>

<ol>
  <li>ì´ì œ ê·¸ëƒ¥ ì‹¤í–‰<br />
ì´ì œë¶€í„°ëŠ” ì˜µì…˜ ì—†ì´ ë„¤ê°€ ì“°ë ¤ë˜ ëª…ë ¹ì„ ê·¸ëŒ€ë¡œ ì“°ë©´ ëœë‹¤.</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npx <span class="nt">-y</span> @modelcontextprotocol/server-everything
</code></pre></div></div>

<p>ì‹¤ë¬´ ë©”ëª¨</p>

<ul>
  <li>
    <p>ì‚¬ìš©ì ìˆ˜ì¤€(~/.npmrc)ì€ í˜„ì¬ ì‚¬ìš©ìì—ê²Œë§Œ ì ìš©ëœë‹¤. í”„ë¡œì íŠ¸ ì „ìš© ì„¤ì •ì„ ì›í•˜ë©´ í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— .npmrcë¥¼ ë‘ë©´ í•´ë‹¹ ë””ë ‰í„°ë¦¬ì—ì„œë§Œ ìš°ì„  ì ìš©ëœë‹¤.</p>
  </li>
  <li>
    <p>ë¹ ë¥¸ ëŒ€ì•ˆìœ¼ë¡œ CLIì—ì„œ ì˜êµ¬ ì €ì¥ë„ ê°€ëŠ¥í•˜ë‹¤:<br />
macOS/Linux:</p>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm config <span class="nb">set </span>registry https://registry.npmmirror.com
npm config <span class="nb">set </span>strict-ssl <span class="nb">false
</span>npm config <span class="nb">set </span>prefix /opt/npm-global
npm config <span class="nb">set </span>cache /var/tmp/npm-cache
</code></pre></div>    </div>
  </li>
</ul>

<p>PowerShell:
    <code class="language-plaintext highlighter-rouge">powershell
    npm config set registry https://registry.npmmirror.com
    npm config set strict-ssl false
    npm config set prefix C:\npm-global
    npm config set cache D:\npm-cache
   </code></p>

<p>ì´ ë°©ì‹ì€ ê°™ì€ ë‚´ìš©ì´ ~/.npmrcì— ê¸°ë¡ëœë‹¤.</p>

<ul>
  <li>
    <p>strict-ssl=falseëŠ” ì¤‘ê°„ì ê³µê²©ì— ì·¨ì•½í•´ì§„ë‹¤. ë³´ì•ˆì´ í•„ìš”í•œ í™˜ê²½ì—ì„  ë‚´ë¶€ CAë¥¼ ì“°ê±°ë‚˜ cafile ì„¤ì •ì„ ê¶Œì¥í•œë‹¤.</p>
  </li>
  <li>
    <p>ì„¤ì •ì„ ë˜ëŒë¦¬ë ¤ë©´ ë°±ì—…í•œ ~/.npmrc.bak.* íŒŒì¼ì„ ë‹¤ì‹œ ë®ì–´ì“°ë©´ ëœë‹¤.</p>
  </li>
</ul>]]></content><author><name>hvppyarchive</name></author><category term="llm" /><summary type="html"><![CDATA[]]></summary></entry></feed>